---
title: "三色标记法"
date: 2022-05-06T23:28:04+08:00
draft: true
tags: ["面试"]
series: [""]
categories: ["面试"]
---

## Go V1.8的三色标记法+混合写屏障机制
具体操作：
1. GC开始将栈上的对象全部扫描标记为黑色（之后不再进行二次重复扫描，无需stw）
2. GC期间，任何在栈上创建的新对象，均为黑色
3. 被删除的对象标记为灰色（栈+堆）
4. 被添加的对象标记为灰色

满足：变形的弱三色不变式（结合了插入、删除写屏障两者的优点）
```go
//伪代码
添加下游对象（当前下游对象slot，新下游对  象ptr）{
	//1
	标记灰色（当前下游对象slot）//只要当前下游对象被移走，就标记为灰色
	//2
	标记灰色（新下游对象ptr）
	//3
	当前下游对象slot = 新下游对象ptr
}
```
基础三色标记法

黑-白-灰
1. gc开始：扫描所有可到达的对象，标记为灰色
2. 从灰色对象中找到其引用对象标记为灰色，把灰色对象本身标记为黑色
3. 监视对象中的内存修改，并持续上一步的操作，直到灰色标记的对象不存在
4. 此时，gc回收白色对象。
5. 最后，将所有黑色对象变为白色，并重复以上所有过程。
