[{"categories":["é¢è¯•"],"content":"context Golang ä¸­çš„context æ˜¯Goè¯­è¨€åœ¨ golang1.7 å‘å¸ƒæ—¶æ–°å¢çš„æ ‡å‡†åŒ… ç›®çš„æ˜¯å¢å¼ºGolangå¼€å‘ä¸­å¹¶å‘æ§åˆ¶æŠ€æœ¯ ç®€å•æ¥è®²å½“ä¸€ä¸ªæœåŠ¡å¯åŠ¨æ—¶,å¯èƒ½ç”±æ­¤æœåŠ¡æ´¾ç”Ÿå‡ºå¤šä¸ªå¤šå±‚çº§çš„ goroutine , ä½†æ˜¯æœ¬è´¨ä¸Šæ¥è®²æ¯ä¸ªå±‚çº§çš„ goroutine éƒ½æ˜¯å¹³è¡Œè°ƒåº¦ä½¿ç”¨,ä¸å­˜åœ¨goroutine â€˜çˆ¶å­â€™ å…³ç³» , å½“å…¶ä¸­ä¸€ä¸ª goroutine æ‰§è¡Œçš„ä»»åŠ¡è¢«å–æ¶ˆäº†æˆ–è€…å¤„ç†è¶…æ—¶äº†, é‚£ä¹ˆå…¶ä»–è¢«å¯åŠ¨èµ·æ¥çš„Goroutine éƒ½åº”è¯¥è¿…é€Ÿé€€å‡º,å¦å¤–å¤šä¸ªå¤šå±‚çš„Goroutine æƒ³ä¼ é€’è¯·æ±‚åŸŸçš„æ•°æ®è¯¥å¦‚ä½•å¤„ç†? å¦‚æœå•ä¸ªè¯·æ±‚çš„Goroutine ç»“æ„æ¯”è¾ƒç®€å•,æˆ–è€…å¤„ç†èµ·æ¥ä¹Ÿä¸éº»çƒ¦,ä½†æ˜¯å¦‚æœå¯åŠ¨çš„Goroutine æ˜¯å¤šä¸ªå¹¶ä¸”ç»“æ„å±‚æ¬¡å¾ˆæ·± é‚£ä¹ˆå…‰æ˜¯ä¿éšœæ¯ä¸ªGoroutine æ­£å¸¸é€€å‡ºä¹Ÿä¸å¾ˆå®¹æ˜“äº† ä¸ºæ­¤Go1.7ä»¥æ¥æä¾›äº† context æ¥è§£å†³ç±»ä¼¼çš„é—®é¢˜ , context å¯ä»¥è·Ÿè¸ª Goroutine çš„è°ƒç”¨, åœ¨è°ƒç”¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªè°ƒç”¨æ ‘,é€šè¿‡è¿™ä¸ªè°ƒç”¨æ ‘å¯ä»¥åœ¨ä¼ é€’è¶…æ—¶æˆ–è€…é€€å‡ºé€šçŸ¥,è¿˜èƒ½åœ¨è°ƒç”¨æ ‘ä¸­ä¼ é€’å…ƒæ•°æ® contextçš„ä¸­æ–‡ç¿»è¯‘æ˜¯ä¸Šä¸‹æ–‡ ,æˆ‘ä»¬å¯ä»¥ç†è§£ä¸º context ç®¡ç†äº†ä¸€ç»„å‘ˆç°æ ‘çŠ¶ç»“æ„çš„ Goroutine ,è®©æ¯ä¸ªGoroutine éƒ½æ‹¥æœ‰ç›¸åŒçš„ä¸Šä¸‹æ–‡,å¹¶ä¸”å¯ä»¥åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ä¼ é€’æ•°æ® context.go 2.0 ç»“æ„å›¾ æˆ‘ä»¬çœ‹ä¸€ context.go çš„æºæ–‡ä»¶äº†è§£ä¸€ä¸‹context çš„æ„æˆ è¯¥æ–‡ä»¶é€šå¸¸ä½äº $GOROOT/src/context/context.go Context interface context å®é™…ä¸Šåªæ˜¯å®šä¹‰çš„4ä¸ªæ–¹æ³•çš„æ¥å£,å‡¡æ˜¯å®ç°äº†è¯¥æ¥å£çš„éƒ½ç§°ä¸ºä¸€ç§ context // A Context carries a deadline, a cancelation signal, and other values across // API boundaries. // // Context's methods may be called by multiple goroutines simultaneously. type Context interface { // æ ‡è¯†deadlineæ˜¯å¦å·²ç»è®¾ç½®äº†,æ²¡æœ‰è®¾ç½®æ—¶,okçš„å€¼æ˜¯false,å¹¶è¿”å›åˆå§‹çš„time.Time Deadline() (deadline time.Time, ok bool) // è¿”å›ä¸€ä¸ªchannel, å½“è¿”å›å…³é—­çš„channelæ—¶å¯ä»¥æ‰§è¡Œä¸€äº›æ“ä½œ Done() \u003c-chan struct{} // æè¿°contextå…³é—­çš„åŸå› ,é€šå¸¸åœ¨Done()æ”¶åˆ°å…³é—­é€šçŸ¥ä¹‹åæ‰èƒ½çŸ¥é“åŸå›  Err() error // è·å–ä¸Šæ¸¸Goroutine ä¼ é€’ç»™ä¸‹æ¸¸Goroutineçš„æŸäº›æ•°æ® Value(key interface{}) interface{} } emptyCtx // An emptyCtx is never canceled, has no values, and has no deadline. It is not // struct{}, since vars of this type must have distinct addresses. type emptyCtx int func (*emptyCtx) Deadline() (deadline time.Time, ok bool) { return } func (*emptyCtx) Done() \u003c-chan struct{} { return nil } func (*emptyCtx) Err() error { return nil } func (*emptyCtx) Value(key interface{}) interface{} { return nil } func (e *emptyCtx) String() string { switch e { case background: return \"context.Background\" case todo: return \"context.TODO\" } return \"unknown empty Context\" } var ( background = new(emptyCtx) todo = new(emptyCtx) ) // Background returns a non-nil, empty Context. It is never canceled, has no // values, and has no deadline. It is typically used by the main function, // initialization, and tests, and as the top-level Context for incoming // requests. func Background() Context { return background } // TODO returns a non-nil, empty Context. Code should use context.TODO when // it's unclear which Context to use or it is not yet available (because the // surrounding function has not yet been extended to accept a Context // parameter). func TODO() Context { return todo } æˆ‘ä»¬çœ‹åˆ° emptyCtx å®ç°äº†Context æ¥å£,ä½†æ˜¯å…¶å®ç°çš„æ–¹æ³•éƒ½æ˜¯ç©ºnil é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“å…¶å®emptyCtx æ˜¯ä¸å…·å¤‡ä»»ä½• å®é™…åŠŸèƒ½çš„,é‚£ä¹ˆå®ƒå­˜åœ¨çš„ç›®çš„æ˜¯ä»€ä¹ˆå‘¢? emptyCtx å­˜åœ¨çš„æ„ä¹‰æ˜¯ä½œä¸º Context å¯¹è±¡æ ‘æ ¹èŠ‚ç‚¹ rootèŠ‚ç‚¹ , åœ¨context.go åŒ…ä¸­æä¾› Background() å’Œ TODO() ä¸¤ä¸ªå‡½æ•° ,è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯è¿”å›çš„éƒ½æ˜¯ emptyCtx å®ä¾‹ ,é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ä»–ä»¬æ¥æ„å»ºContextçš„æ ¹èŠ‚ç‚¹ , æœ‰äº†rootæ ¹èŠ‚ç‚¹ä¹‹å å°±å¯åŒäº‹ context.go åŒ…ä¸­æä¾›çš„å…¶ä»–çš„åŒ…è£…å‡½æ•°åˆ›å»ºå…·æœ‰æ„ä¹‰çš„context å®ä¾‹ ,å¹¶ä¸”æ²¡æœ‰context å®ä¾‹çš„åˆ›å»ºéƒ½æ˜¯ä»¥ä¸Šä¸€ ä¸ª context å®ä¾‹å¯¹è±¡ä½œä¸ºå‚æ•°çš„(æ‰€ä»¥å¿…é¡»æœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹) ,æœ€ç»ˆå½¢æˆä¸€ä¸ªæ ‘çŠ¶çš„ç®¡ç†ç»“æ„ cancelCtx å®šä¹‰äº†cancelCtx ç±»å‹çš„ç»“æ„ä½“ å…¶ä¸­å­—æ®µchildren è®°å½•æ´¾ç”Ÿçš„child,å½“è¯¥ç±»å‹çš„context(ä¸Šä¸‹æ–‡) è¢«æ‰§è¡Œcancelæ˜¯ä¼šå°†æ‰€æœ‰æ´¾ç”Ÿçš„childéƒ½æ‰§è¡Œcancel å¯¹å¤–æš´éœ²äº† Err() Done() String() æ–¹æ³• // A cancelCtx can be canceled. When canceled, it also cancels any children // that implement canceler. type cancelCtx struct { Context mu sync.Mutex // protects following fields done chan struct{} // created lazily, closed by first cancel call children map[canceler]struct{} // set to nil by the first cancel call err error // set to non-nil by the first cancel call } func (c *cancelCtx) Done() \u003c-chan struct{} { c.mu.Lock() if c.done == nil { c.done = make(chan struct{}) } d := c.done c.mu.Unlock() return d } func (c *cancelCtx) Err() error { c.mu.Lock() err := c.err c.mu.Unlock() return err } func (c *cancelCtx) String() string { return fmt.Sprintf(\"%v.WithCancel\", c.Context) } // cancel closes c.done, cancels each of c's children, and, if // removeFromParent is true, removes c from its parent's children. func (c *cancelCtx) cancel(removeFromParent bool, err error) { if err == nil { panic(\"context: internal error: missing cancel error\") } c.mu.Lock() if c.err != nil { c.mu.Unlock() return // already canceled } c.err = err if c.done == nil { c.done = closedchan } else { close(c.done) } for child := ran","date":"2022-05-21","objectID":"/context2/:1:0","tags":["é¢è¯•"],"title":"Context2","uri":"/context2/"},{"categories":["é¢è¯•"],"content":"ä½¿ç”¨ç¤ºä¾‹ context.go åŒ…ä¸­æä¾›äº†4ä¸ªä»¥ With å¼€å¤´çš„å‡½æ•°, è¿™å‡ ä¸ªå‡½æ•°çš„ä¸»è¦åŠŸèƒ½æ˜¯å®ä¾‹åŒ–ä¸åŒç±»å‹çš„context é€šè¿‡ Background() å’Œ TODO() åˆ›å»ºæœ€ emptyCtx å®ä¾‹ ,é€šå¸¸æ˜¯ä½œä¸ºæ ¹èŠ‚ç‚¹ é€šè¿‡ WithCancel() åˆ›å»º cancelCtx å®ä¾‹ é€šè¿‡ WithValue() åˆ›å»º valueCtx å®ä¾‹ é€šè¿‡ WithDeadline å’Œ WithTimeout åˆ›å»º timerCtx å®ä¾‹ WithCancel æºç å¦‚ä¸‹ // newCancelCtx returns an initialized cancelCtx. func newCancelCtx(parent Context) cancelCtx { return cancelCtx{Context: parent} } func WithCancel(parent Context) (ctx Context, cancel CancelFunc) { // åˆ›å»ºcancelCtxå®ä¾‹ c := newCancelCtx(parent) // æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹çš„childrenä¸­ propagateCancel(parent, \u0026c) // è¿”å›å®ä¾‹å’Œæ–¹æ³• return \u0026c, func() { c.cancel(true, Canceled) } } **ä½¿ç”¨ç¤ºä¾‹ : ** package main import ( \"context\" \"fmt\" \"time\" ) func MyOperate1(ctx context.Context) { for { select { default: fmt.Println(\"MyOperate1\", time.Now().Format(\"2006-01-02 15:04:05\")) time.Sleep(2 * time.Second) case \u003c-ctx.Done(): fmt.Println(\"MyOperate1 Done\") return } } } func MyOperate2(ctx context.Context) { fmt.Println(\"Myoperate2\") } func MyDo2(ctx context.Context) { go MyOperate1(ctx) go MyOperate2(ctx) for { select { default: fmt.Println(\"MyDo2 : \", time.Now().Format(\"2006-01-02 15:04:05\")) time.Sleep(2 * time.Second) case \u003c-ctx.Done(): fmt.Println(\"MyDo2 Done\") return } } } func MyDo1(ctx context.Context) { go MyDo2(ctx) for { select { case \u003c-ctx.Done(): fmt.Println(\"MyDo1 Done\") // æ‰“å° ctx å…³é—­åŸå›  fmt.Println(ctx.Err()) return default: fmt.Println(\"MyDo1 : \", time.Now().Format(\"2006-01-02 15:04:05\")) time.Sleep(2 * time.Second) } } } func main() { // åˆ›å»º cancelCtx å®ä¾‹ // ä¼ å…¥context.Background() ä½œä¸ºæ ¹èŠ‚ç‚¹ ctx, cancel := context.WithCancel(context.Background()) // å‘åç¨‹ä¸­ä¼ é€’ctx go MyDo1(ctx) time.Sleep(5 * time.Second) fmt.Println(\"stop all goroutines\") // æ‰§è¡Œcancelæ“ä½œ cancel() time.Sleep(2 * time.Second) } WithDeadline è®¾ç½®äº†deadlineçš„context è¿™ä¸ªdeadline(æœ€ç»ˆæœŸé™) è¡¨ç¤ºcontextåœ¨æŒ‡å®šçš„æ—¶åˆ»ç»“æŸ æºç å¦‚ä¸‹ func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) { if cur, ok := parent.Deadline(); ok \u0026\u0026 cur.Before(d) { // The current deadline is already sooner than the new one. return WithCancel(parent) } c := \u0026timerCtx{ cancelCtx: newCancelCtx(parent), deadline: d, } propagateCancel(parent, c) dur := time.Until(d) if dur \u003c= 0 { c.cancel(true, DeadlineExceeded) // deadline has already passed return c, func() { c.cancel(false, Canceled) } } c.mu.Lock() defer c.mu.Unlock() if c.err == nil { c.timer = time.AfterFunc(dur, func() { c.cancel(true, DeadlineExceeded) }) } return c, func() { c.cancel(true, Canceled) } } ä½¿ç”¨ç¤ºä¾‹ package main import ( \"context\" \"fmt\" \"time\" ) func dl2(ctx context.Context) { n := 1 for { select { case \u003c-ctx.Done(): fmt.Println(ctx.Err()) return default: fmt.Println(\"dl2 : \", n) n++ time.Sleep(time.Second) } } } func dl1(ctx context.Context) { n := 1 for { select { case \u003c-ctx.Done(): fmt.Println(ctx.Err()) return default: fmt.Println(\"dl1 : \", n) n++ time.Sleep(2 * time.Second) } } } func main() { // è®¾ç½®deadlineä¸ºå½“å‰æ—¶é—´ä¹‹åçš„5ç§’é‚£ä¸ªæ—¶åˆ» d := time.Now().Add(5 * time.Second) ctx, cancel := context.WithDeadline(context.Background(), d) defer cancel() go dl1(ctx) go dl2(ctx) for{ select { case \u003c-ctx.Done(): fmt.Println(\"over\",ctx.Err()) return } } } WithTimeout å®é™…å°±æ˜¯è°ƒç”¨äº†WithDeadline() æºç å¦‚ä¸‹ func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) { return WithDeadline(parent, time.Now().Add(timeout)) } ä½¿ç”¨ç¤ºä¾‹ : package main import ( \"context\" \"fmt\" \"time\" ) func to1(ctx context.Context) { n := 1 for { select { case \u003c-ctx.Done(): fmt.Println(\"to1 is over\") return default: fmt.Println(\"to1 : \", n) n++ time.Sleep(time.Second) } } } func main() { // è®¾ç½®ä¸º6ç§’åcontextç»“æŸ ctx, cancel := context.WithTimeout(context.Background(), 6*time.Second) defer cancel() go to1(ctx) n := 1 for { select { case \u003c-time.Tick(2 * time.Second): if n == 9 { return } fmt.Println(\"number :\", n) n++ } } } WithValue ä»…æ˜¯åœ¨Context åŸºç¡€ä¸Šæ·»åŠ äº† key : value çš„é”®å€¼å¯¹ context å½¢æˆçš„æ ‘çŠ¶ç»“æ„,åé¢çš„èŠ‚ç‚¹å¯ä»¥è®¿é—®å‰é¢èŠ‚ç‚¹ä¼ å¯¼çš„æ•°æ® æºç å¦‚ä¸‹ : func WithValue(parent Context, key, val interface{}) Context { if key == nil { panic(\"nil key\") } if !reflect.TypeOf(key).Comparable() { panic(\"key is not comparable\") } return \u0026valueCtx{parent, key,","date":"2022-05-21","objectID":"/context2/:2:0","tags":["é¢è¯•"],"title":"Context2","uri":"/context2/"},{"categories":["é¢è¯•"],"content":"select ç¬¬ä¸€ç§æ˜¯selectã€‚ æˆ‘ä»¬å¯ä»¥è®¾ç½®è¦ç­‰å¾…çš„æè¿°ç¬¦ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ç­‰å¾…è¶…æ—¶æ—¶é—´ã€‚å¦‚æœæœ‰å‡†å¤‡å¥½çš„fdï¼Œæˆ–è¾¾åˆ°æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œselectå‡½æ•°å°±ä¼šè¿”å›ã€‚ ä»å‡½æ•°ç­¾åæ¥çœ‹ï¼Œå®ƒæ”¯æŒç›‘å¬å¯è¯»ã€å¯å†™ã€å¼‚å¸¸ä¸‰ç±»äº‹ä»¶ã€‚ å› ä¸ºè¿™ä¸ªfd_setæ˜¯ä¸ªunsigned longå‹çš„æ•°ç»„ã€‚å…±16ä¸ªå…ƒç´ ï¼Œæ¯ä¸€ä½å¯¹åº”ä¸€ä¸ªfdï¼Œæœ€å¤šå¯ä»¥ç›‘å¬1024ä¸ªï¼Œè¿™å°±æœ‰ç‚¹å°‘äº†ã€‚ è€Œä¸”æ¯æ¬¡è°ƒç”¨selectéƒ½è¦ä¼ é€’æ‰€æœ‰çš„ç›‘å¬é›†åˆã€‚è¿™å°±éœ€è¦é¢‘ç¹çš„ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ‹·è´æ•°æ®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå³ä¾¿æœ‰fdå°±ç»ªäº†ï¼Œä¹Ÿéœ€è¦éå†æ•´ä¸ªç›‘å¬é›†åˆï¼Œæ¥åˆ¤æ–­å“ªä¸ªfdæ˜¯å¯æ“ä½œçš„ã€‚è¿™äº›éƒ½ä¼šå½±å“æ€§èƒ½ã€‚ poll ç¬¬äºŒç§IOå¤šè·¯å¤ç”¨çš„å®ç°æ–¹å¼æ˜¯pollã€‚ è™½ç„¶æ”¯æŒçš„fdæ•°ç›®ï¼Œç­‰äºæœ€å¤šå¯ä»¥æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ã€‚ä½†æ˜¯å¦å¤–ä¸¤ä¸ªé—®é¢˜ä¾ç„¶å­˜åœ¨ã€‚ epoll è€Œepollå°±æ²¡æœ‰è¿™äº›é—®é¢˜äº†ï¼Œå®ƒæä¾›ä¸‰ä¸ªæ¥å£ã€‚ epoll_create1ç”¨äºåˆ›å»ºä¸€ä¸ªepollï¼Œå¹¶è·å–ä¸€ä¸ªå¥æŸ„ã€‚ epoll_ctlç”¨äºæ·»åŠ æˆ–åˆ é™¤fdä¸å¯¹åº”çš„äº‹ä»¶ä¿¡æ¯ã€‚ é™¤äº†æŒ‡å®šfdå’Œè¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ï¼Œè¿˜å¯ä»¥ä¼ å…¥ä¸€ä¸ªevent dataï¼Œé€šå¸¸ä¼šæŒ‰éœ€å®šä¹‰ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œç”¨äºå¤„ç†å¯¹åº”çš„fdã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡éƒ½åªéœ€ä¼ å…¥è¦æ“ä½œå¯¹çš„ä¸€ä¸ªfdï¼Œæ— éœ€ä¼ å…¥æ‰€æœ‰ç›‘å¬é›†åˆï¼Œè€Œä¸”åªéœ€è¦æ³¨å†Œè¿™ä¸€æ¬¡ã€‚é€šè¿‡epoll_waitå¾—åˆ°çš„fdé›†åˆéƒ½æ˜¯ä»¥åŠå°±ç»ªçš„ï¼Œé€ä¸ªå¤„ç†å³å¯ï¼Œæ— éœ€éå†æ‰€æœ‰ç›‘å¬é›†åˆã€‚ é€šè¿‡IOå¤šè·¯å¤ç”¨ï¼Œçº¿ç¨‹å†ä¹Ÿä¸ç”¨ä¸ºç­‰å¾…æŸä¸€ä¸ªsocketï¼Œè€Œé˜»å¡æˆ–ç©ºè€—CPUã€‚å¹¶å‘å¤„ç†èƒ½åŠ›å› è€Œå¤§å¹…æå‡ã€‚ IOå¤šè·¯å¤ç”¨ç»“åˆåç¨‹ ä½†æ˜¯IOå¤šè·¯å¤ç”¨ä¹Ÿå¹¶éæ²¡æœ‰é—®é¢˜ï¼Œä¾‹å¦‚ï¼šä¸€ä¸ªsocketå¯è¯»äº†ï¼Œä½†æ˜¯è¿™å›åªè¯»åˆ°äº†åŠæ¡è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦å†æ¬¡ç­‰å¾…è¿™ä¸ªsocketå¯è¯»ã€‚åœ¨ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªsocketä¹‹å‰ï¼Œéœ€è¦è®°å½•ä¸‹è¿™ä¸ªsocketçš„å¤„ç†çŠ¶æ€ã€‚ä¸‹ä¸€æ¬¡è¿™ä¸ªsocketå¯è¯»æ—¶ï¼Œä¹Ÿéœ€è¦æ¢å¤ä¸Šæ¬¡ä¿å­˜çš„ç°åœºï¼Œæ‰å¥½ç»§ç»­å¤„ç†ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨IOå¤šè·¯å¤ç”¨ä¸­å®ç°ä¸šåŠ¡é€»è¾‘æ—¶ï¼Œæˆ‘ä»¬éœ€è¦éšç€äº‹ä»¶çš„ç­‰å¾…å’Œå°±ç»ªï¼Œè€Œé¢‘ç¹çš„ä¿å­˜å’Œæ¢å¤ç°åœºï¼Œè¿™å¹¶ä¸ç¬¦åˆå¸¸è§„çš„å¼€å‘ä¹ æƒ¯ã€‚å¦‚æœä¸šåŠ¡é€»è¾‘æ¯”è¾ƒç®€å•è¿˜å¥½ï¼Œè‹¥æ˜¯æ¯”è¾ƒå¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼Œå°±æœ‰äº›æ‚²å‰§äº†ã€‚ æ—¢ç„¶ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œè¦ç­‰å¾…äº‹ä»¶æ—¶ï¼Œéœ€è¦ä¿å­˜ç°åœºå¹¶åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå°±ç»ªçš„fdã€‚è€Œäº‹ä»¶å°±ç»ªæ—¶ï¼Œåˆéœ€è¦æ¢å¤ç°åœºç»§ç»­å¤„ç†ã€‚é‚£å²‚ä¸æ˜¯å¾ˆé€‚åˆä½¿ç”¨åç¨‹ï¼Ÿ åœ¨IOå¤šè·¯å¤ç”¨è¿™é‡Œï¼Œäº‹ä»¶å¾ªç¯ä¾ç„¶å­˜åœ¨ï¼Œä¾ç„¶è¦åœ¨å¾ªç¯ä¸­é€ä¸ªå¤„ç†å°±ç»ªçš„fdï¼Œä½†å¤„ç†è¿‡ç¨‹å´ä¸æ˜¯å›´ç»•å…·ä½“ä¸šåŠ¡ï¼Œè€Œæ˜¯é¢å‘åç¨‹è°ƒåº¦ã€‚ å¦‚æœæ˜¯ç”¨äºç›‘å¬ç«¯å£çš„fdå°±ç»ªäº†ï¼Œå°±å»ºç«‹è¿æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„fdï¼Œäº¤ç»™ä¸€ä¸ªåç¨‹æ¥è´Ÿè´£, åç¨‹æ‰§è¡Œå…¥å£å°±æŒ‡å‘ä¸šåŠ¡å¤„ç†å‡½æ•°å…¥å£ï¼Œä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ç­‰å¾…æ—¶å°±æ³¨å†ŒIOäº‹ä»¶ï¼Œç„¶åè®©å‡ºï¼Œè¿™æ ·ï¼Œæ‰§è¡Œæƒå°±ä¼šå›åˆ°åˆ‡æ¢åˆ°è¯¥åç¨‹çš„åœ°æ–¹ç»§ç»­æ‰§è¡Œã€‚å¦‚æœæ˜¯å…¶å®ƒç­‰å¾…IOäº‹ä»¶çš„fdå°±ç»ªäº†ï¼Œåªéœ€è¦æ¢å¤å…³è”çš„åç¨‹å³å¯ã€‚ åç¨‹æ‹¥æœ‰è‡ªå·±çš„æ ˆï¼Œè¦ä¿å­˜å’Œæ¢å¤ç°åœºéƒ½å¾ˆå®¹æ˜“å®ç°ã€‚è¿™æ ·ï¼ŒIOå¤šè·¯å¤ç”¨è¿™ä¸€å±‚çš„äº‹ä»¶å¾ªç¯ï¼Œå°±å’Œå…·ä½“ä¸šåŠ¡é€»è¾‘è§£è€¦äº†ã€‚ å¯ä»¥æŠŠreadã€writeã€connectç­‰å¯èƒ½ä¼šå‘ç”Ÿç­‰å¾…çš„å‡½æ•°åŒ…è£…ä¸€ä¸‹ï¼Œåœ¨å…¶ä¸­å®ç°IOäº‹ä»¶æ³¨å†Œä¸ä¸»åŠ¨è®©å‡ºã€‚è¿™æ ·åœ¨ä¸šåŠ¡é€»è¾‘å±‚é¢ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™äº›åŒ…è£…å‡½æ•°ï¼ŒæŒ‰ç…§å¸¸è§„çš„é¡ºåºç¼–ç¨‹æ–¹å¼ï¼Œæ¥å®ç°ä¸šåŠ¡é€»è¾‘äº†ã€‚ è¿™äº›åŒ…è£…å‡½æ•°åœ¨éœ€è¦ç­‰å¾…æ—¶ï¼Œå°±ä¼šæ³¨å†ŒIOäº‹ä»¶ï¼Œç„¶åè®©å‡ºåç¨‹ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨å®ç°ä¸šåŠ¡é€»è¾‘æ—¶ï¼Œå°±å®Œå…¨ä¸ç”¨æ‹…å¿ƒä¿å­˜ä¸æ¢å¤ç°åœºçš„é—®é¢˜äº†ã€‚ åç¨‹å’ŒIOå¤šè·¯å¤ç”¨ä¹‹é—´çš„åˆä½œï¼Œä¸ä»…ä¿ç•™äº†IOå¤šè·¯å¤ç”¨çš„é«˜å¹¶å‘æ€§èƒ½ï¼Œè¿˜è§£æ”¾äº†ä¸šåŠ¡é€»è¾‘çš„å®ç°ã€‚ ","date":"2022-05-16","objectID":"/io%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/:0:0","tags":["é¢è¯•"],"title":"Ioå¤šè·¯å¤ç”¨","uri":"/io%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/"},{"categories":["é¢è¯•"],"content":"slice åˆ‡ç‰‡ åˆ‡ç‰‡æ˜¯åŸºäºæ•°ç»„å®ç°çš„ï¼Œå®ƒçš„åº•å±‚æ˜¯æ•°ç»„ï¼Œå¯ä»¥ç†è§£ä¸ºå¯¹ åº•å±‚æ•°ç»„çš„æŠ½è±¡ã€‚ åˆ‡ç‰‡ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ æºç åŒ…ä¸­src/runtime/slice.go å®šä¹‰äº†sliceçš„æ•°æ®ç»“æ„ï¼š type slice struct { array unsafe.Pointer //åº•å±‚æŒ‡é’ˆ len int //é•¿åº¦ cap int //é¢„å­˜ç©ºé—´ } sliceï¼šå ç”¨24ä¸ªå­—èŠ‚ arrayï¼šæŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆï¼Œå ç”¨8ä¸ªå­—èŠ‚ lenï¼šåˆ‡ç‰‡çš„é•¿åº¦ï¼Œå ç”¨8ä¸ªå­—èŠ‚ capï¼šåˆ‡ç‰‡çš„å®¹é‡ï¼Œcap æ€»æ˜¯å¤§äºç­‰äº len çš„ï¼Œå ç”¨8ä¸ªå­—èŠ‚ sliceæœ‰4ç§åˆå§‹åŒ–æ–¹å¼ // åˆå§‹åŒ–æ–¹å¼1ï¼šç›´æ¥å£°æ˜ var slice1 []int // åˆå§‹åŒ–æ–¹å¼2ï¼šä½¿ç”¨å­—é¢é‡ slice2 := []int{1, 2, 3, 4} // åˆå§‹åŒ–æ–¹å¼3ï¼šä½¿ç”¨makeåˆ›å»ºslice slice3 := make([]int, 3, 5) // åˆå§‹åŒ–æ–¹å¼4: ä»åˆ‡ç‰‡æˆ–æ•°ç»„â€œæˆªå–â€ slcie4 := arr[1:3] é€šè¿‡ä¸€ä¸ªç®€å•ç¨‹åºï¼Œçœ‹ä¸‹sliceåˆå§‹åŒ–è°ƒç”¨çš„åº•å±‚å‡½æ•° package main import \"fmt\" func main() { slice := make([]int, 0) slice = append(slice, 1) fmt.Println(slice, len(slice), cap(slice)) } é€šè¿‡ go tool compile -S test.go | grep CALL å¾—åˆ°æ±‡ç¼–ä»£ç  0x0042 00066 (test.go:6) CALL runtime.makeslice(SB) 0x006d 00109 (test.go:7) CALL runtime.growslice(SB) 0x00a4 00164 (test.go:8) CALL runtime.convTslice(SB) 0x00c0 00192 (test.go:8) CALL runtime.convT64(SB) 0x00d8 00216 (test.go:8) CALL runtime.convT64(SB) 0x0166 00358 ($GOROOT/src/fmt/print.go:274) CALL fmt.Fprintln(SB) 0x0180 00384 (test.go:5) CALL runtime.morestack_noctxt(SB) 0x0079 00121 (\u003cautogenerated\u003e:1) CALL runtime.efaceeq(SB) 0x00a0 00160 (\u003cautogenerated\u003e:1) CALL runtime.morestack_noctxt(SB) åˆå§‹åŒ–sliceè°ƒç”¨çš„æ˜¯runtime.makesliceï¼Œmakesliceå‡½æ•°çš„å·¥ä½œä¸»è¦å°±æ˜¯è®¡ç®—sliceæ‰€éœ€å†…å­˜å¤§å°ï¼Œç„¶åè°ƒç”¨mallocgcè¿›è¡Œå†…å­˜çš„åˆ†é… æ‰€éœ€å†…å­˜å¤§å° = åˆ‡ç‰‡ä¸­å…ƒç´ å¤§å° * åˆ‡ç‰‡çš„å®¹é‡ func makeslice(et *_type, len, cap int) unsafe.Pointer { mem, overflow := math.MulUintptr(et.size, uintptr(cap)) if overflow || mem \u003e maxAlloc || len \u003c 0 || len \u003e cap { // NOTE: Produce a len out of range error instead of a // cap out of range error when someone does make([]T, bignumber). // cap out of range is true too, but since the cap is only being // supplied implicitly, saying len is clearer. // See golang.org/issue/4085. mem, overflow := math.MulUintptr(et.size, uintptr(len)) if overflow || mem \u003e maxAlloc || len \u003c 0 { panicmakeslicelen() } panicmakeslicecap() } return mallocgc(mem, et, true) } æ•°ç»„å’Œåˆ‡ç‰‡sliceçš„åŒºåˆ« 1ï¼‰ æ•°ç»„é•¿åº¦ä¸åŒ æ•°ç»„åˆå§‹åŒ–å¿…é¡»æŒ‡å®šé•¿åº¦ï¼Œå¹¶ä¸”é•¿åº¦å°±æ˜¯å›ºå®šçš„ åˆ‡ç‰‡çš„é•¿åº¦æ˜¯ä¸å›ºå®šçš„ï¼Œå¯ä»¥è¿½åŠ å…ƒç´ ï¼Œåœ¨è¿½åŠ æ—¶å¯èƒ½ä½¿åˆ‡ç‰‡çš„å®¹é‡å¢å¤§ 2ï¼‰å‡½æ•°ä¼ å‚ä¸åŒ æ•°ç»„æ˜¯å€¼ç±»å‹ï¼Œå°†ä¸€ä¸ªæ•°ç»„èµ‹å€¼ç»™å¦ä¸€ä¸ªæ•°ç»„æ—¶ï¼Œä¼ é€’çš„æ˜¯ä¸€ä»½æ·±æ‹·è´ï¼Œå‡½æ•°ä¼ å‚æ“ä½œéƒ½ä¼šå¤åˆ¶æ•´ä¸ªæ•°ç»„æ•°æ®ï¼Œä¼šå ç”¨é¢å¤–çš„å†…å­˜ï¼Œå‡½æ•°å†…å¯¹æ•°ç»„å…ƒç´ å€¼çš„ä¿®æ”¹ï¼Œä¸ä¼šä¿®æ”¹åŸæ•°ç»„å†…å®¹ã€‚ åˆ‡ç‰‡æ˜¯å¼•ç”¨ç±»å‹ï¼Œå°†ä¸€ä¸ªåˆ‡ç‰‡èµ‹å€¼ç»™å¦ä¸€ä¸ªåˆ‡ç‰‡æ—¶ï¼Œä¼ é€’çš„æ˜¯ä¸€ä»½æµ…æ‹·è´ï¼Œå‡½æ•°ä¼ å‚æ“ä½œä¸ä¼šæ‹·è´æ•´ä¸ªåˆ‡ç‰‡ï¼Œåªä¼šå¤åˆ¶lenå’Œcapï¼Œåº•å±‚å…±ç”¨åŒä¸€ä¸ªæ•°ç»„ï¼Œä¸ä¼šå ç”¨é¢å¤–çš„å†…å­˜ï¼Œå‡½æ•°å†…å¯¹æ•°ç»„å…ƒç´ å€¼çš„ä¿®æ”¹ï¼Œä¼šä¿®æ”¹åŸæ•°ç»„å†…å®¹ã€‚ 3ï¼‰è®¡ç®—æ•°ç»„é•¿åº¦æ–¹å¼ä¸åŒ æ•°ç»„éœ€è¦éå†è®¡ç®—æ•°ç»„é•¿åº¦ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n) åˆ‡ç‰‡åº•å±‚åŒ…å«lenå­—æ®µï¼Œå¯ä»¥é€šè¿‡len()è®¡ç®—åˆ‡ç‰‡é•¿åº¦ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(1) Map Goä¸­çš„mapæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå ç”¨8ä¸ªå­—èŠ‚ï¼ŒæŒ‡å‘hmapç»“æ„ä½“ æºç åŒ…ä¸­src/runtime/map.goå®šä¹‰äº†hmapçš„æ•°æ®ç»“æ„ï¼š hmapåŒ…å«è‹¥å¹²ä¸ªç»“æ„ä¸ºbmapçš„æ•°ç»„ï¼Œæ¯ä¸ªbmapåº•å±‚éƒ½é‡‡ç”¨é“¾è¡¨ç»“æ„ï¼Œbmapé€šå¸¸å«å…¶bucket hmapç»“æ„ä½“ // A header for a Go map. type hmap struct { count int // ä»£è¡¨å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œè°ƒç”¨len(map)æ—¶ï¼Œè¿”å›çš„å°±æ˜¯è¯¥å­—æ®µå€¼ã€‚ flags uint8 // çŠ¶æ€æ ‡å¿—ï¼ˆæ˜¯å¦å¤„äºæ­£åœ¨å†™å…¥çš„çŠ¶æ€ç­‰ï¼‰ B uint8 // bucketsï¼ˆæ¡¶ï¼‰çš„å¯¹æ•° // å¦‚æœB=5ï¼Œåˆ™bucketsæ•°ç»„çš„é•¿åº¦ = 2^B=32ï¼Œæ„å‘³ç€æœ‰32ä¸ªæ¡¶ noverflow uint16 // æº¢å‡ºæ¡¶çš„æ•°é‡ hash0 uint32 // ç”Ÿæˆhashçš„éšæœºæ•°ç§å­ buckets unsafe.Pointer // æŒ‡å‘bucketsæ•°ç»„çš„æŒ‡é’ˆï¼Œæ•°ç»„å¤§å°ä¸º2^Bï¼Œå¦‚æœå…ƒç´ ä¸ªæ•°ä¸º0ï¼Œå®ƒä¸ºnilã€‚ oldbuckets unsafe.Pointer // å¦‚æœå‘ç”Ÿæ‰©å®¹ï¼Œoldbucketsæ˜¯æŒ‡å‘è€çš„bucketsæ•°ç»„çš„æŒ‡é’ˆï¼Œè€çš„bucketsæ•°ç»„å¤§å°æ˜¯æ–°çš„bucketsçš„1/2;éæ‰©å®¹çŠ¶æ€ä¸‹ï¼Œå®ƒä¸ºnilã€‚ nevacuate uintptr // è¡¨ç¤ºæ‰©å®¹è¿›åº¦ï¼Œå°äºæ­¤åœ°å€çš„bucketsä»£è¡¨å·²æ¬è¿å®Œæˆã€‚ extra *mapextra // å­˜å‚¨æº¢å‡ºæ¡¶ï¼Œè¿™ä¸ªå­—æ®µæ˜¯ä¸ºäº†ä¼˜åŒ–GCæ‰«æè€Œè®¾è®¡çš„ï¼Œä¸‹é¢è¯¦ç»†ä»‹ç» } bmapç»“æ„ä½“ bmap å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„â€œæ¡¶â€ï¼Œä¸€ä¸ªæ¡¶é‡Œé¢ä¼šæœ€å¤šè£… 8 ä¸ª keyï¼Œè¿™äº› key ä¹‹æ‰€ä»¥ä¼šè½å…¥åŒä¸€ä¸ªæ¡¶ï¼Œæ˜¯å› ä¸ºå®ƒä»¬ç»è¿‡å“ˆå¸Œè®¡ç®—åï¼Œå“ˆå¸Œç»“æœçš„ä½Bä½æ˜¯ç›¸åŒçš„ï¼Œå…³äºkeyçš„å®šä½æˆ‘ä»¬åœ¨mapçš„æŸ¥è¯¢ä¸­è¯¦ç»†è¯´æ˜ã€‚åœ¨æ¡¶å†…ï¼Œåˆä¼šæ ¹æ® key è®¡ç®—å‡ºæ¥çš„ hash å€¼çš„é«˜ 8 ä½æ¥å†³å®š key åˆ°åº•è½å…¥æ¡¶å†…çš„å“ªä¸ªä½ç½®ï¼ˆä¸€ä¸ªæ¡¶å†…æœ€å¤šæœ‰8ä¸ªä½ç½®)ã€‚ // A bucket for a Go map. type bmap struct { tophash [bucketCnt]uint8 // lenä¸º8çš„æ•°ç»„ // ç”¨æ¥å¿«é€Ÿå®šä½keyæ˜¯å¦åœ¨è¿™ä¸ªbmapä¸­ // ä¸€ä¸ªæ¡¶æœ€å¤š8ä¸ªæ§½ä½ï¼Œå¦‚æœkeyæ‰€åœ¨çš„tophashå€¼åœ¨tophashä¸­ï¼Œåˆ™ä»£è¡¨è¯¥keyåœ¨è¿™ä¸ªæ¡¶ä¸­ } ä¸Šé¢bmapç»“æ„æ˜¯é™æ€ç»“æ„ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­runtime.bmapä¼šæ‹“å±•æˆä»¥ä¸‹ç»“æ„ä½“ï¼š type bmap struct{ tophash [8]uint8 keys [8]keytype // keytype ç”±ç¼–è¯‘å™¨ç¼–è¯‘æ—¶å€™ç¡®å®š values [8]elemtype // elemtype ç”±ç¼–è¯‘å™¨ç¼–è¯‘æ—¶å€™ç¡®å®š overflow uintptr // overflowæŒ‡å‘ä¸‹ä¸€ä¸ªbmapï¼Œoverflowæ˜¯uintptrè€Œä¸æ˜¯*bmapç±»å‹ï¼Œä¿è¯bmapå®Œå…¨ä¸å«æŒ‡é’ˆï¼Œæ˜¯ä¸ºäº†å‡å°‘gcï¼Œæº¢å‡ºæ¡¶å­˜å‚¨åˆ°extraå­—æ®µä¸­ } tophashå°±æ˜¯ç”¨äºå®ç°å¿«é€Ÿå®šä½keyçš„ä½ç½®ï¼Œåœ¨å®ç°è¿‡ç¨‹ä¸­ä¼šä½¿ç”¨keyçš„hashå€¼çš„é«˜8ä½ä½œä¸ºtophashå€¼ï¼Œå­˜æ”¾åœ¨bmapçš„tophashå­—æ®µä¸­ tophashå­—æ®µä¸ä»…å­˜å‚¨keyå“ˆå¸Œå€¼çš„é«˜8ä½ï¼Œè¿˜ä¼šå­˜å‚¨ä¸€äº›çŠ¶æ€å€¼ï¼Œç”¨æ¥è¡¨æ˜å½“å‰æ¡¶å•å…ƒçŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€å€¼éƒ½æ˜¯å°äºminTopHashçš„ ä¸ºäº†é¿å…keyå“ˆå¸Œå€¼çš„é«˜8ä½å€¼å’Œè¿™äº›çŠ¶æ€å€¼ç›¸ç­‰ï¼Œäº§ç”Ÿæ··æ·†æƒ…å†µï¼Œæ‰€ä»¥å½“keyå“ˆå¸Œå€¼é«˜8ä½è‹¥å°äºminTopHashæ—¶å€™ï¼Œè‡ªåŠ¨å°†å…¶å€¼åŠ ä¸ŠminTopHashä½œä¸ºè¯¥keyçš„tophashã€‚æ¡¶å•å…ƒçš„çŠ¶æ€å€¼å¦‚ä¸‹ï¼š emptyRest = 0 // è¡¨æ˜æ­¤æ¡¶å•å…ƒä¸ºç©ºï¼Œä¸”æ›´é«˜ç´¢å¼•çš„å•å…ƒä¹Ÿæ˜¯ç©º emptyOne = 1 // è¡¨æ˜æ­¤æ¡¶å•å…ƒä¸ºç©º evacuatedX = 2 // ç”¨äºè¡¨ç¤ºæ‰©å®¹è¿ç§»åˆ°æ–°æ¡¶å‰åŠæ®µåŒºé—´ evacuatedY = 3 // ç”¨äºè¡¨ç¤ºæ‰©å®¹è¿ç§»åˆ°æ–°æ¡¶ååŠæ®µåŒºé—´ evacuatedEmpty = 4 // ç”¨äºè¡¨ç¤ºæ­¤å•å…ƒå·²è¿ç§» minTopHash = 5 // keyçš„tophashå€¼ä¸æ¡¶çŠ¶æ€å€¼åˆ†å‰²çº¿å€¼ï¼Œå°äºæ­¤å€¼çš„ä¸€å®šä»£è¡¨ç€æ¡¶å•å…ƒçš„çŠ¶æ€ï¼Œå¤§äºæ­¤å€¼çš„ä¸€å®šæ˜¯keyå¯¹åº”çš„tophashå€¼ func tophash(hash uintptr) uint8 { top ","date":"2022-05-10","objectID":"/map%E5%92%8Cslice%E5%8E%9F%E7%90%86%E5%BA%95%E5%B1%82/:0:0","tags":["é¢è¯•"],"title":"Mapå’ŒsliceåŸç†åº•å±‚","uri":"/map%E5%92%8Cslice%E5%8E%9F%E7%90%86%E5%BA%95%E5%B1%82/"},{"categories":["é¢è¯•"],"content":"æ€»ç»“ bmapï¼ˆbucketï¼‰å†…å­˜æ•°æ®ç»“æ„å¯è§†åŒ–å¦‚ä¸‹: æ³¨æ„åˆ° key å’Œ value æ˜¯å„è‡ªæ”¾åœ¨ä¸€èµ·çš„ï¼Œå¹¶ä¸æ˜¯ key/value/key/value/â€¦ è¿™æ ·çš„å½¢å¼ï¼Œå½“keyå’Œvalueç±»å‹ä¸ä¸€æ ·çš„æ—¶å€™ï¼Œkeyå’Œvalueå ç”¨å­—èŠ‚å¤§å°ä¸ä¸€æ ·ï¼Œä½¿ç”¨key/valueè¿™ç§å½¢å¼å¯èƒ½ä¼šå› ä¸ºå†…å­˜å¯¹é½å¯¼è‡´å†…å­˜ç©ºé—´æµªè´¹ï¼Œæ‰€ä»¥Goé‡‡ç”¨keyå’Œvalueåˆ†å¼€å­˜å‚¨çš„è®¾è®¡ï¼Œæ›´èŠ‚çœå†…å­˜ç©ºé—´ ","date":"2022-05-10","objectID":"/map%E5%92%8Cslice%E5%8E%9F%E7%90%86%E5%BA%95%E5%B1%82/:1:0","tags":["é¢è¯•"],"title":"Mapå’ŒsliceåŸç†åº•å±‚","uri":"/map%E5%92%8Cslice%E5%8E%9F%E7%90%86%E5%BA%95%E5%B1%82/"},{"categories":["é¢è¯•"],"content":"å†…å­˜é€ƒé€¸ ","date":"2022-05-10","objectID":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/:0:0","tags":["é¢è¯•"],"title":"å†…å­˜é€ƒé€¸","uri":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/"},{"categories":["é¢è¯•"],"content":"æš‚æ—¶æ€§å†…å­˜æ³„æ¼ è·å–é•¿å­—ç¬¦ä¸²ä¸­çš„ä¸€æ®µå¯¼è‡´é•¿å­—ç¬¦ä¸²æœªè¢«é‡Šæ”¾ è·å–é•¿sliceä¸­çš„ä¸€æ®µå¯¼è‡´é•¿sliceæœªè¢«é‡Šæ”¾ åœ¨é•¿sliceä¸­æ–°å»ºsliceå¯¼è‡´æ³„æ¼ ","date":"2022-05-10","objectID":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/:0:1","tags":["é¢è¯•"],"title":"å†…å­˜é€ƒé€¸","uri":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/"},{"categories":["é¢è¯•"],"content":"æ°¸ä¹…æ€§å†…å­˜æ³„æ¼ goroutineæ³„æ¼ time.Ticker æœªå…³é—­å¯¼è‡´æ³„æ¼ Finalizerå¯¼è‡´æ³„æ¼ Deferring Function Callå¯¼è‡´æ³„æ¼ ","date":"2022-05-10","objectID":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/:0:2","tags":["é¢è¯•"],"title":"å†…å­˜é€ƒé€¸","uri":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/"},{"categories":["é¢è¯•"],"content":"å¸¸è§çš„å†…å­˜é€ƒé€¸ æŒ‡é’ˆé€ƒé€¸ æ ˆç©ºé—´ä¸è¶³ å˜é‡å¤§å°ä¸ç¡®å®š åŠ¨æ€ç±»å‹ é—­åŒ…å¼•ç”¨å¯¹è±¡ ","date":"2022-05-10","objectID":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/:1:0","tags":["é¢è¯•"],"title":"å†…å­˜é€ƒé€¸","uri":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/"},{"categories":["é¢è¯•"],"content":"å°æ€»ç»“ æ ˆä¸Šåˆ†é…å†…å­˜æ¯”åœ¨å †ä¸­åˆ†é…å†…å­˜æ•ˆç‡æ›´é«˜ æ ˆä¸Šåˆ†é…çš„å†…å­˜ä¸éœ€è¦ GC å¤„ç†ï¼Œè€Œå †éœ€è¦ é€ƒé€¸åˆ†æç›®çš„æ˜¯å†³å®šå†…åˆ†é…åœ°å€æ˜¯æ ˆè¿˜æ˜¯å † é€ƒé€¸åˆ†æåœ¨ç¼–è¯‘é˜¶æ®µå®Œæˆ ","date":"2022-05-10","objectID":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/:2:0","tags":["é¢è¯•"],"title":"å†…å­˜é€ƒé€¸","uri":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/"},{"categories":["é¢è¯•"],"content":"å †ä¸æ ˆ ","date":"2022-05-10","objectID":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/:3:0","tags":["é¢è¯•"],"title":"å†…å­˜é€ƒé€¸","uri":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/"},{"categories":["é¢è¯•"],"content":"å¸¸è§çš„é€ƒé€¸ç°è±¡ package main import \"fmt\" func main() { name := test() fmt.Println(name()) } func test() func() string { return func() string { //name ä»åŸæ¥çš„æ ˆä¸Šï¼Œé€ƒé€¸åˆ°å †ä¸Š return \"å…¬ä¼—å·-åç«¯æ—¶å…‰\" } } // go build -gcflags=\"-m -l\" eee.go // -mï¼šè¡¨ç¤ºå†…å­˜åˆ†æ -lï¼šè¡¨ç¤ºé˜²æ­¢å†…è”ä¼˜åŒ– åŸå› æ˜¯ go/src/fmt/print.go æ–‡ä»¶ä¸­ Println æ–¹æ³•ä¼ å‚æ•°ç±»å‹ interface{}, ç¼–è¯‘å™¨å¯¹ä¼ å…¥çš„å˜é‡ç±»å‹æœªçŸ¥ï¼Œæ‰€æœ‰ç»Ÿä¸€å¤„ç†åˆ†é…åˆ°äº†å †ä¸Šé¢å»äº†ã€‚ pprofæ’æŸ¥ ä»€ä¹ˆæ˜¯pprof? pprofæ˜¯Goçš„æ€§èƒ½åˆ†æå·¥å…·,åœ¨ç¨‹åºè¿è¡Œä¸­å¯ä»¥è®°å½•ç¨‹åºçš„è¿è¡Œä¿¡æ¯,å¯ä»¥æ˜¯CPUä½¿ç”¨æƒ…å†µã€å†…å­˜ä½¿ç”¨æƒ…å†µã€goroutineè¿è¡ŒçŠ¶å†µç­‰,å½“éœ€è¦æ€§èƒ½è°ƒä¼˜æˆ–å®šä½bugæ—¶å€™,è¿™äº›è®°å½•çš„ä¿¡æ¯æ˜¯ç›¸å½“é‡è¦ã€‚ package main import ( \"fmt\" \"net/http\" _ \"net/http/pprof\" ) func main() { ip := \"127.0.0.1:6069\" if err := http.ListenAndServe(ip, nil); err != nil { fmt.Printf(\"start pprof failed on %s\\n\", ip) } } ","date":"2022-05-10","objectID":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/:4:0","tags":["é¢è¯•"],"title":"å†…å­˜é€ƒé€¸","uri":"/%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/"},{"categories":["é¢è¯•"],"content":"redis ç®€ä»‹ï¼šRedis ï¼Œå…¨ç§° Remote Dictionary Server ï¼Œæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„é«˜æ€§èƒ½ Key-Value æ•°æ®åº“ã€‚ è„šæœ¬è‡ªåŠ¨å®‰è£…ä»»æ„ç‰ˆæœ¬ sh redis-install.sh 4.0.10 #! /usr/bin/bash ##redisä»»ä½•ç‰ˆæœ¬å…¨ç¨‹è‡ªåŠ¨åŒ–æºç ç¼–è¯‘å®‰è£… ##ç”¨æ³•ï¼šsh redis-install.sh 4.0.10 ï¼ˆåé¢è·Ÿçš„æ˜¯ä½ éœ€è¦çš„ç‰ˆæœ¬å·ï¼Œéœ€è¦ä»€ä¹ˆç‰ˆæœ¬å°±å†™ä»€ä¹ˆç‰ˆæœ¬ï¼‰ï¼Œæˆ‘è¿™é‡Œå®‰è£…çš„4.0.10 version=$1 usage(){ echo \"usage: $0version\" } if [ $# -ne 1 ] then usage exit -1 fi #Rediså®‰è£…åŒ…ä¸‹è½½ cd /usr/local/src if [ ! -f redis-${version}.tar.gz ] then curl -o /usr/local/src/redis-${version}.tar.gz http://download.redis.io/releases/redis-${version}.tar.gz fi #Redisä¾èµ–åŒ…å®‰è£… yum clean all yum makecache fast yum -y install gcc gcc-c++ tcl #ç¼–è¯‘Redisæ‰€éœ€è¦çš„gcc yum -y install centos-release-scl yum -y install devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils source /opt/rh/devtoolset-9/enable echo \"source /opt/rh/devtoolset-9/enable\" \u003e\u003e/etc/profile gcc --version ##å†…ç³»ç»Ÿå‚æ•°æ ¸ä¼˜åŒ– cat \u003e\u003e /etc/rc.d/rc.local \u003c\u003c \"EOF\" ##å…³é—­Linuxçš„THPï¼ˆå†…å­˜ç®¡ç†ç³»ç»Ÿï¼‰é€šè¿‡ä½¿ç”¨æ›´å¤§çš„å†…å­˜é¡µé¢ï¼Œæ¥å‡å°‘å…·æœ‰å¤§é‡å†…å­˜çš„è®¡ç®—æœºä¸Šçš„TLBçš„å¼€é”€ if [ -f /sys/kernel/mm/transparent_hugepage/enabled ] then echo never \u003e /sys/kernel/mm/transparent_hugepage/enabled fi if [ -f /sys/kernel/mm/transparent_hugepage/defrag ] then echo never \u003e /sys/kernel/mm/transparent_hugepage/defrag fi EOF chmod u+x /etc/rc.d/rc.local if [ -f /sys/kernel/mm/transparent_hugepage/enabled ] then echo never \u003e /sys/kernel/mm/transparent_hugepage/enabled fi if [ -f /sys/kernel/mm/transparent_hugepage/defrag ] then echo never \u003e /sys/kernel/mm/transparent_hugepage/defrag fi cat \u003e\u003e /etc/sysctl.conf \u003c\u003c \"EOF\" #Linuxç³»ç»Ÿå†…æ ¸å‚æ•°ä¼˜åŒ– net.core.somaxconn = 2048 net.ipv4.tcp_max_syn_backlog = 2048 vm.overcommit_memory = 1 EOF sysctl -p cat \u003e /etc/security/limits.conf \u003c\u003c \"EOF\" root soft nofile 65535 root hard nofile 65535 * soft nofile 65535 * hard nofile 65535 EOF #Redisç¼–è¯‘å®‰è£… cd /usr/local/src tar -zxvf redis-${version}.tar.gz cd /usr/local/src/redis-${version} make make PREFIX=/usr/local/redis install #RedisåŸºç¡€é…ç½® mkdir -p /usr/local/redis/{etc,logs,data} egrep -v \"^$|^#\" /usr/local/src/redis-${version}/redis.conf \u003e /usr/local/redis/etc/redis.conf #sed -i \"s/bind 127.0.0.1/bind 0.0.0.0/g\" /usr/local/redis/etc/redis.conf sed -i \"s/protected-mode yes/protected-mode no/g\" /usr/local/redis/etc/redis.conf sed -i \"s/daemonize no/daemonize yes/g\" /usr/local/redis/etc/redis.conf sed -i \"s/pidfile \\/var\\/run\\/redis_6379.pid/pidfile \\/usr\\/local\\/redis\\/redis.pid/g\" /usr/local/redis/etc/redis.conf sed -i \"s/dir \\.\\//dir \\/usr\\/local\\/redis\\/data/g\" /usr/local/redis/etc/redis.conf sed -i \"s/logfile \\\"\\\"/logfile \\\"\\/usr\\/local\\/redis\\/logs\\/redis.log\\\"/g\" /usr/local/redis/etc/redis.conf sed -i \"s/dbfilename dump.rdb/dbfilename dump.rdb/g\" /usr/local/redis/etc/redis.conf sed -i \"s/appendfilename \\\"appendonly.aof\\\"/appendfilename \\\"appendonly.aof\\\"/g\" /usr/local/redis/etc/redis.conf #PATHé…ç½® echo \"export PATH=${PATH}:/usr/local/redis/bin\" \u003e\u003e/etc/profile source /etc/profile #å¯åŠ¨redisæœåŠ¡ /usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf #æŸ¥çœ‹redisç›‘å¬ç«¯å£ netstat -tanp|grep redis ","date":"2022-05-09","objectID":"/redis/:0:0","tags":["é¢è¯•"],"title":"Redis","uri":"/redis/"},{"categories":["é¢è¯•"],"content":"Redis æœ‰å“ªäº›æ•°æ®ç»“æ„ï¼Ÿ å¦‚æœä½ æ˜¯ Redis æ™®é€šç©å®¶ï¼Œå¯èƒ½ä½ çš„å›ç­”æ˜¯å¦‚ä¸‹äº”ç§æ•°æ®ç»“æ„ï¼š å­—ç¬¦ä¸² String å­—å…¸ Hash åˆ—è¡¨ List é›†åˆ Set æœ‰åºé›†åˆ SortedSet å¦‚æœä½ æ˜¯ Redis ä¸­çº§ç©å®¶ï¼Œè¿˜éœ€è¦åŠ ä¸Šä¸‹é¢å‡ ç§æ•°æ®ç»“æ„ï¼š HyperLogLog Geo Bitmap å¦‚æœä½ æ˜¯ Redis é«˜ç«¯ç©å®¶ï¼Œä½ å¯èƒ½ç©è¿‡ Redis Module ï¼Œå¯ä»¥å†åŠ ä¸Šä¸‹é¢å‡ ç§æ•°æ®ç»“æ„ï¼š BloomFilter RedisSearch Redis-ML JSON å¦å¤–ï¼Œåœ¨ Redis 5.0 å¢åŠ äº† Stream åŠŸèƒ½ï¼Œä¸€ä¸ªæ–°çš„å¼ºå¤§çš„æ”¯æŒå¤šæ’­çš„å¯æŒä¹…åŒ–çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæä¾›ç±»ä¼¼ Kafka çš„åŠŸèƒ½ã€‚ ","date":"2022-05-09","objectID":"/redis/:1:0","tags":["é¢è¯•"],"title":"Redis","uri":"/redis/"},{"categories":["é¢è¯•"],"content":"Redis çš„çº¿ç¨‹æ¨¡å‹ redis å†…éƒ¨ä½¿ç”¨æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ file event handlerï¼Œè¿™ä¸ªæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥ Redis æ‰å«åšå•çº¿ç¨‹çš„æ¨¡å‹ã€‚å®ƒé‡‡ç”¨ IO å¤šè·¯å¤ç”¨æœºåˆ¶åŒæ—¶ç›‘å¬å¤šä¸ª Socketï¼Œæ ¹æ® Socket ä¸Šçš„äº‹ä»¶æ¥é€‰æ‹©å¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚ æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨çš„ç»“æ„åŒ…å« 4 ä¸ªéƒ¨åˆ†ï¼š å¤šä¸ª Socket ã€‚ IO å¤šè·¯å¤ç”¨ç¨‹åºã€‚ æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ã€‚ äº‹ä»¶å¤„ç†å™¨ï¼ˆè¿æ¥åº”ç­”å¤„ç†å™¨ã€å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ã€å‘½ä»¤å›å¤å¤„ç†å™¨ï¼‰ã€‚ å¤šä¸ª Socket å¯èƒ½ä¼šå¹¶å‘äº§ç”Ÿä¸åŒçš„æ“ä½œï¼Œæ¯ä¸ªæ“ä½œå¯¹åº”ä¸åŒçš„æ–‡ä»¶äº‹ä»¶ï¼Œä½†æ˜¯ IO å¤šè·¯å¤ç”¨ç¨‹åºä¼šç›‘å¬å¤šä¸ª socketï¼Œä¼šå°† socket äº§ç”Ÿçš„äº‹ä»¶æ”¾å…¥é˜Ÿåˆ—ä¸­æ’é˜Ÿï¼Œäº‹ä»¶åˆ†æ´¾å™¨æ¯æ¬¡ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶ï¼ŒæŠŠè¯¥äº‹ä»¶äº¤ç»™å¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚ æ¥çœ‹å®¢æˆ·ç«¯ä¸ redis çš„ä¸€æ¬¡é€šä¿¡è¿‡ç¨‹ï¼š ","date":"2022-05-09","objectID":"/redis/:2:0","tags":["é¢è¯•"],"title":"Redis","uri":"/redis/"},{"categories":["é¢è¯•"],"content":"redis-single-thread-model å®¢æˆ·ç«¯ Socket01 å‘ Redis çš„ Server Socket è¯·æ±‚å»ºç«‹è¿æ¥ï¼Œæ­¤æ—¶ Server Socket ä¼šäº§ç”Ÿä¸€ä¸ª AE_READABLE äº‹ä»¶ï¼ŒIO å¤šè·¯å¤ç”¨ç¨‹åºç›‘å¬åˆ° server socket äº§ç”Ÿçš„äº‹ä»¶åï¼Œå°†è¯¥äº‹ä»¶å‹å…¥é˜Ÿåˆ—ä¸­ã€‚æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä»é˜Ÿåˆ—ä¸­è·å–è¯¥äº‹ä»¶ï¼Œäº¤ç»™è¿æ¥åº”ç­”å¤„ç†å™¨ã€‚è¿æ¥åº”ç­”å¤„ç†å™¨ä¼šåˆ›å»ºä¸€ä¸ªèƒ½ä¸å®¢æˆ·ç«¯é€šä¿¡çš„ Socket01ï¼Œå¹¶å°†è¯¥ Socket01 çš„ AE_READABLE äº‹ä»¶ä¸å‘½ä»¤è¯·æ±‚å¤„ç†å™¨å…³è”ã€‚ å‡è®¾æ­¤æ—¶å®¢æˆ·ç«¯å‘é€äº†ä¸€ä¸ª set key value è¯·æ±‚ï¼Œæ­¤æ—¶ Redis ä¸­çš„ Socket01 ä¼šäº§ç”Ÿ AE_READABLE äº‹ä»¶ï¼ŒIO å¤šè·¯å¤ç”¨ç¨‹åºå°†äº‹ä»¶å‹å…¥é˜Ÿåˆ—ï¼Œæ­¤æ—¶äº‹ä»¶åˆ†æ´¾å™¨ä»é˜Ÿåˆ—ä¸­è·å–åˆ°è¯¥äº‹ä»¶ï¼Œç”±äºå‰é¢ Socket01 çš„ AE_READABLE äº‹ä»¶å·²ç»ä¸å‘½ä»¤è¯·æ±‚å¤„ç†å™¨å…³è”ï¼Œå› æ­¤äº‹ä»¶åˆ†æ´¾å™¨å°†äº‹ä»¶äº¤ç»™å‘½ä»¤è¯·æ±‚å¤„ç†å™¨æ¥å¤„ç†ã€‚å‘½ä»¤è¯·æ±‚å¤„ç†å™¨è¯»å– Scket01 çš„ set key value å¹¶åœ¨è‡ªå·±å†…å­˜ä¸­å®Œæˆ set key value çš„è®¾ç½®ã€‚æ“ä½œå®Œæˆåï¼Œå®ƒä¼šå°† Scket01 çš„ AE_WRITABLE äº‹ä»¶ä¸ä»¤å›å¤å¤„ç†å™¨å…³è”ã€‚ å¦‚æœæ­¤æ—¶å®¢æˆ·ç«¯å‡†å¤‡å¥½æ¥æ”¶è¿”å›ç»“æœäº†ï¼Œé‚£ä¹ˆ Redis ä¸­çš„ Socket01 ä¼šäº§ç”Ÿä¸€ä¸ª AE_WRITABLE äº‹ä»¶ï¼ŒåŒæ ·å‹å…¥é˜Ÿåˆ—ä¸­ï¼Œäº‹ä»¶åˆ†æ´¾å™¨æ‰¾åˆ°ç›¸å…³è”çš„å‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œç”±å‘½ä»¤å›å¤å¤„ç†å™¨å¯¹ socket01 è¾“å…¥æœ¬æ¬¡æ“ä½œçš„ä¸€ä¸ªç»“æœï¼Œæ¯”å¦‚ okï¼Œä¹‹åè§£é™¤ Socket01 çš„ AE_WRITABLE äº‹ä»¶ä¸å‘½ä»¤å›å¤å¤„ç†å™¨çš„å…³è”ã€‚ è¿™æ ·ä¾¿å®Œæˆäº†ä¸€æ¬¡é€šä¿¡ã€‚ ","date":"2022-05-09","objectID":"/redis/:2:1","tags":["é¢è¯•"],"title":"Redis","uri":"/redis/"},{"categories":["é¢è¯•"],"content":"Redis å•çº¿ç¨‹æ¨¡å‹ä¹Ÿèƒ½æ•ˆç‡è¿™ä¹ˆé«˜ï¼Ÿ C è¯­è¨€å®ç°ã€‚ æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒC è¯­è¨€çš„æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ã€‚ çº¯å†…å­˜æ“ä½œã€‚ Redis ä¸ºäº†è¾¾åˆ°æœ€å¿«çš„è¯»å†™é€Ÿåº¦ï¼Œå°†æ•°æ®éƒ½è¯»åˆ°å†…å­˜ä¸­ï¼Œå¹¶é€šè¿‡å¼‚æ­¥çš„æ–¹å¼å°†æ•°æ®å†™å…¥ç£ç›˜ã€‚æ‰€ä»¥ Redis å…·æœ‰å¿«é€Ÿå’Œæ•°æ®æŒä¹…åŒ–çš„ç‰¹å¾ã€‚ å¦‚æœä¸å°†æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ï¼Œç£ç›˜ I/O é€Ÿåº¦ä¸ºä¸¥é‡å½±å“ Redis çš„æ€§èƒ½ã€‚ åŸºäºéé˜»å¡çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ã€‚ å•çº¿ç¨‹ï¼Œé¿å…äº†å¤šçº¿ç¨‹çš„é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜ã€‚ Redis åˆ©ç”¨é˜Ÿåˆ—æŠ€æœ¯ï¼Œå°†å¹¶å‘è®¿é—®å˜ä¸ºä¸²è¡Œè®¿é—®ï¼Œæ¶ˆé™¤äº†ä¼ ç»Ÿæ•°æ®åº“ä¸²è¡Œæ§åˆ¶çš„å¼€é”€ã€‚ å®é™…ä¸Šï¼ŒRedis 4.0 å¼€å§‹ï¼Œä¹Ÿå¼€å§‹æœ‰äº†ä¸€äº›å¼‚æ­¥çº¿ç¨‹ï¼Œç”¨äºå¤„ç†ä¸€äº›è€—æ—¶æ“ä½œã€‚ä¾‹å¦‚è¯´ï¼Œå¼‚æ­¥çº¿ç¨‹ï¼Œå®ç°æƒ°æ€§åˆ é™¤ï¼ˆè§£å†³å¤§ KEY åˆ é™¤ï¼Œé˜»å¡ä¸»çº¿ç¨‹ï¼‰å’Œå¼‚æ­¥ AOF ï¼ˆè§£å†³ç£ç›˜ IO ç´§å¼ æ—¶ï¼Œfsync æ‰§è¡Œä¸€æ¬¡å¾ˆæ…¢ï¼‰ç­‰ç­‰ã€‚ ä¸°å¯Œçš„æ•°æ®ç»“æ„ã€‚ Redis å…¨ç¨‹ä½¿ç”¨ hash ç»“æ„ï¼Œè¯»å–é€Ÿåº¦å¿«ï¼Œè¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œå¯¹æ•°æ®å­˜å‚¨è¿›è¡Œäº†ä¼˜åŒ–ã€‚ä¾‹å¦‚ï¼Œå‹ç¼©è¡¨ï¼Œå¯¹çŸ­æ•°æ®è¿›è¡Œå‹ç¼©å­˜å‚¨ï¼›å†å†å¦‚ï¼Œè·³è¡¨ï¼Œä½¿ç”¨æœ‰åºçš„æ•°æ®ç»“æ„åŠ å¿«è¯»å–çš„é€Ÿåº¦ã€‚ ä¹Ÿå› ä¸º Redis æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥å¯ä»¥å®ç°ä¸°å¯Œçš„æ•°æ®ç»“æ„ï¼Œæ— éœ€è€ƒè™‘å¹¶å‘çš„é—®é¢˜ã€‚ ","date":"2022-05-09","objectID":"/redis/:3:0","tags":["é¢è¯•"],"title":"Redis","uri":"/redis/"},{"categories":["é¢è¯•"],"content":"Redis æ˜¯å•çº¿ç¨‹çš„ï¼Œå¦‚ä½•æé«˜å¤šæ ¸ CPU çš„åˆ©ç”¨ç‡ï¼Ÿ å¯ä»¥åœ¨åŒä¸€ä¸ªæœåŠ¡å™¨éƒ¨ç½²å¤šä¸ª Redis çš„å®ä¾‹ï¼Œå¹¶æŠŠä»–ä»¬å½“ä½œä¸åŒçš„æœåŠ¡å™¨æ¥ä½¿ç”¨ï¼Œåœ¨æŸäº›æ—¶å€™ï¼Œæ— è®ºå¦‚ä½•ä¸€ä¸ªæœåŠ¡å™¨æ˜¯ä¸å¤Ÿçš„ï¼Œ æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨å¤šä¸ª CPU ï¼Œä½ å¯ä»¥è€ƒè™‘ä¸€ä¸‹åˆ†åŒºã€‚ ","date":"2022-05-09","objectID":"/redis/:4:0","tags":["é¢è¯•"],"title":"Redis","uri":"/redis/"},{"categories":["é¢è¯•"],"content":"Redis æœ‰å‡ ç§æŒä¹…åŒ–æ–¹å¼ï¼Ÿ Redis æä¾›äº†ä¸¤ç§æ–¹å¼ï¼Œå®ç°æ•°æ®çš„æŒä¹…åŒ–åˆ°ç¡¬ç›˜ã€‚ 1ã€ã€å…¨é‡ã€‘RDB æŒä¹…åŒ–ï¼Œæ˜¯æŒ‡åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…å°†å†…å­˜ä¸­çš„æ•°æ®é›†å¿«ç…§å†™å…¥ç£ç›˜ã€‚å®é™…æ“ä½œè¿‡ç¨‹æ˜¯ï¼Œfork ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå…ˆå°†æ•°æ®é›†å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œå†™å…¥æˆåŠŸåï¼Œå†æ›¿æ¢ä¹‹å‰çš„æ–‡ä»¶ï¼Œç”¨äºŒè¿›åˆ¶å‹ç¼©å­˜å‚¨ã€‚ 2ã€ã€å¢é‡ã€‘AOFæŒä¹…åŒ–ï¼Œä»¥æ—¥å¿—çš„å½¢å¼è®°å½•æœåŠ¡å™¨æ‰€å¤„ç†çš„æ¯ä¸€ä¸ªå†™ã€åˆ é™¤æ“ä½œï¼ŒæŸ¥è¯¢æ“ä½œä¸ä¼šè®°å½•ï¼Œä»¥æ–‡æœ¬çš„æ–¹å¼è®°å½•ï¼Œå¯ä»¥æ‰“å¼€æ–‡ä»¶çœ‹åˆ°è¯¦ç»†çš„æ“ä½œè®°å½•ã€‚ ","date":"2022-05-09","objectID":"/redis/:5:0","tags":["é¢è¯•"],"title":"Redis","uri":"/redis/"},{"categories":["é¢è¯•"],"content":"æœ‰å“ªå‡ ç§æ•°æ®â€œæ·˜æ±°â€ç­–ç•¥ï¼Ÿ Redis å†…å­˜æ•°æ®é›†å¤§å°ä¸Šå‡åˆ°ä¸€å®šå¤§å°çš„æ—¶å€™ï¼Œå°±ä¼šè¿›è¡Œæ•°æ®æ·˜æ±°ç­–ç•¥ã€‚ Redis æä¾›äº† 6 ç§æ•°æ®æ·˜æ±°ç­–ç•¥ï¼š volatile-lru volatile-ttl volatile-random allkeys-lru allkeys-random ã€é»˜è®¤ç­–ç•¥ã€‘no-enviction å…·ä½“çš„æ¯ç§æ•°æ®æ·˜æ±°ç­–ç•¥çš„å®šä¹‰ï¼Œå’Œå¦‚ä½•é€‰æ‹©è®¨è®ºç­–ç•¥ï¼Œå¯è§ ã€ŠRediså®æˆ˜ï¼ˆäºŒï¼‰ å†…å­˜æ·˜æ±°æœºåˆ¶ã€‹ ã€‚ åœ¨ Redis 4.0 åï¼ŒåŸºäº LFUï¼ˆLeast Frequently Usedï¼‰æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ï¼Œå¢åŠ äº† 2 ç§æ·˜æ±°ç­–ç•¥ï¼š volatile-lfu allkeys-lfu ğŸ¦… Redis LRU ç®—æ³• å¦å¤–ï¼ŒRedis çš„ LRU ç®—æ³•ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„ LRU å®ç°ã€‚è¿™æ„å‘³ç€ Redis ä¸èƒ½é€‰æ‹©æœ€ä½³å€™é€‰é”®æ¥å›æ”¶ï¼Œä¹Ÿå°±æ˜¯æœ€ä¹…æœªè¢«è®¿é—®çš„é‚£äº›é”®ã€‚ç›¸åï¼ŒRedis ä¼šå°è¯•æ‰§è¡Œä¸€ä¸ªè¿‘ä¼¼çš„ LRU ç®—æ³•ï¼Œé€šè¿‡é‡‡æ ·ä¸€å°éƒ¨åˆ†é”®ï¼Œç„¶ååœ¨é‡‡æ ·é”®ä¸­å›æ”¶æœ€é€‚åˆ(æ‹¥æœ‰æœ€ä¹…æœªè¢«è®¿é—®æ—¶é—´)çš„é‚£ä¸ªã€‚ Redis æ²¡æœ‰ä½¿ç”¨çœŸæ­£å®ç°ä¸¥æ ¼çš„ LRU ç®—æ˜¯çš„åŸå› æ˜¯ï¼Œå› ä¸ºæ¶ˆè€—æ›´å¤šçš„å†…å­˜ã€‚ç„¶è€Œå¯¹äºä½¿ç”¨ Redis çš„åº”ç”¨æ¥è¯´ï¼Œä½¿ç”¨è¿‘ä¼¼çš„ LRU ç®—æ³•ï¼Œäº‹å®ä¸Šæ˜¯ç­‰ä»·çš„ã€‚ ","date":"2022-05-09","objectID":"/redis/:6:0","tags":["é¢è¯•"],"title":"Redis","uri":"/redis/"},{"categories":["é¢è¯•"],"content":"ç†è§£å›æ”¶è¿›ç¨‹å¦‚ä½•å·¥ä½œæ˜¯éå¸¸é‡è¦çš„ï¼š ä¸€ä¸ªå®¢æˆ·ç«¯è¿è¡Œäº†æ–°çš„å†™å‘½ä»¤ï¼Œæ·»åŠ äº†æ–°çš„æ•°æ®ã€‚ Redis æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå¦‚æœå¤§äº maxmemory çš„é™åˆ¶, åˆ™æ ¹æ®è®¾å®šå¥½çš„ç­–ç•¥è¿›è¡Œå›æ”¶ã€‚ Redis æ‰§è¡Œæ–°å‘½ä»¤ã€‚ æ‰€ä»¥æˆ‘ä»¬ä¸æ–­åœ°ç©¿è¶Šå†…å­˜é™åˆ¶çš„è¾¹ç•Œï¼Œé€šè¿‡ä¸æ–­è¾¾åˆ°è¾¹ç•Œç„¶åä¸æ–­åœ°å›æ”¶å›åˆ°è¾¹ç•Œä»¥ä¸‹ï¼ˆè·Œå®•èµ·ä¼ï¼‰ã€‚ ","date":"2022-05-09","objectID":"/redis/:7:0","tags":["é¢è¯•"],"title":"Redis","uri":"/redis/"},{"categories":["é¢è¯•"],"content":"å¦‚æœå¤§é‡çš„ key è¿‡æœŸæ—¶é—´è®¾ç½®çš„è¿‡äºé›†ä¸­ï¼Œåˆ°è¿‡æœŸçš„é‚£ä¸ªæ—¶é—´ç‚¹ï¼ŒRediså¯èƒ½ä¼šå‡ºç°çŸ­æš‚çš„å¡é¡¿ç°è±¡ã€‚ ä¸€èˆ¬éœ€è¦åœ¨æ—¶é—´ä¸ŠåŠ ä¸€ä¸ªéšæœºå€¼ï¼Œä½¿å¾—è¿‡æœŸæ—¶é—´åˆ†æ•£ä¸€äº›ã€‚ æ˜¯è°ƒå¤§ hz å‚æ•°ï¼Œæ¯æ¬¡è¿‡æœŸçš„ key æ›´å¤šï¼Œä»è€Œæœ€ç»ˆè¾¾åˆ°é¿å…ä¸€æ¬¡è¿‡æœŸè¿‡å¤šã€‚ è¿™ä¸ªå®šæœŸçš„é¢‘ç‡ï¼Œç”±é…ç½®æ–‡ä»¶ä¸­çš„ hz å‚æ•°å†³å®šï¼Œä»£è¡¨äº†ä¸€ç§’é’Ÿå†…ï¼Œåå°ä»»åŠ¡æœŸæœ›è¢«è°ƒç”¨çš„æ¬¡æ•°ã€‚Redis 3.0.0 ä¸­çš„é»˜è®¤å€¼æ˜¯ 10 ï¼Œä»£è¡¨æ¯ç§’é’Ÿè°ƒç”¨ 10 æ¬¡åå°ä»»åŠ¡ã€‚ hz è°ƒå¤§å°†ä¼šæé«˜ Redis ä¸»åŠ¨æ·˜æ±°çš„é¢‘ç‡ï¼Œå¦‚æœä½ çš„ Redis å­˜å‚¨ä¸­åŒ…å«å¾ˆå¤šå†·æ•°æ®å ç”¨å†…å­˜è¿‡å¤§çš„è¯ï¼Œå¯ä»¥è€ƒè™‘å°†è¿™ä¸ªå€¼è°ƒå¤§ï¼Œä½† Redis ä½œè€…å»ºè®®è¿™ä¸ªå€¼ä¸è¦è¶…è¿‡ 100 ã€‚æˆ‘ä»¬å®é™…çº¿ä¸Šå°†è¿™ä¸ªå€¼è°ƒå¤§åˆ° 100 ï¼Œè§‚å¯Ÿåˆ° CPU ä¼šå¢åŠ  2% å·¦å³ï¼Œä½†å¯¹å†·æ•°æ®çš„å†…å­˜é‡Šæ”¾é€Ÿåº¦ç¡®å®æœ‰æ˜æ˜¾çš„æé«˜ï¼ˆé€šè¿‡è§‚å¯Ÿ keyspace ä¸ªæ•°å’Œ used_memory å¤§å°ï¼‰ã€‚ ","date":"2022-05-09","objectID":"/redis/:8:0","tags":["é¢è¯•"],"title":"Redis","uri":"/redis/"},{"categories":["é¢è¯•"],"content":"Go V1.8çš„ä¸‰è‰²æ ‡è®°æ³•+æ··åˆå†™å±éšœæœºåˆ¶ å…·ä½“æ“ä½œï¼š GCå¼€å§‹å°†æ ˆä¸Šçš„å¯¹è±¡å…¨éƒ¨æ‰«ææ ‡è®°ä¸ºé»‘è‰²ï¼ˆä¹‹åä¸å†è¿›è¡ŒäºŒæ¬¡é‡å¤æ‰«æï¼Œæ— éœ€stwï¼‰ GCæœŸé—´ï¼Œä»»ä½•åœ¨æ ˆä¸Šåˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œå‡ä¸ºé»‘è‰² è¢«åˆ é™¤çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼ˆæ ˆ+å †ï¼‰ è¢«æ·»åŠ çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰² æ»¡è¶³ï¼šå˜å½¢çš„å¼±ä¸‰è‰²ä¸å˜å¼ï¼ˆç»“åˆäº†æ’å…¥ã€åˆ é™¤å†™å±éšœä¸¤è€…çš„ä¼˜ç‚¹ï¼‰ //ä¼ªä»£ç  æ·»åŠ ä¸‹æ¸¸å¯¹è±¡ï¼ˆå½“å‰ä¸‹æ¸¸å¯¹è±¡slotï¼Œæ–°ä¸‹æ¸¸å¯¹ è±¡ptrï¼‰{ //1 æ ‡è®°ç°è‰²ï¼ˆå½“å‰ä¸‹æ¸¸å¯¹è±¡slotï¼‰//åªè¦å½“å‰ä¸‹æ¸¸å¯¹è±¡è¢«ç§»èµ°ï¼Œå°±æ ‡è®°ä¸ºç°è‰² //2 æ ‡è®°ç°è‰²ï¼ˆæ–°ä¸‹æ¸¸å¯¹è±¡ptrï¼‰ //3 å½“å‰ä¸‹æ¸¸å¯¹è±¡slot = æ–°ä¸‹æ¸¸å¯¹è±¡ptr } åŸºç¡€ä¸‰è‰²æ ‡è®°æ³• é»‘-ç™½-ç° gcå¼€å§‹ï¼šæ‰«ææ‰€æœ‰å¯åˆ°è¾¾çš„å¯¹è±¡ï¼Œæ ‡è®°ä¸ºç°è‰² ä»ç°è‰²å¯¹è±¡ä¸­æ‰¾åˆ°å…¶å¼•ç”¨å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼ŒæŠŠç°è‰²å¯¹è±¡æœ¬èº«æ ‡è®°ä¸ºé»‘è‰² ç›‘è§†å¯¹è±¡ä¸­çš„å†…å­˜ä¿®æ”¹ï¼Œå¹¶æŒç»­ä¸Šä¸€æ­¥çš„æ“ä½œï¼Œç›´åˆ°ç°è‰²æ ‡è®°çš„å¯¹è±¡ä¸å­˜åœ¨ æ­¤æ—¶ï¼Œgcå›æ”¶ç™½è‰²å¯¹è±¡ã€‚ æœ€åï¼Œå°†æ‰€æœ‰é»‘è‰²å¯¹è±¡å˜ä¸ºç™½è‰²ï¼Œå¹¶é‡å¤ä»¥ä¸Šæ‰€æœ‰è¿‡ç¨‹ã€‚ ","date":"2022-05-06","objectID":"/%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E6%B3%95/:1:0","tags":["é¢è¯•"],"title":"ä¸‰è‰²æ ‡è®°æ³•","uri":"/%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E6%B3%95/"},{"categories":["é¢è¯•"],"content":"Mysqlé¢è¯• ","date":"2022-04-26","objectID":"/mysql/:0:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯MySQL MySQLæ˜¯ä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œç”±ç‘å…¸MySQL AB å…¬å¸å¼€å‘ï¼Œå±äº Oracle æ——ä¸‹äº§å“ã€‚MySQL æ˜¯æœ€æµè¡Œçš„å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¹‹ä¸€ï¼Œåœ¨ WEB åº”ç”¨æ–¹é¢ï¼ŒMySQLæ˜¯æœ€å¥½çš„ RDBMS (Relational Database Management Systemï¼Œå…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ) åº”ç”¨è½¯ä»¶ä¹‹ä¸€ã€‚åœ¨Javaä¼ä¸šçº§å¼€å‘ä¸­éå¸¸å¸¸ç”¨ï¼Œå› ä¸º MySQL æ˜¯å¼€æºå…è´¹çš„ï¼Œå¹¶ä¸”æ–¹ä¾¿æ‰©å±•ã€‚ ","date":"2022-04-26","objectID":"/mysql/:1:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"æ•°æ®åº“ä¸‰å¤§èŒƒå¼æ˜¯ä»€ä¹ˆ ç¬¬ä¸€èŒƒå¼:æ¯ä¸ªåˆ—éƒ½ä¸å¯æ‹†åˆ† ç¬¬äºŒèŒƒå¼:åœ¨ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Š,éä¸»é”®åˆ—å®Œå…¨ä¾èµ–äºä¸»é”®,è€Œä¸èƒ½æ˜¯ä¾èµ–äºä¸»é”®çš„ä¸€éƒ¨åˆ†ã€‚ ç¬¬ä¸‰èŒƒå¼:åœ¨ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Š,éä¸»é”®åˆ—åªä¾èµ–äºä¸»é”®,ä¸ä¾èµ–äºå…¶ä»–éä¸»é”®ã€‚ ","date":"2022-04-26","objectID":"/mysql/:2:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"mysqlæœ‰å…³æƒé™çš„è¡¨éƒ½æœ‰å‡ ä¸ª è¿™äº›è¡¨åˆ†åˆ«ä¸ºuser, db, table_priv, columns_privå’Œhostã€‚ä¸‹é¢åˆ†åˆ«ä»‹ç»ä¸€ä¸‹è¿™äº›è¡¨çš„ç»“æ„å’Œå†…å®¹: useræƒé™è¡¨:è®°å½•å…è®¸è¿æ¥åˆ°æœåŠ¡å™¨çš„ç”¨æˆ·è´¦æˆ·ä¿¡æ¯,é‡Œé¢çš„æƒé™æ˜¯å…¨å±€çº§çš„ dbæƒé™è¡¨:è®°å½•å„ä¸ªè´¦å·åœ¨å„ä¸ªæ•°æ®åº“ä¸Šçš„æ“ä½œæƒé™ table_privæƒé™è¡¨:è®°å½•æ•°æ®è¡¨çº§çš„æ“ä½œæƒé™ columns_privæƒé™è¡¨:è®°å½•æ•°æ®åˆ—çº§çš„æ“ä½œæƒé™ hostæƒé™è¡¨:é…åˆdbæƒé™è¡¨å¯¹ç»™å®šä¸»æœºä¸Šæ•°æ®åº“çº§æ“ä½œæƒé™ä½œæ›´ç»†è‡´çš„æ§åˆ¶ã€‚è¿™ä¸ªæƒé™è¡¨ä¸å—GRANTå’ŒREVOKEè¯­å¥çš„å½±å“ã€‚ ","date":"2022-04-26","objectID":"/mysql/:3:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"mysqlçš„binlogæœ‰å‡ ç§å½•å…¥æ ¼å¼?åˆ†åˆ«æœ‰ä»€ä¹ˆåŒºåˆ« æœ‰ä¸‰ç§æ ¼å¼ statement, rowå’Œmixedã€‚ statementæ¨¡å¼ä¸‹,æ¯ä¸€æ¡ä¼šä¿®æ”¹æ•°æ®çš„sqléƒ½ä¼šè®°å½•åœ¨binlogä¸­ã€‚ä¸éœ€è¦è®°å½•æ¯ä¸€è¡Œçš„å˜åŒ–,å‡å°‘binlogæ—¥å¿—é‡,èŠ‚çº¦äº†IO,æé«˜æ€§èƒ½ã€‚ç”±äºsqlçš„æ‰§è¡Œæ˜¯æœ‰ä¸Šä¸‹æ–‡çš„,å› æ­¤åœ¨ä¿å­˜çš„æ—¶å€™éœ€è¦ä¿å­˜ç›¸å…³çš„ä¿¡æ¯,åŒæ—¶è¿˜æœ‰ä¸€äº›ä½¿ç”¨äº†å‡½æ•°ä¹‹ç±»çš„è¯­å¥æ— æ³•è¢«è®°å½•å¤åˆ¶ã€‚ rowæ¨¡å¼ä¸‹,ä¸è®°å½•sqlè¯­å¥ä¸Šä¸‹æ–‡ç›¸å…³ä¿¡æ¯,ä»…ä¿å­˜å“ªæ¡è®°å½•è¢«ä¿®æ”¹ã€‚è®°å½•å•å…ƒä¸ºæ¯ä¸€è¡Œçš„æ”¹åŠ¨,åŸºæœ¬æ˜¯å¯ä»¥å…¨éƒ¨è®°å½•ä¸‹æ¥ä½†æ˜¯ç”±äºå¾ˆå¤šæ“ä½œ,ä¼šå¯¼è‡´å¤§é‡çš„æ”¹åŠ¨ mixedæ¨¡å¼ä¸‹,ä¸€ç§æŠ˜ä¸­çš„æ–¹æ¡ˆ,æ™®é€šæ“ä½œä½¿ç”¨statementè®°å½•,å½“æ— æ³•ä½¿ç”¨statementçš„æ—¶å€™ä½¿ç”¨row ","date":"2022-04-26","objectID":"/mysql/:4:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"mysqlå­˜å‚¨å¼•æ“MyISAMä¸InnoDBåŒºåˆ« å¸¸ç”¨çš„å­˜å‚¨å¼•æ“æœ‰ä»¥ä¸‹: Innodbå¼•æ“:Innodbå¼•æ“æä¾›äº†å¯¹æ•°æ®åº“ACIDäº‹åŠ¡çš„æ”¯æŒã€‚å¹¶ä¸”è¿˜æä¾›äº†è¡Œçº§é”å’Œå¤–é”®çš„çº¦æŸã€‚ MyISAMå¼•æ“:ä¸æä¾›äº‹åŠ¡çš„æ”¯æŒ,ä¹Ÿä¸æ”¯æŒè¡Œçº§é”å’Œå¤–é”® MEMORYå¼•æ“:æ‰€æœ‰çš„æ•°æ®éƒ½å­˜åœ¨å†…å­˜ä¸­,æ•°æ®çš„å¤„ç†é€Ÿåº¦å¿«,ä½†æ˜¯å®‰å…¨æ€§ä¸é«˜ã€‚ MyISAMä¸InnoDBåŒºåˆ« MyISAM Innodb å­˜å‚¨ç»“æ„ æ¯å¼ è¡¨è¢«å­˜æ”¾åœ¨ä¸‰ä¸ªæ–‡ä»¶ï¼šfrm-è¡¨æ ¼å®šä¹‰ã€MYD(MYData)-æ•°æ®æ–‡ä»¶ã€MYI(MYIndex)-ç´¢å¼•æ–‡ä»¶ æ‰€æœ‰çš„è¡¨éƒ½ä¿å­˜åœ¨åŒä¸€ä¸ªæ•°æ®æ–‡ä»¶ä¸­ï¼ˆä¹Ÿå¯èƒ½æ˜¯å¤šä¸ªæ–‡ä»¶ï¼Œæˆ–è€…æ˜¯ç‹¬ç«‹çš„è¡¨ç©ºé—´æ–‡ä»¶ï¼‰ï¼ŒInnoDBè¡¨çš„å¤§å°åªå—é™äºæ“ä½œç³»ç»Ÿæ–‡ä»¶çš„å¤§å°ï¼Œä¸€èˆ¬ä¸º2GB å­˜å‚¨ç©ºé—´ MyISAMå¯è¢«å‹ç¼©ï¼Œå­˜å‚¨ç©ºé—´è¾ƒå° InnoDBçš„è¡¨éœ€è¦æ›´å¤šçš„å†…å­˜å’Œå­˜å‚¨ï¼Œå®ƒä¼šåœ¨ä¸»å†…å­˜ä¸­å»ºç«‹å…¶ä¸“ç”¨çš„ç¼“å†²æ± ç”¨äºé«˜é€Ÿç¼“å†²æ•°æ®å’Œç´¢å¼• å¯ç§»æ¤æ€§ã€å¤‡ä»½åŠæ¢å¤ ç”±äºMyISAMçš„æ•°æ®æ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨è·¨å¹³å°çš„æ•°æ®è½¬ç§»ä¸­ä¼šå¾ˆæ–¹ä¾¿ã€‚åœ¨å¤‡ä»½å’Œæ¢å¤æ—¶å¯å•ç‹¬é’ˆå¯¹æŸä¸ªè¡¨è¿›è¡Œæ“ä½œ å…è´¹çš„æ–¹æ¡ˆå¯ä»¥æ˜¯æ‹·è´æ•°æ®æ–‡ä»¶ã€å¤‡ä»½ binlogï¼Œæˆ–è€…ç”¨ mysqldumpï¼Œåœ¨æ•°æ®é‡è¾¾åˆ°å‡ åGçš„æ—¶å€™å°±ç›¸å¯¹ç—›è‹¦äº† æ–‡ä»¶æ ¼å¼ æ•°æ®å’Œç´¢å¼•æ˜¯åˆ†åˆ«å­˜å‚¨çš„ï¼Œæ•°æ®.MYDï¼Œç´¢å¼•.MYI æ•°æ®å’Œç´¢å¼•æ˜¯é›†ä¸­å­˜å‚¨çš„ï¼Œ.ibd è®°å½•å­˜å‚¨é¡ºåº æŒ‰è®°å½•æ’å…¥é¡ºåºä¿å­˜ æŒ‰ä¸»é”®å¤§å°æœ‰åºæ’å…¥ å¤–é”® ä¸æ”¯æŒ æ”¯æŒ äº‹åŠ¡ ä¸æ”¯æŒ æ”¯æŒ é”æ”¯æŒï¼ˆé”æ˜¯é¿å…èµ„æºäº‰ç”¨çš„ä¸€ä¸ªæœºåˆ¶ï¼ŒMySQLé”å¯¹ç”¨æˆ·å‡ ä¹æ˜¯é€æ˜çš„ï¼‰ è¡¨çº§é”å®š è¡Œçº§é”å®šã€è¡¨çº§é”å®šï¼Œé”å®šåŠ›åº¦å°å¹¶å‘èƒ½åŠ›é«˜ SELECT MyISAMæ›´ä¼˜ INSERTã€UPDATEã€DELETE InnoDBæ›´ä¼˜ select count(*) myisamæ›´å¿«ï¼Œå› ä¸ºmyisamå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¯ä»¥ç›´æ¥è°ƒå–ã€‚ ç´¢å¼•çš„å®ç°æ–¹å¼ B+æ ‘ç´¢å¼•ï¼Œmyisam æ˜¯å †è¡¨ B+æ ‘ç´¢å¼•ï¼ŒInnodb æ˜¯ç´¢å¼•ç»„ç»‡è¡¨ å“ˆå¸Œç´¢å¼• ä¸æ”¯æŒ æ”¯æŒ å…¨æ–‡ç´¢å¼• æ”¯æŒ ä¸æ”¯æŒ ","date":"2022-04-26","objectID":"/mysql/:5:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"MyISAMç´¢å¼•ä¸InnoDBç´¢å¼•çš„åŒºåˆ«ï¼Ÿ InnoDBç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼ŒMyISAMç´¢å¼•æ˜¯éèšç°‡ç´¢å¼•ã€‚ InnoDBçš„ä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨ç€è¡Œæ•°æ®ï¼Œå› æ­¤ä¸»é”®ç´¢å¼•éå¸¸é«˜æ•ˆã€‚ MyISAMç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯è¡Œæ•°æ®åœ°å€ï¼Œéœ€è¦å†å¯»å€ä¸€æ¬¡æ‰èƒ½å¾—åˆ°æ•°æ®ã€‚ InnoDBéä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®å’Œå…¶ä»–å¸¦ç´¢å¼•çš„åˆ—æ•°æ®ï¼Œå› æ­¤æŸ¥è¯¢æ—¶åšåˆ°è¦†ç›–ç´¢å¼•ä¼šéå¸¸é«˜æ•ˆã€‚ ","date":"2022-04-26","objectID":"/mysql/:6:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"InnoDBå¼•æ“çš„4å¤§ç‰¹æ€§ æ’å…¥ç¼“å†²ï¼ˆinsert buffer) insert bufferæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼ˆB+ treeï¼‰å¹¶ä¸æ˜¯ç¼“å­˜çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ç‰©ç†é¡µï¼Œå½“å—å½±å“çš„ç´¢å¼•é¡µä¸åœ¨buffer poolæ—¶ç¼“å­˜ secondary index pagesçš„å˜åŒ–ï¼Œå½“buffer pageè¯»å…¥buffer poolæ—¶ï¼Œè¿›è¡Œåˆå¹¶æ“ä½œï¼Œè¿™äº›æ“ä½œå¯ä»¥æ˜¯ INSERT, UPDATE, or DELETE operations (DML) äºŒæ¬¡å†™(double write) å½“æ•°æ®åº“æ­£åœ¨ä»å†…å­˜æƒ³ç£ç›˜å†™ä¸€ä¸ªæ•°æ®é¡µæ˜¯ï¼Œæ•°æ®åº“å®•æœºï¼Œä»è€Œå¯¼è‡´è¿™ä¸ªé¡µåªå†™äº†éƒ¨åˆ†æ•°æ®ï¼Œè¿™å°±æ˜¯éƒ¨åˆ†å†™å¤±æ•ˆï¼Œå®ƒä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚è¿™æ—¶æ˜¯æ— æ³•é€šè¿‡é‡åšæ—¥å¿—æ¢å¤çš„ï¼Œå› ä¸ºé‡åšæ—¥å¿—è®°å½•çš„æ˜¯å¯¹é¡µçš„ç‰©ç†ä¿®æ”¹ï¼Œå¦‚æœé¡µæœ¬èº«å·²ç»æŸåï¼Œé‡åšæ—¥å¿—ä¹Ÿæ— èƒ½ä¸ºåŠ›ã€‚ è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•(ahi) Innodbå­˜å‚¨å¼•æ“ä¼šç›‘æ§å¯¹è¡¨ä¸ŠäºŒçº§ç´¢å¼•çš„æŸ¥æ‰¾ï¼Œå¦‚æœå‘ç°æŸäºŒçº§ç´¢å¼•è¢«é¢‘ç¹è®¿é—®ï¼ŒäºŒçº§ç´¢å¼•æˆä¸ºçƒ­æ•°æ®ï¼Œå»ºç«‹å“ˆå¸Œç´¢å¼•å¯ä»¥å¸¦æ¥é€Ÿåº¦çš„æå‡ é¢„è¯»(read ahead) ç”¨äºå¼‚æ­¥å°†ç£ç›˜çš„é¡µè¯»å–åˆ°buffer poolä¸­ï¼Œé¢„æ–™è¿™äº›é¡µä¼šé©¬ä¸Šè¢«è¯»å–åˆ°ã€‚é¢„è¯»è¯·æ±‚çš„æ‰€æœ‰é¡µé›†ä¸­åœ¨ä¸€ä¸ªèŒƒå›´å†… ","date":"2022-04-26","objectID":"/mysql/:7:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å­˜å‚¨å¼•æ“é€‰æ‹© å¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„éœ€æ±‚ï¼Œä½¿ç”¨é»˜è®¤çš„Innodbå³å¯ã€‚ MyISAMï¼šä»¥è¯»å†™æ’å…¥ä¸ºä¸»çš„åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚åšå®¢ç³»ç»Ÿã€æ–°é—»é—¨æˆ·ç½‘ç«™ã€‚ Innodbï¼šæ›´æ–°ï¼ˆåˆ é™¤ï¼‰æ“ä½œé¢‘ç‡ä¹Ÿé«˜ï¼Œæˆ–è€…è¦ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ï¼›å¹¶å‘é‡é«˜ï¼Œæ”¯æŒäº‹åŠ¡å’Œå¤–é”®ã€‚æ¯”å¦‚OAè‡ªåŠ¨åŒ–åŠå…¬ç³»ç»Ÿã€‚ ","date":"2022-04-26","objectID":"/mysql/:8:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯ç´¢å¼• ç´¢å¼•æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶(InnoDBæ•°æ®è¡¨ä¸Šçš„ç´¢å¼•æ˜¯è¡¨ç©ºé—´çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†),å®ƒä»¬åŒ…å«ç€å¯¹æ•°æ®è¡¨é‡Œæ‰€æœ‰è®°å½•çš„å¼•ç”¨æŒ‡é’ˆã€‚ ç´¢å¼•æ˜¯ä¸€ç§æ•°æ®ç»“æ„ã€‚æ•°æ®åº“ç´¢å¼•,æ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ä¸€ä¸ªæ’åºçš„æ•°æ®ç»“æ„,ä»¥ååŠ©å¿«é€ŸæŸ¥è¯¢ã€æ›´æ–°æ•°æ®åº“è¡¨ä¸­æ•°æ®ã€‚ç´¢å¼•çš„å®ç°é€šå¸¸ç”¨Bæ ‘åŠå…¶å˜ç§B+æ ‘ã€‚ ","date":"2022-04-26","objectID":"/mysql/:9:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ç´¢å¼•æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ ç´¢å¼•çš„ä¼˜ç‚¹ é€šè¿‡åˆ›å»ºå”¯ä¸€ç´¢å¼•å¯ä»¥ä¿è¯æ•°æ®åº“è¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®çš„å”¯ä¸€æ€§ã€‚ å¯ä»¥ç»™æ‰€æœ‰çš„ MySQL åˆ—ç±»å‹è®¾ç½®ç´¢å¼•ã€‚ åœ¨å®ç°æ•°æ®çš„å‚è€ƒå®Œæ•´æ€§æ–¹é¢å¯ä»¥åŠ é€Ÿè¡¨ä¸è¡¨ä¹‹é—´çš„è¿æ¥ã€‚ åœ¨ä½¿ç”¨åˆ†ç»„å’Œæ’åºå­å¥è¿›è¡Œæ•°æ®æŸ¥è¯¢æ—¶ä¹Ÿå¯ä»¥æ˜¾è‘—å‡å°‘æŸ¥è¯¢ä¸­åˆ†ç»„å’Œæ’åºçš„æ—¶é—´ å¯ä»¥å¤§å¤§åŠ å¿«æ•°æ®çš„æ£€ç´¢é€Ÿåº¦,è¿™ä¹Ÿæ˜¯åˆ›å»ºç´¢å¼•çš„æœ€ä¸»è¦çš„åŸå› ã€‚ é€šè¿‡ä½¿ç”¨ç´¢å¼•,å¯ä»¥åœ¨æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­,ä½¿ç”¨ä¼˜åŒ–éšè—å™¨,æé«˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚ ç´¢å¼•çš„ç¼ºç‚¹ åˆ›å»ºç´¢å¼•ä»¥åŠç»´æŠ¤ç´¢å¼•è¦è€—è´¹æ—¶é—´,å…·ä½“åœ°,å½“å¯¹è¡¨ä¸­åœ°æ•°æ®è¿›è¡Œå¢åŠ ã€åˆ é™¤å’Œä¿®æ”¹åœ°æ—¶å€™ï¼Œç´¢å¼•ä¹Ÿè¦åŠ¨æ€åœ°ç»´æŠ¤ï¼Œä¼šé™ä½å¢åˆ æ”¹æŸ¥åœ°æ•ˆç‡; ç´¢å¼•ä¹Ÿå ç”¨ç‰©ç†ç©ºé—´ ","date":"2022-04-26","objectID":"/mysql/:10:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ç´¢å¼•çš„æ•°æ®ç»“æ„(bæ ‘,hash) ç´¢å¼•çš„æ•°æ®ç»“æ„å’Œå…·ä½“å­˜å‚¨å¼•æ“çš„å®ç°æœ‰å…³,åœ¨mysqlä¸­ä½¿ç”¨è¾ƒå¤šçš„ç´¢å¼•æœ‰Hashç´¢å¼•,B+æ ‘ç´¢å¼•ç­‰,æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„InnoDBå­˜å‚¨å¼•æ“çš„é»˜è®¤ç´¢å¼•å®ç°ä¸º:B+æ ‘ç´¢å¼•ã€‚å¯¹äºå“ˆå¸Œç´¢å¼•æ¥è¯´,åº•å±‚çš„æ•°æ®ç»“æ„å°±æ˜¯å“ˆå¸Œè¡¨,å› æ­¤åœ¨ç»å¤§å¤šæ•°éœ€æ±‚ä¸ºå•æ¡è®°å½•æŸ¥è¯¢çš„æ—¶å€™,å¯ä»¥é€‰æ‹©å“ˆå¸Œç´¢å¼•,æŸ¥è¯¢æ€§èƒ½æœ€å¿«;å…¶ä½™åœºæ™¯ä¸‹,å»ºè®®é€‰æ‹©BTreeç´¢å¼•ã€‚ ","date":"2022-04-26","objectID":"/mysql/:11:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"åˆ›å»ºç´¢å¼•çš„åŸåˆ™ æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™,ç»„åˆç´¢å¼•éå¸¸é‡è¦çš„åŸåˆ™,mysqlä¼šä¸€ç›´å‘å³åŒ¹é…ç›´åˆ°é‡åˆ°èŒƒå›´æŸ¥è¯¢(\u003e,\u003c,between,like)å°±åœæ­¢åŒ¹é…,æ¯”å¦‚a = 1 and b = 2 and c \u003e 3 and d = 4å¦‚æœå»ºç«‹é¡ºåºçš„ç´¢å¼•,dæ˜¯ç”¨ä¸åˆ°ç´¢å¼•çš„,å¦‚æœå»ºç«‹(a,d,b,c)çš„ç´¢å¼•éƒ½å¯ä»¥ç”¨åˆ°,a,b,dçš„é¡ºåºå¯ä»¥ä»»æ„è°ƒæ•´ã€‚ è¾ƒé¢‘ç¹çš„æŸ¥è¯¢æ¡ä»¶çš„å­—æ®µé‡‡å–åˆ›å»ºç´¢å¼• æ›´æ–°é¢‘ç¹çš„å­—æ®µä¸é€‚åˆåˆ›å»ºç´¢å¼• è‹¥æ˜¯ä¸èƒ½æœ‰æ•ˆåŒºåˆ†æ•°æ®çš„åˆ—ä¸é€‚åˆåšç´¢å¼•åˆ—(å¦‚æ€§åˆ«,ç”·å¥³æœªçŸ¥,æœ€å¤šä¸‰ç§) å°½é‡çš„æ‰©å±•ç´¢å¼•,ä¸è¦æ–°å»ºç´¢å¼•ã€‚ å®šä¹‰æœ‰å¤–é”®çš„æ•°æ®åˆ—ä¸€å®šè¦å»ºç«‹ç´¢å¼•ã€‚ å¯¹äºå®šä¹‰ä¸ºtextã€imageå’Œbitçš„æ•°æ®ç±»å‹çš„åˆ—ä¸è¦å»ºç«‹ç´¢å¼•ã€‚ ","date":"2022-04-26","objectID":"/mysql/:12:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å‰ç¼€ç´¢å¼• è¯­æ³•:index(field(10)),ä½¿ç”¨å­—æ®µå€¼çš„å‰10ä¸ªå­—ç¬¦å»ºç«‹ç´¢å¼•,é»˜è®¤æ˜¯ä½¿ç”¨å­—æ®µçš„å…¨éƒ¨å†…å®¹å»ºç«‹ç´¢å¼•ã€‚ ","date":"2022-04-26","objectID":"/mysql/:13:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯æœ€å·¦å‰ç¼€åŸåˆ™?ä»€ä¹ˆæ˜¯æœ€å·¦åŒ¹é…åŸåˆ™ é¡¾åæ€ä¹‰,å°±æ˜¯æœ€å·¦ä¼˜å…ˆ,åœ¨åˆ›å»ºå¤šåˆ—ç´¢å¼•æ—¶,è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚,whereå­å¥ä¸­ä½¿ç”¨æœ€é¢‘ç¹çš„ä¸€åˆ—æ”¾åœ¨æœ€å·¦è¾¹ã€‚ ","date":"2022-04-26","objectID":"/mysql/:14:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯èšç°‡ç´¢å¼•?ä½•æ—¶ä½¿ç”¨èšç°‡ç´¢å¼•ä¸éèšç°‡ç´¢å¼• èšç°‡ç´¢å¼•:å°†æ•°æ®å­˜å‚¨ä¸ç´¢å¼•æ”¾åˆ°äº†ä¸€å—,æ‰¾åˆ°ç´¢å¼•ä¹Ÿå°±æ‰¾åˆ°äº†æ•°æ® éèšç°‡ç´¢å¼•:å°†æ•°æ®å­˜å‚¨äºç´¢å¼•åˆ†å¼€ç»“æ„,ç´¢å¼•ç»“æ„çš„å¶å­èŠ‚ç‚¹æŒ‡å‘äº†æ•°æ®çš„å¯¹åº”è¡Œ ","date":"2022-04-26","objectID":"/mysql/:15:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä½•æ—¶ä½¿ç”¨èšç°‡ç´¢å¼•äºéèšç°‡ç´¢å¼• ","date":"2022-04-26","objectID":"/mysql/:15:1","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"éèšç°‡ç´¢å¼•ä¸€å®šä¼šå›è¡¨æŸ¥è¯¢å— ä¸ä¸€å®š,å¦‚æœæŸ¥è¯¢è¯­å¥æ‰€è¦æ±‚çš„å­—æ®µå…¨éƒ¨å‘½ä¸­äº†ç´¢å¼•,å°±ä¸å¿…è¦å›è¡¨æŸ¥è¯¢ã€‚ ","date":"2022-04-26","objectID":"/mysql/:16:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯æ•°æ®åº“äº‹åŠ¡ äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•°æ®åº“æ“ä½œåºåˆ—ï¼Œä¹Ÿæ˜¯æ•°æ®åº“å¹¶å‘æ§åˆ¶çš„åŸºæœ¬å•ä½ï¼Œå…¶æ‰§è¡Œçš„ç»“æœå¿…é¡»ä½¿æ•°æ®åº“ä»ä¸€ç§ä¸€è‡´æ€§çŠ¶æ€å˜åˆ°å¦ä¸€ç§ä¸€è‡´æ€§çŠ¶æ€ã€‚äº‹åŠ¡æ˜¯é€»è¾‘ä¸Šçš„ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚ äº‹åŠ¡æœ€ç»å…¸ä¹Ÿç»å¸¸è¢«æ‹¿å‡ºæ¥è¯´ä¾‹å­å°±æ˜¯è½¬è´¦äº†ã€‚ å‡å¦‚å°æ˜è¦ç»™å°çº¢è½¬è´¦1000å…ƒï¼Œè¿™ä¸ªè½¬è´¦ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªå…³é”®æ“ä½œå°±æ˜¯ï¼šå°†å°æ˜çš„ä½™é¢å‡å°‘1000å…ƒï¼Œå°†å°çº¢çš„ä½™é¢å¢åŠ 1000å…ƒã€‚ä¸‡ä¸€åœ¨è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´çªç„¶å‡ºç°é”™è¯¯æ¯”å¦‚é“¶è¡Œç³»ç»Ÿå´©æºƒï¼Œå¯¼è‡´å°æ˜ä½™é¢å‡å°‘è€Œå°çº¢çš„ä½™é¢æ²¡æœ‰å¢åŠ ï¼Œè¿™æ ·å°±ä¸å¯¹äº†ã€‚äº‹åŠ¡å°±æ˜¯ä¿è¯è¿™ä¸¤ä¸ªå…³é”®æ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½è¦å¤±è´¥ã€‚ ","date":"2022-04-26","objectID":"/mysql/:17:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ åŸå­æ€§: äº‹åŠ¡æ—¶æœ€å°çš„æ‰§è¡Œå•ä½,ä¸å…è®¸åˆ†å‰²ã€‚ ä¸€è‡´æ€§:æ‰§è¡Œäº‹åŠ¡å‰å,æ•°æ®ä¿æŒä¸€è‡´,å¤šä¸ªäº‹åŠ¡å¯¹åŒä¸€ä¸ªæ•°æ®è¯»å–çš„ç»“æœæ˜¯ç›¸åŒçš„ éš”ç¦»æ€§:å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶,ä¸€ä¸ªç”¨æˆ·çš„äº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°,å„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„; æŒä¹…æ€§:ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„,å³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•çš„å½±å“ã€‚ ","date":"2022-04-26","objectID":"/mysql/:18:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯è„è¯»?å¹»è¯»?ä¸å¯é‡å¤è¯»? è„è¯»:æŸä¸ªäº‹åŠ¡å·²æ›´æ–°ä¸€ä»½æ•°æ®,å¦ä¸€ä¸ªäº‹åŠ¡åœ¨æ­¤æ—¶è¯»å–äº†å¦ä¸€ä»½æ•°æ®,ç”±äºæŸä¸ªåŸå› ,å‰ä¸€ä¸ªRollBackäº†æ“ä½œ,åˆ™åä¸€ä¸ªäº‹åŠ¡æ‰€è¯»å–çš„æ•°æ®ä¼šæ˜¯ä¸æ­£ç¡®çš„ã€‚ ä¸å¯é‡å¤è¯»(Non-repeatable read):åœ¨ä¸€ä¸ªäº‹åŠ¡çš„ä¸¤æ¬¡æŸ¥è¯¢ä¸ä¸€è‡´,è¿™å¯èƒ½æ˜¯ä¸¤æ¬¡æŸ¥è¯¢è¿‡ç¨‹ä¸­æ’å…¥äº†ä¸€ä¸ªäº‹åŠ¡æ›´æ–°çš„åŸæœ‰çš„æ•°æ®ã€‚ å¹»è¯»:åœ¨ä¸€ä¸ªäº‹åŠ¡çš„ä¸¤æ¬¡æŸ¥è¯¢çš„åˆ—æ•°ä¸ä¸€è‡´ã€‚ ","date":"2022-04-26","objectID":"/mysql/:19:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯äº‹åŠ¡çš„éš”ç¦»çº§åˆ«?Mysqlçš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆ? ä¸ºäº†è¾¾åˆ°äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼Œæ•°æ®åº“å®šä¹‰äº†4ç§ä¸åŒçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œç”±ä½åˆ°é«˜ä¾æ¬¡ä¸ºRead uncommittedã€Read committedã€Repeatable readã€Serializableï¼Œè¿™å››ä¸ªçº§åˆ«å¯ä»¥é€ä¸ªè§£å†³è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»è¿™å‡ ç±»é—®é¢˜ã€‚ éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»å½±è¯» READ-UNCOMMITTED âˆš âˆš âˆš READ-COMMITTED Ã— âˆš âˆš REPEATABLE-READ Ã— Ã— âˆš SERIALIZABLE Ã— Ã— Ã— SQL æ ‡å‡†å®šä¹‰äº†å››ä¸ªéš”ç¦»çº§åˆ«ï¼š READ-UNCOMMITTED(è¯»å–æœªæäº¤)ï¼š æœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ã€‚ READ-COMMITTED(è¯»å–å·²æäº¤)ï¼š å…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚ REPEATABLE-READ(å¯é‡å¤è¯»)ï¼š å¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œå¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚ SERIALIZABLE(å¯ä¸²è¡ŒåŒ–)ï¼š æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä»ACIDçš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚ ","date":"2022-04-26","objectID":"/mysql/:20:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å¯¹MySQLçš„é”äº†è§£å— å½“æ•°æ®åº“æœ‰å¹¶å‘äº‹åŠ¡çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ•°æ®çš„ä¸ä¸€è‡´ï¼Œè¿™æ—¶å€™éœ€è¦ä¸€äº›æœºåˆ¶æ¥ä¿è¯è®¿é—®çš„æ¬¡åºï¼Œé”æœºåˆ¶å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªæœºåˆ¶ã€‚ å°±åƒé…’åº—çš„æˆ¿é—´ï¼Œå¦‚æœå¤§å®¶éšæ„è¿›å‡ºï¼Œå°±ä¼šå‡ºç°å¤šäººæŠ¢å¤ºåŒä¸€ä¸ªæˆ¿é—´çš„æƒ…å†µï¼Œè€Œåœ¨æˆ¿é—´ä¸Šè£…ä¸Šé”ï¼Œç”³è¯·åˆ°é’¥åŒ™çš„äººæ‰å¯ä»¥å…¥ä½å¹¶ä¸”å°†æˆ¿é—´é”èµ·æ¥ï¼Œå…¶ä»–äººåªæœ‰ç­‰ä»–ä½¿ç”¨å®Œæ¯•æ‰å¯ä»¥å†æ¬¡ä½¿ç”¨ã€‚ ","date":"2022-04-26","objectID":"/mysql/:21:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"éš”ç¦»çº§åˆ«ä¸é”çš„å…³ç³» åœ¨Read Uncommittedçº§åˆ«ä¸‹ï¼Œè¯»å–æ•°æ®ä¸éœ€è¦åŠ å…±äº«é”ï¼Œè¿™æ ·å°±ä¸ä¼šè·Ÿè¢«ä¿®æ”¹çš„æ•°æ®ä¸Šçš„æ’ä»–é”å†²çª åœ¨Read Committedçº§åˆ«ä¸‹ï¼Œè¯»æ“ä½œéœ€è¦åŠ å…±äº«é”ï¼Œä½†æ˜¯åœ¨è¯­å¥æ‰§è¡Œå®Œä»¥åé‡Šæ”¾å…±äº«é”ï¼› åœ¨Repeatable Readçº§åˆ«ä¸‹ï¼Œè¯»æ“ä½œéœ€è¦åŠ å…±äº«é”ï¼Œä½†æ˜¯åœ¨äº‹åŠ¡æäº¤ä¹‹å‰å¹¶ä¸é‡Šæ”¾å…±äº«é”ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»ç­‰å¾…äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ä»¥åæ‰é‡Šæ”¾å…±äº«é”ã€‚ SERIALIZABLE æ˜¯é™åˆ¶æ€§æœ€å¼ºçš„éš”ç¦»çº§åˆ«ï¼Œå› ä¸ºè¯¥çº§åˆ«é”å®šæ•´ä¸ªèŒƒå›´çš„é”®ï¼Œå¹¶ä¸€ç›´æŒæœ‰é”ï¼Œç›´åˆ°äº‹åŠ¡å®Œæˆã€‚ ","date":"2022-04-26","objectID":"/mysql/:22:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"æŒ‰ç…§é”çš„ç²’åº¦åˆ†æ•°æ®åº“é”æœ‰å“ªäº›?é”æœºåˆ¶ä¸InnoDBé”ç®—æ³• åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå¯ä»¥æŒ‰ç…§é”çš„ç²’åº¦æŠŠæ•°æ®åº“é”åˆ†ä¸ºè¡Œçº§é”(INNODBå¼•æ“)ã€è¡¨çº§é”(MYISAMå¼•æ“)å’Œé¡µçº§é”(BDBå¼•æ“ )ã€‚ MyISAMå’ŒInnoDBå­˜å‚¨å¼•æ“ä½¿ç”¨çš„é”ï¼š MyISAMé‡‡ç”¨è¡¨çº§é”(table-level locking)ã€‚ InnoDBæ”¯æŒè¡Œçº§é”(row-level locking)å’Œè¡¨çº§é”ï¼Œé»˜è®¤ä¸ºè¡Œçº§é” è¡Œçº§é”ï¼Œè¡¨çº§é”å’Œé¡µçº§é”å¯¹æ¯” è¡Œçº§é” è¡Œçº§é”æ˜¯Mysqlä¸­é”å®šç²’åº¦æœ€ç»†çš„ä¸€ç§é”ï¼Œè¡¨ç¤ºåªé’ˆå¯¹å½“å‰æ“ä½œçš„è¡Œè¿›è¡ŒåŠ é”ã€‚è¡Œçº§é”èƒ½å¤§å¤§å‡å°‘æ•°æ®åº“æ“ä½œçš„å†²çªã€‚å…¶åŠ é”ç²’åº¦æœ€å°ï¼Œä½†åŠ é”çš„å¼€é”€ä¹Ÿæœ€å¤§ã€‚è¡Œçº§é”åˆ†ä¸ºå…±äº«é” å’Œ æ’ä»–é”ã€‚ ç‰¹ç‚¹ï¼šå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦ä¹Ÿæœ€é«˜ã€‚ è¡¨çº§é” è¡¨çº§é”æ˜¯MySQLä¸­é”å®šç²’åº¦æœ€å¤§çš„ä¸€ç§é”ï¼Œè¡¨ç¤ºå¯¹å½“å‰æ“ä½œçš„æ•´å¼ è¡¨åŠ é”ï¼Œå®ƒå®ç°ç®€å•ï¼Œèµ„æºæ¶ˆè€—è¾ƒå°‘ï¼Œè¢«å¤§éƒ¨åˆ†MySQLå¼•æ“æ”¯æŒã€‚æœ€å¸¸ä½¿ç”¨çš„MYISAMä¸INNODBéƒ½æ”¯æŒè¡¨çº§é”å®šã€‚è¡¨çº§é”å®šåˆ†ä¸ºè¡¨å…±äº«è¯»é”ï¼ˆå…±äº«é”ï¼‰ä¸è¡¨ç‹¬å å†™é”ï¼ˆæ’ä»–é”ï¼‰ã€‚ ç‰¹ç‚¹ï¼šå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘å‡ºé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚ é¡µçº§é” é¡µçº§é”æ˜¯MySQLä¸­é”å®šç²’åº¦ä»‹äºè¡Œçº§é”å’Œè¡¨çº§é”ä¸­é—´çš„ä¸€ç§é”ã€‚è¡¨çº§é”é€Ÿåº¦å¿«ï¼Œä½†å†²çªå¤šï¼Œè¡Œçº§å†²çªå°‘ï¼Œä½†é€Ÿåº¦æ…¢ã€‚æ‰€ä»¥å–äº†æŠ˜è¡·çš„é¡µçº§ï¼Œä¸€æ¬¡é”å®šç›¸é‚»çš„ä¸€ç»„è®°å½•ã€‚ ç‰¹ç‚¹ï¼šå¼€é”€å’ŒåŠ é”æ—¶é—´ç•Œäºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦ç•Œäºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œå¹¶å‘åº¦ä¸€èˆ¬ ","date":"2022-04-26","objectID":"/mysql/:23:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»é”çš„ç±»åˆ«ä¸Šåˆ†MySQLéƒ½æœ‰å“ªäº›é”å‘¢ï¼Ÿåƒä¸Šé¢é‚£æ ·å­è¿›è¡Œé”å®šå²‚ä¸æ˜¯æœ‰ç‚¹é˜»ç¢å¹¶å‘æ•ˆç‡äº† ä»é”çš„ç±»åˆ«ä¸Šæ¥è®²ï¼Œæœ‰å…±äº«é”å’Œæ’ä»–é”ã€‚ å…±äº«é”: åˆå«åšè¯»é”ã€‚ å½“ç”¨æˆ·è¦è¿›è¡Œæ•°æ®çš„è¯»å–æ—¶ï¼Œå¯¹æ•°æ®åŠ ä¸Šå…±äº«é”ã€‚å…±äº«é”å¯ä»¥åŒæ—¶åŠ ä¸Šå¤šä¸ªã€‚ æ’ä»–é”: åˆå«åšå†™é”ã€‚ å½“ç”¨æˆ·è¦è¿›è¡Œæ•°æ®çš„å†™å…¥æ—¶ï¼Œå¯¹æ•°æ®åŠ ä¸Šæ’ä»–é”ã€‚æ’ä»–é”åªå¯ä»¥åŠ ä¸€ä¸ªï¼Œä»–å’Œå…¶ä»–çš„æ’ä»–é”ï¼Œå…±äº«é”éƒ½ç›¸æ–¥ã€‚ ç”¨ä¸Šé¢çš„ä¾‹å­æ¥è¯´å°±æ˜¯ç”¨æˆ·çš„è¡Œä¸ºæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ¥çœ‹æˆ¿ï¼Œå¤šä¸ªç”¨æˆ·ä¸€èµ·çœ‹æˆ¿æ˜¯å¯ä»¥æ¥å—çš„ã€‚ ä¸€ç§æ˜¯çœŸæ­£çš„å…¥ä½ä¸€æ™šï¼Œåœ¨è¿™æœŸé—´ï¼Œæ— è®ºæ˜¯æƒ³å…¥ä½çš„è¿˜æ˜¯æƒ³çœ‹æˆ¿çš„éƒ½ä¸å¯ä»¥ã€‚ é”çš„ç²’åº¦å–å†³äºå…·ä½“çš„å­˜å‚¨å¼•æ“ï¼ŒInnoDBå®ç°äº†è¡Œçº§é”ï¼Œé¡µçº§é”ï¼Œè¡¨çº§é”ã€‚ ä»–ä»¬çš„åŠ é”å¼€é”€ä»å¤§åˆ°å°ï¼Œå¹¶å‘èƒ½åŠ›ä¹Ÿæ˜¯ä»å¤§åˆ°å°ã€‚ ","date":"2022-04-26","objectID":"/mysql/:23:1","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"MySQLä¸­InnoDBå¼•æ“çš„è¡Œé”æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ ç­”ï¼šInnoDBæ˜¯åŸºäºç´¢å¼•æ¥å®Œæˆè¡Œé” ä¾‹: select * from tab_with_index where id = 1 for update; for update å¯ä»¥æ ¹æ®æ¡ä»¶æ¥å®Œæˆè¡Œé”é”å®šï¼Œå¹¶ä¸” id æ˜¯æœ‰ç´¢å¼•é”®çš„åˆ—ï¼Œå¦‚æœ id ä¸æ˜¯ç´¢å¼•é”®é‚£ä¹ˆInnoDBå°†å®Œæˆè¡¨é”ï¼Œå¹¶å‘å°†æ— ä»è°ˆèµ· ","date":"2022-04-26","objectID":"/mysql/:23:2","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"InnoDBå­˜å‚¨å¼•æ“çš„é”çš„ç®—æ³•æœ‰ä¸‰ç§ Record lockï¼šå•ä¸ªè¡Œè®°å½•ä¸Šçš„é” Gap lockï¼šé—´éš™é”ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä¸åŒ…æ‹¬è®°å½•æœ¬èº« Next-key lockï¼šrecord+gap é”å®šä¸€ä¸ªèŒƒå›´ï¼ŒåŒ…å«è®°å½•æœ¬èº« ç›¸å…³çŸ¥è¯†ç‚¹ï¼š innodbå¯¹äºè¡Œçš„æŸ¥è¯¢ä½¿ç”¨next-key lock Next-locking keyingä¸ºäº†è§£å†³Phantom Problemå¹»è¯»é—®é¢˜ å½“æŸ¥è¯¢çš„ç´¢å¼•å«æœ‰å”¯ä¸€å±æ€§æ—¶ï¼Œå°†next-key locké™çº§ä¸ºrecord key Gapé”è®¾è®¡çš„ç›®çš„æ˜¯ä¸ºäº†é˜»æ­¢å¤šä¸ªäº‹åŠ¡å°†è®°å½•æ’å…¥åˆ°åŒä¸€èŒƒå›´å†…ï¼Œè€Œè¿™ä¼šå¯¼è‡´å¹»è¯»é—®é¢˜çš„äº§ç”Ÿ æœ‰ä¸¤ç§æ–¹å¼æ˜¾å¼å…³é—­gapé”ï¼šï¼ˆé™¤äº†å¤–é”®çº¦æŸå’Œå”¯ä¸€æ€§æ£€æŸ¥å¤–ï¼Œå…¶ä½™æƒ…å†µä»…ä½¿ç”¨record lockï¼‰ A. å°†äº‹åŠ¡éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºRC B. å°†å‚æ•°innodb_locks_unsafe_for_binlogè®¾ç½®ä¸º1 ","date":"2022-04-26","objectID":"/mysql/:23:3","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡åœ¨åŒä¸€èµ„æºä¸Šç›¸äº’å ç”¨ï¼Œå¹¶è¯·æ±‚é”å®šå¯¹æ–¹çš„èµ„æºï¼Œä»è€Œå¯¼è‡´æ¶æ€§å¾ªç¯çš„ç°è±¡ã€‚ å¸¸è§çš„è§£å†³æ­»é”çš„æ–¹æ³• 1ã€å¦‚æœä¸åŒç¨‹åºä¼šå¹¶å‘å­˜å–å¤šä¸ªè¡¨ï¼Œå°½é‡çº¦å®šä»¥ç›¸åŒçš„é¡ºåºè®¿é—®è¡¨ï¼Œå¯ä»¥å¤§å¤§é™ä½æ­»é”æœºä¼šã€‚ 2ã€åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå°½å¯èƒ½åšåˆ°ä¸€æ¬¡é”å®šæ‰€éœ€è¦çš„æ‰€æœ‰èµ„æºï¼Œå‡å°‘æ­»é”äº§ç”Ÿæ¦‚ç‡ï¼› 3ã€å¯¹äºéå¸¸å®¹æ˜“äº§ç”Ÿæ­»é”çš„ä¸šåŠ¡éƒ¨åˆ†ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨å‡çº§é”å®šé¢—ç²’åº¦ï¼Œé€šè¿‡è¡¨çº§é”å®šæ¥å‡å°‘æ­»é”äº§ç”Ÿçš„æ¦‚ç‡ï¼› å¦‚æœä¸šåŠ¡å¤„ç†ä¸å¥½å¯ä»¥ç”¨åˆ†å¸ƒå¼äº‹åŠ¡é”æˆ–è€…ä½¿ç”¨ä¹è§‚é” ","date":"2022-04-26","objectID":"/mysql/:23:4","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"æ•°æ®åº“çš„ä¹è§‚é”å’Œæ‚²è§‚é”æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆå®ç°çš„ï¼Ÿ æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆDBMSï¼‰ä¸­çš„å¹¶å‘æ§åˆ¶çš„ä»»åŠ¡æ˜¯ç¡®ä¿åœ¨å¤šä¸ªäº‹åŠ¡åŒæ—¶å­˜å–æ•°æ®åº“ä¸­åŒä¸€æ•°æ®æ—¶ä¸ç ´åäº‹åŠ¡çš„éš”ç¦»æ€§å’Œç»Ÿä¸€æ€§ä»¥åŠæ•°æ®åº“çš„ç»Ÿä¸€æ€§ã€‚ä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆä¹è§‚é”ï¼‰å’Œæ‚²è§‚å¹¶å‘æ§åˆ¶ï¼ˆæ‚²è§‚é”ï¼‰æ˜¯å¹¶å‘æ§åˆ¶ä¸»è¦é‡‡ç”¨çš„æŠ€æœ¯æ‰‹æ®µã€‚ æ‚²è§‚é”ï¼šå‡å®šä¼šå‘ç”Ÿå¹¶å‘å†²çªï¼Œå±è”½ä¸€åˆ‡å¯èƒ½è¿åæ•°æ®å®Œæ•´æ€§çš„æ“ä½œã€‚åœ¨æŸ¥è¯¢å®Œæ•°æ®çš„æ—¶å€™å°±æŠŠäº‹åŠ¡é”èµ·æ¥ï¼Œç›´åˆ°æäº¤äº‹åŠ¡ã€‚å®ç°æ–¹å¼ï¼šä½¿ç”¨æ•°æ®åº“ä¸­çš„é”æœºåˆ¶ ä¹è§‚é”ï¼šå‡è®¾ä¸ä¼šå‘ç”Ÿå¹¶å‘å†²çªï¼Œåªåœ¨æäº¤æ“ä½œæ—¶æ£€æŸ¥æ˜¯å¦è¿åæ•°æ®å®Œæ•´æ€§ã€‚åœ¨ä¿®æ”¹æ•°æ®çš„æ—¶å€™æŠŠäº‹åŠ¡é”èµ·æ¥ï¼Œé€šè¿‡versionçš„æ–¹å¼æ¥è¿›è¡Œé”å®šã€‚å®ç°æ–¹å¼ï¼šä¹ä¸€èˆ¬ä¼šä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ–CASç®—æ³•å®ç°ã€‚ ä¸¤ç§é”çš„ä½¿ç”¨åœºæ™¯ ä»ä¸Šé¢å¯¹ä¸¤ç§é”çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ä¸¤ç§é”å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œä¸å¯è®¤ä¸ºä¸€ç§å¥½äºå¦ä¸€ç§ï¼Œåƒä¹è§‚é”é€‚ç”¨äºå†™æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼ˆå¤šè¯»åœºæ™¯ï¼‰ï¼Œå³å†²çªçœŸçš„å¾ˆå°‘å‘ç”Ÿçš„æ—¶å€™ï¼Œè¿™æ ·å¯ä»¥çœå»äº†é”çš„å¼€é”€ï¼ŒåŠ å¤§äº†ç³»ç»Ÿçš„æ•´ä¸ªååé‡ã€‚ ä½†å¦‚æœæ˜¯å¤šå†™çš„æƒ…å†µï¼Œä¸€èˆ¬ä¼šç»å¸¸äº§ç”Ÿå†²çªï¼Œè¿™å°±ä¼šå¯¼è‡´ä¸Šå±‚åº”ç”¨ä¼šä¸æ–­çš„è¿›è¡Œretryï¼Œè¿™æ ·åå€’æ˜¯é™ä½äº†æ€§èƒ½ï¼Œæ‰€ä»¥ä¸€èˆ¬å¤šå†™çš„åœºæ™¯ä¸‹ç”¨æ‚²è§‚é”å°±æ¯”è¾ƒåˆé€‚ã€‚ ","date":"2022-04-26","objectID":"/mysql/:23:5","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"è§†å›¾ ","date":"2022-04-26","objectID":"/mysql/:24:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è§†å›¾ï¼Ÿä»€ä¹ˆæ˜¯è§†å›¾ï¼Ÿ ä¸ºäº†æé«˜å¤æ‚SQLè¯­å¥çš„å¤ç”¨æ€§å’Œè¡¨æ“ä½œçš„å®‰å…¨æ€§ï¼ŒMySQLæ•°æ®åº“ç®¡ç†ç³»ç»Ÿæä¾›äº†è§†å›¾ç‰¹æ€§ã€‚æ‰€è°“è§†å›¾ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ç§è™šæ‹Ÿè¡¨ï¼Œåœ¨ç‰©ç†ä¸Šæ˜¯ä¸å­˜åœ¨çš„ï¼Œå…¶å†…å®¹ä¸çœŸå®çš„è¡¨ç›¸ä¼¼ï¼ŒåŒ…å«ä¸€ç³»åˆ—å¸¦æœ‰åç§°çš„åˆ—å’Œè¡Œæ•°æ®ã€‚ä½†æ˜¯ï¼Œè§†å›¾å¹¶ä¸åœ¨æ•°æ®åº“ä¸­ä»¥å‚¨å­˜çš„æ•°æ®å€¼å½¢å¼å­˜åœ¨ã€‚è¡Œå’Œåˆ—æ•°æ®æ¥è‡ªå®šä¹‰è§†å›¾çš„æŸ¥è¯¢æ‰€å¼•ç”¨åŸºæœ¬è¡¨ï¼Œå¹¶ä¸”åœ¨å…·ä½“å¼•ç”¨è§†å›¾æ—¶åŠ¨æ€ç”Ÿæˆã€‚ è§†å›¾ä½¿å¼€å‘è€…åªå…³å¿ƒæ„Ÿå…´è¶£çš„æŸäº›ç‰¹å®šæ•°æ®å’Œæ‰€è´Ÿè´£çš„ç‰¹å®šä»»åŠ¡ï¼Œåªèƒ½çœ‹åˆ°è§†å›¾ä¸­æ‰€å®šä¹‰çš„æ•°æ®ï¼Œè€Œä¸æ˜¯è§†å›¾æ‰€å¼•ç”¨è¡¨ä¸­çš„æ•°æ®ï¼Œä»è€Œæé«˜äº†æ•°æ®åº“ä¸­æ•°æ®çš„å®‰å…¨æ€§ã€‚ ","date":"2022-04-26","objectID":"/mysql/:24:1","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"è§†å›¾æœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿ è§†å›¾çš„ç‰¹ç‚¹å¦‚ä¸‹: è§†å›¾çš„åˆ—å¯ä»¥æ¥è‡ªä¸åŒçš„è¡¨ï¼Œæ˜¯è¡¨çš„æŠ½è±¡å’Œåœ¨é€»è¾‘æ„ä¹‰ä¸Šå»ºç«‹çš„æ–°å…³ç³»ã€‚ è§†å›¾æ˜¯ç”±åŸºæœ¬è¡¨(å®è¡¨)äº§ç”Ÿçš„è¡¨(è™šè¡¨)ã€‚ è§†å›¾çš„å»ºç«‹å’Œåˆ é™¤ä¸å½±å“åŸºæœ¬è¡¨ã€‚ å¯¹è§†å›¾å†…å®¹çš„æ›´æ–°(æ·»åŠ ï¼Œåˆ é™¤å’Œä¿®æ”¹)ç›´æ¥å½±å“åŸºæœ¬è¡¨ã€‚ å½“è§†å›¾æ¥è‡ªå¤šä¸ªåŸºæœ¬è¡¨æ—¶ï¼Œä¸å…è®¸æ·»åŠ å’Œåˆ é™¤æ•°æ®ã€‚ è§†å›¾çš„æ“ä½œåŒ…æ‹¬åˆ›å»ºè§†å›¾ï¼ŒæŸ¥çœ‹è§†å›¾ï¼Œåˆ é™¤è§†å›¾å’Œä¿®æ”¹è§†å›¾ã€‚ ","date":"2022-04-26","objectID":"/mysql/:24:2","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"è§†å›¾çš„ä½¿ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ è§†å›¾æ ¹æœ¬ç”¨é€”ï¼šç®€åŒ–sqlæŸ¥è¯¢ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚å¦‚æœè¯´è¿˜æœ‰å¦å¤–ä¸€ä¸ªç”¨é€”é‚£å°±æ˜¯å…¼å®¹è€çš„è¡¨ç»“æ„ã€‚ ä¸‹é¢æ˜¯è§†å›¾çš„å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š é‡ç”¨SQLè¯­å¥ï¼› ç®€åŒ–å¤æ‚çš„SQLæ“ä½œã€‚åœ¨ç¼–å†™æŸ¥è¯¢åï¼Œå¯ä»¥æ–¹ä¾¿çš„é‡ç”¨å®ƒè€Œä¸å¿…çŸ¥é“å®ƒçš„åŸºæœ¬æŸ¥è¯¢ç»†èŠ‚ï¼› ä½¿ç”¨è¡¨çš„ç»„æˆéƒ¨åˆ†è€Œä¸æ˜¯æ•´ä¸ªè¡¨ï¼› ä¿æŠ¤æ•°æ®ã€‚å¯ä»¥ç»™ç”¨æˆ·æˆäºˆè¡¨çš„ç‰¹å®šéƒ¨åˆ†çš„è®¿é—®æƒé™è€Œä¸æ˜¯æ•´ä¸ªè¡¨çš„è®¿é—®æƒé™ï¼› æ›´æ”¹æ•°æ®æ ¼å¼å’Œè¡¨ç¤ºã€‚è§†å›¾å¯è¿”å›ä¸åº•å±‚è¡¨çš„è¡¨ç¤ºå’Œæ ¼å¼ä¸åŒçš„æ•°æ®ã€‚ ","date":"2022-04-26","objectID":"/mysql/:24:3","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"è§†å›¾çš„ä¼˜ç‚¹ æŸ¥è¯¢ç®€å•åŒ–ã€‚è§†å›¾èƒ½ç®€åŒ–ç”¨æˆ·çš„æ“ä½œ æ•°æ®å®‰å…¨æ€§ã€‚è§†å›¾ä½¿ç”¨æˆ·èƒ½ä»¥å¤šç§è§’åº¦çœ‹å¾…åŒä¸€æ•°æ®ï¼Œèƒ½å¤Ÿå¯¹æœºå¯†æ•°æ®æä¾›å®‰å…¨ä¿æŠ¤ é€»è¾‘æ•°æ®ç‹¬ç«‹æ€§ã€‚è§†å›¾å¯¹é‡æ„æ•°æ®åº“æä¾›äº†ä¸€å®šç¨‹åº¦çš„é€»è¾‘ç‹¬ç«‹æ€§ ","date":"2022-04-26","objectID":"/mysql/:24:4","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"è§†å›¾çš„ç¼ºç‚¹ æ€§èƒ½ã€‚æ•°æ®åº“å¿…é¡»æŠŠè§†å›¾çš„æŸ¥è¯¢è½¬åŒ–æˆå¯¹åŸºæœ¬è¡¨çš„æŸ¥è¯¢ï¼Œå¦‚æœè¿™ä¸ªè§†å›¾æ˜¯ç”±ä¸€ä¸ªå¤æ‚çš„å¤šè¡¨æŸ¥è¯¢æ‰€å®šä¹‰ï¼Œé‚£ä¹ˆï¼Œå³ä½¿æ˜¯è§†å›¾çš„ä¸€ä¸ªç®€å•æŸ¥è¯¢ï¼Œæ•°æ®åº“ä¹ŸæŠŠå®ƒå˜æˆä¸€ä¸ªå¤æ‚çš„ç»“åˆä½“ï¼Œéœ€è¦èŠ±è´¹ä¸€å®šçš„æ—¶é—´ã€‚ ä¿®æ”¹é™åˆ¶ã€‚å½“ç”¨æˆ·è¯•å›¾ä¿®æ”¹è§†å›¾çš„æŸäº›è¡Œæ—¶ï¼Œæ•°æ®åº“å¿…é¡»æŠŠå®ƒè½¬åŒ–ä¸ºå¯¹åŸºæœ¬è¡¨çš„æŸäº›è¡Œçš„ä¿®æ”¹ã€‚äº‹å®ä¸Šï¼Œå½“ä»è§†å›¾ä¸­æ’å…¥æˆ–è€…åˆ é™¤æ—¶ï¼Œæƒ…å†µä¹Ÿæ˜¯è¿™æ ·ã€‚å¯¹äºç®€å•è§†å›¾æ¥è¯´ï¼Œè¿™æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œä½†æ˜¯ï¼Œå¯¹äºæ¯”è¾ƒå¤æ‚çš„è§†å›¾ï¼Œå¯èƒ½æ˜¯ä¸å¯ä¿®æ”¹çš„ è¿™äº›è§†å›¾æœ‰å¦‚ä¸‹ç‰¹å¾ï¼š1.æœ‰UNIQUEç­‰é›†åˆæ“ä½œç¬¦çš„è§†å›¾ã€‚2.æœ‰GROUP BYå­å¥çš„è§†å›¾ã€‚3.æœ‰è¯¸å¦‚AVG\\SUM\\MAXç­‰èšåˆå‡½æ•°çš„è§†å›¾ã€‚ 4.ä½¿ç”¨DISTINCTå…³é”®å­—çš„è§†å›¾ã€‚5.è¿æ¥è¡¨çš„è§†å›¾ï¼ˆå…¶ä¸­æœ‰äº›ä¾‹å¤–ï¼‰ ","date":"2022-04-26","objectID":"/mysql/:24:5","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯æ¸¸æ ‡ï¼Ÿ æ¸¸æ ‡æ˜¯ç³»ç»Ÿä¸ºç”¨æˆ·å¼€è®¾çš„ä¸€ä¸ªæ•°æ®ç¼“å†²åŒºï¼Œå­˜æ”¾SQLè¯­å¥çš„æ‰§è¡Œç»“æœï¼Œæ¯ä¸ªæ¸¸æ ‡åŒºéƒ½æœ‰ä¸€ä¸ªåå­—ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡æ¸¸æ ‡é€ä¸€è·å–è®°å½•å¹¶èµ‹ç»™ä¸»å˜é‡ï¼Œäº¤ç”±ä¸»è¯­è¨€è¿›ä¸€æ­¥å¤„ç†ã€‚ ","date":"2022-04-26","objectID":"/mysql/:24:6","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å­˜å‚¨è¿‡ç¨‹ä¸å‡½æ•° ","date":"2022-04-26","objectID":"/mysql/:25:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯å­˜å‚¨è¿‡ç¨‹ï¼Ÿæœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ å­˜å‚¨è¿‡ç¨‹æ˜¯ä¸€ä¸ªé¢„ç¼–è¯‘çš„SQLè¯­å¥ï¼Œä¼˜ç‚¹æ˜¯å…è®¸æ¨¡å—åŒ–çš„è®¾è®¡ï¼Œå°±æ˜¯è¯´åªéœ€è¦åˆ›å»ºä¸€æ¬¡ï¼Œä»¥ååœ¨è¯¥ç¨‹åºä¸­å°±å¯ä»¥è°ƒç”¨å¤šæ¬¡ã€‚å¦‚æœæŸæ¬¡æ“ä½œéœ€è¦æ‰§è¡Œå¤šæ¬¡SQLï¼Œä½¿ç”¨å­˜å‚¨è¿‡ç¨‹æ¯”å•çº¯SQLè¯­å¥æ‰§è¡Œè¦å¿«ã€‚ ä¼˜ç‚¹ 1ï¼‰å­˜å‚¨è¿‡ç¨‹æ˜¯é¢„ç¼–è¯‘è¿‡çš„ï¼Œæ‰§è¡Œæ•ˆç‡é«˜ã€‚ 2ï¼‰å­˜å‚¨è¿‡ç¨‹çš„ä»£ç ç›´æ¥å­˜æ”¾äºæ•°æ®åº“ä¸­ï¼Œé€šè¿‡å­˜å‚¨è¿‡ç¨‹åç›´æ¥è°ƒç”¨ï¼Œå‡å°‘ç½‘ç»œé€šè®¯ã€‚ 3ï¼‰å®‰å…¨æ€§é«˜ï¼Œæ‰§è¡Œå­˜å‚¨è¿‡ç¨‹éœ€è¦æœ‰ä¸€å®šæƒé™çš„ç”¨æˆ·ã€‚ 4ï¼‰å­˜å‚¨è¿‡ç¨‹å¯ä»¥é‡å¤ä½¿ç”¨ï¼Œå‡å°‘æ•°æ®åº“å¼€å‘äººå‘˜çš„å·¥ä½œé‡ã€‚ ç¼ºç‚¹ 1ï¼‰è°ƒè¯•éº»çƒ¦ï¼Œä½†æ˜¯ç”¨ PL/SQL Developer è°ƒè¯•å¾ˆæ–¹ä¾¿ï¼å¼¥è¡¥è¿™ä¸ªç¼ºç‚¹ã€‚ 2ï¼‰ç§»æ¤é—®é¢˜ï¼Œæ•°æ®åº“ç«¯ä»£ç å½“ç„¶æ˜¯ä¸æ•°æ®åº“ç›¸å…³çš„ã€‚ä½†æ˜¯å¦‚æœæ˜¯åšå·¥ç¨‹å‹é¡¹ç›®ï¼ŒåŸºæœ¬ä¸å­˜åœ¨ç§»æ¤é—®é¢˜ã€‚ 3ï¼‰é‡æ–°ç¼–è¯‘é—®é¢˜ï¼Œå› ä¸ºåç«¯ä»£ç æ˜¯è¿è¡Œå‰ç¼–è¯‘çš„ï¼Œå¦‚æœå¸¦æœ‰å¼•ç”¨å…³ç³»çš„å¯¹è±¡å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå—å½±å“çš„å­˜å‚¨è¿‡ç¨‹ã€åŒ…å°†éœ€è¦é‡æ–°ç¼–è¯‘ï¼ˆä¸è¿‡ä¹Ÿå¯ä»¥è®¾ç½®æˆè¿è¡Œæ—¶åˆ»è‡ªåŠ¨ç¼–è¯‘ï¼‰ã€‚ 4ï¼‰å¦‚æœåœ¨ä¸€ä¸ªç¨‹åºç³»ç»Ÿä¸­å¤§é‡çš„ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œåˆ°ç¨‹åºäº¤ä»˜ä½¿ç”¨çš„æ—¶å€™éšç€ç”¨æˆ·éœ€æ±‚çš„å¢åŠ ä¼šå¯¼è‡´æ•°æ®ç»“æ„çš„å˜åŒ–ï¼Œæ¥ç€å°±æ˜¯ç³»ç»Ÿçš„ç›¸å…³é—®é¢˜äº†ï¼Œæœ€åå¦‚æœç”¨æˆ·æƒ³ç»´æŠ¤è¯¥ç³»ç»Ÿå¯ä»¥è¯´æ˜¯å¾ˆéš¾å¾ˆéš¾ã€è€Œä¸”ä»£ä»·æ˜¯ç©ºå‰çš„ï¼Œç»´æŠ¤èµ·æ¥æ›´éº»çƒ¦ã€‚ ","date":"2022-04-26","objectID":"/mysql/:25:1","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"è§¦å‘å™¨ ","date":"2022-04-26","objectID":"/mysql/:26:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯è§¦å‘å™¨ï¼Ÿè§¦å‘å™¨çš„ä½¿ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ è§¦å‘å™¨æ˜¯ç”¨æˆ·å®šä¹‰åœ¨å…³ç³»è¡¨ä¸Šçš„ä¸€ç±»ç”±äº‹ä»¶é©±åŠ¨çš„ç‰¹æ®Šçš„å­˜å‚¨è¿‡ç¨‹ã€‚è§¦å‘å™¨æ˜¯æŒ‡ä¸€æ®µä»£ç ï¼Œå½“è§¦å‘æŸä¸ªäº‹ä»¶æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œè¿™äº›ä»£ç ã€‚ ä½¿ç”¨åœºæ™¯ å¯ä»¥é€šè¿‡æ•°æ®åº“ä¸­çš„ç›¸å…³è¡¨å®ç°çº§è”æ›´æ”¹ã€‚ å®æ—¶ç›‘æ§æŸå¼ è¡¨ä¸­çš„æŸä¸ªå­—æ®µçš„æ›´æ”¹è€Œéœ€è¦åšå‡ºç›¸åº”çš„å¤„ç†ã€‚ ä¾‹å¦‚å¯ä»¥ç”ŸæˆæŸäº›ä¸šåŠ¡çš„ç¼–å·ã€‚ æ³¨æ„ä¸è¦æ»¥ç”¨ï¼Œå¦åˆ™ä¼šé€ æˆæ•°æ®åº“åŠåº”ç”¨ç¨‹åºçš„ç»´æŠ¤å›°éš¾ã€‚ å¤§å®¶éœ€è¦ç‰¢è®°ä»¥ä¸ŠåŸºç¡€çŸ¥è¯†ç‚¹ï¼Œé‡ç‚¹æ˜¯ç†è§£æ•°æ®ç±»å‹CHARå’ŒVARCHARçš„å·®å¼‚ï¼Œè¡¨å­˜å‚¨å¼•æ“InnoDBå’ŒMyISAMçš„åŒºåˆ«ã€‚ ","date":"2022-04-26","objectID":"/mysql/:26:1","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"MySQLä¸­éƒ½æœ‰å“ªäº›è§¦å‘å™¨ï¼Ÿ åœ¨MySQLæ•°æ®åº“ä¸­æœ‰å¦‚ä¸‹å…­ç§è§¦å‘å™¨ï¼š Before Insert After Insert Before Update After Update Before Delete After Delete ","date":"2022-04-26","objectID":"/mysql/:26:2","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å¸¸ç”¨SQLè¯­å¥ ","date":"2022-04-26","objectID":"/mysql/:27:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"SQLè¯­å¥ä¸»è¦åˆ†ä¸ºå“ªå‡ ç±» æ•°æ®å®šä¹‰è¯­è¨€DDLï¼ˆData Ddefinition Languageï¼‰CREATEï¼ŒDROPï¼ŒALTER ä¸»è¦ä¸ºä»¥ä¸Šæ“ä½œ å³å¯¹é€»è¾‘ç»“æ„ç­‰æœ‰æ“ä½œçš„ï¼Œå…¶ä¸­åŒ…æ‹¬è¡¨ç»“æ„ï¼Œè§†å›¾å’Œç´¢å¼•ã€‚ æ•°æ®æŸ¥è¯¢è¯­è¨€DQLï¼ˆData Query Languageï¼‰SELECT è¿™ä¸ªè¾ƒä¸ºå¥½ç†è§£ å³æŸ¥è¯¢æ“ä½œï¼Œä»¥selectå…³é”®å­—ã€‚å„ç§ç®€å•æŸ¥è¯¢ï¼Œè¿æ¥æŸ¥è¯¢ç­‰ éƒ½å±äºDQLã€‚ æ•°æ®æ“çºµè¯­è¨€DMLï¼ˆData Manipulation Languageï¼‰INSERTï¼ŒUPDATEï¼ŒDELETE ä¸»è¦ä¸ºä»¥ä¸Šæ“ä½œ å³å¯¹æ•°æ®è¿›è¡Œæ“ä½œçš„ï¼Œå¯¹åº”ä¸Šé¢æ‰€è¯´çš„æŸ¥è¯¢æ“ä½œ DQLä¸DMLå…±åŒæ„å»ºäº†å¤šæ•°åˆçº§ç¨‹åºå‘˜å¸¸ç”¨çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚è€ŒæŸ¥è¯¢æ˜¯è¾ƒä¸ºç‰¹æ®Šçš„ä¸€ç§ è¢«åˆ’åˆ†åˆ°DQLä¸­ã€‚ æ•°æ®æ§åˆ¶åŠŸèƒ½DCLï¼ˆData Control Languageï¼‰GRANTï¼ŒREVOKEï¼ŒCOMMITï¼ŒROLLBACK ä¸»è¦ä¸ºä»¥ä¸Šæ“ä½œ å³å¯¹æ•°æ®åº“å®‰å…¨æ€§å®Œæ•´æ€§ç­‰æœ‰æ“ä½œçš„ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ä¸ºæƒé™æ§åˆ¶ç­‰ã€‚ ","date":"2022-04-26","objectID":"/mysql/:27:1","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"è¶…é”®ã€å€™é€‰é”®ã€ä¸»é”®ã€å¤–é”®åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ è¶…é”®ï¼šåœ¨å…³ç³»ä¸­èƒ½å”¯ä¸€æ ‡è¯†å…ƒç»„çš„å±æ€§é›†ç§°ä¸ºå…³ç³»æ¨¡å¼çš„è¶…é”®ã€‚ä¸€ä¸ªå±æ€§å¯ä»¥ä¸ºä½œä¸ºä¸€ä¸ªè¶…é”®ï¼Œå¤šä¸ªå±æ€§ç»„åˆåœ¨ä¸€èµ·ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªè¶…é”®ã€‚è¶…é”®åŒ…å«å€™é€‰é”®å’Œä¸»é”®ã€‚ å€™é€‰é”®ï¼šæ˜¯æœ€å°è¶…é”®ï¼Œå³æ²¡æœ‰å†—ä½™å…ƒç´ çš„è¶…é”®ã€‚ ä¸»é”®ï¼šæ•°æ®åº“è¡¨ä¸­å¯¹å‚¨å­˜æ•°æ®å¯¹è±¡äºˆä»¥å”¯ä¸€å’Œå®Œæ•´æ ‡è¯†çš„æ•°æ®åˆ—æˆ–å±æ€§çš„ç»„åˆã€‚ä¸€ä¸ªæ•°æ®åˆ—åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ï¼Œä¸”ä¸»é”®çš„å–å€¼ä¸èƒ½ç¼ºå¤±ï¼Œå³ä¸èƒ½ä¸ºç©ºå€¼ï¼ˆNullï¼‰ã€‚ å¤–é”®ï¼šåœ¨ä¸€ä¸ªè¡¨ä¸­å­˜åœ¨çš„å¦ä¸€ä¸ªè¡¨çš„ä¸»é”®ç§°æ­¤è¡¨çš„å¤–é”®ã€‚ ","date":"2022-04-26","objectID":"/mysql/:27:2","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"SQL çº¦æŸæœ‰å“ªå‡ ç§ï¼Ÿ SQL çº¦æŸæœ‰å“ªå‡ ç§ï¼Ÿ NOT NULL: ç”¨äºæ§åˆ¶å­—æ®µçš„å†…å®¹ä¸€å®šä¸èƒ½ä¸ºç©ºï¼ˆNULLï¼‰ã€‚ UNIQUE: æ§ä»¶å­—æ®µå†…å®¹ä¸èƒ½é‡å¤ï¼Œä¸€ä¸ªè¡¨å…è®¸æœ‰å¤šä¸ª Unique çº¦æŸã€‚ PRIMARY KEY: ä¹Ÿæ˜¯ç”¨äºæ§ä»¶å­—æ®µå†…å®¹ä¸èƒ½é‡å¤ï¼Œä½†å®ƒåœ¨ä¸€ä¸ªè¡¨åªå…è®¸å‡ºç°ä¸€ä¸ªã€‚ FOREIGN KEY: ç”¨äºé¢„é˜²ç ´åè¡¨ä¹‹é—´è¿æ¥çš„åŠ¨ä½œï¼Œä¹Ÿèƒ½é˜²æ­¢éæ³•æ•°æ®æ’å…¥å¤–é”®åˆ—ï¼Œå› ä¸ºå®ƒå¿…é¡»æ˜¯å®ƒæŒ‡å‘çš„é‚£ä¸ªè¡¨ä¸­çš„å€¼ä¹‹ä¸€ã€‚ CHECK: ç”¨äºæ§åˆ¶å­—æ®µçš„å€¼èŒƒå›´ã€‚ ","date":"2022-04-26","objectID":"/mysql/:27:3","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å…­ç§å…³è”æŸ¥è¯¢ äº¤å‰è¿æ¥ï¼ˆCROSS JOINï¼‰ å†…è¿æ¥ï¼ˆINNER JOINï¼‰ å¤–è¿æ¥ï¼ˆLEFT JOIN/RIGHT JOINï¼‰ è”åˆæŸ¥è¯¢ï¼ˆUNIONä¸UNION ALLï¼‰ å…¨è¿æ¥ï¼ˆFULL JOINï¼‰ äº¤å‰è¿æ¥ï¼ˆCROSS JOINï¼‰ SELECT * FROM A,B(,C)æˆ–è€…SELECT * FROM A CROSS JOIN B (CROSS JOIN C)#æ²¡æœ‰ä»»ä½•å…³è”æ¡ä»¶ï¼Œç»“æœæ˜¯ç¬›å¡å°”ç§¯ï¼Œç»“æœé›†ä¼šå¾ˆå¤§ï¼Œæ²¡æœ‰æ„ä¹‰ï¼Œå¾ˆå°‘ä½¿ç”¨å†…è¿æ¥ï¼ˆINNER JOINï¼‰SELECT * FROM A,B WHERE A.id=B.idæˆ–è€…SELECT * FROM A INNER JOIN B ON A.id=B.idå¤šè¡¨ä¸­åŒæ—¶ç¬¦åˆæŸç§æ¡ä»¶çš„æ•°æ®è®°å½•çš„é›†åˆï¼ŒINNER JOINå¯ä»¥ç¼©å†™ä¸ºJOIN 1 å†…è¿æ¥åˆ†ä¸ºä¸‰ç±» ç­‰å€¼è¿æ¥ï¼šON A.id=B.id ä¸ç­‰å€¼è¿æ¥ï¼šON A.id \u003e B.id è‡ªè¿æ¥ï¼šSELECT * FROM A T1 INNER JOIN A T2 ON T1.id=T2.pid å¤–è¿æ¥ï¼ˆLEFT JOIN/RIGHT JOINï¼‰ å·¦å¤–è¿æ¥ï¼šLEFT OUTER JOIN, ä»¥å·¦è¡¨ä¸ºä¸»ï¼Œå…ˆæŸ¥è¯¢å‡ºå·¦è¡¨ï¼ŒæŒ‰ç…§ONåçš„å…³è”æ¡ä»¶åŒ¹é…å³è¡¨ï¼Œæ²¡æœ‰åŒ¹é…åˆ°çš„ç”¨NULLå¡«å……ï¼Œå¯ä»¥ç®€å†™æˆLEFT JOIN å³å¤–è¿æ¥ï¼šRIGHT OUTER JOIN, ä»¥å³è¡¨ä¸ºä¸»ï¼Œå…ˆæŸ¥è¯¢å‡ºå³è¡¨ï¼ŒæŒ‰ç…§ONåçš„å…³è”æ¡ä»¶åŒ¹é…å·¦è¡¨ï¼Œæ²¡æœ‰åŒ¹é…åˆ°çš„ç”¨NULLå¡«å……ï¼Œå¯ä»¥ç®€å†™æˆRIGHT JOIN è”åˆæŸ¥è¯¢ï¼ˆUNIONä¸UNION ALLï¼‰ SELECT * FROM A UNION SELECT * FROM B UNION ... 1 å°±æ˜¯æŠŠå¤šä¸ªç»“æœé›†é›†ä¸­åœ¨ä¸€èµ·ï¼ŒUNIONå‰çš„ç»“æœä¸ºåŸºå‡†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è”åˆæŸ¥è¯¢çš„åˆ—æ•°è¦ç›¸ç­‰ï¼Œç›¸åŒçš„è®°å½•è¡Œä¼šåˆå¹¶ å¦‚æœä½¿ç”¨UNION ALLï¼Œä¸ä¼šåˆå¹¶é‡å¤çš„è®°å½•è¡Œ æ•ˆç‡ UNION é«˜äº UNION ALL å…¨è¿æ¥ï¼ˆFULL JOINï¼‰ MySQLä¸æ”¯æŒå…¨è¿æ¥ å¯ä»¥ä½¿ç”¨LEFT JOIN å’ŒUNIONå’ŒRIGHT JOINè”åˆä½¿ç”¨ SELECT * FROM A LEFT JOIN B ON A.id=B.id UNIONSELECT * FROM A RIGHT JOIN B ON A.id=B.id 1 è¡¨è¿æ¥é¢è¯•é¢˜ æœ‰2å¼ è¡¨ï¼Œ1å¼ Rã€1å¼ Sï¼ŒRè¡¨æœ‰ABCä¸‰åˆ—ï¼ŒSè¡¨æœ‰CDä¸¤åˆ—ï¼Œè¡¨ä¸­å„æœ‰ä¸‰æ¡è®°å½•ã€‚ Rè¡¨ A B C a1 b1 c1 a2 b2 c2 a3 b3 c3 Sè¡¨ C D c1 d1 c2 d2 c4 d3 äº¤å‰è¿æ¥(ç¬›å¡å°”ç§¯): select r.*,s.* from r,s A B C C D a1 b1 c1 c1 d1 a2 b2 c2 c1 d1 a3 b3 c3 c1 d1 a1 b1 c1 c2 d2 a2 b2 c2 c2 d2 a3 b3 c3 c2 d2 a1 b1 c1 c4 d3 a2 b2 c2 c4 d3 a3 b3 c3 c4 d3 å†…è¿æ¥ç»“æœï¼š select r.*,s.* from r inner join s on r.c=s.c A B C C D a1 b1 c1 c1 d1 a2 b2 c2 c2 d2 å·¦è¿æ¥ç»“æœï¼š select r.*,s.* from r left join s on r.c=s.c A B C C D a1 b1 c1 c1 d1 a2 b2 c2 c2 d2 a3 b3 c3 å³è¿æ¥ç»“æœï¼š select r.*,s.* from r right join s on r.c=s.c A B C C D a1 b1 c1 c1 d1 a2 b2 c2 c2 d2 c4 d3 å…¨è¡¨è¿æ¥çš„ç»“æœï¼ˆMySqlä¸æ”¯æŒï¼ŒOracleæ”¯æŒï¼‰ï¼š select r.*,s.* from r full join s on r.c=s.c A B C C D a1 b1 c1 c1 d1 a2 b2 c2 c2 d2 a3 b3 c3 c4 d3 ","date":"2022-04-26","objectID":"/mysql/:27:4","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä»€ä¹ˆæ˜¯å­æŸ¥è¯¢ æ¡ä»¶ï¼šä¸€æ¡SQLè¯­å¥çš„æŸ¥è¯¢ç»“æœåšä¸ºå¦ä¸€æ¡æŸ¥è¯¢è¯­å¥çš„æ¡ä»¶æˆ–æŸ¥è¯¢ç»“æœ åµŒå¥—ï¼šå¤šæ¡SQLè¯­å¥åµŒå¥—ä½¿ç”¨ï¼Œå†…éƒ¨çš„SQLæŸ¥è¯¢è¯­å¥ç§°ä¸ºå­æŸ¥è¯¢ã€‚ ","date":"2022-04-26","objectID":"/mysql/:27:5","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å­æŸ¥è¯¢çš„ä¸‰ç§æƒ…å†µ å­æŸ¥è¯¢æ˜¯å•è¡Œå•åˆ—çš„æƒ…å†µï¼šç»“æœé›†æ˜¯ä¸€ä¸ªå€¼ï¼Œçˆ¶æŸ¥è¯¢ä½¿ç”¨ï¼š=ã€ \u003cã€ \u003e ç­‰è¿ç®—ç¬¦ -- æŸ¥è¯¢å·¥èµ„æœ€é«˜çš„å‘˜å·¥æ˜¯è°ï¼Ÿ select*fromemployeewheresalary=(selectmax(salary)fromemployee);12 å­æŸ¥è¯¢æ˜¯å¤šè¡Œå•åˆ—çš„æƒ…å†µï¼šç»“æœé›†ç±»ä¼¼äºä¸€ä¸ªæ•°ç»„ï¼Œçˆ¶æŸ¥è¯¢ä½¿ç”¨ï¼šin è¿ç®—ç¬¦ -- æŸ¥è¯¢å·¥èµ„æœ€é«˜çš„å‘˜å·¥æ˜¯è°ï¼Ÿ select*fromemployeewheresalary=(selectmax(salary)fromemployee);12 å­æŸ¥è¯¢æ˜¯å¤šè¡Œå¤šåˆ—çš„æƒ…å†µï¼šç»“æœé›†ç±»ä¼¼äºä¸€å¼ è™šæ‹Ÿè¡¨ï¼Œä¸èƒ½ç”¨äºwhereæ¡ä»¶ï¼Œç”¨äºselectå­å¥ä¸­åšä¸ºå­è¡¨ -- 1) æŸ¥è¯¢å‡º2011å¹´ä»¥åå…¥èŒçš„å‘˜å·¥ä¿¡æ¯ -- 2) æŸ¥è¯¢æ‰€æœ‰çš„éƒ¨é—¨ä¿¡æ¯ï¼Œä¸ä¸Šé¢çš„è™šæ‹Ÿè¡¨ä¸­çš„ä¿¡æ¯æ¯”å¯¹ï¼Œæ‰¾å‡ºæ‰€æœ‰éƒ¨é—¨IDç›¸ç­‰çš„å‘˜å·¥ã€‚ select*fromdeptd,(select*fromemployeewherejoin_date\u003e'2011-1-1')ewheree.dept_id=d.id;-- ä½¿ç”¨è¡¨è¿æ¥ï¼š selectd.*,e.*fromdeptdinnerjoinemployeeeond.id=e.dept_idwheree.join_date\u003e'2011-1-1'123456 ","date":"2022-04-26","objectID":"/mysql/:27:6","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"mysqlä¸­ in å’Œ exists åŒºåˆ« mysqlä¸­çš„inè¯­å¥æ˜¯æŠŠå¤–è¡¨å’Œå†…è¡¨ä½œhash è¿æ¥ï¼Œè€Œexistsè¯­å¥æ˜¯å¯¹å¤–è¡¨ä½œloopå¾ªç¯ï¼Œæ¯æ¬¡loopå¾ªç¯å†å¯¹å†…è¡¨è¿›è¡ŒæŸ¥è¯¢ã€‚ä¸€ç›´å¤§å®¶éƒ½è®¤ä¸ºexistsæ¯”inè¯­å¥çš„æ•ˆç‡è¦é«˜ï¼Œè¿™ç§è¯´æ³•å…¶å®æ˜¯ä¸å‡†ç¡®çš„ã€‚è¿™ä¸ªæ˜¯è¦åŒºåˆ†ç¯å¢ƒçš„ã€‚ å¦‚æœæŸ¥è¯¢çš„ä¸¤ä¸ªè¡¨å¤§å°ç›¸å½“ï¼Œé‚£ä¹ˆç”¨inå’Œexistså·®åˆ«ä¸å¤§ã€‚ å¦‚æœä¸¤ä¸ªè¡¨ä¸­ä¸€ä¸ªè¾ƒå°ï¼Œä¸€ä¸ªæ˜¯å¤§è¡¨ï¼Œåˆ™å­æŸ¥è¯¢è¡¨å¤§çš„ç”¨existsï¼Œå­æŸ¥è¯¢è¡¨å°çš„ç”¨inã€‚ not in å’Œnot existsï¼šå¦‚æœæŸ¥è¯¢è¯­å¥ä½¿ç”¨äº†not inï¼Œé‚£ä¹ˆå†…å¤–è¡¨éƒ½è¿›è¡Œå…¨è¡¨æ‰«æï¼Œæ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼›è€Œnot extstsçš„å­æŸ¥è¯¢ä¾ç„¶èƒ½ç”¨åˆ°è¡¨ä¸Šçš„ç´¢å¼•ã€‚æ‰€ä»¥æ— è®ºé‚£ä¸ªè¡¨å¤§ï¼Œç”¨not existséƒ½æ¯”not inè¦å¿«ã€‚ ","date":"2022-04-26","objectID":"/mysql/:27:7","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"varcharä¸charçš„åŒºåˆ« charçš„ç‰¹ç‚¹ charè¡¨ç¤ºå®šé•¿å­—ç¬¦ä¸²ï¼Œé•¿åº¦æ˜¯å›ºå®šçš„ï¼› å¦‚æœæ’å…¥æ•°æ®çš„é•¿åº¦å°äºcharçš„å›ºå®šé•¿åº¦æ—¶ï¼Œåˆ™ç”¨ç©ºæ ¼å¡«å……ï¼› å› ä¸ºé•¿åº¦å›ºå®šï¼Œæ‰€ä»¥å­˜å–é€Ÿåº¦è¦æ¯”varcharå¿«å¾ˆå¤šï¼Œç”šè‡³èƒ½å¿«50%ï¼Œä½†æ­£å› ä¸ºå…¶é•¿åº¦å›ºå®šï¼Œæ‰€ä»¥ä¼šå æ®å¤šä½™çš„ç©ºé—´ï¼Œæ˜¯ç©ºé—´æ¢æ—¶é—´çš„åšæ³•ï¼› å¯¹äºcharæ¥è¯´ï¼Œæœ€å¤šèƒ½å­˜æ”¾çš„å­—ç¬¦ä¸ªæ•°ä¸º255ï¼Œå’Œç¼–ç æ— å…³ varcharçš„ç‰¹ç‚¹ varcharè¡¨ç¤ºå¯å˜é•¿å­—ç¬¦ä¸²ï¼Œé•¿åº¦æ˜¯å¯å˜çš„ï¼› æ’å…¥çš„æ•°æ®æ˜¯å¤šé•¿ï¼Œå°±æŒ‰ç…§å¤šé•¿æ¥å­˜å‚¨ï¼› varcharåœ¨å­˜å–æ–¹é¢ä¸charç›¸åï¼Œå®ƒå­˜å–æ…¢ï¼Œå› ä¸ºé•¿åº¦ä¸å›ºå®šï¼Œä½†æ­£å› å¦‚æ­¤ï¼Œä¸å æ®å¤šä½™çš„ç©ºé—´ï¼Œæ˜¯æ—¶é—´æ¢ç©ºé—´çš„åšæ³•ï¼› å¯¹äºvarcharæ¥è¯´ï¼Œæœ€å¤šèƒ½å­˜æ”¾çš„å­—ç¬¦ä¸ªæ•°ä¸º65532 æ€»ä¹‹ï¼Œç»“åˆæ€§èƒ½è§’åº¦ï¼ˆcharæ›´å¿«ï¼‰å’ŒèŠ‚çœç£ç›˜ç©ºé—´è§’åº¦ï¼ˆvarcharæ›´å°ï¼‰ï¼Œå…·ä½“æƒ…å†µè¿˜éœ€å…·ä½“æ¥è®¾è®¡æ•°æ®åº“æ‰æ˜¯å¦¥å½“çš„åšæ³•ã€‚ ","date":"2022-04-26","objectID":"/mysql/:27:8","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"varchar(50)ä¸­50çš„æ¶µä¹‰ æœ€å¤šå­˜æ”¾50ä¸ªå­—ç¬¦ï¼Œvarchar(50)å’Œ(200)å­˜å‚¨helloæ‰€å ç©ºé—´ä¸€æ ·ï¼Œä½†åè€…åœ¨æ’åºæ—¶ä¼šæ¶ˆè€—æ›´å¤šå†…å­˜ï¼Œå› ä¸ºorder by colé‡‡ç”¨fixed_lengthè®¡ç®—colé•¿åº¦(memoryå¼•æ“ä¹Ÿä¸€æ ·)ã€‚åœ¨æ—©æœŸ MySQL ç‰ˆæœ¬ä¸­ï¼Œ 50 ä»£è¡¨å­—èŠ‚æ•°ï¼Œç°åœ¨ä»£è¡¨å­—ç¬¦æ•°ã€‚ ","date":"2022-04-26","objectID":"/mysql/:27:9","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"int(20)ä¸­20çš„æ¶µä¹‰ æ˜¯æŒ‡æ˜¾ç¤ºå­—ç¬¦çš„é•¿åº¦ã€‚20è¡¨ç¤ºæœ€å¤§æ˜¾ç¤ºå®½åº¦ä¸º20ï¼Œä½†ä»å 4å­—èŠ‚å­˜å‚¨ï¼Œå­˜å‚¨èŒƒå›´ä¸å˜ï¼› ä¸å½±å“å†…éƒ¨å­˜å‚¨ï¼Œåªæ˜¯å½±å“å¸¦ zerofill å®šä¹‰çš„ int æ—¶ï¼Œå‰é¢è¡¥å¤šå°‘ä¸ª 0ï¼Œæ˜“äºæŠ¥è¡¨å±•ç¤º ","date":"2022-04-26","objectID":"/mysql/:27:10","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"mysqlä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ å¯¹å¤§å¤šæ•°åº”ç”¨æ²¡æœ‰æ„ä¹‰ï¼Œåªæ˜¯è§„å®šä¸€äº›å·¥å…·ç”¨æ¥æ˜¾ç¤ºå­—ç¬¦çš„ä¸ªæ•°ï¼›int(1)å’Œint(20)å­˜å‚¨å’Œè®¡ç®—å‡ä¸€æ ·ï¼› ","date":"2022-04-26","objectID":"/mysql/:27:11","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"mysqlä¸­int(10)å’Œchar(10)ä»¥åŠvarchar(10)çš„åŒºåˆ« int(10)çš„10è¡¨ç¤ºæ˜¾ç¤ºçš„æ•°æ®çš„é•¿åº¦ï¼Œä¸æ˜¯å­˜å‚¨æ•°æ®çš„å¤§å°ï¼›chart(10)å’Œvarchar(10)çš„10è¡¨ç¤ºå­˜å‚¨æ•°æ®çš„å¤§å°ï¼Œå³è¡¨ç¤ºå­˜å‚¨å¤šå°‘ä¸ªå­—ç¬¦ã€‚ int(10) 10ä½çš„æ•°æ®é•¿åº¦ 9999999999ï¼Œå 32ä¸ªå­—èŠ‚ï¼Œintå‹4ä½ char(10) 10ä½å›ºå®šå­—ç¬¦ä¸²ï¼Œä¸è¶³è¡¥ç©ºæ ¼ æœ€å¤š10ä¸ªå­—ç¬¦ varchar(10) 10ä½å¯å˜å­—ç¬¦ä¸²ï¼Œä¸è¶³è¡¥ç©ºæ ¼ æœ€å¤š10ä¸ªå­—ç¬¦ char(10)è¡¨ç¤ºå­˜å‚¨å®šé•¿çš„10ä¸ªå­—ç¬¦ï¼Œä¸è¶³10ä¸ªå°±ç”¨ç©ºæ ¼è¡¥é½ï¼Œå ç”¨æ›´å¤šçš„å­˜å‚¨ç©ºé—´ varchar(10)è¡¨ç¤ºå­˜å‚¨10ä¸ªå˜é•¿çš„å­—ç¬¦ï¼Œå­˜å‚¨å¤šå°‘ä¸ªå°±æ˜¯å¤šå°‘ä¸ªï¼Œç©ºæ ¼ä¹ŸæŒ‰ä¸€ä¸ªå­—ç¬¦å­˜å‚¨ï¼Œè¿™ä¸€ç‚¹æ˜¯å’Œchar(10)çš„ç©ºæ ¼ä¸åŒçš„ï¼Œchar(10)çš„ç©ºæ ¼è¡¨ç¤ºå ä½ä¸ç®—ä¸€ä¸ªå­—ç¬¦ ","date":"2022-04-26","objectID":"/mysql/:27:12","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"FLOATå’ŒDOUBLEçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ FLOATç±»å‹æ•°æ®å¯ä»¥å­˜å‚¨è‡³å¤š8ä½åè¿›åˆ¶æ•°ï¼Œå¹¶åœ¨å†…å­˜ä¸­å 4å­—èŠ‚ã€‚ DOUBLEç±»å‹æ•°æ®å¯ä»¥å­˜å‚¨è‡³å¤š18ä½åè¿›åˆ¶æ•°ï¼Œå¹¶åœ¨å†…å­˜ä¸­å 8å­—èŠ‚ã€‚ ","date":"2022-04-26","objectID":"/mysql/:27:13","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"dropã€deleteä¸truncateçš„åŒºåˆ« ä¸‰è€…éƒ½è¡¨ç¤ºåˆ é™¤ï¼Œä½†æ˜¯ä¸‰è€…æœ‰ä¸€äº›å·®åˆ«ï¼š Delete Truncate Drop ç±»å‹ å±äºDML å±äºDDL å±äºDDL å›æ»š å¯å›æ»š ä¸å¯å›æ»š ä¸å¯å›æ»š åˆ é™¤å†…å®¹ è¡¨ç»“æ„è¿˜åœ¨ï¼Œåˆ é™¤è¡¨çš„å…¨éƒ¨æˆ–è€…ä¸€éƒ¨åˆ†æ•°æ®è¡Œ è¡¨ç»“æ„è¿˜åœ¨ï¼Œåˆ é™¤è¡¨ä¸­çš„æ‰€æœ‰æ•°æ® ä»æ•°æ®åº“ä¸­åˆ é™¤è¡¨ï¼Œæ‰€æœ‰çš„æ•°æ®è¡Œï¼Œç´¢å¼•å’Œæƒé™ä¹Ÿä¼šè¢«åˆ é™¤ åˆ é™¤é€Ÿåº¦ åˆ é™¤é€Ÿåº¦æ…¢ï¼Œéœ€è¦é€è¡Œåˆ é™¤ åˆ é™¤é€Ÿåº¦å¿« åˆ é™¤é€Ÿåº¦æœ€å¿« å› æ­¤ï¼Œåœ¨ä¸å†éœ€è¦ä¸€å¼ è¡¨çš„æ—¶å€™ï¼Œç”¨dropï¼›åœ¨æƒ³åˆ é™¤éƒ¨åˆ†æ•°æ®è¡Œæ—¶å€™ï¼Œç”¨deleteï¼›åœ¨ä¿ç•™è¡¨è€Œåˆ é™¤æ‰€æœ‰æ•°æ®çš„æ—¶å€™ç”¨truncateã€‚ ","date":"2022-04-26","objectID":"/mysql/:27:14","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"UNIONä¸UNION ALLçš„åŒºåˆ«ï¼Ÿ å¦‚æœä½¿ç”¨UNION ALLï¼Œä¸ä¼šåˆå¹¶é‡å¤çš„è®°å½•è¡Œ æ•ˆç‡ UNION é«˜äº UNION ALL ","date":"2022-04-26","objectID":"/mysql/:27:15","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"SQLä¼˜åŒ– ","date":"2022-04-26","objectID":"/mysql/:28:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å¦‚ä½•å®šä½åŠä¼˜åŒ–SQLè¯­å¥çš„æ€§èƒ½é—®é¢˜ï¼Ÿåˆ›å»ºçš„ç´¢å¼•æœ‰æ²¡æœ‰è¢«ä½¿ç”¨åˆ°?æˆ–è€…è¯´æ€ä¹ˆæ‰å¯ä»¥çŸ¥é“è¿™æ¡è¯­å¥è¿è¡Œå¾ˆæ…¢çš„åŸå› ï¼Ÿ å¯¹äºä½æ€§èƒ½çš„SQLè¯­å¥çš„å®šä½ï¼Œæœ€é‡è¦ä¹Ÿæ˜¯æœ€æœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨æ‰§è¡Œè®¡åˆ’ï¼ŒMySQLæä¾›äº†explainå‘½ä»¤æ¥æŸ¥çœ‹è¯­å¥çš„æ‰§è¡Œè®¡åˆ’ã€‚ æˆ‘ä»¬çŸ¥é“ï¼Œä¸ç®¡æ˜¯å“ªç§æ•°æ®åº“ï¼Œæˆ–è€…æ˜¯å“ªç§æ•°æ®åº“å¼•æ“ï¼Œåœ¨å¯¹ä¸€æ¡SQLè¯­å¥è¿›è¡Œæ‰§è¡Œçš„è¿‡ç¨‹ä¸­éƒ½ä¼šåšå¾ˆå¤šç›¸å…³çš„ä¼˜åŒ–ï¼Œå¯¹äºæŸ¥è¯¢è¯­å¥ï¼Œæœ€é‡è¦çš„ä¼˜åŒ–æ–¹å¼å°±æ˜¯ä½¿ç”¨ç´¢å¼•ã€‚ è€Œæ‰§è¡Œè®¡åˆ’ï¼Œå°±æ˜¯æ˜¾ç¤ºæ•°æ®åº“å¼•æ“å¯¹äºSQLè¯­å¥çš„æ‰§è¡Œçš„è¯¦ç»†æƒ…å†µï¼Œå…¶ä¸­åŒ…å«äº†æ˜¯å¦ä½¿ç”¨ç´¢å¼•ï¼Œä½¿ç”¨ä»€ä¹ˆç´¢å¼•ï¼Œä½¿ç”¨çš„ç´¢å¼•çš„ç›¸å…³ä¿¡æ¯ç­‰ã€‚ æ‰§è¡Œè®¡åˆ’åŒ…å«çš„ä¿¡æ¯ id æœ‰ä¸€ç»„æ•°å­—ç»„æˆã€‚è¡¨ç¤ºä¸€ä¸ªæŸ¥è¯¢ä¸­å„ä¸ªå­æŸ¥è¯¢çš„æ‰§è¡Œé¡ºåº; idç›¸åŒæ‰§è¡Œé¡ºåºç”±ä¸Šè‡³ä¸‹ã€‚ idä¸åŒï¼Œidå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆè¢«æ‰§è¡Œã€‚ idä¸ºnullæ—¶è¡¨ç¤ºä¸€ä¸ªç»“æœé›†ï¼Œä¸éœ€è¦ä½¿ç”¨å®ƒæŸ¥è¯¢ï¼Œå¸¸å‡ºç°åœ¨åŒ…å«unionç­‰æŸ¥è¯¢è¯­å¥ä¸­ã€‚ select_type æ¯ä¸ªå­æŸ¥è¯¢çš„æŸ¥è¯¢ç±»å‹ï¼Œä¸€äº›å¸¸è§çš„æŸ¥è¯¢ç±»å‹ã€‚ id select_type description 1 SIMPLE ä¸åŒ…å«ä»»ä½•å­æŸ¥è¯¢æˆ–unionç­‰æŸ¥è¯¢ 2 PRIMARY åŒ…å«å­æŸ¥è¯¢æœ€å¤–å±‚æŸ¥è¯¢å°±æ˜¾ç¤ºä¸º PRIMARY 3 SUBQUERY åœ¨selectæˆ– whereå­—å¥ä¸­åŒ…å«çš„æŸ¥è¯¢ 4 DERIVED fromå­—å¥ä¸­åŒ…å«çš„æŸ¥è¯¢ 5 UNION å‡ºç°åœ¨unionåçš„æŸ¥è¯¢è¯­å¥ä¸­ 6 UNION RESULT ä»UNIONä¸­è·å–ç»“æœé›†ï¼Œä¾‹å¦‚ä¸Šæ–‡çš„ç¬¬ä¸‰ä¸ªä¾‹å­ table æŸ¥è¯¢çš„æ•°æ®è¡¨ï¼Œå½“ä»è¡ç”Ÿè¡¨ä¸­æŸ¥æ•°æ®æ—¶ä¼šæ˜¾ç¤º x è¡¨ç¤ºå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’id partitions è¡¨åˆ†åŒºã€è¡¨åˆ›å»ºçš„æ—¶å€™å¯ä»¥æŒ‡å®šé€šè¿‡é‚£ä¸ªåˆ—è¿›è¡Œè¡¨åˆ†åŒºã€‚ ä¸¾ä¸ªä¾‹å­ï¼š createtabletmp(idintunsignednotnullAUTO_INCREMENT,namevarchar(255),PRIMARYKEY(id))engine=innodbpartitionbykey(id)partitions5;123456 type(éå¸¸é‡è¦ï¼Œå¯ä»¥çœ‹åˆ°æœ‰æ²¡æœ‰èµ°ç´¢å¼•) è®¿é—®ç±»å‹ ALL æ‰«æå…¨è¡¨æ•°æ® index éå†ç´¢å¼• range ç´¢å¼•èŒƒå›´æŸ¥æ‰¾ index_subquery åœ¨å­æŸ¥è¯¢ä¸­ä½¿ç”¨ ref unique_subquery åœ¨å­æŸ¥è¯¢ä¸­ä½¿ç”¨ eq_ref ref_or_null å¯¹Nullè¿›è¡Œç´¢å¼•çš„ä¼˜åŒ–çš„ ref fulltext ä½¿ç”¨å…¨æ–‡ç´¢å¼• ref ä½¿ç”¨éå”¯ä¸€ç´¢å¼•æŸ¥æ‰¾æ•°æ® eq_ref åœ¨joinæŸ¥è¯¢ä¸­ä½¿ç”¨PRIMARY KEYorUNIQUE NOT NULLç´¢å¼•å…³è”ã€‚ possible_keys å¯èƒ½ä½¿ç”¨çš„ç´¢å¼•ï¼Œæ³¨æ„ä¸ä¸€å®šä¼šä½¿ç”¨ã€‚æŸ¥è¯¢æ¶‰åŠåˆ°çš„å­—æ®µä¸Šè‹¥å­˜åœ¨ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•å°†è¢«åˆ—å‡ºæ¥ã€‚å½“è¯¥åˆ—ä¸º NULLæ—¶å°±è¦è€ƒè™‘å½“å‰çš„SQLæ˜¯å¦éœ€è¦ä¼˜åŒ–äº†ã€‚ key æ˜¾ç¤ºMySQLåœ¨æŸ¥è¯¢ä¸­å®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼Œè‹¥æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œæ˜¾ç¤ºä¸ºNULLã€‚ TIPS:æŸ¥è¯¢ä¸­è‹¥ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•(è¦†ç›–ç´¢å¼•ï¼šç´¢å¼•çš„æ•°æ®è¦†ç›–äº†éœ€è¦æŸ¥è¯¢çš„æ‰€æœ‰æ•°æ®)ï¼Œåˆ™è¯¥ç´¢å¼•ä»…å‡ºç°åœ¨keyåˆ—è¡¨ä¸­ key_length ç´¢å¼•é•¿åº¦ ref è¡¨ç¤ºä¸Šè¿°è¡¨çš„è¿æ¥åŒ¹é…æ¡ä»¶ï¼Œå³å“ªäº›åˆ—æˆ–å¸¸é‡è¢«ç”¨äºæŸ¥æ‰¾ç´¢å¼•åˆ—ä¸Šçš„å€¼ rows è¿”å›ä¼°ç®—çš„ç»“æœé›†æ•°ç›®ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå‡†ç¡®çš„å€¼ã€‚ extra çš„ä¿¡æ¯éå¸¸ä¸°å¯Œï¼Œå¸¸è§çš„æœ‰ï¼š Using index ä½¿ç”¨è¦†ç›–ç´¢å¼• Using where ä½¿ç”¨äº†ç”¨whereå­å¥æ¥è¿‡æ»¤ç»“æœé›† Using filesort ä½¿ç”¨æ–‡ä»¶æ’åºï¼Œä½¿ç”¨éç´¢å¼•åˆ—è¿›è¡Œæ’åºæ—¶å‡ºç°ï¼Œéå¸¸æ¶ˆè€—æ€§èƒ½ï¼Œå°½é‡ä¼˜åŒ–ã€‚ Using temporary ä½¿ç”¨äº†ä¸´æ—¶è¡¨ sqlä¼˜åŒ–çš„ç›®æ ‡å¯ä»¥å‚è€ƒé˜¿é‡Œå¼€å‘æ‰‹å†Œ ã€æ¨èã€‘SQLæ€§èƒ½ä¼˜åŒ–çš„ç›®æ ‡ï¼šè‡³å°‘è¦è¾¾åˆ° range çº§åˆ«ï¼Œè¦æ±‚æ˜¯refçº§åˆ«ï¼Œå¦‚æœå¯ä»¥æ˜¯constsæœ€å¥½ã€‚ è¯´æ˜ï¼š 1ï¼‰ consts å•è¡¨ä¸­æœ€å¤šåªæœ‰ä¸€ä¸ªåŒ¹é…è¡Œï¼ˆä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•ï¼‰ï¼Œåœ¨ä¼˜åŒ–é˜¶æ®µå³å¯è¯»å–åˆ°æ•°æ®ã€‚ 2ï¼‰ ref æŒ‡çš„æ˜¯ä½¿ç”¨æ™®é€šçš„ç´¢å¼•ï¼ˆnormal indexï¼‰ã€‚ 3ï¼‰ range å¯¹ç´¢å¼•è¿›è¡ŒèŒƒå›´æ£€ç´¢ã€‚ åä¾‹ï¼šexplainè¡¨çš„ç»“æœï¼Œtype=indexï¼Œç´¢å¼•ç‰©ç†æ–‡ä»¶å…¨æ‰«æï¼Œé€Ÿåº¦éå¸¸æ…¢ï¼Œè¿™ä¸ªindexçº§åˆ«æ¯”è¾ƒrangeè¿˜ä½ï¼Œä¸å…¨è¡¨æ‰«ææ˜¯å°å·«è§å¤§å·«ã€‚ 123456 ","date":"2022-04-26","objectID":"/mysql/:28:1","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"SQLçš„ç”Ÿå‘½å‘¨æœŸï¼Ÿ åº”ç”¨æœåŠ¡å™¨ä¸æ•°æ®åº“æœåŠ¡å™¨å»ºç«‹ä¸€ä¸ªè¿æ¥ æ•°æ®åº“è¿›ç¨‹æ‹¿åˆ°è¯·æ±‚sql è§£æå¹¶ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œæ‰§è¡Œ è¯»å–æ•°æ®åˆ°å†…å­˜å¹¶è¿›è¡Œé€»è¾‘å¤„ç† é€šè¿‡æ­¥éª¤ä¸€çš„è¿æ¥ï¼Œå‘é€ç»“æœåˆ°å®¢æˆ·ç«¯ å…³æ‰è¿æ¥ï¼Œé‡Šæ”¾èµ„æº ","date":"2022-04-26","objectID":"/mysql/:28:2","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å¤§è¡¨æ•°æ®æŸ¥è¯¢ï¼Œæ€ä¹ˆä¼˜åŒ– ä¼˜åŒ–shemaã€sqlè¯­å¥+ç´¢å¼•ï¼› ç¬¬äºŒåŠ ç¼“å­˜ï¼Œmemcached, redisï¼› ä¸»ä»å¤åˆ¶ï¼Œè¯»å†™åˆ†ç¦»ï¼› å‚ç›´æ‹†åˆ†ï¼Œæ ¹æ®ä½ æ¨¡å—çš„è€¦åˆåº¦ï¼Œå°†ä¸€ä¸ªå¤§çš„ç³»ç»Ÿåˆ†ä¸ºå¤šä¸ªå°çš„ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼› æ°´å¹³åˆ‡åˆ†ï¼Œé’ˆå¯¹æ•°æ®é‡å¤§çš„è¡¨ï¼Œè¿™ä¸€æ­¥æœ€éº»çƒ¦ï¼Œæœ€èƒ½è€ƒéªŒæŠ€æœ¯æ°´å¹³ï¼Œè¦é€‰æ‹©ä¸€ä¸ªåˆç†çš„sharding key, ä¸ºäº†æœ‰å¥½çš„æŸ¥è¯¢æ•ˆç‡ï¼Œè¡¨ç»“æ„ä¹Ÿè¦æ”¹åŠ¨ï¼Œåšä¸€å®šçš„å†—ä½™ï¼Œåº”ç”¨ä¹Ÿè¦æ”¹ï¼Œsqlä¸­å°½é‡å¸¦sharding keyï¼Œå°†æ•°æ®å®šä½åˆ°é™å®šçš„è¡¨ä¸Šå»æŸ¥ï¼Œè€Œä¸æ˜¯æ‰«æå…¨éƒ¨çš„è¡¨ï¼› ","date":"2022-04-26","objectID":"/mysql/:28:3","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"è¶…å¤§åˆ†é¡µæ€ä¹ˆå¤„ç†ï¼Ÿ è¶…å¤§çš„åˆ†é¡µä¸€èˆ¬ä»ä¸¤ä¸ªæ–¹å‘ä¸Šæ¥è§£å†³. æ•°æ®åº“å±‚é¢,è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸»è¦é›†ä¸­å…³æ³¨çš„(è™½ç„¶æ”¶æ•ˆæ²¡é‚£ä¹ˆå¤§),ç±»ä¼¼äºselect * from table where age \u003e 20 limit 1000000,10è¿™ç§æŸ¥è¯¢å…¶å®ä¹Ÿæ˜¯æœ‰å¯ä»¥ä¼˜åŒ–çš„ä½™åœ°çš„. è¿™æ¡è¯­å¥éœ€è¦load1000000æ•°æ®ç„¶ååŸºæœ¬ä¸Šå…¨éƒ¨ä¸¢å¼ƒ,åªå–10æ¡å½“ç„¶æ¯”è¾ƒæ…¢. å½“æ—¶æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸ºselect * from table where id in (select id from table where age \u003e 20 limit 1000000,10).è¿™æ ·è™½ç„¶ä¹Ÿloadäº†ä¸€ç™¾ä¸‡çš„æ•°æ®,ä½†æ˜¯ç”±äºç´¢å¼•è¦†ç›–,è¦æŸ¥è¯¢çš„æ‰€æœ‰å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­,æ‰€ä»¥é€Ÿåº¦ä¼šå¾ˆå¿«. åŒæ—¶å¦‚æœIDè¿ç»­çš„å¥½,æˆ‘ä»¬è¿˜å¯ä»¥select * from table where id \u003e 1000000 limit 10,æ•ˆç‡ä¹Ÿæ˜¯ä¸é”™çš„,ä¼˜åŒ–çš„å¯èƒ½æ€§æœ‰è®¸å¤šç§,ä½†æ˜¯æ ¸å¿ƒæ€æƒ³éƒ½ä¸€æ ·,å°±æ˜¯å‡å°‘loadçš„æ•°æ®. ä»éœ€æ±‚çš„è§’åº¦å‡å°‘è¿™ç§è¯·æ±‚â€¦ä¸»è¦æ˜¯ä¸åšç±»ä¼¼çš„éœ€æ±‚(ç›´æ¥è·³è½¬åˆ°å‡ ç™¾ä¸‡é¡µä¹‹åçš„å…·ä½“æŸä¸€é¡µ.åªå…è®¸é€é¡µæŸ¥çœ‹æˆ–è€…æŒ‰ç…§ç»™å®šçš„è·¯çº¿èµ°,è¿™æ ·å¯é¢„æµ‹,å¯ç¼“å­˜)ä»¥åŠé˜²æ­¢IDæ³„æ¼ä¸”è¿ç»­è¢«äººæ¶æ„æ”»å‡». è§£å†³è¶…å¤§åˆ†é¡µ,å…¶å®ä¸»è¦æ˜¯é ç¼“å­˜,å¯é¢„æµ‹æ€§çš„æå‰æŸ¥åˆ°å†…å®¹,ç¼“å­˜è‡³redisç­‰k-Væ•°æ®åº“ä¸­,ç›´æ¥è¿”å›å³å¯. åœ¨é˜¿é‡Œå·´å·´ã€ŠJavaå¼€å‘æ‰‹å†Œã€‹ä¸­,å¯¹è¶…å¤§åˆ†é¡µçš„è§£å†³åŠæ³•æ˜¯ç±»ä¼¼äºä¸Šé¢æåˆ°çš„ç¬¬ä¸€ç§. ã€æ¨èã€‘åˆ©ç”¨å»¶è¿Ÿå…³è”æˆ–è€…å­æŸ¥è¯¢ä¼˜åŒ–è¶…å¤šåˆ†é¡µåœºæ™¯ã€‚è¯´æ˜ï¼šMySQLå¹¶ä¸æ˜¯è·³è¿‡offsetè¡Œï¼Œè€Œæ˜¯å–offset+Nè¡Œï¼Œç„¶åè¿”å›æ”¾å¼ƒå‰offsetè¡Œï¼Œè¿”å›Nè¡Œï¼Œé‚£å½“offsetç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œæ•ˆç‡å°±éå¸¸çš„ä½ä¸‹ï¼Œè¦ä¹ˆæ§åˆ¶è¿”å›çš„æ€»é¡µæ•°ï¼Œè¦ä¹ˆå¯¹è¶…è¿‡ç‰¹å®šé˜ˆå€¼çš„é¡µæ•°è¿›è¡ŒSQLæ”¹å†™ã€‚æ­£ä¾‹ï¼šå…ˆå¿«é€Ÿå®šä½éœ€è¦è·å–çš„idæ®µï¼Œç„¶åå†å…³è”ï¼šSELECTa.*FROMè¡¨1a,(selectidfromè¡¨1whereæ¡ä»¶LIMIT100000,20)bwherea.id=b.id1234567 ","date":"2022-04-26","objectID":"/mysql/:28:4","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"mysql åˆ†é¡µ LIMIT å­å¥å¯ä»¥è¢«ç”¨äºå¼ºåˆ¶ SELECT è¯­å¥è¿”å›æŒ‡å®šçš„è®°å½•æ•°ã€‚LIMIT æ¥å—ä¸€ä¸ªæˆ–ä¸¤ä¸ªæ•°å­—å‚æ•°ã€‚å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªæ•´æ•°å¸¸é‡ã€‚å¦‚æœç»™å®šä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šç¬¬ä¸€ä¸ªè¿”å›è®°å½•è¡Œçš„åç§»é‡ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šè¿”å›è®°å½•è¡Œçš„æœ€å¤§æ•°ç›®ã€‚åˆå§‹è®°å½•è¡Œçš„åç§»é‡æ˜¯ 0(è€Œä¸æ˜¯ 1) mysql\u003e SELECT * FROM table LIMIT 5,10; // æ£€ç´¢è®°å½•è¡Œ 6-15 1 ä¸ºäº†æ£€ç´¢ä»æŸä¸€ä¸ªåç§»é‡åˆ°è®°å½•é›†çš„ç»“æŸæ‰€æœ‰çš„è®°å½•è¡Œï¼Œå¯ä»¥æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ä¸º -1ï¼š mysql\u003e SELECT * FROM table LIMIT 95,-1; // æ£€ç´¢è®°å½•è¡Œ 96-last. 1 å¦‚æœåªç»™å®šä¸€ä¸ªå‚æ•°ï¼Œå®ƒè¡¨ç¤ºè¿”å›æœ€å¤§çš„è®°å½•è¡Œæ•°ç›®ï¼š mysql\u003e SELECT * FROM table LIMIT 5; //æ£€ç´¢å‰ 5 ä¸ªè®°å½•è¡Œ 1 æ¢å¥è¯è¯´ï¼ŒLIMIT n ç­‰ä»·äº LIMIT 0,nã€‚ ","date":"2022-04-26","objectID":"/mysql/:28:5","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"æ…¢æŸ¥è¯¢æ—¥å¿— ç”¨äºè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡æŸä¸ªä¸´ç•Œå€¼çš„SQLæ—¥å¿—ï¼Œç”¨äºå¿«é€Ÿå®šä½æ…¢æŸ¥è¯¢ï¼Œä¸ºæˆ‘ä»¬çš„ä¼˜åŒ–åšå‚è€ƒã€‚ å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— é…ç½®é¡¹ï¼šslow_query_log å¯ä»¥ä½¿ç”¨show variables like â€˜slov_query_logâ€™æŸ¥çœ‹æ˜¯å¦å¼€å¯ï¼Œå¦‚æœçŠ¶æ€å€¼ä¸ºOFFï¼Œå¯ä»¥ä½¿ç”¨set GLOBAL slow_query_log = onæ¥å¼€å¯ï¼Œå®ƒä¼šåœ¨datadirä¸‹äº§ç”Ÿä¸€ä¸ªxxx-slow.logçš„æ–‡ä»¶ã€‚ è®¾ç½®ä¸´ç•Œæ—¶é—´ é…ç½®é¡¹ï¼šlong_query_time æŸ¥çœ‹ï¼šshow VARIABLES like 'long_query_time'ï¼Œå•ä½ç§’ è®¾ç½®ï¼šset long_query_time=0.5 å®æ“æ—¶åº”è¯¥ä»é•¿æ—¶é—´è®¾ç½®åˆ°çŸ­çš„æ—¶é—´ï¼Œå³å°†æœ€æ…¢çš„SQLä¼˜åŒ–æ‰ æŸ¥çœ‹æ—¥å¿—ï¼Œä¸€æ—¦SQLè¶…è¿‡äº†æˆ‘ä»¬è®¾ç½®çš„ä¸´ç•Œæ—¶é—´å°±ä¼šè¢«è®°å½•åˆ°xxx-slow.logä¸­ ","date":"2022-04-26","objectID":"/mysql/:28:6","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å…³å¿ƒè¿‡ä¸šåŠ¡ç³»ç»Ÿé‡Œé¢çš„sqlè€—æ—¶å—ï¼Ÿç»Ÿè®¡è¿‡æ…¢æŸ¥è¯¢å—ï¼Ÿå¯¹æ…¢æŸ¥è¯¢éƒ½æ€ä¹ˆä¼˜åŒ–è¿‡ï¼Ÿ åœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œé™¤äº†ä½¿ç”¨ä¸»é”®è¿›è¡Œçš„æŸ¥è¯¢ï¼Œå…¶ä»–çš„æˆ‘éƒ½ä¼šåœ¨æµ‹è¯•åº“ä¸Šæµ‹è¯•å…¶è€—æ—¶ï¼Œæ…¢æŸ¥è¯¢çš„ç»Ÿè®¡ä¸»è¦ç”±è¿ç»´åœ¨åšï¼Œä¼šå®šæœŸå°†ä¸šåŠ¡ä¸­çš„æ…¢æŸ¥è¯¢åé¦ˆç»™æˆ‘ä»¬ã€‚ æ…¢æŸ¥è¯¢çš„ä¼˜åŒ–é¦–å…ˆè¦ææ˜ç™½æ…¢çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ æ˜¯æŸ¥è¯¢æ¡ä»¶æ²¡æœ‰å‘½ä¸­ç´¢å¼•ï¼Ÿæ˜¯loadäº†ä¸éœ€è¦çš„æ•°æ®åˆ—ï¼Ÿè¿˜æ˜¯æ•°æ®é‡å¤ªå¤§ï¼Ÿ æ‰€ä»¥ä¼˜åŒ–ä¹Ÿæ˜¯é’ˆå¯¹è¿™ä¸‰ä¸ªæ–¹å‘æ¥çš„ï¼Œ é¦–å…ˆåˆ†æè¯­å¥ï¼Œçœ‹çœ‹æ˜¯å¦loadäº†é¢å¤–çš„æ•°æ®ï¼Œå¯èƒ½æ˜¯æŸ¥è¯¢äº†å¤šä½™çš„è¡Œå¹¶ä¸”æŠ›å¼ƒæ‰äº†ï¼Œå¯èƒ½æ˜¯åŠ è½½äº†è®¸å¤šç»“æœä¸­å¹¶ä¸éœ€è¦çš„åˆ—ï¼Œå¯¹è¯­å¥è¿›è¡Œåˆ†æä»¥åŠé‡å†™ã€‚ åˆ†æè¯­å¥çš„æ‰§è¡Œè®¡åˆ’ï¼Œç„¶åè·å¾—å…¶ä½¿ç”¨ç´¢å¼•çš„æƒ…å†µï¼Œä¹‹åä¿®æ”¹è¯­å¥æˆ–è€…ä¿®æ”¹ç´¢å¼•ï¼Œä½¿å¾—è¯­å¥å¯ä»¥å°½å¯èƒ½çš„å‘½ä¸­ç´¢å¼•ã€‚ å¦‚æœå¯¹è¯­å¥çš„ä¼˜åŒ–å·²ç»æ— æ³•è¿›è¡Œï¼Œå¯ä»¥è€ƒè™‘è¡¨ä¸­çš„æ•°æ®é‡æ˜¯å¦å¤ªå¤§ï¼Œå¦‚æœæ˜¯çš„è¯å¯ä»¥è¿›è¡Œæ¨ªå‘æˆ–è€…çºµå‘çš„åˆ†è¡¨ã€‚ ","date":"2022-04-26","objectID":"/mysql/:28:7","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¸ºä»€ä¹ˆè¦å°½é‡è®¾å®šä¸€ä¸ªä¸»é”®ï¼Ÿ ä¸»é”®æ˜¯æ•°æ®åº“ç¡®ä¿æ•°æ®è¡Œåœ¨æ•´å¼ è¡¨å”¯ä¸€æ€§çš„ä¿éšœï¼Œå³ä½¿ä¸šåŠ¡ä¸Šæœ¬å¼ è¡¨æ²¡æœ‰ä¸»é”®ï¼Œä¹Ÿå»ºè®®æ·»åŠ ä¸€ä¸ªè‡ªå¢é•¿çš„IDåˆ—ä½œä¸ºä¸»é”®ã€‚è®¾å®šäº†ä¸»é”®ä¹‹åï¼Œåœ¨åç»­çš„åˆ æ”¹æŸ¥çš„æ—¶å€™å¯èƒ½æ›´åŠ å¿«é€Ÿä»¥åŠç¡®ä¿æ“ä½œæ•°æ®èŒƒå›´å®‰å…¨ã€‚ ","date":"2022-04-26","objectID":"/mysql/:28:8","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¸»é”®ä½¿ç”¨è‡ªå¢IDè¿˜æ˜¯UUIDï¼Ÿ æ¨èä½¿ç”¨è‡ªå¢IDï¼Œä¸è¦ä½¿ç”¨UUIDã€‚ å› ä¸ºåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œä¸»é”®ç´¢å¼•æ˜¯ä½œä¸ºèšç°‡ç´¢å¼•å­˜åœ¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸»é”®ç´¢å¼•çš„B+æ ‘å¶å­èŠ‚ç‚¹ä¸Šå­˜å‚¨äº†ä¸»é”®ç´¢å¼•ä»¥åŠå…¨éƒ¨çš„æ•°æ®(æŒ‰ç…§é¡ºåº)ï¼Œå¦‚æœä¸»é”®ç´¢å¼•æ˜¯è‡ªå¢IDï¼Œé‚£ä¹ˆåªéœ€è¦ä¸æ–­å‘åæ’åˆ—å³å¯ï¼Œå¦‚æœæ˜¯UUIDï¼Œç”±äºåˆ°æ¥çš„IDä¸åŸæ¥çš„å¤§å°ä¸ç¡®å®šï¼Œä¼šé€ æˆéå¸¸å¤šçš„æ•°æ®æ’å…¥ï¼Œæ•°æ®ç§»åŠ¨ï¼Œç„¶åå¯¼è‡´äº§ç”Ÿå¾ˆå¤šçš„å†…å­˜ç¢ç‰‡ï¼Œè¿›è€Œé€ æˆæ’å…¥æ€§èƒ½çš„ä¸‹é™ã€‚ æ€»ä¹‹ï¼Œåœ¨æ•°æ®é‡å¤§ä¸€äº›çš„æƒ…å†µä¸‹ï¼Œç”¨è‡ªå¢ä¸»é”®æ€§èƒ½ä¼šå¥½ä¸€äº›ã€‚ å…³äºä¸»é”®æ˜¯èšç°‡ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰ä¸»é”®ï¼ŒInnoDBä¼šé€‰æ‹©ä¸€ä¸ªå”¯ä¸€é”®æ¥ä½œä¸ºèšç°‡ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰å”¯ä¸€é”®ï¼Œä¼šç”Ÿæˆä¸€ä¸ªéšå¼çš„ä¸»é”®ã€‚ ","date":"2022-04-26","objectID":"/mysql/:28:9","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å­—æ®µä¸ºä»€ä¹ˆè¦æ±‚å®šä¹‰ä¸ºnot nullï¼Ÿ nullå€¼ä¼šå ç”¨æ›´å¤šçš„å­—èŠ‚ï¼Œä¸”ä¼šåœ¨ç¨‹åºä¸­é€ æˆå¾ˆå¤šä¸é¢„æœŸä¸ç¬¦çš„æƒ…å†µã€‚ ","date":"2022-04-26","objectID":"/mysql/:28:10","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å¦‚æœè¦å­˜å‚¨ç”¨æˆ·çš„å¯†ç æ•£åˆ—ï¼Œåº”è¯¥ä½¿ç”¨ä»€ä¹ˆå­—æ®µè¿›è¡Œå­˜å‚¨ï¼Ÿ å¯†ç æ•£åˆ—ï¼Œç›ï¼Œç”¨æˆ·èº«ä»½è¯å·ç­‰å›ºå®šé•¿åº¦çš„å­—ç¬¦ä¸²åº”è¯¥ä½¿ç”¨charè€Œä¸æ˜¯varcharæ¥å­˜å‚¨ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœç©ºé—´ä¸”æé«˜æ£€ç´¢æ•ˆç‡ã€‚ ","date":"2022-04-26","objectID":"/mysql/:28:11","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¼˜åŒ–æŸ¥è¯¢è¿‡ç¨‹ä¸­çš„æ•°æ®è®¿é—® è®¿é—®æ•°æ®å¤ªå¤šå¯¼è‡´æŸ¥è¯¢æ€§èƒ½ä¸‹é™ ç¡®å®šåº”ç”¨ç¨‹åºæ˜¯å¦åœ¨æ£€ç´¢å¤§é‡è¶…è¿‡éœ€è¦çš„æ•°æ®ï¼Œå¯èƒ½æ˜¯å¤ªå¤šè¡Œæˆ–åˆ— ç¡®è®¤MySQLæœåŠ¡å™¨æ˜¯å¦åœ¨åˆ†æå¤§é‡ä¸å¿…è¦çš„æ•°æ®è¡Œ é¿å…çŠ¯å¦‚ä¸‹SQLè¯­å¥é”™è¯¯ æŸ¥è¯¢ä¸éœ€è¦çš„æ•°æ®ã€‚è§£å†³åŠæ³•ï¼šä½¿ç”¨limitè§£å†³ å¤šè¡¨å…³è”è¿”å›å…¨éƒ¨åˆ—ã€‚è§£å†³åŠæ³•ï¼šæŒ‡å®šåˆ—å æ€»æ˜¯è¿”å›å…¨éƒ¨åˆ—ã€‚è§£å†³åŠæ³•ï¼šé¿å…ä½¿ç”¨SELECT * é‡å¤æŸ¥è¯¢ç›¸åŒçš„æ•°æ®ã€‚è§£å†³åŠæ³•ï¼šå¯ä»¥ç¼“å­˜æ•°æ®ï¼Œä¸‹æ¬¡ç›´æ¥è¯»å–ç¼“å­˜ æ˜¯å¦åœ¨æ‰«æé¢å¤–çš„è®°å½•ã€‚è§£å†³åŠæ³•ï¼š ä½¿ç”¨explainè¿›è¡Œåˆ†æï¼Œå¦‚æœå‘ç°æŸ¥è¯¢éœ€è¦æ‰«æå¤§é‡çš„æ•°æ®ï¼Œä½†åªè¿”å›å°‘æ•°çš„è¡Œï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æŠ€å·§å»ä¼˜åŒ–ï¼š ä½¿ç”¨ç´¢å¼•è¦†ç›–æ‰«æï¼ŒæŠŠæ‰€æœ‰çš„åˆ—éƒ½æ”¾åˆ°ç´¢å¼•ä¸­ï¼Œè¿™æ ·å­˜å‚¨å¼•æ“ä¸éœ€è¦å›è¡¨è·å–å¯¹åº”è¡Œå°±å¯ä»¥è¿”å›ç»“æœã€‚ æ”¹å˜æ•°æ®åº“å’Œè¡¨çš„ç»“æ„ï¼Œä¿®æ”¹æ•°æ®è¡¨èŒƒå¼ é‡å†™SQLè¯­å¥ï¼Œè®©ä¼˜åŒ–å™¨å¯ä»¥ä»¥æ›´ä¼˜çš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ã€‚ ","date":"2022-04-26","objectID":"/mysql/:28:12","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¼˜åŒ–é•¿éš¾çš„æŸ¥è¯¢è¯­å¥ ä¸€ä¸ªå¤æ‚æŸ¥è¯¢è¿˜æ˜¯å¤šä¸ªç®€å•æŸ¥è¯¢ MySQLå†…éƒ¨æ¯ç§’èƒ½æ‰«æå†…å­˜ä¸­ä¸Šç™¾ä¸‡è¡Œæ•°æ®ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œå“åº”æ•°æ®ç»™å®¢æˆ·ç«¯å°±è¦æ…¢å¾—å¤š ä½¿ç”¨å°½å¯èƒ½å°çš„æŸ¥è¯¢æ˜¯å¥½çš„ï¼Œä½†æ˜¯æœ‰æ—¶å°†ä¸€ä¸ªå¤§çš„æŸ¥è¯¢åˆ†è§£ä¸ºå¤šä¸ªå°çš„æŸ¥è¯¢æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ åˆ‡åˆ†æŸ¥è¯¢ å°†ä¸€ä¸ªå¤§çš„æŸ¥è¯¢åˆ†ä¸ºå¤šä¸ªå°çš„ç›¸åŒçš„æŸ¥è¯¢ ä¸€æ¬¡æ€§åˆ é™¤1000ä¸‡çš„æ•°æ®è¦æ¯”ä¸€æ¬¡åˆ é™¤1ä¸‡ï¼Œæš‚åœä¸€ä¼šçš„æ–¹æ¡ˆæ›´åŠ æŸè€—æœåŠ¡å™¨å¼€é”€ã€‚ åˆ†è§£å…³è”æŸ¥è¯¢ï¼Œè®©ç¼“å­˜çš„æ•ˆç‡æ›´é«˜ã€‚ æ‰§è¡Œå•ä¸ªæŸ¥è¯¢å¯ä»¥å‡å°‘é”çš„ç«äº‰ã€‚ åœ¨åº”ç”¨å±‚åšå…³è”æ›´å®¹æ˜“å¯¹æ•°æ®åº“è¿›è¡Œæ‹†åˆ†ã€‚ æŸ¥è¯¢æ•ˆç‡ä¼šæœ‰å¤§å¹…æå‡ã€‚ è¾ƒå°‘å†—ä½™è®°å½•çš„æŸ¥è¯¢ã€‚ ","date":"2022-04-26","objectID":"/mysql/:28:13","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¼˜åŒ–ç‰¹å®šç±»å‹çš„æŸ¥è¯¢è¯­å¥ count(*)ä¼šå¿½ç•¥æ‰€æœ‰çš„åˆ—ï¼Œç›´æ¥ç»Ÿè®¡æ‰€æœ‰åˆ—æ•°ï¼Œä¸è¦ä½¿ç”¨count(åˆ—å) MyISAMä¸­ï¼Œæ²¡æœ‰ä»»ä½•whereæ¡ä»¶çš„count(*)éå¸¸å¿«ã€‚ å½“æœ‰whereæ¡ä»¶æ—¶ï¼ŒMyISAMçš„countç»Ÿè®¡ä¸ä¸€å®šæ¯”å…¶å®ƒå¼•æ“å¿«ã€‚ å¯ä»¥ä½¿ç”¨explainæŸ¥è¯¢è¿‘ä¼¼å€¼ï¼Œç”¨è¿‘ä¼¼å€¼æ›¿ä»£count(*) å¢åŠ æ±‡æ€»è¡¨ ä½¿ç”¨ç¼“å­˜ ","date":"2022-04-26","objectID":"/mysql/:28:14","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¼˜åŒ–å…³è”æŸ¥è¯¢ ç¡®å®šONæˆ–è€…USINGå­å¥ä¸­æ˜¯å¦æœ‰ç´¢å¼•ã€‚ ç¡®ä¿GROUP BYå’ŒORDER BYåªæœ‰ä¸€ä¸ªè¡¨ä¸­çš„åˆ—ï¼Œè¿™æ ·MySQLæ‰æœ‰å¯èƒ½ä½¿ç”¨ç´¢å¼•ã€‚ ","date":"2022-04-26","objectID":"/mysql/:28:15","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¼˜åŒ–å­æŸ¥è¯¢ ç”¨å…³è”æŸ¥è¯¢æ›¿ä»£ ä¼˜åŒ–GROUP BYå’ŒDISTINCT è¿™ä¸¤ç§æŸ¥è¯¢æ®å¯ä»¥ä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–ï¼Œæ˜¯æœ€æœ‰æ•ˆçš„ä¼˜åŒ–æ–¹æ³• å…³è”æŸ¥è¯¢ä¸­ï¼Œä½¿ç”¨æ ‡è¯†åˆ—åˆ†ç»„çš„æ•ˆç‡æ›´é«˜ å¦‚æœä¸éœ€è¦ORDER BYï¼Œè¿›è¡ŒGROUP BYæ—¶åŠ ORDER BY NULLï¼ŒMySQLä¸ä¼šå†è¿›è¡Œæ–‡ä»¶æ’åºã€‚ WITH ROLLUPè¶…çº§èšåˆï¼Œå¯ä»¥æŒªåˆ°åº”ç”¨ç¨‹åºå¤„ç† ","date":"2022-04-26","objectID":"/mysql/:28:16","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¼˜åŒ–LIMITåˆ†é¡µ LIMITåç§»é‡å¤§çš„æ—¶å€™ï¼ŒæŸ¥è¯¢æ•ˆç‡è¾ƒä½ å¯ä»¥è®°å½•ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å¤§IDï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶ç›´æ¥æ ¹æ®è¯¥IDæ¥æŸ¥è¯¢ ","date":"2022-04-26","objectID":"/mysql/:28:17","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¼˜åŒ–UNIONæŸ¥è¯¢ UNION ALLçš„æ•ˆç‡é«˜äºUNION ","date":"2022-04-26","objectID":"/mysql/:28:18","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¼˜åŒ–WHEREå­å¥ è§£é¢˜æ–¹æ³• å¯¹äºæ­¤ç±»è€ƒé¢˜ï¼Œå…ˆè¯´æ˜å¦‚ä½•å®šä½ä½æ•ˆSQLè¯­å¥ï¼Œç„¶åæ ¹æ®SQLè¯­å¥å¯èƒ½ä½æ•ˆçš„åŸå› åšæ’æŸ¥ï¼Œå…ˆä»ç´¢å¼•ç€æ‰‹ï¼Œå¦‚æœç´¢å¼•æ²¡æœ‰é—®é¢˜ï¼Œè€ƒè™‘ä»¥ä¸Šå‡ ä¸ªæ–¹é¢ï¼Œæ•°æ®è®¿é—®çš„é—®é¢˜ï¼Œé•¿éš¾æŸ¥è¯¢å¥çš„é—®é¢˜è¿˜æ˜¯ä¸€äº›ç‰¹å®šç±»å‹ä¼˜åŒ–çš„é—®é¢˜ï¼Œé€ä¸€å›ç­”ã€‚ SQLè¯­å¥ä¼˜åŒ–çš„ä¸€äº›æ–¹æ³•ï¼Ÿ 1.å¯¹æŸ¥è¯¢è¿›è¡Œä¼˜åŒ–ï¼Œåº”å°½é‡é¿å…å…¨è¡¨æ‰«æï¼Œé¦–å…ˆåº”è€ƒè™‘åœ¨ where åŠ order by æ¶‰åŠçš„åˆ—ä¸Šå»ºç«‹ç´¢å¼•ã€‚ 2.åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œ null å€¼åˆ¤æ–­ï¼Œå¦åˆ™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æï¼Œå¦‚ï¼š selectidfromtwherenumisnull-- å¯ä»¥åœ¨numä¸Šè®¾ç½®é»˜è®¤å€¼0ï¼Œç¡®ä¿è¡¨ä¸­numåˆ—æ²¡æœ‰nullå€¼ï¼Œç„¶åè¿™æ ·æŸ¥è¯¢ï¼š selectidfromtwherenum=123 3.åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­ä½¿ç”¨!=æˆ–\u003c\u003eæ“ä½œç¬¦ï¼Œå¦åˆ™å¼•æ“å°†æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æã€‚ 4.åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­ä½¿ç”¨or æ¥è¿æ¥æ¡ä»¶ï¼Œå¦åˆ™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æï¼Œå¦‚ï¼š selectidfromtwherenum=10ornum=20-- å¯ä»¥è¿™æ ·æŸ¥è¯¢ï¼š selectidfromtwherenum=10unionallselectidfromtwherenum=20123 5.in å’Œ not in ä¹Ÿè¦æ…ç”¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´å…¨è¡¨æ‰«æï¼Œå¦‚ï¼š selectidfromtwherenumin(1,2,3)-- å¯¹äºè¿ç»­çš„æ•°å€¼ï¼Œèƒ½ç”¨ between å°±ä¸è¦ç”¨ in äº†ï¼š selectidfromtwherenumbetween1and3123 6.ä¸‹é¢çš„æŸ¥è¯¢ä¹Ÿå°†å¯¼è‡´å…¨è¡¨æ‰«æï¼šselect id from t where name like â€˜%æ%â€™è‹¥è¦æé«˜æ•ˆç‡ï¼Œå¯ä»¥è€ƒè™‘å…¨æ–‡æ£€ç´¢ã€‚ 7.å¦‚æœåœ¨ where å­å¥ä¸­ä½¿ç”¨å‚æ•°ï¼Œä¹Ÿä¼šå¯¼è‡´å…¨è¡¨æ‰«æã€‚å› ä¸ºSQLåªæœ‰åœ¨è¿è¡Œæ—¶æ‰ä¼šè§£æå±€éƒ¨å˜é‡ï¼Œä½†ä¼˜åŒ–ç¨‹åºä¸èƒ½å°†è®¿é—®è®¡åˆ’çš„é€‰æ‹©æ¨è¿Ÿåˆ°è¿è¡Œæ—¶ï¼›å®ƒå¿…é¡»åœ¨ç¼–è¯‘æ—¶è¿›è¡Œé€‰æ‹©ã€‚ç„¶ è€Œï¼Œå¦‚æœåœ¨ç¼–è¯‘æ—¶å»ºç«‹è®¿é—®è®¡åˆ’ï¼Œå˜é‡çš„å€¼è¿˜æ˜¯æœªçŸ¥çš„ï¼Œå› è€Œæ— æ³•ä½œä¸ºç´¢å¼•é€‰æ‹©çš„è¾“å…¥é¡¹ã€‚å¦‚ä¸‹é¢è¯­å¥å°†è¿›è¡Œå…¨è¡¨æ‰«æï¼š selectidfromtwherenum=@num-- å¯ä»¥æ”¹ä¸ºå¼ºåˆ¶æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•ï¼š selectidfromtwith(index(ç´¢å¼•å))wherenum=@num123 8.åº”å°½é‡é¿å…åœ¨ where å­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œè¡¨è¾¾å¼æ“ä½œï¼Œè¿™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æã€‚å¦‚ï¼š selectidfromtwherenum/2=100-- åº”æ”¹ä¸º: selectidfromtwherenum=100*2123 9.åº”å°½é‡é¿å…åœ¨whereå­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œå‡½æ•°æ“ä½œï¼Œè¿™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æã€‚å¦‚ï¼š selectidfromtwheresubstring(name,1,3)=â€™abcâ€™-- nameä»¥abcå¼€å¤´çš„idåº”æ”¹ä¸º: selectidfromtwherenamelikeâ€˜abc%â€™123 10.ä¸è¦åœ¨ where å­å¥ä¸­çš„â€œ=â€å·¦è¾¹è¿›è¡Œå‡½æ•°ã€ç®—æœ¯è¿ç®—æˆ–å…¶ä»–è¡¨è¾¾å¼è¿ç®—ï¼Œå¦åˆ™ç³»ç»Ÿå°†å¯èƒ½æ— æ³•æ­£ç¡®ä½¿ç”¨ç´¢å¼•ã€‚ ","date":"2022-04-26","objectID":"/mysql/:28:19","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"æ•°æ®åº“ä¼˜åŒ– ","date":"2022-04-26","objectID":"/mysql/:29:0","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"ä¸ºä»€ä¹ˆè¦ä¼˜åŒ– ç³»ç»Ÿçš„ååé‡ç“¶é¢ˆå¾€å¾€å‡ºç°åœ¨æ•°æ®åº“çš„è®¿é—®é€Ÿåº¦ä¸Š éšç€åº”ç”¨ç¨‹åºçš„è¿è¡Œï¼Œæ•°æ®åº“çš„ä¸­çš„æ•°æ®ä¼šè¶Šæ¥è¶Šå¤šï¼Œå¤„ç†æ—¶é—´ä¼šç›¸åº”å˜æ…¢ æ•°æ®æ˜¯å­˜æ”¾åœ¨ç£ç›˜ä¸Šçš„ï¼Œè¯»å†™é€Ÿåº¦æ— æ³•å’Œå†…å­˜ç›¸æ¯” ä¼˜åŒ–åŸåˆ™ï¼šå‡å°‘ç³»ç»Ÿç“¶é¢ˆï¼Œå‡å°‘èµ„æºå ç”¨ï¼Œå¢åŠ ç³»ç»Ÿçš„ååº”é€Ÿåº¦ã€‚ ","date":"2022-04-26","objectID":"/mysql/:29:1","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"æ•°æ®åº“ç»“æ„ä¼˜åŒ– ä¸€ä¸ªå¥½çš„æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆå¯¹äºæ•°æ®åº“çš„æ€§èƒ½å¾€å¾€ä¼šèµ·åˆ°äº‹åŠåŠŸå€çš„æ•ˆæœã€‚ éœ€è¦è€ƒè™‘æ•°æ®å†—ä½™ã€æŸ¥è¯¢å’Œæ›´æ–°çš„é€Ÿåº¦ã€å­—æ®µçš„æ•°æ®ç±»å‹æ˜¯å¦åˆç†ç­‰å¤šæ–¹é¢çš„å†…å®¹ã€‚ å°†å­—æ®µå¾ˆå¤šçš„è¡¨åˆ†è§£æˆå¤šä¸ªè¡¨ å¯¹äºå­—æ®µè¾ƒå¤šçš„è¡¨ï¼Œå¦‚æœæœ‰äº›å­—æ®µçš„ä½¿ç”¨é¢‘ç‡å¾ˆä½ï¼Œå¯ä»¥å°†è¿™äº›å­—æ®µåˆ†ç¦»å‡ºæ¥å½¢æˆæ–°è¡¨ã€‚ å› ä¸ºå½“ä¸€ä¸ªè¡¨çš„æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œä¼šç”±äºä½¿ç”¨é¢‘ç‡ä½çš„å­—æ®µçš„å­˜åœ¨è€Œå˜æ…¢ã€‚ å¢åŠ ä¸­é—´è¡¨ å¯¹äºéœ€è¦ç»å¸¸è”åˆæŸ¥è¯¢çš„è¡¨ï¼Œå¯ä»¥å»ºç«‹ä¸­é—´è¡¨ä»¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚ é€šè¿‡å»ºç«‹ä¸­é—´è¡¨ï¼Œå°†éœ€è¦é€šè¿‡è”åˆæŸ¥è¯¢çš„æ•°æ®æ’å…¥åˆ°ä¸­é—´è¡¨ä¸­ï¼Œç„¶åå°†åŸæ¥çš„è”åˆæŸ¥è¯¢æ”¹ä¸ºå¯¹ä¸­é—´è¡¨çš„æŸ¥è¯¢ã€‚ å¢åŠ å†—ä½™å­—æ®µ è®¾è®¡æ•°æ®è¡¨æ—¶åº”å°½é‡éµå¾ªèŒƒå¼ç†è®ºçš„è§„çº¦ï¼Œå°½å¯èƒ½çš„å‡å°‘å†—ä½™å­—æ®µï¼Œè®©æ•°æ®åº“è®¾è®¡çœ‹èµ·æ¥ç²¾è‡´ã€ä¼˜é›…ã€‚ä½†æ˜¯ï¼Œåˆç†çš„åŠ å…¥å†—ä½™å­—æ®µå¯ä»¥æé«˜æŸ¥è¯¢é€Ÿåº¦ã€‚ è¡¨çš„è§„èŒƒåŒ–ç¨‹åº¦è¶Šé«˜ï¼Œè¡¨å’Œè¡¨ä¹‹é—´çš„å…³ç³»è¶Šå¤šï¼Œéœ€è¦è¿æ¥æŸ¥è¯¢çš„æƒ…å†µä¹Ÿå°±è¶Šå¤šï¼Œæ€§èƒ½ä¹Ÿå°±è¶Šå·®ã€‚ æ³¨æ„ï¼š å†—ä½™å­—æ®µçš„å€¼åœ¨ä¸€ä¸ªè¡¨ä¸­ä¿®æ”¹äº†ï¼Œå°±è¦æƒ³åŠæ³•åœ¨å…¶ä»–è¡¨ä¸­æ›´æ–°ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ ","date":"2022-04-26","objectID":"/mysql/:29:2","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"MySQLæ•°æ®åº“cpué£™å‡åˆ°500%çš„è¯ä»–æ€ä¹ˆå¤„ç†ï¼Ÿ å½“ cpu é£™å‡åˆ° 500%æ—¶ï¼Œå…ˆç”¨æ“ä½œç³»ç»Ÿå‘½ä»¤ top å‘½ä»¤è§‚å¯Ÿæ˜¯ä¸æ˜¯ mysqld å ç”¨å¯¼è‡´çš„ï¼Œå¦‚æœä¸æ˜¯ï¼Œæ‰¾å‡ºå ç”¨é«˜çš„è¿›ç¨‹ï¼Œå¹¶è¿›è¡Œç›¸å…³å¤„ç†ã€‚ å¦‚æœæ˜¯ mysqld é€ æˆçš„ï¼Œ show processlistï¼Œçœ‹çœ‹é‡Œé¢è·‘çš„ session æƒ…å†µï¼Œæ˜¯ä¸æ˜¯æœ‰æ¶ˆè€—èµ„æºçš„ sql åœ¨è¿è¡Œã€‚æ‰¾å‡ºæ¶ˆè€—é«˜çš„ sqlï¼Œçœ‹çœ‹æ‰§è¡Œè®¡åˆ’æ˜¯å¦å‡†ç¡®ï¼Œ index æ˜¯å¦ç¼ºå¤±ï¼Œæˆ–è€…å®åœ¨æ˜¯æ•°æ®é‡å¤ªå¤§é€ æˆã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œè‚¯å®šè¦ kill æ‰è¿™äº›çº¿ç¨‹(åŒæ—¶è§‚å¯Ÿ cpu ä½¿ç”¨ç‡æ˜¯å¦ä¸‹é™)ï¼Œç­‰è¿›è¡Œç›¸åº”çš„è°ƒæ•´(æ¯”å¦‚è¯´åŠ ç´¢å¼•ã€æ”¹ sqlã€æ”¹å†…å­˜å‚æ•°)ä¹‹åï¼Œå†é‡æ–°è·‘è¿™äº› SQLã€‚ ä¹Ÿæœ‰å¯èƒ½æ˜¯æ¯ä¸ª sql æ¶ˆè€—èµ„æºå¹¶ä¸å¤šï¼Œä½†æ˜¯çªç„¶ä¹‹é—´ï¼Œæœ‰å¤§é‡çš„ session è¿è¿›æ¥å¯¼è‡´ cpu é£™å‡ï¼Œè¿™ç§æƒ…å†µå°±éœ€è¦è·Ÿåº”ç”¨ä¸€èµ·æ¥åˆ†æä¸ºä½•è¿æ¥æ•°ä¼šæ¿€å¢ï¼Œå†åšå‡ºç›¸åº”çš„è°ƒæ•´ï¼Œæ¯”å¦‚è¯´é™åˆ¶è¿æ¥æ•°ç­‰ ","date":"2022-04-26","objectID":"/mysql/:29:3","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å¤§è¡¨æ€ä¹ˆä¼˜åŒ–ï¼ŸæŸä¸ªè¡¨æœ‰è¿‘åƒä¸‡æ•°æ®ï¼ŒCRUDæ¯”è¾ƒæ…¢ï¼Œå¦‚ä½•ä¼˜åŒ–ï¼Ÿåˆ†åº“åˆ†è¡¨äº†æ˜¯æ€ä¹ˆåšçš„ï¼Ÿåˆ†è¡¨åˆ†åº“äº†æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿæœ‰ç”¨åˆ°ä¸­é—´ä»¶ä¹ˆï¼Ÿä»–ä»¬çš„åŸç†çŸ¥é“ä¹ˆï¼Ÿ å½“MySQLå•è¡¨è®°å½•æ•°è¿‡å¤§æ—¶ï¼Œæ•°æ®åº“çš„CRUDæ€§èƒ½ä¼šæ˜æ˜¾ä¸‹é™ï¼Œä¸€äº›å¸¸è§çš„ä¼˜åŒ–æªæ–½å¦‚ä¸‹ï¼š é™å®šæ•°æ®çš„èŒƒå›´ï¼š åŠ¡å¿…ç¦æ­¢ä¸å¸¦ä»»ä½•é™åˆ¶æ•°æ®èŒƒå›´æ¡ä»¶çš„æŸ¥è¯¢è¯­å¥ã€‚æ¯”å¦‚ï¼šæˆ‘ä»¬å½“ç”¨æˆ·åœ¨æŸ¥è¯¢è®¢å•å†å²çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶åœ¨ä¸€ä¸ªæœˆçš„èŒƒå›´å†…ã€‚ï¼› è¯»/å†™åˆ†ç¦»ï¼š ç»å…¸çš„æ•°æ®åº“æ‹†åˆ†æ–¹æ¡ˆï¼Œä¸»åº“è´Ÿè´£å†™ï¼Œä»åº“è´Ÿè´£è¯»ï¼› ç¼“å­˜ï¼š ä½¿ç”¨MySQLçš„ç¼“å­˜ï¼Œå¦å¤–å¯¹é‡é‡çº§ã€æ›´æ–°å°‘çš„æ•°æ®å¯ä»¥è€ƒè™‘ä½¿ç”¨åº”ç”¨çº§åˆ«çš„ç¼“å­˜ï¼› è¿˜æœ‰å°±æ˜¯é€šè¿‡åˆ†åº“åˆ†è¡¨çš„æ–¹å¼è¿›è¡Œä¼˜åŒ–ï¼Œä¸»è¦æœ‰å‚ç›´åˆ†è¡¨å’Œæ°´å¹³åˆ†è¡¨ å‚ç›´åˆ†åŒºï¼š æ ¹æ®æ•°æ®åº“é‡Œé¢æ•°æ®è¡¨çš„ç›¸å…³æ€§è¿›è¡Œæ‹†åˆ†ã€‚ ä¾‹å¦‚ï¼Œç”¨æˆ·è¡¨ä¸­æ—¢æœ‰ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯åˆæœ‰ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¯ä»¥å°†ç”¨æˆ·è¡¨æ‹†åˆ†æˆä¸¤ä¸ªå•ç‹¬çš„è¡¨ï¼Œç”šè‡³æ”¾åˆ°å•ç‹¬çš„åº“åšåˆ†åº“ã€‚ ç®€å•æ¥è¯´å‚ç›´æ‹†åˆ†æ˜¯æŒ‡æ•°æ®è¡¨åˆ—çš„æ‹†åˆ†ï¼ŒæŠŠä¸€å¼ åˆ—æ¯”è¾ƒå¤šçš„è¡¨æ‹†åˆ†ä¸ºå¤šå¼ è¡¨ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™æ ·æ¥è¯´å¤§å®¶åº”è¯¥å°±æ›´å®¹æ˜“ç†è§£äº†ã€‚ å‚ç›´æ‹†åˆ†çš„ä¼˜ç‚¹ï¼š å¯ä»¥ä½¿å¾—è¡Œæ•°æ®å˜å°ï¼Œåœ¨æŸ¥è¯¢æ—¶å‡å°‘è¯»å–çš„Blockæ•°ï¼Œå‡å°‘I/Oæ¬¡æ•°ã€‚æ­¤å¤–ï¼Œå‚ç›´åˆ†åŒºå¯ä»¥ç®€åŒ–è¡¨çš„ç»“æ„ï¼Œæ˜“äºç»´æŠ¤ã€‚ å‚ç›´æ‹†åˆ†çš„ç¼ºç‚¹ï¼š ä¸»é”®ä¼šå‡ºç°å†—ä½™ï¼Œéœ€è¦ç®¡ç†å†—ä½™åˆ—ï¼Œå¹¶ä¼šå¼•èµ·Joinæ“ä½œï¼Œå¯ä»¥é€šè¿‡åœ¨åº”ç”¨å±‚è¿›è¡ŒJoinæ¥è§£å†³ã€‚æ­¤å¤–ï¼Œå‚ç›´åˆ†åŒºä¼šè®©äº‹åŠ¡å˜å¾—æ›´åŠ å¤æ‚ï¼› å‚ç›´åˆ†è¡¨ æŠŠä¸»é”®å’Œä¸€äº›åˆ—æ”¾åœ¨ä¸€ä¸ªè¡¨ï¼Œç„¶åæŠŠä¸»é”®å’Œå¦å¤–çš„åˆ—æ”¾åœ¨å¦ä¸€ä¸ªè¡¨ä¸­ é€‚ç”¨åœºæ™¯ 1ã€å¦‚æœä¸€ä¸ªè¡¨ä¸­æŸäº›åˆ—å¸¸ç”¨ï¼Œå¦å¤–ä¸€äº›åˆ—ä¸å¸¸ç”¨ 2ã€å¯ä»¥ä½¿æ•°æ®è¡Œå˜å°ï¼Œä¸€ä¸ªæ•°æ®é¡µèƒ½å­˜å‚¨æ›´å¤šæ•°æ®ï¼ŒæŸ¥è¯¢æ—¶å‡å°‘I/Oæ¬¡æ•° ç¼ºç‚¹ æœ‰äº›åˆ†è¡¨çš„ç­–ç•¥åŸºäºåº”ç”¨å±‚çš„é€»è¾‘ç®—æ³•ï¼Œä¸€æ—¦é€»è¾‘ç®—æ³•æ”¹å˜ï¼Œæ•´ä¸ªåˆ†è¡¨é€»è¾‘éƒ½ä¼šæ”¹å˜ï¼Œæ‰©å±•æ€§è¾ƒå·® å¯¹äºåº”ç”¨å±‚æ¥è¯´ï¼Œé€»è¾‘ç®—æ³•å¢åŠ å¼€å‘æˆæœ¬ ç®¡ç†å†—ä½™åˆ—ï¼ŒæŸ¥è¯¢æ‰€æœ‰æ•°æ®éœ€è¦joinæ“ä½œ æ°´å¹³åˆ†åŒºï¼š ä¿æŒæ•°æ®è¡¨ç»“æ„ä¸å˜ï¼Œé€šè¿‡æŸç§ç­–ç•¥å­˜å‚¨æ•°æ®åˆ†ç‰‡ã€‚è¿™æ ·æ¯ä¸€ç‰‡æ•°æ®åˆ†æ•£åˆ°ä¸åŒçš„è¡¨æˆ–è€…åº“ä¸­ï¼Œè¾¾åˆ°äº†åˆ†å¸ƒå¼çš„ç›®çš„ã€‚ æ°´å¹³æ‹†åˆ†å¯ä»¥æ”¯æ’‘éå¸¸å¤§çš„æ•°æ®é‡ã€‚ æ°´å¹³æ‹†åˆ†æ˜¯æŒ‡æ•°æ®è¡¨è¡Œçš„æ‹†åˆ†ï¼Œè¡¨çš„è¡Œæ•°è¶…è¿‡200ä¸‡è¡Œæ—¶ï¼Œå°±ä¼šå˜æ…¢ï¼Œè¿™æ—¶å¯ä»¥æŠŠä¸€å¼ çš„è¡¨çš„æ•°æ®æ‹†æˆå¤šå¼ è¡¨æ¥å­˜æ”¾ã€‚ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬å¯ä»¥å°†ç”¨æˆ·ä¿¡æ¯è¡¨æ‹†åˆ†æˆå¤šä¸ªç”¨æˆ·ä¿¡æ¯è¡¨ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…å•ä¸€è¡¨æ•°æ®é‡è¿‡å¤§å¯¹æ€§èƒ½é€ æˆå½±å“ã€‚ æ°´å“æ‹†åˆ†å¯ä»¥æ”¯æŒéå¸¸å¤§çš„æ•°æ®é‡ã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯:åˆ†è¡¨ä»…ä»…æ˜¯è§£å†³äº†å•ä¸€è¡¨æ•°æ®è¿‡å¤§çš„é—®é¢˜ï¼Œä½†ç”±äºè¡¨çš„æ•°æ®è¿˜æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå…¶å®å¯¹äºæå‡MySQLå¹¶å‘èƒ½åŠ›æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œæ‰€ä»¥ æ°´å¹³æ‹†åˆ†æœ€å¥½åˆ†åº“ ã€‚ æ°´å¹³æ‹†åˆ†èƒ½å¤Ÿ æ”¯æŒéå¸¸å¤§çš„æ•°æ®é‡å­˜å‚¨ï¼Œåº”ç”¨ç«¯æ”¹é€ ä¹Ÿå°‘ï¼Œä½† åˆ†ç‰‡äº‹åŠ¡éš¾ä»¥è§£å†³ ï¼Œè·¨ç•Œç‚¹Joinæ€§èƒ½è¾ƒå·®ï¼Œé€»è¾‘å¤æ‚ã€‚ ã€ŠJavaå·¥ç¨‹å¸ˆä¿®ç‚¼ä¹‹é“ã€‹çš„ä½œè€…æ¨è å°½é‡ä¸è¦å¯¹æ•°æ®è¿›è¡Œåˆ†ç‰‡ï¼Œå› ä¸ºæ‹†åˆ†ä¼šå¸¦æ¥é€»è¾‘ã€éƒ¨ç½²ã€è¿ç»´çš„å„ç§å¤æ‚åº¦ ï¼Œä¸€èˆ¬çš„æ•°æ®è¡¨åœ¨ä¼˜åŒ–å¾—å½“çš„æƒ…å†µä¸‹æ”¯æ’‘åƒä¸‡ä»¥ä¸‹çš„æ•°æ®é‡æ˜¯æ²¡æœ‰å¤ªå¤§é—®é¢˜çš„ã€‚å¦‚æœå®åœ¨è¦åˆ†ç‰‡ï¼Œå°½é‡é€‰æ‹©å®¢æˆ·ç«¯åˆ†ç‰‡æ¶æ„ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€æ¬¡å’Œä¸­é—´ä»¶çš„ç½‘ç»œI/Oã€‚ æ°´å¹³åˆ†è¡¨ï¼š è¡¨å¾ˆå¤§ï¼Œåˆ†å‰²åå¯ä»¥é™ä½åœ¨æŸ¥è¯¢æ—¶éœ€è¦è¯»çš„æ•°æ®å’Œç´¢å¼•çš„é¡µæ•°ï¼ŒåŒæ—¶ä¹Ÿé™ä½äº†ç´¢å¼•çš„å±‚æ•°ï¼Œæé«˜æŸ¥è¯¢æ¬¡æ•° é€‚ç”¨åœºæ™¯ 1ã€è¡¨ä¸­çš„æ•°æ®æœ¬èº«å°±æœ‰ç‹¬ç«‹æ€§ï¼Œä¾‹å¦‚è¡¨ä¸­åˆ†è¡¨è®°å½•å„ä¸ªåœ°åŒºçš„æ•°æ®æˆ–è€…ä¸åŒæ—¶æœŸçš„æ•°æ®ï¼Œç‰¹åˆ«æ˜¯æœ‰äº›æ•°æ®å¸¸ç”¨ï¼Œæœ‰äº›ä¸å¸¸ç”¨ã€‚ 2ã€éœ€è¦æŠŠæ•°æ®å­˜æ”¾åœ¨å¤šä¸ªä»‹è´¨ä¸Šã€‚ æ°´å¹³åˆ‡åˆ†çš„ç¼ºç‚¹ 1ã€ç»™åº”ç”¨å¢åŠ å¤æ‚åº¦ï¼Œé€šå¸¸æŸ¥è¯¢æ—¶éœ€è¦å¤šä¸ªè¡¨åï¼ŒæŸ¥è¯¢æ‰€æœ‰æ•°æ®éƒ½éœ€UNIONæ“ä½œ 2ã€åœ¨è®¸å¤šæ•°æ®åº“åº”ç”¨ä¸­ï¼Œè¿™ç§å¤æ‚åº¦ä¼šè¶…è¿‡å®ƒå¸¦æ¥çš„ä¼˜ç‚¹ï¼ŒæŸ¥è¯¢æ—¶ä¼šå¢åŠ è¯»ä¸€ä¸ªç´¢å¼•å±‚çš„ç£ç›˜æ¬¡æ•° ä¸‹é¢è¡¥å……ä¸€ä¸‹æ•°æ®åº“åˆ†ç‰‡çš„ä¸¤ç§å¸¸è§æ–¹æ¡ˆï¼š å®¢æˆ·ç«¯ä»£ç†ï¼š åˆ†ç‰‡é€»è¾‘åœ¨åº”ç”¨ç«¯ï¼Œå°è£…åœ¨jaråŒ…ä¸­ï¼Œé€šè¿‡ä¿®æ”¹æˆ–è€…å°è£…JDBCå±‚æ¥å®ç°ã€‚ å½“å½“ç½‘çš„ Sharding-JDBC ã€é˜¿é‡Œçš„TDDLæ˜¯ä¸¤ç§æ¯”è¾ƒå¸¸ç”¨çš„å®ç°ã€‚ ä¸­é—´ä»¶ä»£ç†ï¼š åœ¨åº”ç”¨å’Œæ•°æ®ä¸­é—´åŠ äº†ä¸€ä¸ªä»£ç†å±‚ã€‚åˆ†ç‰‡é€»è¾‘ç»Ÿä¸€ç»´æŠ¤åœ¨ä¸­é—´ä»¶æœåŠ¡ä¸­ã€‚ æˆ‘ä»¬ç°åœ¨è°ˆçš„ Mycat ã€360çš„Atlasã€ç½‘æ˜“çš„DDBç­‰ç­‰éƒ½æ˜¯è¿™ç§æ¶æ„çš„å®ç°ã€‚ åˆ†åº“åˆ†è¡¨åé¢ä¸´çš„é—®é¢˜ äº‹åŠ¡æ”¯æŒ åˆ†åº“åˆ†è¡¨åï¼Œå°±æˆäº†åˆ†å¸ƒå¼äº‹åŠ¡äº†ã€‚å¦‚æœä¾èµ–æ•°æ®åº“æœ¬èº«çš„åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†åŠŸèƒ½å»æ‰§è¡Œäº‹åŠ¡ï¼Œå°†ä»˜å‡ºé«˜æ˜‚çš„æ€§èƒ½ä»£ä»·ï¼› å¦‚æœç”±åº”ç”¨ç¨‹åºå»ååŠ©æ§åˆ¶ï¼Œå½¢æˆç¨‹åºé€»è¾‘ä¸Šçš„äº‹åŠ¡ï¼Œåˆä¼šé€ æˆç¼–ç¨‹æ–¹é¢çš„è´Ÿæ‹…ã€‚ è·¨åº“join åªè¦æ˜¯è¿›è¡Œåˆ‡åˆ†ï¼Œè·¨èŠ‚ç‚¹Joinçš„é—®é¢˜æ˜¯ä¸å¯é¿å…çš„ã€‚ä½†æ˜¯è‰¯å¥½çš„è®¾è®¡å’Œåˆ‡åˆ†å´å¯ä»¥å‡å°‘æ­¤ç±»æƒ…å†µçš„å‘ç”Ÿã€‚è§£å†³è¿™ä¸€é—®é¢˜çš„æ™®éåšæ³•æ˜¯åˆ†ä¸¤æ¬¡æŸ¥è¯¢å®ç°ã€‚åœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœé›†ä¸­æ‰¾å‡ºå…³è”æ•°æ®çš„id,æ ¹æ®è¿™äº›idå‘èµ·ç¬¬äºŒæ¬¡è¯·æ±‚å¾—åˆ°å…³è”æ•°æ®ã€‚ åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆäº§å“ è·¨èŠ‚ç‚¹çš„count,order by,group byä»¥åŠèšåˆå‡½æ•°é—®é¢˜ è¿™äº›æ˜¯ä¸€ç±»é—®é¢˜ï¼Œå› ä¸ºå®ƒä»¬éƒ½éœ€è¦åŸºäºå…¨éƒ¨æ•°æ®é›†åˆè¿›è¡Œè®¡ç®—ã€‚å¤šæ•°çš„ä»£ç†éƒ½ä¸ä¼šè‡ªåŠ¨å¤„ç†åˆå¹¶å·¥ä½œã€‚è§£å†³æ–¹æ¡ˆï¼šä¸è§£å†³è·¨èŠ‚ç‚¹joiné—®é¢˜çš„ç±»ä¼¼ï¼Œåˆ†åˆ«åœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šå¾—åˆ°ç»“æœååœ¨åº”ç”¨ç¨‹åºç«¯è¿›è¡Œåˆå¹¶ã€‚å’Œjoinä¸åŒçš„æ˜¯æ¯ä¸ªç»“ç‚¹çš„æŸ¥è¯¢å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œå› æ­¤å¾ˆå¤šæ—¶å€™å®ƒçš„é€Ÿåº¦è¦æ¯”å•ä¸€å¤§è¡¨å¿«å¾ˆå¤šã€‚ä½†å¦‚æœç»“æœé›†å¾ˆå¤§ï¼Œå¯¹åº”ç”¨ç¨‹åºå†…å­˜çš„æ¶ˆè€—æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ æ•°æ®è¿ç§»ï¼Œå®¹é‡è§„åˆ’ï¼Œæ‰©å®¹ç­‰é—®é¢˜ æ¥è‡ªæ·˜å®ç»¼åˆä¸šåŠ¡å¹³å°å›¢é˜Ÿï¼Œå®ƒåˆ©ç”¨å¯¹2çš„å€æ•°å–ä½™å…·æœ‰å‘å‰å…¼å®¹çš„ç‰¹æ€§ï¼ˆå¦‚å¯¹4å–ä½™å¾—1çš„æ•°å¯¹2å–ä½™ä¹Ÿæ˜¯1ï¼‰æ¥åˆ†é…æ•°æ®ï¼Œé¿å…äº†è¡Œçº§åˆ«çš„æ•°æ®è¿ç§»ï¼Œä½†æ˜¯ä¾ç„¶éœ€è¦è¿›è¡Œè¡¨çº§åˆ«çš„è¿ç§»ï¼ŒåŒæ—¶å¯¹æ‰©å®¹è§„æ¨¡å’Œåˆ†è¡¨æ•°é‡éƒ½æœ‰é™åˆ¶ã€‚æ€»å¾—æ¥è¯´ï¼Œè¿™äº›æ–¹æ¡ˆéƒ½ä¸æ˜¯ååˆ†çš„ç†æƒ³ï¼Œå¤šå¤šå°‘å°‘éƒ½å­˜åœ¨ä¸€äº›ç¼ºç‚¹ï¼Œè¿™ä¹Ÿä»ä¸€ä¸ªä¾§é¢åæ˜ å‡ºäº†Shardingæ‰©å®¹çš„éš¾åº¦ã€‚ IDé—®é¢˜ ä¸€æ—¦æ•°æ®åº“è¢«åˆ‡åˆ†åˆ°å¤šä¸ªç‰©ç†ç»“ç‚¹ä¸Šï¼Œæˆ‘ä»¬å°†ä¸èƒ½å†ä¾èµ–æ•°æ®åº“è‡ªèº«çš„ä¸»é”®ç”Ÿæˆæœºåˆ¶ã€‚ä¸€æ–¹é¢ï¼ŒæŸä¸ªåˆ†åŒºæ•°æ®åº“è‡ªç”Ÿæˆçš„IDæ— æ³•ä¿è¯åœ¨å…¨å±€ä¸Šæ˜¯å”¯ä¸€çš„ï¼›å¦ä¸€æ–¹é¢ï¼Œåº”ç”¨ç¨‹åºåœ¨æ’å…¥æ•°æ®ä¹‹å‰éœ€è¦å…ˆè·å¾—ID,ä»¥ä¾¿è¿›è¡ŒSQLè·¯ç”±. ä¸€äº›å¸¸è§çš„ä¸»é”®ç”Ÿæˆç­–ç•¥ UUID ä½¿ç”¨UUIDä½œä¸»é”®æ˜¯æœ€ç®€å•çš„æ–¹æ¡ˆï¼Œä½†æ˜¯ç¼ºç‚¹ä¹Ÿæ˜¯éå¸¸æ˜æ˜¾çš„ã€‚ç”±äºUUIDéå¸¸çš„é•¿ï¼Œé™¤å ç”¨å¤§é‡å­˜å‚¨ç©ºé—´å¤–ï¼Œæœ€ä¸»è¦çš„é—®é¢˜æ˜¯åœ¨ç´¢å¼•ä¸Šï¼Œåœ¨å»ºç«‹ç´¢å¼•å’ŒåŸºäºç´¢å¼•è¿›è¡ŒæŸ¥è¯¢æ—¶éƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚ Twitterçš„åˆ†å¸ƒå¼è‡ªå¢IDç®—æ³•Snowflake åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œéœ€è¦ç”Ÿæˆå…¨å±€UIDçš„åœºåˆè¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œtwitterçš„snowflakeè§£å†³äº†è¿™ç§éœ€æ±‚ï¼Œå®ç°ä¹Ÿè¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œé™¤å»é…ç½®ä¿¡æ¯ï¼Œæ ¸å¿ƒä»£ç å°±æ˜¯æ¯«ç§’çº§æ—¶é—´41ä½ æœºå™¨ID 10ä½ æ¯«ç§’å†…åºåˆ—12ä½ã€‚ è·¨åˆ†ç‰‡çš„æ’åºåˆ†é¡µ èˆ¬æ¥è®²ï¼Œåˆ†é¡µæ—¶éœ€è¦æŒ‰ç…§æŒ‡å®šå­—æ®µè¿›è¡Œæ’åºã€‚å½“æ’åºå­—æ®µå°±æ˜¯åˆ†ç‰‡å­—æ®µçš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡åˆ†ç‰‡è§„åˆ™å¯ä»¥æ¯”è¾ƒå®¹æ˜“å®šä½åˆ°æŒ‡å®šçš„åˆ†ç‰‡ï¼Œè€Œå½“æ’åºå­—æ®µéåˆ†ç‰‡å­—æ®µçš„æ—¶å€™ï¼Œæƒ…å†µå°±ä¼šå˜å¾—æ¯”è¾ƒå¤æ‚äº†ã€‚ä¸ºäº†æœ€ç»ˆç»“æœçš„å‡†ç¡®æ€§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸åŒçš„åˆ†ç‰‡èŠ‚ç‚¹ä¸­å°†æ•°æ®è¿›è¡Œæ’åºå¹¶è¿”å›ï¼Œå¹¶å°†ä¸åŒåˆ†ç‰‡è¿”å›çš„ç»“æœé›†è¿›è¡Œæ±‡æ€»å’Œå†æ¬¡æ’åºï¼Œæœ€åå†è¿”å›ç»™ç”¨æˆ·ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ","date":"2022-04-26","objectID":"/mysql/:29:4","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"MySQLçš„å¤åˆ¶åŸç†ä»¥åŠæµç¨‹ ä¸»ä»å¤åˆ¶ï¼šå°†ä¸»æ•°æ®åº“ä¸­çš„DDLå’ŒDMLæ“ä½œé€šè¿‡äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBINLOGï¼‰ä¼ è¾“åˆ°ä»æ•°æ®åº“ä¸Šï¼Œç„¶åå°†è¿™äº›æ—¥å¿—é‡æ–°æ‰§è¡Œï¼ˆé‡åšï¼‰ï¼›ä»è€Œä½¿å¾—ä»æ•°æ®åº“çš„æ•°æ®ä¸ä¸»æ•°æ®åº“ä¿æŒä¸€è‡´ã€‚ ä¸»ä»å¤åˆ¶çš„ä½œç”¨ ä¸»æ•°æ®åº“å‡ºç°é—®é¢˜ï¼Œå¯ä»¥åˆ‡æ¢åˆ°ä»æ•°æ®åº“ã€‚ å¯ä»¥è¿›è¡Œæ•°æ®åº“å±‚é¢çš„è¯»å†™åˆ†ç¦»ã€‚ å¯ä»¥åœ¨ä»æ•°æ®åº“ä¸Šè¿›è¡Œæ—¥å¸¸å¤‡ä»½ã€‚ MySQLä¸»ä»å¤åˆ¶è§£å†³çš„é—®é¢˜ æ•°æ®åˆ†å¸ƒï¼šéšæ„å¼€å§‹æˆ–åœæ­¢å¤åˆ¶ï¼Œå¹¶åœ¨ä¸åŒåœ°ç†ä½ç½®åˆ†å¸ƒæ•°æ®å¤‡ä»½ è´Ÿè½½å‡è¡¡ï¼šé™ä½å•ä¸ªæœåŠ¡å™¨çš„å‹åŠ› é«˜å¯ç”¨å’Œæ•…éšœåˆ‡æ¢ï¼šå¸®åŠ©åº”ç”¨ç¨‹åºé¿å…å•ç‚¹å¤±è´¥ å‡çº§æµ‹è¯•ï¼šå¯ä»¥ç”¨æ›´é«˜ç‰ˆæœ¬çš„MySQLä½œä¸ºä»åº“ MySQLä¸»ä»å¤åˆ¶å·¥ä½œåŸç† åœ¨ä¸»åº“ä¸ŠæŠŠæ•°æ®æ›´é«˜è®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿— ä»åº“å°†ä¸»åº“çš„æ—¥å¿—å¤åˆ¶åˆ°è‡ªå·±çš„ä¸­ç»§æ—¥å¿— ä»åº“è¯»å–ä¸­ç»§æ—¥å¿—çš„äº‹ä»¶ï¼Œå°†å…¶é‡æ”¾åˆ°ä»åº“æ•°æ®ä¸­ åŸºæœ¬åŸç†æµç¨‹ï¼Œ3ä¸ªçº¿ç¨‹ä»¥åŠä¹‹é—´çš„å…³è” ä¸»ï¼šbinlogçº¿ç¨‹â€”â€”è®°å½•ä¸‹æ‰€æœ‰æ”¹å˜äº†æ•°æ®åº“æ•°æ®çš„è¯­å¥ï¼Œæ”¾è¿›masterä¸Šçš„binlogä¸­ï¼› ä»ï¼šioçº¿ç¨‹â€”â€”åœ¨ä½¿ç”¨start slave ä¹‹åï¼Œè´Ÿè´£ä»masterä¸Šæ‹‰å– binlog å†…å®¹ï¼Œæ”¾è¿›è‡ªå·±çš„relay logä¸­ï¼› ä»ï¼šsqlæ‰§è¡Œçº¿ç¨‹â€”â€”æ‰§è¡Œrelay logä¸­çš„è¯­å¥ï¼› å¤åˆ¶è¿‡ç¨‹ Binary logï¼šä¸»æ•°æ®åº“çš„äºŒè¿›åˆ¶æ—¥å¿— Relay logï¼šä»æœåŠ¡å™¨çš„ä¸­ç»§æ—¥å¿— ç¬¬ä¸€æ­¥ï¼šmasteråœ¨æ¯ä¸ªäº‹åŠ¡æ›´æ–°æ•°æ®å®Œæˆä¹‹å‰ï¼Œå°†è¯¥æ“ä½œè®°å½•ä¸²è¡Œåœ°å†™å…¥åˆ°binlogæ–‡ä»¶ä¸­ã€‚ ç¬¬äºŒæ­¥ï¼šsalveå¼€å¯ä¸€ä¸ªI/O Threadï¼Œè¯¥çº¿ç¨‹åœ¨masteræ‰“å¼€ä¸€ä¸ªæ™®é€šè¿æ¥ï¼Œä¸»è¦å·¥ä½œæ˜¯binlog dump processã€‚å¦‚æœè¯»å–çš„è¿›åº¦å·²ç»è·Ÿä¸Šäº†masterï¼Œå°±è¿›å…¥ç¡çœ çŠ¶æ€å¹¶ç­‰å¾…masteräº§ç”Ÿæ–°çš„äº‹ä»¶ã€‚I/Oçº¿ç¨‹æœ€ç»ˆçš„ç›®çš„æ˜¯å°†è¿™äº›äº‹ä»¶å†™å…¥åˆ°ä¸­ç»§æ—¥å¿—ä¸­ã€‚ ç¬¬ä¸‰æ­¥ï¼šSQL Threadä¼šè¯»å–ä¸­ç»§æ—¥å¿—ï¼Œå¹¶é¡ºåºæ‰§è¡Œè¯¥æ—¥å¿—ä¸­çš„SQLäº‹ä»¶ï¼Œä»è€Œä¸ä¸»æ•°æ®åº“ä¸­çš„æ•°æ®ä¿æŒä¸€è‡´ã€‚ ","date":"2022-04-26","objectID":"/mysql/:29:5","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"è¯»å†™åˆ†ç¦»æœ‰å“ªäº›è§£å†³æ–¹æ¡ˆï¼Ÿ è¯»å†™åˆ†ç¦»æ˜¯ä¾èµ–äºä¸»ä»å¤åˆ¶ï¼Œè€Œä¸»ä»å¤åˆ¶åˆæ˜¯ä¸ºè¯»å†™åˆ†ç¦»æœåŠ¡çš„ã€‚å› ä¸ºä¸»ä»å¤åˆ¶è¦æ±‚slaveä¸èƒ½å†™åªèƒ½è¯»ï¼ˆå¦‚æœå¯¹slaveæ‰§è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆshow slave statuså°†ä¼šå‘ˆç°Slave_SQL_Running=NOï¼Œæ­¤æ—¶ä½ éœ€è¦æŒ‰ç…§å‰é¢æåˆ°çš„æ‰‹åŠ¨åŒæ­¥ä¸€ä¸‹slaveï¼‰ã€‚ æ–¹æ¡ˆä¸€ ä½¿ç”¨mysql-proxyä»£ç† ä¼˜ç‚¹ï¼šç›´æ¥å®ç°è¯»å†™åˆ†ç¦»å’Œè´Ÿè½½å‡è¡¡ï¼Œä¸ç”¨ä¿®æ”¹ä»£ç ï¼Œmasterå’Œslaveç”¨ä¸€æ ·çš„å¸å·ï¼Œmysqlå®˜æ–¹ä¸å»ºè®®å®é™…ç”Ÿäº§ä¸­ä½¿ç”¨ ç¼ºç‚¹ï¼šé™ä½æ€§èƒ½ï¼Œ ä¸æ”¯æŒäº‹åŠ¡ æ–¹æ¡ˆäºŒ ä½¿ç”¨AbstractRoutingDataSource+aop+annotationåœ¨daoå±‚å†³å®šæ•°æ®æºã€‚ å¦‚æœé‡‡ç”¨äº†mybatisï¼Œ å¯ä»¥å°†è¯»å†™åˆ†ç¦»æ”¾åœ¨ORMå±‚ï¼Œæ¯”å¦‚mybatiså¯ä»¥é€šè¿‡mybatis pluginæ‹¦æˆªsqlè¯­å¥ï¼Œæ‰€æœ‰çš„insert/update/deleteéƒ½è®¿é—®masteråº“ï¼Œæ‰€æœ‰çš„select éƒ½è®¿é—®salveåº“ï¼Œè¿™æ ·å¯¹äºdaoå±‚éƒ½æ˜¯é€æ˜ã€‚ pluginå®ç°æ—¶å¯ä»¥é€šè¿‡æ³¨è§£æˆ–è€…åˆ†æè¯­å¥æ˜¯è¯»å†™æ–¹æ³•æ¥é€‰å®šä¸»ä»åº“ã€‚ä¸è¿‡è¿™æ ·ä¾ç„¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ ä¹Ÿå°±æ˜¯ä¸æ”¯æŒäº‹åŠ¡ï¼Œ æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦é‡å†™ä¸€ä¸‹DataSourceTransactionManagerï¼Œ å°†read-onlyçš„äº‹åŠ¡æ‰”è¿›è¯»åº“ï¼Œ å…¶ä½™çš„æœ‰è¯»æœ‰å†™çš„æ‰”è¿›å†™åº“ã€‚ æ–¹æ¡ˆä¸‰ ä½¿ç”¨AbstractRoutingDataSource+aop+annotationåœ¨serviceå±‚å†³å®šæ•°æ®æºï¼Œå¯ä»¥æ”¯æŒäº‹åŠ¡. ç¼ºç‚¹ï¼šç±»å†…éƒ¨æ–¹æ³•é€šè¿‡this.xx()æ–¹å¼ç›¸äº’è°ƒç”¨æ—¶ï¼Œaopä¸ä¼šè¿›è¡Œæ‹¦æˆªï¼Œéœ€è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚ ","date":"2022-04-26","objectID":"/mysql/:29:6","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"å¤‡ä»½è®¡åˆ’ï¼Œmysqldumpä»¥åŠxtranbackupçš„å®ç°åŸç† (1)å¤‡ä»½è®¡åˆ’ è§†åº“çš„å¤§å°æ¥å®šï¼Œä¸€èˆ¬æ¥è¯´ 100G å†…çš„åº“ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ mysqldump æ¥åšï¼Œå› ä¸º mysqldumpæ›´åŠ è½»å·§çµæ´»ï¼Œå¤‡ä»½æ—¶é—´é€‰åœ¨ä¸šåŠ¡ä½å³°æœŸï¼Œå¯ä»¥æ¯å¤©è¿›è¡Œéƒ½è¿›è¡Œå…¨é‡å¤‡ä»½(mysqldump å¤‡ä»½å‡ºæ¥çš„æ–‡ä»¶æ¯”è¾ƒå°ï¼Œå‹ç¼©ä¹‹åæ›´å°)ã€‚ 100G ä»¥ä¸Šçš„åº“ï¼Œå¯ä»¥è€ƒè™‘ç”¨ xtranbackup æ¥åšï¼Œå¤‡ä»½é€Ÿåº¦æ˜æ˜¾è¦æ¯” mysqldump è¦å¿«ã€‚ä¸€èˆ¬æ˜¯é€‰æ‹©ä¸€å‘¨ä¸€ä¸ªå…¨å¤‡ï¼Œå…¶ä½™æ¯å¤©è¿›è¡Œå¢é‡å¤‡ä»½ï¼Œå¤‡ä»½æ—¶é—´ä¸ºä¸šåŠ¡ä½å³°æœŸã€‚ (2)å¤‡ä»½æ¢å¤æ—¶é—´ ç‰©ç†å¤‡ä»½æ¢å¤å¿«ï¼Œé€»è¾‘å¤‡ä»½æ¢å¤æ…¢ è¿™é‡Œè·Ÿæœºå™¨ï¼Œå°¤å…¶æ˜¯ç¡¬ç›˜çš„é€Ÿç‡æœ‰å…³ç³»ï¼Œä»¥ä¸‹åˆ—ä¸¾å‡ ä¸ªä»…ä¾›å‚è€ƒ 20Gçš„2åˆ†é’Ÿï¼ˆmysqldumpï¼‰ 80Gçš„30åˆ†é’Ÿ(mysqldump) 111Gçš„30åˆ†é’Ÿï¼ˆmysqldump) 288Gçš„3å°æ—¶ï¼ˆxtra) 3Tçš„4å°æ—¶ï¼ˆxtra) é€»è¾‘å¯¼å…¥æ—¶é—´ä¸€èˆ¬æ˜¯å¤‡ä»½æ—¶é—´çš„5å€ä»¥ä¸Š (3)å¤‡ä»½æ¢å¤å¤±è´¥å¦‚ä½•å¤„ç† é¦–å…ˆåœ¨æ¢å¤ä¹‹å‰å°±åº”è¯¥åšè¶³å‡†å¤‡å·¥ä½œï¼Œé¿å…æ¢å¤çš„æ—¶å€™å‡ºé”™ã€‚æ¯”å¦‚è¯´å¤‡ä»½ä¹‹åçš„æœ‰æ•ˆæ€§æ£€æŸ¥ã€æƒé™æ£€æŸ¥ã€ç©ºé—´æ£€æŸ¥ç­‰ã€‚å¦‚æœä¸‡ä¸€æŠ¥é”™ï¼Œå†æ ¹æ®æŠ¥é”™çš„æç¤ºæ¥è¿›è¡Œç›¸åº”çš„è°ƒæ•´ã€‚ (4)mysqldumpå’Œxtrabackupå®ç°åŸç† mysqldump mysqldump å±äºé€»è¾‘å¤‡ä»½ã€‚åŠ å…¥â€“single-transaction é€‰é¡¹å¯ä»¥è¿›è¡Œä¸€è‡´æ€§å¤‡ä»½ã€‚åå°è¿›ç¨‹ä¼šå…ˆè®¾ç½® session çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸º RR(SET SESSION TRANSACTION ISOLATION LEVELREPEATABLE READ)ï¼Œä¹‹åæ˜¾å¼å¼€å¯ä¸€ä¸ªäº‹åŠ¡(START TRANSACTION /*!40100 WITH CONSISTENTSNAPSHOT */)ï¼Œè¿™æ ·å°±ä¿è¯äº†è¯¥äº‹åŠ¡é‡Œè¯»åˆ°çš„æ•°æ®éƒ½æ˜¯äº‹åŠ¡äº‹åŠ¡æ—¶å€™çš„å¿«ç…§ã€‚ä¹‹åå†æŠŠè¡¨çš„æ•°æ®è¯»å–å‡ºæ¥ã€‚å¦‚æœåŠ ä¸Šâ€“master-data=1 çš„è¯ï¼Œåœ¨åˆšå¼€å§‹çš„æ—¶å€™è¿˜ä¼šåŠ ä¸€ä¸ªæ•°æ®åº“çš„è¯»é”(FLUSH TABLES WITH READ LOCK),ç­‰å¼€å¯äº‹åŠ¡åï¼Œå†è®°å½•ä¸‹æ•°æ®åº“æ­¤æ—¶ binlog çš„ä½ç½®(showmaster status)ï¼Œé©¬ä¸Šè§£é”ï¼Œå†è¯»å–è¡¨çš„æ•°æ®ã€‚ç­‰æ‰€æœ‰çš„æ•°æ®éƒ½å·²ç»å¯¼å®Œï¼Œå°±å¯ä»¥ç»“æŸäº‹åŠ¡ Xtrabackup: xtrabackup å±äºç‰©ç†å¤‡ä»½ï¼Œç›´æ¥æ‹·è´è¡¨ç©ºé—´æ–‡ä»¶ï¼ŒåŒæ—¶ä¸æ–­æ‰«æäº§ç”Ÿçš„ redo æ—¥å¿—å¹¶ä¿å­˜ä¸‹æ¥ã€‚æœ€åå®Œæˆ innodb çš„å¤‡ä»½åï¼Œä¼šåšä¸€ä¸ª flush engine logs çš„æ“ä½œ(è€ç‰ˆæœ¬åœ¨æœ‰ bugï¼Œåœ¨5.6 ä¸Šä¸åšæ­¤æ“ä½œä¼šä¸¢æ•°æ®)ï¼Œç¡®ä¿æ‰€æœ‰çš„ redo log éƒ½å·²ç»è½ç›˜(æ¶‰åŠåˆ°äº‹åŠ¡çš„ä¸¤é˜¶æ®µæäº¤ æ¦‚å¿µï¼Œå› ä¸º xtrabackup å¹¶ä¸æ‹·è´ binlogï¼Œæ‰€ä»¥å¿…é¡»ä¿è¯æ‰€æœ‰çš„ redo log éƒ½è½ç›˜ï¼Œå¦åˆ™å¯èƒ½ä¼šä¸¢æœ€åä¸€ç»„æäº¤äº‹åŠ¡çš„æ•°æ®)ã€‚è¿™ä¸ªæ—¶é—´ç‚¹å°±æ˜¯ innodb å®Œæˆå¤‡ä»½çš„æ—¶é—´ç‚¹ï¼Œæ•°æ®æ–‡ä»¶è™½ç„¶ä¸æ˜¯ä¸€è‡´æ€§çš„ï¼Œä½†æ˜¯æœ‰è¿™æ®µæ—¶é—´çš„ redo å°±å¯ä»¥è®©æ•°æ®æ–‡ä»¶è¾¾åˆ°ä¸€è‡´æ€§(æ¢å¤çš„æ—¶å€™åšçš„äº‹ æƒ…)ã€‚ç„¶åè¿˜éœ€è¦ flush tables with read lockï¼ŒæŠŠ myisam ç­‰å…¶ä»–å¼•æ“çš„è¡¨ç»™å¤‡ä»½å‡ºæ¥ï¼Œå¤‡ä»½å®Œåè§£é”ã€‚è¿™æ ·å°±åšåˆ°äº†å®Œç¾çš„çƒ­å¤‡ã€‚ ","date":"2022-04-26","objectID":"/mysql/:29:7","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"æ•°æ®è¡¨æŸåçš„ä¿®å¤æ–¹å¼æœ‰å“ªäº›ï¼Ÿ ä½¿ç”¨ myisamchk æ¥ä¿®å¤ï¼Œå…·ä½“æ­¥éª¤ï¼š 1ï¼‰ä¿®å¤å‰å°†mysqlæœåŠ¡åœæ­¢ã€‚ 2ï¼‰æ‰“å¼€å‘½ä»¤è¡Œæ–¹å¼ï¼Œç„¶åè¿›å…¥åˆ°mysqlçš„/binç›®å½•ã€‚ 3ï¼‰æ‰§è¡Œmyisamchk â€“recover æ•°æ®åº“æ‰€åœ¨è·¯å¾„/*.MYI ä½¿ç”¨repair table æˆ–è€… OPTIMIZE tableå‘½ä»¤æ¥ä¿®å¤ï¼ŒREPAIR TABLE table_name ä¿®å¤è¡¨ OPTIMIZE TABLE table_name ä¼˜åŒ–è¡¨ REPAIR TABLE ç”¨äºä¿®å¤è¢«ç ´åçš„è¡¨ã€‚ OPTIMIZE TABLE ç”¨äºå›æ”¶é—²ç½®çš„æ•°æ®åº“ç©ºé—´ï¼Œå½“è¡¨ä¸Šçš„æ•°æ®è¡Œè¢«åˆ é™¤æ—¶ï¼Œæ‰€å æ®çš„ç£ç›˜ç©ºé—´å¹¶æ²¡æœ‰ç«‹å³è¢«å›æ”¶ï¼Œä½¿ç”¨äº†OPTIMIZE TABLEå‘½ä»¤åè¿™äº›ç©ºé—´å°†è¢«å›æ”¶ï¼Œå¹¶ä¸”å¯¹ç£ç›˜ä¸Šçš„æ•°æ®è¡Œè¿›è¡Œé‡æ’ï¼ˆæ³¨æ„ï¼šæ˜¯ç£ç›˜ä¸Šï¼Œè€Œéæ•°æ®åº“ï¼‰ InnoDBå’ŒMyISAMçš„æœ€å¤§ä¸åŒç‚¹æœ‰ä¸¤ä¸ªï¼šä¸€ï¼ŒInnoDBæ”¯æŒäº‹åŠ¡(transaction)ï¼›äºŒï¼Œé»˜è®¤é‡‡ç”¨è¡Œçº§é”ã€‚åŠ é”å¯ä»¥ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼Œå¯è°“æ˜¯æœ‰äºº(é”)çš„åœ°æ–¹ï¼Œå°±æœ‰æ±Ÿæ¹–(äº‹åŠ¡) mysql è¡Œé” è¡Œé”çš„åŠ£åŠ¿ï¼šå¼€é”€å¤§ï¼›åŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é” è¡Œé”çš„ä¼˜åŠ¿ï¼šé”çš„ç²’åº¦å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡ä½ï¼›å¤„ç†å¹¶å‘çš„èƒ½åŠ›å¼º åŠ é”çš„æ–¹å¼ï¼šè‡ªåŠ¨åŠ é”ã€‚å¯¹äºUPDATEã€DELETEå’ŒINSERTè¯­å¥ï¼ŒInnoDBä¼šè‡ªåŠ¨ç»™æ¶‰åŠæ•°æ®é›†åŠ æ’ä»–é”ï¼›å¯¹äºæ™®é€šSELECTè¯­å¥ï¼ŒInnoDBä¸ä¼šåŠ ä»»ä½•é”ï¼›å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ˜¾ç¤ºçš„åŠ é”ï¼š å…±äº«é”ï¼šselect * from tableName where â€¦ + lock in share more æ’ä»–é”ï¼šselect * from tableName where â€¦ + for update ","date":"2022-04-26","objectID":"/mysql/:29:8","tags":["é¢è¯•"],"title":"Mysql","uri":"/mysql/"},{"categories":["é¢è¯•"],"content":"Golangç²¾ç¼–100é¢˜ èƒ½åŠ›æ¨¡å‹ çº§åˆ« æ¨¡å‹ åˆçº§ primary: ç†Ÿæ‚‰åŸºæœ¬è¯­æ³•ï¼Œèƒ½å¤Ÿçœ‹æ‡‚ä»£ç çš„æ„å›¾ï¼› åœ¨ä»–äººæŒ‡å¯¼ä¸‹èƒ½å¤Ÿå®Œæˆç”¨æˆ·æ•…äº‹çš„å¼€å‘ï¼Œç¼–å†™çš„ä»£ç ç¬¦åˆCleanCodeè§„èŒƒï¼› ä¸­çº§ intermediate: èƒ½å¤Ÿç‹¬ç«‹å®Œæˆç”¨æˆ·æ•…äº‹çš„å¼€å‘å’Œæµ‹è¯•ï¼› èƒ½å¤Ÿå—…å‡ºä»£ç çš„åå‘³é“ï¼Œå¹¶çŸ¥é“å¦‚ä½•é‡æ„è¾¾æˆç›®æ ‡ï¼› é«˜çº§ senior: èƒ½å¤Ÿå¼€å‘å‡ºé«˜è´¨é‡é«˜æ€§èƒ½çš„ä»£ç ï¼› èƒ½å¤Ÿç†Ÿç»ƒä½¿ç”¨é«˜çº§ç‰¹æ€§ï¼Œå¼€å‘ç¼–ç¨‹æ¡†æ¶æˆ–æµ‹è¯•æ¡†æ¶ï¼› ","date":"2022-04-20","objectID":"/100%E9%A2%98/:0:0","tags":["é¢è¯•"],"title":"100é¢˜","uri":"/100%E9%A2%98/"},{"categories":["é¢è¯•"],"content":"é€‰æ‹©é¢˜ 1. ã€åˆçº§ã€‘ä¸‹é¢å±äºå…³é”®å­—çš„æ˜¯ï¼ˆï¼‰ A. func B. def C. struct D. class å‚è€ƒç­”æ¡ˆï¼šAC 2. ã€åˆçº§ã€‘å®šä¹‰ä¸€ä¸ªåŒ…å†…å…¨å±€å­—ç¬¦ä¸²å˜é‡ï¼Œä¸‹é¢è¯­æ³•æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. var str string B. str := \"\" C. str = \"\" D. var str = \"\" å‚è€ƒç­”æ¡ˆï¼šAD ã€åˆçº§ã€‘é€šè¿‡æŒ‡é’ˆå˜é‡ p è®¿é—®å…¶æˆå‘˜å˜é‡ nameï¼Œä¸‹é¢è¯­æ³•æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. p.name B. (*p).name C. (\u0026p).name D. p-\u003ename å‚è€ƒç­”æ¡ˆï¼šAB 4. ã€åˆçº§ã€‘å…³äºæ¥å£å’Œç±»çš„è¯´æ³•ï¼Œä¸‹é¢è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. ä¸€ä¸ªç±»åªéœ€è¦å®ç°äº†æ¥å£è¦æ±‚çš„æ‰€æœ‰å‡½æ•°ï¼Œæˆ‘ä»¬å°±è¯´è¿™ä¸ªç±»å®ç°äº†è¯¥æ¥å£ B. å®ç°ç±»çš„æ—¶å€™ï¼Œåªéœ€è¦å…³å¿ƒè‡ªå·±åº”è¯¥æä¾›å“ªäº›æ–¹æ³•ï¼Œä¸ç”¨å†çº ç»“æ¥å£éœ€è¦æ‹†å¾—å¤šç»†æ‰åˆç† C. ç±»å®ç°æ¥å£æ—¶ï¼Œéœ€è¦å¯¼å…¥æ¥å£æ‰€åœ¨çš„åŒ… D. æ¥å£ç”±ä½¿ç”¨æ–¹æŒ‰è‡ªèº«éœ€æ±‚æ¥å®šä¹‰ï¼Œä½¿ç”¨æ–¹æ— éœ€å…³å¿ƒæ˜¯å¦æœ‰å…¶ä»–æ¨¡å—å®šä¹‰è¿‡ç±»ä¼¼çš„æ¥å£ å‚è€ƒç­”æ¡ˆï¼šABD 5. ã€åˆçº§ã€‘å…³äºå­—ç¬¦ä¸²è¿æ¥ï¼Œä¸‹é¢è¯­æ³•æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. str := â€˜abcâ€™ + â€˜123â€™ B. str := \"abc\" + \"123\" C. str ï¼š= '123' + \"abc\" D. fmt.Sprintf(\"abc%d\", 123) å‚è€ƒç­”æ¡ˆï¼šBD 6. ã€åˆçº§ã€‘å…³äºåç¨‹ï¼Œä¸‹é¢è¯´æ³•æ­£ç¡®æ˜¯ï¼ˆï¼‰ A. åç¨‹å’Œçº¿ç¨‹éƒ½å¯ä»¥å®ç°ç¨‹åºçš„å¹¶å‘æ‰§è¡Œ B. çº¿ç¨‹æ¯”åç¨‹æ›´è½»é‡çº§ C. åç¨‹ä¸å­˜åœ¨æ­»é”é—®é¢˜ D. é€šè¿‡channelæ¥è¿›è¡Œåç¨‹é—´çš„é€šä¿¡ å‚è€ƒç­”æ¡ˆï¼šAD 7. ã€ä¸­çº§ã€‘å…³äºinitå‡½æ•°ï¼Œä¸‹é¢è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. ä¸€ä¸ªåŒ…ä¸­ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªinitå‡½æ•° B. ç¨‹åºç¼–è¯‘æ—¶ï¼Œå…ˆæ‰§è¡Œå¯¼å…¥åŒ…çš„initå‡½æ•°ï¼Œå†æ‰§è¡Œæœ¬åŒ…å†…çš„initå‡½æ•° C. mainåŒ…ä¸­ï¼Œä¸èƒ½æœ‰initå‡½æ•° D. initå‡½æ•°å¯ä»¥è¢«å…¶ä»–å‡½æ•°è°ƒç”¨ å‚è€ƒç­”æ¡ˆï¼šAB 8. ã€åˆçº§ã€‘å…³äºå¾ªç¯è¯­å¥ï¼Œä¸‹é¢è¯´æ³•æ­£ç¡®çš„æœ‰ï¼ˆï¼‰ A. å¾ªç¯è¯­å¥æ—¢æ”¯æŒforå…³é”®å­—ï¼Œä¹Ÿæ”¯æŒwhileå’Œdo-while B. å…³é”®å­—forçš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ä¸C/C++ä¸­æ²¡æœ‰ä»»ä½•å·®å¼‚ C. forå¾ªç¯æ”¯æŒcontinueå’Œbreakæ¥æ§åˆ¶å¾ªç¯ï¼Œä½†æ˜¯å®ƒæä¾›äº†ä¸€ä¸ªæ›´é«˜çº§çš„breakï¼Œå¯ä»¥é€‰æ‹©ä¸­æ–­å“ªä¸€ä¸ªå¾ªç¯ D. forå¾ªç¯ä¸æ”¯æŒä»¥é€—å·ä¸ºé—´éš”çš„å¤šä¸ªèµ‹å€¼è¯­å¥ï¼Œå¿…é¡»ä½¿ç”¨å¹³è¡Œèµ‹å€¼çš„æ–¹å¼æ¥åˆå§‹åŒ–å¤šä¸ªå˜é‡ å‚è€ƒç­”æ¡ˆï¼šCD 9. ã€ä¸­çº§ã€‘å¯¹äºå‡½æ•°å®šä¹‰ï¼š func add(args ...int) int { sum :=0 for _,arg := range args {//undefined sum += arg } returnsum } ä¸‹é¢å¯¹addå‡½æ•°è°ƒç”¨æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. add(1, 2) B. add(1, 3, 7) C. add([]int{1, 2}) D. add([]int{1, 3, 7}...) å‚è€ƒç­”æ¡ˆï¼šABD 16. ã€åˆçº§ã€‘å…³äºç±»å‹è½¬åŒ–ï¼Œä¸‹é¢è¯­æ³•æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. 17. type MyInt int 18. var i int = 1 var jMyInt = i B. type MyIntint var i int= 1 var jMyInt = (MyInt)i C. type MyIntint var i int= 1 var jMyInt = MyInt(i) D. type MyIntint var i int= 1 var jMyInt = i.(MyInt) å‚è€ƒç­”æ¡ˆï¼šC 19. ã€åˆçº§ã€‘å…³äºå±€éƒ¨å˜é‡çš„åˆå§‹åŒ–ï¼Œä¸‹é¢æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼æ˜¯ï¼ˆï¼‰ A. var i int = 10 B. var i = 10 C. i := 10 D. i = 10 å‚è€ƒç­”æ¡ˆï¼šABC 20. ã€åˆçº§ã€‘å…³äºconstå¸¸é‡å®šä¹‰ï¼Œä¸‹é¢æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼æ˜¯ï¼ˆï¼‰ A. 21. const Pi float64 = 3.14159265358979323846 const zero= 0.0 B. const ( size int64= 1024 eof = -1 ) C. const ( ERR_ELEM_EXISTerror = errors.New(\"element already exists\") ERR_ELEM_NT_EXISTerror = errors.New(\"element not exists\") ) D. const u, vfloat32 = 0, 3 const a,b, c = 3, 4, \"foo\" å‚è€ƒç­”æ¡ˆï¼šABD 22. ã€åˆçº§ã€‘å…³äºå¸ƒå°”å˜é‡bçš„èµ‹å€¼ï¼Œä¸‹é¢é”™è¯¯çš„ç”¨æ³•æ˜¯ï¼ˆï¼‰ A. b = true B. b = 1 C. b = bool(1) D. b = (1 == 2) å‚è€ƒç­”æ¡ˆï¼šBC 23. ã€ä¸­çº§ã€‘ä¸‹é¢çš„ç¨‹åºçš„è¿è¡Œç»“æœæ˜¯ï¼ˆï¼‰ 24. func main() { 25. if (true) { 26. defer fmt.Printf(\"1\") 27. } else { 28. defer fmt.Printf(\"2\") 29. } 30. fmt.Printf(\"3\") } A. 321 B. 32 C. 31 D. 13 å‚è€ƒç­”æ¡ˆï¼šC 31. ã€åˆçº§ã€‘å…³äºswitchè¯­å¥ï¼Œä¸‹é¢è¯´æ³•æ­£ç¡®çš„æœ‰ï¼ˆï¼‰ A. æ¡ä»¶è¡¨è¾¾å¼å¿…é¡»ä¸ºå¸¸é‡æˆ–è€…æ•´æ•° B. å•ä¸ªcaseä¸­ï¼Œå¯ä»¥å‡ºç°å¤šä¸ªç»“æœé€‰é¡¹ C. éœ€è¦ç”¨breakæ¥æ˜ç¡®é€€å‡ºä¸€ä¸ªcase D. åªæœ‰åœ¨caseä¸­æ˜ç¡®æ·»åŠ fallthroughå…³é”®å­—ï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œç´§è·Ÿçš„ä¸‹ä¸€ä¸ªcase å‚è€ƒç­”æ¡ˆï¼šBD 32. ã€ä¸­çº§ã€‘ golangä¸­æ²¡æœ‰éšè—çš„thisæŒ‡é’ˆï¼Œè¿™å¥è¯çš„å«ä¹‰æ˜¯ï¼ˆï¼‰ A. æ–¹æ³•æ–½åŠ çš„å¯¹è±¡æ˜¾å¼ä¼ é€’ï¼Œæ²¡æœ‰è¢«éšè—èµ·æ¥ B. golangæ²¿è¢­äº†ä¼ ç»Ÿé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„è¯¸å¤šæ¦‚å¿µï¼Œæ¯”å¦‚ç»§æ‰¿ã€è™šå‡½æ•°å’Œæ„é€ å‡½æ•° C. golangçš„é¢å‘å¯¹è±¡è¡¨è¾¾æ›´ç›´è§‚ï¼Œå¯¹äºé¢å‘è¿‡ç¨‹åªæ˜¯æ¢äº†ä¸€ç§è¯­æ³•å½¢å¼æ¥è¡¨è¾¾ D. æ–¹æ³•æ–½åŠ çš„å¯¹è±¡ä¸éœ€è¦éå¾—æ˜¯æŒ‡é’ˆï¼Œä¹Ÿä¸ç”¨éå¾—å«this å‚è€ƒç­”æ¡ˆï¼šACD 33. ã€ä¸­çº§ã€‘ golangä¸­çš„å¼•ç”¨ç±»å‹åŒ…æ‹¬ï¼ˆï¼‰ A. æ•°ç»„åˆ‡ç‰‡ B. map C. channel D. interface å‚è€ƒç­”æ¡ˆï¼šABCD 34. ã€ä¸­çº§ã€‘ golangä¸­çš„æŒ‡é’ˆè¿ç®—åŒ…æ‹¬ï¼ˆï¼‰ A. å¯ä»¥å¯¹æŒ‡é’ˆè¿›è¡Œè‡ªå¢æˆ–è‡ªå‡è¿ç®— B. å¯ä»¥é€šè¿‡â€œ\u0026â€å–æŒ‡é’ˆçš„åœ°å€ C. å¯ä»¥é€šè¿‡â€œ*â€å–æŒ‡é’ˆæŒ‡å‘çš„æ•°æ® D. å¯ä»¥å¯¹æŒ‡é’ˆè¿›è¡Œä¸‹æ ‡è¿ç®— å‚è€ƒç­”æ¡ˆï¼šBC 35. ã€åˆçº§ã€‘å…³äºmainå‡½æ•°ï¼ˆå¯æ‰§è¡Œç¨‹åºçš„æ‰§è¡Œèµ·ç‚¹ï¼‰ï¼Œä¸‹é¢è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. mainå‡½æ•°ä¸èƒ½å¸¦å‚æ•° B. mainå‡½æ•°ä¸èƒ½å®šä¹‰è¿”å›å€¼ C. mainå‡½æ•°æ‰€åœ¨çš„åŒ…å¿…é¡»ä¸ºmainåŒ… D. mainå‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨flagåŒ…æ¥è·å–å’Œè§£æå‘½ä»¤è¡Œå‚æ•° å‚è€ƒç­”æ¡ˆï¼šABCD 36. ã€ä¸­çº§ã€‘ä¸‹é¢èµ‹å€¼æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. var x = nil B. var x interface{} = nil C. var x string = nil D. var x error = nil å‚è€ƒç­”æ¡ˆï¼šBD 37. ã€ä¸­çº§ã€‘å…³äºæ•´å‹åˆ‡ç‰‡çš„åˆå§‹åŒ–ï¼Œä¸‹é¢æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. s := make([]int) B. s := make([]int, 0) C. s := make([]int, 5, 10) D. s := []int{1, 2, 3, 4, 5} å‚è€ƒç­”æ¡ˆï¼šBCD 38. ã€ä¸­çº§ã€‘ä»åˆ‡ç‰‡ä¸­åˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼Œä¸‹é¢çš„ç®—æ³•å®ç°æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. 39. func (s *Slice)Remove(value interface{})error { 40. for i, v := range *s { 41. if isEqual(value, v) {undefined 42. if i== len(*s) - 1 {undefined 43. *s = (*s)[:i] 44. }else {undefined 45. *s = append((*s)[:i],(*s)[i + 2:]...) 46. } 47. return nil 48. } 49. } 50. return ERR_ELEM_NT_EXIST } B. func (s*Slice)Remove(value interface{}) error { for i, v:= range *s { if isEqual(value, v) {undefined *s =append((*s)[:i],(*s)[i + 1:]) return nil } } returnERR_ELEM_NT_EXIST } C. func (s*Slice)Remove(value interface{}) error { for i, v:= range *s { if isEqual(value, v) {undefined delete(*s, v) return nil } } returnERR_ELEM_NT_EXIST } D. func (s*Slice)Remove(value interface{}) error { for i, v:= range *s { if isEqual(value, v) {undefined *s =append((*s)[:i],(*s)[i + 1:]...) return nil } } returnERR_ELEM_NT_EXIST } å‚è€ƒç­”æ¡ˆï¼šD 51. ã€åˆçº§ã€‘å¯¹äºå±€éƒ¨å˜é‡æ•´å‹åˆ‡ç‰‡xçš„èµ‹å€¼ï¼Œä¸‹é¢å®šä¹‰æ­£ç¡®çš„æ˜¯ï¼ˆï¼‰ A. 52. x := []int{ 53. 1, 2, 3, 54. 4, 5, 6, } B. x :=[]in","date":"2022-04-20","objectID":"/100%E9%A2%98/:1:0","tags":["é¢è¯•"],"title":"100é¢˜","uri":"/100%E9%A2%98/"},{"categories":["é¢è¯•"],"content":"interfaceçš„åº•å±‚å®ç° æ‰€æœ‰interfaceï¼ŒåŒ…æ‹¬æœ‰æ–¹æ³•å’Œç©ºæ¥å£ï¼Œåœ¨å†…å­˜ä¸­éƒ½æ˜¯å æ®ä¸¤ä¸ªå­—é•¿ï¼Œåœ¨32ä½æœºå™¨ä¸Šå°±æ˜¯8ä¸ªå­—èŠ‚ï¼Œåœ¨64ä½æœºå™¨ä¸Šå°±æ˜¯16ä¸ªå­—èŠ‚ã€‚ runtime.efaceï¼š type eface struct{ _type *_type // æ•°æ®çš„çœŸå®ç±»å‹ data unsafe.Pointer } ç©ºæ¥å£ç”±ä¸¤ä¸ªæŒ‡é’ˆç»„æˆï¼Œ_typeè¡¨ç¤ºæ¥å£çš„ç±»å‹ç›¸å…³çš„ä¿¡æ¯ï¼Œdataè¡¨ç¤ºæ•°æ®çš„æŒ‡é’ˆã€‚ type _type struct { size uintptr // å†…å­˜å¤§å° ptrdata uintptr // å†…å­˜å‰ç¼€å¤§å° hash uint32 // ç±»å‹çš„hashå€¼ tflag tflag // ç±»å‹ä¿¡æ¯æ ‡å¿—ï¼Œå’Œåå°„ç›¸å…³ align uint8 // å†…å­˜å¯¹é½å¤§å° fieldalign uint8 // ç»“æ„ä½“å­—æ®µå†…å­˜å¯¹é½å¤§å° kind uint8 // ç±»åˆ« equal func(unsafe.Pointer, unsafe.Pointer) bool // gcdata stores the GC type data for the garbage collector. // If the KindGCProg bit is set in kind, gcdata is a GC program. // Otherwise it is a ptrmask bitmap. See mbitmap.go for details. gcdata *byte // gcç›¸å…³ str nameOff ptrToThis typeOff } runtime.iface type iface struct { tab *itab data unsafe.Pointer } æœ‰æ–¹æ³•çš„æ¥å£ä¹Ÿç”±ä¸¤ä¸ªæŒ‡é’ˆç»„æˆï¼Œtabå­˜æ”¾æ¥å£çš„ç±»å‹ä»¥åŠæ–¹æ³•è¡¨ï¼Œdataè¡¨ç¤ºæ•°æ®çš„æŒ‡é’ˆ type itab struct { inter *interfacetype // æ¥å£ç±»å‹ï¼ˆæ¯”å¦‚Birdï¼‰ _type *_type // æ•°æ®çœŸå®ç±»å‹ï¼ŒåŠ¨æ€ç±»å‹ï¼ˆæ¯”å¦‚Sparrowï¼‰ hash uint32 // copy of _type.hash. Used for type switches. _ [4]byte fun [1]uintptr // variable sized. fun[0]==0 means _type does not implement inter. } type nameOff int32 type typeOff int32 type imethod struct { name nameOff ityp typeOff } type interfacetype struct { typ _type // å…·ä½“çš„ç±»å‹ pkgpath name // æ¥å£çš„åŒ…å mhdr []imethod //æ¥å£å®šä¹‰çš„å‡½æ•°åˆ—è¡¨ } itabä¸­ inter è¡¨ç¤ºæ¥å£ç±»å‹ï¼ŒåŒ…å«ç±»å‹ã€åŒ…åã€æ–¹æ³•ç­‰ä¿¡æ¯ï¼Œ_type è¡¨ç¤ºæ•°æ®çš„çœŸå®ç±»å‹ã€‚ funå­—æ®µä¸ºä¸æ¥å£æ–¹æ³•å¯¹åº”çš„å…·ä½“æ•°æ®ç±»å‹çš„æ–¹æ³•åœ°å€ï¼Œfunçš„æ•°ç»„å¤§å°ä¸º1ï¼Œå­˜æ”¾çš„æ˜¯ç¬¬ä¸€ä¸ªæ–¹æ³•çš„åœ°å€ï¼Œå¦‚æœæœ‰å¤šä¸ªæ–¹æ³•ï¼Œå› ä¸ºå†…å­˜æ˜¯è¿ç»­çš„ï¼Œå¯ä»¥é€šè¿‡å¢åŠ æŒ‡é’ˆè·å–åé¢çš„æ–¹æ³•åœ°å€ã€‚ reflect.Typeof() è¿”å›çš„æ˜¯æ•°æ®çš„çœŸå®ç±»å‹ã€‚ ","date":"2022-04-13","objectID":"/interface/:1:0","tags":["é¢è¯•"],"title":"Interface","uri":"/interface/"},{"categories":["é¢è¯•"],"content":"interfaceçš„ç±»å‹è½¬æ¢ func main() { var x int64 = 1 var a interface{} = x fmt.Println(a) } è¿™æ®µä»£ç å°†int64çš„xèµ‹å€¼ç»™aï¼Œå°†å‘ç”Ÿç±»å‹è½¬æ¢ã€‚æ‰“å°å…¶æ±‡ç¼–ä»£ç ï¼š go tool compile -S mian.go \u003e mian.s è§‚å¯Ÿæ±‡ç¼–å¯ä»¥å‘ç°ï¼Œåœ¨æ‰§è¡Œ var a interface{} = xçš„æ—¶å€™ï¼Œå‘ç°å…¶è°ƒç”¨äº†runtime.convT64(SB)æ–¹æ³•ã€‚ å®é™…ä¸Šæ ¹æ®æ‰€èµ‹ä¸å€¼çš„ç±»å‹çš„ä¸åŒï¼Œä¼šè°ƒç”¨ä¸åŒçš„è½¬æ¢æ–¹æ³•ï¼Œç±»ä¼¼çš„è¿˜æœ‰ convTstringï¼ŒconvT32ç­‰ã€‚ ","date":"2022-04-13","objectID":"/interface/:2:0","tags":["é¢è¯•"],"title":"Interface","uri":"/interface/"},{"categories":["é¢è¯•"],"content":"ç±»å‹æ–­è¨€ var any interface{} = 1 i,ok := any.(int) var any interface{} switch any.(type){ case int: fmt.Println(\"type int\") case string: fmt.Println(\"type string) default: fmt.Println(\"type unknow) } ç±»å‹æ–­è¨€interfaceçš„ç±»å‹å°±æ˜¯å®ƒçš„æ•°æ®çœŸå®ç±»å‹ã€‚ä¾‹å¦‚ï¼š type a int64 func main(){ var i interface{} = a(1) // içš„çœŸå®æ•°æ®ç±»å‹ä¸º main.aè€Œä¸æ˜¯int64 fmt.Println(i.(a)) } ç±»å‹æ–­è¨€å‚è€ƒï¼šruntime.assertxx æ–¹æ³•çš„å®ç°ã€‚ ","date":"2022-04-13","objectID":"/interface/:3:0","tags":["é¢è¯•"],"title":"Interface","uri":"/interface/"},{"categories":["é¢è¯•"],"content":"æŒ‡é’ˆæ¥æ”¶è€…è¿˜æ˜¯å€¼æ¥æ”¶è€…ï¼Ÿ å…ˆçœ‹æŒ‡é’ˆæ¥æ”¶è€…å’Œå€¼æ¥æ”¶è€…çš„åŒºåˆ«ï¼š å½“Flyçš„æ¥æ”¶è€…ä¸ºå€¼ç±»å‹æ—¶ï¼š type Bird interface { Fly() } type Sparrow struct { } func (Sparrow) Fly() { fmt.Println(\"sparrow fly\") } func main() { var s1 Bird = Sparrow{} s1.Fly() var s2 Bird = \u0026Sparrow{} s2.Fly() } æ‰“å°ç»“æœä¸ºï¼š sparrow fly sparrow fly å½“Flyçš„æ¥æ”¶è€…ä¸ºæŒ‡é’ˆç±»å‹æ—¶ï¼š func (*Sparrow) Fly() { fmt.Println(\"sparrow fly\") } func main() { var s1 Bird = Sparrow{} s1.Fly() var s2 Bird = \u0026Sparrow{} s2.Fly() } æ‰“å°ç»“æœä¸ºï¼š cannot use Sparrow literal (type Sparrow) as type Bird in assignment: Sparrow does not implement Bird (Fly method has pointer receiver) å¯ä»¥çœ‹å‡ºï¼Œå½“æ–¹æ³•çš„æ¥æ”¶è€…ä¸ºå€¼ç±»å‹æ—¶ï¼Œä¸ç®¡æ˜¯æŒ‡é’ˆç±»å‹çš„å€¼è¿˜æ˜¯å€¼ç±»å‹çš„å€¼éƒ½å¯ä»¥è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå› ä¸ºgoä¼šæŠŠæŒ‡é’ˆè¿›è¡Œéšå¼çš„è½¬æ¢å¾—åˆ°æŒ‡é’ˆçš„å€¼ï¼Œè€Œå½“æ–¹æ³•çš„æ¥æ”¶è€…ä¸ºæŒ‡é’ˆç±»å‹æ—¶ï¼Œå€¼ç±»å‹çš„å€¼è°ƒç”¨è¯¥æ–¹æ³•ä¼šæŠ¥é”™ã€‚ *ç±»å‹ T å˜é‡åªæœ‰æ¥å—è€…æ˜¯ T çš„æ–¹æ³•ï¼›è€Œç±»å‹ *Tå˜é‡æ‹¥æœ‰æ¥å—è€…æ˜¯ T å’Œ T çš„æ–¹æ³• é€‰æ‹©æŒ‡é’ˆæ¥æ”¶è€…ä¸»è¦è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š æœŸæœ›ä¿®æ”¹ç»“æ„ä½“çš„å€¼ å½“ç»“æ„ä½“æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œé¿å…æ¯æ¬¡éƒ½è¿›è¡Œå€¼æ‹·è´ é¿å…ç±»å‹å¯èƒ½ä¸ä¸ºç©ºçš„interfaceå’Œnilç›´æ¥è¿›è¡Œæ¯”è¾ƒï¼Œå› ä¸ºinterfaceåº•å±‚æ˜¯ç”±ç±»å‹å’Œå€¼ç»„æˆï¼Œå½“ä¸¤è€…éƒ½ä¸ºnilæ—¶ï¼Œä»–çš„å€¼æ‰ç­‰äºnilã€‚ var _ intertype= (*mytype)(nil)ï¼Œå®šä¹‰ä¸€ä¸ªç±»å‹å®ç°äº†æŸä¸ªæ¥å£æ—¶ï¼Œgoç¼–è¯‘å™¨å¯ä»¥æ£€æµ‹mytypeæ˜¯å¦å®ç°äº†intertypeæ¥å£ã€‚ ","date":"2022-04-13","objectID":"/interface/:4:0","tags":["é¢è¯•"],"title":"Interface","uri":"/interface/"},{"categories":["é¢è¯•"],"content":"æ¥å£çš„æ¯”è¾ƒ ä¸¤ä¸ªæ¥å£å¯ä»¥é€šè¿‡æ¯”è¾ƒè¿ç®—ç¬¦ == ï¼Œ**!=**æ¥è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœæ˜¯ä¸¤ä¸ªç©ºæ¥å£ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ€»æ˜¯ç›¸ç­‰çš„ã€‚æ‰€ä»¥ == æ“ä½œç¬¦è¿”å› trueã€‚ var a, b interface{} fmt.Println(a==b) // true fmt.Println(a!=b) // false å¦‚æœä¸¤ä¸ªä¸æ˜¯ç©ºæ¥å£ï¼Œé‚£ä¹ˆåªæœ‰å½“ä»–ä»¬çš„åŠ¨æ€ç±»å‹å’ŒåŠ¨æ€å€¼éƒ½ç›¸ç­‰çš„æƒ…å†µä¸‹ï¼Œä»–ä»¬æ‰ç›¸ç­‰ï¼ˆ==æ“ä½œç¬¦è¿”å›trueï¼‰ã€‚ ä¸Šé¢çš„æƒ…å†µéƒ½æ˜¯åŸºäºåŠ¨æ€ç±»å‹éƒ½èƒ½æ¯”è¾ƒçš„æƒ…å†µä¸‹è¿›è¡Œçš„ï¼Œå¦‚æœåŠ¨æ€ç±»å‹ä¸èƒ½æ¯”è¾ƒå‘¢ï¼ˆæ¯”å¦‚ï¼šsliceï¼Œmapï¼Œarrayï¼Œ functionå’Œç»“æ„ä½“ç­‰ï¼‰ï¼Œé‚£ä¹ˆï¼Œæ‰§è¡Œæ¯”è¾ƒæ“ä½œçš„æ—¶å€™ä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ã€‚ ","date":"2022-04-13","objectID":"/interface/:5:0","tags":["é¢è¯•"],"title":"Interface","uri":"/interface/"},{"categories":["é¢è¯•"],"content":"GMPæ¨¡å‹ ","date":"2022-04-12","objectID":"/gmp/:0:0","tags":["é¢è¯•"],"title":"GMP","uri":"/gmp/"},{"categories":["é¢è¯•"],"content":"M Mä»£è¡¨å†…æ ¸çº§çº¿ç¨‹,ä¸€ä¸ªMå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹,goroutineå°±æ˜¯è·‘åœ¨Mä¹‹ä¸Šçš„;Mæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç»“æ„,é‡Œé¢ç»´æŠ¤äº†å°å¯¹è±¡å†…å­˜cacheã€å½“å‰æ‰§è¡Œçš„goroutineã€éšæœºæ•°å‘ç”Ÿå™¨ ç­‰ç­‰ã€‚Mçš„PCå¯„å­˜å™¨å­˜å‚¨ç€æŒ‡å‘Gçš„å‡½æ•°ã€‚ type m struct { g0 *g // å¸¦æœ‰è°ƒåº¦æ ˆçš„goroutine gsignal *g // å¤„ç†ä¿¡å·çš„goroutine tls [6]uintptr mstartfn func() curg *g //å½“å‰è¿è¡Œçš„goroutine caughtsig guintptr p puintptr //å…³è”på’Œæ‰§è¡Œçš„goä»£ç  nextp puintptr id int32 mallocing int32 // çŠ¶æ€ spinning bool // mæ˜¯å¦out of work blocked bool // mæ˜¯å¦è¢«é˜»å¡ inwb bool // mæ˜¯å¦åœ¨æ‰§è¡Œå†™å±è”½ printlock int8 incgo bool //måœ¨æ‰§è¡Œcgoå— fastrand uint32 ncgocall uint64 // cgoè°ƒç”¨çš„æ€»æ•° ncgo int32 // å½“å‰cgoè°ƒç”¨çš„æ•°ç›® park note alllink *m // ç”¨äºé“¾æ¥allm schedlink muintptr mcache *mcache // å½“å‰mçš„å†…å­˜ç¼“å­˜ lockedg *g // é”å®šgåœ¨å½“å‰mä¸Šæ‰§è¡Œï¼Œè€Œä¸ä¼šåˆ‡æ¢åˆ°å…¶ä»–m createstack [32]uintptr // threadåˆ›å»ºçš„æ ˆ } ","date":"2022-04-12","objectID":"/gmp/:1:0","tags":["é¢è¯•"],"title":"GMP","uri":"/gmp/"},{"categories":["é¢è¯•"],"content":"G Gä»£è¡¨ä¸€ä¸ªgoroutine,å®ƒæœ‰ä¸€ä¸ªè‡ªå·±çš„æ ˆ,instrtuction pointerå’Œå…¶ä»–çš„ä¿¡æ¯(æ­£åœ¨ç­‰å¾…çš„channelç­‰ç­‰),ç”¨äºè°ƒåº¦ã€‚ type g struct { stack stack //æè¿°äº†çœŸå®çš„å†…å­˜,åŒ…æ‹¬ä¸Šä¸‹ç•Œ m *m // å½“å‰çš„m sced gobuf // goroutineåˆ‡æ¢æ—¶,ç”¨äºä¿å­˜gçš„ä¸Šä¸‹æ–‡ param unsafe.Pointer // ç”¨äºä¼ é€’å‚æ•°, ç¡çœ æ—¶å…¶ä»–goroutineå¯ä»¥è®¾ç½®param, å”¤é†’æ—¶è¯¥goroutineå¯ä»¥è·å– atomicstatus uint32 stackLock uint32 goid int64 //goroutineçš„ID waitsince int64 // gè¢«é˜»å¡çš„å¤§ä½“æ—¶é—´ lockedm *m // Gè¢«é”å®šåªåœ¨è¿™ä¸ªmä¸Šè¿è¡Œ } type gobuf struct { sp uintptr pc uintptr g guintptr ctxt unsafe.Pointer ret sys.Uintreg lr uintptr bp uinptr } ä¿å­˜äº†å½“å‰çš„æ ˆæŒ‡é’ˆã€è®¡æ•°å™¨ã€å½“ç„¶è¿˜æœ‰gè‡ªèº«,è¿™é‡Œè®°å½•è‡ªèº«gçš„æŒ‡é’ˆæ˜¯ä¸ºäº†å¿«é€Ÿè®¿é—®åˆ°goroutineä¸­çš„ä¿¡æ¯ã€‚ ","date":"2022-04-12","objectID":"/gmp/:2:0","tags":["é¢è¯•"],"title":"GMP","uri":"/gmp/"},{"categories":["é¢è¯•"],"content":"P Pä»£è¡¨Processor,é€»è¾‘å¤„ç†å™¨,å®ƒçš„ä¸»è¦ç”¨é€”æ˜¯ç”¨æ¥æ‰§è¡Œgoroutineçš„,æ‰€ä»¥å®ƒä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªgoroutineé˜Ÿåˆ—,é‡Œé¢å­˜å‚¨äº†æ‰€æœ‰éœ€è¦å®ƒæ¥æ‰§è¡Œçš„goroutine,P/Méœ€è¦è¿›è¡Œç»‘å®š,æ„æˆä¸€ä¸ªæ‰§è¡Œå•å…ƒã€‚ type p struct { lock mutex id int32 status uint32 // çŠ¶æ€å¯ä»¥ä¸ºpidle/prunning/... link puintptr schedtick uint32 //æ¯è°ƒåº¦ä¸€æ¬¡åŠ 1 syscalltick uint32 //æ¯è°ƒåº¦ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨åŠ 1 m muintptr // å›é“¾åˆ°å…³è”çš„m mcache *mcache racectx uintptr goidcache uint64 //goroutineçš„IDçš„ç¼“å­˜ goidcacheend uint64 // å¯è¿è¡Œçš„goroutineçš„é˜Ÿåˆ— runqhead uint32 runqtail uint32 runq [256]guintptr runnext guintptr // ä¸‹ä¸€ä¸ªè¿è¡Œçš„g sudogcache []*sudog sudogbuf [128]*sudog palloc persistentAlloc pad [sys.CacheLineSize]byte } ","date":"2022-04-12","objectID":"/gmp/:2:1","tags":["é¢è¯•"],"title":"GMP","uri":"/gmp/"},{"categories":["é¢è¯•"],"content":"Sched Schedä»£è¡¨è°ƒåº¦å™¨,å®ƒç»´æŠ¤æœ‰å­˜å‚¨Må’ŒGçš„é˜Ÿåˆ—ä»¥åŠè°ƒåº¦å™¨çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ç­‰ã€‚ type schedt struct { goidgen uint64 lastpoll uint64 lock mutex midle muintptr // idleçŠ¶æ€çš„m nmidle int32 // idleçŠ¶æ€çš„mä¸ªæ•° nmidlelocked int32 // lockdeçŠ¶æ€çš„mä¸ªæ•° mcount int32 // åˆ›å»ºçš„mçš„æ€»æ•° maxmcount int32 // må…è®¸çš„æœ€å¤§ä¸ªæ•° ngsys uint32 // ç³»ç»Ÿä¸­goroutineçš„æ•°ç›®ï¼Œä¼šè‡ªåŠ¨æ›´æ–° pidle puintptr // idleçš„p npidle uint32 nmspinning uint32 // å…¨å±€çš„å¯è¿è¡Œçš„gé˜Ÿåˆ— runqhead guintptr runqtail guintptr runqsize int32 // deadçš„Gçš„å…¨å±€ç¼“å­˜ gflock mutex gfreeStack *g gfreeNoStack *g ngfree int32 // sudogçš„ç¼“å­˜ä¸­å¿ƒ sudoglock mutex sudogcache *sudog } ","date":"2022-04-12","objectID":"/gmp/:3:0","tags":["é¢è¯•"],"title":"GMP","uri":"/gmp/"},{"categories":["é¢è¯•"],"content":"GMPè°ƒåº¦ æ–°åˆ›å»ºçš„Goroutineä¼šå­˜æ”¾åœ¨Globalå…¨å±€é˜Ÿåˆ—ä¸­,ç­‰å¾…Goè°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦,éšåGoroutineè¢«åˆ†é…ç»™å…¶ä¸­çš„ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨P,å¹¶æ”¾åˆ°è¿™ä¸ªé€»è¾‘å¤„ç†å™¨å¯¹åº”çš„Localæœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­,æœ€ç»ˆç­‰å¾…è¢«é€»è¾‘å¤„ç†å™¨Pæ‰§è¡Œå³å¯ã€‚åœ¨Mä¸Pç»‘å®šå,Mä¼šä¸æ–­ä»Pçš„Localé˜Ÿåˆ—ä¸­æ— é”åœ°å–å‡ºG,å¹¶åˆ‡æ¢åˆ°Gçš„å †æ ˆæ‰§è¡Œ,å½“Pçš„Localé˜Ÿåˆ—ä¸­æ²¡æœ‰Gæ—¶,å†ä»Globalé˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªG,å½“Globalé˜Ÿåˆ—ä¸­ä¹Ÿæ²¡æœ‰å¾…è¿è¡Œçš„Gæ—¶,åˆ™å°è¯•ä»å…¶ä»–çš„Pçªƒå–éƒ¨åˆ†Gæ¥æ‰§è¡Œç›¸å½“äºPä¹‹é—´çš„è´Ÿè½½å‡è¡¡ã€‚ ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°,æœ‰2ä¸ªç‰©ç†çº¿ç¨‹M,æ¯ä¸€ä¸ªMéƒ½æ‹¥æœ‰ä¸€ä¸ªå¤„ç†å™¨P,æ¯ä¸€ä¸ªä¹Ÿéƒ½æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„goroutineã€‚Pçš„æ•°é‡å¯ä»¥é€šè¿‡GOMAXPROCS()è®¾ç½®,å®ƒå…¶å®ä¹Ÿå°±ä»£è¡¨äº†çœŸæ­£çš„å¹¶å‘åº¦,å³æœ‰å¤šå°‘ä¸ªgoroutineå¯ä»¥åŒæ—¶è¿è¡Œã€‚ å›¾ä¸­ç°è‰²çš„é‚£äº›goroutineå¹¶æ²¡æœ‰è¿è¡Œ,è€Œæ˜¯å¤„äºreadyçš„å°±ç»ªæ€,æ­£åœ¨ç­‰å¾…è¢«è°ƒåº¦ã€‚Pç»´æŠ¤ç€è¿™ä¸ªé˜Ÿåˆ—(ç§°ä¹‹ä¸ºrunqueue),Goè¯­è¨€é‡Œ,å¯åŠ¨ä¸€ä¸ªgoroutineå¾ˆå®¹æ˜“:go function å°±è¡Œ,æ‰€ä»¥æ¯æœ‰ä¸€ä¸ªgoè¯­å¥è¢«æ‰§è¡Œ,runqueueä¸­é˜Ÿåˆ—å°±åœ¨å…¶æœ«å°¾åŠ å…¥ä¸€ä¸ªgoroutine,åœ¨ä¸‹ä¸€ä¸ªè°ƒåº¦ç‚¹,å°±ä»runqueueä¸­å–å‡ºä¸€ä¸ªgoroutineæ‰§è¡Œã€‚ golang GMPæ¨¡å¼ï¼ˆgolang çš„è°ƒåº¦æ¨¡å¼ï¼‰ CSPï¼ˆcommunicating sequential processesï¼‰å¹¶å‘æ¨¡å‹ã€‚ä¸åŒäºä¼ ç»Ÿçš„å¤šçº¿ç¨‹é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼ŒCSPè®²ç©¶çš„æ˜¯â€œä»¥é€šä¿¡çš„æ–¹å¼æ¥å…±äº«å†…å­˜â€ã€‚ä¸è¦ä»¥å…±äº«å†…å­˜çš„æ–¹å¼æ¥é€šä¿¡ï¼Œç›¸åï¼Œè¦é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚ MæŒ‡çš„æ˜¯Machineï¼Œä¸€ä¸ªMç›´æ¥å…³è”äº†ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ã€‚ PæŒ‡çš„æ˜¯â€processorâ€ï¼Œä»£è¡¨äº†Mæ‰€éœ€çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿæ˜¯å¤„ç†ç”¨æˆ·çº§ä»£ç é€»è¾‘çš„å¤„ç†å™¨ã€‚ GæŒ‡çš„æ˜¯Goroutineï¼Œå…¶å®æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§è½»é‡çº§çš„çº¿ç¨‹ã€‚ Må…³è”äº†ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œé€šè¿‡è°ƒåº¦å™¨Pï¼ˆä¸Šä¸‹æ–‡ï¼‰çš„è°ƒåº¦ï¼Œå¯ä»¥è¿æ¥1ä¸ªæˆ–è€…å¤šä¸ªG,ç›¸å½“äºæŠŠä¸€ä¸ªå†…æ ¸çº¿ç¨‹åˆ‡åˆ†æˆäº†äº†Nä¸ªç”¨æˆ·çº¿ç¨‹ï¼ŒMå’ŒPæ˜¯ä¸€å¯¹ä¸€å…³ç³»ï¼ˆä½†æ˜¯å®é™…è°ƒåº¦ä¸­å…³ç³»å¤šå˜ï¼‰ï¼Œé€šè¿‡Pè°ƒåº¦Nä¸ªGï¼ˆPå’ŒGæ˜¯ä¸€å¯¹å¤šå…³ç³»ï¼‰ï¼Œå®ç°å†…æ ¸çº¿ç¨‹å’ŒGçš„å¤šå¯¹å¤šå…³ç³»ï¼ˆM:Nï¼‰ï¼Œé€šè¿‡è¿™ä¸ªæ–¹å¼ï¼Œä¸€ä¸ªå†…æ ¸çº¿ç¨‹å°±å¯ä»¥èµ·Nä¸ªGoroutineï¼ŒåŒæ ·ç¡¬ä»¶é…ç½®çš„æœºå™¨å¯ç”¨çš„ç”¨æˆ·çº¿ç¨‹å°±æˆå‡ ä½•çº§å¢é•¿ï¼Œå¹¶å‘æ€§å¤§å¹…æé«˜ã€‚ ","date":"2022-04-12","objectID":"/gmp/:4:0","tags":["é¢è¯•"],"title":"GMP","uri":"/gmp/"},{"categories":["é¢è¯•"],"content":"PMGä¸­åˆ‡æ¢æ­£åœ¨ç­‰å¾…æˆ–è€…é˜»å¡çš„åç¨‹ ","date":"2022-04-12","objectID":"/gmp/:5:0","tags":["é¢è¯•"],"title":"GMP","uri":"/gmp/"},{"categories":["é¢è¯•"],"content":"goparkå‡½æ•° goparkå‡½æ•°åœ¨åç¨‹çš„å®ç°ä¸Šæ‰®æ¼”ç€éå¸¸é‡è¦çš„è§’è‰²ï¼Œç”¨äºåç¨‹çš„åˆ‡æ¢ï¼Œåç¨‹åˆ‡æ¢çš„åŸå› ä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š ç³»ç»Ÿè°ƒç”¨ï¼› channelè¯»å†™æ¡ä»¶ä¸æ»¡è¶³ï¼› æŠ¢å å¼è°ƒåº¦æ—¶é—´ç‰‡ç»“æŸï¼› goparkå‡½æ•°åšçš„ä¸»è¦äº‹æƒ…åˆ†ä¸ºä¸¤ç‚¹ï¼š è§£é™¤å½“å‰goroutineçš„mçš„ç»‘å®šå…³ç³»ï¼Œå°†å½“å‰goroutineçŠ¶æ€æœºåˆ‡æ¢ä¸ºç­‰å¾…çŠ¶æ€ï¼› è°ƒç”¨ä¸€æ¬¡schedule()å‡½æ•°ï¼Œåœ¨å±€éƒ¨è°ƒåº¦å™¨På‘èµ·ä¸€è½®æ–°çš„è°ƒåº¦ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹goparkå‡½æ•°æ˜¯æ€ä¹ˆå®ç°åç¨‹åˆ‡æ¢çš„ã€‚ å…ˆçœ‹çœ‹æºç ï¼š func gopark(unlockf func(*g, unsafe.Pointer) bool, lock unsafe.Pointer, reason waitReason, traceEv byte, traceskip int) { if reason != waitReasonSleep { checkTimeouts() // timeouts may expire while two goroutines keep the scheduler busy } mp := acquirem() gp := mp.curg status := readgstatus(gp) if status != _Grunning \u0026\u0026 status != _Gscanrunning { throw(\"gopark: bad g status\") } mp.waitlock = lock mp.waitunlockf = *(*unsafe.Pointer)(unsafe.Pointer(\u0026unlockf)) gp.waitreason = reason mp.waittraceev = traceEv mp.waittraceskip = traceskip releasem(mp) // can't do anything that might move the G between Ms here. mcall(park_m) } æºç é‡Œé¢æœ€é‡è¦çš„ä¸€è¡Œå°±æ˜¯è°ƒç”¨ mcall(park_m) å‡½æ•°ï¼Œpark_m æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚mcall åœ¨golangéœ€è¦è¿›è¡Œåç¨‹åˆ‡æ¢æ—¶è¢«è°ƒç”¨ï¼Œåšçš„ä¸»è¦å·¥ä½œæ˜¯ï¼š åˆ‡æ¢å½“å‰çº¿ç¨‹çš„å †æ ˆä»gçš„å †æ ˆåˆ‡æ¢åˆ°g0çš„å †æ ˆï¼› å¹¶åœ¨g0çš„å †æ ˆä¸Šæ‰§è¡Œæ–°çš„å‡½æ•°fn(g)ï¼› ä¿å­˜å½“å‰åç¨‹çš„ä¿¡æ¯( PC/SPå­˜å‚¨åˆ°g-\u003esched)ï¼Œå½“åç»­å¯¹å½“å‰åç¨‹è°ƒç”¨goreadyå‡½æ•°æ—¶å€™èƒ½å¤Ÿæ¢å¤ç°åœºï¼› mcallå‡½æ•°æ‰§è¡ŒåŸç† mcallçš„å‡½æ•°åŸå‹æ˜¯ï¼š func mcall(fn func(*g)) è¿™é‡Œå‡½æ•°fnçš„å‚æ•°gæŒ‡çš„æ˜¯åœ¨è°ƒç”¨mcallä¹‹å‰æ­£åœ¨è¿è¡Œçš„åç¨‹ã€‚ æˆ‘ä»¬å‰é¢è¯´åˆ°ï¼Œmcallçš„ä¸»è¦ä½œç”¨æ˜¯åç¨‹åˆ‡æ¢ï¼Œå®ƒå°†å½“å‰æ­£åœ¨æ‰§è¡Œçš„åç¨‹çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œç„¶ååœ¨m-\u003eg0 çš„å †æ ˆä¸Šè°ƒç”¨æ–°çš„å‡½æ•°ã€‚ åœ¨æ–°çš„å‡½æ•°å†…ä¼šå°†ä¹‹å‰è¿è¡Œçš„åç¨‹æ”¾å¼ƒï¼Œç„¶åè°ƒç”¨ä¸€æ¬¡schedule()æ¥æŒ‘é€‰æ–°çš„åç¨‹è¿è¡Œã€‚ ( ä¹Ÿå°±æ˜¯åœ¨fnå‡½æ•°é‡Œé¢ä¼šè°ƒç”¨ä¸€æ¬¡schedule()å‡½æ•°è¿›è¡Œä¸€æ¬¡schedulerçš„é‡æ–°è°ƒåº¦ï¼Œè®©må»è¿è¡Œå…¶ä½™çš„goroutine ) package runtime // One round of scheduler: find a runnable goroutine and execute it. // Never returns. func schedule() { _g_ := getg() if _g_.m.locks != 0 { throw(\"schedule: holding locks\") } if _g_.m.lockedg != 0 { stoplockedm() execute(_g_.m.lockedg.ptr(), false) // Never returns. } // We should not schedule away from a g that is executing a cgo call, // since the cgo call is using the m's g0 stack. if _g_.m.incgo { throw(\"schedule: in cgo\") } top: pp := _g_.m.p.ptr() pp.preempt = false if sched.gcwaiting != 0 { gcstopm() goto top } if pp.runSafePointFn != 0 { runSafePointFn() } // Sanity check: if we are spinning, the run queue should be empty. // Check this before calling checkTimers, as that might call // goready to put a ready goroutine on the local run queue. if _g_.m.spinning \u0026\u0026 (pp.runnext != 0 || pp.runqhead != pp.runqtail) { throw(\"schedule: spinning with local work\") } checkTimers(pp, 0) var gp *g var inheritTime bool // Normal goroutines will check for need to wakeP in ready, // but GCworkers and tracereaders will not, so the check must // be done here instead. tryWakeP := false if trace.enabled || trace.shutdown { gp = traceReader() if gp != nil { casgstatus(gp, _Gwaiting, _Grunnable) traceGoUnpark(gp, 0) tryWakeP = true } } if gp == nil \u0026\u0026 gcBlackenEnabled != 0 { gp = gcController.findRunnableGCWorker(_g_.m.p.ptr()) if gp != nil { tryWakeP = true } } if gp == nil { // Check the global runnable queue once in a while to ensure fairness. // Otherwise two goroutines can completely occupy the local runqueue // by constantly respawning each other. if _g_.m.p.ptr().schedtick%61 == 0 \u0026\u0026 sched.runqsize \u003e 0 { lock(\u0026sched.lock) gp = globrunqget(_g_.m.p.ptr(), 1) unlock(\u0026sched.lock) } } if gp == nil { gp, inheritTime = runqget(_g_.m.p.ptr()) // We can see gp != nil here even if the M is spinning, // if checkTimers added a local goroutine via goready. } if gp == nil { gp, inheritTime = findrunnable() // blocks until work is available } // This thread is going to run a goroutine and is not spinning anymore, // so if it was marked as spinning we need to reset it now and potentially // start a new spinning M. if _g_.m.spinning { resetspinning() } if sched.disable.user \u0026\u0026 !schedEnabled(gp) { // Scheduling of this goroutine is disabled. Put it on // the list of pending runnable goroutines for when we // re-enable user scheduling and look again. lock(\u0026sched.lock) if schedEnabled(gp) { // Something re-enabled scheduling while we // were acquiring the lock. unlock(\u0026sched.lock) } else { sched.disable.runnable.pushBack(gp) sched.disable.n++ unlock(\u0026sched.lock) goto top } } // If about to schedule a not-normal goroutine (a GCworker or tracereader), // wake a P if","date":"2022-04-12","objectID":"/gmp/:5:1","tags":["é¢è¯•"],"title":"GMP","uri":"/gmp/"},{"categories":["é¢è¯•"],"content":"goreadyå‡½æ•°ï¼š goreadyå‡½æ•°ç›¸æ¯”goparkå‡½æ•°æ¥è¯´ç®€å•ä¸€äº›ï¼Œä¸»è¦åŠŸèƒ½å°±æ˜¯å”¤é†’æŸä¸€ä¸ªgoroutineï¼Œè¯¥åç¨‹è½¬æ¢åˆ°runnableçš„çŠ¶æ€ï¼Œå¹¶å°†å…¶æ”¾å…¥Pçš„local queueï¼Œç­‰å¾…è°ƒåº¦ã€‚ func goready(gp *g, traceskip int) { // åˆ‡æ¢åˆ°g0çš„æ ˆ systemstack(func() { ready(gp, traceskip, true) }) } è¯¥å‡½æ•°ä¸»è¦å°±æ˜¯åˆ‡æ¢åˆ°g0çš„æ ˆç©ºé—´ç„¶åæ‰§è¡Œreadyå‡½æ•°ã€‚ ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹readyå‡½æ•°æºç (åˆ é™¤éä¸»æµç¨‹ä»£ç )ï¼š // Mark gp ready to run. func ready(gp *g, traceskip int, next bool) { status := readgstatus(gp) // Mark runnable. _g_ := getg()//g0 _g_.m.locks++ // disable preemption because it can be holding p in a local var if status\u0026^_Gscan != _Gwaiting { dumpgstatus(gp) throw(\"bad g-\u003estatus in ready\") } //è®¾ç½®gpçŠ¶æ€ä¸ºrunnableï¼Œç„¶ååŠ å…¥åˆ°Pçš„å¯è¿è¡Œlocal queue; casgstatus(gp, _Gwaiting, _Grunnable) runqput(_g_.m.p.ptr(), gp, next) if atomic.Load(\u0026sched.npidle) != 0 \u0026\u0026 atomic.Load(\u0026sched.nmspinning) == 0 { wakep() } _g_.m.locks-- if _g_.m.locks == 0 \u0026\u0026 _g_.preempt { // restore the preemption request in Case we've cleared it in newstack _g_.stackguard0 = stackPreempt } } è¯¥æ–‡ç« ä¸»è¦è¯¦ç»†å…·ä½“çš„ä»‹ç»Goroutineè°ƒåº¦å™¨è¿‡ç¨‹åŠåŸç†ï¼Œå¯ä»¥å¯¹Goè°ƒåº¦å™¨çš„è¯¦ç»†è°ƒåº¦è¿‡ç¨‹æœ‰ä¸€ä¸ªæ¸…æ™°çš„ç†è§£ï¼ŒèŠ± è´¹4å¤©æ—¶é—´ä½œäº†30+å¼ å›¾(æ¨èæ”¶è—)ï¼ŒåŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªç« èŠ‚ã€‚ æœ¬ç« èŠ‚å«è§†é¢‘ç‰ˆ: ç¬¬ä¸€ç«  Golangè°ƒåº¦å™¨çš„ç”±æ¥ ç¬¬äºŒç«  Goroutineè°ƒåº¦å™¨çš„GMPæ¨¡å‹åŠè®¾è®¡æ€æƒ³ ç¬¬ä¸‰ç«  Goroutineè°ƒåº¦åœºæ™¯è¿‡ç¨‹å…¨å›¾æ–‡è§£æ ä¸€ã€Golangâ€œè°ƒåº¦å™¨â€çš„ç”±æ¥ï¼Ÿ (1) å•è¿›ç¨‹æ—¶ä»£ä¸éœ€è¦è°ƒåº¦å™¨ æˆ‘ä»¬çŸ¥é“ï¼Œä¸€åˆ‡çš„è½¯ä»¶éƒ½æ˜¯è·‘åœ¨æ“ä½œç³»ç»Ÿä¸Šï¼ŒçœŸæ­£ç”¨æ¥å¹²æ´»(è®¡ç®—)çš„æ˜¯CPUã€‚æ—©æœŸçš„æ“ä½œç³»ç»Ÿæ¯ä¸ªç¨‹åºå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œç›´åˆ°ä¸€ä¸ªç¨‹åºè¿è¡Œå®Œï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œå°±æ˜¯â€œå•è¿›ç¨‹æ—¶ä»£â€ ä¸€åˆ‡çš„ç¨‹åºåªèƒ½ä¸²è¡Œå‘ç”Ÿã€‚ æ—©æœŸçš„å•è¿›ç¨‹æ“ä½œç³»ç»Ÿï¼Œé¢ä¸´2ä¸ªé—®é¢˜ï¼š 1.å•ä¸€çš„æ‰§è¡Œæµç¨‹ï¼Œè®¡ç®—æœºåªèƒ½ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªä»»åŠ¡å¤„ç†ã€‚ 2.è¿›ç¨‹é˜»å¡æ‰€å¸¦æ¥çš„CPUæ—¶é—´æµªè´¹ã€‚ é‚£ä¹ˆèƒ½ä¸èƒ½æœ‰å¤šä¸ªè¿›ç¨‹æ¥å®è§‚ä¸€èµ·æ¥æ‰§è¡Œå¤šä¸ªä»»åŠ¡å‘¢ï¼Ÿ åæ¥æ“ä½œç³»ç»Ÿå°±å…·æœ‰äº†æœ€æ—©çš„å¹¶å‘èƒ½åŠ›ï¼šå¤šè¿›ç¨‹å¹¶å‘ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹é˜»å¡çš„æ—¶å€™ï¼Œåˆ‡æ¢åˆ°å¦å¤–ç­‰å¾…æ‰§è¡Œçš„è¿›ç¨‹ï¼Œè¿™æ ·å°±èƒ½å°½é‡æŠŠCPUåˆ©ç”¨èµ·æ¥ï¼ŒCPUå°±ä¸æµªè´¹äº†ã€‚ (2)å¤šè¿›ç¨‹/çº¿ç¨‹æ—¶ä»£æœ‰äº†è°ƒåº¦å™¨éœ€æ±‚ åœ¨å¤šè¿›ç¨‹/å¤šçº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œå°±è§£å†³äº†é˜»å¡çš„é—®é¢˜ï¼Œå› ä¸ºä¸€ä¸ªè¿›ç¨‹é˜»å¡cpuå¯ä»¥ç«‹åˆ»åˆ‡æ¢åˆ°å…¶ä»–è¿›ç¨‹ä¸­å»æ‰§è¡Œï¼Œè€Œä¸”è°ƒåº¦cpuçš„ç®—æ³•å¯ä»¥ä¿è¯åœ¨è¿è¡Œçš„è¿›ç¨‹éƒ½å¯ä»¥è¢«åˆ†é…åˆ°cpuçš„è¿è¡Œæ—¶é—´ç‰‡ã€‚è¿™æ ·ä»å®è§‚æ¥çœ‹ï¼Œä¼¼ä¹å¤šä¸ªè¿›ç¨‹æ˜¯åœ¨åŒæ—¶è¢«è¿è¡Œã€‚ ä½†æ–°çš„é—®é¢˜å°±åˆå‡ºç°äº†ï¼Œè¿›ç¨‹æ‹¥æœ‰å¤ªå¤šçš„èµ„æºï¼Œè¿›ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ã€é”€æ¯ï¼Œéƒ½ä¼šå ç”¨å¾ˆé•¿çš„æ—¶é—´ï¼ŒCPUè™½ç„¶åˆ©ç”¨èµ·æ¥äº†ï¼Œä½†å¦‚æœè¿›ç¨‹è¿‡å¤šï¼ŒCPUæœ‰å¾ˆå¤§çš„ä¸€éƒ¨åˆ†éƒ½è¢«ç”¨æ¥è¿›è¡Œè¿›ç¨‹è°ƒåº¦äº†ã€‚ æ€ä¹ˆæ‰èƒ½æé«˜CPUçš„åˆ©ç”¨ç‡å‘¢ï¼Ÿ ä½†æ˜¯å¯¹äºLinuxæ“ä½œç³»ç»Ÿæ¥è®²ï¼Œcpuå¯¹è¿›ç¨‹çš„æ€åº¦å’Œçº¿ç¨‹çš„æ€åº¦æ˜¯ä¸€æ ·çš„ã€‚ å¾ˆæ˜æ˜¾ï¼ŒCPUè°ƒåº¦åˆ‡æ¢çš„æ˜¯è¿›ç¨‹å’Œçº¿ç¨‹ã€‚å°½ç®¡çº¿ç¨‹çœ‹èµ·æ¥å¾ˆç¾å¥½ï¼Œä½†å®é™…ä¸Šå¤šçº¿ç¨‹å¼€å‘è®¾è®¡ä¼šå˜å¾—æ›´åŠ å¤æ‚ï¼Œè¦è€ƒè™‘å¾ˆå¤šåŒæ­¥ç«äº‰ç­‰é—®é¢˜ï¼Œå¦‚é”ã€ç«äº‰å†²çªç­‰ã€‚ (3)åç¨‹æ¥æé«˜CPUåˆ©ç”¨ç‡ å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹å·²ç»æé«˜äº†ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›ï¼Œä½†æ˜¯åœ¨å½“ä»Šäº’è”ç½‘é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸ºæ¯ä¸ªä»»åŠ¡éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ç°å®çš„ï¼Œå› ä¸ºä¼šæ¶ˆè€—å¤§é‡çš„å†…å­˜(è¿›ç¨‹è™šæ‹Ÿå†…å­˜ä¼šå ç”¨4GB[32ä½æ“ä½œç³»ç»Ÿ], è€Œçº¿ç¨‹ä¹Ÿè¦å¤§çº¦4MB)ã€‚ å¤§é‡çš„è¿›ç¨‹/çº¿ç¨‹å‡ºç°äº†æ–°çš„é—®é¢˜ é«˜å†…å­˜å ç”¨ è°ƒåº¦çš„é«˜æ¶ˆè€—CPU å¥½äº†ï¼Œç„¶åå·¥ç¨‹å¸ˆä»¬å°±å‘ç°ï¼Œå…¶å®ä¸€ä¸ªçº¿ç¨‹åˆ†ä¸ºâ€œå†…æ ¸æ€â€œçº¿ç¨‹å’Œâ€ç”¨æˆ·æ€â€œçº¿ç¨‹ã€‚ ä¸€ä¸ªâ€œç”¨æˆ·æ€çº¿ç¨‹â€å¿…é¡»è¦ç»‘å®šä¸€ä¸ªâ€œå†…æ ¸æ€çº¿ç¨‹â€ï¼Œä½†æ˜¯CPUå¹¶ä¸çŸ¥é“æœ‰â€œç”¨æˆ·æ€çº¿ç¨‹â€çš„å­˜åœ¨ï¼Œå®ƒåªçŸ¥é“å®ƒè¿è¡Œçš„æ˜¯ä¸€ä¸ªâ€œå†…æ ¸æ€çº¿ç¨‹â€(Linuxçš„PCBè¿›ç¨‹æ§åˆ¶å—)ã€‚ è¿™æ ·ï¼Œæˆ‘ä»¬å†å»ç»†åŒ–å»åˆ†ç±»ä¸€ä¸‹ï¼Œå†…æ ¸çº¿ç¨‹ä¾ç„¶å«â€œçº¿ç¨‹(thread)â€ï¼Œç”¨æˆ·çº¿ç¨‹å«â€œåç¨‹(co-routine)\". â€‹ çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±è¦å¼€è„‘æ´äº†ï¼Œæ—¢ç„¶ä¸€ä¸ªåç¨‹(co-routine)å¯ä»¥ç»‘å®šä¸€ä¸ªçº¿ç¨‹(thread)ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½å¤šä¸ªåç¨‹(co-routine)ç»‘å®šä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹(thread)ä¸Šå‘¢ã€‚ â€‹ ä¹‹åï¼Œæˆ‘ä»¬å°±çœ‹åˆ°äº†æœ‰3ä¸­åç¨‹å’Œçº¿ç¨‹çš„æ˜ å°„å…³ç³»ï¼š N:1å…³ç³» Nä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹ï¼Œä¼˜ç‚¹å°±æ˜¯åç¨‹åœ¨ç”¨æˆ·æ€çº¿ç¨‹å³å®Œæˆåˆ‡æ¢ï¼Œä¸ä¼šé™·å…¥åˆ°å†…æ ¸æ€ï¼Œè¿™ç§åˆ‡æ¢éå¸¸çš„è½»é‡å¿«é€Ÿã€‚ä½†ä¹Ÿæœ‰å¾ˆå¤§çš„ç¼ºç‚¹ï¼Œ1ä¸ªè¿›ç¨‹çš„æ‰€æœ‰åç¨‹éƒ½ç»‘å®šåœ¨1ä¸ªçº¿ç¨‹ä¸Š ç¼ºç‚¹ï¼š æŸä¸ªç¨‹åºç”¨ä¸äº†ç¡¬ä»¶çš„å¤šæ ¸åŠ é€Ÿèƒ½åŠ› ä¸€æ—¦æŸåç¨‹é˜»å¡ï¼Œé€ æˆçº¿ç¨‹é˜»å¡ï¼Œæœ¬è¿›ç¨‹çš„å…¶ä»–åç¨‹éƒ½æ— æ³•æ‰§è¡Œäº†ï¼Œæ ¹æœ¬å°±æ²¡æœ‰å¹¶å‘çš„èƒ½åŠ›äº†ã€‚ 1:1 å…³ç³» 1ä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹ï¼Œè¿™ç§æœ€å®¹æ˜“å®ç°ã€‚åç¨‹çš„è°ƒåº¦éƒ½ç”±CPUå®Œæˆäº†ï¼Œä¸å­˜åœ¨N:1ç¼ºç‚¹ï¼Œ ç¼ºç‚¹ï¼š åç¨‹çš„åˆ›å»ºã€åˆ é™¤å’Œåˆ‡æ¢çš„ä»£ä»·éƒ½ç”±CPUå®Œæˆï¼Œæœ‰ç‚¹ç•¥æ˜¾æ˜‚è´µäº†ã€‚ M:Nå…³ç³» Mä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹ï¼Œæ˜¯N:1å’Œ1:1ç±»å‹çš„ç»“åˆï¼Œå…‹æœäº†ä»¥ä¸Š2ç§æ¨¡å‹çš„ç¼ºç‚¹ï¼Œä½†å®ç°èµ·æ¥æœ€ä¸ºå¤æ‚ã€‚ â€‹ åç¨‹è·Ÿçº¿ç¨‹æ˜¯æœ‰åŒºåˆ«çš„ï¼Œçº¿ç¨‹ç”±CPUè°ƒåº¦æ˜¯æŠ¢å å¼çš„ï¼Œåç¨‹ç”±ç”¨æˆ·æ€è°ƒåº¦æ˜¯åä½œå¼çš„ï¼Œä¸€ä¸ªåç¨‹è®©å‡ºCPUåï¼Œæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ã€‚ â€‹ (4)Goè¯­è¨€çš„åç¨‹goroutine Goä¸ºäº†æä¾›æ›´å®¹æ˜“ä½¿ç”¨çš„å¹¶å‘æ–¹æ³•ï¼Œä½¿ç”¨äº†goroutineå’Œchannelã€‚goroutineæ¥è‡ªåç¨‹çš„æ¦‚å¿µï¼Œè®©ä¸€ç»„å¯å¤ç”¨çš„å‡½æ•°è¿è¡Œåœ¨ä¸€ç»„çº¿ç¨‹ä¹‹ä¸Šï¼Œå³ä½¿æœ‰åç¨‹é˜»å¡ï¼Œè¯¥çº¿ç¨‹çš„å…¶ä»–åç¨‹ä¹Ÿå¯ä»¥è¢«runtimeè°ƒåº¦ï¼Œè½¬ç§»åˆ°å…¶ä»–å¯è¿è¡Œçš„çº¿ç¨‹ä¸Šã€‚æœ€å…³é”®çš„æ˜¯ï¼Œç¨‹åºå‘˜çœ‹ä¸åˆ°è¿™äº›åº•å±‚çš„ç»†èŠ‚ï¼Œè¿™å°±é™ä½äº†ç¼–ç¨‹çš„éš¾åº¦ï¼Œæä¾›äº†æ›´å®¹æ˜“çš„å¹¶å‘ã€‚ Goä¸­ï¼Œåç¨‹è¢«ç§°ä¸ºgoroutineï¼Œå®ƒéå¸¸è½»é‡ï¼Œä¸€ä¸ªgoroutineåªå å‡ KBï¼Œå¹¶ä¸”è¿™å‡ KBå°±è¶³å¤Ÿgoroutineè¿è¡Œå®Œï¼Œè¿™å°±èƒ½åœ¨æœ‰é™çš„å†…å­˜ç©ºé—´å†…æ”¯æŒå¤§é‡goroutineï¼Œæ”¯æŒäº†æ›´å¤šçš„å¹¶å‘ã€‚è™½ç„¶ä¸€ä¸ªgoroutineçš„æ ˆåªå å‡ KBï¼Œä½†å®é™…æ˜¯å¯ä¼¸ç¼©çš„ï¼Œå¦‚æœéœ€è¦æ›´å¤šå†…å®¹ï¼Œruntimeä¼šè‡ªåŠ¨ä¸ºgoroutineåˆ†é…ã€‚ Goroutineç‰¹ç‚¹ï¼š å ç”¨å†…å­˜æ›´å°ï¼ˆå‡ kbï¼‰ è°ƒåº¦æ›´çµæ´»(runtimeè°ƒåº¦) (5)è¢«åºŸå¼ƒçš„goroutineè°ƒåº¦å™¨ â€‹ å¥½äº†ï¼Œæ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†åç¨‹å’Œçº¿ç¨‹çš„å…³ç³»ï¼Œé‚£ä¹ˆæœ€å…³é”®çš„ä¸€ç‚¹å°±æ˜¯è°ƒåº¦åç¨‹çš„è°ƒåº¦å™¨çš„å®ç°äº†ã€‚ Goç›®å‰ä½¿ç”¨çš„è°ƒåº¦å™¨æ˜¯2012å¹´é‡æ–°è®¾è®¡çš„ï¼Œå› ä¸ºä¹‹å‰çš„è°ƒåº¦å™¨æ€§èƒ½å­˜åœ¨é—®é¢˜ï¼Œæ‰€ä»¥ä½¿ç”¨4å¹´å°±è¢«åºŸå¼ƒäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹è¢«åºŸå¼ƒçš„è°ƒåº¦å™¨æ˜¯å¦‚ä½•è¿ä½œçš„ï¼Ÿ å¤§éƒ¨åˆ†æ–‡ç« éƒ½æ˜¯ä¼šç”¨Gæ¥è¡¨ç¤ºGoroutineï¼Œç”¨Mæ¥è¡¨ç¤ºçº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿä¼šç”¨è¿™ç§è¡¨è¾¾çš„å¯¹åº”å…³ç³»ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¢«åºŸå¼ƒçš„golangè°ƒåº¦å™¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ Mæƒ³è¦æ‰§è¡Œã€æ”¾å›Géƒ½å¿…é¡»è®¿é—®å…¨å±€Gé˜Ÿåˆ—ï¼Œå¹¶ä¸”Mæœ‰å¤šä¸ªï¼Œå³å¤šçº¿ç¨‹è®¿é—®åŒä¸€èµ„æºéœ€è¦åŠ é”è¿›è¡Œä¿è¯äº’æ–¥/åŒæ­¥ï¼Œæ‰€ä»¥å…¨å±€Gé˜Ÿåˆ—æ˜¯æœ‰äº’æ–¥é”è¿›è¡Œä¿æŠ¤çš„ã€‚ è€è°ƒåº¦å™¨æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦Géƒ½éœ€è¦æ¯ä¸ªMè·å–é”ï¼Œè¿™å°±å½¢æˆäº†æ¿€çƒˆçš„é”ç«äº‰ã€‚ Mè½¬ç§»Gä¼šé€ æˆå»¶è¿Ÿå’Œé¢å¤–çš„ç³»ç»Ÿè´Ÿè½½ã€‚æ¯”å¦‚å½“Gä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹çš„æ—¶å€™ï¼ŒMåˆ›å»ºäº†Gâ€™ï¼Œä¸ºäº†ç»§ç»­æ‰§è¡ŒGï¼Œéœ€è¦æŠŠGâ€™äº¤ç»™Mâ€™æ‰§è¡Œï¼Œä¹Ÿé€ æˆäº†å¾ˆå·®çš„å±€éƒ¨æ€§ï¼Œå› ä¸ºGâ€™å’ŒGæ˜¯ç›¸å…³çš„ï¼Œæœ€å¥½æ”¾åœ¨Mä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å…¶ä»–M'ã€‚ ç³»ç»Ÿè°ƒç”¨(CPUåœ¨Mä¹‹é—´çš„åˆ‡æ¢)å¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹é˜»å¡å’Œå–æ¶ˆé˜»å¡æ“ä½œå¢åŠ äº†ç³»ç»Ÿå¼€é”€ã€‚ äºŒã€Goroutineè°ƒåº¦å™¨çš„GMPæ¨¡å‹çš„è®¾è®¡æ€æƒ³ é¢å¯¹ä¹‹å‰è°ƒåº¦å™¨çš„é—®é¢˜ï¼ŒGoè®¾è®¡äº†æ–°çš„è°ƒåº¦å™¨ã€‚ åœ¨æ–°è°ƒåº¦å™¨ä¸­ï¼Œé™¤äº†M(thread)å’ŒG(goroutine)ï¼Œåˆå¼•è¿›äº†P(Processor)ã€‚ Processorï¼Œå®ƒåŒ…å«äº†è¿è¡Œgoroutineçš„èµ„æºï¼Œå¦‚æœçº¿ç¨‹æƒ³è¿è¡Œgoroutineï¼Œå¿…é¡»å…ˆè·å–Pï¼ŒPä¸­è¿˜åŒ…å«äº†å¯è¿è¡Œçš„Gé˜Ÿåˆ—ã€‚ (1)GMPæ¨¡å‹ åœ¨Goä¸­ï¼Œçº¿ç¨‹æ˜¯è¿è¡Œgoroutineçš„å®ä½“ï¼Œè°ƒåº¦å™¨çš„åŠŸèƒ½æ˜¯æŠŠå¯è¿è¡Œçš„goroutineåˆ†é…åˆ°å·¥ä½œçº¿ç¨‹ä¸Šã€‚ å…¨å±€é˜Ÿåˆ—ï¼ˆGlobal Queueï¼‰ï¼šå­˜æ”¾ç­‰å¾…è¿è¡Œçš„Gã€‚ Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼šåŒå…¨å±€é˜Ÿåˆ—ç±»ä¼¼ï¼Œå­˜æ”¾çš„ä¹Ÿæ˜¯ç­‰å¾…è¿è¡Œçš„Gï¼Œå­˜çš„æ•°é‡æœ‰é™ï¼Œä¸è¶…è¿‡256ä¸ªã€‚æ–°å»ºGâ€™æ—¶ï¼ŒGâ€™ä¼˜å…ˆåŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„Gç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚ Påˆ—è¡¨ï¼šæ‰€æœ‰çš„Péƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰GOMAXPROCS(å¯é…ç½®)ä¸ªã€‚ Mï¼šçº¿ç¨‹æƒ³è¿è¡Œä»»åŠ¡å°±å¾—è·å–Pï¼Œä»Pçš„æœ¬åœ°é˜Ÿåˆ—è·å–Gï¼ŒPé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒMä¹Ÿä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—æ‹¿ä¸€æ‰¹Gæ”¾åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæˆ–ä»å…¶ä»–Pçš„æœ¬åœ°é˜Ÿåˆ—å·ä¸€åŠæ”¾åˆ°è‡ªå·±Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚Mè¿è¡ŒGï¼ŒGæ‰§è¡Œä¹‹åï¼ŒMä¼šä»Pè·å–ä¸‹ä¸€ä¸ªGï¼Œä¸æ–­é‡å¤ä¸‹å»ã€‚ Goroutineè°ƒåº¦å™¨å’ŒOSè°ƒåº¦å™¨æ˜¯é€šè¿‡Mç»“åˆèµ·æ¥çš„ï¼Œæ¯ä¸ªMéƒ½ä»£è¡¨äº†1ä¸ªå†…æ ¸çº¿ç¨‹ï¼ŒOSè°ƒåº¦å™¨è´Ÿè´£æŠŠå†…æ ¸çº¿ç¨‹åˆ†é…åˆ°CPUçš„æ ¸ä¸Šæ‰§è¡Œã€‚ ","date":"2022-04-12","objectID":"/gmp/:6:0","tags":["é¢è¯•"],"title":"GMP","uri":"/gmp/"},{"categories":["é¢è¯•"],"content":"æœ‰å…³På’ŒMçš„ä¸ªæ•°é—®é¢˜ 1ã€Pçš„æ•°é‡ï¼š ç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡$GOMAXPROCSæˆ–è€…æ˜¯ç”±runtimeçš„æ–¹æ³•GOMAXPROCS()å†³å®šã€‚è¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰$GOMAXPROCSä¸ªgoroutineåœ¨åŒæ—¶è¿è¡Œã€‚ 2ã€Mçš„æ•°é‡: goè¯­è¨€æœ¬èº«çš„é™åˆ¶ï¼šgoç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šè®¾ç½®Mçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤10000.ä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçš„çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ã€‚ runtime/debugä¸­çš„SetMaxThreadså‡½æ•°ï¼Œè®¾ç½®Mçš„æœ€å¤§æ•°é‡ ä¸€ä¸ªMé˜»å¡äº†ï¼Œä¼šåˆ›å»ºæ–°çš„Mã€‚ Mä¸Pçš„æ•°é‡æ²¡æœ‰ç»å¯¹å…³ç³»ï¼Œä¸€ä¸ªMé˜»å¡ï¼ŒPå°±ä¼šå»åˆ›å»ºæˆ–è€…åˆ‡æ¢å¦ä¸€ä¸ªMï¼Œæ‰€ä»¥ï¼Œå³ä½¿Pçš„é»˜è®¤æ•°é‡æ˜¯1ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šåˆ›å»ºå¾ˆå¤šä¸ªMå‡ºæ¥ã€‚ ","date":"2022-04-12","objectID":"/gmp/:6:1","tags":["é¢è¯•"],"title":"GMP","uri":"/gmp/"},{"categories":["é¢è¯•"],"content":"På’ŒMä½•æ—¶ä¼šè¢«åˆ›å»º 1ã€Pä½•æ—¶åˆ›å»ºï¼šåœ¨ç¡®å®šäº†Pçš„æœ€å¤§æ•°é‡nåï¼Œè¿è¡Œæ—¶ç³»ç»Ÿä¼šæ ¹æ®è¿™ä¸ªæ•°é‡åˆ›å»ºnä¸ªPã€‚ 2ã€Mä½•æ—¶åˆ›å»ºï¼šæ²¡æœ‰è¶³å¤Ÿçš„Mæ¥å…³è”På¹¶è¿è¡Œå…¶ä¸­çš„å¯è¿è¡Œçš„Gã€‚æ¯”å¦‚æ‰€æœ‰çš„Mæ­¤æ—¶éƒ½é˜»å¡ä½äº†ï¼Œè€ŒPä¸­è¿˜æœ‰å¾ˆå¤šå°±ç»ªä»»åŠ¡ï¼Œå°±ä¼šå»å¯»æ‰¾ç©ºé—²çš„Mï¼Œè€Œæ²¡æœ‰ç©ºé—²çš„ï¼Œå°±ä¼šå»åˆ›å»ºæ–°çš„Mã€‚ (2)è°ƒåº¦å™¨çš„è®¾è®¡ç­–ç•¥ å¤ç”¨çº¿ç¨‹ï¼šé¿å…é¢‘ç¹çš„åˆ›å»ºã€é”€æ¯çº¿ç¨‹ï¼Œè€Œæ˜¯å¯¹çº¿ç¨‹çš„å¤ç”¨ã€‚ 1ï¼‰work stealingæœºåˆ¶ â€‹ å½“æœ¬çº¿ç¨‹æ— å¯è¿è¡Œçš„Gæ—¶ï¼Œå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„På·å–Gï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹ã€‚ 2ï¼‰hand offæœºåˆ¶ â€‹ å½“æœ¬çº¿ç¨‹å› ä¸ºGè¿›è¡Œç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œçº¿ç¨‹é‡Šæ”¾ç»‘å®šçš„Pï¼ŒæŠŠPè½¬ç§»ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œã€‚ åˆ©ç”¨å¹¶è¡Œï¼šGOMAXPROCSè®¾ç½®Pçš„æ•°é‡ï¼Œæœ€å¤šæœ‰GOMAXPROCSä¸ªçº¿ç¨‹åˆ†å¸ƒåœ¨å¤šä¸ªCPUä¸ŠåŒæ—¶è¿è¡Œã€‚GOMAXPROCSä¹Ÿé™åˆ¶äº†å¹¶å‘çš„ç¨‹åº¦ï¼Œæ¯”å¦‚GOMAXPROCS = æ ¸æ•°/2ï¼Œåˆ™æœ€å¤šåˆ©ç”¨äº†ä¸€åŠçš„CPUæ ¸è¿›è¡Œå¹¶è¡Œã€‚ æŠ¢å ï¼šåœ¨coroutineä¸­è¦ç­‰å¾…ä¸€ä¸ªåç¨‹ä¸»åŠ¨è®©å‡ºCPUæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ï¼Œåœ¨Goä¸­ï¼Œä¸€ä¸ªgoroutineæœ€å¤šå ç”¨CPU 10msï¼Œé˜²æ­¢å…¶ä»–goroutineè¢«é¥¿æ­»ï¼Œè¿™å°±æ˜¯goroutineä¸åŒäºcoroutineçš„ä¸€ä¸ªåœ°æ–¹ã€‚ å…¨å±€Gé˜Ÿåˆ—ï¼šåœ¨æ–°çš„è°ƒåº¦å™¨ä¸­ä¾ç„¶æœ‰å…¨å±€Gé˜Ÿåˆ—ï¼Œä½†åŠŸèƒ½å·²ç»è¢«å¼±åŒ–äº†ï¼Œå½“Mæ‰§è¡Œwork stealingä»å…¶ä»–På·ä¸åˆ°Gæ—¶ï¼Œå®ƒå¯ä»¥ä»å…¨å±€Gé˜Ÿåˆ—è·å–Gã€‚ (3) go func() è°ƒåº¦æµç¨‹ ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥åˆ†æå‡ºå‡ ä¸ªç»“è®ºï¼š â€‹ 1ã€æˆ‘ä»¬é€šè¿‡ go func()æ¥åˆ›å»ºä¸€ä¸ªgoroutineï¼› â€‹ 2ã€æœ‰ä¸¤ä¸ªå­˜å‚¨Gçš„é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯å±€éƒ¨è°ƒåº¦å™¨Pçš„æœ¬åœ°é˜Ÿåˆ—ã€ä¸€ä¸ªæ˜¯å…¨å±€Gé˜Ÿåˆ—ã€‚æ–°åˆ›å»ºçš„Gä¼šå…ˆä¿å­˜åœ¨Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœPçš„æœ¬åœ°é˜Ÿåˆ—å·²ç»æ»¡äº†å°±ä¼šä¿å­˜åœ¨å…¨å±€çš„é˜Ÿåˆ—ä¸­ï¼› â€‹ 3ã€Gåªèƒ½è¿è¡Œåœ¨Mä¸­ï¼Œä¸€ä¸ªMå¿…é¡»æŒæœ‰ä¸€ä¸ªPï¼ŒMä¸Pæ˜¯1ï¼š1çš„å…³ç³»ã€‚Mä¼šä»Pçš„æœ¬åœ°é˜Ÿåˆ—å¼¹å‡ºä¸€ä¸ªå¯æ‰§è¡ŒçŠ¶æ€çš„Gæ¥æ‰§è¡Œï¼Œå¦‚æœPçš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œå°±ä¼šæƒ³å…¶ä»–çš„MPç»„åˆå·å–ä¸€ä¸ªå¯æ‰§è¡Œçš„Gæ¥æ‰§è¡Œï¼› â€‹ 4ã€ä¸€ä¸ªMè°ƒåº¦Gæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªå¾ªç¯æœºåˆ¶ï¼› â€‹ 5ã€å½“Mæ‰§è¡ŒæŸä¸€ä¸ªGæ—¶å€™å¦‚æœå‘ç”Ÿäº†syscallæˆ–åˆ™å…¶ä½™é˜»å¡æ“ä½œï¼ŒMä¼šé˜»å¡ï¼Œå¦‚æœå½“å‰æœ‰ä¸€äº›Gåœ¨æ‰§è¡Œï¼Œruntimeä¼šæŠŠè¿™ä¸ªçº¿ç¨‹Mä»Pä¸­æ‘˜é™¤(detach)ï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹(å¦‚æœæœ‰ç©ºé—²çš„çº¿ç¨‹å¯ç”¨å°±å¤ç”¨ç©ºé—²çº¿ç¨‹)æ¥æœåŠ¡äºè¿™ä¸ªPï¼› â€‹ 6ã€å½“Mç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶å€™ï¼Œè¿™ä¸ªGä¼šå°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„Pæ‰§è¡Œï¼Œå¹¶æ”¾å…¥åˆ°è¿™ä¸ªPçš„æœ¬åœ°é˜Ÿåˆ—ã€‚å¦‚æœè·å–ä¸åˆ°Pï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹Må˜æˆä¼‘çœ çŠ¶æ€ï¼Œ åŠ å…¥åˆ°ç©ºé—²çº¿ç¨‹ä¸­ï¼Œç„¶åè¿™ä¸ªGä¼šè¢«æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ (4)è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸ ç‰¹æ®Šçš„M0å’ŒG0 M0 M0æ˜¯å¯åŠ¨ç¨‹åºåçš„ç¼–å·ä¸º0çš„ä¸»çº¿ç¨‹ï¼Œè¿™ä¸ªMå¯¹åº”çš„å®ä¾‹ä¼šåœ¨å…¨å±€å˜é‡runtime.m0ä¸­ï¼Œä¸éœ€è¦åœ¨heapä¸Šåˆ†é…ï¼ŒM0è´Ÿè´£æ‰§è¡Œåˆå§‹åŒ–æ“ä½œå’Œå¯åŠ¨ç¬¬ä¸€ä¸ªGï¼Œ åœ¨ä¹‹åM0å°±å’Œå…¶ä»–çš„Mä¸€æ ·äº†ã€‚ G0 G0æ˜¯æ¯æ¬¡å¯åŠ¨ä¸€ä¸ªMéƒ½ä¼šç¬¬ä¸€ä¸ªåˆ›å»ºçš„ goroutineï¼ŒG0ä»…ç”¨äºè´Ÿè´£è°ƒåº¦çš„Gï¼ŒG0ä¸æŒ‡å‘ä»»ä½•å¯æ‰§è¡Œçš„å‡½æ•°, æ¯ä¸ªMéƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„G0ã€‚åœ¨è°ƒåº¦æˆ–ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šä½¿ç”¨G0çš„æ ˆç©ºé—´, å…¨å±€å˜é‡çš„G0æ˜¯M0çš„G0ã€‚ æˆ‘ä»¬æ¥è·Ÿè¸ªä¸€æ®µä»£ç  package main import \"fmt\" func main() { fmt.Println(\"Hello world\") } æ¥ä¸‹æ¥æˆ‘ä»¬æ¥é’ˆå¯¹ä¸Šé¢çš„ä»£ç å¯¹è°ƒåº¦å™¨é‡Œé¢çš„ç»“æ„åšä¸€ä¸ªåˆ†æã€‚ ä¹Ÿä¼šç»å†å¦‚ä¸Šå›¾æ‰€ç¤ºçš„è¿‡ç¨‹ï¼š runtimeåˆ›å»ºæœ€åˆçš„çº¿ç¨‹m0å’Œgoroutine g0ï¼Œå¹¶æŠŠ2è€…å…³è”ã€‚ è°ƒåº¦å™¨åˆå§‹åŒ–ï¼šåˆå§‹åŒ–m0ã€æ ˆã€åƒåœ¾å›æ”¶ï¼Œä»¥åŠåˆ›å»ºå’Œåˆå§‹åŒ–ç”±GOMAXPROCSä¸ªPæ„æˆçš„Påˆ—è¡¨ã€‚ ç¤ºä¾‹ä»£ç ä¸­çš„mainå‡½æ•°æ˜¯main.mainï¼Œruntimeä¸­ä¹Ÿæœ‰1ä¸ªmainå‡½æ•°â€”â€”runtime.mainï¼Œä»£ç ç»è¿‡ç¼–è¯‘åï¼Œruntime.mainä¼šè°ƒç”¨main.mainï¼Œç¨‹åºå¯åŠ¨æ—¶ä¼šä¸ºruntime.mainåˆ›å»ºgoroutineï¼Œç§°å®ƒä¸ºmain goroutineå§ï¼Œç„¶åæŠŠmain goroutineåŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚ å¯åŠ¨m0ï¼Œm0å·²ç»ç»‘å®šäº†Pï¼Œä¼šä»Pçš„æœ¬åœ°é˜Ÿåˆ—è·å–Gï¼Œè·å–åˆ°main goroutineã€‚ Gæ‹¥æœ‰æ ˆï¼ŒMæ ¹æ®Gä¸­çš„æ ˆä¿¡æ¯å’Œè°ƒåº¦ä¿¡æ¯è®¾ç½®è¿è¡Œç¯å¢ƒ Mè¿è¡ŒG Gé€€å‡ºï¼Œå†æ¬¡å›åˆ°Mè·å–å¯è¿è¡Œçš„Gï¼Œè¿™æ ·é‡å¤ä¸‹å»ï¼Œç›´åˆ°main.mainé€€å‡ºï¼Œruntime.mainæ‰§è¡ŒDeferå’ŒPanicå¤„ç†ï¼Œæˆ–è°ƒç”¨runtime.exité€€å‡ºç¨‹åºã€‚ è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸå‡ ä¹å æ»¡äº†ä¸€ä¸ªGoç¨‹åºçš„ä¸€ç”Ÿï¼Œruntime.mainçš„goroutineæ‰§è¡Œä¹‹å‰éƒ½æ˜¯ä¸ºè°ƒåº¦å™¨åšå‡†å¤‡å·¥ä½œï¼Œruntime.mainçš„goroutineè¿è¡Œï¼Œæ‰æ˜¯è°ƒåº¦å™¨çš„çœŸæ­£å¼€å§‹ï¼Œç›´åˆ°runtime.mainç»“æŸè€Œç»“æŸã€‚ (5)å¯è§†åŒ–GMPç¼–ç¨‹ æœ‰2ç§æ–¹å¼å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªç¨‹åºçš„GMPçš„æ•°æ®ã€‚ æ–¹å¼1ï¼šgo tool trace traceè®°å½•äº†è¿è¡Œæ—¶çš„ä¿¡æ¯ï¼Œèƒ½æä¾›å¯è§†åŒ–çš„Webé¡µé¢ã€‚ ç®€å•æµ‹è¯•ä»£ç ï¼šmainå‡½æ•°åˆ›å»ºtraceï¼Œtraceä¼šè¿è¡Œåœ¨å•ç‹¬çš„goroutineä¸­ï¼Œç„¶åmainæ‰“å°\"Hello World\"é€€å‡ºã€‚ trace.go package main import ( \"os\" \"fmt\" \"runtime/trace\" ) func main() { //åˆ›å»ºtraceæ–‡ä»¶ f, err := os.Create(\"trace.out\") if err != nil { panic(err) } defer f.Close() //å¯åŠ¨trace goroutine err = trace.Start(f) if err != nil { panic(err) } defer trace.Stop() //main fmt.Println(\"Hello World\") } è¿è¡Œç¨‹åº $ go run trace.go Hello World ä¼šå¾—åˆ°ä¸€ä¸ªtrace.outæ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªå·¥å…·æ‰“å¼€ï¼Œæ¥åˆ†æè¿™ä¸ªæ–‡ä»¶ã€‚ $ go tool trace trace.out 2020/02/23 10:44:11 Parsing trace... 2020/02/23 10:44:11 Splitting trace... 2020/02/23 10:44:11 Opening browser. Trace viewer is listening on http://127.0.0.1:33479 æˆ‘ä»¬å¯ä»¥é€šè¿‡æµè§ˆå™¨æ‰“å¼€http://127.0.0.1:33479ç½‘å€ï¼Œç‚¹å‡»view trace èƒ½å¤Ÿçœ‹è§å¯è§†åŒ–çš„è°ƒåº¦æµç¨‹ã€‚ Gä¿¡æ¯ ç‚¹å‡»Goroutinesé‚£ä¸€è¡Œå¯è§†åŒ–çš„æ•°æ®æ¡ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€äº›è¯¦ç»†çš„ä¿¡æ¯ã€‚ ä¸€å…±æœ‰ä¸¤ä¸ªGåœ¨ç¨‹åºä¸­ï¼Œä¸€ä¸ªæ˜¯ç‰¹æ®Šçš„G0ï¼Œæ˜¯æ¯ä¸ªMå¿…é¡»æœ‰çš„ä¸€ä¸ªåˆå§‹åŒ–çš„Gï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸å¿…è®¨è®ºã€‚\r å…¶ä¸­G1åº”è¯¥å°±æ˜¯main goroutine(æ‰§è¡Œmainå‡½æ•°çš„åç¨‹)ï¼Œåœ¨ä¸€æ®µæ—¶é—´å†…å¤„äºå¯è¿è¡Œå’Œè¿è¡Œçš„çŠ¶æ€ã€‚ Mä¿¡æ¯ ç‚¹å‡»Threadsé‚£ä¸€è¡Œå¯è§†åŒ–çš„æ•°æ®æ¡ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€äº›è¯¦ç»†çš„ä¿¡æ¯ã€‚ ä¸€å…±æœ‰ä¸¤ä¸ªMåœ¨ç¨‹åºä¸­ï¼Œä¸€ä¸ªæ˜¯ç‰¹æ®Šçš„M0ï¼Œç”¨äºåˆå§‹åŒ–ä½¿ç”¨ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸å¿…è®¨è®ºã€‚ Pä¿¡æ¯ G1ä¸­è°ƒç”¨äº†main.mainï¼Œåˆ›å»ºäº†trace goroutine g18ã€‚G1è¿è¡Œåœ¨P1ä¸Šï¼ŒG18è¿è¡Œåœ¨P0ä¸Šã€‚ è¿™é‡Œæœ‰ä¸¤ä¸ªPï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªPå¿…é¡»ç»‘å®šä¸€ä¸ªMæ‰èƒ½è°ƒåº¦Gã€‚ æˆ‘ä»¬åœ¨æ¥çœ‹çœ‹ä¸Šé¢çš„Mä¿¡æ¯ã€‚ æˆ‘ä»¬ä¼šå‘ç°ï¼Œç¡®å®G18åœ¨P0ä¸Šè¢«è¿è¡Œçš„æ—¶å€™ï¼Œç¡®å®åœ¨Threadsè¡Œå¤šäº†ä¸€ä¸ªMçš„æ•°æ®ï¼Œç‚¹å‡»æŸ¥çœ‹å¦‚ä¸‹ï¼š å¤šäº†ä¸€ä¸ªM2åº”è¯¥å°±æ˜¯P0ä¸ºäº†æ‰§è¡ŒG18è€ŒåŠ¨æ€åˆ›å»ºçš„M2. æ–¹å¼2ï¼šDebug trace package main import ( \"fmt\" \"time\" ) func main() { for i := 0; i \u003c 5; i++ { time.Sleep(time.Second) fmt.Println(\"Hello World\") } } ç¼–è¯‘ $ go build trace2.go é€šè¿‡Debugæ–¹å¼è¿è¡Œ $ GODEBUG=schedtrace=1000 ./trace2 SCHED 0ms: gomaxprocs=2 idleprocs=0 threads=4 spinningthreads=1 idlethreads=1 runqueue=0 [0 0] Hello World SCHED 1003ms: gomaxprocs=2 idleprocs=2 threads=4 spinningthreads=0 idlethreads=2 runqueue=0 [0 0] Hello World SCHED 2014ms: gomaxprocs=2 idleprocs=2 threads=4 spinningthreads=0 idlethreads=2 runqueue=0 [0 0] Hello World SCHED 3015ms: gomaxprocs=2 idleprocs=2 threads=4 spinningthreads=0 idlethreads=2 runqueue=0 [0 0] Hello World SCHED 4023ms: gomaxprocs=2 idleprocs=2 threads=4 spinningthreads=0 idlethreads=2 runqueue=0 [0 0] Hello World SCHEDï¼šè°ƒè¯•ä¿¡æ¯è¾“å‡ºæ ‡å¿—å­—ç¬¦ä¸²ï¼Œä»£è¡¨æœ¬è¡Œæ˜¯goroutineè°ƒåº¦å™¨çš„è¾“å‡ºï¼› 0msï¼šå³ä»ç¨‹åºå¯åŠ¨åˆ°è¾“å‡ºè¿™è¡Œæ—¥å¿—çš„æ—¶é—´ï¼› gomaxprocs: Pçš„æ•°é‡ï¼Œæœ¬ä¾‹æœ‰2ä¸ªP, å› ä¸ºé»˜è®¤çš„Pçš„å±æ€§æ˜¯å’Œcpuæ ¸å¿ƒæ•°é‡é»˜è®¤ä¸€è‡´ï¼Œå½“ç„¶ä¹Ÿ","date":"2022-04-12","objectID":"/gmp/:6:2","tags":["é¢è¯•"],"title":"GMP","uri":"/gmp/"},{"categories":["é¢è¯•"],"content":"ç©ºåˆ‡ç‰‡å’Œnilåˆ‡ç‰‡ é—®é¢˜ï¼š package main import ( \"fmt\" \"reflect\" \"unsafe\" ) func main() { var s1 []int // nilåˆ‡ç‰‡ s2 := make([]int,0) // ç©ºåˆ‡ç‰‡ s4 := make([]int,0) // ç©ºåˆ‡ç‰‡ fmt.Printf(\"s1 pointer:%+v, s2 pointer:%+v, s4 pointer:%+v, \\n\", *(*reflect.SliceHeader)(unsafe.Pointer(\u0026s1)),*(*reflect.SliceHeader)(unsafe.Pointer(\u0026s2)),*(*reflect.SliceHeader)(unsafe.Pointer(\u0026s4))) fmt.Printf(\"%v\\n\", (*(*reflect.SliceHeader)(unsafe.Pointer(\u0026s1))).Data==(*(*reflect.SliceHeader)(unsafe.Pointer(\u0026s2))).Data) fmt.Printf(\"%v\\n\", (*(*reflect.SliceHeader)(unsafe.Pointer(\u0026s2))).Data==(*(*reflect.SliceHeader)(unsafe.Pointer(\u0026s4))).Data) } nilåˆ‡ç‰‡å’Œç©ºåˆ‡ç‰‡æŒ‡å‘çš„åœ°å€ä¸€æ ·å—ï¼Ÿè¿™ä¸ªä»£ç ä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿ ç­”ï¼š nilåˆ‡ç‰‡å’Œç©ºåˆ‡ç‰‡æŒ‡å‘çš„åœ°å€ä¸ä¸€æ ·ã€‚nilç©ºåˆ‡ç‰‡å¼•ç”¨æ•°ç»„æŒ‡é’ˆåœ°å€ä¸º0ï¼ˆæ— æŒ‡å‘ä»»ä½•å®é™…åœ°å€ï¼‰ ç©ºåˆ‡ç‰‡çš„å¼•ç”¨æ•°ç»„æŒ‡é’ˆåœ°å€æ˜¯æœ‰çš„ï¼Œä¸”å›ºå®šä¸ºä¸€ä¸ªå€¼ s1 pointer:{Data:0 Len:0 Cap:0}, s2 pointer:{Data:824634207952 Len:0 Cap:0}, s4 pointer:{Data:824634207952 Len:0 Cap:0}, false //nilåˆ‡ç‰‡å’Œç©ºåˆ‡ç‰‡æŒ‡å‘çš„æ•°ç»„åœ°å€ä¸ä¸€æ · true //ä¸¤ä¸ªç©ºåˆ‡ç‰‡æŒ‡å‘çš„æ•°ç»„åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯824634207952 è§£é‡Š åˆ‡ç‰‡çš„æ•°æ®ç»“æ„ï¼š type SliceHeader struct { Data uintptr //å¼•ç”¨æ•°ç»„æŒ‡é’ˆåœ°å€ Len int // åˆ‡ç‰‡çš„ç›®å‰ä½¿ç”¨é•¿åº¦ Cap int // åˆ‡ç‰‡çš„å®¹é‡ } nilåˆ‡ç‰‡å’Œç©ºåˆ‡ç‰‡æœ€å¤§çš„åŒºåˆ«åœ¨äºæŒ‡å‘çš„æ•°ç»„å¼•ç”¨åœ°å€æ˜¯ä¸ä¸€æ ·çš„ã€‚ æ‰€æœ‰çš„ç©ºåˆ‡ç‰‡æŒ‡å‘çš„æ•°ç»„å¼•ç”¨åœ°å€éƒ½æ˜¯ä¸€æ ·çš„ ","date":"2022-04-11","objectID":"/%E7%A9%BA%E5%88%87%E7%89%87%E5%92%8Cnil%E5%88%87%E7%89%87/:0:0","tags":["é¢è¯•"],"title":"ç©ºåˆ‡ç‰‡å’Œnilåˆ‡ç‰‡","uri":"/%E7%A9%BA%E5%88%87%E7%89%87%E5%92%8Cnil%E5%88%87%E7%89%87/"},{"categories":["é¢è¯•"],"content":"Channel æ¦‚å¿µï¼š Goä¸­çš„channel æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œéµå¾ªå…ˆè¿›å…ˆå‡ºçš„åŸåˆ™ï¼Œè´Ÿè´£åç¨‹ä¹‹é—´çš„é€šä¿¡ï¼ˆGo è¯­è¨€æå€¡ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè€Œè¦é€šè¿‡é€šä¿¡æ¥å®ç°å†…å­˜å…±äº«ï¼ŒCSP(Communicating Sequential Process)å¹¶å‘æ¨¡å‹ï¼Œå°±æ˜¯é€šè¿‡ goroutine å’Œ channel æ¥å®ç°çš„ï¼‰ ä½¿ç”¨åœºæ™¯ï¼š åœæ­¢ä¿¡å·ç›‘å¬ å®šæ—¶ä»»åŠ¡ ç”Ÿäº§æ–¹å’Œæ¶ˆè´¹æ–¹è§£è€¦ æ§åˆ¶å¹¶å‘æ•° åº•å±‚æ•°æ®ç»“æ„ï¼š é€šè¿‡varå£°æ˜æˆ–è€…makeå‡½æ•°åˆ›å»ºçš„channelå˜é‡æ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨å‡½æ•°æ ˆå¸§ä¸Šçš„æŒ‡é’ˆï¼Œå ç”¨8ä¸ªå­—èŠ‚ï¼ŒæŒ‡å‘å †ä¸Šçš„hchanç»“æ„ä½“ æºç åŒ…ä¸­src/runtime/chan.goå®šä¹‰äº†hchançš„æ•°æ®ç»“æ„ï¼š type hchan struct { closed uint32 // channelæ˜¯å¦å…³é—­çš„æ ‡å¿— elemtype *_type // channelä¸­çš„å…ƒç´ ç±»å‹ // channelåˆ†ä¸ºæ— ç¼“å†²å’Œæœ‰ç¼“å†²ä¸¤ç§ã€‚ // å¯¹äºæœ‰ç¼“å†²çš„channelå­˜å‚¨æ•°æ®ï¼Œä½¿ç”¨äº† ring bufferï¼ˆç¯å½¢ç¼“å†²åŒº) æ¥ç¼“å­˜å†™å…¥çš„æ•°æ®ï¼Œæœ¬è´¨æ˜¯å¾ªç¯æ•°ç»„ // ä¸ºå•¥æ˜¯å¾ªç¯æ•°ç»„ï¼Ÿæ™®é€šæ•°ç»„ä¸è¡Œå—ï¼Œæ™®é€šæ•°ç»„å®¹é‡å›ºå®šæ›´é€‚åˆæŒ‡å®šçš„ç©ºé—´ï¼Œå¼¹å‡ºå…ƒç´ æ—¶ï¼Œæ™®é€šæ•°ç»„éœ€è¦å…¨éƒ¨éƒ½å‰ç§» // å½“ä¸‹æ ‡è¶…è¿‡æ•°ç»„å®¹é‡åä¼šå›åˆ°ç¬¬ä¸€ä¸ªä½ç½®ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸¤ä¸ªå­—æ®µè®°å½•å½“å‰è¯»å’Œå†™çš„ä¸‹æ ‡ä½ç½® buf unsafe.Pointer // æŒ‡å‘åº•å±‚å¾ªç¯æ•°ç»„çš„æŒ‡é’ˆï¼ˆç¯å½¢ç¼“å†²åŒºï¼‰ qcount uint // å¾ªç¯æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ dataqsiz uint // å¾ªç¯æ•°ç»„çš„é•¿åº¦ elemsize uint16 // å…ƒç´ çš„å¤§å° sendx uint // ä¸‹ä¸€æ¬¡å†™ä¸‹æ ‡çš„ä½ç½® recvx uint // ä¸‹ä¸€æ¬¡è¯»ä¸‹æ ‡çš„ä½ç½® // å°è¯•è¯»å–channelæˆ–å‘channelå†™å…¥æ•°æ®è€Œè¢«é˜»å¡çš„goroutine recvq waitq // è¯»ç­‰å¾…é˜Ÿåˆ— sendq waitq // å†™ç­‰å¾…é˜Ÿåˆ— lock mutex //äº’æ–¥é”ï¼Œä¿è¯è¯»å†™channelæ—¶ä¸å­˜åœ¨å¹¶å‘ç«äº‰é—®é¢˜ } ç­‰å¾…é˜Ÿåˆ—ï¼š åŒå‘é“¾è¡¨ï¼ŒåŒ…å«ä¸€ä¸ªå¤´ç»“ç‚¹å’Œä¸€ä¸ªå°¾ç»“ç‚¹ æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªsudogç»“æ„ä½“å˜é‡ï¼Œè®°å½•å“ªä¸ªåç¨‹åœ¨ç­‰å¾…ï¼Œç­‰å¾…çš„æ˜¯å“ªä¸ªchannelï¼Œç­‰å¾…å‘é€/æ¥æ”¶çš„æ•°æ®åœ¨å“ªé‡Œ type waitq struct { first *sudog last *sudog } type sudog struct { g *g next *sudog prev *sudog elem unsafe.Pointer c *hchan ... } æ“ä½œï¼š åˆ›å»º ä½¿ç”¨ make(chan T, cap) æ¥åˆ›å»º channelï¼Œmake è¯­æ³•ä¼šåœ¨ç¼–è¯‘æ—¶ï¼Œè½¬æ¢ä¸º makechan64 å’Œ makechan func makechan64(t *chantype, size int64) *hchan { if int64(int(size)) != size { panic(plainError(\"makechan: size out of range\")) } return makechan(t, int(size)) } åˆ›å»ºchannel æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å¸¦ç¼“å†²çš„channelï¼Œä¸€ç§æ˜¯ä¸å¸¦ç¼“å†²çš„channel // å¸¦ç¼“å†² ch := make(chan int, 3) // ä¸å¸¦ç¼“å†² ch := make(chan int) åˆ›å»ºæ—¶ä¼šåšä¸€äº›æ£€æŸ¥: å…ƒç´ å¤§å°ä¸èƒ½è¶…è¿‡ 64K å…ƒç´ çš„å¯¹é½å¤§å°ä¸èƒ½è¶…è¿‡ maxAlign ä¹Ÿå°±æ˜¯ 8 å­—èŠ‚ è®¡ç®—å‡ºæ¥çš„å†…å­˜æ˜¯å¦è¶…è¿‡é™åˆ¶ åˆ›å»ºæ—¶çš„ç­–ç•¥: å¦‚æœæ˜¯æ— ç¼“å†²çš„ channelï¼Œä¼šç›´æ¥ç»™ hchan åˆ†é…å†…å­˜ å¦‚æœæ˜¯æœ‰ç¼“å†²çš„ channelï¼Œå¹¶ä¸”å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆï¼Œé‚£ä¹ˆä¼šä¸º hchan å’Œåº•å±‚æ•°ç»„åˆ†é…ä¸€æ®µè¿ç»­çš„åœ°å€ å¦‚æœæ˜¯æœ‰ç¼“å†²çš„ channelï¼Œå¹¶ä¸”å…ƒç´ åŒ…å«æŒ‡é’ˆï¼Œé‚£ä¹ˆä¼šä¸º hchan å’Œåº•å±‚æ•°ç»„åˆ†åˆ«åˆ†é…åœ°å€ å‘é€ å‘é€æ“ä½œï¼Œç¼–è¯‘æ—¶è½¬æ¢ä¸ºruntime.chansendå‡½æ•° func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool é˜»å¡å¼ï¼š è°ƒç”¨chansendå‡½æ•°ï¼Œå¹¶ä¸”block=true ch \u003c- 10 éé˜»å¡å¼ï¼š è°ƒç”¨chansendå‡½æ•°ï¼Œå¹¶ä¸”block=false select { case ch \u003c- 10: ... default } å‘ channel ä¸­å‘é€æ•°æ®æ—¶å¤§æ¦‚åˆ†ä¸ºä¸¤å¤§å—ï¼šæ£€æŸ¥å’Œæ•°æ®å‘é€ï¼Œæ•°æ®å‘é€æµç¨‹å¦‚ä¸‹ï¼š å¦‚æœ channel çš„è¯»ç­‰å¾…é˜Ÿåˆ—å­˜åœ¨æ¥æ”¶è€…goroutine å°†æ•°æ®ç›´æ¥å‘é€ç»™ç¬¬ä¸€ä¸ªç­‰å¾…çš„ goroutineï¼Œ å”¤é†’æ¥æ”¶çš„ goroutine å¦‚æœ channel çš„è¯»ç­‰å¾…é˜Ÿåˆ—ä¸å­˜åœ¨æ¥æ”¶è€…goroutine å¦‚æœå¾ªç¯æ•°ç»„bufæœªæ»¡ï¼Œé‚£ä¹ˆå°†ä¼šæŠŠæ•°æ®å‘é€åˆ°å¾ªç¯æ•°ç»„bufçš„é˜Ÿå°¾ å¦‚æœå¾ªç¯æ•°ç»„bufå·²æ»¡ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šèµ°é˜»å¡å‘é€çš„æµç¨‹ï¼Œå°†å½“å‰ goroutine åŠ å…¥å†™ç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶æŒ‚èµ·ç­‰å¾…å”¤é†’ æ¥æ”¶ å‘é€æ“ä½œï¼Œç¼–è¯‘æ—¶è½¬æ¢ä¸ºruntime.chanrecvå‡½æ•° func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) é˜»å¡å¼ï¼š è°ƒç”¨chanrecvå‡½æ•°ï¼Œå¹¶ä¸”block=true \u003cch v := \u003cch v, ok := \u003cch // å½“channelå…³é—­æ—¶ï¼Œforå¾ªç¯ä¼šè‡ªåŠ¨é€€å‡ºï¼Œæ— éœ€ä¸»åŠ¨ç›‘æµ‹channelæ˜¯å¦å…³é—­ï¼Œå¯ä»¥é˜²æ­¢è¯»å–å·²ç»å…³é—­çš„channel,é€ æˆè¯»åˆ°æ•°æ®ä¸ºé€šé“æ‰€å­˜å‚¨çš„æ•°æ®ç±»å‹çš„é›¶å€¼ for i := range ch { fmt.Println(i) } éé˜»å¡å¼ï¼š è°ƒç”¨chanrecvå‡½æ•°ï¼Œå¹¶ä¸”block=false select { case \u003c-ch: ... default } å‘ channel ä¸­æ¥æ”¶æ•°æ®æ—¶å¤§æ¦‚åˆ†ä¸ºä¸¤å¤§å—ï¼Œæ£€æŸ¥å’Œæ•°æ®å‘é€ï¼Œè€Œæ•°æ®æ¥æ”¶æµç¨‹å¦‚ä¸‹ï¼š å¦‚æœ channel çš„å†™ç­‰å¾…é˜Ÿåˆ—å­˜åœ¨å‘é€è€…goroutine å¦‚æœæ˜¯æ— ç¼“å†² channelï¼Œç›´æ¥ä»ç¬¬ä¸€ä¸ªå‘é€è€…goroutineé‚£é‡ŒæŠŠæ•°æ®æ‹·è´ç»™æ¥æ”¶å˜é‡ï¼Œå”¤é†’å‘é€çš„ goroutine å¦‚æœæ˜¯æœ‰ç¼“å†² channelï¼ˆå·²æ»¡ï¼‰ï¼Œå°†å¾ªç¯æ•°ç»„bufçš„é˜Ÿé¦–å…ƒç´ æ‹·è´ç»™æ¥æ”¶å˜é‡ï¼Œå°†ç¬¬ä¸€ä¸ªå‘é€è€…goroutineçš„æ•°æ®æ‹·è´åˆ° bufå¾ªç¯æ•°ç»„é˜Ÿå°¾ï¼Œå”¤é†’å‘é€çš„ goroutine å¦‚æœ channel çš„å†™ç­‰å¾…é˜Ÿåˆ—ä¸å­˜åœ¨å‘é€è€…goroutine å¦‚æœå¾ªç¯æ•°ç»„buféç©ºï¼Œå°†å¾ªç¯æ•°ç»„bufçš„é˜Ÿé¦–å…ƒç´ æ‹·è´ç»™æ¥æ”¶å˜é‡ å¦‚æœå¾ªç¯æ•°ç»„bufä¸ºç©ºï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šèµ°é˜»å¡æ¥æ”¶çš„æµç¨‹ï¼Œå°†å½“å‰ goroutine åŠ å…¥è¯»ç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶æŒ‚èµ·ç­‰å¾…å”¤é†’ å…³é—­ å…³é—­æ“ä½œï¼Œè°ƒç”¨closeå‡½æ•°ï¼Œç¼–è¯‘æ—¶è½¬æ¢ä¸ºruntime.closechanå‡½æ•° close(ch) func closechan(c *hchan) æ¡ˆä¾‹åˆ†æï¼š package main import ( \"fmt\" \"time\" \"unsafe\" ) func main() { // chæ˜¯é•¿åº¦ä¸º4çš„å¸¦ç¼“å†²çš„channel // åˆå§‹hchanç»“æ„ä½“é‡çš„bufä¸ºç©ºï¼Œsendxå’Œrecvxå‡ä¸º0 ch := make(chan string, 4) fmt.Println(ch, unsafe.Sizeof(ch)) go sendTask(ch) go receiveTask(ch) time.Sleep(1 * time.Second) } // G1æ˜¯å‘é€è€… // å½“G1å‘ché‡Œå‘é€æ•°æ®æ—¶ï¼Œé¦–å…ˆä¼šå¯¹bufåŠ é”ï¼Œç„¶åå°†taskå­˜å‚¨çš„æ•°æ®copyåˆ°bufä¸­ï¼Œç„¶åsendx++ï¼Œç„¶åé‡Šæ”¾å¯¹bufçš„é” func sendTask(ch chan string) { taskList := []string{\"this\", \"is\", \"a\", \"demo\"} for _, task := range taskList { ch \u003c- task //å‘é€ä»»åŠ¡åˆ°channel } } // G2æ˜¯æ¥æ”¶è€… // å½“G2æ¶ˆè´¹chçš„æ—¶å€™ï¼Œä¼šé¦–å…ˆå¯¹bufåŠ é”ï¼Œç„¶åå°†bufä¸­çš„æ•°æ®copyåˆ°taskå˜é‡å¯¹åº”çš„å†…å­˜é‡Œï¼Œç„¶årecvx++,å¹¶é‡Šæ”¾é” func receiveTask(ch chan string) { for { task := \u003c-ch //æ¥æ”¶ä»»åŠ¡ fmt.Println(\"received\", task) //å¤„ç†ä»»åŠ¡ } } æ€»ç»“ hchanç»“æ„ä½“çš„ä¸»è¦ç»„æˆéƒ¨åˆ†æœ‰å››ä¸ªï¼š ç”¨æ¥ä¿å­˜goroutineä¹‹é—´ä¼ é€’æ•°æ®çš„å¾ªç¯æ•°ç»„ï¼šbuf ç”¨æ¥è®°å½•æ­¤å¾ªç¯æ•°ç»„å½“å‰å‘é€æˆ–æ¥æ”¶æ•°æ®çš„ä¸‹æ ‡å€¼ï¼šsendxå’Œrecvx ç”¨äºä¿å­˜å‘è¯¥chanå‘é€å’Œä»è¯¥chanæ¥æ”¶æ•°æ®è¢«é˜»å¡çš„goroutineé˜Ÿåˆ—ï¼š sendq å’Œ recvq ä¿è¯channelå†™å…¥å’Œè¯»å–æ•°æ®æ—¶çº¿ç¨‹å®‰å…¨çš„é”ï¼šlock ","date":"2022-04-11","objectID":"/channel/:0:0","tags":["é¢è¯•"],"title":"Channel","uri":"/channel/"},{"categories":["é¢è¯•"],"content":"å¯¹æœªåˆå§‹åŒ–çš„çš„chanè¿›è¡Œè¯»å†™ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ ç­”ï¼š å†™æœªåˆå§‹åŒ–çš„ chan package main // å†™æœªåˆå§‹åŒ–çš„chan func main() { var c chan int c \u003c- 1 } // è¾“å‡ºç»“æœ fatal error: all goroutines are asleep - deadlock! goroutine 1 [chan send (nil chan)]: main.main() /Users/admin18/go/src/code.byted.org/linzhaolun/repos/main.go:6 +0x36 å†™è¯»æœªåˆå§‹åŒ–çš„ chan package main import \"fmt\" // è¯»æœªåˆå§‹åŒ–çš„chan func main() { var c chan int num, ok := \u003c-c fmt.Printf(\"è¯»chançš„åç¨‹ç»“æŸ, num=%v, ok=%v\\n\", num, ok) } // è¾“å‡ºç»“æœ fatal error: all goroutines are asleep - deadlock! goroutine 1 [chan receive (nil chan)]: main.main() /Users/admin18/go/src/code.byted.org/linzhaolun/repos/main.go:6 +0x46 ä¸ºä»€ä¹ˆå¯¹æœªåˆå§‹åŒ–çš„ chan å°±ä¼šé˜»å¡å‘¢ï¼Ÿ å¯¹äºå†™çš„æƒ…å†µ //åœ¨ src/runtime/chan.goä¸­ func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool { if c == nil { // ä¸èƒ½é˜»å¡ï¼Œç›´æ¥è¿”å› falseï¼Œè¡¨ç¤ºæœªå‘é€æˆåŠŸ if !block { return false } gopark(nil, nil, waitReasonChanSendNilChan, traceEvGoStop, 2) throw(\"unreachable\") } // çœç•¥å…¶ä»–é€»è¾‘ } æœªåˆå§‹åŒ–çš„ chan æ­¤æ—¶æ˜¯ç­‰äº nilï¼Œå½“å®ƒä¸èƒ½é˜»å¡çš„æƒ…å†µä¸‹ï¼Œç›´æ¥è¿”å› falseï¼Œè¡¨ç¤ºå†™ chan å¤±è´¥ å½“ chan èƒ½é˜»å¡çš„æƒ…å†µä¸‹ï¼Œåˆ™ç›´æ¥é˜»å¡ gopark(nil, nil, waitReasonChanSendNilChan, traceEvGoStop, 2), ç„¶åè°ƒç”¨ throw(s string) æŠ›å‡ºé”™è¯¯ï¼Œå…¶ä¸­ waitReasonChanSendNilChan å°±æ˜¯åˆšåˆšæåˆ°çš„æŠ¥é”™ â€œchan send (nil chan)â€ å¯¹äºè¯»çš„æƒ…å†µ //åœ¨ src/runtime/chan.goä¸­ func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) { //çœç•¥é€»è¾‘... if c == nil { if !block { return } gopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2) throw(\"unreachable\") } //çœç•¥é€»è¾‘... } æœªåˆå§‹åŒ–çš„ chan æ­¤æ—¶æ˜¯ç­‰äº nilï¼Œå½“å®ƒä¸èƒ½é˜»å¡çš„æƒ…å†µä¸‹ï¼Œç›´æ¥è¿”å› falseï¼Œè¡¨ç¤ºè¯» chan å¤±è´¥ å½“ chan èƒ½é˜»å¡çš„æƒ…å†µä¸‹ï¼Œåˆ™ç›´æ¥é˜»å¡ gopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2), ç„¶åè°ƒç”¨ throw(s string) æŠ›å‡ºé”™è¯¯ï¼Œå…¶ä¸­ waitReasonChanReceiveNilChan å°±æ˜¯åˆšåˆšæåˆ°çš„æŠ¥é”™ â€œchan receive (nil chan)â€ ","date":"2022-04-11","objectID":"/channel/:1:0","tags":["é¢è¯•"],"title":"Channel","uri":"/channel/"},{"categories":["é¢è¯•"],"content":"1.for selectæ—¶ï¼Œå¦‚æœé€šé“å·²ç»å…³é—­ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦‚æœselectä¸­åªæœ‰ä¸€ä¸ªcaseå‘¢ï¼Ÿ ç­”ï¼š forå¾ªç¯selectæ—¶ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªcaseé€šé“å·²ç»å…³é—­ï¼Œåˆ™æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œåˆ°è¿™ä¸ªcaseã€‚ å¦‚æœselecté‡Œè¾¹åªæœ‰ä¸€ä¸ªcaseï¼Œè€Œè¿™ä¸ªcaseè¢«å…³é—­äº†ï¼Œåˆ™ä¼šå‡ºç°æ­»å¾ªç¯ã€‚ package _for import ( \"fmt\" \"testing\" \"time\" ) //é—®é¢˜ï¼šfor selectæ—¶ï¼Œå¦‚æœé€šé“å·²ç»å…³é—­ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦‚æœselectä¸­åªæœ‰ä¸€ä¸ªcaseå‘¢ï¼Ÿ //ç»“æœï¼šå½“æœªæœ‰å€¼æ—¶ï¼Œç”±äºç¼“å­˜ä¸º0ï¼Œ\u003c-ch æ²¡æ•°æ®ï¼Œåˆ™ä¸€ç›´èµ°defaultï¼Œå½“æœ‰å€¼è¾“å…¥åï¼Œä½†æ˜¯åœ¨é€šé“å…³é—­åï¼Œè¿™ä¸ªé€šé“ä¸€ç›´èƒ½è¯»å‡ºå†…å®¹ã€‚ func TestForCase(t *testing.T) { ch := make(chan int) go func() { time.Sleep(time.Second * 1) ch \u003c- 1 close(ch) }() for { select { case a, ok := \u003c-ch: fmt.Printf(\"fmt:%d time:%v %v \\t\\n\", a, time.Now(), ok) time.Sleep(500 * time.Millisecond) default: fmt.Println(\"å’©æœ‰è¯»å‡ºæ¥\") time.Sleep(500 * time.Millisecond) } } } ç»“æœ: === RUN TestForCase å’©æœ‰è¯»å‡ºæ¥ å’©æœ‰è¯»å‡ºæ¥ fmt:1 time:2022-04-11 23:01:15.691889 +0800 CST m=+1.005903641 true fmt:0 time:2022-04-11 23:01:16.193244 +0800 CST m=+1.507252014 false fmt:0 time:2022-04-11 23:01:16.694997 +0800 CST m=+2.008997910 false ","date":"2022-04-11","objectID":"/for-select%E6%97%B6%E5%A6%82%E6%9E%9C%E9%80%9A%E9%81%93%E5%B7%B2%E7%BB%8F%E5%85%B3%E9%97%AD%E4%BC%9A%E6%80%8E%E4%B9%88%E6%A0%B7/:1:0","tags":["é¢è¯•"],"title":"é¢è¯•é¢˜","uri":"/for-select%E6%97%B6%E5%A6%82%E6%9E%9C%E9%80%9A%E9%81%93%E5%B7%B2%E7%BB%8F%E5%85%B3%E9%97%AD%E4%BC%9A%E6%80%8E%E4%B9%88%E6%A0%B7/"},{"categories":["é¢è¯•"],"content":"2.æ€ä¹ˆæ ·æ‰èƒ½ä¸è¯»å…³é—­åé€šé“ func TestForCase2(t *testing.T) { ch := make(chan int) go func() { time.Sleep(time.Second * 1) ch \u003c- 1 close(ch) }() for { select { case a, ok := \u003c-ch: fmt.Printf(\"fmt:%d time:%v %v \\t\\n\", a, time.Now(), ok) time.Sleep(500 * time.Millisecond) if !ok { ch = nil //æŠŠå…³é—­åçš„é€šé“å¤å€¼ä¸ºnilï¼Œåˆ™selectè¯»å–åˆ™ä¼šé˜»å¡ } default: fmt.Println(\"å’©æœ‰è¯»å‡ºæ¥\") time.Sleep(500 * time.Millisecond) } } } === RUN TestForCase2 å’©æœ‰è¯»å‡ºæ¥ å’©æœ‰è¯»å‡ºæ¥ å’©æœ‰è¯»å‡ºæ¥ fmt:1 time:2022-04-11 23:16:03.751807 +0800 CST m=+1.506454927 true fmt:0 time:2022-04-11 23:16:04.253248 +0800 CST m=+2.007888277 false å’©æœ‰è¯»å‡ºæ¥ å’©æœ‰è¯»å‡ºæ¥ å’©æœ‰è¯»å‡ºæ¥ ","date":"2022-04-11","objectID":"/for-select%E6%97%B6%E5%A6%82%E6%9E%9C%E9%80%9A%E9%81%93%E5%B7%B2%E7%BB%8F%E5%85%B3%E9%97%AD%E4%BC%9A%E6%80%8E%E4%B9%88%E6%A0%B7/:2:0","tags":["é¢è¯•"],"title":"é¢è¯•é¢˜","uri":"/for-select%E6%97%B6%E5%A6%82%E6%9E%9C%E9%80%9A%E9%81%93%E5%B7%B2%E7%BB%8F%E5%85%B3%E9%97%AD%E4%BC%9A%E6%80%8E%E4%B9%88%E6%A0%B7/"},{"categories":["é¢è¯•"],"content":"3.å¦‚æœselecté‡Œåªæœ‰ä¸€ä¸ªå·²ç»å…³é—­çš„caseï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿ func TestForCase2(t *testing.T) { ch := make(chan int) go func() { time.Sleep(time.Second * 1) ch \u003c- 1 close(ch) }() for { select { case a, ok := \u003c-ch: fmt.Printf(\"fmt:%d time:%v %v \\t\\n\", a, time.Now(), ok) time.Sleep(500 * time.Millisecond) if !ok { ch = nil //æŠŠå…³é—­åçš„é€šé“å¤å€¼ä¸ºnilï¼Œåˆ™selectè¯»å–åˆ™ä¼šé˜»å¡ } //default: // fmt.Println(\"å’©æœ‰è¯»å‡ºæ¥\") // time.Sleep(500 * time.Millisecond) } } } === RUN TestForCase2 fmt:1 time:2022-04-11 23:19:03.189441 +0800 CST m=+1.003139137 true fmt:0 time:2022-04-11 23:19:03.693051 +0800 CST m=+1.506741808 false fatal error: all goroutines are asleep - deadlock! goroutine 1 [chan receive]: testing.(*T).Run(0xc000001500, 0x11a0fe9, 0xc, 0x11a94f0, 0x62544600) /usr/local/Cellar/go/1.15.5/libexec/src/testing/testing.go:1169 +0x676 æ€»ç»“ selectä¸­å¦‚æœä»»æ„æŸä¸ªé€šé“æœ‰å€¼å¯è¯»æ—¶ï¼Œå®ƒå°±ä¼šè¢«æ‰§è¡Œï¼Œå…¶ä»–è¢«å¿½ç•¥ã€‚ å¦‚æœæ²¡æœ‰defaultå­—å¥ï¼Œselectå°†æœ‰å¯èƒ½é˜»å¡ï¼Œç›´åˆ°æŸä¸ªé€šé“æœ‰å€¼å¯ä»¥è¿è¡Œï¼Œæ‰€ä»¥selecté‡Œæœ€å¥½æœ‰ä¸€ä¸ªdefaultï¼Œå¦åˆ™å°†æœ‰ä¸€ç›´é˜»å¡çš„é£é™©ã€‚ ","date":"2022-04-11","objectID":"/for-select%E6%97%B6%E5%A6%82%E6%9E%9C%E9%80%9A%E9%81%93%E5%B7%B2%E7%BB%8F%E5%85%B3%E9%97%AD%E4%BC%9A%E6%80%8E%E4%B9%88%E6%A0%B7/:3:0","tags":["é¢è¯•"],"title":"é¢è¯•é¢˜","uri":"/for-select%E6%97%B6%E5%A6%82%E6%9E%9C%E9%80%9A%E9%81%93%E5%B7%B2%E7%BB%8F%E5%85%B3%E9%97%AD%E4%BC%9A%E6%80%8E%E4%B9%88%E6%A0%B7/"},{"categories":["é¢è¯•"],"content":"é›¶æ‹·è´ ä¼ ç»Ÿçš„I/Oæ“ä½œåŸºæœ¬ä¸Šè¦åˆ†ä¸ºå››æ­¥ï¼š ç£ç›˜æ–‡ä»¶è¯»å…¥æ“ä½œç³»ç»Ÿ æ“ä½œç³»ç»Ÿè¯»åˆ°ç”¨æˆ·è¿›ç¨‹ ç”¨æˆ·è¿›ç¨‹å†™åˆ°æ“ä½œç³»ç»Ÿ æ“ä½œç³»ç»Ÿå†™å…¥ç£ç›˜æ–‡ä»¶ é›¶æ‹·è´å°±æ˜¯æŒ‡ï¼Œä¼ è¾“ä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œä¸éœ€è¦æŠŠæ–‡ä»¶è¯»åˆ°ç”¨æˆ·è¿›ç¨‹å†å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥æŠŠæ–‡ä»¶è¯»åˆ°æ“ä½œç³»ç»Ÿä¸€ä¸ªå†…å­˜åŒºï¼Œç„¶åå†ç§»åŠ¨åˆ°æ“ä½œç³»ç»Ÿçš„å¦ä¸€ä¸ªå†…å­˜åŒºï¼Œæœ€åå†™å…¥æ–‡ä»¶ã€‚ è¿™æ ·ä¸€æ¥ï¼Œæ­¥éª¤å˜æˆè¿™æ ·ï¼š ç£ç›˜æ–‡ä»¶è¯»å…¥æ“ä½œç³»ç»Ÿ æ“ä½œç³»ç»ŸæŠŠæ•°æ®å†™å…¥æ“ä½œç³»ç»Ÿå¦ä¸€ä¸ªåŒºåŸŸ æ“ä½œç³»ç»Ÿå†™å…¥ç£ç›˜æ–‡ä»¶ è™½ç„¶åªå°‘äº†ä¸€æ­¥ï¼Œä½†æ˜¯è¿™é‡Œä¸ä»…å‡å°‘äº†æ•°æ®ç§»åŠ¨çš„æ—¶é—´æŸè€—ï¼Œè€Œä¸”å‡å°‘äº†ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ï¼Œå› æ­¤å¤§å¤§ç¼©çŸ­äº†æ—¶é—´ã€‚ æ•°æ®æ‹·è´ æ•°æ®æ‹·è´çš„æ¨¡å¼ï¼Œæ¯ä¸€æ¬¡æ‹·è´æˆ‘éƒ½æ‰“ä¸Šäº†åºå· DMAæ§åˆ¶å™¨å°†æ•°æ®ä»ç£ç›˜æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œè¿™æ˜¯ç¬¬1æ¬¡æ‹·è´ï¼ˆDMAæ‹·è´ï¼‰ CPUå°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°åº”ç”¨ç¨‹åºç¼“å†²åŒºï¼Œè¿™æ˜¯ç¬¬2æ¬¡æ‹·è´ï¼ˆCPUæ‹·è´ï¼‰ï¼ˆå†…æ ¸æ€=\u003eç”¨æˆ·æ€ï¼‰ CPUå°†æ•°æ®ä»åº”ç”¨ç¨‹åºç¼“å†²åŒºå¤åˆ¶åˆ°Socketç¼“å†²åŒºï¼Œè¿™æ˜¯ç¬¬3æ¬¡æ‹·è´ï¼ˆCPUæ‹·è´ï¼‰ DMAæ§åˆ¶å™¨å°†æ•°æ®ä»Socketç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ï¼Œè¿™æ˜¯ç¬¬4æ¬¡æ‹·è´ï¼ˆDMAæ‹·è´ï¼‰ï¼ˆç”¨æˆ·æ€=\u003eå†…æ ¸æ€ï¼‰ ç”±ä¸Šè¿°ä¿¡æ¯å¯å¾—ï¼šä¸€å…±ç»å†äº†å››æ¬¡æ‹·è´ï¼Œå…¶ä¸­ä¸¤æ¬¡æ˜¯CPUæ‹·è´ï¼Œä¸¤æ¬¡æ˜¯DMAæ‹·è´;ç»å†äº†ä¸¤æ¬¡çš„çŠ¶æ€åˆ‡æ¢ï¼ˆæˆ‘å°±æ‹·è´ä¸ªæ•°æ®æ€ä¹ˆè¿™ä¹ˆéº»çƒ¦ï¼‰ MMAP mmapä¸»è¦æ˜¯ å†…å­˜æ˜ å°„ è¿™é¡¹æŠ€æœ¯çš„å‡ºç°ï¼Œä¸‹é¢è¿™æ®µå…³äºå†…å­˜æ˜ å°„çš„ä»‹ç»æ‘˜è‡ªç½‘ç»œ å†…å­˜æ˜ å°„æ–‡ä»¶æŠ€æœ¯æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§æ–°çš„æ–‡ä»¶æ•°æ®å­˜å–æœºåˆ¶ï¼Œåˆ©ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶æŠ€æœ¯ï¼Œç³»ç»Ÿå¯ä»¥åœ¨å†…å­˜ç©ºé—´ä¸­ä¸ºæ–‡ä»¶ä¿ç•™ä¸€éƒ¨åˆ†ç©ºé—´ï¼Œå¹¶å°†æ–‡ä»¶æ˜ å°„åˆ°è¿™å—ä¿ç•™ç©ºé—´ï¼Œä¸€æ—¦æ–‡ä»¶è¢«æ˜ å°„åï¼Œæ“ä½œç³»ç»Ÿå°†ç®¡ç†é¡µæ˜ å°„ç¼“å†²ä»¥åŠé«˜é€Ÿç¼“å†²ç­‰ä»»åŠ¡ï¼Œè€Œä¸éœ€è¦è°ƒç”¨åˆ†é…ã€é‡Šæ”¾å†…å­˜å—å’Œæ–‡ä»¶è¾“å…¥/è¾“å‡ºçš„APIå‡½æ•°ï¼Œä¹Ÿä¸éœ€è¦è‡ªå·±æä¾›ä»»ä½•ç¼“å†²ç®—æ³•ã€‚ ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶å¤„ç†å­˜å‚¨äºç£ç›˜ä¸Šçš„æ–‡ä»¶æ—¶ï¼Œå°†ä¸å¿…å†å¯¹æ–‡ä»¶æ‰§è¡ŒI/O æ“ä½œï¼Œè¿™æ„å‘³ç€åœ¨å¯¹æ–‡ä»¶è¿›è¡Œå¤„ç†æ—¶å°†ä¸å¿…å†ä¸ºæ–‡ä»¶ç”³è¯·å¹¶åˆ†é…ç¼“å­˜ï¼Œæ‰€æœ‰çš„æ–‡ä»¶ç¼“å­˜æ“ä½œå‡ç”±ç³»ç»Ÿç›´æ¥ç®¡ç†ï¼Œç”±äºå–æ¶ˆäº†å°†æ–‡ä»¶æ•°æ®åŠ è½½åˆ°å†…å­˜ã€æ•°æ®ä»å†…å­˜åˆ°æ–‡ä»¶çš„å›å†™ä»¥åŠé‡Šæ”¾å†…å­˜å—ç­‰æ­¥éª¤ï¼Œä½¿å¾—å†…å­˜æ˜ å°„æ–‡ä»¶åœ¨å¤„ç†å¤§æ•°æ®é‡çš„æ–‡ä»¶æ—¶èƒ½èµ·åˆ°ç›¸å½“é‡è¦çš„ä½œç”¨ã€‚ é€šè¿‡mmapè¿™é¡¹æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°äº†é¿å…å°†æ•°æ®æ‹·è´å‡ºå†…æ ¸ç©ºé—´äº†ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨ä¸€æ¬¡CPUæ‹·è´ï¼ŒCPUæ˜¯éå¸¸çè´µçš„èµ„æºï¼Œå¹¶ä¸”è¿™ä¸ªmmapçš„æ¨¡å¼é™¤äº†CPUè¿™æ¬¡æ‹·è´ä¹‹å¤–ï¼ˆå…¶å®åœ¨mmapå‡ºç°çš„æ—¶å€™è¿˜æ˜¯å¾ˆæ£’çš„ï¼Œä¸è¿‡æˆ‘ä»¬ç°åœ¨æœ‰äº†æ–°çš„è®¤çŸ¥äº†ï¼‰ï¼Œè¿˜å­˜åœ¨ç€å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¯èƒ½å‡ºç°ç¢ç‰‡é—®é¢˜è·Ÿå¤šè¿›ç¨‹ä¸‹åŒæ—¶æ“ä½œæ–‡ä»¶æ—¶å¯èƒ½äº§ç”Ÿå¼•å‘coredumpçš„signalã€‚ ç¢ç‰‡é—®é¢˜ä¸»è¦æ˜¯ä½“ç°åœ¨ï¼Œæ‹·è´çš„æ—¶å€™ï¼Œå¯èƒ½æ˜¯å°æ–‡ä»¶ï¼Œå¦‚æœæ˜¯å¤§æ–‡ä»¶å°±ä¼šå¤§å¤§é™ä½è¿™ç§ç¢ç‰‡é—®é¢˜çš„å‡ºç°ã€‚ï¼ˆç¢ç‰‡é—®é¢˜ä¸»è¦æ˜¯æˆ‘ä»¬æŸ¥å†…å­˜è¿˜æœ‰å¾ˆå¤šï¼Œä½†æ˜¯ç”³è¯·å¤§å†…å­˜ä¼šæœ‰ç”³è¯·å¤±è´¥çš„æƒ…å†µå‡ºç°ï¼ŒåŸç†å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ï¼Œä¸»è¦æ˜¯é¡ºåºåˆ†é…å†…å­˜ä¸æ•´å—åˆ†é…å†…å­˜ç›¸å…³çš„ï¼‰ å½“å¯¹æ–‡ä»¶è¿›è¡Œäº†å†…å­˜æ˜ å°„ï¼Œç„¶åè°ƒç”¨ write() ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœæ­¤æ—¶å…¶ä»–çš„è¿›ç¨‹æˆªæ–­äº†è¿™ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆ write() ç³»ç»Ÿè°ƒç”¨å°†ä¼šè¢«æ€»çº¿é”™è¯¯ä¿¡å· SIGBUS ä¸­æ–­ï¼Œå› ä¸ºæ­¤æ—¶æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªé”™è¯¯çš„å­˜å‚¨è®¿é—®ã€‚è¯¥ä¿¡å·çš„é»˜è®¤è¡Œä¸ºæ˜¯æ€æ­»è¿›ç¨‹å’Œè½¬å‚¨æ ¸å¿ƒã€‚ï¼ˆæºäºæ“ä½œç³»ç»Ÿå¯¹äºè¿›ç¨‹çš„å†…å­˜ä¿æŠ¤æœºåˆ¶ï¼‰ ","date":"2022-04-11","objectID":"/%E9%9B%B6%E6%8B%B7%E8%B4%9D/:0:0","tags":["é¢è¯•"],"title":"é›¶æ‹·è´","uri":"/%E9%9B%B6%E6%8B%B7%E8%B4%9D/"},{"categories":["é¢è¯•"],"content":"ã€Œå½“ç„¶ä¸Šé¢æ‰€è¯´å­˜åœ¨çš„ä¸¤ä¸ªé—®é¢˜æ˜¯å¯ä»¥é€šè¿‡å…¶ä»–æ–¹æ³•è§£å†³çš„ã€ ","date":"2022-04-11","objectID":"/%E9%9B%B6%E6%8B%B7%E8%B4%9D/:1:0","tags":["é¢è¯•"],"title":"é›¶æ‹·è´","uri":"/%E9%9B%B6%E6%8B%B7%E8%B4%9D/"},{"categories":["é¢è¯•"],"content":"â‘ ã€Œå¯¹SIGBUSæ•æ‰å¤„ç†ã€ å¯¹SIGBUS ä¿¡å·è¿›è¡Œç®€å•å¤„ç†å¹¶è¿”å›ï¼Œè¿™æ ·ï¼Œwrite() ç³»ç»Ÿè°ƒç”¨åœ¨å®ƒè¢«ä¸­æ–­ä¹‹å‰å°±è¿”å›å·²ç»å†™å…¥çš„å­—èŠ‚æ•°ç›®ï¼Œerrno ä¼šè¢«è®¾ç½®æˆ successã€‚ï¼ˆè¯´ç™½äº†å°±æ˜¯è®©ç¨‹åºä¸ä¼šå‡ºç°coredumpï¼‰ã€Œç¼ºç‚¹ã€ï¼šå®ƒä¸èƒ½åæ˜ å‡ºäº§ç”Ÿè¿™ä¸ªé—®é¢˜çš„æ ¹æºæ‰€åœ¨ï¼Œå› ä¸º BIGBUS ä¿¡å·åªæ˜¯æ˜¾ç¤ºæŸè¿›ç¨‹å‘ç”Ÿäº†ä¸€äº›å¾ˆä¸¥é‡çš„é”™è¯¯ã€‚ ","date":"2022-04-11","objectID":"/%E9%9B%B6%E6%8B%B7%E8%B4%9D/:1:1","tags":["é¢è¯•"],"title":"é›¶æ‹·è´","uri":"/%E9%9B%B6%E6%8B%B7%E8%B4%9D/"},{"categories":["é¢è¯•"],"content":"â‘¡ã€Œæ–‡ä»¶ç§Ÿå€Ÿé”ã€ å½“è¿›ç¨‹å°è¯•æ‰“å¼€ä¸€ä¸ªè¢«ç§Ÿå€Ÿé”ä¿æŠ¤çš„æ–‡ä»¶æ—¶ï¼Œè¯¥è¿›ç¨‹ä¼šè¢«é˜»å¡ï¼ŒåŒæ—¶ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…æ‹¥æœ‰è¯¥æ–‡ä»¶ç§Ÿå€Ÿé”çš„è¿›ç¨‹ä¼šæ”¶åˆ°ä¸€ä¸ªä¿¡å·ã€‚æ”¶åˆ°ä¿¡å·ä¹‹åï¼Œæ‹¥æœ‰è¯¥æ–‡ä»¶ç§Ÿå€Ÿé”çš„è¿›ç¨‹ä¼šé¦–å…ˆæ›´æ–°æ–‡ä»¶ï¼Œä»è€Œä¿è¯äº†æ–‡ä»¶å†…å®¹çš„ä¸€è‡´æ€§ï¼Œæ¥ç€ï¼Œè¯¥è¿›ç¨‹é‡Šæ”¾è¿™ä¸ªç§Ÿå€Ÿé”ã€‚å¦‚æœæ‹¥æœ‰ç§Ÿå€Ÿé”çš„è¿›ç¨‹åœ¨ä¸€å®šçš„æ—¶é—´é—´éš”å†…æ²¡æœ‰å®Œæˆå·¥ä½œï¼Œå†…æ ¸å°±ä¼šè‡ªåŠ¨åˆ é™¤è¿™ä¸ªç§Ÿå€Ÿé”æˆ–è€…å°†è¯¥é”è¿›è¡Œé™çº§ï¼Œä»è€Œå…è®¸è¢«é˜»å¡çš„è¿›ç¨‹ç»§ç»­å·¥ä½œã€‚ã€Œæ³¨æ„ã€ï¼šæ–‡ä»¶ç§Ÿå€Ÿé”éœ€è¦åœ¨å¯¹æ–‡ä»¶è¿›è¡Œå†…å­˜æ˜ å°„ä¹‹å‰è®¾ç½®ã€‚ sendfile å‰é¢å‡ æ¬¡åˆ°Socketå½“ä¸­æˆ‘ä»¬éƒ½æ˜¯æŠŠå®Œæ•´çš„æ•°æ®æ‹·è´å¸¦Socketç¼“å†²åŒºå½“ä¸­ï¼Œä½†æ˜¯ç»è¿‡æ€è€ƒï¼Œåæ­£æ•°æ®æ˜¯æœ€ç»ˆæ‹·è´åˆ°ç½‘å¡å½“ä¸­ï¼Œä¹Ÿå°±æ˜¯Socketç¼“å†²åŒºåˆæ˜¯ä¸€ä¸ªä¸­é—´è€…è€Œå·²ï¼Œæˆ‘ä»¬ä½•ä¸æƒ³ä¸ªæ–¹æ³•ï¼Œèƒ½æŠŠæ•°æ®ç›´æ¥æ‹·è´åˆ°ç½‘å¡ï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬çš„sendfileäº†ï¼Œæˆ‘ä»¬æ‹·è´å»socketç¼“å†²åŒºåªæ‹·è´äº†æ–‡ä»¶æè¿°ç¬¦è·Ÿæ•°æ®é•¿åº¦ï¼Œç„¶åç›´æ¥é‡‡ç”¨DMAæ”¶é›†æ‹·è´å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®åˆ°ç½‘å¡å½“ä¸­ã€‚ ","date":"2022-04-11","objectID":"/%E9%9B%B6%E6%8B%B7%E8%B4%9D/:1:2","tags":["é¢è¯•"],"title":"é›¶æ‹·è´","uri":"/%E9%9B%B6%E6%8B%B7%E8%B4%9D/"},{"categories":null,"content":"etcdçš„ä½¿ç”¨å®ä¾‹ etcdæœ‰ä¸¤ä¸ªç‰ˆæœ¬çš„æ¥å£ï¼Œv2å’Œv3ï¼Œä¸”ä¸¤ä¸ªç‰ˆæœ¬ä¸å…¼å®¹ï¼Œv2å·²ç»åœæ­¢äº†æ”¯æŒï¼Œv3æ€§èƒ½æ›´å¥½ã€‚ æ³¨æ„ ï¼šetcdctlé»˜è®¤ä½¿ç”¨v2ç‰ˆæœ¬ï¼Œå¦‚æœæƒ³ä½¿ç”¨v3ç‰ˆæœ¬ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡ETCDCTL_API=3è¿›è¡Œè®¾ç½® etcd æœ‰å¦‚ä¸‹çš„ä½¿ç”¨åœºæ™¯ï¼š æœåŠ¡å‘ç°ï¼ˆService Discoveryï¼‰ æ¶ˆæ¯å‘å¸ƒä¸è®¢é˜… è´Ÿè½½å‡è¡¡ åˆ†å¸ƒå¼é€šçŸ¥ä¸åè°ƒ åˆ†å¸ƒå¼é” åˆ†å¸ƒå¼é˜Ÿåˆ— é›†ç¾¤ç›‘æ§äºLeaderç«é€‰ã€‚ ä¸€ã€æœåŠ¡å‘ç° etcd çš„å¸¸è§ä½¿ç”¨åœºæ™¯ä¹‹ä¸€å°±æ˜¯æœåŠ¡å‘ç°ã€‚å®ç°æ€è·¯å¦‚ä¸‹ï¼šå…ˆå‡†å¤‡ etcd æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯çš„ç¨‹åºåœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨ä¹‹åä¼šè¿æ¥åˆ° etcd æœåŠ¡å™¨å¹¶è®¾ç½®ä¸€ä¸ªæ ¼å¼ä¸º ip:port çš„é”®å€¼å¯¹ï¼Œå¹¶ç»‘å®šä¸€ä¸ª leaseã€‚ä¹‹åçš„æœåŠ¡ç«¯å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±æ›´æ–°æœåŠ¡ç«¯æ³¨å†Œä¸­å¿ƒçš„ lease çš„ TTLã€‚å¦å¤–ä¸€ä¸ªç»„ä»¶å°±æ˜¯æœåŠ¡å‘ç°ç»„ä»¶ï¼Œdiscovery ä¼š watch æœåŠ¡ç«¯çš„ keyã€‚æ¯æ¬¡è¯¥ key å˜åŒ–æ—¶ï¼Œdiscovery å°±å¯ä»¥æ£€æµ‹åˆ°æ—¶é—´å¹¶åšå‡ºå¯¹åº”çš„æ“ä½œã€‚ä»£ç çš„å®ç°å¦‚ä¸‹ï¼š // server.go package main import ( \"context\" \"crypto/md5\" \"encoding/json\" \"errors\" \"flag\" \"fmt\" \"github.com/coreos/etcd/clientv3\" \"github.com/coreos/etcd/etcdserver/api/v3rpc/rpctypes\" \"log\" \"net\" \"os\" \"os/signal\" \"strings\" \"syscall\" \"time\" ) var ( prefix = \"register\" client *clientv3.Client stopSignal = make(chan struct{}, 1) srvKey string ) var ( serv = flag.String(\"name\", \"hello\", \"service name\") port = flag.Int(\"port\", 30000, \"service port\") endpoint = flag.String(\"endpoints\", \"http://127.0.0.1:2379\", \"etcd endpoints\") ) type SvConfig struct { Name string `json:\"name\"` Host string `json:\"host\"` Port int `json:\"port\"` } func Register(endpoints string, config *SvConfig, interval time.Duration, ttl int) error { // è§£ææœåŠ¡ç«¯çš„å€¼ srvValue, _ := json.Marshal(config) srvKey = fmt.Sprintf(\"%s/%x\", prefix, md5.Sum(srvValue)) var err error client, err = clientv3.New(clientv3.Config{ Endpoints: strings.Split(endpoints, \",\"), DialTimeout: time.Second * 2, }) if err != nil { return fmt.Errorf(\"register service failed: %v\", err) } go func() { timer := time.NewTicker(interval) for { resp, _ := client.Grant(context.TODO(), int64(ttl)) _, err = client.Get(context.TODO(), srvKey) if err != nil { // æ•è· key ä¸å­˜åœ¨çš„åœºåˆ if errors.Is(err, rpctypes.ErrKeyNotFound) { _, err = client.Put(context.TODO(), srvKey, string(srvValue), clientv3.WithLease(resp.ID)) if err != nil { log.Printf(\"register service %s at %s:%d\\n\", config.Name, config.Host, config.Port) } } } else { // å¦‚æœkeyå­˜åœ¨å°±æ›´æ–°ttl _, err = client.Put(context.TODO(), srvKey, string(srvValue), clientv3.WithLease(resp.ID)) } select { case \u003c-stopSignal: return case \u003c-timer.C: } } }() return err } func Unregister() error { stopSignal \u003c- struct{}{} stopSignal = make(chan struct{}, 1) _, err := client.Delete(context.TODO(), srvKey) return err } func main() { flag.Parse() // ç»‘å®šæœåŠ¡åœ°å€å’Œç«¯å£ lis, err := net.Listen(\"tcp\", fmt.Sprintf(\"127.0.0.1:%d\", *port)) if err != nil { panic(err) } config := \u0026SvConfig{ Name: *serv, Host: \"127.0.0.1\", Port: *port, } Register(*endpoint, config, time.Second*10, 15) ch := make(chan os.Signal, 1) signal.Notify(ch, syscall.SIGTERM, syscall.SIGINT, syscall.SIGKILL, syscall.SIGHUP, syscall.SIGQUIT) go func() { \u003c-ch Unregister() os.Exit(1) }() log.Printf(\"service %s start at %d\", *serv, *port) // server todo for { lis.Accept() } } // discovery.go package main import ( \"context\" \"encoding/json\" \"flag\" \"fmt\" \"github.com/coreos/etcd/clientv3\" \"log\" \"net\" \"os\" \"os/signal\" \"strings\" \"syscall\" \"time\" ) var ( prefix = \"register\" client *clientv3.Client ) var ( port = flag.Int(\"port\", 30001, \"service port\") endpoint = flag.String(\"endpoints\", \"http://127.0.0.1:2379\", \"etcd endpoints\") ) type SvConfig struct { Name string `json:\"name\"` Host string `json:\"host\"` Port int `json:\"port\"` } func watcher() error { var err error client, err = clientv3.New(clientv3.Config{ Endpoints: strings.Split(*endpoint, \",\"), DialTimeout: time.Second * 3, }) if err != nil { return fmt.Errorf(\"connect etcd cluster failed: %v\", err.Error()) } go func() { resp := client.Watch(context.TODO(), prefix, clientv3.WithPrefix()) for ch := range resp { for _, event := range ch.Events { switch event.Type { case clientv3.EventTypePut: if event.IsCreate() { srv := parseSrv(event.Kv.Value) log.Printf(\"discovery service %s at %s:%d\", srv.Name, srv.Host, srv.Port) } case clientv3.EventTypeDelete: log.Printf(\"delete service %s\", event.Kv.Key) } } } }() return err } func parseSrv(text []byte) *SvConfig { svc := \u0026SvConfig{} json.Unmarshal(text, \u0026svc) return svc } func main() { flag.Parse() // ç»‘å®šæœåŠ¡åœ°å€å’Œç«¯å£ li","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:0:0","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"æŸ¥è¯¢æ•°æ® ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:1:0","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"æŒ‰keyå€¼æŸ¥è¯¢ etcdctl get name1 name1 james ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:1:1","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"ä¸æ˜¾ç¤ºkeyåªé™åˆ¶values etcdctl get --print-value-only name1 james ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:1:2","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"æŒ‰keyå‰ç¼€æŸ¥æ‰¾ etcdctl get --prefix name name1 james name11 alice name12 seli name2 jetty name3 tom name4 cris ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:1:3","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"æŒ‰keyçš„å­—èŠ‚æ’åºçš„å‰ç¼€æŸ¥æ‰¾ \u003e= etcdctl get --from-key name2 name2 jetty name3 tom name4 cris ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:1:4","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"æŒ‰keyçš„å­—èŠ‚æ’åºåŒºé—´æŸ¥æ‰¾ \u003c= value \u003c etcdctl get name1 name3 name1 james name11 alice name12 seli name2 jetty ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:1:5","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"æŸ¥æ‰¾æ‰€æœ‰key etcdctl get --from-key \"\" avg_age 25 name1 james name11 alice name12 seli name2 jetty name3 tom name4 cris ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:1:6","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"åˆ é™¤æ•°æ® ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:2:0","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"åˆ é™¤key name11 etcdctl del name11 ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:2:1","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"åˆ é™¤key name12æ—¶å¹¶è¿”å›è¢«åˆ é™¤çš„é”®å€¼å¯¹ etcdctl del --prev-kv name12 1 name12 seli ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:2:2","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"åˆ é™¤æŒ‡å®šå­—èŠ‚æ’åºèµ·å§‹å€¼åçš„key etcdctl del --prev-kv --from-key name3 2 name3 tom name4 cris ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:2:3","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"åˆ é™¤æŒ‡å®šå‰ç¼€çš„key etcdctl del --prev-kv --prefix name 2 name1 james name2 jetty ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:2:4","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"åˆ é™¤æ‰€æœ‰æ•°æ® etcdctl del --prefix \"\" 9 ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:2:5","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"æ›´æ–°æ•°æ® ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:3:0","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"ç›´æ¥ç”¨putå³å¯ etcdctl put avg_age 30 etcdctl get --prefix \"\" avg_age 30 ","date":"2022-04-11","objectID":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/:3:1","tags":null,"title":"etcdçš„ä½¿ç”¨å®ä¾‹","uri":"/etcd%E7%9A%84%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B/"},{"categories":null,"content":"MangoDBçš„åŸºç¡€ MongoDBæ˜¯ä¸€ä¸ªåŸºäºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨çš„æ•°æ®åº“ã€‚é»˜è®¤ç«¯å£ä¸º27017 ","date":"2022-04-08","objectID":"/mangodb%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/:0:0","tags":null,"title":"Mangodbçš„åŸºç¡€ä½¿ç”¨","uri":"/mangodb%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/"},{"categories":["å¾®ä¿¡æ”¯ä»˜"],"content":"å¾®ä¿¡æ”¯ä»˜V3 æ•´ç†æ•´ä½“æµç¨‹ ","date":"2022-04-08","objectID":"/payment/:0:0","tags":["HS"],"title":"å¾®ä¿¡æ”¯ä»˜çš„æ¥å£","uri":"/payment/"},{"categories":null,"content":"æ—¥å¿— // æ—¥å¿—è®°å½•åˆ°æ–‡ä»¶ func (d *Handler) LoggerToFile() gin.HandlerFunc { return func(c *gin.Context) { // å¼€å§‹æ—¶é—´ startTime := time.Now() // å¤„ç†è¯·æ±‚ c.Next() // ç»“æŸæ—¶é—´ endTime := time.Now() // æ‰§è¡Œæ—¶é—´ latencyTime := endTime.Sub(startTime) // è¯·æ±‚æ–¹å¼ reqMethod := c.Request.Method // è¯·æ±‚è·¯ç”± reqUri := c.Request.RequestURI // çŠ¶æ€ç  statusCode := c.Writer.Status() // è¯·æ±‚IP clientIP := c.ClientIP() //// æ—¥å¿—æ ¼å¼ //fmt.Printf(\"%s [INFO] %s %s %3d %13v %15s \\r\\n\", // startTime.Format(\"2006-01-02 15:04:05\"), // reqMethod, // reqUri, // statusCode, // latencyTime, // clientIP, //) log.Infof(\"%s %s %3d %13v %15s\", reqMethod, reqUri, statusCode, latencyTime, clientIP) if c.Request.Method != \"GET\" \u0026\u0026 c.Request.Method != \"OPTIONS\" \u0026\u0026 conf.Conf.LoggerConfig.EnabledDB { d.SetDBOperLog(c, clientIP, statusCode, reqUri, reqMethod, latencyTime) } } } è‡ªå®šä¹‰å¼‚å¸¸å¤„ç† func (d *Handler) CustomError(c *gin.Context) { defer func() { if err := recover(); err != nil { if c.IsAborted() { c.Status(200) } switch errStr := err.(type) { case string: p := strings.Split(errStr, \"#\") if len(p) == 3 \u0026\u0026 p[0] == \"CustomError\" { statusCode, e := strconv.Atoi(p[1]) if e != nil { break } c.Status(statusCode) fmt.Println( time.Now().Format(\"2006-01-02 15:04:05\"), \"[ERROR]\", c.Request.Method, c.Request.URL, statusCode, c.Request.RequestURI, c.ClientIP(), p[2], ) c.JSON(http.StatusOK, gin.H{ \"code\": statusCode, \"msg\": p[2], }) } default: panic(err) } } }() c.Next() } è¯·æ±‚id func (d *Handler) RequestId() gin.HandlerFunc { return func(c *gin.Context) { // Check for incoming header, use it if exists requestId := c.Request.Header.Get(\"X-Request-Id\") // Create request id with UUID4 if requestId == \"\" { u4 := uuid.NewV4() requestId = u4.String() } // Expose it for use in the application c.Set(\"X-Request-Id\", requestId) // Set X-Request-Id header c.Writer.Header().Set(\"X-Request-Id\", requestId) c.Next() } } nocache // NoCache is a middleware function that appends headers // to prevent the client from caching the HTTP response. func (d *Handler) NoCache(c *gin.Context) { c.Header(\"Cache-Control\", \"no-cache, no-store, max-age=0, must-revalidate, value\") c.Header(\"Expires\", \"Thu, 01 Jan 1970 00:00:00 GMT\") c.Header(\"Last-Modified\", time.Now().UTC().Format(http.TimeFormat)) c.Next() } è·¨åŸŸ //Options is a middleware function that appends headers // for options requests and aborts then exits the middleware // chain and ends the request. func (d *Handler) Options(c *gin.Context) { if c.Request.Method != \"OPTIONS\" { c.Next() } else { c.Header(\"Access-Control-Allow-Origin\", \"*\") c.Header(\"Access-Control-Allow-Methods\", \"GET,POST,PUT,PATCH,DELETE,OPTIONS\") c.Header(\"Access-Control-Allow-Headers\", \"lang,X-DEVICE-ID,X-APP-VERSION,X-CHANNEL,authorization, origin, content-type, accept,X-TENANT-CODE,sign,time\") c.Header(\"Allow\", \"HEAD,GET,POST,PUT,PATCH,DELETE,OPTIONS\") c.Header(\"Content-Type\", \"application/json\") c.AbortWithStatus(200) } } Secure // Secure is a middleware function that appends security // and resource access headers. func (d *Handler) Secure(c *gin.Context) { c.Header(\"Access-Control-Allow-Origin\", \"*\") //c.Header(\"X-Frame-Options\", \"DENY\") c.Header(\"X-Content-Type-Options\", \"nosniff\") c.Header(\"X-XSS-Protection\", \"1; mode=block\") if c.Request.TLS != nil { c.Header(\"Strict-Transport-Security\", \"max-age=31536000\") } // Also consider adding Content-Security-Policy headers // c.Header(\"Content-Security-Policy\", \"script-src 'self' https://cdnjs.cloudflare.com\") } é™æµ func (d *Handler) Limiter(ctx *gin.Context) { now := time.Now().UnixNano() key := \"REDIS_LIMITER\" userCntKey := fmt.Sprint(constant.ImApiRedisPrefix, ctx.ClientIP(), \":\", key) //äº”ç§’é™æµ var limit int64 = 10 dura := time.Second * 60 //åˆ é™¤æœ‰åºé›†åˆä¸­çš„äº”ç§’ä¹‹å‰çš„æ•°æ® d.Dao.Redis.ZRemRangeByScore(ctx, userCntKey, \"0\", fmt.Sprint(now-(dura.Nanoseconds()))).Result() reqs, _ := d.Dao.Redis.ZCard(ctx, userCntKey).Result() if reqs \u003e= limit { ctx.AbortWithStatusJSON(http.StatusTooManyRequests, gin.H{ \"status\": http.StatusTooManyRequests, \"message\": \"too many request\", }) return } ctx.N","date":"2022-02-08","objectID":"/gin/:0:0","tags":null,"title":"gin å¸¸ç”¨ä¸­é—´ä»¶","uri":"/gin/"},{"categories":null,"content":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å· Aixä¸º6.1ç‰ˆæœ¬ ä½¿ç”¨iscsiå­˜å‚¨ é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªiscsi targetï¼Œå¹¶å…±äº«åˆ°IBM Aixä¸Šã€‚ ","date":"2021-12-03","objectID":"/aix1/:0:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"æ£€æŸ¥iscsiæ˜¯å¦è¢«å®‰è£… $ lslpp -L | grep -i iscsi devices.common.IBM.iscsi.rte 6.1.5.0 C F Common iSCSI Files devices.iscsi.disk.rte 6.1.5.0 C F iSCSI Disk Software ... ","date":"2021-12-03","objectID":"/aix1/:1:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"é…ç½®iscsi $ vi /etc/iscsi/targets ... # æ·»åŠ target 172.16.1.169 3260 iqn.2018-11.com.howlink.wbrt.portal.backup ","date":"2021-12-03","objectID":"/aix1/:2:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"é‡æ–°æ‰«ç›˜ $ cfgmgr -l iscsi0 cfgmgr: 0514-621 WARNING: The following device packages are required for device support but are not currently installed. devices.iscsi.array ","date":"2021-12-03","objectID":"/aix1/:3:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"æŸ¥çœ‹iscsiç›˜ $ lsdev -Cc disk | grep iSCSI hdisk18 Available Other iSCSI Disk Drive ","date":"2021-12-03","objectID":"/aix1/:4:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"åˆ›å»ºç‰©ç†å· $ chdev -l hdisk18 -a pv=yes ","date":"2021-12-03","objectID":"/aix1/:5:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"åˆ›å»ºvg $ mkvg -y wbrt_portal_bg hdisk18 ","date":"2021-12-03","objectID":"/aix1/:6:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"åˆ›å»ºlv $ mklv -t jfs2 -y wbrt_portal_bl wbrt_portal_bg 700 æ³¨:lvçš„å¤§å°å¯ä»¥ä½¿ç”¨å‘½ä»¤ $ lsvg wbrt_portal_bg | grep \"TOTAL PPs\" | awk -F' ' '{ print $6}' 703 ä½†ä¸è¦å…¨éƒ¨ä½¿ç”¨ï¼Œéœ€è¦ä¸€äº›å‰©ä½™ç©ºé—´ã€‚ ","date":"2021-12-03","objectID":"/aix1/:7:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"åˆ›å»ºæŒ‚è½½ç›®å½• $ mkdir /mnt/iscsi ","date":"2021-12-03","objectID":"/aix1/:8:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"æ ¼å¼åŒ–å¹¶æŒ‚è½½ $ crfs -v jfs2 -m /mnt/iscsi -d wbrt_portal_bl $ mount /mnt/iscsi åˆ é™¤å­˜å‚¨ç›˜ ","date":"2021-12-03","objectID":"/aix1/:9:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"å¸è½½ç£ç›˜ $ umount /mnt/iscsi ","date":"2021-12-03","objectID":"/aix1/:10:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"lv $ rmlv wbrt_portal_bl ","date":"2021-12-03","objectID":"/aix1/:11:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"åˆ é™¤æ–‡ä»¶ç³»ç»Ÿ $ rmfs -r /dev/wbrt_portal_bl ","date":"2021-12-03","objectID":"/aix1/:12:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"åˆ é™¤vg $ reducevg -d wbrt_portal_bg hdisk18 ","date":"2021-12-03","objectID":"/aix1/:13:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"åˆ é™¤ç‰©ç†ç›˜ $ rmdev -dl hdisk18 -R ","date":"2021-12-03","objectID":"/aix1/:14:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"åˆ é™¤iscsi target $ vi /etc/iscsi/targets ... # æ·»åŠ target # 172.16.1.169 3260 iqn.2018-11.com.howlink.wbrt.portal.backup é‡è¯»ç£ç›˜ $ cfgmgr -l iscsi0 ","date":"2021-12-03","objectID":"/aix1/:15:0","tags":null,"title":"Aixæ·»åŠ å’Œåˆ é™¤Iscsiå­˜å‚¨å·","uri":"/aix1/"},{"categories":null,"content":"C++å‹å…ƒ å‹å…ƒè¯´æ˜ ç›¸å¯¹äºå…¶ä»–çš„ç¼–ç¨‹è¯­è¨€ï¼Œâ€œå‹å…ƒâ€æ˜¯C++ä¸­ç‰¹åˆ«çš„ä¸€ç§è¯­æ³•ã€‚é‚£å®ƒæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ å…¶å®â€œå‹å…ƒâ€å°±æ˜¯æä¾›ä¸€ç§è®¿é—®ç±»ç§æœ‰éƒ¨åˆ†çš„çš„æ–¹æ³•ã€‚å¦‚æœæ²¡æœ‰â€œå‹å…ƒâ€ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡ç±»æœ¬èº«æä¾›çš„å…¬æœ‰æ–¹æ³•æ¥è®¿é—®ï¼Œä½†ç›¸å¯¹åœ°ï¼Œè¿™æ ·é™åˆ¶å¤ªé«˜äº†ï¼Œæ‰€ä»¥â€œå‹å…ƒâ€å°±æ˜¯ä¸€ç§çš„åœ¨ç±»çš„å°è£…æ€§å’Œå®ç”¨æ€§ä¸­å¾ˆå¥½çš„â€œæŠ˜ä¸­â€æ–¹å¼ã€‚ C++ä¸­çš„å‹å…ƒæœ‰ä¸‰ç§ï¼š å‹å…ƒå‡½æ•° å‹å…ƒç±» å‹å…ƒæˆå‘˜å‡½æ•° C++ä¸­ä½¿ç”¨å…³é”®å­—friendæ¥å®šä¹‰ã€‚ å‹å…ƒå‡½æ•° è¿™é‡Œç›´æ¥ç”¨ä»£ç æ¥è¯´æ˜ï¼š #include \u003ciostream\u003e#include \u003cstring\u003e class Person { private: std::string account; std::string passwd; public: Person(std::string ac, std::string pw); // è¿™é‡Œä½¿ç”¨friendå…³é”®å­—ï¼ŒæŒ‡å®šPointä¸­çš„getPersonæ–¹æ³•å¯ä»¥ä½¿ç”¨Personç±»çš„ç§æœ‰å˜é‡ã€‚ friend void getPerson(Person \u0026p); }; Person::Person(std::string ac, std::string pw) { account = ac; passwd = pw; } void getPerson(Person \u0026p) { // å› ä¸ºå®šä¹‰äº†å‹å…ƒï¼Œè¿™é‡Œå°±å¯ä»¥è®¿é—®Personç±»çš„ç§æœ‰å˜é‡äº†ã€‚ std::cout \u003c\u003c \"account: \" \u003c\u003c p.account \u003c\u003c \", passwd: \" \u003c\u003c p.passwd \u003c\u003c std::endl; } int main() { Person p(\"xingyys\", \"123456\"); getPerson(p); return 0; } è¿™ä¸ªä¾‹å­è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåªè¦åœ¨æŒ‡å®šçš„æ–¹æ³•ä¸­æ·»åŠ å…³é”®å­—å°±å¯ä»¥å®ç°äº†ã€‚ å‹å…ƒç±» åœ¨æ¥ä¸€ä¸ªä¾‹å­è¯´æ˜ï¼š #include \u003ciostream\u003e#include \u003cstring\u003e class Tv { private: int state; int volume; int maxchannel; int channel; int mode; int input; public: // åœ¨è¿™é‡ŒæŒ‡å®šè°æ˜¯ä»–çš„å‹å…ƒ friend class Remote; enum { Off, On }; enum { MinVal, MaxVal = 20 }; enum { Antenna, Cable }; enum { TV, DVD }; Tv(int s = Off, int mc = 125) : state(s), volume(5), maxchannel(mc), channel(2), mode(Cable), input(TV) {} void onoff() { state = (state == On) ? Off : On; } bool ison() const { return state == On; } bool volup(); bool voldown(); void chanup(); void chandown(); void set_mode() { mode = (mode == Antenna) ? Cable : Antenna; } void set_input() { input = (input == TV) ? DVD : TV; } void settings() const; }; class Remote { private: int mode; public: Remote(int m = Tv::TV) : mode(m) {} bool volup(Tv \u0026t) { return t.volup(); } bool voldown(Tv \u0026t) { return t.voldown(); } void onoff(Tv \u0026t) { t.onoff(); } void chanup(Tv \u0026t) { t.chanup(); } void chandown(Tv \u0026t) { t.chandown(); } void set_chan(Tv \u0026t, int c) { t.channel = c; } void set_mode(Tv \u0026t) { t.set_mode(); } void set_input(Tv \u0026t) { t.set_input(); } }; bool Tv::volup() { if (volume \u003c MaxVal) { volume++; return true; } else { return false; } } bool Tv::voldown() { if (volume \u003e MinVal) { volume--; return true; } else { return false; } } void Tv::chanup() { if (channel \u003c maxchannel) channel++; else channel = 1; } void Tv::chandown() { if (channel \u003e 1) channel--; else channel = maxchannel; } void Tv::settings() const { using std::cout; using std::endl; cout \u003c\u003c \"TV is \" \u003c\u003c (state == Off ? \"Off\" : \"On\") \u003c\u003c endl; if (state == On) { cout \u003c\u003c \"Volume setting = \" \u003c\u003c volume \u003c\u003c endl; cout \u003c\u003c \"Channel setting = \" \u003c\u003c channel \u003c\u003c endl; cout \u003c\u003c \"Mode = \" \u003c\u003c (mode == Antenna ? \"antenna\" : \"cable\") \u003c\u003c endl; cout \u003c\u003c \"Input = \" \u003c\u003c (input == TV ? \"TV\" : \"DVD\") \u003c\u003c endl; } } int main() { using std::cout; Tv s42; cout \u003c\u003c \"Initial setting for 42\\\"TV:\\n\"; s42.settings(); s42.onoff(); s42.chanup(); cout \u003c\u003c \"\\nAdjusted setting for 42\\\"TV:\\n\"; s42.chanup(); cout \u003c\u003c \"\\nAdjusted settings for 42\\\"TV:\\n\"; s42.settings(); Remote grey; grey.set_chan(s42, 10); grey.volup(s42); grey.volup(s42); cout \u003c\u003c \"\\n42\\\"setting after using remote:\\n\"; s42.settings(); Tv s58(Tv::On); s58.set_mode(); grey.set_chan(s58, 28); cout \u003c\u003c \"\\n58\\\"settings:\\n\"; s58.settings(); return 0; } å‹å…ƒæˆå‘˜å‡½æ•° #include \u003ciostream\u003e#include \u003cstring\u003e class Person; class Point { public: void getPerson(Person \u0026p); }; class Person { private: std::string account; std::string passwd; public: Person(std::string ac, std::string pw); // è¿™é‡Œä½¿ç”¨friendå…³é”®å­—ï¼ŒæŒ‡å®šPointä¸­çš„getPersonæ–¹æ³•å¯ä»¥ä½¿ç”¨Personç±»çš„ç§æœ‰å˜é‡ã€‚ friend void Point::getPerson(Person \u0026p); }; Person::Person(std::string ac, std::string pw) { account = ac; passwd = pw; } void Point::getPerson(Person \u0026p) { // å› ä¸ºå®šä¹‰äº†å‹å…ƒï¼Œè¿™é‡Œå°±å¯ä»¥è®¿é—®Personç±»çš„ç§æœ‰å˜é‡äº†ã€‚ std::cout \u003c\u003c \"account: \" \u003c\u003c p.account \u003c\u003c \", passwd: \" \u003c\u003c p.passwd \u003c\u003c std::endl; } int main() { Person p (\"xingyys\", \"123456\"); Point pt; pt.getPerson(p); return 0; } è¡¥å…… ä¸èƒ½å®šä¹‰ç±»çš„å¯¹è±¡ã€‚ å¯ä»¥ç”¨äºå®šä¹‰æŒ‡å‘è¿™ä¸ªç±»å‹çš„æŒ‡é’ˆæˆ–å¼•ç”¨ã€‚ ç”¨äºå£°æ˜(ä¸æ˜¯å®šä¹‰)ï¼Œä½¿ç”¨è¯¥ç±»å‹ä½œä¸ºå½¢å‚ç±»å‹æˆ–è€…å‡½æ•°çš„è¿”å›å€¼ç±»å‹ã€‚ å‹å…ƒå…³ç³»ä¸èƒ½è¢«ç»§æ‰¿ã€‚ å‹å…ƒå…³ç³»æ˜¯å•å‘çš„ï¼Œä¸å…·æœ‰äº¤æ¢æ€§ã€‚è‹¥ç±»Bæ˜¯ç±»Açš„å‹å…ƒï¼Œç±»Aä¸ä¸€å®šæ˜¯ç±»Bçš„å‹å…ƒï¼Œè¦çœ‹åœ¨ç±»ä¸­æ˜¯å¦æœ‰ç›¸åº”çš„å£°æ˜ã€‚ å‹å…ƒå…³ç³»ä¸å…·æœ‰ä¼ é€’æ€§ã€‚è‹¥ç±»Bæ˜¯ç±»Açš„å‹å…ƒï¼Œç±»Cæ˜¯Bçš„å‹å…ƒï¼Œç±»Cä¸ä¸€å®šæ˜¯ç±»Açš„å‹å…ƒï¼ŒåŒæ ·è¦çœ‹ç±»ä¸­æ˜¯å¦æœ‰ç›¸åº”çš„ç”³æ˜ ","date":"2021-12-03","objectID":"/c-%E5%8F%8B%E5%85%83/:0:0","tags":null,"title":"C++å‹å…ƒ","uri":"/c-%E5%8F%8B%E5%85%83/"},{"categories":null,"content":"CentOS7 å®‰è£… qemu-5.2.0 æœ¬æ–‡ä»‹ç»åœ¨ CentOS7.9 ä¸Šç¼–è¯‘å®‰è£… qemu-5.2.0 å®‰è£… Python3 ç¼–è¯‘å®‰è£… qemu-5.2.0 ä¾èµ– Python3.6 åŠä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚æ‰€ä»¥é¦–å…ˆå®‰è£… Python3.6ã€‚è¿™é‡Œé€‰æ‹©ç¼–è¯‘å®‰è£…ã€‚ ","date":"2021-12-03","objectID":"/centos7_install_qemu/:0:0","tags":null,"title":"CentOS7 å®‰è£… qemu-5.2.0","uri":"/centos7_install_qemu/"},{"categories":null,"content":"ä¸‹è½½ Python3.6.12 ä» Python å®˜ç½‘ä¸‹è½½ Python3.6.12 æºç åŒ…ï¼š wget https://www.python.org/ftp/python/3.6.12/Python-3.6.12.tar.xz ","date":"2021-12-03","objectID":"/centos7_install_qemu/:1:0","tags":null,"title":"CentOS7 å®‰è£… qemu-5.2.0","uri":"/centos7_install_qemu/"},{"categories":null,"content":"è§£å‹ tar -xvf Python-3.6.12.tar.gz ","date":"2021-12-03","objectID":"/centos7_install_qemu/:2:0","tags":null,"title":"CentOS7 å®‰è£… qemu-5.2.0","uri":"/centos7_install_qemu/"},{"categories":null,"content":"å®‰è£… openssl pip ä¸‹è½½æ˜¯éœ€è¦ ssl æ”¯æŒï¼Œæ‰€ä»¥ä¸‹è½½ openssl yum install -y openssl openssl-devel zlib-devel bzip2-devel bzip2 ","date":"2021-12-03","objectID":"/centos7_install_qemu/:3:0","tags":null,"title":"CentOS7 å®‰è£… qemu-5.2.0","uri":"/centos7_install_qemu/"},{"categories":null,"content":"ç¼–è¯‘å®‰è£… cd Python-3.6.12 ./configure --prefix=/usr/local/python3 --enable-optimizations make -j8 build_all \u0026\u0026 make -j8 install ","date":"2021-12-03","objectID":"/centos7_install_qemu/:4:0","tags":null,"title":"CentOS7 å®‰è£… qemu-5.2.0","uri":"/centos7_install_qemu/"},{"categories":null,"content":"è®¾ç½®è½¯é“¾æ¥ ln -s /usr/local/python3/bin/python3 /usr/bin/python3 ln -s /usr/local/python3/bin/pip3 /usr/bin/pip3 ","date":"2021-12-03","objectID":"/centos7_install_qemu/:5:0","tags":null,"title":"CentOS7 å®‰è£… qemu-5.2.0","uri":"/centos7_install_qemu/"},{"categories":null,"content":"éªŒè¯ # python3 Python 3.6.12 (default, Dec 27 2020, 07:52:33) [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)] on linux Type \"help\", \"copyright\", \"credits\" or \"license\" for more information. \u003e\u003e\u003e å®‰è£… ninja qemu-5.2.0 ç¼–è¯‘æ—¶ä½¿ç”¨æ„å»ºå·¥å…· ninja ä¸‹è½½ ninja git clone git://github.com/ninja-build/ninja.git \u0026\u0026 cd ninja ./configure.py --bootstrap cp ninja /usr/bin/ ä½¿ç”¨ ninja --version, éªŒè¯ ninja ç‰ˆæœ¬: # ninja --version 1.10.2.git ç¼–è¯‘å®‰è£… qemu-5.2.0 å®Œæˆä»¥ä¸Šæ­¥éª¤ä¹‹åå°±å¯ä»¥å¼€å§‹å®‰è£…qemuäº†ã€‚å…¶å®å¯ä»¥é€šè¿‡ yum å®‰è£…ï¼Œä½†æ˜¯ä¼šç¼ºå°‘ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ ","date":"2021-12-03","objectID":"/centos7_install_qemu/:6:0","tags":null,"title":"CentOS7 å®‰è£… qemu-5.2.0","uri":"/centos7_install_qemu/"},{"categories":null,"content":"å®‰è£…ä¾èµ– é¦–å…ˆå®‰è£… qemu-5.2.0 æ‰€éœ€çš„ä¾èµ–ï¼Œè¿™é‡Œè¿½åŠ ä¸€ä¸ªå°æç¤ºï¼š CentOS7 ç¼–è¯‘å®‰è£…è½¯ä»¶æ—¶ç»å¸¸éœ€è¦å®‰è£…å¯¹åº”çš„ä¾èµ–ã€‚ç¼–è¯‘è¿‡ç¨‹ä¸­å¦‚æœå‘ç°ç¼ºå°‘ä¾èµ–ï¼Œåˆ™ç¼–è¯‘åæŠ¥é”™å¹¶é€€å‡ºï¼Œè¿™æ—¶å€™å°±éœ€è¦å®‰è£…ä¾èµ–åŒ…ã€‚ä»¥qemu-5.2.0å®‰è£…ä¸ºä¾‹ï¼Œç¼–è¯‘æ—¶æç¤ºç¼ºå°‘ glib2 åŒ…ã€‚è¿™æ—¶å€™ä¸æ˜¯ä¸‹è½½ glib2ï¼Œè€Œæ˜¯ä¸‹è½½å¯¹åº”çš„å¼€å‘åŒ…ï¼ŒCentOSé‡Œæ˜¯ glib2-develï¼ŒUbuntu ä¸‹åˆ™æ˜¯ glib2-devã€‚ yum install -y pkgconfig-devel glib2-devel pixman-devel è¿™é‡Œæä¾›çš„ä¾èµ–å¯èƒ½è¡¥å…¨ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸­å¦‚æœæç¤ºç¼ºå°‘ä¾èµ–ï¼Œè¯·æ ¹æ®ä»¥ä¸Šç»™å‡ºçš„æç¤ºå®‰è£…å¯¹åº”ä¾èµ–ã€‚ ","date":"2021-12-03","objectID":"/centos7_install_qemu/:7:0","tags":null,"title":"CentOS7 å®‰è£… qemu-5.2.0","uri":"/centos7_install_qemu/"},{"categories":null,"content":"ä¸‹è½½ qemu-5.2.0 åœ¨ qemu å®˜ç½‘ä¸‹è½½æºç åŒ… wget https://download.qemu.org/qemu-5.2.0.tar.xz ","date":"2021-12-03","objectID":"/centos7_install_qemu/:8:0","tags":null,"title":"CentOS7 å®‰è£… qemu-5.2.0","uri":"/centos7_install_qemu/"},{"categories":null,"content":"ç¼–è¯‘å®‰è£… tar xvJf qemu-5.2.0.tar.xz cd qemu-5.2.0 ./configure --enable-debug --target-list=x86_64-softmmu --enable-kvm make \u0026\u0026 make install ","date":"2021-12-03","objectID":"/centos7_install_qemu/:9:0","tags":null,"title":"CentOS7 å®‰è£… qemu-5.2.0","uri":"/centos7_install_qemu/"},{"categories":null,"content":"éªŒè¯ # qemu- qemu-edid qemu-img qemu-nbd qemu-storage-daemon qemu-ga qemu-io qemu-pr-helper qemu-system-x86_64 ","date":"2021-12-03","objectID":"/centos7_install_qemu/:10:0","tags":null,"title":"CentOS7 å®‰è£… qemu-5.2.0","uri":"/centos7_install_qemu/"},{"categories":null,"content":"CentOSä¸‹kvmå®‰è£… æ³¨ï¼šè¿è¡Œkvmä¿è¯æœºå™¨æ”¯æŒè™šæ‹ŸåŒ–ä¸”åœ¨biosä¸­å¼€å¯ã€‚ å‡†å¤‡å·¥ä½œ ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:0:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"æ¸…é™¤iptablesè§„åˆ™ # CentOS6 service iptables stop; service iptables save # CentOS7 systemctl stop firewalld ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:1:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"å…³é—­selinux sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config setenforce 0 ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:2:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"æ£€æµ‹ç³»ç»Ÿæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ– grep -Ei 'vmx|svm' /proc/cpuinfo å¦‚æœæœ‰è¾“å‡ºå†…å®¹ï¼Œåˆ™æ”¯æŒï¼Œå…¶ä¸­intel cpuæ”¯æŒä¼šæœ‰vmxï¼Œamd cpuæ”¯æŒä¼šæœ‰svm å®‰è£… ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:3:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"æ‰§è¡Œå®‰è£…å‘½ä»¤ yum install -y kvm virt-* libvirt bridge-utils qemu-img è¯´æ˜ï¼š kvm:è½¯ä»¶åŒ…ä¸­å«æœ‰KVMå†…æ ¸æ¨¡å—ï¼Œå®ƒåœ¨é»˜è®¤linuxå†…æ ¸ä¸­æä¾›kvmç®¡ç†ç¨‹åº libvirt:å®‰è£…è™šæ‹Ÿæœºç®¡ç†å·¥å…·ï¼Œä½¿ç”¨virshç­‰å‘½ä»¤æ¥ç®¡ç†å’Œæ§åˆ¶è™šæ‹Ÿæœºã€‚ bridge-utils:è®¾ç½®ç½‘ç»œç½‘å¡æ¡¥æ¥ã€‚ virt-*:åˆ›å»ºã€å…‹éš†è™šæ‹Ÿæœºå‘½ä»¤ï¼Œä»¥åŠå›¾å½¢åŒ–ç®¡ç†å·¥å…·virt-manager qemu-img:å®‰è£…qemuç»„ä»¶ï¼Œä½¿ç”¨qemuå‘½ä»¤æ¥åˆ›å»ºç£ç›˜ç­‰ã€‚ ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:4:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"æ£€æŸ¥kvmæ¨¡å—æ˜¯å¦åŠ è½½ lsmod |grep kvm ç»“æœè¾“å‡ºï¼š kvm_intel 55496 3 kvm 337772 1 kvm_intel å¦‚æœæ²¡æœ‰ï¼Œéœ€è¦æ‰§è¡Œï¼Œè¿˜æ²¡æœ‰å°±é‡å¯ä¸€ä¸‹è¯•è¯• modprobe kvm-intel ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:5:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"é…ç½®ç½‘å¡ cd /etc/sysconfig/network-scripts/ cp ifcfg-eth0 ifcfg-br0 ç¼–è¾‘eth0 DEVICE=eth0 HWADDR=00:0C:29:55:A7:0A TYPE=Ethernet UUID=2be47d79-2a68-4b65-a9ce-6a2df93759c6 ONBOOT=yes NM_CONTROLLED=yes BOOTPROTO=none BRIDGE=br0 ç¼–è¾‘br0 DEVICE=br0 #HWADDR=00:0C:29:55:A7:0A TYPE=Bridge #UUID=2be47d79-2a68-4b65-a9ce-6a2df93759c6 ONBOOT=yes NM_CONTROLLED=yes BOOTPROTO=static IPADDR=192.168.11.17 NETMASK=255.255.255.0 GATEWAY=192.168.11.1 DNS1=202.106.0.20 è®°å¾—é‡å¯ç½‘å¡ï¼š/etc/init.d/network restart br0 Link encap:Ethernet HWaddr 00:0C:29:55:A7:0A inet addr:192.168.11.17 Bcast:192.168.11.255 Mask:255.255.255.0 inet6 addr: fe80::20c:29ff:fe55:a70a/64 Scope:Link UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:141326 errors:0 dropped:0 overruns:0 frame:0 TX packets:90931 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:456024940 (434.8 MiB) TX bytes:10933593 (10.4 MiB) eth0 Link encap:Ethernet HWaddr 00:0C:29:55:A7:0A inet6 addr: fe80::20c:29ff:fe55:a70a/64 Scope:Link UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:341978 errors:0 dropped:0 overruns:0 frame:0 TX packets:90946 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:1000 RX bytes:468848861 (447.1 MiB) TX bytes:10934699 (10.4 MiB) lo Link encap:Local Loopback inet addr:127.0.0.1 Mask:255.0.0.0 inet6 addr: ::1/128 Scope:Host UP LOOPBACK RUNNING MTU:65536 Metric:1 RX packets:0 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:0 (0.0 b) TX bytes:0 (0.0 b) virbr0 Link encap:Ethernet HWaddr 52:54:00:14:EF:D5 inet addr:192.168.122.1 Bcast:192.168.122.255 Mask:255.255.255.0 UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:0 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:0 (0.0 b) TX bytes:0 (0.0 b) ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:6:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"å¯åŠ¨æœåŠ¡ /etc/init.d/libvirtd start /etc/init.d/messagebus restart æ­¤æ—¶å¯ä»¥æŸ¥çœ‹ç½‘ç»œæ¥å£åˆ—è¡¨ $ brctl show bridge name bridge id STP enabled interfaces br0 8000.000c2955a70a no eth0 virbr0 8000.52540014efd5 yes virbr0-nic åˆ›å»ºè™šæ‹Ÿæœº åˆ›å»ºä¸€ä¸ªå­˜å‚¨è™šæ‹Ÿæœºè™šæ‹Ÿç£ç›˜çš„ç›®å½•ï¼Œè¯¥ç›®å½•æ‰€åœ¨åˆ†åŒºå¿…é¡»è¶³å¤Ÿå¤§ mkdir /data/ æ‰§è¡Œå‘½ä»¤ï¼š virt-install \\ --name ping \\ --ram 512 \\ --disk path=/data/ping.img,size=20 \\ --vcpus 1 \\ --os-type linux \\ --os-variant rhel6 \\ --network bridge=br0 \\ --graphics none \\ --console pty,target_type=serial \\ --location 'http://mirrors.163.com/centos/6.8/os/x86_64/' \\ --extra-args 'console=ttyS0,115200n8 serial' è¯´æ˜ï¼š â€“name æŒ‡å®šè™šæ‹Ÿæœºçš„åå­— â€“ram æŒ‡å®šå†…å­˜åˆ†é…å¤šå°‘ â€“disk path æŒ‡å®šè™šæ‹Ÿç£ç›˜æ”¾åˆ°å“ªé‡Œï¼Œsize=30 æŒ‡å®šç£ç›˜å¤§å°ä¸º30G,è¿™æ ·ç£ç›˜æ–‡ä»¶æ ¼å¼ä¸ºrawï¼Œrawæ ¼å¼ä¸èƒ½åšå¿«ç…§ï¼Œåé¢æœ‰è¯´æ˜ï¼Œéœ€è¦è½¬æ¢ä¸ºqcow2æ ¼å¼ï¼Œå¦‚æœè¦ä½¿ç”¨qcow2æ ¼å¼çš„è™šæ‹Ÿç£ç›˜ï¼Œéœ€è¦äº‹å…ˆåˆ›å»ºqcow2æ ¼å¼çš„è™šæ‹Ÿç£ç›˜ã€‚ å‚è€ƒ http://www.361way.com/kvm-qcow2-preallocation-metadata/3354.html ç¤ºä¾‹:qemu-img create -f qcow2 -o preallocation=metadata /data/test02.img 7G; â€“disk path=/data/test02.img,format=qcow2,size=7,bus=virtio â€“vcpus æŒ‡å®šåˆ†é…cpuå‡ ä¸ª â€“os-type æŒ‡å®šç³»ç»Ÿç±»å‹ä¸ºlinux â€“os-variant æŒ‡å®šç³»ç»Ÿç‰ˆæœ¬ â€“network æŒ‡å®šç½‘ç»œç±»å‹ â€“graphics æŒ‡å®šå®‰è£…é€šè¿‡å“ªç§ç±»å‹ï¼Œå¯ä»¥æ˜¯vncï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰å›¾å½¢ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨å›¾å½¢ç›´æ¥ä½¿ç”¨æ–‡æœ¬æ–¹å¼ â€“console æŒ‡å®šæ§åˆ¶å°ç±»å‹ â€“location æŒ‡å®šå®‰è£…ä»‹è´¨åœ°å€ï¼Œå¯ä»¥æ˜¯ç½‘ç»œåœ°å€ï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°çš„ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œï¼ˆâ€“location â€˜/mnt/â€™, å…¶ä¸­/mnt/ä¸‹å°±æ˜¯æˆ‘ä»¬æŒ‚è½½çš„å…‰ç›˜é•œåƒmount /dev/cdrom /mnt)å¦‚æœæ˜¯ç»å¯¹è·¯å¾„ï¼Œé‚£ä¹ˆåé¢è¿˜éœ€è¦æŒ‡å®šä¸€ä¸ªå®‰è£…ä»‹è´¨ï¼Œæ¯”å¦‚NFS ä¹‹åå°±å‡ºç°ï¼š å¼€å§‹å®‰è£…...... æœç´¢æ–‡ä»¶ .treeinfo...... | 720 B 00:00 ... æœç´¢æ–‡ä»¶ vmlinuz...... | 7.7 MB 00:02 ... æœç´¢æ–‡ä»¶ initrd.img...... | 63 MB 00:23 ... åˆ›å»ºå­˜å‚¨æ–‡ä»¶ ping.img | 30 GB 00:00 åˆ›å»ºåŸŸ...... | 0 B 00:00 è¿æ¥åˆ°åŸŸ ping Escape character is ^] ç„¶åå°±æ˜¯æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„OK or Next äº† ï¼Œåªä¸è¿‡è¿™ä¸ªè¿‡ç¨‹æ˜¯æ–‡æœ¬æ¨¡å¼ï¼Œå¦‚æœæƒ³ä½¿ç”¨å›¾å½¢ï¼Œåªèƒ½å¼€å¯vncå•¦ æœ€åå®‰è£…å®Œï¼Œrebootå°±è¿›å…¥åˆšåˆšåˆ›å»ºçš„è™šæ‹Ÿæœºäº†ã€‚è¦æƒ³é€€å›åˆ°å®¿ä¸»æœºï¼Œctrl + ] å³å¯ã€‚ virsh list å¯ä»¥åˆ—å‡ºå½“å‰çš„å­æœºåˆ—è¡¨ã€‚ virsh start ping å¼€å¯å­æœº virsh console ping å¯ä»¥è¿›å…¥æŒ‡å®šçš„å­æœº ä½¿ç”¨pythonç®¡ç†API ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:7:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"å®‰è£…ç›¸å…³åŒ… yum install libvirt-devel ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:8:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"å®‰è£…pythonçš„libvirtåº“ pip install libvirt-python libvirt ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:9:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"æµ‹è¯• import libvirt conn = libvirt.open(\"qemu:///system\") ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:10:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"è¿œç¨‹ç®¡ç† ç›´æ¥ä¸Šè¿°å®‰è£…è¿˜åªèƒ½åœ¨æœ¬åœ°ä½¿ç”¨pythonç®¡ç†ã€‚å¦‚æœè¿˜éœ€è¦è¿œç¨‹ç®¡ç†çš„è¯è¿˜è¦é¢å¤–çš„é…ç½®ã€‚ ä¿®è¯¥é…ç½®æ–‡ä»¶/etc/libvirt/libvirtd.conf ###/etc/libvirt/libvirtd.conf listen_tls = 0ã€€#ç¦ç”¨tlsç™»å½• listen_tcp = 1ã€€#å¯ç”¨tcpæ–¹å¼ç™»å½• tcp_port = \"16509\"ã€€#tcpç«¯å£16509 listen_addr = \"0.0.0.0\" unix_sock_group = \"libvirtd\" unix_sock_rw_perms = \"0770\" auth_unix_ro = \"none\" auth_unix_rw = \"none\" auth_tcp = \"none\"ã€€#TCPä¸ä½¿ç”¨è®¤è¯ max_clients = 1024ã€€#æœ€å¤§æ€»çš„è¿æ¥å®¢æˆ·æ•°1024 min_workers = 50ã€€#libvirtdå¯åŠ¨æ—¶ï¼Œåˆå§‹çš„å·¥ä½œçº¿ç¨‹æ•°ç›® max_workers = 200ã€€#åŒä¸Šï¼Œæœ€å¤§æ•°ç›® max_requests = 1000ã€€#æœ€å¤§åŒæ—¶æ”¯æŒçš„RPCè°ƒç”¨ï¼Œå¿…é¡»å¤§äºç­‰äºmax_workers max_client_requests = 200ã€€#æ¯ä¸ªå®¢æˆ·ç«¯æ”¯æŒçš„æœ€å¤§è¿æ¥æ•° ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/sysconfig/libvirtdï¼š LIBVIRTD_ARGS=\"--listen\" é‡å¯æœåŠ¡ålibvirtdä¼šç»‘å®šåœ¨16509ç«¯å£ åœ¨è¿œç¨‹çš„æœºå™¨ä¸Šå®‰è£…pythonåº“ yum install libvirt-devel python-devel # è¦å…ˆå®‰è£…libvirt-develåŒ…ï¼Œå› ä¸ºlibvirt-pythonä¾èµ–äºlibvirt-devel pip install libvirt libvirt-python æµ‹è¯•ä»£ç ï¼š import libvirt conn = libvirt.open(\"qemu+tcp://192.168.11.17/system\") æ²¡æœ‰æŠ¥é”™ï¼Œå®‰è£…å®Œæ¯•ã€‚ ","date":"2021-12-03","objectID":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/:11:0","tags":null,"title":"CentOSä¸‹kvmå®‰è£…","uri":"/centos%E4%B8%8Bkvm%E5%AE%89%E8%A3%85/"},{"categories":null,"content":"Containerdæºç åˆ†æ ä» Kubernetes 1.22 å¼€å§‹ï¼Œk8s çš„å®¹å™¨è¿è¡Œæ˜¯é»˜è®¤æ›¿æ¢æˆ containerdã€‚æœ‰å¿…è¦æ·±å…¥äº†è§£ containerd çš„å†…éƒ¨å®ç°åŸç†ã€‚æœ¬ç¯‡é€šè¿‡åˆ†æ containerd çš„ä»£ç æ·±å…¥ç†è§£å…¶å†…éƒ¨åŸç†ã€‚ ä½¿ç”¨çš„ç‰ˆæœ¬ä¸º containerd 1.5ã€‚ ","date":"2021-12-03","objectID":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:0:0","tags":null,"title":"Containerdæºç åˆ†æ","uri":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":null,"content":"é…ç½®ç¯å¢ƒ ä¸‹è½½ containerd æºç : git clone github.com/containerd/containerd å¯åŠ¨ goland çš„è¿œç¨‹è°ƒè¯•åŠŸèƒ½ ","date":"2021-12-03","objectID":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:1:0","tags":null,"title":"Containerdæºç åˆ†æ","uri":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":null,"content":"å…¥å£ å…ˆæ¥ä» main å‡½æ•°æ¥çœ‹å¯åŠ¨æµç¨‹ã€‚ä»ä»¥ä¸‹ç›®å½•ç»“æ„ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œcontainerd é¡¹ç›®ç›®å½•ä¸­åŒ…å«ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹å’Œå¯¹åº”çš„æ‰§è¡Œå·¥å…·ã€‚ cmd â”œâ”€â”€ containerd // containerd CRI å®ç°ï¼Œå¯¹å¤–æä¾›å®¹å™¨æœåŠ¡ï¼Œå¯¹å†…å’Œ containerd-shim-runc é€šè®¯ â”œâ”€â”€ containerd-shim â”œâ”€â”€ containerd-shim-runc-v1 // è´Ÿè´£å’Œ runc é€šä¿¡ï¼Œç®¡ç†å®¹å™¨å®ä¾‹ â”œâ”€â”€ containerd-shim-runc-v2 // v2 ç‰ˆæœ¬ â”œâ”€â”€ containerd-stress â”œâ”€â”€ ctr // containerd å®¢æˆ·ç«¯å‘½ä»¤è¡Œå·¥å…· â”œâ”€â”€ gen-manpages â””â”€â”€ protoc-gen-gogoctrd ä»¥ä¸‹æ˜¯å®ƒä»¬ä¹‹é—´çš„è°ƒç”¨æµç¨‹å›¾: ","date":"2021-12-03","objectID":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:2:0","tags":null,"title":"Containerdæºç åˆ†æ","uri":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":null,"content":"containerd containerd æœ¬èº«æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·å®ç°ï¼Œå…¥å£æ–‡ä»¶ä¸º cmd/containerd/main.go func main() { app := command.App() if err := app.Run(os.Args); err != nil { fmt.Fprintf(os.Stderr, \"containerd: %s\\n\", err) os.Exit(1) } } ","date":"2021-12-03","objectID":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:3:0","tags":null,"title":"Containerdæºç åˆ†æ","uri":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":null,"content":"command app containerd åŒ…å«ä¸‰ä¸ªå­å‘½ä»¤: configCommand: è¾“å‡º containerd é»˜è®¤é…ç½®æ–‡ä»¶ publishCommand: å‘ containerd æœåŠ¡å‘å¸ƒä¸€ä¸ªäº‹ä»¶ ociHook: å¯åŠ¨ä¸€ä¸ª oci é’©å­ app.Action ä¸­å®šä¹‰äº† containerd çš„å¯åŠ¨æµç¨‹ï¼š ... app.Action = func(context *cli.Context) error { ... // åŠ è½½é…ç½®æ–‡ä»¶ configPath := context.GlobalString(\"config\") ... // é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º serverï¼Œserver ä¸­åŒ…å« ttrpcã€grpcã€tcpã€metrics server, err := server.New(ctx, config) ... ... // å¯åŠ¨ ttrpc æœåŠ¡ serve(ctx, tl, server.ServeTTRPC) ... if config.GRPC.TCPAddress != \"\" { l, err := net.Listen(\"tcp\", config.GRPC.TCPAddress) if err != nil { return errors.Wrapf(err, \"failed to get listener for TCP grpc endpoint\") } // å¯åŠ¨ tcp æœåŠ¡ serve(ctx, l, server.ServeTCP) } ... // å¯åŠ¨ grpc æœåŠ¡ serve(ctx, l, server.ServeGRPC) ... return nil } ... å†æ¥çœ‹ server.Newï¼Œå®ƒåˆ›å»º containerd æœåŠ¡: func New(ctx context.Context, config *srvconfig.Config) (*Server, error) { ... // ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½æ’ä»¶ plugins, err := LoadPlugins(ctx, config) if err != nil { return nil, err } ... // å¾ªç¯ç¡®è®¤æ’ä»¶ç±»å‹ï¼Œå¹¶è§£æã€‚ for _, p := range plugins { id := p.URI() reqID := id if config.GetVersion() == 1 { reqID = p.ID } log.G(ctx).WithField(\"type\", p.Type).Infof(\"loading plugin %q...\", id) initContext := plugin.NewContext( ctx, p, initialized, config.Root, config.State, ) initContext.Events = s.events initContext.Address = config.GRPC.Address initContext.TTRPCAddress = config.TTRPC.Address // load the plugin specific configuration if it is provided if p.Config != nil { pc, err := config.Decode(p) if err != nil { return nil, err } initContext.Config = pc } result := p.Init(initContext) if err := initialized.Add(result); err != nil { return nil, errors.Wrapf(err, \"could not add plugin result to plugin set\") } instance, err := result.Instance() if err != nil { if plugin.IsSkipPlugin(err) { log.G(ctx).WithError(err).WithField(\"type\", p.Type).Infof(\"skip loading plugin %q...\", id) } else { log.G(ctx).WithError(err).Warnf(\"failed to load plugin %s\", id) } if _, ok := required[reqID]; ok { return nil, errors.Wrapf(err, \"load required plugin %s\", id) } continue } delete(required, reqID) // check for grpc services that should be registered with the server if src, ok := instance.(plugin.Service); ok { grpcServices = append(grpcServices, src) } if src, ok := instance.(plugin.TTRPCService); ok { ttrpcServices = append(ttrpcServices, src) } if service, ok := instance.(plugin.TCPService); ok { tcpServices = append(tcpServices, service) } s.plugins = append(s.plugins, result) } // æ³¨å†ŒæœåŠ¡ // register services after all plugins have been initialized for _, service := range grpcServices { if err := service.Register(grpcServer); err != nil { return nil, err } } for _, service := range ttrpcServices { if err := service.RegisterTTRPC(ttrpcServer); err != nil { return nil, err } } for _, service := range tcpServices { if err := service.RegisterTCP(tcpServer); err != nil { return nil, err } } return s, nil } ç”±æ­¤å¯çŸ¥ï¼Œcontainerd ä¸­çš„æœåŠ¡éƒ½æ˜¯é€šè¿‡æ’ä»¶åŠ è½½çš„ï¼Œæ’ä»¶çš„åŠ è½½ä»£ç ç»Ÿä¸€å­˜æ”¾åœ¨ cmd/containerd/containerd ç›®å½•ä¸‹çš„ builtins*.go æ–‡ä»¶ä¸­ã€‚ å…¶ä¸­åŒ…å«ä»¥ä¸‹å‡ ç§æœåŠ¡: container content diff images events introspection leases namespaces snapshots tasks ttrpc version å…·ä½“çš„ä»£ç å­˜æ”¾åœ¨ services ç›®å½•ä¸‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ images å’Œ container è¿™ä¸¤ä¸ªæœ€é‡è¦çš„æœåŠ¡ã€‚ ","date":"2021-12-03","objectID":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:3:1","tags":null,"title":"Containerdæºç åˆ†æ","uri":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":null,"content":"é•œåƒæ“ä½œ containerd ä½œä¸º docker çš„æ›¿ä»£è€…ï¼Œç†æ‰€å½“ç„¶çš„éœ€è¦å®ç° docker çš„æ ¸å¿ƒåŠŸèƒ½ OCIã€‚images æœåŠ¡åŒ…å«: Get : é€šè¿‡åç§°è·å–å•ä¸ªé•œåƒ List : è·å–é•œåƒåˆ—è¡¨ Create : åˆ›å»ºä¸€ä¸ªé•œåƒ Update : æ›´æ–°é•œåƒ Delete : é€šè¿‡åç§°åˆ é™¤é•œåƒ å…·ä½“ä»£ç è¯·çœ‹ services/images/local.go: // åˆå§‹åŒ–ï¼Œæ³¨å†Œæˆæ’ä»¶ func init() { plugin.Register(\u0026plugin.Registration{ Type: plugin.ServicePlugin, // æ’ä»¶ç±»å‹ ID: services.ImagesService, // æ’ä»¶åç§° Requires: []plugin.Type{ plugin.MetadataPlugin, // ä¾èµ–çš„æ’ä»¶ plugin.GCPlugin, }, InitFn: func(ic *plugin.InitContext) (interface{}, error) { // åˆå§‹åŒ–æ–¹æ³• m, err := ic.Get(plugin.MetadataPlugin) // è·å– plugin.MetadataPlugin æ’ä»¶ï¼Œä½œä¸ºå­˜å‚¨ï¼Œå†…éƒ¨ä½¿ç”¨ bblot å®ç° if err != nil { return nil, err } g, err := ic.Get(plugin.GCPlugin) // GC æ’ä»¶ï¼Œç”¨äºèµ„æºå›æ”¶ if err != nil { return nil, err } return \u0026local{ store: metadata.NewImageStore(m.(*metadata.DB)), publisher: ic.Events, // å†…éƒ¨çš„è®¢é˜…å‘å¸ƒæ¨¡å‹ gc: g.(gcScheduler), // gc è°ƒåº¦å™¨ }, nil }, }) } // images æœåŠ¡çš„å…·ä½“å®ç° type local struct { store images.Store // å†…éƒ¨å­˜å‚¨å™¨ gc gcScheduler // gc è°ƒåº¦å™¨ publisher events.Publisher // å†…éƒ¨çš„è®¢é˜…å‘å¸ƒæ¨¡å‹ } var _ imagesapi.ImagesClient = \u0026local{} ... è¿™é‡Œæˆ‘ä»¬å¯ä»¥æŠŠ images çš„æ“ä½œåˆ†ä¸ºè¯»å–å’Œä¿®æ”¹ä¸¤ç»„ã€‚Get å’Œ List ä¸ºè¯»å–æ“ä½œï¼Œå°±æ˜¯ä»æ•°æ®åº“ä¸­è¯»å–ç›¸å…³è®°å½•ã€‚ ... func (l *local) Get(ctx context.Context, req *imagesapi.GetImageRequest, _ ...grpc.CallOption) (*imagesapi.GetImageResponse, error) { image, err := l.store.Get(ctx, req.Name) if err != nil { return nil, errdefs.ToGRPC(err) } imagepb := imageToProto(\u0026image) return \u0026imagesapi.GetImageResponse{ Image: \u0026imagepb, }, nil } func (l *local) List(ctx context.Context, req *imagesapi.ListImagesRequest, _ ...grpc.CallOption) (*imagesapi.ListImagesResponse, error) { images, err := l.store.List(ctx, req.Filters...) if err != nil { return nil, errdefs.ToGRPC(err) } return \u0026imagesapi.ListImagesResponse{ Images: imagesToProto(images), }, nil } ... Createã€Update å’Œ Delete æ˜¯ä¿®æ”¹æ“ä½œï¼Œæ ¸å¿ƒæ˜¯é€šè¿‡ events.Publisher å‘å¸ƒäº‹ä»¶å¯¹åº”çš„äº‹ä»¶ // services/images/local.go func (l *local) Create(ctx context.Context, req *imagesapi.CreateImageRequest, _ ...grpc.CallOption) (*imagesapi.CreateImageResponse, error) { ... if err := l.publisher.Publish(ctx, \"/images/create\", \u0026eventstypes.ImageCreate{ Name: resp.Image.Name, Labels: resp.Image.Labels, }); err != nil { return nil, err } ... return \u0026resp, nil } è€ŒçœŸæ­£å¤„ç†è¯¥äº‹ä»¶çš„è®¢é˜…è€…åˆ™æ˜¯ containerd å®ç°çš„ CRI æ¥å£æœåŠ¡ ã€‚ // pkg/cri/server/service.go ... // criService implements CRIService. type criService struct { ... } ... cri å¯åŠ¨æ—¶ï¼Œè®¢é˜… containerd äº‹ä»¶ï¼Œå¹¶å¯åŠ¨äº‹ä»¶å¤„ç†åç¨‹: // pkg/cri/server/service.go // Run starts the CRI service. func (c *criService) Run() error { logrus.Info(\"Start subscribing containerd event\") c.eventMonitor.subscribe(c.client) ... // Start event handler. logrus.Info(\"Start event monitor\") eventMonitorErrCh := c.eventMonitor.start() ... } eventMonitor.start() å†…éƒ¨å¤„ç†é€»è¾‘å¦‚ä¸‹: func (em *eventMonitor) start() \u003c-chan error { ... go func() { defer close(errCh) for { select { case e := \u003c-em.ch: logrus.Debugf(\"Received containerd event timestamp - %v, namespace - %q, topic - %q\", e.Timestamp, e.Namespace, e.Topic) if e.Namespace != constants.K8sContainerdNamespace { logrus.Debugf(\"Ignoring events in namespace - %q\", e.Namespace) break } id, evt, err := convertEvent(e.Event) if err != nil { logrus.WithError(err).Errorf(\"Failed to convert event %+v\", e) break } if em.backOff.isInBackOff(id) { logrus.Infof(\"Events for %q is in backoff, enqueue event %+v\", id, evt) em.backOff.enBackOff(id, evt) break } if err := em.handleEvent(evt); err != nil { logrus.WithError(err).Errorf(\"Failed to handle event %+v for %s\", evt, id) em.backOff.enBackOff(id, evt) } case err := \u003c-em.errCh: ... case \u003c-backOffCheckCh: ... } } }() return errCh } namespace ä¸ä¸º k8s.io æ—¶äº‹ä»¶éƒ½ä¼šè¢«å¿½ç•¥ã€‚ criService ä¸€å…±å¤„ç†äº”ç±»äº‹ä»¶: TaskExit TaskOOM ImageCreate ImageUpdate ImageDelete // pkg/cri/server/event.go // handleEvent handles a containerd event. func (em *eventMonitor) handleEvent(any interface{}) error { ... switch e := any.(type) { case *eventtypes.TaskExit: ... case *eventtypes.TaskOOM: ... case *eventtypes.ImageCreate: logrus.Infof(\"ImageCreate event %+v\", e) return em.c.updateImage(ctx, e.Name) case *eventtypes.ImageUpdate: logrus.Infof(\"ImageUpdate event %+v\", e) return e","date":"2021-12-03","objectID":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:4:0","tags":null,"title":"Containerdæºç åˆ†æ","uri":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":null,"content":"å®¹å™¨æ“ä½œ ä»‹ç»å®Œé•œåƒæ“ä½œåï¼Œæ¥ä¸‹æ¥å°±æ˜¯å…³äºå®¹å™¨éƒ¨åˆ†çš„æ“ä½œã€‚ä»¥ä¸‹æˆ‘ä»¬é€šè¿‡ä¸€æ®µä»£ç æ¥æ¢ç©¶ containerd å†…éƒ¨çš„å®¹å™¨ç®¡ç†æ–¹å¼: package main import ( \"context\" \"log\" \"syscall\" \"github.com/containerd/containerd\" \"github.com/containerd/containerd/cio\" \"github.com/containerd/containerd/namespaces\" \"github.com/containerd/containerd/oci\" ) func main() { client, err := containerd.New(\"/run/containerd/containerd.sock\", containerd.WithDefaultNamespace(\"default\")) if err != nil { log.Fatal(err) } defer client.Close() ctx := context.Background() log.Println(\"get image\") img, err := client.GetImage(ctx, \"docker.io/library/redis:alpine3.14\") if err != nil { log.Fatal(err) } log.Println(\"new container\") ctx = namespaces.WithNamespace(ctx, \"default\") c, err := client.NewContainer(ctx, \"redis\", containerd.WithNewSnapshot(\"redis-rootfs\", img), containerd.WithNewSpec(oci.WithImageConfig(img)), ) if err != nil { log.Fatalf(\"new container: %v\", err) } defer c.Delete(ctx) log.Println(\"new task\") task, err := c.NewTask(ctx, cio.NewCreator(cio.WithStdio)) if err != nil { log.Fatal(err) } pid := task.Pid() log.Printf(\"redis running in pid=%d\\n\", pid) err = task.Start(ctx) if err != nil { log.Fatalf(\"start task: %v\", err) } err = task.Kill(ctx, syscall.SIGINT) if err != nil { log.Fatalf(\"kill task: %v\", err) } for { status, _ := task.Status(ctx) if status.Status == containerd.Stopped { break } } _, err = task.Delete(ctx) if err != nil { log.Fatalf(\"delete task: %v\", err) } } containerd ä¸­åˆ›å»ºä¸€ä¸ªå®¹å™¨ä¹‹åï¼Œå¦‚æœè¦è¿è¡Œè¿™ä¸ªå®¹å™¨ï¼Œå°±éœ€è¦åˆ›å»ºä¸€ä¸ª task ç”¨æ¥ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚å¯ä»¥ç†è§£ä¸º task å°±æ˜¯ containerd çš„è¿è¡Œæ—¶ã€‚ ","date":"2021-12-03","objectID":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:5:0","tags":null,"title":"Containerdæºç åˆ†æ","uri":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":null,"content":"åˆ›å»º åˆ›å»ºå®¹å™¨å¦‚ä¸‹: // services/containers/local.go func (l *local) Create(ctx context.Context, req *api.CreateContainerRequest, _ ...grpc.CallOption) (*api.CreateContainerResponse, error) { var resp api.CreateContainerResponse if err := l.withStoreUpdate(ctx, func(ctx context.Context) error { container := containerFromProto(\u0026req.Container) created, err := l.Store.Create(ctx, container) if err != nil { return err } resp.Container = containerToProto(\u0026created) return nil }); err != nil { return \u0026resp, errdefs.ToGRPC(err) } if err := l.publisher.Publish(ctx, \"/containers/create\", \u0026eventstypes.ContainerCreate{ ID: resp.Container.ID, Image: resp.Container.Image, Runtime: \u0026eventstypes.ContainerCreate_Runtime{ Name: resp.Container.Runtime.Name, Options: resp.Container.Runtime.Options, }, }); err != nil { return \u0026resp, err } return \u0026resp, nil } é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯ä¿å­˜æ•°æ®åˆ°å†…éƒ¨å­˜å‚¨ä¸­ï¼Œå†å‘å¸ƒåˆ›å»ºå®¹å™¨çš„äº‹ä»¶ã€‚ ","date":"2021-12-03","objectID":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:5:1","tags":null,"title":"Containerdæºç åˆ†æ","uri":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":null,"content":"å¯åŠ¨ å¯åŠ¨å®¹å™¨éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª taskï¼Œä½¿ç”¨ task æ¥ç®¡ç†å®¹å™¨ // services/tasks/local.go ... func (l *local) Create(ctx context.Context, r *api.CreateTaskRequest, _ ...grpc.CallOption) (*api.CreateTaskResponse, error) { ... // åˆ›å»ºå®¹å™¨è¿è¡Œæ—¶ c, err := rtime.Create(ctx, r.ContainerID, opts) if err != nil { return nil, errdefs.ToGRPC(err) } if err := l.monitor.Monitor(c); err != nil { return nil, errors.Wrap(err, \"monitor task\") } return \u0026api.CreateTaskResponse{ ContainerID: r.ContainerID, Pid: c.PID(), }, nil } // runtime/v2/manager.go // Create a new task func (m *TaskManager) Create(ctx context.Context, id string, opts runtime.CreateOpts) (_ runtime.Task, retErr error) { // åœ¨ç£ç›˜ä¸Šæ–°å»ºä¸€ä¸ªçº¦æŸç›®å½• bundle, err := NewBundle(ctx, m.root, m.state, id, opts.Spec.Value) ... // åˆ›å»ºå¯åŠ¨ä¸€ä¸ª containerd-shim-runc-v2 ç®¡ç†å®¹å™¨è¿è¡Œæ—¶ shim, err := m.startShim(ctx, bundle, id, opts) ... // åˆ›å»ºä¸€ä¸ª task t, err := shim.Create(ctx, opts) ... // æ·»åŠ  task if err := m.tasks.Add(ctx, t); err != nil { return nil, errors.Wrap(err, \"failed to add task\") } return t, nil } å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª TaskManager æ¥ç®¡ç† tasks // runtime/v2/manager.go // TaskManager manages v2 shim's and their tasks type TaskManager struct { root string state string containerdAddress string containerdTTRPCAddress string tasks *runtime.TaskList events *exchange.Exchange containers containers.Store } containerd æœåŠ¡å’Œ containerd-shim-runc-v2 ä½¿ç”¨ ttrpc é€šè®¯ã€‚ ","date":"2021-12-03","objectID":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:5:2","tags":null,"title":"Containerdæºç åˆ†æ","uri":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":null,"content":"åœæ­¢ å¦‚ä½•åœæ­¢ä¸€ä¸ªå®¹å™¨å‘¢? // services/tasks/local.go func (l *local) Kill(ctx context.Context, r *api.KillRequest, _ ...grpc.CallOption) (*ptypes.Empty, error) { t, err := l.getTask(ctx, r.ContainerID) if err != nil { return nil, err } p := runtime.Process(t) if r.ExecID != \"\" { if p, err = t.Process(ctx, r.ExecID); err != nil { return nil, errdefs.ToGRPC(err) } } if err := p.Kill(ctx, r.Signal, r.All); err != nil { return nil, errdefs.ToGRPC(err) } return empty, nil } // runtime/v2/shim.go func (s *shim) Kill(ctx context.Context, signal uint32, all bool) error { if _, err := s.task.Kill(ctx, \u0026task.KillRequest{ ID: s.ID(), Signal: signal, All: all, }); err != nil { return errdefs.FromGRPC(err) } return nil } ä» containerd tasks æœåŠ¡ä¸­è·å– tasks ä¿¡æ¯ï¼Œç„¶åé€šè¿‡ ttrpc è¿æ¥ containerd-shim-runc-v2 å¹¶æ€æ­»è¿›ç¨‹ã€‚ containerd-shim-runc-v2 æ”¯æŒä»¥ä¸‹æ¥å£ Create Delete Exec State Pause Resume Kill Pids CloseIO CheckPoint Update ResizePty ","date":"2021-12-03","objectID":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:5:3","tags":null,"title":"Containerdæºç åˆ†æ","uri":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":null,"content":"æ’ä»¶æœºåˆ¶ containerd å†…éƒ¨æœåŠ¡éƒ½æ˜¯é€šè¿‡æ’ä»¶æ–¹å¼æ³¨å†Œã€‚æ³¨å†Œæ’ä»¶ä»£ç å¦‚ä¸‹: // services/server/tasks/local.go func init() { plugin.Register(\u0026plugin.Registration{ Type: plugin.ServicePlugin, ID: services.TasksService, Requires: tasksServiceRequires, InitFn: initFunc, }) timeout.Set(stateTimeout, 2*time.Second) } containerd å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªå…¨å±€æ’ä»¶åˆ—è¡¨: // plugin/plugin.go var register = struct { sync.RWMutex r []*Registration }{} å¯¹å¤–æä¾›ä¸‰ç§æ–¹æ³•: Load : é€šè¿‡è·¯å¾„åŠ è½½æ’ä»¶ Register : æ³¨å†Œæ’ä»¶ Graph : éå†æ’ä»¶åˆ—è¡¨ æ³¨å†Œçš„æ’ä»¶åœ¨ containerd æœåŠ¡å¯åŠ¨æ—¶åˆå§‹åŒ–: // services/server/server.go // New creates and initializes a new containerd server func New(ctx context.Context, config *srvconfig.Config) (*Server, error) { ... for _, p := range plugins { id := p.URI() reqID := id if config.GetVersion() == 1 { reqID = p.ID } log.G(ctx).WithField(\"type\", p.Type).Infof(\"loading plugin %q...\", id) // æ–°å»ºæ’ä»¶ä¸Šä¸‹æ–‡ç»“æ„ä½“ initContext := plugin.NewContext( ctx, p, initialized, config.Root, config.State, ) initContext.Events = s.events initContext.Address = config.GRPC.Address initContext.TTRPCAddress = config.TTRPC.Address // åŠ è½½é…ç½®å‚æ•° if p.Config != nil { pc, err := config.Decode(p) if err != nil { return nil, err } initContext.Config = pc } // æ’ä»¶åˆå§‹åŒ– result := p.Init(initContext) if err := initialized.Add(result); err != nil { return nil, errors.Wrapf(err, \"could not add plugin result to plugin set\") } // è·å–æ’ä»¶å®ä¾‹ instance, err := result.Instance() if err != nil { if plugin.IsSkipPlugin(err) { log.G(ctx).WithError(err).WithField(\"type\", p.Type).Infof(\"skip loading plugin %q...\", id) } else { log.G(ctx).WithError(err).Warnf(\"failed to load plugin %s\", id) } if _, ok := required[reqID]; ok { return nil, errors.Wrapf(err, \"load required plugin %s\", id) } continue } delete(required, reqID) // æ ¹æ®æ’ä»¶ç±»å‹ï¼ŒåŠ è½½æˆä¸åŒçš„æœåŠ¡ if src, ok := instance.(plugin.Service); ok { grpcServices = append(grpcServices, src) } if src, ok := instance.(plugin.TTRPCService); ok { ttrpcServices = append(ttrpcServices, src) } if service, ok := instance.(plugin.TCPService); ok { tcpServices = append(tcpServices, service) } s.plugins = append(s.plugins, result) } ... return s, nil } æ’ä»¶åˆå§‹åŒ–å‡½æ•°éœ€è¦ InitContextã€‚ // InitContext is used for plugin inititalization type InitContext struct { Context context.Context Root string State string Config interface{} Address string TTRPCAddress string Events *exchange.Exchange Meta *Meta // plugins can fill in metadata at init. plugins *Set } InitContext ä¸­æºå¸¦çš„ plugins å˜é‡æŒ‡å‘å…¨å±€æ’ä»¶é›†åˆã€‚ç»“æ„ä½“ä¸­ä¿å­˜æ’ä»¶åˆå§‹åŒ–æ‰€éœ€çš„å‚æ•°ï¼ŒåŒ…æ‹¬ Root : containerd é¡¹ç›®çš„æ ¹ç›®å½•ï¼Œä»é…ç½®æ–‡ä»¶ä¸­è·å–ã€‚ï¼ˆé»˜è®¤ä¸º /var/lib/containerdï¼‰ State : containerd è¿è¡Œè¿‡ç¨‹ä¸­æ•°æ®çš„å­˜æ”¾ç›®å½•ï¼Œä»é…ç½®æ–‡ä»¶ä¸­è·å–ï¼Œ(é»˜è®¤ä¸º /run/containerd) Config : é…ç½®æ–‡ä»¶ Address : gRPC åœ°å€ TTRPCAddress: ttrpc åœ°å€ Events: å…¨å±€çš„è®¢é˜…å‘å¸ƒæ¨¡å‹ // plugin/context.go // Plugin represents an initialized plugin, used with an init context. type Plugin struct { Registration *Registration // registration, as initialized Config interface{} // config, as initialized Meta *Meta instance interface{} err error // will be set if there was an error initializing the plugin } æ¯ä¸ªæœåŠ¡ä½¿ç”¨ Plugin å°è£…ï¼Œæ’ä»¶çš„ä¿¡æ¯ä¿å­˜åˆ° Registration ä¸­: // plugin/plugin.go // Registration contains information for registering a plugin type Registration struct { // Type of the plugin Type Type // ID of the plugin ID string // Config specific to the plugin Config interface{} // Requires is a list of plugins that the registered plugin requires to be available Requires []Type // InitFn is called when initializing a plugin. The registration and // context are passed in. The init function may modify the registration to // add exports, capabilities and platform support declarations. InitFn func(*InitContext) (interface{}, error) // Disable the plugin from loading Disable bool } Registration åŒ…å«æ’ä»¶ç±»å‹ï¼Œæ’ä»¶IDï¼Œé…ç½®å‚æ•°ï¼Œä¾èµ–çš„å…¶ä»–æ’ä»¶ç±»å‹ï¼Œåˆå§‹åŒ–å‡½æ•°ã€‚ ","date":"2021-12-03","objectID":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:6:0","tags":null,"title":"Containerdæºç åˆ†æ","uri":"/containerd%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":null,"content":"Dblink æŸ¥è¯¢æ‰€æœ‰è§¦å‘å™¨ select*fromuser_triggers; æ ¹æ®åç§°ç¦ç”¨è§¦å‘å™¨ altertriggerLOGMNRGGC_TRIGGERdisable; æŸ¥è¯¢æ‰€æœ‰ job select*fromuser_jobs; æ ¹æ® id ç¦ç”¨ job BEGINdbms_job.broken(4001,true);END; ç¦ç”¨ oracle dblink altersystemsetopen_links=0sid='$sid'scope=spfile;altersystemsetopen_links_per_instance=0sid='$sid'scope=spfile; å¯ç”¨ oracle dblink altersystemsetopen_links=4sid='$sid'scope=spfile;altersystemsetopen_links_per_instance=4sid='$sid'scope=spfile; ","date":"2021-12-03","objectID":"/dblink/:0:0","tags":null,"title":"Dblink","uri":"/dblink/"},{"categories":null,"content":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡ ","date":"2021-12-03","objectID":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/:0:0","tags":null,"title":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡","uri":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":"å¸¸ç”¨çš„å®¹å™¨åŒ–æŠ€æœ¯ ","date":"2021-12-03","objectID":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/:1:0","tags":null,"title":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡","uri":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":"Chroot ç‰¹ç‚¹: æ”¹å˜æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å’Œå®ƒçš„å­è¿›ç¨‹æ ¹ç›®å½•ã€‚ ç»chrootè®¾ç½®æ ¹ç›®å½•çš„ç¨‹åºï¼Œä¸èƒ½å¤Ÿå¯¹è¿™ä¸ªæŒ‡å®šæ ¹ç›®å½•ä¹‹å¤–çš„æ–‡ä»¶è¿›è¡Œè®¿é—®å’Œè¯»å–ï¼Œä¹Ÿä¸èƒ½å†™æ“ä½œã€‚ åŸç†: ä¿®æ”¹PCBå®ç°é™åˆ¶åŠŸèƒ½ (PCB: process control block) ç¼ºç‚¹: éš”ç¦»æ–‡ä»¶ç³»ç»Ÿ ä½†æ˜¯æ— æ³•é™åˆ¶ CPU, å†…å­˜, ç½‘ç»œç«¯å£å·çš„å‘½åç©ºé—´ ","date":"2021-12-03","objectID":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/:1:1","tags":null,"title":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡","uri":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":"Jails ç‰¹ç‚¹ï¼š åŸºäºChrootçš„æ“ä½œç³»ç»Ÿå±‚è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚ åªèƒ½è®¿é—®æŸä¸ªéƒ¨åˆ†çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯FreeBSD jailæœºåˆ¶é™åˆ¶äº†åœ¨è½¯ä»¶ç›‘ç‹±ä¸­è¿ä½œçš„è¡Œç¨‹ï¼Œä¸èƒ½å¤Ÿå½±å“æ“ä½œç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ† åœºæ™¯ï¼š è™šæ‹ŸåŒ– å®‰å…¨æ€§ æ˜“ç»´æŠ¤ ç¼ºç‚¹: ä½¿ç”¨å¤æ‚ éš”ç¦»çº§åˆ«è¾ƒå¼± å‡ºç°æ²™ç›’æ¦‚å¿µ ","date":"2021-12-03","objectID":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/:1:2","tags":null,"title":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡","uri":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":"LinuxÂ vserverÂ /Â openVZ ç‰¹ç‚¹: ç±»ä¼¼Jailsæœºåˆ¶ï¼Œå¯ä»¥å¯¹è®¡ç®—æœºç³»ç»Ÿä¸Šçš„èµ„æºï¼ˆæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œåœ°å€ã€å†…å­˜ï¼‰è¿›è¡Œåˆ†åŒº Linuxæ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå®ƒé€šè¿‡Linuxå†…æ ¸è¡¥ä¸å½¢å¼è¿›è¡Œè™šæ‹ŸåŒ–ã€éš”ç¦»ã€èµ„æºç®¡ç†å’ŒçŠ¶æ€æ£€æŸ¥ ä¼˜ç‚¹: èµ„æºéš”ç¦»æ€§(CPUè¶…å–ï¼Œå†…å­˜å…±äº«) ç¼ºç‚¹: éš”ç¦»çº§åˆ«è¾ƒå¼± è¿›ä¸€æ­¥å¼ºåŒ–æ²™ç›’æ¦‚å¿µã€‚ ","date":"2021-12-03","objectID":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/:1:3","tags":null,"title":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡","uri":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":"LXC ç‰¹ç‚¹: linux è‡ªå¸¦åŠŸèƒ½ï¼Œå‡ ä¹æ²¡æœ‰é¢å¤–çš„æ€§èƒ½æŸè€—ã€‚ è½»é‡çº§çš„ â€œè™šæ‹ŸåŒ– â€œæ–¹æ³•ï¼ŒåŒæ—¶è¿è¡Œå¤šä¸ªè™šæ‹Ÿå•å…ƒã€‚ å®¹å™¨æ˜¯ç”¨å†…æ ¸æ§åˆ¶ç»„ï¼ˆcgroupsï¼‰å’Œå†…æ ¸å‘½åç©ºé—´æ¥éš”ç¦»çš„ã€‚ ä¼˜åŠ¿ é€šè¿‡å®¹å™¨éš”ç¦»åº”ç”¨ç¨‹åºå’Œæ“ä½œç³»ç»Ÿ é€šè¿‡LXCå®æ—¶ç®¡ç†èµ„æºçš„åˆ†é…ï¼Œæä¾›è¿‘ä¹åŸç”Ÿçš„æ€§èƒ½ã€‚ é€šè¿‡cgroupsæ§åˆ¶ç½‘ç»œæ¥å£å’Œåº”ç”¨å®¹å™¨å†…çš„èµ„æºã€‚ ç¼ºé™· æ‰€æœ‰LXCå®¹å™¨éƒ½ä½¿ç”¨ç›¸åŒçš„å†…æ ¸ã€‚ åªèƒ½åœ¨Linuxæ“ä½œç³»ç»Ÿè¿è¡Œã€‚ LXC å¹¶ä¸å®‰å…¨ï¼Œå®‰å…¨æ€§å–å†³äºä¸»æœºç³»ç»Ÿã€‚ ","date":"2021-12-03","objectID":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/:1:4","tags":null,"title":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡","uri":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":"cgroup å’Œ namespace Cgroups: ç”¨äºé™åˆ¶å’Œéš”ç¦»ä¸€ç»„è¿›ç¨‹å¯¹ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨ å¯¹ä¸åŒèµ„æºçš„å…·ä½“ç®¡ç†æ˜¯ç”±å„ä¸ªå­ç³»ç»Ÿåˆ†å·¥å®Œæˆçš„ Namespace: å†…æ ¸å…¨å±€èµ„æºçš„å°è£… æ¯ä¸ªnamespaceæ˜¯ä¸€ä»½ç‹¬ç«‹çš„èµ„æº ä¸åŒè¿›ç¨‹åœ¨å„è‡ªnamespaceä¸­å¯¹åŒä¸€ç§èµ„æºçš„ä½¿ç”¨äº’ä¸å¹²æ‰° å¸¸ç”¨çš„namespaceæœ‰IPCã€Networkã€Mountã€PIDã€Userå’ŒUTCÂ  ","date":"2021-12-03","objectID":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/:1:5","tags":null,"title":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡","uri":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":"docker çš„æ¶æ„å’ŒåŸç† å®¹å™¨æŠ€æœ¯çš„ç›®æ ‡ æé«˜ç³»ç»Ÿèµ„æºåˆ©ç”¨ç‡ æé«˜è¿›ç¨‹è¿è¡Œç¨³å®šæ€§ docker ä¹‹å‰çš„è§£å†³æ–¹æ¡ˆ: è™šæ‹ŸåŒ–è§£å†³æ–¹æ¡ˆ è½¯ä»¶è™šæ‹ŸåŒ– ç¡¬ä»¶è™šæ‹ŸåŒ– è™šæ‹ŸåŒ–æ–¹æ¡ˆæé«˜äº†è¿›ç¨‹ç¨³å®šæ€§ï¼Œä¸€å®šç¨‹åº¦æé«˜äº†èµ„æºåˆ©ç”¨ç‡ã€‚ä½†ä»ç„¶æœ‰å¾ˆå¤§ç¨‹åº¦çš„èµ„æºæµªè´¹(è™šæ‹ŸåŒ–æˆæœ¬) å®¹å™¨åŒ–è§£å†³æ–¹æ¡ˆ:åœ¨æ“ä½œç³»ç»Ÿå±‚é¢å®ç°èµ„æºéš”ç¦» OpenVZ LXC ProcessÂ Container(cgroups) å‡è¡¡äº†èµ„æºåˆ©ç”¨ç‡å’Œç¨³å®šæ€§ã€‚ ç¨³å®šæ€§æ¯”è™šæ‹ŸåŒ–å·®ï¼Œä½†èµ„æºåˆ©ç”¨ç‡æ¯”è™šæ‹ŸåŒ–é«˜ï¼Œé€‚åˆåˆ†å¸ƒå¼ç¯å¢ƒã€‚ ","date":"2021-12-03","objectID":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/:2:0","tags":null,"title":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡","uri":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":"Docker ç½‘ç»œæ¶æ„å’ŒåŸç† ","date":"2021-12-03","objectID":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/:3:0","tags":null,"title":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡","uri":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":"ç½‘ç»œåŸºç¡€çŸ¥è¯† Lan/VLan/VXLan: LANÂ (Local Area Network)æœ¬åœ°å±€åŸŸç½‘ VLAN(Virtual Local Area Network)è™šæ‹Ÿæœ¬åœ°å±€åŸŸç½‘ VXLAN(Virtual eXtensible Local Area Network) åœ¨ä¸€å¥—ç‰©ç†ç½‘ç»œè®¾å¤‡ä¸Šè™šæ‹Ÿå‡ºå¤šä¸ªäºŒå±‚ç½‘ç»œ VXLAN: VLAN IDæ•°é‡é™åˆ¶ äº¤æ¢æœºMACåœ°å€è¡¨é™åˆ¶ çµæ´»çš„è™šæœºéƒ¨ç½²å’Œéƒ¨ç½² å¤ç”¨ç½‘ç»œé“¾è·¯ æ¡¥æ¥: ä»ä¸€ä¸ªç½‘å¡è®¾å¤‡å‘å‡ºçš„ä»¥å¤ªå¸§ï¼ŒåŸå°ä¸åŠ¨åœ°åˆ°è¾¾å¦å¤–ä¸€ä¸ªç½‘å¡è®¾å¤‡ã€‚ å°†å¤šä¸ªå¹¿æ’­åŸŸç»„åˆæˆä¸€ä¸ªå¹¿æ’­åŸŸï¼Œåœ¨é“¾è·¯å±‚å…è®¸è®¾å¤‡äº’è”ã€‚ æ¡¥æ¥ä¸è·¯ç”±çš„åŒºåˆ«: åˆ†å‰²å¹¿æ’­åŸŸ æ¡¥æ¥æ— æ³•æ§åˆ¶å¹¿æ’­åœ¨ä¸åŒç‰©ç†æ¥å£ä¹‹é—´çš„ç©¿æ¢­ã€‚å¹¿æ’­å˜ˆæ‚ï¼Œå¯¹ä¸»æœºçš„å¹²æ‰°ç¨‹åº¦ä¸¥é‡ã€‚ è·¯ç”±å¯ä»¥å°†æŸäº›ä¸»æœºæ”¾åœ¨ä¸€ä¸ªå¹¿æ’­åŸŸï¼Œå°†å¦å¤–ä¸€äº›ä¸»æœºæ”¾åœ¨å¦å¤–çš„å¹¿æ’­åŸŸã€‚ æ§åˆ¶ç½‘ç»œæµé‡ ä¸åŒåè®®ç±»å‹çš„ç‰©ç†æ¥å£ï¼Œåªèƒ½ä½¿ç”¨è·¯ç”±ã€‚ äºŒå±‚å°è£…æ–¹å¼ä¸ä¸€æ ·ï¼Œæ¡¥æ¥æ— æ³•è§£ææ•°æ®ã€‚è·¯ç”±å™¨å¯ä»¥æ›¿æ¢äºŒå±‚æ•°æ®å¸§ ","date":"2021-12-03","objectID":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/:3:1","tags":null,"title":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡","uri":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":"docker è·¨ä¸»æœºäº’è®¿æ–¹æ¡ˆ Bridge Host Overlay Flannel ","date":"2021-12-03","objectID":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/:3:2","tags":null,"title":"Dockerå®¹å™¨å’Œç½‘ç»œæ¶æ„è®¾è®¡","uri":"/docker%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"},{"categories":null,"content":"Flaskä¸Vueçš„tokenè®¤è¯ åç«¯ä½¿ç”¨flaskè®¾è®¡åŸºäºtokenè®¤è¯æ–¹å¼çš„restfulæ¥å£ï¼Œå‰ç«¯ä½¿ç”¨vue.jså…¨å®¶æ¡¶ï¼Œåˆ©ç”¨axiosé€šè®¯ã€‚ æ„Ÿè°¢ä¸¤ç¯‡æ–‡ç« çš„ä½œè€…ï¼š http://www.cnblogs.com/vovlie/p/4182814.html https://segmentfault.com/a/1190000008383094?_ea=1639495 æºç é“¾æ¥ï¼šhttps://github.com/xingyys/flaskvue åç«¯Flask Flaské‡‡ç”¨tokenè®¤è¯æ–¹å¼ï¼Œä¸»è¦æ€è·¯æ˜¯é€šè¿‡/api/loginç™»å½•è·å–tokenï¼Œç„¶åä½¿ç”¨tokenè°ƒç”¨å„ä¸ªæ¥å£ã€‚ æ‰€ç”¨åˆ°æ¡†æ¶çš„åº“ï¼š flask flask-corsï¼šflaskè·¨åŸŸ flask-sqlachemy: flaskæ•°æ®åº“orm flask-httpauthï¼šflaskçš„authè®¤è¯ passlib: pythonå¯†ç è§£æåº“ itsdangerous ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:0:0","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"åç«¯ç»“æ„å›¾ flask/ â”œâ”€â”€ app # ä¸»ç›®å½• â”‚Â â”œâ”€â”€ __init__.py â”‚Â â”œâ”€â”€ __init__.pyc â”‚Â â”œâ”€â”€ models.py # æ•°æ®åº“ â”‚Â â”œâ”€â”€ models.pyc â”‚Â â”œâ”€â”€ views.py # è§†å›¾ â”‚Â â””â”€â”€ views.pyc â”œâ”€â”€ config.py # é…ç½®ä¿¡æ¯ â”œâ”€â”€ config.pyc â”œâ”€â”€ db_create.py # åˆ›å»ºæ•°æ®åº“ â”œâ”€â”€ db_migrate.py # æ›´æ–°æ•°æ®åº“ â”œâ”€â”€ db_repository â”‚Â â”œâ”€â”€ __init__.py â”‚Â â”œâ”€â”€ __init__.pyc â”‚Â â”œâ”€â”€ manage.py â”‚Â â”œâ”€â”€ migrate.cfg â”‚Â â”œâ”€â”€ README â”‚Â â””â”€â”€ versions â”‚Â â”œâ”€â”€ 008_migration.py â”‚Â â”œâ”€â”€ 008_migration.pyc â”‚Â â”œâ”€â”€ 009_migration.py â”‚Â â”œâ”€â”€ 009_migration.pyc â”‚Â â”œâ”€â”€ __init__.py â”‚Â â””â”€â”€ __init__.pyc â”œâ”€â”€ index.html â””â”€â”€ run.py # appçš„è¿è¡Œæ–‡ä»¶ ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:1:0","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"å…·ä½“å®ç° ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:2:0","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"ç³»ç»Ÿåˆå§‹åŒ–app/__init__.py # -*- coding:utf-8 -*- from flask import Flask from flask_sqlalchemy import SQLAlchemy from flask_httpauth import HTTPBasicAuth from flask_cors import CORS app = Flask(__name__) # flaskçš„è·¨åŸŸè§£å†³ CORS(app) app.config.from_object('config') db = SQLAlchemy(app) auth = HTTPBasicAuth() from . import models, views ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:2:1","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"é…ç½®æ–‡ä»¶config.py import os basedir = os.path.abspath(os.path.dirname(__file__)) SQLALCHEMY_DATABASE_URI = \"mysql://root:123456@127.0.0.1/rest\" SQLALCHEMY_MIGRATE_REPO = os.path.join(basedir, 'db_repository') SQLALCHEMY_TRACK_MODIFICATIONS = True BASEDIR = basedir # å®‰å…¨é…ç½® CSRF_ENABLED = True SECRET_KEY = 'jklklsadhfjkhwbii9/sdf\\sdf' ç¯å¢ƒä¸­ä½¿ç”¨mysqlæ•°æ®åº“ï¼Œç‰ˆæœ¬ä¸ºmariadb 10.1.22ã€‚åˆ›å»ºrestè¡¨ $ mysql -uroot -p xxxxxx $ create database rest default charset utf8; ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:2:2","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"åˆ›å»ºæ•°æ®åº“è¡¨app/models.py # -*- coding:utf-8 -*- from app import db, app from passlib.apps import custom_app_context from itsdangerous import TimedJSONWebSignatureSerializer as Serializer, SignatureExpired, BadSignature class User(db.Model): __tablename__ = 'users' id = db.Column(db.Integer, primary_key=True) username = db.Column(db.String(32), index=True) password = db.Column(db.String(128)) # å¯†ç åŠ å¯† def hash_password(self, password): self.password = custom_app_context.encrypt(password) # å¯†ç è§£æ def verify_password(self, password): return custom_app_context.verify(password, self.password) # è·å–tokenï¼Œæœ‰æ•ˆæ—¶é—´10min def generate_auth_token(self, expiration = 600): s = Serializer(app.config['SECRET_KEY'], expires_in = expiration) return s.dumps({ 'id': self.id }) # è§£ætokenï¼Œç¡®è®¤ç™»å½•çš„ç”¨æˆ·èº«ä»½ @staticmethod def verify_auth_token(token): s = Serializer(app.config['SECRET_KEY']) try: data = s.loads(token) except SignatureExpired: return None # valid token, but expired except BadSignature: return None # invalid token user = User.query.get(data['id']) return user åˆ›å»ºæ•°æ®åº“usersè¡¨ï¼š $ python db_create.py $ python db_migrate.py ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:2:3","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"è§†å›¾app/views.py from app import app, db, auth from flask import render_template, json, jsonify, request, abort, g from app.models import * @app.route(\"/\") @auth.login_required def index(): return jsonify('Hello, %s' % g.user.username) @app.route('/api/users', methods = ['POST']) def new_user(): username = request.json.get('username') password = request.json.get('password') if username is None or password is None: abort(400) # missing arguments if User.query.filter_by(username = username).first() is not None: abort(400) # existing user user = User(username = username) user.hash_password(password) db.session.add(user) db.session.commit() return jsonify({ 'username': user.username }) @auth.verify_password def verify_password(username_or_token, password): if request.path == \"/api/login\": user = User.query.filter_by(username=username_or_token).first() if not user or not user.verify_password(password): return False else: user = User.verify_auth_token(username_or_token) if not user: return False g.user = user return True @app.route('/api/login') @auth.login_required def get_auth_token(): token = g.user.generate_auth_token() return jsonify(token) ç”¨æˆ·æ³¨å†Œåå¯†ç åŠ å¯†å­˜å‚¨ï¼Œç¡®è®¤ç”¨æˆ·èº«ä»½æ—¶å¯†ç è§£å¯†ã€‚éœ€è¦è®¤è¯çš„apiä¸Šæ·»åŠ @auth.login_requiredï¼Œå®ƒä¼šåœ¨è°ƒç”¨æ¥å£ä¹‹å‰è°ƒç”¨@auth.verify_passwordä¸‹çš„æ–¹æ³•(æ­¤æ–¹æ³•å”¯ä¸€)å¦‚verify_passwordã€‚æ ¹æ®è¯·æ±‚çš„è·¯å¾„é€‰æ‹©ä¸åŒçš„è®¤è¯æ–¹å¼ã€‚ ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:2:4","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"æµ‹è¯• ä½¿ç”¨curlå‘½ä»¤æµ‹è¯•æ¥å£ æ³¨å†Œç”¨æˆ·: $ curl -i -X POST -H \"Content-Type: application/json\" -d '{\"username\":\"admin\",\"password\":\"123456\"}' http://127.0.0.1:5000/api/register HTTP/1.0 200 OK Content-Type: application/json Access-Control-Allow-Origin: * Content-Length: 26 Server: Werkzeug/0.12.2 Python/2.7.13 Date: Wed, 20 Sep 2017 06:33:46 GMT { \"username\": \"admin\" } æŸ¥çœ‹æ•°æ®åº“ï¼š MariaDB [rest]\u003e select * from users\\G; *************************** 1. row *************************** id: 1 username: admin password: $6$rounds=656000$etV4F3xLL0dwflX8$mLFX9l5dumBnQFtajGmey346viGuQ4bxR7YhQdKtB/nQH9ij2e3HHMEBPj.ef/o//4o9P2Wd3Y7dxQfjwR2hY/ 1 row in set (0.00 sec) è·å–tokenï¼š curl -i -u admin:123456 -X GET -H \"Content-Type: application/json\" http://127.0.0.1:5000/api/login HTTP/1.0 200 OK Content-Type: application/json Access-Control-Allow-Origin: * Content-Length: 125 Server: Werkzeug/0.12.2 Python/2.7.13 Date: Wed, 20 Sep 2017 06:37:01 GMT \"eyJhbGciOiJIUzI1NiIsImV4cCI6MTUwNTg5MDAyMSwiaWF0IjoxNTA1ODg5NDIxfQ.eyJpZCI6MX0.nUIKq-ZhFOiLPwZyUmfgWPfHYNy8o6eoR6lmzdsY0oQ\" ä½¿ç”¨tokenè°ƒç”¨apiï¼š $ curl -i -u eyJhbGciOiJIUzI1NiIsImV4cCI6MTUwNTg5MDAyMSwiaWF0IjoxNTA1ODg5NDIxfQ.eyJpZCI6MX0.nUIKq-ZhFOiLPwZyUmfgWPfHYNy8o6eoR6lmzdsY0oQ:unused -X GET -H \"Content-Type: application/json\" http://127.0.0.1:5000/ HTTP/1.0 200 OK Content-Type: application/json Access-Control-Allow-Origin: * Content-Length: 15 Server: Werkzeug/0.12.2 Python/2.7.13 Date: Wed, 20 Sep 2017 06:38:22 GMT \"Hello, admin\" åŸºäºtokençš„Flask apiæˆåŠŸï¼ï¼ï¼ï¼ å‰ç«¯Vue.js å‰ç«¯ä½¿ç”¨vueçš„å…¨å®¶æ¡¶ï¼Œaxioså‰åç«¯é€šè®¯ï¼Œaxiosæ‹¦æˆªå™¨ï¼ŒlocalStorageä¿å­˜token æ‰€ä½¿ç”¨çš„æ¡†æ¶å’Œåº“ï¼š vue2.0 iview2.X axios vuex vue-router ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:2:5","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"å…·ä½“å®ç° ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:3:0","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"main.js // åˆå§‹åŒ–axios axios.defaults.baseURL = 'http://127.0.0.1:5000' axios.defaults.auth = { username: '', password: '', } // axios.interceptors.request.use((config) =\u003e { // console.log(config) // return config; // }, (error) =\u003e { // return Promise.reject(error) // }) // axiosæ‹¦æˆªå™¨ï¼Œ401çŠ¶æ€æ—¶è·³è½¬ç™»å½•é¡µå¹¶æ¸…é™¤token axios.interceptors.response.use((response) =\u003e { return response; }, (error) =\u003e { if (error.response) { switch (error.response.status) { case 401: store.commit('del_token') router.push('/login') } } return Promise.reject(error.response.data) }) // è·¯ç”±è·³è½¬ router.beforeEach((to, from, next) =\u003e { if (to.meta.required) { // æ£€æŸ¥localStorage if (localStorage.token) { store.commit('set_token', localStorage.token) // æ·»åŠ axioså¤´éƒ¨Authorized axios.defaults.auth = { username: store.state.token, password: store.state.token, } // iviewçš„é¡µé¢åŠ è½½æ¡ iView.LoadingBar.start(); next() } else { next({ path: '/login', }) } } else { iView.LoadingBar.start(); next() } }) router.afterEach((to, from, next) =\u003e { iView.LoadingBar.finish(); }) ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:3:1","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"è·¯ç”± export default new Router({ routes: [{ path: '/', name: 'index', component: Index, meta: { required: true, } }, { path: '/login', name: 'login', component: Login, }] }) è·¯ç”±æ·»åŠ metaå­—æ®µï¼Œä½œä¸ºéœ€è¦è®¤è¯è·¯ç”±çš„æ ‡å¿— ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:3:2","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"vuex export default new Vuex.Store({ state: { token: '' }, mutations: { set_token(state, token) { state.token = token localStorage.token = token }, del_token(state) { state.token = '' localStorage.removeItem('token') } } }) vuexä¸­ä¿å­˜tokenï¼ŒåŒæ—¶ä¿®æ”¹åˆ é™¤tokenå’ŒlocalStorage.token ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:3:3","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"ç™»å½•å’Œç™»å‡º ç™»å½•ï¼š handleSubmit(name, form) { this.$refs[name].validate((valid) =\u003e { if (valid) { // ç”¨æˆ·åå¯†ç ç®€å•éªŒè¯åæ·»åŠ åˆ°axiosçš„authä¸­ this.$axios.defaults.auth = { username: form.username, password: form.password, } this.$axios.get('/api/login').then(response =\u003e { this.$Message.success(\"æäº¤æˆåŠŸ\") let data = response.data // ä¿å­˜token this.$store.commit('set_token', data) this.$router.push('/') }).catch(error =\u003e { this.$Message.error(error.status) }) } else { this.$Message.error('è¡¨å•éªŒè¯å¤±è´¥!'); } }) } ç™»å‡ºï¼š logout() { this.$store.commit('del_token') this.$router.push('/login') } åˆ é™¤tokenå¹¶è·³è½¬åˆ°ç™»å½•é¡µ flaskå’Œvueçš„tokenè®¤è¯å°±å®Œæˆäº†ï¼ï¼ï¼ï¼ ","date":"2021-12-03","objectID":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/:3:4","tags":null,"title":"Flaskä¸Vueçš„tokenè®¤è¯","uri":"/flask%E4%B8%8Evue%E7%9A%84token%E8%AE%A4%E8%AF%81/"},{"categories":null,"content":"Go ç»“åˆ etcd å…³äº etcd çš„å®‰è£…å’Œä»‹ç»çœ‹Â è¿™é‡ŒÂ ã€‚å®˜æ–¹çš„å®ä¾‹å¯ä»¥çœ‹Â è¿™é‡Œ ä¸€ã€è¿æ¥ é¦–å…ˆæ˜¯å…³äº golang å¦‚ä½•è¿æ¥ etcd ï¼Œå…ˆæ˜¯ç®€å•çš„è¿æ¥ã€‚ package main import ( \"github.com/coreos/etcd/clientv3\" \"log\" \"time\" ) func connect() { cli, err := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) if err != nil { log.Fatal(\"connect etcd cluster: \" + err.Error()) } cli.Close() } è¿˜æœ‰å¸¦ https å’Œ å¼€å¯ç”¨æˆ·éªŒè¯çš„è¿æ¥ func connectTlsAuth() { tlsInfo := transport.TLSInfo{ CertFile: \"/tmp/cert.pem\", KeyFile: \"/tmp/key.pem\", TrustedCAFile: \"/tmp/ca.pem\", } tlsConfig, err := tlsInfo.ClientConfig() if err != nil { log.Fatal(\"parse tls config file: \" + err.Error()) } cli, err := clientv3.New(clientv3.Config{ Endpoints: []string{\"192.168.10.10:2379\"}, DialTimeout: time.Second * 3, TLS: tlsConfig, Username: \"root\", Password: \"root\", }) if err != nil { log.Fatal(\"connect etcd cluster: \" + err.Error()) } cli.Close() } äºŒã€KV æ“ä½œ ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:0:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"2.1 ç®€å•çš„ curd åœ¨è¿æ¥åŸºç¡€ä¸Šï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å¯¹keyåšæ“ä½œäº†ã€‚å¯¹keyåš curd func kv() { cli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) defer cli.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() // etcdctl put foo 1 _, err := cli.Put(ctx, \"foo\", \"1\") if err != nil { log.Fatal(\"put key:\" + err.Error()) } // etcdctl get foo --prefix // å¸¦å‚æ•°çš„è¯·æ±‚ resp, err := cli.Get(ctx, \"foo\", clientv3.WithPrefix()) if err != nil { log.Fatal(\"get key: \" + err.Error()) } for _, v := range resp.Kvs { log.Printf(\"get %s =\u003e %s\\n\", v.Key, string(v.Value)) } kvcli := clientv3.NewKV(cli) // etcdctl del foo _, err = kvcli.Delete(ctx, \"foo\") if err != nil { log.Fatal(\"delete key: \" + err.Error()) } } ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:1:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"2.2 äº‹åŠ¡ ä½¿ç”¨äº‹åŠ¡å¦‚ä¸‹ï¼š func txn() { cli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) defer cli.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() kvc := clientv3.NewKV(cli) _, err := kvc.Put(ctx, \"foo\", \"xyz\") if err != nil { log.Fatal(\"put key: \" + err.Error()) } _, err = kvc.Txn(ctx). // txn value comparisons are lexical If(clientv3.Compare(clientv3.Value(\"foo\"), \"\u003e\", \"abc\")). // the \"Then\" runs, since \"xyz\" \u003e \"abc\" Then(clientv3.OpPut(\"foo\", \"XYZ\")). // the \"Else\" does not run Else(clientv3.OpPut(\"foo\", \"ABC\")). Commit() if err != nil { log.Fatal(\"run txn: \" + err.Error()) } } ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:2:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"2.3 æ‰¹é‡æ“ä½œ æ‰¹é‡æŒ‡å®šæ“ä½œ func do() { cli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) defer cli.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() ops := []clientv3.Op{ clientv3.OpPut(\"key1\", \"123\"), clientv3.OpGet(\"key1\"), clientv3.OpPut(\"key2\", \"456\"), } for _, op := range ops { if _, err := cli.Do(ctx, op); err != nil { log.Fatal(err.Error()) } } } ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:3:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"2.3 watch ç›‘è§†key func watch() { cli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) defer cli.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() go func() { timer := time.NewTicker(time.Second) for { select { case \u003c-timer.C: // change foo value every second _, _ = cli.Put(context.TODO(), \"foo\", time.Now().String()) _, _ = cli.Put(context.TODO(), \"foo1\", time.Now().String()) _, _ = cli.Put(context.TODO(), \"foo2\", time.Now().String()) _, _ = cli.Put(context.TODO(), \"foo3\", time.Now().String()) _, _ = cli.Put(context.TODO(), \"foo4\", time.Now().String()) } } }() //rch := cli.Watch(ctx, \"foo\") rch := cli.Watch(ctx, \"foo\", clientv3.WithPrefix()) //rch := cli.Watch(ctx, \"foo\", clientv3.WithRange(\"foo4\")) for wresp := range rch { for _, ev := range wresp.Events { fmt.Printf(\"%s %q: %q\\n\", ev.Type, ev.Kv.Key, ev.Kv.Value) } } } func watchWithProcessNotify() { cli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) defer cli.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() rch := cli.Watch(ctx, \"foo\", clientv3.WithProgressNotify()) wresp := \u003c- rch fmt.Printf(\"wresp.Header.Revision: %d\\n\", wresp.Header.Revision) fmt.Println(\"wresp.IsProgressNotify:\", wresp.IsProgressNotify()) } ä¸‰ã€lease ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:4:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"2.1 åˆ›å»º lease func grant() { cli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) defer cli.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() // etcdctl lease grant 5 // grant lease 5s resp, err := cli.Grant(ctx, 5) if err != nil { log.Fatal(\"grant lease: \" + err.Error()) } // after 5 seconds, the key 'foo' will be removed _, err = cli.Put(ctx, \"foo\", \"bar\", clientv3.WithLease(resp.ID)) if err != nil { log.Fatal(\"put key with lease: \" + err.Error()) } } ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:5:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"2.2 åˆ é™¤ lease func revoke() { cli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) defer cli.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() resp, err := cli.Grant(ctx, 5) if err != nil { log.Fatal(\"grant lease: \" + err.Error()) } _, err = cli.Put(ctx, \"foo\", \"bar\", clientv3.WithLease(resp.ID)) if err != nil { log.Fatal(err) } // revoking lease expires the key attached to its lease ID _, err = cli.Revoke(ctx, resp.ID) if err != nil { log.Fatal(err) } } ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:6:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"2.3 ç»­ç§Ÿ func keepAlive() { cli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) defer cli.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() resp, err := cli.Grant(ctx, 5) if err != nil { log.Fatal(\"grant lease: \" + err.Error()) } _, err = cli.Put(ctx, \"foo\", \"bar\", clientv3.WithLease(resp.ID)) if err != nil { log.Fatal(err) } ch, err := cli.KeepAlive(ctx, resp.ID) if err != nil { log.Fatal(err.Error()) } ka := \u003c- ch fmt.Println(\"ttl:\", ka.TTL) // å®˜æ–¹æç¤ºï¼šå¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨ KeepAlive æ¥ä»£æ›¿ KeepAliveOnce kaa, err := cli.KeepAliveOnce(ctx, resp.ID) if err != nil { log.Fatal(err) } fmt.Println(\"ttl:\", kaa.TTL) } ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:7:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"2.4 æŸ¥è¯¢ lease func leases() { cli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) defer cli.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() _, err := cli.Grant(ctx, 5) if err != nil { log.Fatal(\"grant lease: \" + err.Error()) } _, err = cli.Grant(ctx, 10) if err != nil { log.Fatal(\"grant lease: \" + err.Error()) } _, err = cli.Grant(ctx, 15) if err != nil { log.Fatal(\"grant lease: \" + err.Error()) } resp, err := cli.Lease.Leases(ctx) if err != nil { log.Fatal(err) } for _, lease := range resp.Leases { ttl, err := cli.Lease.TimeToLive(ctx, lease.ID, clientv3.WithAttachedKeys()) if err == nil { fmt.Printf(\"lease: %d, ttl: %d, grantedTTL: %d\\n\", ttl.ID, ttl.TTL, ttl.GrantedTTL) } } } å››ã€è®¿é—®æ§åˆ¶ func auth() { cli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) defer cli.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() auth := clientv3.NewAuth(cli) // create role if _, err := auth.RoleAdd(ctx, \"root\"); err != nil { log.Fatal(err) } // create role if _, err := auth.UserAdd(ctx, \"root\", \"123\"); err != nil { log.Fatal(err) } // grant role root to user root if _, err := auth.UserGrantRole(ctx, \"root\", \"root\"); err != nil { log.Fatal(err) } if _, err := auth.UserChangePassword(ctx, \"root\", \"123\"); err != nil { log.Fatal(err) } if _, err := auth.RoleAdd(ctx, \"guest\"); err != nil { log.Fatal(err) } if _, err := auth.UserAdd(ctx, \"xingyys\", \"\"); err != nil { log.Fatal(err) } if _, err := auth.UserGrantRole(ctx, \"xingyys\", \"guest\"); err != nil { log.Fatal(err) } // ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œéœ€è¦åœ¨grantåæ›´æ–°å¯†ç  // å¦åˆ™å¯†ç æ— æ•ˆ if _, err := auth.UserChangePassword(ctx, \"xingyys\", \"123\"); err != nil { log.Fatal(err) } // æ·»åŠ æŒ‡å®škeyçš„è®¿é—®æƒé™ // read, write, readwrite if _, err := auth.RoleGrantPermission(ctx, \"guest\", \"foo\", \"zoo\", clientv3.PermissionType(clientv3.PermReadWrite)); err != nil { log.Fatal(err) } if _, err := auth.AuthEnable(ctx); err != nil { log.Fatal(err) } authCli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, Username: \"xingyys\", Password: \"123\", }) defer authCli.Close() _, _ = authCli.Put(ctx, \"foo\", \"1\") resp, _ := authCli.Get(ctx, \"foo\") for _, v := range resp.Kvs { log.Printf(\"%s =\u003e %q\\n\", v.Key, v.Value) } _, err := authCli.Txn(ctx). If(clientv3.Compare(clientv3.Value(\"zoo1\"), \"\u003e\", \"abc\")). Then(clientv3.OpPut(\"zoo1\", \"XYZ\")). Else(clientv3.OpPut(\"zoo1\", \"ABC\")). Commit() log.Println(err) } äº”ã€é›†ç¾¤ func member() { cli, _ := clientv3.New(clientv3.Config{ // etcd é›†ç¾¤çš„åœ°å€é›†åˆ Endpoints: []string{\"192.168.10.10:2379\"}, // è¯·æ±‚è¶…æ—¶æ—¶é—´ DialTimeout: time.Second * 3, }) defer cli.Close() ctx, cancel := context.WithCancel(context.Background()) defer cancel() cluster := clientv3.NewCluster(cli) resp, err := cluster.MemberList(ctx) if err != nil { log.Fatal(err) } for _, member := range resp.Members { fmt.Printf(\"ID: %d | Name: %s | ClientURL: %q | PeerURL: %q\\n\", member.ID, member.Name, member.ClientURLs, member.PeerURLs) } //_, _ = cluster.MemberAdd(ctx, []string{\"192.168.10.10:2370\", \"192.168.10.11:2379\"}) //_, _ = cluster.MemberRemove(ctx, // id) //_, _ = cluster.MemberUpdate(ctx, // id, // peer) } å…­ã€å¹¶å‘ ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:8:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"6.1 é” func lock() { cli, err := clientv3.New(clientv3.Config{ Endpoints: []string{\"192.168.10.10:2379\"}, }) if err != nil { log.Fatal(err) } defer cli.Close() // æ³¨å†Œsession s1, err := concurrency.NewSession(cli) if err != nil { log.Fatal(err) } defer s1.Close() m1 := concurrency.NewMutex(s1, \"/lock\") s2, err := concurrency.NewSession(cli) if err != nil { log.Fatal(err) } defer s2.Close() m2 := concurrency.NewMutex(s2, \"/lock\") // acquired lock for s1 if err := m1.Lock(context.TODO()); err != nil { log.Fatal(err) } fmt.Println(\"acquired lock for s1\") m2Locked := make(chan struct{}) go func() { defer close(m2Locked) // wait util s1 is locks /lock if err := m2.Lock(context.TODO()); err != nil { log.Fatal(err) } }() if err := m1.Unlock(context.TODO()); err != nil { log.Fatal(err) } fmt.Println(\"release lock for s1\") \u003c-m2Locked fmt.Println(\"acquired lock for s2\") } func tryLock() { cli, err := clientv3.New(clientv3.Config{ Endpoints: []string{\"192.168.10.10:2379\"}, }) if err != nil { log.Fatal(err) } defer cli.Close() // æ³¨å†Œsession s1, err := concurrency.NewSession(cli) if err != nil { log.Fatal(err) } defer s1.Close() m1 := concurrency.NewMutex(s1, \"/lock\") s2, err := concurrency.NewSession(cli) if err != nil { log.Fatal(err) } defer s2.Close() m2 := concurrency.NewMutex(s2, \"/lock\") // acquire lock for s1 if err = m1.Lock(context.TODO()); err != nil { log.Fatal(err) } fmt.Println(\"acquired lock for s1\") if err = m2.TryLock(context.TODO()); err == nil { log.Fatal(\"should not acquire lock\") } if err == concurrency.ErrLocked { fmt.Println(\"cannot acquire lock for s2, as already locked in another session\") } if err = m1.Unlock(context.TODO()); err != nil { log.Fatal(err) } fmt.Println(\"released lock for s1\") if err = m2.TryLock(context.TODO()); err != nil { log.Fatal(err) } fmt.Println(\"acquired lock for s2\") } ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:9:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"6.2 é¢†å¯¼é€‰ä¸¾ func election() { cli, err := clientv3.New(clientv3.Config{Endpoints: []string{\"192.168.10.10:2379\"}}) if err != nil { log.Fatal(err) } defer cli.Close() // create two separate sessions for election competition s1, err := concurrency.NewSession(cli) if err != nil { log.Fatal(err) } defer s1.Close() e1 := concurrency.NewElection(s1, \"/my-election/\") s2, err := concurrency.NewSession(cli) if err != nil { log.Fatal(err) } defer s2.Close() e2 := concurrency.NewElection(s2, \"/my-election/\") // create competing candidates, with e1 initially losing to e2 var wg sync.WaitGroup wg.Add(2) electc := make(chan *concurrency.Election, 2) go func() { defer wg.Done() // delay candidacy so e2 wins first time.Sleep(3 * time.Second) if err := e1.Campaign(context.Background(), \"e1\"); err != nil { log.Fatal(err) } electc \u003c- e1 }() go func() { defer wg.Done() if err := e2.Campaign(context.Background(), \"e2\"); err != nil { log.Fatal(err) } electc \u003c- e2 }() cctx, cancel := context.WithCancel(context.TODO()) defer cancel() e := \u003c-electc fmt.Println(\"completed first election with\", string((\u003c-e.Observe(cctx)).Kvs[0].Value)) // resign so next candidate can be elected if err := e.Resign(context.TODO()); err != nil { log.Fatal(err) } e = \u003c-electc fmt.Println(\"completed second election with\", string((\u003c-e.Observe(cctx)).Kvs[0].Value)) wg.Wait() } ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:10:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"6.3 è½¯ä»¶äº‹åŠ¡å†…å­˜ func stm() { cli, err := clientv3.New(clientv3.Config{Endpoints: []string{\"192.168.10.10:2379\"}}) if err != nil { log.Fatal(err) } defer cli.Close() // set up \"accounts\" totalAccounts := 5 for i := 0; i \u003c totalAccounts; i++ { k := fmt.Sprintf(\"accts/%d\", i) if _, err = cli.Put(context.TODO(), k, \"100\"); err != nil { log.Fatal(err) } } exchange := func(stm concurrency.STM) error { from, to := rand.Intn(totalAccounts), rand.Intn(totalAccounts) if from == to { // nothing to do return nil } // read values fromK, toK := fmt.Sprintf(\"accts/%d\", from), fmt.Sprintf(\"accts/%d\", to) fromV, toV := stm.Get(fromK), stm.Get(toK) fromInt, toInt := 0, 0 fmt.Sscanf(fromV, \"%d\", \u0026fromInt) fmt.Sscanf(toV, \"%d\", \u0026toInt) // transfer amount xfer := fromInt / 2 fromInt, toInt = fromInt-xfer, toInt+xfer // write back stm.Put(fromK, fmt.Sprintf(\"%d\", fromInt)) stm.Put(toK, fmt.Sprintf(\"%d\", toInt)) return nil } // concurrently exchange values between accounts var wg sync.WaitGroup wg.Add(10) for i := 0; i \u003c 10; i++ { go func() { defer wg.Done() if _, serr := concurrency.NewSTM(cli, exchange); serr != nil { log.Fatal(serr) } }() } wg.Wait() // confirm account sum matches sum from beginning. sum := 0 accts, err := cli.Get(context.TODO(), \"accts/\", clientv3.WithPrefix()) if err != nil { log.Fatal(err) } for _, kv := range accts.Kvs { v := 0 fmt.Sscanf(string(kv.Value), \"%d\", \u0026v) sum += v } fmt.Println(\"account sum is\", sum) } ","date":"2021-12-03","objectID":"/go%E7%BB%93%E5%90%88etcd/:11:0","tags":null,"title":"Go ç»“åˆ etcd","uri":"/go%E7%BB%93%E5%90%88etcd/"},{"categories":null,"content":"Golangä½¿ç”¨jsonæ ¼å¼å®ç°å¢åˆ æŸ¥æ”¹ éœ€æ±‚å’Œæ€è·¯ åœ¨ä¸€èˆ¬çš„å°é¡¹ç›®æˆ–è€…ä¸€ä¸ªå°è½¯ä»¶,ä¾‹å¦‚å®¢æˆ·ç«¯ä¹‹ç±»çš„å°ç¨‹åºä¸­,å¯èƒ½ä¼šéœ€è¦æ•°æ®çš„æŒä¹…åŒ–.ä½†æ˜¯ä½¿ç”¨ä¸€èˆ¬çš„æ•°æ®åº“(Mysql)ä¹‹ç±»çš„ä¸åˆé€‚.ä½¿ç”¨sqlite3è¿™ç§åµŒå…¥å¼çš„æ˜¯ä¸ªè¾ƒå¥½çš„æ–¹æ³•,ä½†æ˜¯Goè¯­è¨€ä¸­sqlite3çš„åº“æ˜¯Cè¯­è¨€çš„,Cgoä¸æ”¯æŒè·¨å¹³å°ç¼–è¯‘.æ­£æ˜¯ç”±äºè¿™ç§éœ€æ±‚,æ‰æƒ³åˆ°ä½¿ç”¨jsonæ ¼å¼å°†æ•°æ®ç›´æ¥ä¿å­˜åœ¨æ–‡ä»¶ä¸­. å…·ä½“çš„æ€è·¯æ˜¯æ€ä¹ˆæ ·å‘¢? åœ¨Goè¯­è¨€ä¸­å¦‚æœè¦å°†æ•°æ®è½¬åŒ–æˆjsonæ ¼å¼çš„è¯,æœ‰ä¸¤ç§æ ¼å¼ struct å’Œ map. å¦‚æœåŒæ—¶éœ€è¦å¢åˆ æŸ¥æ”¹åŠŸèƒ½çš„è¯,å°†mapä½œä¸ºä¸­é—´æ ¼å¼æ˜¯æ¯”è¾ƒåˆé€‚çš„.æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥å®ç°å®ƒ. æŸ¥è¯¢æ“ä½œ è¿™ç§æ“ä½œçš„å®ç°æ¯”è¾ƒç®€å•,ç›´æ¥å°†æ–‡ä»¶ä¸­çš„æ•°æ®è¯»å–å‡ºæ¥,ä½¿ç”¨jsonåº“ååºåˆ—åŒ–å°±å¯ä»¥äº†. ä»£ç å¦‚ä¸‹ : type Product struct { Name string `json:\"name\"` Num int `json:\"num\"` } func findAll() { ps := make([]Product, 0) data, err := ioutil.ReadFile(\"./index.json\") if err != nil { log.Fatal(err) } // è¿™é‡Œå‚æ•°è¦æŒ‡å®šä¸ºå˜é‡çš„åœ°å€ err = json.Unmarshal(data, \u0026ps) if err != nil { log.Fatal(err) } fmt.Println(ps) } æ·»åŠ æ“ä½œ æ·»åŠ çš„å®ç°å®åœ¨æŸ¥è¯¢çš„åŸºç¡€ä¸Šçš„,æˆ‘ä»¬éœ€è¦å…ˆæŸ¥è¯¢æ–‡ä»¶ä¸­çš„æ•°æ®åº“,å¹¶è½¬åŒ–ä¸ºmapæ ¼å¼,å†å°†structä¹Ÿè½¬åŒ–ä¸ºmapæ ¼å¼(è¿™é‡Œè¦ä½¿ç”¨åå°„),åˆå¹¶map,jsonåºåˆ—åŒ–,æœ€åä¿å­˜åœ¨æ–‡ä»¶ä¸­.ä»£ç å¦‚ä¸‹: func create() { fields := make([]map[string]interface{}, 0) p1 := \u0026Product{ Name: \"Blog\", Num: 2, } _, _ = json.Marshal(p1) // è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®,ä¿å­˜ä¸ºmapæ ¼å¼ data, _ := ioutil.ReadFile(\"./index.json\") err := json.Unmarshal(data, \u0026fields) if err != nil { log.Fatal(err) } // ä½¿ç”¨åå°„å°†structè½¬åŒ–ä¸ºmap tp := reflect.TypeOf(p1).Elem() vp := reflect.ValueOf(p1).Elem() field := make(map[string]interface{}, 0) for i := 0; i \u003c tp.NumField(); i++ { field1 := tp.Field(i) field2 := vp.Field(i) key := field1.Tag.Get(\"json\") field[key] = field2.Interface() } // åˆå¹¶map fields = append(fields, field) // å†™å…¥æ–‡ä»¶ out, _ := json.Marshal(fields) _ = ioutil.WriteFile(\"./index.json\", out, 0755) } æ¡ä»¶æŸ¥è¯¢ æ€è·¯: å°†structè½¬åŒ–ä¸ºmap,æ ¹æ®è¾“å…¥çš„æ¡ä»¶æŸ¥è¯¢.æŸ¥è¯¢çš„ç»“æœè½¬åŒ–ä¸ºstruct.ä»£ç å¦‚ä¸‹: func FindOne() { product := \u0026Product{} p1 := \u0026Product{ Name: \"John\", Num: 23, } // ä½¿ç”¨åå°„å°†structè½¬åŒ–ä¸ºmap tp := reflect.TypeOf(p1).Elem() vp := reflect.ValueOf(p1).Elem() field := make(map[string]interface{}, 0) for i := 0; i \u003c tp.NumField(); i++ { field1 := tp.Field(i) field2 := vp.Field(i) key := field1.Tag.Get(\"json\") switch field2.Kind() { case reflect.Int: field[key] = float64(field2.Interface().(int)) case reflect.Int8: field[key] = float64(field2.Interface().(int8)) case reflect.Int16: field[key] = float64(field2.Interface().(int16)) case reflect.Int32: field[key] = float64(field2.Interface().(int32)) case reflect.Int64: field[key] = float64(field2.Interface().(int64)) case reflect.Uint: field[key] = float64(field2.Interface().(uint)) case reflect.Uint8: field[key] = float64(field2.Interface().(uint8)) case reflect.Uint16: field[key] = float64(field2.Interface().(uint16)) case reflect.Uint32: field[key] = float64(field2.Interface().(uint32)) case reflect.Uint64: field[key] = float64(field2.Interface().(uint64)) case reflect.Float32: field[key] = float64(field2.Interface().(float32)) case reflect.Float64: field[key] = field2.Interface() default: field[key] = field2.Interface() } } _, _ = json.Marshal(p1) // è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®,ä¿å­˜ä¸ºmapæ ¼å¼ // æ•°æ®è½¬åŒ–ä¸ºmapæ—¶,æ•°å€¼ç±»å‹çš„ç»Ÿä¸€å˜æˆfloat64 data, _ := ioutil.ReadFile(\"./index.json\") fields := make([]map[string]interface{}, 0) err := json.Unmarshal(data, \u0026fields) if err != nil { log.Fatal(err) } // æŸ¥è¯¢çš„æ¡ä»¶ columns := []string{\"name\", \"num\"} length := len(columns) for _, item := range fields { for i := 0; i \u003c length; i++ { // è¿™é‡Œçš„æ¯”è¾ƒéœ€è¦æ”¹è¿› if item[columns[i]] != field[columns[i]] { break } if i == length-1 { field = item goto OVER } } } OVER: fmt.Println(field) out, _ := json.Marshal(field) _ = json.Unmarshal(out, \u0026product) fmt.Println(product) } ä¿®æ”¹æ“ä½œ ä¿®æ”¹æ“ä½œåœ¨æŸ¥è¯¢æ“ä½œçš„åŸºç¡€ä¸Šå®ç°, ä¿®æ”¹æ“ä½œéœ€è¦æœ‰ä¸€ä¸ªidå€¼,èƒ½ç¡®å®šå…ƒç´ çš„å”¯ä¸€æ€§.ä»£ç å¦‚ä¸‹: func Update() { p1 := \u0026Product{ Id: \"2bbec87025968879c3c9682abe3bf730\", Name: \"John_e\", Num: 100, } // ä½¿ç”¨åå°„å°†structè½¬åŒ–ä¸ºmap tp := reflect.TypeOf(p1).Elem() vp := reflect.ValueOf(p1).Elem() field := make(map[string]interface{}, 0) for i := 0; i \u003c tp.NumField(); i++ { field1 := tp.Field(i) field2 := vp.Field(i) key := field1.Tag.Get(\"json\") switch field2.Kind() { case reflect.Int: field[key] = float64(field2.Interface().(int)) case reflect.Int8: field[key] = float64(field2.Interface().(int8)) case reflect.Int16: field[key] = float64(field2.Interface().(int16)) case reflect.Int32: field[key] = float64(field2.Interface().(int32)) case reflect.Int64: field[key] = float64(field2.Interface().(int64)) case reflect.Uint: field","date":"2021-12-03","objectID":"/golang%E4%BD%BF%E7%94%A8json%E6%A0%BC%E5%BC%8F%E5%AE%9E%E7%8E%B0%E5%A2%9E%E5%88%A0%E6%9F%A5%E6%94%B9/:0:0","tags":null,"title":"Golangä½¿ç”¨jsonæ ¼å¼å®ç°å¢åˆ æŸ¥æ”¹","uri":"/golang%E4%BD%BF%E7%94%A8json%E6%A0%BC%E5%BC%8F%E5%AE%9E%E7%8E%B0%E5%A2%9E%E5%88%A0%E6%9F%A5%E6%94%B9/"},{"categories":null,"content":"golangæ‰“åŒ…å’Œè§£åŒ… æ‰“åŒ… // æ‰“åŒ… func Compress(destPath, srcDir string) error { // å‹ç¼©æ–‡ä»¶è·¯å¾„ fw, err := os.Create(destPath) if err != nil { return err } defer fw.Close() // gzip writer gw := gzip.NewWriter(fw) defer gw.Close() // tar writer tw := tar.NewWriter(gw) defer tw.Close() // è¯»å–è¦å‹ç¼©çš„ç›®å½• dir, err := os.Open(srcDir) if err != nil { return err } defer dir.Close() // è¯»å–ç›®å½•å†…å®¹ files, err := dir.Readdir(0) if err != nil { return err } for _, file := range files { if file.IsDir() { continue } // è·¯å¾„è¡¥å…¨ filePath := path.Join(dir.Name(), file.Name()) fread, err := os.Open(filePath) if err != nil { continue } // è·å–æ–‡ä»¶å¤´éƒ¨ä¿¡æ¯ h := \u0026tar.Header{} h.Name = file.Name() h.Size = file.Size() h.Mode = int64(file.Mode()) h.ModTime = file.ModTime() err = tw.WriteHeader(h) if err == nil { // å¼€å§‹å‹ç¼©ï¼Œè¿™é‡Œç­‰äºå¿½ç•¥é”™è¯¯ io.Copy(tw, fread) } // è®°å¾—å…³é—­æ–‡ä»¶ fread.Close() } return nil } è§£åŒ… // è§£å‹ func DeCompress(srcPath, destDir string) error { // è§£å‹åŒ…çš„è·¯å¾„ fread, err := os.Open(srcPath) if err != nil { return err } defer fread.Close() // æ£€æµ‹ç›®æ ‡è·¯å¾„æ˜¯å¦å­˜åœ¨ _, err = os.Stat(destDir) if err != nil { return err } // gzip reader gr, err := gzip.NewReader(fread) if err != nil { return err } defer gr.Close() // tr reader tr := tar.NewReader(gr) for { // è·å–ä¸‹ä¸€ä¸ªæ–‡ä»¶ h, err := tr.Next() // è¯»å–å®Œæ¯• if err == io.EOF { break } if err != nil { continue } fw, err := os.OpenFile(path.Join(destDir, h.Name), os.O_CREATE|os.O_WRONLY, 0644) if err == nil { io.Copy(fw, tr) fw.Close() } } return nil } ","date":"2021-12-03","objectID":"/golang%E6%89%93%E5%8C%85%E5%92%8C%E8%A7%A3%E5%8C%85/:0:0","tags":null,"title":"golangæ‰“åŒ…å’Œè§£åŒ…","uri":"/golang%E6%89%93%E5%8C%85%E5%92%8C%E8%A7%A3%E5%8C%85/"},{"categories":null,"content":"Golangç›‘æ§è¿›ç¨‹æµé‡ é“¾æ¥ libpcap ","date":"2021-12-03","objectID":"/golang%E7%9B%91%E6%8E%A7%E8%BF%9B%E7%A8%8B%E6%B5%81%E9%87%8F/:0:0","tags":null,"title":"Golangç›‘æ§è¿›ç¨‹æµé‡","uri":"/golang%E7%9B%91%E6%8E%A7%E8%BF%9B%E7%A8%8B%E6%B5%81%E9%87%8F/"},{"categories":null,"content":"Golangè·¨å¹³å°ç¼–è¯‘ golang cgo åˆ° Windows çš„äº¤å‰ç¼–è¯‘ æœ¬ç¯‡è®°å½•åœ¨ MaxOS ä¸‹ cgo äº¤å‰ç¼–è¯‘çš„è§£å†³æ–¹æ¡ˆã€‚å› ä¸ºåœ¨é¡¹ç›®ä¸­ä½¿ç”¨ go-sqlite3 ï¼Œç¼–è¯‘ go-sqlite3 ä¸­éœ€è¦ä½¿ç”¨åˆ° cgoã€‚åœ¨ MacOS ä¸‹ç¼–è¯‘ Go åŸç”Ÿ Linux å’Œ Windows çš„ç¨‹åºä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š # äº¤å‰ç¼–è¯‘åˆ° linux GOOS=linux GOARCH=amd64 go build main.go # äº¤å‰ç¼–è¯‘åˆ° windows GOOS=windows GOARCH=amd64 go build -o main.exe main.go å¦‚æœä½¿ç”¨ cgo çš„è¯ï¼Œè¿˜éœ€è¦æ·»åŠ  CGO_ENABLEDÂ å‚æ•°ï¼š CGO_ENABLED=1 GOOS=windows GOARCH=amd64 go build -o main.exe main.go ä½†æ˜¯è¿™ç§ç¼–è¯‘ go-sqlite3 çš„ä»£ç ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š # runtime/cgo gcc_libinit_windows.c:7:10: fatal error: 'windows.h' file not found å› ä¸º Windows ä¸­ä½¿ç”¨ MinGWï¼ŒMacOS ä¸‹å¦‚æœäº¤å‰ç¼–è¯‘éœ€è¦å®‰è£… C/C++ äº¤å‰ç¼–è¯‘å·¥å…·ï¼š brew install FiloSottile/musl-cross/musl-cross brew install mingw-w64 å®‰è£…å®Œå·¥å…·ä¹‹åå°±å¯ä»¥ä½¿ç”¨å‘½ä»¤ï¼š CGO_ENABLED=1 CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ GOOS=windows GOARCH=amd64 go build -a -v -o store.exe store/sqlite.exe æ³¨æ„å‚æ•°ï¼š CXX=x86_64-w64-mingw32-g++Â ï¼Œå¦‚æœç¼ºå°‘è¿™ä¸ªå‚æ•°æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°é”™è¯¯ï¼š # runtime/cgo gcc: error: unrecognized command line option â€˜-mthreadsâ€™; did you mean â€˜-pthreadâ€™? ","date":"2021-12-03","objectID":"/golang%E8%B7%A8%E5%B9%B3%E5%8F%B0%E7%BC%96%E8%AF%91/:0:0","tags":null,"title":"Golangè·¨å¹³å°ç¼–è¯‘","uri":"/golang%E8%B7%A8%E5%B9%B3%E5%8F%B0%E7%BC%96%E8%AF%91/"},{"categories":null,"content":"GPRC å®æˆ˜ æ³¨æ„ï¼šå½“é¡¹ç›®ä¸­ä½¿ç”¨äº†etcdçš„ç»„ä»¶ï¼Œæ³¨æ„ç‰ˆæœ¬æ§åˆ¶ã€‚etcdä½ç‰ˆæœ¬çš„éœ€è¦grpc v1.2.6 GRPC ç®€ä»‹ grpc æ˜¯ç”± google å¼€å‘çš„ä¸€æ¬¾å¼€æºï¼Œé«˜æ€§èƒ½ rpcï¼ˆè¿œç¨‹è¿›ç¨‹è°ƒç”¨åè®®ï¼‰ä½¿ç”¨ Protocol Buffers ä½œä¸ºæ•°æ®äº¤æ¢æ ¼å¼ã€‚ GRPC å®‰è£… golang ä½¿ç”¨ grpc è¦å®‰è£… grpc-go, protoc å’Œ å¯¹åº”çš„æ’ä»¶ã€‚ ","date":"2021-12-03","objectID":"/grpc1/:0:0","tags":null,"title":"GPRC å®æˆ˜","uri":"/grpc1/"},{"categories":null,"content":"å®‰è£…grpc-go go get -u github.com/golang/protobuf/{proto,protoc-gen-go} go get -u google.golang.org/grpc å¦‚æœæ˜¯å›½å†…ç”¨æˆ·æ— æ³•è¿æ¥åˆ° google.golang.org çš„è¯å¯ä»¥ä½¿ç”¨ VPNã€‚æˆ–è€…ç›´æ¥ä» github.com ç›´æ¥ä¸‹è½½æºä»£ç å†ç¼–è¯‘å®‰è£… git clone https://github.com/grpc/grpc-go.git $GOPATH/src/google.golang.org/grpc go get -u google.golang.org/grpc ","date":"2021-12-03","objectID":"/grpc1/:1:0","tags":null,"title":"GPRC å®æˆ˜","uri":"/grpc1/"},{"categories":null,"content":"å®‰è£… protoc golang è¦ä½¿ç”¨ grpcï¼Œè¿˜éœ€è¦ä½¿ç”¨ protoc å·¥å…·ã€‚å› ä¸º golang ä¸èƒ½ç›´æ¥è¯†åˆ« .proto æ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨ protoc å·¥å…·å°† .proto è½¬åŒ–æˆ golang ä»£ç ã€‚ä¸‹é¢ä»‹ç»å‡ ä¸ªå¹³å°ä¸‹å®‰è£… protobuf çš„æ–¹æ³•ã€‚ ","date":"2021-12-03","objectID":"/grpc1/:2:0","tags":null,"title":"GPRC å®æˆ˜","uri":"/grpc1/"},{"categories":null,"content":"macos macos ä¸‹å®‰è£…ç›´æ¥ä½¿ç”¨ brew å‘½ä»¤å³å¯ã€‚ brew install protobuf ","date":"2021-12-03","objectID":"/grpc1/:2:1","tags":null,"title":"GPRC å®æˆ˜","uri":"/grpc1/"},{"categories":null,"content":"linux linux ä¸‹éœ€è¦å…ˆä» github.com ä¸‹è½½ protobuf æºç æˆ–è€…äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸‹è½½åœ°å€ã€‚äºŒè¿›åˆ¶å®‰è£…çš„è¯å°±ä¸‹è½½ protobuf-all-*.tar.gz åŒ…ï¼Œè§£å‹åè¿›å…¥ç”Ÿæˆçš„ç›®å½•ã€‚ä¹‹åæ‰§è¡Œå‘½ä»¤ï¼š make \u0026\u0026 make install ","date":"2021-12-03","objectID":"/grpc1/:2:2","tags":null,"title":"GPRC å®æˆ˜","uri":"/grpc1/"},{"categories":null,"content":"windows ä¸‹è½½ protobuf.all-*.zip åŒ…ï¼Œè§£å‹åå†é…ç½®ç¯å¢ƒå˜é‡ï¼Œå°† protobuf\\bin é…ç½®åˆ° $PATH å˜é‡ä¸­ã€‚ GRPCä½¿ç”¨ ","date":"2021-12-03","objectID":"/grpc1/:2:3","tags":null,"title":"GPRC å®æˆ˜","uri":"/grpc1/"},{"categories":null,"content":"æ–°å»ºé¡¹ç›® æ–°å»ºä¸€ä¸ª grpc é¡¹ç›®ï¼Œå¦‚ä¸‹: ../sample â””â”€â”€ pb â””â”€â”€ echo.proto echo.proto çš„å†…å®¹ä¸º: syntax = \"proto3\"; // protobuf è¯­æ³•ç‰ˆæœ¬ï¼Œé»˜è®¤ä¸º proto2 // // è¿™ä¸ªæ˜¯æ³¨é‡Š // .proto æ‰€åœ¨çš„åŒ…è·¯å¾„ package sample.pb;option go_package = \"pb\";// EchoRequest grpc è¯·æ±‚æŠ¥æ–‡æ ¼å¼. message EchoRequest { string message = 1;}// EchoResponse grpc å“åº”æŠ¥æ–‡æ ¼å¼. message EchoResponse { string message = 1;}// å®šä¹‰ Echo æœåŠ¡. service Echo { // UnaryEcho ä¸€å…ƒè¯·æ±‚. rpc UnaryEcho(EchoRequest) returns (EchoResponse) {} // ServerStreamingEcho æœåŠ¡ç«¯ stream è¯·æ±‚. rpc ServerStreamingEcho(EchoRequest) returns (stream EchoResponse) {} // ClientStreamingEcho å®¢æˆ·ç«¯ stream è¯·æ±‚. rpc ClientStreamingEcho(stream EchoRequest) returns (EchoResponse) {} // BidirectionalStreamingEcho åŒå‘ stream. rpc BidirectionalStreamingEcho(stream EchoRequest) returns (stream EchoResponse) {}} æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°† .proto è½¬åŒ–ä¸º golang ä»£ç : cd sample # protoc -I\u003cimportè·¯å¾„\u003e \u003c...-I$PATH\u003e --go_out=plugins=grpc:\u003cè¾“å‡ºè·¯å¾„\u003e *.proto protoc -I. --go_out=plugins=grpc:. pb/echo.proto ç®€å•æè¿°ä¸‹ protoc å‘½ä»¤çš„åŠŸèƒ½ã€‚ -I : *.proto ä¸­å¯¼å…¥çš„åŒ…çš„è·¯å¾„ï¼Œå¯¼å…¥çš„è·¯å¾„ä¸ºå…¨è·¯å¾„æ ¼å¼ã€‚. è¡¨ç¤ºå½“å‰è·¯å¾„ã€‚ â€“go_out=plugins=grpc: ï¼šæŒ‡å®š _.proto è¾“å‡ºçš„æ ¼å¼å’Œè·¯å¾„ï¼Œç”Ÿæˆ _.go æ–‡ä»¶çš„è·¯å¾„ä¸º å’Œ *.proto çš„æ‹¼æ¥ã€‚æ‰§è¡ŒæˆåŠŸåæˆä¸ºæ–‡ä»¶ echo.pb.go æ–‡ä»¶: ../sample â””â”€â”€ pb â”œâ”€â”€ echo.pb.go â””â”€â”€ echo.proto ","date":"2021-12-03","objectID":"/grpc1/:3:0","tags":null,"title":"GPRC å®æˆ˜","uri":"/grpc1/"},{"categories":null,"content":"Server package main import ( \"context\" \"errors\" \"google.golang.org/grpc\" \"io\" \"log\" \"mysite/sample/pb\" \"net\" ) type server struct { pb.EchoServer } // ç®€å•è¯·æ±‚ func (s *server) UnaryEcho(ctx context.Context, request *pb.EchoRequest) (*pb.EchoResponse, error) { return \u0026pb.EchoResponse{Message: \"echo: \" + request.Message}, nil } // æœåŠ¡ç«¯æµå¼ func (s *server) ServerStreamingEcho(request *pb.EchoRequest, stream pb.Echo_ServerStreamingEchoServer) error { _ = stream.Send(\u0026pb.EchoResponse{Message: \"hello\"}) _ = stream.Send(\u0026pb.EchoResponse{Message: \" \"}) _ = stream.Send(\u0026pb.EchoResponse{Message: \"client\"}) return nil } // å®¢æˆ·ç«¯æµå¼ func (s *server) ClientStreamingEcho(stream pb.Echo_ClientStreamingEchoServer) error { for { recv, err := stream.Recv() // block ç›´åˆ°æœ‰æ•°æ®è¾“å‡º if errors.Is(err, io.EOF) { // è¡¨ç¤ºæ¶ˆæ¯ä¼ è¾“å®Œæ¯• break } if err != nil { log.Printf(\"recv error: %v\", err) return err } // client æ–­å¼€è¿æ¥ log.Printf(\"recv data: %v\", recv.Message) } // SendAndClose åªå­˜åœ¨äºå®¢æˆ·ç«¯ stream è¯·æ±‚ // å‘é€å®Œå…³é—­ stream return stream.SendAndClose(\u0026pb.EchoResponse{Message: \"bye\"}) } // åŒå‘æµå¼ func (s *server) BidirectionalStreamingEcho(stream pb.Echo_BidirectionalStreamingEchoServer) error { // å¦‚æœæœåŠ¡ç«¯ stream æ–¹æ³•é€€å‡ºï¼Œå®¢æˆ·ç«¯è¯·æ±‚ä¹Ÿç›´æ¥æ–­å¼€ for { recv, err := stream.Recv() if errors.Is(err, io.EOF) { break } if err != nil { log.Printf(\"recv error: %v\", err) return err } if recv.Message == \"bye\" { log.Printf(\"client send done!\") break } if err := stream.Send(\u0026pb.EchoResponse{Message: \"reply: \" + recv.Message}); err != nil { log.Printf(\"send message error: %v\", err) return err } } return nil } func main() { addr := \"127.0.0.1:50001\" // grpc ä¸º http2 è¯·æ±‚ï¼Œä¼ è¾“å±‚åè®®ä¸º tcp lis, err := net.Listen(\"tcp\", addr) if err != nil { log.Fatalf(\"binding at %v: %v\", addr, err) } gRPCServer := grpc.NewServer() pb.RegisterEchoServer(gRPCServer, \u0026server{}) if err := gRPCServer.Serve(lis); err != nil { log.Fatalf(\"start grpc: %v\", err) } } ","date":"2021-12-03","objectID":"/grpc1/:4:0","tags":null,"title":"GPRC å®æˆ˜","uri":"/grpc1/"},{"categories":null,"content":"Client package main import ( \"context\" \"errors\" \"fmt\" \"google.golang.org/grpc\" \"io\" \"log\" \"mysite/sample/pb\" ) // ç®€å•è¯·æ±‚ func unaryEcho(cli pb.EchoClient, msg string) { recv, err := cli.UnaryEcho(context.Background(), \u0026pb.EchoRequest{Message: msg}) if err != nil { log.Fatalf(\"unaryEcho %v\", err) } log.Println(\"recv data =\u003e \" + recv.Message) } // æœåŠ¡ç«¯æµå¼ func serverStreamingEcho(cli pb.EchoClient, msg string) { stream, err := cli.ServerStreamingEcho(context.Background(), \u0026pb.EchoRequest{Message: msg}) if err != nil { log.Fatalf(\"serverStreamingEcho %v\", err) } ctx := stream.Context() for { select { case \u003c-ctx.Done(): log.Println(\"serverStreamingEcho done!\") break default: } msg, err := stream.Recv() if errors.Is(err, io.EOF) { break } if err == nil { log.Println(\"serverStreaming reply =\u003e \", msg.Message) } } } // å®¢æˆ·ç«¯æµå¼ func clientStreamingEcho(cli pb.EchoClient) { stream, err := cli.ClientStreamingEcho(context.Background()) if err != nil { log.Printf(\"connect client Streaming: %v\\n\", err) return } err = stream.Send(\u0026pb.EchoRequest{Message: \"hello\"}) if err != nil { log.Printf(\"clientStreamingEcho send data: %v\", err) return } err = stream.Send(\u0026pb.EchoRequest{Message: \" \"}) if err != nil { log.Printf(\"clientStreamingEcho send data: %v\", err) return } err = stream.Send(\u0026pb.EchoRequest{Message: \"world\"}) if err != nil { log.Printf(\"clientStreamingEcho send data: %v\", err) return } if recv, err := stream.CloseAndRecv(); err == nil { fmt.Printf(\"recv data: %v\\n\", recv.Message) } } // åŒå‘æµå¼ func bidirectionalStreamingEcho(cli pb.EchoClient) { stream, err := cli.BidirectionalStreamingEcho(context.Background()) if err != nil { log.Printf(\"bidirectionalStreamingEcho error: %v\\n\", err) return } stream.Send(\u0026pb.EchoRequest{Message: \"dataset 1\"}) recv, err := stream.Recv() if err == nil { fmt.Printf(\"recv from bidirectionalStreamingEcho =\u003e %v\\n\", recv.Message) } stream.Send(\u0026pb.EchoRequest{Message: \"dataset 2\"}) recv, err = stream.Recv() if err == nil { fmt.Printf(\"recv from bidirectionalStreamingEcho =\u003e %v\\n\", recv.Message) } stream.Send(\u0026pb.EchoRequest{Message: \"dataset 3\"}) recv, err = stream.Recv() if err == nil { fmt.Printf(\"recv from bidirectionalStreamingEcho =\u003e %v\\n\", recv.Message) } stream.Send(\u0026pb.EchoRequest{Message: \"bye\"}) stream.CloseSend() } func main() { addr := \"127.0.0.1:50001\" ctx, cancel := context.WithCancel(context.Background()) defer cancel() conn, err := grpc.DialContext(ctx, addr, grpc.WithInsecure()) if err != nil { log.Fatalf(\"connect %v: %v\", addr, err) } cli := pb.NewEchoClient(conn) unaryEcho(cli, \"hello\") serverStreamingEcho(cli, \"hello\") clientStreamingEcho(cli) bidirectionalStreamingEcho(cli) } ","date":"2021-12-03","objectID":"/grpc1/:5:0","tags":null,"title":"GPRC å®æˆ˜","uri":"/grpc1/"},{"categories":null,"content":"GPRC è¿›é˜¶ grpc é™¤äº†æä¾›å››ç§è¯·æ±‚ç±»å‹ä¹‹å¤–ï¼Œè¿˜æ”¯æŒå¾ˆå¤šé«˜çº§åŠŸèƒ½ï¼škeepaliveã€è¯·æ±‚é‡è¯•ã€è´Ÿè½½å‡è¡¡ã€ç”¨æˆ·éªŒè¯ç­‰ã€‚æ¥ä¸‹æ¥ä¸€ä¸€ä»‹ç»ã€‚ GRPC è¿›é˜¶åŠŸèƒ½ æ¯ä¸ªgrpcè¯·æ±‚éƒ½æ˜¯ streamã€‚ ","date":"2021-12-03","objectID":"/grpc2/:0:0","tags":null,"title":"GPRC è¿›é˜¶","uri":"/grpc2/"},{"categories":null,"content":"Keepalive Keepalive èƒ½å¤Ÿè®© grpc çš„æ¯ä¸ª stream ä¿æŒé•¿è¿æ¥çŠ¶æ€ï¼Œé€‚åˆä¸€äº›æ‰§è¡Œæ—¶é—´é•¿çš„è¯·æ±‚ã€‚Keepalive æ”¯æŒåœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯é…ç½®ï¼Œä¸”åªæœ‰æœåŠ¡ç«¯é…ç½®åï¼Œå®¢æˆ·ç«¯çš„é…ç½®æ‰ä¼šçœŸæ­£æœ‰æ•ˆã€‚å…ˆç»™å‡ºå®ä¾‹çš„ä»£ç åœ¨æ¥è¯´æ˜ grpc keepalive çš„ä½¿ç”¨æƒ…å†µï¼šserver å®ç°ï¼š // ... var kaep = keepalive.EnforcementPolicy{ MinTime: 5 * time.Second, // If a client pings more than once every 5 seconds, terminate the connection PermitWithoutStream: true, // Allow pings even when there are no active streams } var kasp = keepalive.ServerParameters{ MaxConnectionIdle: 15 * time.Second, // If a client is idle for 15 seconds, send a GOAWAY MaxConnectionAge: 30 * time.Second, // If any connection is alive for more than 30 seconds, send a GOAWAY MaxConnectionAgeGrace: 5 * time.Second, // Allow 5 seconds for pending RPCs to complete before forcibly closing connections Time: 5 * time.Second, // Ping the client if it is idle for 5 seconds to ensure the connection is still active Timeout: 1 * time.Second, // Wait 1 second for the ping ack before assuming the connection is dead } // server implements EchoServer. type server struct { pb.UnimplementedEchoServer } func (s *server) UnaryEcho(ctx context.Context, req *pb.EchoRequest) (*pb.EchoResponse, error) { return \u0026pb.EchoResponse{Message: req.Message}, nil } func main() { address := \"50001\" lis, err := net.Listen(\"tcp\", address) if err != nil { log.Fatalf(\"failed to listen: %v\", err) } // åˆ›å»º grpc server æ—¶é…ç½®æœåŠ¡ç«¯çš„ keepalive s := grpc.NewServer(grpc.KeepaliveEnforcementPolicy(kaep), grpc.KeepaliveParams(kasp)) pb.RegisterEchoServer(s, \u0026server{}) if err := s.Serve(lis); err != nil { log.Fatalf(\"failed to serve: %v\", err) } } client ç«¯å®ç°ï¼š // ... var kacp = keepalive.ClientParameters{ Time: 10 * time.Second, // send pings every 10 seconds if there is no activity Timeout: time.Second, // wait 1 second for ping ack before considering the connection dead PermitWithoutStream: true, // send pings even without active streams } func main() { conn, err := grpc.Dial(\"50001\", grpc.WithInsecure(), grpc.WithKeepaliveParams(kacp)) if err != nil { log.Fatalf(\"did not connect: %v\", err) } defer conn.Close() c := pb.NewEchoClient(conn) ctx, cancel := context.WithTimeout(context.Background(), 3*time.Minute) defer cancel() fmt.Println(\"Performing unary request\") res, err := c.UnaryEcho(ctx, \u0026pb.EchoRequest{Message: \"keepalive demo\"}) if err != nil { log.Fatalf(\"unexpected error from UnaryEcho: %v\", err) } fmt.Println(\"RPC response:\", res) } keepalive çš„å®ç°æ ¸å¿ƒåœ¨äº keepalive.EnforcementPolicy å’Œ keepalive.ServerParametersã€‚é¦–å…ˆæ˜¯ keepalive.ServerParametersã€‚å®ƒåŒ…å«å‡ ä¸ªå±æ€§ï¼š MaxConnectionIdle : æœ€å¤§ç©ºé—²è¿æ¥æ—¶é—´ï¼Œé»˜è®¤ä¸ºæ— é™åˆ¶ã€‚è¿™æ®µæ—¶é—´ä¸ºå®¢æˆ·ç«¯ stream è¯·æ±‚ä¸º0 æˆ–è€…å»ºç«‹è¿æ¥ã€‚è¶…å‡ºè¿™æ®µæ—¶é—´åï¼Œserve ä¼šå‘é€ä¸€ä¸ª GoWayï¼Œå¼ºåˆ¶ client stream æ–­å¼€ã€‚ MaxConnectionAgeï¼šæœ€å¤§è¿æ¥æ—¶é—´ï¼Œé»˜è®¤ä¸ºæ— é™åˆ¶ã€‚stream è¿æ¥è¶…å‡ºè¿™ä¸ªå€¼æ˜¯å‘é€ä¸€ä¸ª GoWayã€‚ MaxConnectionAgeGrace ï¼šè¶…å‡ºMaxConnectionAgeä¹‹åçš„å®½é™æ—¶é•¿ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œæœ€å°ä¸º 1sã€‚ Time ï¼šå¦‚æœä¸€æ®µæ—¶é—´å®¢æˆ·ç«¯å­˜æ´»ä½†æ²¡æœ‰ pings è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å‘é€ä¸€æ¬¡ ping è¯·æ±‚ï¼Œé»˜è®¤æ˜¯ 2hourã€‚ Timeoutï¼šæœåŠ¡ç«¯å‘é€ ping è¯·æ±‚è¶…æ—¶çš„æ—¶é—´ï¼Œé»˜è®¤20sã€‚ keepalive.EnforcementPolicyåœ¨æœåŠ¡ç«¯å¼ºåˆ¶æ‰§è¡Œç­–ç•¥ï¼Œå¦‚æœå®¢æˆ·ç«¯è¿åæ”¹ç­–ç•¥åˆ™æ–­å¼€è¿æ¥ã€‚å®ƒæœ‰ä¸¤ä¸ªå±æ€§ï¼š MinTime : å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…æ”¶åˆ° pings è¯·æ±‚å¤§äºä¸€æ¬¡ï¼Œå¼ºåˆ¶æ–­å¼€è¿æ¥ï¼Œé»˜è®¤ 5minã€‚ PermitWithoutStreamï¼šæ²¡æœ‰æ´»åŠ¨çš„ stream ä¹Ÿå…è®¸pingsã€‚é»˜è®¤å…³é—­ã€‚ keepalive.ClientParametersæ˜¯åœ¨å®¢æˆ·ç«¯è¿™ä¾§ä½¿ç”¨çš„ keepalive é…ç½®ï¼š Time ï¼špings è¯·æ±‚é—´éš”æ—¶é—´ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œæœ€å°ä¸º 10sã€‚ Timeout ï¼špings è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯ 20sã€‚ PermitWithoutStreamï¼šæ²¡æœ‰æ´»åŠ¨çš„ stream ä¹Ÿå…è®¸pingsã€‚é»˜è®¤å…³é—­ã€‚ ","date":"2021-12-03","objectID":"/grpc2/:1:0","tags":null,"title":"GPRC è¿›é˜¶","uri":"/grpc2/"},{"categories":null,"content":"è¯·æ±‚é‡è¯• grpc æ”¯æŒè¯·æ±‚é‡è¯•ï¼Œåœ¨å®¢æˆ·ç«¯é…ç½®å¥½è§„åˆ™ä¹‹åï¼Œå®¢æˆ·ç«¯ä¼šåœ¨è¯·æ±‚å¤±è´¥ä¹‹åå°è¯•é‡æ–°å‘èµ·è¯·æ±‚ã€‚ var ( retryPolicy = `{ \"methodConfig\": [{ \"name\": [{\"service\": \"mysite.pb.Echo\"}], \"waitForReady\": true, \"retryPolicy\": { \"MaxAttempts\": 3, \"InitialBackoff\": \".01s\", \"MaxBackoff\": \"1s\", \"BackoffMultiplier\": 2.0, \"RetryableStatusCodes\": [ \"UNAVAILABLE\" ] } }]}` ) // use grpc.WithDefaultServiceConfig() to set service config func retryDial() (*grpc.ClientConn, error) { return grpc.Dial(*addr, grpc.WithInsecure(), grpc.WithDefaultServiceConfig(retryPolicy)) } // ... retry é…ç½®åªéœ€è¦åœ¨å®¢æˆ·ç«¯è®¾ç½®å³å¯ç”Ÿæ•ˆã€‚ä¸»è¦æ˜¯é…ç½®ServerConfigï¼Œæ ¼å¼ä¸ºè¯¥é“¾æ¥ MaxAttempts ï¼šé‡è¯•çš„æœ€å¤§æ¬¡æ•°ï¼Œæœ€å¤§å€¼æ˜¯5ã€‚ InitialBackoff : åˆå§‹åŒ–é‡è¯•é—´éš”æ—¶é—´ï¼Œç¬¬ä¸€æ¬¡é‡è¯•å» Randon(0,initialBackoff)ã€‚ MaxBackoff : æœ€å¤§é‡è¯•é—´éš”æ—¶é—´ï¼Œå¤šæ¬¡é‡è¯•æ˜¯ï¼Œé—´éš”æ—¶é—´å– random(0,min(initial_backoff*backoff_multiplier**(n-1), max_backoff))ã€‚ RetryableStatusCodes : è®¾ç½®éœ€è¦é‡è¯•çš„çŠ¶æ€ç ã€‚ ","date":"2021-12-03","objectID":"/grpc2/:2:0","tags":null,"title":"GPRC è¿›é˜¶","uri":"/grpc2/"},{"categories":null,"content":"è´Ÿè½½å‡è¡¡ grpc æ”¯æŒå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œè´Ÿè½½å‡è¡¡åœ¨ grpc name_resolver çš„åŸºç¡€ä¸Šå®ç°ï¼š const ( exampleScheme = \"example\" exampleServiceName = \"lb.example.grpc.io\" ) // ... func main() { // ... // round_robin æŒ‡å®šè´Ÿè½½å‡è¡¡ç­–ç•¥ä¸ºè½®è¯¢ç­–ç•¥ roundrobinConn, err := grpc.Dial( fmt.Sprintf(\"%s:///%s\", exampleScheme, exampleServiceName), grpc.WithBalancerName(\"round_robin\"), // This sets the initial balancing policy. grpc.WithInsecure(), grpc.WithBlock(), ) // ... } // é…ç½® name resolver type exampleResolverBuilder struct{} func (*exampleResolverBuilder) Build(target resolver.Target, cc resolver.ClientConn, opts resolver.BuildOptions) (resolver.Resolver, error) { r := \u0026exampleResolver{ target: target, cc: cc, addrsStore: map[string][]string{ exampleServiceName: addrs, }, } r.start() return r, nil } func (*exampleResolverBuilder) Scheme() string { return exampleScheme } type exampleResolver struct { target resolver.Target cc resolver.ClientConn addrsStore map[string][]string } func (r *exampleResolver) start() { addrStrs := r.addrsStore[r.target.Endpoint] addrs := make([]resolver.Address, len(addrStrs)) for i, s := range addrStrs { addrs[i] = resolver.Address{Addr: s} } r.cc.UpdateState(resolver.State{Addresses: addrs}) } func (*exampleResolver) ResolveNow(o resolver.ResolveNowOptions) {} func (*exampleResolver) Close() {} func init() { resolver.Register(\u0026exampleResolverBuilder{}) } ä¸»è¦æ˜¯è¦å®ç° resolver.Builderæ¥å£ // Builder creates a resolver that will be used to watch name resolution updates. type Builder interface { // Build creates a new resolver for the given target. // // gRPC dial calls Build synchronously, and fails if the returned error is // not nil. Build(target Target, cc ClientConn, opts BuildOptions) (Resolver, error) // Scheme returns the scheme supported by this resolver. // Scheme is defined at \u003chttps://github.com/grpc/grpc/blob/master/doc/naming.md\u003e. Scheme() string } ä¸Šé¢çš„å®ç°æ–¹å¼ä¸æ”¯æŒåŠ¨æ€å¢å‡æœåŠ¡ç«¯åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨ etcd å®ç°è´Ÿè½½å‡è¡¡ï¼š type etcdBuilder struct { prefix string endpoints []string } func ETCDBuilder(prefix string, endpoints []string) resolver.Builder { return \u0026etcdBuilder{prefix, endpoints} } func (b *etcdBuilder) Build(target resolver.Target, cc resolver.ClientConn, opts resolver.BuildOptions) (resolver.Resolver, error) { cli, err := clientv3.New(clientv3.Config{ Endpoints: b.endpoints, DialTimeout: 3 * time.Second, }) if err != nil { return nil, fmt.Errorf(\"connect to etcd endpoints error\") } ctx, cancel := context.WithCancel(context.Background()) rlv := \u0026etcdResolver{ cc: cc, cli: cli, ctx: ctx, cancel: cancel, watchKeyPrefix: b.prefix, freq: 5 * time.Second, t: time.NewTimer(0), rn: make(chan struct{}, 1), im: make(chan []resolver.Address), wg: sync.WaitGroup{}, } rlv.wg.Add(2) go rlv.watcher() go rlv.FetchBackendsWithWatch() return rlv, nil } func (b *etcdBuilder) Scheme() string { return \"etcd\" } type etcdResolver struct { retry int freq time.Duration ctx context.Context cancel context.CancelFunc cc resolver.ClientConn cli *clientv3.Client t *time.Timer watchKeyPrefix string rn chan struct{} im chan []resolver.Address wg sync.WaitGroup } func (r *etcdResolver) ResolveNow(opt resolver.ResolveNowOptions) { select { case r.rn \u003c- struct{}{}: default: } } func (r *etcdResolver) Close() { r.cancel() r.wg.Wait() r.t.Stop() } func (r *etcdResolver) watcher() { defer r.wg.Done() for { select { case \u003c-r.ctx.Done(): return case addrs := \u003c-r.im: if len(addrs) \u003e 0 { r.retry = 0 r.t.Reset(r.freq) r.cc.UpdateState(resolver.State{Addresses: addrs}) continue } case \u003c-r.t.C: case \u003c-r.rn: } result := r.FetchBackends() if len(result) == 0 { r.retry++ r.t.Reset(r.freq) } else { r.retry = 0 r.t.Reset(r.freq) } r.cc.UpdateState(resolver.State{Addresses: result}) } } func (r *etcdResolver) FetchBackendsWithWatch() { defer r.wg.Done() for { select { case \u003c-r.ctx.Done(): return case _ = \u003c-r.cli.Watch(r.ctx, r.watchKeyPrefix, clientv3.WithPrefix()): result := r.FetchBackends() r.im \u003c- result } } } func (r *etcdResolver) FetchBackends() []resolver.Address { ctx, cancel := context.WithTimeout(context.Background()","date":"2021-12-03","objectID":"/grpc2/:3:0","tags":null,"title":"GPRC è¿›é˜¶","uri":"/grpc2/"},{"categories":null,"content":"grpc åŠ å¯†ä¼ è¾“ ä»¥ä¸Šçš„è¯·æ±‚ä¸­ï¼Œgrpc éƒ½æ˜¯é€šè¿‡æ˜æ–‡ä¼ è¾“æ•°æ®ã€‚ä½†è¿™ç§æ–¹å¼æ˜¯å¾ˆå®¹æ˜“æ³„éœ²æ•°æ®å†…å®¹çš„ï¼Œgrpc æ”¯æŒ TLS æ ¼å¼çš„åŠ å¯†é€šè®¯ï¼Œæ¥ä¿å­˜æ•°æ®ä¼ è¾“çš„å®‰å…¨æ€§ã€‚ ","date":"2021-12-03","objectID":"/grpc2/:4:0","tags":null,"title":"GPRC è¿›é˜¶","uri":"/grpc2/"},{"categories":null,"content":"TLS è¯ä¹¦ æˆ‘ä»¬é¦–å…ˆæ¥ç”Ÿæˆ TLS è¯ä¹¦ openssl ecparam -genkey -name secp384r1 -out server.key openssl req -new -x509 -sha256 -key server.key -out server.pem -days 3650 è¿™é‡Œéœ€è¦å¡«å†™ç›¸å…³ä¿¡æ¯ Country Name (2 letter code) []: State or Province Name (full name) []: Locality Name (eg, city) []: Organization Name (eg, company) []: Organizational Unit Name (eg, section) []: Common Name (eg, fully qualified host name) []: mysite Email Address []: å¡«å†™å®Œæˆåå°±ç”Ÿæˆå¯¹åº”çš„è¯ä¹¦ï¼š ssl â”œâ”€â”€ server.key â””â”€â”€ server.pem æœåŠ¡ç«¯å®ç° // ... const PORT = \"50001\" func main() { // é€šè¿‡ credentials åŠ è½½æœåŠ¡ç«¯çš„TLSè¯ä¹¦ c, err := credentials.NewServerTLSFromFile(\"../ssl/server.pem\", \"../ssl/server.key\") if err != nil { log.Fatalf(\"credentials.NewServerTLSFromFile err: %v\", err) } // æ·»åŠ  credentials é…ç½® server := grpc.NewServer(grpc.Creds(c)) pb.RegisterSearchServiceServer(server, \u0026SearchService{}) lis, err := net.Listen(\"tcp\", \":\"+PORT) if err != nil { log.Fatalf(\"net.Listen err: %v\", err) } server.Serve(lis) } å®¢æˆ·ç«¯å®ç° const PORT = \"9001\" func main() { // æ·»åŠ  credentials é…ç½® c, err := credentials.NewClientTLSFromFile(\"../ssl/server.pem\", \"mysite\") if err != nil { log.Fatalf(\"credentials.NewClientTLSFromFile err: %v\", err) } // å®¢æˆ·ç«¯å¼€å¯è¯ä¹¦éªŒè¯ conn, err := grpc.Dial(\":\"+PORT, grpc.WithTransportCredentials(c)) if err != nil { log.Fatalf(\"grpc.Dial err: %v\", err) } defer conn.Close() client := pb.NewSearchServiceClient(conn) resp, err := client.Search(context.Background(), \u0026pb.SearchRequest{ Request: \"gRPC\", }) if err != nil { log.Fatalf(\"client.Search err: %v\", err) } log.Printf(\"resp: %s\", resp.GetResponse()) } ","date":"2021-12-03","objectID":"/grpc2/:4:1","tags":null,"title":"GPRC è¿›é˜¶","uri":"/grpc2/"},{"categories":null,"content":"CA TLS è¯ä¹¦ TLS è¯ä¹¦çš„å®‰å…¨æ€§è¿˜ä¸å¤Ÿé«˜ï¼Œç‰¹åˆ«åœ¨è¯ä¹¦ç”Ÿæˆä¹‹åï¼Œserver.keyæ–‡ä»¶çš„ä¼ è¾“å°±æˆä¸ºä¸€ä¸ªé—®é¢˜ã€‚æ‰€ä»¥ CA æ¥ç­¾å‘ TLS è¯ä¹¦æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½¿ç”¨å¼€æºå·¥å…· cfssl ç”Ÿæˆå¯¹åº”çš„è¯ä¹¦ï¼š1.ca é…ç½® cat \u003c\u003c EOF | tee ca-config.json { \"signing\": { \"default\": { \"expiry\": \"87600h\" }, \"profiles\": { \"mysite\": { \"expiry\": \"87600h\", \"usages\": [ \"signing\", \"key encipherment\", \"server auth\", \"client auth\" ] } } }} EOF é…ç½® mysite æœºæ„è¯ä¹¦å¯ä»¥è¿›è¡ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åŒå‘éªŒè¯ã€‚2.ca è¯ä¹¦ cat \u003c\u003c EOF | tee ca-csr.json { \"CN\": \"mysite CA\", \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"L\": \"Beijing\", \"ST\": \"Beijing\" } ]} EOF 3.æœåŠ¡ç«¯è¯ä¹¦ cat \u003c\u003c EOF | tee server-csr.json { \"CN\": \"mysite\", \"hosts\": [ \"127.0.0.1\" ], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"L\": \"Beijing\", \"ST\": \"Beijing\" } ]} EOF ç”Ÿæˆ mysite ca è¯ä¹¦å’Œç§é’¥ï¼Œåˆå§‹åŒ– ca cfssl gencert -initca ca-csr.json | cfssljson -bare ca ç”Ÿæˆserverè¯ä¹¦ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=mysite -hostname=mysite server-csr.json | cfssljson -bare server æœ€åçš„ç»“æœä¸º: ../ssl â”œâ”€â”€ ca-config.json â”œâ”€â”€ ca-csr.json â”œâ”€â”€ ca-key.pem â”œâ”€â”€ ca.csr â”œâ”€â”€ ca.pem â”œâ”€â”€ server-csr.json â”œâ”€â”€ server-key.pem â”œâ”€â”€ server.csr â””â”€â”€ server.pem æ¥ä¸‹æ¥æ˜¯ä»£ç å®ç°ï¼Œå…ˆæ˜¯æœåŠ¡ç«¯ï¼š // ... type ecServer struct { pb.UnimplementedEchoServer } func (s *ecServer) UnaryEcho(ctx context.Context, req *pb.EchoRequest) (*pb.EchoResponse, error) { return \u0026pb.EchoResponse{Message: req.Message}, nil } func main() { lis, err := net.Listen(\"tcp\", \"127.0.0.1:50001\") if err != nil { log.Fatalf(\"failed to listen: %v\", err) } // Create tls based credential. cert, err := tls.LoadX509KeyPair(\"ssl/server.pem\", \"ssl/server-key.pem\") if err != nil { log.Fatalf(\"tls.LoadX509KeyPair err: %v\", err) } certPool := x509.NewCertPool() ca, err := ioutil.ReadFile(\"ssl/ca.pem\") if err != nil { log.Fatalf(\"ioutil.ReadFile err: %v\", err) } if ok := certPool.AppendCertsFromPEM(ca); !ok { log.Fatalf(\"certPool.AppendCertsFromPEM err\") } creds := credentials.NewTLS(\u0026tls.Config{ Certificates: []tls.Certificate{cert}, ClientAuth: tls.RequireAndVerifyClientCert, ClientCAs: certPool, }) s := grpc.NewServer(grpc.Creds(creds)) // Register EchoServer on the server. pb.RegisterEchoServer(s, \u0026ecServer{}) log.Println(\"server start\") if err := s.Serve(lis); err != nil { log.Fatalf(\"failed to serve: %v\", err) } } ç„¶åæ˜¯å®¢æˆ·ç«¯ï¼š // ... func callUnaryEcho(client pb.EchoClient, message string) { ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second) defer cancel() resp, err := client.UnaryEcho(ctx, \u0026pb.EchoRequest{Message: message}) if err != nil { log.Fatalf(\"client.UnaryEcho(_) = _, %v: \", err) } fmt.Println(\"UnaryEcho: \", resp.Message) } func main() { // Create tls based credential. cert, err := tls.LoadX509KeyPair(\"ssl/server.pem\", \"ssl/server-key.pem\") if err != nil { log.Fatalf(\"tls.LoadX509KeyPair err: %v\", err) } certPool := x509.NewCertPool() ca, err := ioutil.ReadFile(\"ssl/ca.pem\") if err != nil { log.Fatalf(\"ioutil.ReadFile err: %v\", err) } if ok := certPool.AppendCertsFromPEM(ca); !ok { log.Fatalf(\"certPool.AppendCertsFromPEM err\") } creds := credentials.NewTLS(\u0026tls.Config{ Certificates: []tls.Certificate{cert}, ServerName: \"mysite\", RootCAs: certPool, }) // Set up a connection to the server. conn, err := grpc.Dial(\"127.0.0.1:50001\", grpc.WithTransportCredentials(creds)) if err != nil { log.Fatalf(\"did not connect: %v\", err) } defer conn.Close() // Make a echo client and send an RPC. rgc := pb.NewEchoClient(conn) callUnaryEcho(rgc, \"hello world\") } ","date":"2021-12-03","objectID":"/grpc2/:4:2","tags":null,"title":"GPRC è¿›é˜¶","uri":"/grpc2/"},{"categories":null,"content":"æ‹¦æˆªå™¨ grpc æ”¯æŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„æ‹¦æˆªå™¨ï¼Œå¯ä»¥åœ¨è¯·æ±‚å‘èµ·æˆ–è¿”å›å‰è¿›è¡Œå¤„ç†ï¼Œè€Œä¸ç”¨ä¿®æ”¹åŸæ¥çš„ä»£ç ã€‚æ¥ä¸‹æ¥æ¥çœ‹æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å„è‡ªæ€ä¹ˆä½¿ç”¨æ‹¦æˆªå™¨ï¼š // unary è¯·æ±‚æ‹¦æˆªå™¨ func UnaryInterceptor(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler, ) (resp interface{}, err error) { var ip string p, ok := peer.FromContext(ctx) if ok { ip = p.Addr.String() } md, _ := metadata.FromIncomingContext(ctx) start := time.Now() resp, err = handler(ctx, req) end := time.Now() log.Printf(\"%10s | %14s | %10v | md=%v | reply = %v\", ip, info.FullMethod, end.Sub(start), md, resp) return } // stream è¯·æ±‚æ‹¦æˆªå™¨ func StreamInterceptor(srv interface{}, ss grpc.ServerStream, info *grpc.StreamServerInfo, handler grpc.StreamHandler, ) (err error) { var ip string p, ok := peer.FromContext(ss.Context()) if ok { ip = p.Addr.String() } err = handler(srv, ss) log.Printf(\"stream %v | %v | %s\\\\n\", srv, ip, info.FullMethod) return } type server struct { pb.UnimplementedEchoServer } func (s *server) UnaryEcho(ctx context.Context, request *pb.EchoRequest) (*pb.EchoResponse, error) { return \u0026pb.EchoResponse{Message: request.Message}, nil } func (s *server) BidirectionalStreamingEcho(stream pb.Echo_BidirectionalStreamingEchoServer) error { ctx := stream.Context() for { select { case \u003c-ctx.Done(): break default: } msg, err := stream.Recv() if errors.Is(err, io.EOF) { break } if err != nil { log.Printf(\"recv failed: %v\\\\n\", err) } if err := stream.Send(\u0026pb.EchoResponse{Message: \"reply: \" + msg.Message}); err != nil { log.Printf(\"send to client: %v\\\\n\", err) } } return nil } func main() { addr := \"127.0.0.1:50001\" lis, err := net.Listen(\"tcp\", addr) if err != nil { log.Fatalf(\"network at %v: %v\\\\n\", addr, err) } s := grpc.NewServer(grpc.ChainUnaryInterceptor(UnaryInterceptor), grpc.ChainStreamInterceptor(StreamInterceptor)) pb.RegisterEchoServer(s, \u0026server{}) if err := s.Serve(lis); err != nil { log.Fatalf(\"start server at %v: %v\\\\n\", addr, err) } } grpc ä¸­çš„æ‹¦æˆªå™¨åˆ†ä¸¤ç§ï¼Œä¸€å…ƒè¯·æ±‚çš„æ‹¦æˆªå™¨å’Œæµå¼è¯·æ±‚çš„æ‹¦æˆªå™¨ã€‚å…¶ä¸­æµå¼è¯·æ±‚çš„è¿æ¥å™¨åŒæ—¶ä½œç”¨äºæœåŠ¡ç«¯æµå¼ã€å®¢æˆ·ç«¯æµå¼å’ŒåŒå‘æµå¼ä¸‰ç§è¯·æ±‚æ¨¡å¼ã€‚ æ¥ä¸‹æ¥æ˜¯å®¢æˆ·ç«¯ï¼š func clientUnaryInterceptor( ctx context.Context, method string, req, reply interface{}, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption, ) (err error) { ctx = metadata.AppendToOutgoingContext(ctx, \"username\", \"OOB\") err = invoker(ctx, method, req, reply, cc, opts...) return } func clientStreamInterceptor(ctx context.Context, desc *grpc.StreamDesc, cc *grpc.ClientConn, method string, streamer grpc.Streamer, opts ...grpc.CallOption, ) (stream grpc.ClientStream, err error) { // before stream stream, err = streamer(ctx, desc, cc, method, opts...) // after stream return } func callUnaryEcho(cc pb.EchoClient, msg string) { reply, err := cc.UnaryEcho(context.Background(), \u0026pb.EchoRequest{Message: msg}) if err == nil { log.Printf(\"reply =\u003e %v\\\\n\", reply) } } func callBidirectionalEcho(cc pb.EchoClient, msg string) { stream, err := cc.BidirectionalStreamingEcho(context.TODO()) if err != nil { log.Fatalf(\"call BidirectionalEcho: %v\\\\n\", err) } _ = stream.Send(\u0026pb.EchoRequest{Message: msg}) _ = stream.CloseSend() ctx := stream.Context() for { select { case \u003c-ctx.Done(): break default: } reply, err := stream.Recv() if errors.Is(err, io.EOF) { break } if err != nil { log.Fatalf(\"stream recv: %v\\\\n\", err) } log.Printf(\"stream reply =\u003e %v\\\\n\", reply.Message) } } func main() { addr := \"127.0.0.1:50001\" ctx, cancel := context.WithCancel(context.Background()) defer cancel() conn, err := grpc.DialContext( ctx, addr, grpc.WithInsecure(), grpc.WithChainUnaryInterceptor(clientUnaryInterceptor), grpc.WithChainStreamInterceptor(clientStreamInterceptor)) if err != nil { log.Fatalf(\"connect %v: %v\\\\n\", addr, err) } cc := pb.NewEchoClient(conn) callUnaryEcho(cc, \"unary\") callBidirectionalEcho(cc, \"start\") } grpc çš„æ‹¦æˆªå™¨åŒæ—¶æ”¯æŒå•ä¸ªæ‹¦æˆªå™¨å’Œé“¾å¼æ‹¦æˆªå™¨ã€‚ ","date":"2021-12-03","objectID":"/grpc2/:5:0","tags":null,"title":"GPRC è¿›é˜¶","uri":"/grpc2/"},{"categories":null,"content":"grpc æ·»åŠ  pprof æ¥å£ grpc æœ¬èº«æ˜¯ä½¿ç”¨ http2 ä½œä¸ºåº•å±‚åè®®ï¼Œæ‰€ä»¥å®ƒä¹Ÿèƒ½å’Œ golang çš„ pprof ç»“åˆæä¾› pprof æ¥å£ã€‚ä¸‹é¢ç»™å‡ºä»£ç ï¼š type server struct { pb.UnimplementedEchoServer } func (s *server) UnaryEcho(ctx context.Context, request *pb.EchoRequest) (*pb.EchoResponse, error) { return \u0026pb.EchoResponse{Message: request.Message}, nil } func (s *server) BidirectionalStreamingEcho(stream pb.Echo_BidirectionalStreamingEchoServer) error { ctx := stream.Context() for { select { case \u003c-ctx.Done(): break default: } msg, err := stream.Recv() if errors.Is(err, io.EOF) { break } if err != nil { log.Printf(\"recv failed: %v\\\\n\", err) } if err := stream.Send(\u0026pb.EchoResponse{Message: \"reply: \" + msg.Message}); err != nil { log.Printf(\"send to client: %v\\\\n\", err) } } return nil } func main() { addr := \"127.0.0.1:50001\" // è¿™é‡Œå¯ä»¥æ·»åŠ æœåŠ¡æ®µå¯åŠ¨é…ç½®å’Œå„ç§æ‹¦æˆªå™¨ s := grpc.NewServer() pb.RegisterEchoServer(s, \u0026server{}) mux := http.NewServeMux() mux.HandleFunc(\"/debug/pprof/\", pprof.Index) mux.HandleFunc(\"/debug/pprof/cmdline\", pprof.Cmdline) mux.HandleFunc(\"/debug/pprof/profile\", pprof.Profile) mux.HandleFunc(\"/debug/pprof/symbol\", pprof.Symbol) mux.HandleFunc(\"/debug/pprof/trace\", pprof.Trace) // å¯åŠ¨ http2 æœåŠ¡ï¼Œgolang http å¯åŠ¨æ—¶æ·»åŠ è¯ä¹¦ä¼šè‡ªåŠ¨è½¬åŒ–ä¸º http2 æœåŠ¡ã€‚ // å°† Content-Type ä¸º application/grpc è¯·æ±‚è½¬äº¤ç»™ grpc å³å¯ã€‚ err := http.ListenAndServeTLS( addr, \"ssl/server.pem\", \"ssl/server-key.pem\", http.HandlerFunc(func(rw http.ResponseWriter, r *http.Request) { if r.ProtoMajor == 2 \u0026\u0026 strings.Contains(r.Header.Get(\"Content-Type\"), \"application/grpc\") { log.Println(\"call grpc service\") s.ServeHTTP(rw, r) } else { mux.ServeHTTP(rw, r) } })) if err != nil { log.Fatalf(\"start server at %v: %v\", addr, err) } } ","date":"2021-12-03","objectID":"/grpc2/:6:0","tags":null,"title":"GPRC è¿›é˜¶","uri":"/grpc2/"},{"categories":null,"content":"grpc è¯·æ±‚æ–­å¼€å¤„ç† grpc çš„è¯·æ±‚æ²¡æœ‰è‡ªå·±è®¾ç½®è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œè€Œæ˜¯å°†è¿™éƒ¨åˆ†çš„å¤„ç†äº¤ç»™ golang çš„ context åŒ…ã€‚é€šè¿‡ context çš„åŠŸèƒ½å®ç°å®¢æˆ·ç«¯çš„ç™»å½•è¶…æ—¶ï¼Œè¯·æ±‚è¶…æ—¶ã€‚æœåŠ¡ç«¯ä»£ç ï¼š type server struct { pb.UnimplementedEchoServer } func (s *server) BidirectionalStreamingEcho(stream pb.Echo_BidirectionalStreamingEchoServer) error { // è¯¥å‡½æ•°å†…æ˜¯ stream çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œè¯¥å‡½æ•°é€€å‡ºåï¼Œstream çš„ä¸Šä¸‹æ–‡ç»“æŸ // æ¯ä¸ªstreamå‡½æ•°ç›¸äº’ç‹¬ç«‹ // æœåŠ¡ç«¯çš„ stream ä¸èƒ½ç›´æ¥å‘èµ·è¯·æ±‚ç»ˆæ­¢ï¼Œä½†å¯ä»¥é€šè¿‡æå‰ç»“æŸè¯¥å‡½æ•°ï¼Œåœæ­¢è¯¥ stream for { in, err := stream.Recv() if err != nil { fmt.Printf(\"server: error receiving from stream: %v\\n\", err) if err == io.EOF { return nil } return err } fmt.Printf(\"echoing message %q\\n\", in.Message) stream.Send(\u0026pb.EchoResponse{Message: in.Message}) } } func main() { lis, err := net.Listen(\"tcp\", \"127.0.0.1:10050\") if err != nil { log.Fatalf(\"failed to listen: %v\", err) } fmt.Printf(\"server listening at port %v\\n\", lis.Addr()) s := grpc.NewServer() pb.RegisterEchoServer(s, \u0026server{}) s.Serve(lis) } å®¢æˆ·ç«¯: func sendMessage(stream pb.Echo_BidirectionalStreamingEchoClient, msg string) error { fmt.Printf(\"sending message %q\\n\", msg) return stream.Send(\u0026pb.EchoRequest{Message: msg}) } func recvMessage(stream pb.Echo_BidirectionalStreamingEchoClient, wantErrCode codes.Code) { res, err := stream.Recv() if status.Code(err) != wantErrCode { log.Fatalf(\"stream.Recv() = %v, %v; want _, status.Code(err)=%v\", res, err, wantErrCode) } if err != nil { fmt.Printf(\"stream.Recv() returned expected error %v\\n\", err) return } fmt.Printf(\"received message %q\\n\", res.Message) } func main() { addr := \"127.0.0.1:10050\" // å»ºç«‹è¿æ¥ // å»ºç«‹è¿æ¥çš„ ctx å’Œè¯·æ±‚çš„ ctx æ˜¯ç‹¬ç«‹çš„ conn, err := grpc.DialContext(context.Background(), addr, grpc.WithInsecure()) if err != nil { log.Fatalf(\"did not connect: %v\", err) } defer conn.Close() c := pb.NewEchoClient(conn) // Initiate the stream with a context that supports cancellation. ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second) stream, err := c.BidirectionalStreamingEcho(ctx) if err != nil { log.Fatalf(\"error creating stream: %v\", err) } // Send some test messages. if err := sendMessage(stream, \"hello\"); err != nil { log.Fatalf(\"error sending on stream: %v\", err) } if err := sendMessage(stream, \"world\"); err != nil { log.Fatalf(\"error sending on stream: %v\", err) } // Ensure the RPC is working. recvMessage(stream, codes.OK) recvMessage(stream, codes.OK) fmt.Println(\"cancelling context\") cancel() // This Send may or may not return an error, depending on whether the // monitored context detects cancellation before the call is made. sendMessage(stream, \"closed\") // This Recv should never succeed. recvMessage(stream, codes.Canceled) } GRPC æ€§èƒ½ä¼˜åŒ– è™½ç„¶ grpc çš„å®˜æ–¹è‡ªè¯©æ˜¯é«˜æ€§èƒ½çš„æ¡†æ¶ï¼Œä½†æ˜¯ grpc å†…éƒ¨ä½¿ç”¨å¤§é‡çš„åå°„ï¼Œä½¿å¾— grpc åœ¨æ€§èƒ½ä¸Šå¹¶ä¸ç®—å¾ˆå¥½ï¼Œæ‰€ä»¥è¿˜æ˜¯æœ‰å¿…è¦ä¼˜åŒ–ã€‚grpc çš„ä¼˜åŒ–æ€è·¯æ¯”è¾ƒç®€å•ï¼Œä¸éœ€è¦ç›´æ¥ä¿®æ”¹æºç ï¼Œåªéœ€è¦åœ¨ protoc å‘½ä»¤ç”Ÿæˆ golang ä»£ç æ˜¯ï¼Œå°† golang/protobuf æ¢æˆç¬¬ä¸‰æ–¹çš„ gogo/protobuf ã€‚gogoåº“åŸºäºå®˜æ–¹åº“å¼€å‘ï¼Œå¢åŠ äº†å¾ˆå¤šçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š å¿«é€Ÿçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ– æ›´è§„èŒƒçš„Goæ•°æ®ç»“æ„ goprotobufå…¼å®¹ å¯é€‰æ‹©çš„äº§ç”Ÿä¸€äº›è¾…åŠ©æ–¹æ³•ï¼Œå‡å°‘ä½¿ç”¨ä¸­çš„ä»£ç è¾“å…¥ å¯ä»¥é€‰æ‹©äº§ç”Ÿæµ‹è¯•ä»£ç å’Œbenchmarkä»£ç  å…¶å®ƒåºåˆ—åŒ–æ ¼å¼ æ¯”å¦‚etcdã€k8sã€dgraphã€docker swarmkitéƒ½ä½¿ç”¨å®ƒã€‚åŸºäºé€Ÿåº¦å’Œå®šåˆ¶åŒ–çš„è€ƒè™‘ï¼Œgogoæœ‰ä¸‰ç§äº§ç”Ÿä»£ç çš„æ–¹å¼ gofast: é€Ÿåº¦ä¼˜å…ˆï¼Œä¸æ”¯æŒå…¶å®ƒgogoprotobuf extensionsã€‚ go get github.com/gogo/protobuf/protoc-gen-gofast protoc --gofast_out=. myproto.proto gogofastç±»ä¼¼gofast,ä½†æ˜¯ä¼šå¯¼å…¥gogoprotobuf gogofasterç±»ä¼¼gogofast, ä¸ä¼šäº§ç”ŸXXX_unrecognizedæŒ‡é’ˆå­—æ®µï¼Œå¯ä»¥å‡å°‘åƒåœ¾å›æ”¶æ—¶é—´ã€‚ gogoslickç±»ä¼¼gogofaster,ä½†æ˜¯å¯ä»¥å¢åŠ ä¸€äº›é¢å¤–çš„æ–¹æ³•gostringå’Œequalç­‰ç­‰ã€‚ go get github.com/gogo/protobuf/proto go get github.com/gogo/protobuf/{binary} //protoc-gen-gogofastã€protoc-gen-gogofaster ã€protoc-gen-gogoslick go get github.com/gogo/protobuf/gogoproto protoc -I=. -I=$GOPATH/src -I=$GOPATH/src/github.com/gogo/protobuf/protobuf --{binary}_out=. myproto.proto protoc-gen-gogo: æœ€å¿«çš„é€Ÿåº¦ï¼Œæœ€å¤šçš„å¯å®šåˆ¶åŒ– ä½ å¯ä»¥é€šè¿‡æ‰©å±•å®šåˆ¶åºåˆ—åŒ–: æ‰©å±•. go get github.com/gogo/protobuf/proto go get github.com/gogo/protobuf/jsonpb go get github.com/gogo/protobuf/protoc-gen-gogo go get github.com/gogo/protobuf/gogoproto gogoåŒæ ·æ”¯æŒgrpc: protoc --gofast_out=plugins=grpc:. my.protoã€‚åŒæ—¶è¿˜æœ‰ protobuf å¯¹åº”çš„æ•™ç¨‹ ã€‚ ","date":"2021-12-03","objectID":"/grpc2/:7:0","tags":null,"title":"GPRC è¿›é˜¶","uri":"/grpc2/"},{"categories":null,"content":"iscsiå…±äº«ç£ç›˜æœåŠ¡ iscsiç®€å•ä»‹ç» iSCSIï¼ˆInternet Small Computer System Interfaceï¼Œå‘éŸ³ä¸º/ËˆĞ°ÉªskÊŒzi/ï¼‰ï¼ŒInternetå°å‹è®¡ç®—æœºç³»ç»Ÿæ¥å£ï¼Œåˆç§°ä¸ºIP-SANï¼Œæ˜¯ä¸€ç§åŸºäºå› ç‰¹ç½‘åŠSCSI-3åè®®ä¸‹çš„å­˜å‚¨æŠ€æœ¯ï¼Œç”±IETFæå‡ºï¼Œå¹¶äº2003å¹´2æœˆ11æ—¥æˆä¸ºæ­£å¼çš„æ ‡å‡†ã€‚ä¸ä¼ ç»Ÿçš„SCSIæŠ€æœ¯æ¯”è¾ƒèµ·æ¥ï¼ŒiSCSIæŠ€æœ¯æœ‰ä»¥ä¸‹ä¸‰ä¸ªé©å‘½æ€§çš„å˜åŒ–ï¼š æŠŠåŸæ¥åªç”¨äºæœ¬æœºçš„SCSIåä¹‰é€è¿‡TCP/IPç½‘ç»œå‘é€ï¼Œä½¿è¿æ¥è·ç¦»å¯ä½œæ— é™çš„åœ°åŸŸå»¶ä¼¸ï¼› è¿æ¥çš„æœåŠ¡å™¨æ•°é‡æ— é™ï¼ˆåŸæ¥çš„SCSI-3çš„ä¸Šé™æ˜¯15ï¼‰ï¼› ç”±äºæ˜¯æœåŠ¡å™¨æ¶æ„ï¼Œå› æ­¤ä¹Ÿå¯ä»¥å®ç°åœ¨çº¿æ‰©å®¹ä»¥è‡³åŠ¨æ€éƒ¨ç½²ã€‚ ç®€å•çš„è¯´å°±æ˜¯tcpåè®®ä»¿çœŸscsiï¼Œå°†æœ¬åœ°çš„ç£ç›˜é€šè¿‡ç½‘ç»œå…±äº«ç»™å…¶ä»–æœºå™¨ï¼Œæä¾›æ•°æ®çš„è¿œç¨‹å­˜å‚¨ã€‚ iscsiåŸºæœ¬æ¦‚å¿µ iscsiä¸­æœ‰ä¸€äº›å¸¸ç”¨çš„åŸºæœ¬æ¦‚å¿µï¼Œäº†è§£è¿™äº›èƒ½å¸®åŠ©æˆ‘ä»¬è®¤è¯†iscsiæœåŠ¡çš„å…·ä½“å·¥ä½œåŸç†ï¼Œä¸‹é¢å°±ç”¨ä¸€å¼ å›¾è¡¨æ¥è¯´æ˜ï¼š åè¯ è¯´æ˜ ACL è®¿é—®æƒé™æ§åˆ¶åˆ—è¡¨ï¼Œç”¨æ¥éªŒè¯å®¢æˆ·ç«¯å¯åŠ¨å™¨çš„è®¿é—®ï¼Œé€šå¸¸æ˜¯å®¢æˆ·ç«¯ iSCSI å¯åŠ¨å™¨çš„ IQN åç§° IQN ç”¨äºæ ‡è¯†å•ä¸ª iSCSI ç›®æ ‡å’Œå¯åŠ¨å™¨çš„å”¯ä¸€åç§°(å…¨éƒ¨å°å†™) WWN ç”¨äºæ ‡è¯†å•ä¸ªå…‰çº¤é€šé“ç«¯å£å’ŒèŠ‚ç‚¹çš„å”¯ä¸€ç¼–å· TARGET iSCSI æœåŠ¡å™¨ä¸Šçš„å­˜å‚¨èµ„æº LUN iSCSI æœåŠ¡å™¨ä¸Šçš„å—è®¾å¤‡ initiator(å¯åŠ¨å™¨) ä»¥è½¯ä»¶æˆ–ç¡¬ä»¶å®æ–½çš„ iSCSI å®¢æˆ·ç«¯ NODE å•ä¸ª iSCSI å¯åŠ¨å™¨æˆ–è€…ç›®æ ‡ TPG å¯åŠ¨å™¨æˆ–è€…ç›®æ ‡ä¸Šçš„å•ä¸ª IP è¿æ¥åœ°å€ Portal ç½‘ç»œæ¥å£åŠç«¯å£ iscsi å®‰è£…é…ç½® iscsi æœåŠ¡ç®¡ç†çš„è½¯ä»¶æœ‰å¤šä¸ªï¼Œè¿™é‡Œå°±ç®€å•ä»‹ç»ä¸¤ä¸ªï¼Œtargetcliå’Œtgtã€‚ ","date":"2021-12-03","objectID":"/iscsi%E5%85%B1%E4%BA%AB%E7%A3%81%E7%9B%98%E6%9C%8D%E5%8A%A1/:0:0","tags":null,"title":"iscsiå…±äº«ç£ç›˜æœåŠ¡","uri":"/iscsi%E5%85%B1%E4%BA%AB%E7%A3%81%E7%9B%98%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":"ä½¿ç”¨targetcliç®¡ç†é…ç½®iscsi 1.å‡†å¤‡é˜¶æ®µ æœ‰ä¸¤å°linuxæœºå™¨ï¼Œåˆ†åˆ«ä½œä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ã€‚å®éªŒç¯å¢ƒæœ€å¥½åœ¨è™šæ‹Ÿæœºä¸Šï¼Œæ–¹ä¾¿ä¿®æ”¹çš„åå¤æ“ä½œã€‚åŒæ—¶åœ¨æœåŠ¡ç«¯ä¸Šæœ‰ä¸€å—ç£ç›˜ä½œä¸ºiscsiå…±äº«ç£ç›˜ã€‚ [root@localhost ~]# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 40G 0 disk â”œâ”€sda1 8:1 0 500M 0 part /boot â”œâ”€sda2 8:2 0 4G 0 part [SWAP] â””â”€sda3 8:3 0 35.5G 0 part / sdb 8:16 0 10G 0 disk â””â”€sdb1 8:17 0 10G 0 part sdc 8:32 0 10G 0 disk sr0 11:0 1 1024M 0 rom è¿™ä¸ªé€‰æ‹©/dev/sdb1,æ²¡æœ‰çš„åŒå­¦å¯ä»¥ä½¿ç”¨fdiskå‘½ä»¤è‡ªå·±åˆ†é…ä¸€ä¸ªã€‚ 2.å®‰è£…targetcli yum install -y targetcli è¿˜éœ€è¦å¯åŠ¨targetcliæœåŠ¡ systemctl start target 3.é…ç½®targetcli é…ç½®targetcliæœ‰å‡ ä¸ªæ­¥éª¤ï¼Œæ·»åŠ targetï¼Œåœ¨targetä¸Šæ·»åŠ lunï¼Œå°†targetå…±äº«åˆ°æŒ‡å®šç½‘æ®µã€‚ å…ˆæ¥åˆ›å»ºä¸€ä¸ªå—è®¾å¤‡ï¼Œä½¿ç”¨å‘½ä»¤ä¸ºï¼š /backstores/block create westos:storage1 /dev/sdb1 è¿›å…¥targetcliæ“ä½œï¼š [root@localhost ~]# targetcli Warning: Could not load preferences file /root/.targetcli/prefs.bin. targetcli shell version 2.1.fb46 Copyright 2011-2013 by Datera, Inc and others. For help on commands, type 'help'. /\u003e /backstores/block create westos:storage1 /dev/sdb1 Created block storage object westos:storage1 using /dev/sdb1. # æ³¨æ„è¿™é‡Œå°±æˆåŠŸåˆ›å»ºä¸€ä¸ªå¿«è®¾å¤‡ /\u003e ls o- / ......................................................................................................................... [...] o- backstores .............................................................................................................. [...] | o- block .................................................................................................. [Storage Objects: 1] | | o- westos:storage1 .............................................................. [/dev/sdb1 (0 bytes) write-thru deactivated] | | o- alua ................................................................................................... [ALUA Groups: 1] | | o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized] | o- fileio ................................................................................................. [Storage Objects: 0] | o- pscsi .................................................................................................. [Storage Objects: 0] | o- ramdisk ................................................................................................ [Storage Objects: 0] o- iscsi ............................................................................................................ [Targets: 0] o- loopback ......................................................................................................... [Targets: 0] /\u003e æ¥ç€åˆ›å»ºä¸€ä¸ªiscsiå…±äº«çš„targetï¼Œä½¿ç”¨å‘½ä»¤ä¸ºï¼š /iscsi create iqn.2018-10.com.westos:storage1 è¿™é‡Œçš„targetåç§°å…¶å®å¯ä»¥éšæ„ï¼Œä½†ä¸€èˆ¬æ ¼å¼ä¸ºiqn.year.month.com.domain.xxx, æ‰§è¡Œçš„ç»“æœå¦‚ä¸‹ï¼š /\u003e /iscsi create iqn.2018-10.com.westos:storage1 Created target iqn.2018-10.com.westos:storage1. Created TPG 1. Global pref auto_add_default_portal=true Created default portal listening on all IPs (0.0.0.0), port 3260. /\u003e ls o- / ......................................................................................................................... [...] o- backstores .............................................................................................................. [...] | o- block .................................................................................................. [Storage Objects: 1] | | o- westos:storage1 .............................................................. [/dev/sdb1 (0 bytes) write-thru deactivated] | | o- alua ................................................................................................... [ALUA Groups: 1] | | o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized] | o- fileio ................................................................................................. [Storage Objects: 0] | o- pscsi .................................................................................................. [Storage Objects: 0] | o- ramdisk ................................................................................................ [Storage Objects: 0] o- iscsi ........................","date":"2021-12-03","objectID":"/iscsi%E5%85%B1%E4%BA%AB%E7%A3%81%E7%9B%98%E6%9C%8D%E5%8A%A1/:1:0","tags":null,"title":"iscsiå…±äº«ç£ç›˜æœåŠ¡","uri":"/iscsi%E5%85%B1%E4%BA%AB%E7%A3%81%E7%9B%98%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":"ä½¿ç”¨tgté…ç½®iscsi å†æ¥ä»‹ç»å¦å¤–ä¸€ç§è½¯ä»¶ï¼Œå°±æ˜¯tgtã€‚ 1.å®‰è£… yum install -y epel-release yum install -y scsi-target-utils å¯åŠ¨æœåŠ¡ systemctl start tgtd 2.é…ç½®tgt é…ç½®tgtä½¿ç”¨çš„å‘½ä»¤æ˜¯tgtadmï¼Œæœ‰ä»¥ä¸‹å¸¸ç”¨é€‰é¡¹ï¼š â€“lld â€“mode target â€“op new â€“tid â€“targetname # æ–°å»ºtarget â€“lld â€“mode target â€“op delete [â€“force] â€“tid # åˆ é™¤target â€“lld â€“mode target â€“op show # æŸ¥çœ‹æ‰€æœ‰çš„target â€“lld â€“mode target â€“op show â€“tid # æŸ¥çœ‹æŒ‡å®šidçš„target â€“lld â€“mode target â€“op update â€“tid â€“name â€“value # æ›´æ–°target â€“lld â€“mode target â€“op bind â€“tid â€“initiator-address # targetå…±äº«åˆ°æŒ‡å®šç½‘æ®µ â€“lld â€“mode target â€“op bind â€“tid â€“initiator-name # targetå…±äº«åˆ°æŒ‡å®šçš„å®¢æˆ·ç«¯åç§° â€“lld â€“mode target â€“op unbind â€“tid â€“initiator-address # è§£ç»‘ â€“lld â€“mode target â€“op unbind â€“tid â€“initiator-name â€“lld â€“mode logicalunit â€“op new â€“tid â€“lun â€“backing-store â€“bstype â€“bsopts â€“bsoflags # åˆ›å»ºlun â€“lld â€“mode logicalunit â€“op delete â€“tid â€“lun # åˆ é™¤lun â€“lld â€“mode account â€“op new â€“user â€“password # æ·»åŠ è®¤è¯ â€“lld â€“mode account â€“op delete â€“user # åˆ é™¤è®¤è¯ â€“lld â€“mode account â€“op bind â€“tid â€“user [â€“outgoing] # ç»‘å®šè®¤è¯ â€“lld â€“mode account â€“op unbind â€“tid â€“user [â€“outgoing] # è§£ç»‘è®¤è¯ æ·»åŠ target [root@localhost ~]# tgtadm --lld iscsi --mode target --op new --tid 1 --targetname iqn-2019-11.com.iscsi.test [root@localhost ~]# tgtadm --lld iscsi --mode target --op show Target 1: iqn-2019-11.com.iscsi.test System information: Driver: iscsi State: ready I_T nexus information: LUN information: LUN: 0 Type: controller SCSI ID: IET 00010000 SCSI SN: beaf10 Size: 0 MB, Block size: 1 Online: Yes Removable media: No Prevent removal: No Readonly: No SWP: No Thin-provisioning: No Backing store type: null Backing store path: None Backing store flags: Account information: ACL information: æ·»åŠ lun [root@localhost ~]# tgtadm --lld iscsi --mode logicalunit --op new --tid 1 --lun 22 -b /dev/sdb [root@localhost ~]# tgtadm --lld iscsi --mode target --op show Target 1: iqn-2019-11.com.iscsi.test System information: Driver: iscsi State: ready I_T nexus information: LUN information: LUN: 0 Type: controller SCSI ID: IET 00010000 SCSI SN: beaf10 Size: 0 MB, Block size: 1 Online: Yes Removable media: No Prevent removal: No Readonly: No SWP: No Thin-provisioning: No Backing store type: null Backing store path: None Backing store flags: LUN: 22 Type: disk SCSI ID: IET 00010016 SCSI SN: beaf122 Size: 10737 MB, Block size: 512 Online: Yes Removable media: No Prevent removal: No Readonly: No SWP: No Thin-provisioning: No Backing store type: rdwr Backing store path: /dev/sdb Backing store flags: Account information: ACL information: æ³¨ï¼šè¿™é‡Œæœ‰ä¸€ä¸ªå°æç¤ºï¼Œæ¯ä¸ªlunä¸­çš„SCSI IDé¡¹æ˜¯åœ¨å®¢æˆ·ç«¯ä¸­çš„å”¯ä¸€æ ‡è¯†ï¼Œå®ƒçš„å€¼æ˜¯æ ¹æ®target idå’Œlun idè®¡ç®—å¾—åˆ°çš„ï¼Œå³ï¼š SCSI ID = Target IDè½¬16è¿›åˆ¶(å‰å››ä½) + Lun IDè½¬16è¿›åˆ¶(åå››ä½) æ‰€ä»¥lun 22çš„SCSI IDä¸º00010016 å…±äº«åˆ°å®¢æˆ·ç«¯ï¼š [root@localhost ~]# tgtadm --lld iscsi --mode target --op bind --tid 1 --initiator-address 192.168.3.131 ","date":"2021-12-03","objectID":"/iscsi%E5%85%B1%E4%BA%AB%E7%A3%81%E7%9B%98%E6%9C%8D%E5%8A%A1/:2:0","tags":null,"title":"iscsiå…±äº«ç£ç›˜æœåŠ¡","uri":"/iscsi%E5%85%B1%E4%BA%AB%E7%A3%81%E7%9B%98%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":"å®¢æˆ·ç«¯è¿æ¥ 1.å®‰è£…å®¢æˆ·ç«¯ yum install -y epel-release yum install -y iscsi-initiator-utils å®¢æˆ·ç«¯å‘½ä»¤ï¼š iscsiadm -m session # æŸ¥çœ‹æ‰€æœ‰ä¼šè¯ iscsiadm -m discovery -t st -p 192.168.3.150 #æŸ¥çœ‹å…±äº«target iscsiadm -m node -T iqn.2018-10.com.westos:storage1 -p 192.168.3.150 -l #ç™»é™†è¿æ¥ iscsiadm -m node -T iqn.2018-10.com.westos:storage1 -u #é€€å‡ºç™»é™† iscsiadm -m node -T iqn.2018-10.com.westos:storage1 -o delete #åˆ é™¤ç™»é™†æ•°æ® 2.å‘ç°è®¾å¤‡ [root@localhost ~]# iscsiadm -m discovery -t st -p 192.168.3.150 192.168.3.150:3260,1 iqn.2018-10.com.westos:storage1 ç™»å½• æ³¨ï¼šè¯·å…³é—­é˜²ç«å¢™å’Œselinux [root@localhost mnt]# iscsiadm -m node -T iqn.2018-10.com.westos:storage1 -p 192.168.3.150 -l Logging in to [iface: default, target: iqn.2018-10.com.westos:storage1, portal: 192.168.3.150,3260] (multiple) Login to [iface: default, target: iqn.2018-10.com.westos:storage1, portal: 192.168.3.150,3260] successful. [root@localhost ~]# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT fd0 2:0 1 4K 0 disk sda 8:0 0 40G 0 disk â”œâ”€sda1 8:1 0 500M 0 part /boot â”œâ”€sda2 8:2 0 8G 0 part [SWAP] â””â”€sda3 8:3 0 31.5G 0 part / sdb 8:16 0 2G 0 disk â””â”€sdb1 8:17 0 2G 0 part sr0 11:0 1 1024M 0 rom åŒæ—¶åœ¨/dev/disk/by-idä¸‹ç”Ÿæˆå—è®¾å¤‡ã€‚ ","date":"2021-12-03","objectID":"/iscsi%E5%85%B1%E4%BA%AB%E7%A3%81%E7%9B%98%E6%9C%8D%E5%8A%A1/:3:0","tags":null,"title":"iscsiå…±äº«ç£ç›˜æœåŠ¡","uri":"/iscsi%E5%85%B1%E4%BA%AB%E7%A3%81%E7%9B%98%E6%9C%8D%E5%8A%A1/"},{"categories":null,"content":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç† æœ¬ç¯‡æ–‡ç« ä»‹ç» KVM è™šæ‹Ÿæœºçš„ç®¡ç†ï¼ŒåŒ…æ‹¬è™šæ‹Ÿæœºçš„åˆ›å»ºã€ä¿®æ”¹ã€å¯åŠ¨ã€åˆ é™¤ç­‰å†…å®¹ å®‰è£…è™šæ‹Ÿæœº ","date":"2021-12-03","objectID":"/kvm_vm/:0:0","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"ä½¿ç”¨ virt-install å®‰è£… virt-install æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œä¸“é—¨ç”¨äºå®‰è£… kvm è™šæ‹Ÿæœºã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š virt-install \\ --name centos \\ --ram 1024 \\ --disk path=/data/kvm/centos.img,size=20 \\ --vcpus 1 \\ --os-type linux --os-variant rhel7 \\ --network bridge=br0 \\ --graphics vnc,listen=0.0.0.0,port=5999 --noautoconsole \\ --console pty,target_type=serial \\ --cdrom CentOS-7-x86_64-DVD-1810.iso è¿›å…¥å®‰è£…æµç¨‹ï¼š # virsh list --all Id åç§° çŠ¶æ€ ---------------------------------------------------- 2 centos running å¯ä»¥ä½¿ç”¨ vnc å®¢æˆ·ç«¯è¿æ¥è™šæ‹Ÿæœºã€‚ å‚æ•°è¯´æ˜ï¼š -â€“name æŒ‡å®šè™šæ‹Ÿæœºçš„åå­— â€“-ram æŒ‡å®šå†…å­˜åˆ†é…å¤šå°‘ â€“-disk path æŒ‡å®šè™šæ‹Ÿç£ç›˜æ”¾åˆ°å“ªé‡Œï¼Œsize=30 æŒ‡å®šç£ç›˜å¤§å°ä¸º30G,è¿™æ ·ç£ç›˜æ–‡ä»¶æ ¼å¼ä¸ºrawï¼Œrawæ ¼å¼ä¸èƒ½åšå¿«ç…§ï¼Œåé¢æœ‰è¯´æ˜ï¼Œéœ€è¦è½¬æ¢ä¸ºqcow2æ ¼å¼ï¼Œå¦‚æœè¦ä½¿ç”¨qcow2æ ¼å¼çš„è™šæ‹Ÿç£ç›˜ï¼Œéœ€è¦äº‹å…ˆåˆ›å»ºqcow2æ ¼å¼çš„è™šæ‹Ÿç£ç›˜ã€‚ å‚è€ƒ http://www.361way.com/kvm-qcow2-preallocation-metadata/3354.html ç¤ºä¾‹:qemu-img create -f qcow2 -o preallocation=metadata /data/test02.img 7G; â€“disk path=/data/test02.img,format=qcow2,size=7,bus=virtio â€“-vcpus æŒ‡å®šåˆ†é…cpuå‡ ä¸ª -â€“os-type æŒ‡å®šç³»ç»Ÿç±»å‹ä¸ºlinux â€“-os-variant æŒ‡å®šç³»ç»Ÿç‰ˆæœ¬ -â€“network æŒ‡å®šç½‘ç»œç±»å‹ -â€“graphics æŒ‡å®šå®‰è£…é€šè¿‡å“ªç§ç±»å‹ï¼Œå¯ä»¥æ˜¯vncï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰å›¾å½¢ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨å›¾å½¢ç›´æ¥ä½¿ç”¨æ–‡æœ¬æ–¹å¼ -â€“console æŒ‡å®šæ§åˆ¶å°ç±»å‹ -â€“location æŒ‡å®šå®‰è£…ä»‹è´¨åœ°å€ï¼Œå¯ä»¥æ˜¯ç½‘ç»œåœ°å€ï¼Œä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°çš„ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œï¼ˆâ€“location â€˜/mnt/â€™, å…¶ä¸­/mnt/ä¸‹å°±æ˜¯æˆ‘ä»¬æŒ‚è½½çš„å…‰ç›˜é•œåƒmount /dev/cdrom /mnt)å¦‚æœæ˜¯ç»å¯¹è·¯å¾„ï¼Œé‚£ä¹ˆåé¢è¿˜éœ€è¦æŒ‡å®šä¸€ä¸ªå®‰è£…ä»‹è´¨ï¼Œæ¯”å¦‚NFS â€“extra-args é¢å¤–å‚æ•°ï¼Œéœ€è¦å’Œ â€“location é…ç½®ä½¿ç”¨ â€“cdrom æŒ‡å®šæ“ä½œç³»ç»Ÿé•œåƒä½ç½® ","date":"2021-12-03","objectID":"/kvm_vm/:1:0","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"é”™è¯¯å¤„ç† å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°ä¸‰ä¸ªé”™è¯¯: ","date":"2021-12-03","objectID":"/kvm_vm/:2:0","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"é”™è¯¯ä¸€ ç¬¬ä¸€ä¸ªé”™è¯¯å¦‚ä¸‹: CPU mode 'custom' for x86_64 kvm domain on x86_64 host is not supported by hypervisor è§£å†³æ–¹å¼æ˜¯é‡å¯å®¿ä¸»æœº ","date":"2021-12-03","objectID":"/kvm_vm/:2:1","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"é”™è¯¯äºŒ ç¬¬äºŒä¸ªé”™è¯¯å¦‚ä¸‹ï¼š Creating storage file centos.img | 20 GB 00:00 ERROR internal error Process exited while reading console log output: char device redirected to /dev/pts/4 2016-01-27T08:56:58.986952Z ...: Permission denied Domain installation does not appear to have been successful. If it was, you can restart your domain by running: virsh --connect qemu:///system start centos65 otherwise, please restart your installation. è§£å†³æ–¹å¼ä¿®æ”¹ /etc/libvirt/qemu.conf é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ  user å’Œ group é…ç½®ï¼š # /etc/libvirt/qemu.conf # ... user = \"root\" # ... group = \"root\" é‡å¯æœåŠ¡: systemctl restart libvirtd ","date":"2021-12-03","objectID":"/kvm_vm/:2:2","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"é”™è¯¯ä¸‰ ç¬¬ä¸‰ä¸ªé”™è¯¯æ˜¯æ‰§è¡Œå‘½ä»¤ virsh console centos æ—¶å¡ä½: # virsh console centos è¿æ¥åˆ°åŸŸ centos æ¢ç ç¬¦ä¸º ^] è§£å†³æ–¹å¼å¦‚ä¸‹ï¼š ç¡®è®¤ ttyS0 å­˜åœ¨åœ¨ /etc/securetty æ–‡ä»¶ä¸­ï¼Œæ²¡æœ‰å°±æ‰§è¡Œä»¥ä¸‹å‘½ä»¤: echo \"ttyS0\" \u003e\u003e /etc/securetty ä¿®æ”¹ /etc/default/grub æ–‡ä»¶ï¼š # GRUB_CMDLINE_LINUX=\"crashkernel=auto rd.lvm.lv=cl/root rd.lvm.lv=cl/swap rhgb quietâ€ # æ”¹æˆ GRUB_CMDLINE_LINUX=\"crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet net.ifnames=0 console=ttyS0,115200\" é‡æ–°ç”Ÿæˆ grub æ–‡ä»¶ï¼š grub2-mkconfig -o /boot/grub2/grub.cfg å¯åŠ¨ serial-getty æœåŠ¡: systemctl start serial-getty@ttyS0.service systemctl enable serial-getty@ttyS0.service æ“ä½œè™šæ‹Ÿæœº KVM åœ¨ Hypervisor ä¸­è¢«ç§°ä½œåŸŸ(domain)ã€‚ä½¿ç”¨ virsh å‘½ä»¤å¯ä»¥å¾ˆæœ‰æ•ˆçš„ç®¡ç†åŸŸã€‚ virsh ä¸­ç®¡ç†åŸŸçš„å‘½ä»¤: å‘½ä»¤ åŠŸèƒ½æè¿° list è·å–å½“å‰èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰åŸŸçš„åˆ—è¡¨ domstate \u003cID or Name or UUID\u003e è·å–ä¸€ä¸ªåŸŸçš„è¿è¡ŒçŠ¶æ€ dominfo \u003cID\u003e è·å–ä¸€ä¸ªåŸŸçš„åŸºæœ¬ä¿¡æ¯ domid \u003cName or UUID\u003e æ ¹æ®åŸŸçš„åç§°æˆ–UUIDè¿”å›åŸŸçš„ID domname \u003cID or UUID\u003e æ ¹æ®åŸŸçš„IDæˆ–UUIDè¿”å›åŸŸçš„åç§° dommemstat \u003cID\u003e è·å–ä¸€ä¸ªåŸŸçš„å†…å­˜ä½¿ç”¨æƒ…å†µçš„ç»Ÿè®¡ä¿¡æ¯ setmem \u003cID\u003e \u003cmem-size\u003e è®¾ç½®ä¸€ä¸ªåŸŸçš„å†…å­˜å¤§å°(é»˜è®¤å•ä½ä¸ºKB) vcpupin \u003cID\u003e \u003cvCPU\u003e \u003cpCPU\u003e å°†ä¸€ä¸ªåŸŸçš„ vCPU ç»‘å®šåˆ°æŸä¸ªç‰©ç† CPU ä¸Šè¿è¡Œ setvcpus \u003cID\u003e \u003cvCPU-num\u003e è®¾ç½®ä¸€ä¸ªåŸŸçš„ vCPU çš„ä¸ªæ•° vncdisplay \u003cID\u003e è·å–ä¸€ä¸ªåŸŸçš„ VNC è¿æ¥ IP åœ°å€çš„ç«¯å£ create \u003cdom.xml\u003e æ ¹æ®åŸŸçš„ XML é…ç½®æ–‡ä»¶åˆ›å»ºä¸€ä¸ªåŸŸ(å®¢æˆ·æœº) suspend \u003cID\u003e æš‚åœä¸€ä¸ªåŸŸ resume \u003cID\u003e å”¤é†’ä¸€ä¸ªåŸŸ shutdown \u003cID\u003e è®©ä¸€ä¸ªåŸŸæ‰§è¡Œå…³æœºæ“ä½œ reboot \u003cID\u003e è®©ä¸€ä¸ªåŸŸæ‰§è¡Œé‡å¯æ“ä½œ reset \u003cID\u003e å¼ºåˆ¶é‡å¯ä¸€ä¸ªåŸŸï¼Œç›¸å½“äºåœ¨ç‰©ç†æœºä¸ŠæŒ‰å¸¦ç”µæº â€œresetâ€ æŒ‰é’® (å¯èƒ½ä¼šç ´åè¯¥åŸŸçš„æ–‡ä»¶ç³»ç»Ÿ) destroy \u003cID\u003e ç«‹å³é”€æ¯ä¸€ä¸ªåŸŸï¼Œç›¸å½“äºç›´æ¥æ‹”æ‰ç‰©ç†æœºæœºå™¨çš„ç”µæºçº¿ï¼ˆå¯èƒ½ä¼šç ´åè¯¥åŸŸçš„æ–‡ä»¶ç³»ç»Ÿï¼‰ save \u003cID\u003e \u003cfile.img\u003e ä¿å­˜ä¸€ä¸ªè¿è¡Œä¸­çš„åŸŸçš„çŠ¶æ€åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ restore \u003cfile.img\u003e ä»ä¸€ä¸ªè¢«ä¿å­˜çš„æ–‡ä»¶ä¸­æ¢å¤ä¸€ä¸ªåŸŸçš„è¿è¡Œ migrate \u003cID\u003e \u003cdest_url\u003e å°†ä¸€ä¸ªåŸŸè¿ç§»åˆ°å¦å¤–ä¸€ä¸ªç›®çš„åœ°å€ dumpxml \u003cID\u003e ä»¥ XML æ ¼å¼è½¬å­˜å‡ºä¸€ä¸ªåŸŸçš„ä¿¡æ¯åˆ°æ ‡å‡†è¾“å‡ºä¸­ attach-device \u003cID\u003e \u003cdevice.xml\u003e å‘ä¸€ä¸ªåŸŸæ·»åŠ  XML æ–‡ä»¶ä¸­çš„è®¾å¤‡(çƒ­æ’æ‹”) detach-device \u003cID\u003e \u003cdevice.xml\u003e å°† XML æ–‡ä»¶ä¸­çš„è®¾å¤‡ä»ä¸€ä¸ªåŸŸä¸­ç§»é™¤ console \u003cID\u003e è¿æ¥åˆ°ä¸€ä¸ªåŸŸçš„æ§åˆ¶å° ","date":"2021-12-03","objectID":"/kvm_vm/:2:3","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"è™šæ‹Ÿæœºç”Ÿå‘½å‘¨æœŸ # å¯åŠ¨è™šæ‹Ÿæœº virsh start centos # å…³é—­è™šæ‹Ÿæœº virsh shutdown centos # é‡å¯è™šæ‹Ÿæœº virsh reboot centos # é”€æ¯è™šæ‹Ÿæœº virsh destroy centos # æš‚åœè™šæ‹Ÿæœº virsh suspend centos # æ¢å¤è™šæ‹Ÿæœº virsh resume centos # åˆ é™¤è™šæ‹Ÿæœº virsh undefine centos rm -fr /etc/libvirt/qemu/centos.xml ","date":"2021-12-03","objectID":"/kvm_vm/:3:0","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"é™åˆ¶å’Œä¿®æ”¹è™šæ‹Ÿæœº cpu å…ˆå…³é—­è™šæ‹Ÿæœºï¼Œä¿®æ”¹è™šæ‹Ÿæœº xml æ–‡ä»¶: # è®¾ç½® cpu æœ€å¤§ä¸ªæ•°ä¸º 4 ä¸ªï¼Œå½“å‰ä¸º 1 \u003cvcpu placement='static' current='1'\u003e4\u003c/vcpu\u003e å¼€å¯è™šæ‹Ÿæœºåï¼ŒåŠ¨æ€è®¾ç½®è™šæ‹Ÿæœº cpu # æœ€å¤§ä¸ªæ•°ä¸èƒ½è¶…è¿‡æŒ‡å®šå€¼ virsh setvcpus centos 2 ","date":"2021-12-03","objectID":"/kvm_vm/:4:0","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"é™åˆ¶å’Œä¿®æ”¹è™šæ‹Ÿæœºå†…å­˜ ä¿®æ”¹è™šæ‹Ÿæœºå†…å­˜æœ€å¤§å€¼éœ€è¦å…ˆå…³é—­è™šæ‹Ÿæœº # æœ€å¤§å€¼ä¸èƒ½è¶…è¿‡å®¿ä¸»æœºå†…å­˜æœ€å¤§å€¼ virsh setmaxmem centos 4G åŠ¨æ€è®¾ç½®è™šæ‹Ÿæœºå†…å­˜ virsh setmem centos 2G ","date":"2021-12-03","objectID":"/kvm_vm/:5:0","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"åœ¨çº¿æ·»åŠ å’Œåˆ é™¤è™šæ‹Ÿæœºç¡¬ç›˜ å…ˆåˆ›å»ºç¡¬ç›˜: # qemu-img create -f qcow2 disk1.qcow2 2G Formatting 'disk1.qcow2', fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=2147483648 lazy_refcounts=off refcount_bits=16 åˆ›å»º disk.xml æ–‡ä»¶ $ vim disk.xml \u003cdisk type='file' device='disk'\u003e \u003cdriver name='qemu' type='qcow2'/\u003e \u003csource file='/data/kvm/disk1.qcow2'/\u003e \u003ctarget dev='vdb' bus='virtio'/\u003e \u003caddress type='pci' domain='0x0000' bus='0x00' slot='0x08' function='0x0'/\u003e \u003c/disk\u003e æ·»åŠ ç¡¬ç›˜è®¾å¤‡: virsh attach-device centos disk.xml å¸è½½ç¡¬ç›˜è®¾å¤‡ virsh dettach-device centos disk.xml ","date":"2021-12-03","objectID":"/kvm_vm/:6:0","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"åœ¨çº¿æ·»åŠ å’Œåˆ é™¤è™šæ‹Ÿæœºç½‘å¡ æ·»åŠ  bridge ç½‘å¡ virsh attach-interface centos --type bridge --source br0 å¸è½½ç½‘å¡ virsh detach-interface centos --type bridge --mac 52:54:00:d9:90:bb ","date":"2021-12-03","objectID":"/kvm_vm/:7:0","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"ä¿®æ”¹è™šæ‹Ÿæœº vnc å…ˆå…³é—­è™šæ‹Ÿæœº virsh stop centos ä¿®æ”¹è™šæ‹Ÿæœºæ–‡ä»¶ # irsh edit centos \u003cgraphics type='vnc' port='6000' autoport='no' listen='0.0.0.0' passwd='123456'\u003e \u003clisten type='address' address='0.0.0.0'/\u003e \u003c/graphics\u003e æ³¨: è™šæ‹Ÿæœº vnc çš„ç«¯å£å¿…é¡»åœ¨ 5900 - 65535 ä¹‹é—´ åŠ è½½é…ç½®æ–‡ä»¶ virsh define /etc/libvirt/qemu/centos.xml æœ€åå¯åŠ¨è™šæ‹Ÿæœº virsh start centos ","date":"2021-12-03","objectID":"/kvm_vm/:8:0","tags":null,"title":"KVMä¹‹è™šæ‹Ÿæœºç®¡ç†","uri":"/kvm_vm/"},{"categories":null,"content":"KVMä»‹ç» KVM æ¦‚è¿° KVM (Kernal-base Virtual Machine) åŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºã€‚æ˜¯ä¸€ç§é€šè¿‡ä¿®æ”¹ linux å†…æ ¸å®ç°è™šæ‹ŸåŒ–åŠŸèƒ½çš„åŠè™šæ‹ŸåŒ–æŠ€æœ¯ã€‚ç”±äºæ˜¯åœ¨å†…æ ¸åŸºç¡€ä¸Šè¿è¡Œï¼Œæ‰€æœ‰å…·æœ‰æ¥è¿‘ç‰©ç†æœºçš„é«˜æ€§èƒ½ã€‚ KVM å’Œ Qemu Qemuï¼ˆquick emulatorï¼‰å¼€æºçš„è½¯ä»¶è™šæ‹ŸåŒ–å®ç°ï¼Œé€šè¿‡è½¯ä»¶æ¥æ¨¡æ‹Ÿç¡¬ä»¶çš„åŠŸèƒ½ï¼Œä½†ç¼ºç‚¹æ˜¯æ€§èƒ½ä½ã€‚é€šè¿‡å’Œ KVM ç›¸ç»“åˆæ¥æé«˜æ€§èƒ½ã€‚ç°åœ¨çš„ç‰ˆæœ¬å·²ç»å†…ç½® KVMã€‚ å…¨è™šæ‹ŸåŒ–å’ŒåŠè™šæ‹ŸåŒ– å…¨è™šæ‹ŸåŒ–æ˜¯æŒ‡ä¸éœ€è¦ä¿®æ”¹æ“ä½œç³»ç»Ÿå†…æ ¸å®ç°è™šæ‹ŸåŒ–åŠŸèƒ½ï¼ŒåŠè™šæ‹ŸåŒ–åˆ™éœ€è¦ä¿®æ”¹å†…æ ¸æ¥å®ç°è™šæ‹ŸåŒ–ã€‚ KVM å°±æ˜¯ä¸€ç§åŠè™šæ‹ŸåŒ–å®ç°ã€‚ å…¨è™šæ‹ŸåŒ–åˆåˆ†ä¸ºè½¯ä»¶å…¨è™šæ‹ŸåŒ– (Qemu) å’Œç¡¬ä»¶å…¨è™šæ‹ŸåŒ–(Xen)ã€‚ KVM å·¥å…·é›†åˆ libvirtï¼šæ“ä½œå’Œç®¡ç†KVMè™šæœºçš„è™šæ‹ŸåŒ– APIï¼Œä½¿ç”¨ C è¯­è¨€ç¼–å†™ï¼Œå¯ä»¥ç”± Python,Ruby, Perl, PHP, Java ç­‰è¯­è¨€è°ƒç”¨ã€‚å¯ä»¥æ“ä½œåŒ…æ‹¬ KVMï¼Œvmwareï¼ŒXENï¼ŒHyper-v, LXC ç­‰åœ¨å†…çš„å¤šç§ Hypervisorã€‚ Virshï¼šåŸºäº libvirt çš„ å‘½ä»¤è¡Œå·¥å…· ï¼ˆCLIï¼‰ Virt-Managerï¼šåŸºäº libvirt çš„ GUI å·¥å…· virt-v2vï¼šè™šæœºæ ¼å¼è¿ç§»å·¥å…· virt-* å·¥å…·ï¼šåŒ…æ‹¬ Virt-install ï¼ˆåˆ›å»ºKVMè™šæœºçš„å‘½ä»¤è¡Œå·¥å…·ï¼‰ï¼Œ Virt-viewer ï¼ˆè¿æ¥åˆ°è™šæœºå±å¹•çš„å·¥å…·ï¼‰ï¼ŒVirt-cloneï¼ˆè™šæœºå…‹éš†å·¥å…·ï¼‰ï¼Œvirt-top ç­‰ sVirtï¼šå®‰å…¨å·¥å…· KVM æ–‡ç«  KVMä»‹ç» KVMæºç åˆ†æ ","date":"2021-12-03","objectID":"/kvm_detail/:0:0","tags":null,"title":"KVMä»‹ç»","uri":"/kvm_detail/"},{"categories":null,"content":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs ç®€ä»‹ libguestfs æ˜¯ä¸€å¥—ç®¡ç†è™šæ‹Ÿæœºé•œåƒçš„å·¥å…·ã€‚å®ƒæä¾›ä»¥ä¸€ç³»åˆ—å‘½ä»¤å’ŒAPIæ¥ä¿®æ”¹å’Œç®¡ç†è™šæ‹Ÿæœºçš„é•œåƒã€‚ å®‰è£… ç›´æ¥ä½¿ç”¨ yum å®‰è£… libguestfs : yum install -y libguestfs-tool libguestfs-devel é»˜è®¤ä¸æ”¯æŒä¿®æ”¹ windows é•œåƒï¼Œå¯ä»¥å®‰è£… libguestfs-winsupport : yum install -y libguestfs-winsupport libguestfs å‘½ä»¤ libguestfs çš„é€šç”¨å‚æ•° -a|â€“add image : æŒ‡å®šæŸ¥çœ‹çš„é•œåƒæ–‡ä»¶è·¯å¾„ -c|â€“connect uri : æŒ‡å®šè¿œç¨‹ libvirt åœ°å€ -d|â€“domain guest : æŒ‡å®š libvirt ä¸Šçš„ domain åç§° æ³¨: libguestfs çš„å‘½ä»¤éœ€è¦è°ƒç”¨ libvirt æ‰€ä»¥å“åº”çš„é€Ÿåº¦ä¼šæ¯”è¾ƒæ…¢ã€‚åŒæ—¶ï¼Œå¦‚æœå‘½ä»¤ä¼šä¿®æ”¹é•œåƒçš„å†…å®¹ï¼Œéœ€è¦å…ˆå…³é—­åŸŸï¼Œé¿å…é€ æˆæ•°æ®ä¸åŒæ­¥ã€‚ ","date":"2021-12-03","objectID":"/libguestfs/:0:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-inspector virt-inspector å‘½ä»¤ç”¨æ¥æŸ¥çœ‹é•œåƒä¿¡æ¯ï¼Œè¾“å‡ºæ ¼å¼ä¸º xml $ virt-inspector -d centos \u003c?xml version=\"1.0\"?\u003e \u003coperatingsystems\u003e \u003coperatingsystem\u003e \u003croot\u003e/dev/centos/root\u003c/root\u003e \u003cname\u003elinux\u003c/name\u003e \u003carch\u003ex86_64\u003c/arch\u003e \u003cdistro\u003ecentos\u003c/distro\u003e \u003cproduct_name\u003eCentOS Linux release 7.6.1810 (Core) \u003c/product_name\u003e \u003cmajor_version\u003e7\u003c/major_version\u003e \u003cminor_version\u003e6\u003c/minor_version\u003e \u003cpackage_format\u003erpm\u003c/package_format\u003e \u003cpackage_management\u003eyum\u003c/package_management\u003e \u003chostname\u003elocalhost.localdomain\u003c/hostname\u003e \u003cosinfo\u003ecentos7.0\u003c/osinfo\u003e \u003cmountpoints\u003e \u003cmountpoint dev=\"/dev/centos/root\"\u003e/\u003c/mountpoint\u003e \u003cmountpoint dev=\"/dev/sda1\"\u003e/boot\u003c/mountpoint\u003e \u003c/mountpoints\u003e \u003cfilesystems\u003e \u003cfilesystem dev=\"/dev/centos/root\"\u003e \u003ctype\u003exfs\u003c/type\u003e \u003cuuid\u003e12e94e0d-93e6-4714-9c61-116fbe994936\u003c/uuid\u003e \u003c/filesystem\u003e ... ... \u003cxml\u003e ","date":"2021-12-03","objectID":"/libguestfs/:1:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-watch virt-watch æŸ¥çœ‹æœ¬æœºè™šæ‹ŸåŒ–ç¯å¢ƒ $ virt-what vmware ","date":"2021-12-03","objectID":"/libguestfs/:2:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-host-validator virt-host-validator æ£€æŸ¥æœ¬åœ°ç¯å¢ƒæ˜¯å¦ç¬¦åˆè™šæ‹ŸåŒ– $ virt-host-validate QEMU: æ­£åœ¨æ£€æŸ¥ for hardware virtualization : PASS QEMU: æ­£åœ¨æ£€æŸ¥ if device /dev/kvm exists : PASS QEMU: æ­£åœ¨æ£€æŸ¥ if device /dev/kvm is accessible : PASS QEMU: æ­£åœ¨æ£€æŸ¥ if device /dev/vhost-net exists : PASS ... ... ","date":"2021-12-03","objectID":"/libguestfs/:3:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-get-kernel virt-get-kernel è·å–é•œåƒçš„å†…æ ¸æ–‡ä»¶ $ virt-get-kernel -d centos download: /boot/vmlinuz-3.10.0-957.el7.x86_64 -\u003e ./vmlinuz-3.10.0-957.el7.x86_64 download: /boot/initramfs-3.10.0-957.el7.x86_64.img -\u003e ./initramfs-3.10.0-957.el7.x86_64.img ","date":"2021-12-03","objectID":"/libguestfs/:4:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-filesystems virt-filesystems æŸ¥çœ‹é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿ $ virt-filesystems -d centos /dev/sda1 /dev/centos/root ","date":"2021-12-03","objectID":"/libguestfs/:5:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-df virt-df ç”¨æ¥æŸ¥çœ‹é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿå®¹é‡ï¼ŒåŒ df å‘½ä»¤ $ virt-df -d centos -h æ–‡ä»¶ç³»ç»Ÿ å¤§å° å·²ç”¨ç©ºé—´ å¯ç”¨ç©ºé—´ ä½¿ç”¨ç™¾åˆ†æ¯”% centos:/dev/sda1 1014M 100M 914M 10% centos:/dev/centos/root 17G 974M 16G 6% ","date":"2021-12-03","objectID":"/libguestfs/:6:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-ls virt-ls æŸ¥çœ‹é•œåƒçš„æ–‡ä»¶ä¿¡æ¯ï¼ŒåŒ ls å‘½ä»¤ $ virt-ls -d centos /root/ -l total 28 dr-xr-x---. 2 root root 135 Jan 26 15:07 . dr-xr-xr-x. 17 root root 224 Jan 16 09:56 .. -rw-------. 1 root root 45 Jan 26 15:07 .bash_history -rw-r--r--. 1 root root 18 Dec 29 2013 .bash_logout -rw-r--r--. 1 root root 176 Dec 29 2013 .bash_profile -rw-r--r--. 1 root root 176 Dec 29 2013 .bashrc -rw-r--r--. 1 root root 100 Dec 29 2013 .cshrc -rw-r--r--. 1 root root 129 Dec 29 2013 .tcshrc -rw-------. 1 root root 1259 Jan 16 09:57 anaconda-ks.cfg ","date":"2021-12-03","objectID":"/libguestfs/:7:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-cat virt-cat æŸ¥çœ‹é•œåƒå†…çš„æ–‡ä»¶å†…å®¹ï¼ŒåŒ cat å‘½ä»¤ $ virt-cat -d centos /etc/passwd root:xx:0:0:root:/root:/bin/bash ... ... ","date":"2021-12-03","objectID":"/libguestfs/:8:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-log virt-log æŸ¥çœ‹é•œåƒçš„æ—¥å¿—ä¿¡æ¯ $ virt-log -d centos Jan 30 20:13:01 localhost rsyslogd: [origin software=\"rsyslogd\" swVersion=\"8.24.0-34.el7\" x-pid=\"3123\" x-info=\"http://www.rsyslog.com\"] rsyslogd was HUPed Jan 30 20:33:37 localhost qemu-ga: info: guest-shutdown called, mode: powerdown Jan 30 20:33:37 localhost systemd: Started Delayed Shutdown Service. ","date":"2021-12-03","objectID":"/libguestfs/:9:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-tail virt-tail ç›‘å¬æ–‡ä»¶å†…å®¹ï¼ŒåŒ tail å‘½ä»¤ $ virt-tail -d centos /var/log/messages --- /var/log/messages --- ... ","date":"2021-12-03","objectID":"/libguestfs/:10:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-alignment-scan virt-alignment-scan æŸ¥çœ‹é•œåƒåˆ†åŒºæ˜¯å¦å¯¹é½ $ virt-alignment-scan -a centos.qcow2 /dev/sda1 1048576 1024K ok /dev/sda2 1074790400 1024K ok ","date":"2021-12-03","objectID":"/libguestfs/:11:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-diff virt-diff æ¯”è¾ƒé•œåƒé—´çš„ä¸åŒ $ # virt-diff -a centos.qcow2 -A centos.img - d 0550 150 /root + d 0550 135 /root # changed: st_size - - 0644 4 /root/kvm.txt - d 1777 187 /tmp + d 1777 172 /tmp # changed: st_size - - 0644 4 /tmp/kvm.txt ","date":"2021-12-03","objectID":"/libguestfs/:12:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-sparisify virt-sparisify ç”¨æ¥æ¶ˆé™¤é•œåƒå†…çš„ç©ºæ´æ–‡ä»¶ï¼Œå‡å°‘é•œåƒå¤§å° $ virt-sparsify centos.qcow2 -f qcow2 centos2.qcow2 [ 0.0] Create overlay file in /tmp to protect source disk [ 0.0] Examine source disk [ 3.4] Fill free space in /dev/centos/root with zero 100% âŸ¦â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’âŸ§ 00:00 [ 33.5] Clearing Linux swap on /dev/centos/swap 100% âŸ¦â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’âŸ§ --:-- [ 36.2] Fill free space in /dev/sda1 with zero [ 38.5] Copy to destination and make sparse [ 51.4] Sparsify operation completed with no errors. virt-sparsify: Before deleting the old disk, carefully check that the target disk boots and works correctly. æ‰§è¡Œå®Œæˆåç”Ÿæˆ centos2.qcow2 æ–‡ä»¶: $ ll -h æ€»ç”¨é‡ 4.0G -rw-r--r-- 1 root root 1.1G 1æœˆ 30 23:39 centos2.qcow2 -rw-r--r-- 1 root root 1.5G 1æœˆ 30 20:33 centos.img -rw-r--r-- 1 root root 1.5G 1æœˆ 30 20:43 centos.qcow2 ","date":"2021-12-03","objectID":"/libguestfs/:13:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-copy-in virt-copy-in å°†æœ¬åœ°æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­ $ virt-copy-in -a centos.qcow2 kvm.txt /tmp/ $ virt-ls -a centos.qcow2 /tmp/ kvm.txt ","date":"2021-12-03","objectID":"/libguestfs/:14:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-copy-out virt-copy-out å°†é•œåƒä¸­çš„æ–‡ä»¶å¤åˆ¶åˆ°æœ¬åœ° $ virt-copy-out -a centos.qcow2 /tmp/kvm.txt . ","date":"2021-12-03","objectID":"/libguestfs/:15:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-edit virt-edit ç¼–è¯‘é•œåƒå†…çš„æ–‡ä»¶ï¼Œé»˜è®¤ä¼šæ‰“å¼€æœ¬åœ°çš„ Vim è¿›è¡Œç¼–è¾‘ $ virt-edit -a centos.qcow2 /tmp/kvm.txt $ virt-cat -a centos.qcow2 /tmp/kvm.txt kvm kvm11 ","date":"2021-12-03","objectID":"/libguestfs/:16:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-make-fs virt-make-fs æ ¹æ®æœ¬åœ°çš„ç›®å½•åˆ›å»ºä¸€ä¸ªé•œåƒ $ mkdir /input $ echo \"input\" \u003e /input/1.txt $ virt-make-fs --partition=gpt --type=ntfs --size=1G --format=qcow2 /input sdb.qcow2 ","date":"2021-12-03","objectID":"/libguestfs/:17:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-tar-in virt-tar-in tar å‹ç¼©æ–‡ä»¶æ‹·è´è¿›è™šæ‹Ÿæœºå¹¶è§£å‹ $ virt-tar-in -a centos.qcow2 kvm.tar /root/ ","date":"2021-12-03","objectID":"/libguestfs/:18:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-tar-out virt-tar-out é•œåƒå†…æŒ‡å®šç›®å½•æ–‡ä»¶æ‹·è´å¹¶å‹ç¼© $ virt-tar-out -a centos.qcow2 /root root.tar ","date":"2021-12-03","objectID":"/libguestfs/:19:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"guestmount guestmount å°†é•œåƒä¸­çš„æ–‡ä»¶ç³»ç»Ÿåˆ†åŒºæŒ‚è½½åˆ°æœ¬åœ°ç›®å½• $ guestmount -a centos.qcow2 -m /dev/sda1 /mnt ","date":"2021-12-03","objectID":"/libguestfs/:20:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"guestumount guestumount å¸è½½ guestmount æŒ‚è½½çš„ç›®å½• $ guestumount /mnt ","date":"2021-12-03","objectID":"/libguestfs/:21:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-rescue virt-rescue è¿›å…¥æ•‘æ´æ¨¡å¼ï¼Œä¿®å¤é•œåƒ $ virt-rescue -a centos.qcow2 ","date":"2021-12-03","objectID":"/libguestfs/:22:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"virt-resize virt-resize é•œåƒåˆ†åŒºç¼©å®¹å’Œæ‰©å®¹ ç»™å…¶ä¸­æŸä¸ªåˆ†åŒºæ‰©å®¹ 5G $ virt-filesystems --long -h --all -a olddisk $ truncate -r olddisk newdisk $ truncate -s +5G newdisk $ virt-resize --expand /dev/sda2 olddisk newdisk /boot åˆ†åŒºæ‰©å®¹ 200MB bigger, å‰©ä¸‹çš„åˆ†é…ç»™ /dev/sda2: $ virt-resize --resize /dev/sda1=+200M --expand /dev/sda2 olddisk newdisk lvm åˆ†åŒºæ‰©å®¹ $ virt-resize --expand /dev/sda2 --LV-expand /dev/vg_guest/lv_root olddisk newdisk ","date":"2021-12-03","objectID":"/libguestfs/:23:0","tags":null,"title":"KVMé•œåƒç®¡ç†å·¥å…·libguestfs","uri":"/libguestfs/"},{"categories":null,"content":"linuxä¸Šä½¿ç”¨udevåˆ›å»ºè£¸è®¾å¤‡ éœ€æ±‚å’Œåˆ†æ åœ¨ä¸€æ¬¡é¡¹ç›®ä¸­éœ€è¦å°†è¿›è¡Œoracleæ•°æ®åº“çš„å¤‡ä»½ï¼Œè¦æ±‚åœ¨oracleæœºå™¨æ€»æ˜¯èƒ½è®¤åˆ°å¤‡ä»½çš„å—è®¾å¤‡çš„è·¯å¾„ä»¥ä¿è¯å¤‡ä»½å’Œæ¢å¤çš„æ­£å¸¸ã€‚åŒæ—¶è¿˜éœ€è¦å¯¹ç£ç›˜è¿›è¡Œä¿®æ”¹ï¼Œè½¬åŒ–ä¸­asmæ ¼å¼çš„ã€‚ åŸºäºè¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨linuxä¸­å°†ç£ç›˜è½¬åŒ–æˆå¯¹åº”çš„è£¸è®¾å¤‡æ˜¯ä¸€ç§åˆé€‚çš„æ–¹æ³•ã€‚ ç®€å•çš„æ“ä½œå°±æ˜¯å°†é…ç½®å†™å…¥/etc/udev/rule.d/1401-oracle-asmdevice.rulesæ–‡ä»¶ä¸­ï¼Œè®©udevç®¡ç†ã€‚ udev è§„åˆ™çš„åŒ¹é…é”® ACTIONï¼š äº‹ä»¶ (uevent) çš„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼šadd( æ·»åŠ è®¾å¤‡ )ã€remove( åˆ é™¤è®¾å¤‡ )ã€‚ KERNELï¼š å†…æ ¸è®¾å¤‡åç§°ï¼Œä¾‹å¦‚ï¼šsda, cdromã€‚ DEVPATHï¼šè®¾å¤‡çš„ devpath è·¯å¾„ã€‚ SUBSYSTEMï¼š è®¾å¤‡çš„å­ç³»ç»Ÿåç§°ï¼Œä¾‹å¦‚ï¼šsda çš„å­ç³»ç»Ÿä¸º blockã€‚ BUSï¼š è®¾å¤‡åœ¨ devpath é‡Œçš„æ€»çº¿åç§°ï¼Œä¾‹å¦‚ï¼šusbã€‚ DRIVERï¼š è®¾å¤‡åœ¨ devpath é‡Œçš„è®¾å¤‡é©±åŠ¨åç§°ï¼Œä¾‹å¦‚ï¼šide-cdromã€‚ IDï¼š è®¾å¤‡åœ¨ devpath é‡Œçš„è¯†åˆ«å·ã€‚ SYSFS{filename}ï¼š è®¾å¤‡çš„ devpath è·¯å¾„ä¸‹ï¼Œè®¾å¤‡çš„å±æ€§æ–‡ä»¶â€œfilenameâ€é‡Œçš„å†…å®¹ã€‚ ä¾‹å¦‚ï¼šSYSFS{model}==â€œST936701SSâ€è¡¨ç¤ºï¼šå¦‚æœè®¾å¤‡çš„å‹å·ä¸º ST936701SSï¼Œåˆ™è¯¥è®¾å¤‡åŒ¹é…è¯¥ åŒ¹é…é”®ã€‚ åœ¨ä¸€æ¡è§„åˆ™ä¸­ï¼Œå¯ä»¥è®¾å®šæœ€å¤šäº”æ¡ SYSFS çš„ åŒ¹é…é”®ã€‚ ENV{key}ï¼š ç¯å¢ƒå˜é‡ã€‚åœ¨ä¸€æ¡è§„åˆ™ä¸­ï¼Œå¯ä»¥è®¾å®šæœ€å¤šäº”æ¡ç¯å¢ƒå˜é‡çš„ åŒ¹é…é”®ã€‚ PROGRAMï¼šè°ƒç”¨å¤–éƒ¨å‘½ä»¤ã€‚ RESULTï¼š å¤–éƒ¨å‘½ä»¤ PROGRAM çš„è¿”å›ç»“æœã€‚ é…ç½®æ–‡ä»¶ è¿™é‡Œæ˜¯CentOS 6çš„ç‰ˆæœ¬ [root@rac1 ~]# cat /etc/udev/rules.d/99-oracle-asmdevice.rules KERNEL==\"sd*\",SUBSYSTEM==\"block\",PROGRAM==\"/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name\",RESULT==\"360000000000000000e00000000020fa8\",NAME+=\"oracleasm/disks/HL_360000000000000000e00000000020fa8\",OWNER=\"grid\",GROUP=\"asmadmin\",MODE=\"0660\" ç„¶ååŠ è½½é…ç½®æ–‡ä»¶ [root@rac1 ~]# start_udev æ­£åœ¨å¯åŠ¨ udevï¼š [ç¡®å®š] [root@rac1 ~]# ll /dev/oracleasm/disks æ€»ç”¨é‡ 0 brw-rw---- 1 grid asmadmin 8, 16 1æœˆ 23 14:30 HL_360000000000000000e00000000020fa8 æ³¨æ„ åœ¨CentOS6å’ŒCentOS7çš„é…ç½®æœ‰æ‰€ä¸åŒã€‚ ä¸€ä¸ªæ˜¯scsi_idå‘½ä»¤ï¼Œè¿˜æœ‰æ˜¯udevè§„åˆ™å˜åŒ–ã€‚ KERNEL==\"sd*\",SUBSYSTEM==\"block\",PROGRAM==\"/usr/lib/udev/scsi_id --whitelisted --replace-whitespace --device=/dev/$name\",RESULT==\"360000000000000000e00000000160fa8\",RUN+=\"/bin/sh -c 'mkdir -pv /dev/oracleasm/disks;mknod /dev/oracleasm/disks/HL_360000000000000000e00000000160fa8 b 1 3; chown grid:oinstall /dev/oracleasm/disks/HL_360000000000000000e00000000160fa8; chmod 0660 /dev/oracleasm/disks/HL_360000000000000000e00000000160fa8'\" scsi_idå‘½ä»¤éœ€è¦å®‰è£…systemdåŒ…ï¼Œå¦‚æœçŸ¥é“å‘½ä»¤å¯¹åº”çš„è½¯ä»¶åŒ…åç§°ï¼Œå¯ä»¥ä½¿ç”¨yumå‘½ä»¤æŸ¥çœ‹ yum provides \"/*/scsi_id\" udevéœ€è¦ä½¿ç”¨RUNæ¥ä»£æ›¿NAMEï¼Œåœ¨RUNä¸­èƒ½ä½¿ç”¨linuxçš„å‘½ä»¤ï¼Œä½¿ç”¨ï¼›åˆ†éš”å¤šä¸ªå‘½ä»¤ã€‚ mknodæ˜¯CentOS7ä¸­è½¬åŒ–è®¾å¤‡çš„æ–°å‘½ä»¤ï¼Œæ ¼å¼ä¸ºï¼š mknod /dev/sdb \u003cDEVICE_TYPE\u003e \u003cä¸»è®¾å¤‡å·\u003e \u003cæ¬¡è®¾å¤‡å·\u003e åŒæ—¶ä¿®æ”¹udevçš„å‘½ä»¤ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚ [root@localhost ~]# /usr/sbin/udevadm trigger --type=devices --action=change åœ¨åŒæ—¶æ·»åŠ å¤šä¸ªè®¾å¤‡æ—¶ï¼Œåæ·»åŠ çš„è®¾å¤‡åŒæ­¥è¾ƒæ…¢ã€‚æ¯”è¾ƒå¥½çš„æ–¹æ³•æ˜¯å…ˆå…¨éƒ¨æ·»åŠ åˆ°.rulesæ–‡ä»¶ä¸­ï¼Œæœ€åå†æ‰§è¡Œudevadm triggeråŠ è½½ã€‚ ","date":"2021-12-03","objectID":"/linux%E4%B8%8A%E4%BD%BF%E7%94%A8udev%E5%88%9B%E5%BB%BA%E8%A3%B8%E8%AE%BE%E5%A4%87/:0:0","tags":null,"title":"linuxä¸Šä½¿ç”¨udevåˆ›å»ºè£¸è®¾å¤‡","uri":"/linux%E4%B8%8A%E4%BD%BF%E7%94%A8udev%E5%88%9B%E5%BB%BA%E8%A3%B8%E8%AE%BE%E5%A4%87/"},{"categories":null,"content":"Linuxä¸­æ–­å’Œå¼‚å¸¸ ä¸­æ–­(interrupt)é€šå¸¸è¢«å®šä¹‰ä¸ºä¸€ä¸ªäº‹ä»¶ï¼Œè¯¥äº‹ä»¶æ”¹å˜å¤„ç†å™¨æ‰§è¡Œçš„æŒ‡ä»¤é¡ºåºã€‚è¿™æ ·çš„äº‹ä»¶ä¸CPUèŠ¯ç‰‡å†…å¤–éƒ¨ç¡¬ä»¶ç”µè·¯äº§ç”Ÿçš„ç‚¹ä¿¡å·ç›¸å¯¹åº”ã€‚ ä¸­æ–­é€šå¸¸åˆ†ä¸ºåŒæ­¥ (synchronous) ä¸­æ–­å’Œå¼‚æ­¥ (asynchornous) ä¸­æ–­: åŒæ­¥ä¸­æ–­æ˜¯å½“æŒ‡ä»¤æ‰§è¡Œæ—¶ç”± CPU æ§åˆ¶å•å…ƒäº§ç”Ÿçš„ï¼Œä¹‹æ‰€ä»¥ç§°ä¸ºåŒæ­¥ï¼Œæ˜¯å› ä¸ºåªæœ‰åœ¨ä¸€æ¡æŒ‡ä»¤ç»ˆæ­¢æ‰§è¡Œå CPU æ‰ä¼šå‘å‡ºä¸­æ–­ã€‚ å¼‚æ­¥ä¸­æ–­æ˜¯ç”±å…¶ä»–ç¡¬ä»¶è®¾å¤‡ä¾ç…§ CPU æ—¶é’Ÿä¿¡å·éšæœºäº§ç”Ÿçš„ã€‚ åœ¨ Intel å¾®å¤„ç†å™¨ä¸­ï¼ŒæŠŠåŒæ­¥å’Œå¼‚æ­¥ä¸­æ–­åˆ†åˆ«ç§°ä¸ºå¼‚å¸¸ (exception) å’Œä¸­æ–­ (interrupt)ã€‚ ä¸­æ–­æ˜¯ç”±é—´éš”å®šæ—¶å™¨å’ŒI/Oè®¾å¤‡äº§ç”Ÿçš„ï¼Œå¼‚å¸¸æ˜¯ç”±ç¨‹åºçš„é”™è¯¯äº§ç”Ÿçš„ï¼Œæˆ–è€…æ˜¯ç”±å†…æ ¸å¿…é¡»å¤„ç†çš„å¼‚å¸¸æ¡ä»¶äº§ç”Ÿçš„ã€‚ ","date":"2021-12-03","objectID":"/linux%E4%B8%AD%E6%96%AD%E5%92%8C%E5%BC%82%E5%B8%B8/:0:0","tags":null,"title":"Linuxä¸­æ–­å’Œå¼‚å¸¸","uri":"/linux%E4%B8%AD%E6%96%AD%E5%92%8C%E5%BC%82%E5%B8%B8/"},{"categories":null,"content":"ä¸­æ–­ä¿¡å·çš„ä½œç”¨ ä¸­æ–­ä¿¡å·æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„æ–¹å¼ï¼Œä½¿å¤„ç†å™¨è½¬è€Œå»è¿è¡Œæ­£å¸¸æ§åˆ¶æµä¹‹å¤–çš„ä»£ç ã€‚å½“ä¸€ä¸ªä¸­æ–­ä¿¡å·è¾¾åˆ°æ˜¯ï¼ŒCPU å¿…é¡»åœæ­¢å®ƒå½“å‰æ­£åœ¨åšçš„äº‹æƒ…ï¼Œå¹¶ä¸”åˆ‡æ¢åˆ°ä¸€ä¸ªæ–°çš„æ´»åŠ¨ã€‚æ‰€ä»¥è¦åœ¨å†…æ ¸æ€å †æ ˆä¿å­˜ç¨‹åºè®¡æ•°å™¨çš„å½“å‰å€¼(å³eipå’Œcså¯„å­˜å™¨çš„å†…å®¹)ï¼Œå¹¶æŠŠä¸ä¸­æ–­ç±»å‹ç›¸å…³çš„ä¸€ä¸ªåœ°å€æ”¾è¿›ç¨‹åºè®¡æ•°å™¨ã€‚ ","date":"2021-12-03","objectID":"/linux%E4%B8%AD%E6%96%AD%E5%92%8C%E5%BC%82%E5%B8%B8/:1:0","tags":null,"title":"Linuxä¸­æ–­å’Œå¼‚å¸¸","uri":"/linux%E4%B8%AD%E6%96%AD%E5%92%8C%E5%BC%82%E5%B8%B8/"},{"categories":null,"content":"ä¸­æ–­å’Œå¼‚å¸¸ ä¸­æ–­: å¯å±è”½ä¸­æ–­ (maskable interrupt) : I/O è®¾å¤‡å‘å‡ºçš„æ‰€æœ‰ä¸­æ–­è¯·æ±‚(IRQ)éƒ½äº§ç”Ÿå¯å±è”½ä¸­æ–­ã€‚å¯å±è”½ä¸­æ–­å¯ä»¥å¤„äºä¸¤ç§çŠ¶æ€: å±è”½çš„ (masked) æˆ–éå±è”½çš„ (unmasked)ï¼›ä¸€ä¸ªå±è”½çš„ä¸­æ–­åªè¦è¿˜æ˜¯å±è”½çš„ï¼Œæ§åˆ¶å•å…ƒå°±å¿½ç•¥å®ƒã€‚ éå±è”½ä¸­æ–­ (nonmaskable interrupt) : åªæœ‰å‡ ä¸ªå±æ€¥äº‹ä»¶(å¦‚ç¡¬ä»¶æ•…éšœ)æ‰å¼•èµ·éå±è”½ä¸­æ–­ã€‚éå±è”½ä¸­æ–­æ€»æ˜¯ç”±CPUè¾¨è®¤ã€‚ å¼‚å¸¸: å¤„ç†å™¨æ¢æµ‹å¼‚å¸¸(processor-detected exception) : å½“ CPU æ‰§è¡ŒæŒ‡ä»¤æ—¶æ¢æµ‹åˆ°ä¸€ä¸ªåå¸¸æ¡ä»¶æ‰€äº§ç”Ÿçš„å¼‚å¸¸ã€‚å¯ä»¥è¿›ä¸€æ­¥åˆ†ä¸ºä¸‰ç»„ï¼Œè¿™å–å†³äºCPUæ§åˆ¶å•å…ƒäº§ç”Ÿå¼‚å¸¸æ˜¯ä¿å­˜åœ¨å†…æ ¸æ€å †æ ˆeipå¯„å­˜å™¨ä¸­çš„å€¼ã€‚å®ƒä»¬åˆ†åˆ«æ˜¯æ•…éšœ(fault)ã€é™·é˜±(trap) å’Œå¼‚å¸¸ä¸­æ­¢(abort)ã€‚ ç¼–ç¨‹å¼‚å¸¸(programmed exception) : åœ¨ç¼–ç¨‹è€…å‘å‡ºè¯·æ±‚æ—¶å‘ç”Ÿã€‚æ˜¯ç”± int æˆ– int3 æŒ‡ä»¤è§¦å‘çš„ã€‚å½“ into(æ£€æŸ¥æº¢å‡º)å’Œ bound(æ£€æŸ¥åœ°å€å‡ºç•Œ)æŒ‡ä»¤æŸ¥è¯¢çš„æ¡ä»¶ä¸ä¸ºçœŸæ—¶ï¼Œä¹Ÿå¼•èµ·ç¼–ç¨‹å¼‚å¸¸ã€‚æ§åˆ¶å•å…ƒæŠŠç¼–ç¨‹å¼‚å¸¸ä½œä¸ºé™·é˜±æ¥å¤„ç†ã€‚ç¼–ç¨‹å¼‚å¸¸é€šå¸¸ä¹Ÿå«åšè½¯ä¸­æ–­(software interrupt)ã€‚è¿™æ ·çš„å¼‚å¸¸æœ‰ä¸¤ç§å¸¸ç”¨çš„ç”¨é€”: æ‰§è¡Œç³»ç»Ÿè°ƒç”¨å’Œç»™è°ƒè¯•ç¨‹åºé€šæŠ¥ä¸€ä¸ªç‰¹å®šçš„äº‹ä»¶ã€‚ å¤„ç†å™¨æ¢æµ‹çš„å¼‚å¸¸: æ•…éšœ: é€šå¸¸å¯ä»¥çº æ­£ã€‚ä¸€æ—¦çº æ­£ï¼Œç¨‹åºå°±å¯ä»¥åœ¨ä¸å¤±è¿è´¯æ€§çš„æƒ…å†µä¸‹é‡æ–°å¼€å§‹ã€‚ä¿å­˜åœ¨ eip ä¸­çš„å€¼æ˜¯å¼•èµ·æ•…éšœçš„æŒ‡ä»¤åœ°å€ã€‚å› æ­¤ï¼Œå½“å¼‚å¸¸å¤„ç†ç¨‹åºç»ˆæ­¢æ—¶ï¼Œé‚£æ¡æŒ‡ä»¤ä¼šè¢«é‡æ–°æ‰§è¡Œã€‚ é™·é˜±: åœ¨é™·é˜±æŒ‡ä»¤æ‰§è¡Œåç«‹å³æŠ¥å‘Šã€‚å†…æ ¸æŠŠæ§åˆ¶æƒè¿”å›ç»™ç¨‹åº¦åå°±å¯ä»¥ç»§ç»­å®ƒçš„æ‰§è¡Œè€Œä¸å¤±è¿è´¯æ€§ã€‚ä¿å­˜åœ¨ eip ä¸­çš„å€¼æ˜¯ä¸€ä¸ªéšåè¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ã€‚åªæœ‰å½“æ²¡æœ‰å¿…é¡»è¦é‡æ–°æ‰§è¡Œä»¥ç»ˆæ­¢çš„æŒ‡ä»¤æ—¶ï¼Œæ‰è§¦å‘é™·é˜±ã€‚é™·é˜±çš„ä¸»è¦ç”¨é€”æ˜¯ä¸ºäº†è°ƒè¯•ç¨‹åºã€‚ å¼‚å¸¸ä¸­æ­¢: å‘é€ä¸€ä¸ªä¸¥é‡çš„é”™è¯¯ï¼Œæ§åˆ¶å•å…ƒå‡ºäº†é—®é¢˜ï¼Œä¸èƒ½åœ¨ eip å¯„å­˜å™¨ä¸­ä¿å­˜å¼•èµ·å¼‚å¸¸çš„æŒ‡ä»¤æ‰€åœ¨çš„ç¡®åˆ‡ä½ç½®ã€‚å¼‚å¸¸ä¸­æ­¢ç”¨äºæŠ¥å‘Šä¸¥é‡çš„é”™è¯¯ï¼Œå¦‚ç¡¬ä»¶æ•…éšœæˆ–ç³»ç»Ÿè¡¨ä¸­æ— æ•ˆçš„å€¼æˆ–ä¸ä¸€è‡´çš„å€¼ã€‚ç”±æ§åˆ¶å•å…ƒå‘é€çš„è¿™ä¸ªä¸­æ–­ä¿¡å·æ—¶ç´§æ€¥ä¿¡å·ï¼Œç”¨æ¥æŠŠæ§åˆ¶æƒåˆ‡æ¢åˆ°ç›¸åº”çš„å¼‚å¸¸ä¸­æ­¢å¤„ç†ç¨‹åºï¼Œè¿™ä¸ªå¼‚å¸¸ä¸­æ­¢å¤„ç†ç¨‹åºé™¤äº†å¼ºåˆ¶å—å½±å“çš„è¿›ç¨‹ä¸­æ­¢å¤–ï¼Œæ²¡æœ‰åˆ«çš„é€‰æ‹©ã€‚ æ¯ä¸ªä¸­æ–­å’Œå¼‚å¸¸æ˜¯ç”±0~255ä¹‹é—´çš„ä¸€ä¸ªæ•°æ¥æ ‡è¯†ã€‚Intel æŠŠè¿™ä¸ª8ä½çš„æ— ç¬¦å·æ•´æ•°å«åšä¸€ä¸ªå‘é‡(vector)ã€‚éå±è”½ä¸­æ–­çš„å‘é‡å’Œå¼‚å¸¸çš„å‘é‡æ˜¯å›ºå®šçš„ï¼Œè€Œå¯å±è”½ä¸­æ–­çš„å‘é‡å¯ä»¥é€šè¿‡å¯¹ä¸­æ–­æ§åˆ¶å™¨çš„ç¼–ç¨‹æ¥æ”¹å˜ã€‚ ","date":"2021-12-03","objectID":"/linux%E4%B8%AD%E6%96%AD%E5%92%8C%E5%BC%82%E5%B8%B8/:2:0","tags":null,"title":"Linuxä¸­æ–­å’Œå¼‚å¸¸","uri":"/linux%E4%B8%AD%E6%96%AD%E5%92%8C%E5%BC%82%E5%B8%B8/"},{"categories":null,"content":"Linuxå†…å­˜ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:0:0","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"å†…å­˜æ¦‚è®º ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:1:0","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"è™šæ‹Ÿå†…å­˜ è™šæ‹Ÿå†…å­˜(virtual memory)æ˜¯ Unix ç³»ç»Ÿä¸­ä¸€ç§å¯¹å†…å­˜çš„æŠ½è±¡ã€‚è™šæ‹Ÿå†…å­˜ä½œä¸ºä¸€ç§é€»è¾‘å±‚ï¼Œå¤„äºåº”ç”¨ç¨‹åºçš„å†…å­˜è¯·æ±‚ä¸ç¡¬ä»¶å†…å­˜ç®¡ç†å•å…ƒ(Memory Management Unit, MMU)ä¹‹é—´ã€‚è™šæ‹Ÿå†…å­˜æœ‰å¾ˆå¤šç”¨é€”å’Œä¼˜ç‚¹: è‹¥å¹²ä¸ªè¿›ç¨‹å¯èƒ½å¹¶å‘åœ°æ‰§è¡Œã€‚ åº”ç”¨ç¨‹åºæ‰€éœ€å†…å­˜å¤§äºå¯ç”¨ç‰©ç†å†…å­˜æ—¶ä¹Ÿå¯ä»¥è¿è¡Œã€‚ ç¨‹åºåªæœ‰éƒ¨åˆ†ä»£ç è£…å…¥å†…å­˜æ—¶è¿›ç¨‹å¯ä»¥æ‰§è¡Œå®ƒã€‚ å…è®¸æ¯ä¸ªè¿›ç¨‹è®¿é—®å¯ç”¨ç‰©ç†å†…å­˜çš„å­é›†ã€‚ è¿›ç¨‹å¯ä»¥å…±äº«åº“å‡½æ•°æˆ–ç¨‹åºçš„ä¸€ä¸ªå•ç‹¬å†…å­˜æ˜ è±¡ã€‚ ç¨‹åºæ—¶å¯é‡å®šä½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥æŠŠç¨‹åºæ”¾åœ¨ç‰©ç†å†…å­˜çš„ä»»ä½•åœ°æ–¹ã€‚ ç¨‹åºå‘˜å¯ä»¥ç¼–å†™ä¸æœºå™¨æ— å…³çš„ä»£ç ï¼Œå› ä¸ºä»–ä»¬ä¸å¿…å…³å¿ƒæœ‰å…³ç‰©ç†å†…å­˜çš„ç»„ç»‡ç»“æ„ã€‚ è™šæ‹Ÿå†…å­˜å­ç³»ç»Ÿçš„ä¸»è¦æˆåˆ†æ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´(virtual address space)çš„æ¦‚å¿µã€‚è¿›ç¨‹æ‰€ç”¨çš„ä¸€ç»„å†…å­˜åœ°å€ä¸åŒäºç‰©ç†å†…å­˜åœ°å€ã€‚å½“è¿›ç¨‹ä½¿ç”¨ä¸€ä¸ªè™šæ‹Ÿåœ°å€æ—¶ï¼Œå†…æ ¸å’ŒMMUååŒå®šä½å…¶åœ¨å†…å­˜ä¸­çš„å®é™…ç‰©ç†åœ°å€ä½ç½®ã€‚ ç°åœ¨çš„ CPU åŒ…å«äº†èƒ½è‡ªåŠ¨æŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€çš„ç¡¬ä»¶ç”µè·¯ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®æ ‡ï¼ŒæŠŠå¯ç”¨ RAM åˆ’åˆ†æˆé•¿åº¦ä¸º 4KB æˆ– 8KB çš„é¡µæ¡†(page frame)ï¼Œå¹¶å¼•å…¥ä¸€ç»„é¡µè¡¨æ¥æŒ‡å®šè™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚ ä¸€å—è¿ç»­çš„è™šæ‹Ÿåœ°å€è¯·æ±‚å¯ä»¥é€šè¿‡åˆ†é…ä¸€ç»„éè¿ç»­çš„ç‰©ç†åœ°å€é¡µæ¡†è€Œå¾—åˆ°æ»¡è¶³ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:1:1","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"éšæœºè®¿é—®å­˜å‚¨å™¨(RAM)çš„ä½¿ç”¨ Unix æ“ä½œç³»ç»Ÿå°† RAM åˆ’åˆ†æˆä¸¤éƒ¨åˆ†ã€‚å…¶ä¸­è‹¥å¹²å…†å­—èŠ‚ä¸“é—¨ç”¨äºå­˜æ”¾å†…æ ¸æ˜ è±¡(ä¹Ÿå°±æ˜¯å†…æ ¸ä»£ç å’Œå†…æ ¸é™æ€æ•°æ®ç»“æ„)ã€‚RAMçš„å…¶ä½™éƒ¨åˆ†é€šå¸¸ç”±è™šæ‹Ÿå†…å­˜ç³»ç»Ÿæ¥å¤„ç†ï¼Œå¹¶ä¸”ç”¨åœ¨ä»¥ä¸‹ä¸‰ç§å¯èƒ½çš„æ–¹é¢: æ»¡è¶³å†…æ ¸å¯¹ç¼“å†²åŒºï¼Œæè¿°ç¬¦åŠå…¶ä»–åŠ¨æ€å†…å­˜æ•°æ®ç»“æ„çš„è¯·æ±‚ã€‚ æ»¡è¶³è¿›ç¨‹å¯¹ä¸€èˆ¬å†…å­˜åŒºçš„è¯·æ±‚åŠå¯¹æ–‡ä»¶å†…å­˜æ˜ å°„çš„è¯·æ±‚ã€‚ å€ŸåŠ©ä¸é«˜é€Ÿç¼“å­˜ä»ç£ç›˜åŠå…¶ä»–ç¼“å†²è®¾å¤‡è·å¾—è¾ƒå¥½çš„æ€§èƒ½ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:1:2","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"å†…æ ¸å†…å­˜åˆ†é…å™¨ å†…æ ¸å†…å­˜åˆ†é…å™¨(Kernel Memory Allocator, KMA)æ˜¯ä¸€ä¸ªå­ç³»ç»Ÿï¼Œå®ƒè¯•å›¾æ»¡è¶³ç³»ç»Ÿä¸­éƒ¨åˆ†å¯¹å†…å­˜çš„è¯·æ±‚ã€‚å…¶ä¸­ä¸€äº›è¯·æ±‚æ¥è‡ªå†…æ ¸å…¶ä»–å­ç³»ç»Ÿï¼Œå®ƒä»¬éœ€è¦ä¸€äº›å†…æ ¸ä½¿ç”¨çš„å†…å­˜ï¼Œè¿˜æœ‰ä¸€äº›è¯·æ±‚æ¥è‡ªäºç”¨æˆ·ç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨æ¥å¢åŠ ç”¨æˆ·è¿›ç¨‹ä¸­åœ°å€ç©ºé—´ã€‚ä¸€ä¸ªå¥½çš„ KMA åº”è¯¥å…·æœ‰ä¸‹åˆ—ç‰¹ç‚¹: å¿…é¡»å¿«ã€‚å› ä¸ºå®ƒç”±æ‰€æœ‰çš„å†…æ ¸å­ç³»ç»Ÿ(åŒ…æ‹¬ä¸­æ–­å¤„ç†ç¨‹åº)è°ƒç”¨ã€‚ å¿…é¡»æŠŠå†…å­˜çš„æµªè´¹å‡åˆ°æœ€å°‘ã€‚ å¿…é¡»åŠªåŠ›å‡è½»å†…å­˜çš„ç¢ç‰‡(fragmentation)é—®é¢˜ã€‚ å¿…é¡»èƒ½ä¸å…¶ä»–å†…å­˜ç®¡ç†å­ç³»ç»Ÿåˆä½œï¼Œä»¥ä¾¿å€Ÿç”¨å’Œé‡Šæ”¾é¡µæ¡†ã€‚ åŸºäºä¸åŒçš„ç®—æ³•æŠ€æœ¯å®ç°çš„KMA: èµ„æºå›¾åˆ†é…ç®—æ³•(allocator) 2çš„å¹‚æ¬¡æ–¹ç©ºé—²é“¾è¡¨ McKusick-Karels åˆ†é…ç®—æ³• ä¼™ä¼´ (Buddy) ç³»ç»Ÿ Mach çš„åŒºåŸŸ (Zone) åˆ†é…ç®—æ³• Dynix åˆ†é…ç®—æ³• Solaris çš„ Slab åˆ†é…ç®—æ³• ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:1:3","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´å¤„ç† è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´åŒ…æ‹¬äº†è¿›ç¨‹å¯ä»¥å¼•ç”¨çš„æ‰€æœ‰è™šæ‹Ÿå†…å­˜åœ°å€ã€‚å†…æ ¸é€šå¸¸ç”¨ä¸€ç»„å†…å­˜åŒºæè¿°ç¬¦æè¿°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚ä¾‹å¦‚ï¼Œå½“è¿›ç¨‹é€šè¿‡ exec() ç±»ç³»ç»Ÿè°ƒç”¨å¼€å§‹æŸä¸ªç¨‹åºæ‰§è¡Œæ—¶ï¼Œå†…æ ¸åˆ†é…ç»™è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´æœ‰ä»¥ä¸‹å†…å­˜åŒºç»„æˆã€‚ ç¨‹åºçš„å¯æ‰§è¡Œä»£ç ã€‚ ç¨‹åºçš„åˆå§‹åŒ–æ•°æ®ã€‚ ç¨‹åºçš„æœªåˆå§‹åŒ–æ•°æ®ã€‚ åˆå§‹ç¨‹åºæ ˆ(å³ç”¨æˆ·æ€æ ˆ)ã€‚ æ‰€éœ€å…±äº«åº“çš„å¯æ‰§è¡Œä»£ç å’Œæ•°æ®ã€‚ å †(ç”±ç¨‹åºè‘£å¤ªå¤ªè¯·æ±‚çš„å†…å­˜)ã€‚ ç°ä»£ Unix æ“ä½œç³»ç»Ÿé‡‡ç”¨äº†è¯·æ±‚è°ƒé¡µ(demand paging)çš„å†…å­˜åˆ†é…ç­–ç•¥ã€‚æœ‰äº†è¯·æ±‚è°ƒé¡µï¼Œè¿›ç¨‹å¯ä»¥åœ¨å®ƒçš„é¡µè¿˜æ²¡æœ‰åœ¨å†…å­˜æ—¶å°±å¼€å§‹æ‰§è¡Œã€‚å½“è¿›ç¨‹è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µæ—¶ï¼ŒMMUäº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ï¼Œå¼‚å¸¸å¤„ç†ç¨‹åºæ‰¾åˆ°å—å½±å“çš„å†…å­˜åŒºï¼Œåˆ†é…ä¸€ä¸ªç©ºé—²çš„é¡µï¼Œå¹¶ç”¨é€‚å½“çš„æ•°æ®æŠŠå•Šåˆå§‹åŒ–ã€‚åŒç†ï¼Œå½“è¿›ç¨‹é€šè¿‡è°ƒç”¨ malloc() æˆ– brk()(ç”±malloc()åœ¨å†…éƒ¨è°ƒç”¨)ç³»ç»Ÿè°ƒç”¨åŠ¨æ€åœ°è¯·æ±‚å†…å­˜æ˜¯ï¼Œå†…æ ¸ä»…ä»…ä¿®æ”¹è¿›ç¨‹çš„å †å†…å­˜åŒºçš„å¤§å°ã€‚åªæœ‰è¯•å›¾å¼•è¿›è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜è€Œäº§ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ‰ç»™è¿›ç¨‹åˆ†é…é¡µæ¡†ã€‚ è™šæ‹Ÿåœ°å€ç©ºé—´ä¹Ÿé‡‡ç”¨å…¶ä»–æ›´æœ‰æ•ˆçš„ç­–ç•¥ï¼Œå¦‚å†™æ—¶å¤åˆ¶ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªæ–°è¿›ç¨‹è¢«åˆ›å»ºæ—¶ï¼Œå†…æ ¸ä»…ä»…æŠŠçˆ¶è¿›ç¨‹çš„é¡µæ¡†èµ‹ç»™å­è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œä½†æ˜¯æŠŠè¿™äº›é¡µæ¡†æ ‡è®°ä¸ºåªè¯»ã€‚ä¸€æ—¦çˆ¶æˆ–å­è¿›ç¨‹ä¿®æ”¹é¡µä¸­çš„å†…å®¹æ—¶ï¼Œä¸€ä¸ªå¼‚å¸¸å°±ä¼šäº§ç”Ÿã€‚å¼‚å¸¸å¤„ç†ç¨‹åºæŠŠæ–°é¡µæ¡†èµ‹ç»™å—å½±å“çš„è¿›ç¨‹ï¼Œå¹¶ç”¨åŸæ¥ä¹Ÿä¸­çš„å†…å®¹åˆå§‹åŒ–æ–°é¡µæ¡†ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:1:4","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"é«˜é€Ÿç¼“å­˜ ç‰©ç†å†…å­˜çš„ä¸€å¤§ä¼˜åŠ¿å°±æ˜¯ç”¨ä½œç£ç›˜å’Œå…¶ä»–å—è®¾å¤‡çš„é«˜é€Ÿç¼“å­˜ã€‚é€šå¸¸ï¼Œåœ¨æœ€æ—©çš„ Unix ç³»ç»Ÿä¸­å°±å·²ç»å®ç°çš„ä¸€ä¸ªç­–ç•¥æ˜¯: å°½å¯èƒ½åœ°æ¨è¿Ÿå†™ç£ç›˜çš„æ—¶é—´ï¼Œå› æ­¤ï¼Œä»ç£ç›˜è¯»å…¥å†…å­˜çš„æ•°æ®å³ä½¿ä»»ä½•è¿›ç¨‹éƒ½ä¸å†ä½¿ç”¨å®ƒä»¬ï¼Œå®ƒä»¬ä¹Ÿç»§ç»­ç•™åœ¨ RAM ä¸­ã€‚ æ–°è¿›ç¨‹è¯·æ±‚ä»ç£ç›˜è¯»æˆ–å†™çš„æ•°æ®ï¼Œå°±æ˜¯è¢«æ’¤é”€è¿›ç¨‹æ›¾æ‹¥æœ‰çš„æ•°æ®ã€‚å½“ä¸€ä¸ªè¿›ç¨‹è¯·æ±‚è®¿é—®ç£ç›˜æ—¶ï¼Œå†…æ ¸é¦–å…ˆæ£€æŸ¥è¿›ç¨‹è¯·æ±‚çš„æ•°æ®æ˜¯å¦åœ¨ç¼“å­˜ä¸­ï¼Œå¦‚æœåœ¨(æŠŠè¿™ç§è¯·æ±‚å«åšç¼“å­˜å‘½ä¸­)ï¼Œå†…æ ¸å°±å¯ä»¥ä¸ºè¿›ç¨‹è¯·æ±‚æä¾›æœåŠ¡è€Œä¸ç”¨è®¿é—®ç£ç›˜ã€‚ sync() ç³»ç»Ÿè°ƒç”¨æŠŠæ‰€æœ‰\"è„\"çš„ç¼“å†²åŒºå†™å…¥ç£ç›˜æ¥å¼ºåˆ¶ç£ç›˜åŒæ­¥ã€‚ä¸ºäº†é¿å…æ•°æ®ä¸¢å¤±ï¼Œæ‰€æœ‰çš„æ“ä½œç³»ç»Ÿéƒ½ä¼šæ³¨æ„å‘¨æœŸæ€§åœ°æŠŠè„ç¼“å­˜åŒºå†™å›ç£ç›˜ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:1:5","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"å†…å­˜åœ°å€ x86å¾®å¤„ç†å™¨çš„ä¸‰ç§ä¸åŒåœ°å€: é€»è¾‘åœ°å€(logical address): æ¯ä¸€ä¸ªé€»è¾‘åœ°å€éƒ½ç”±ä¸€ä¸ªæ®µ(segment)å’Œåç§»é‡(offsetæˆ–displacement)ç»„æˆï¼Œåç§»é‡æŒ‡æ˜äº†ä»æ®µå¼€å§‹çš„åœ°æ–¹åˆ°å®é™…åœ°å€ä¹‹é—´çš„è·ç¦»ã€‚ çº¿æ€§åœ°å€(linear address)(ä¹Ÿç§°è™šæ‹Ÿåœ°å€ virtual address): çº¿æ€§åœ°å€é€šå¸¸ç”¨åå…­è¿›åˆ¶æ•°å­—è¡¨ç¤ºï¼Œå€¼å¾—èŒƒå›´ä» 0x00000000 åˆ° 0xffffffffã€‚å¯ä»¥è¡¨ç¤ºé«˜è¾¾ 4GB çš„åœ°å€ã€‚ ç‰©ç†åœ°å€(physical address): ç”¨äºèŠ¯ç‰‡çº§å†…å­˜å•å…ƒå¯»å€ã€‚ä»–ä»¬ä»å¾®å¤„ç†å™¨çš„åœ°å€å¼•è„šå‘é€åˆ°å†…å­˜æ€»çº¿ä¸Šçš„ç”µä¿¡å·ç›¸å¯¹åº”ã€‚ å†…å­˜æ§åˆ¶å•å…ƒ(MMU)é€šè¿‡åˆ†æ®µå•å…ƒ(segmentation unit)çš„ç¡¬ä»¶ç”µè·¯æŠŠä¸€ä¸ªé€»è¾‘åœ°å€è½¬æ¢æˆçº¿æ€§åœ°å€ã€‚é€šè¿‡åˆ†é¡µå•å…ƒ(paging unit)çš„ç¡¬ä»¶ç”µè·¯æŠŠçº¿æ€§åœ°å€è½¬åŒ–æˆç‰©ç†åœ°å€ã€‚ åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰ CPU éƒ½å…±äº«åŒä¸€å†…å­˜ã€‚RAMèŠ¯ç‰‡ä¸Šçš„è¯»å’Œå†™æ“ä½œå¿…é¡»ä¸²è¡Œæ‰§è¡Œï¼Œå› æ­¤å†…å­˜ä»²è£å™¨(memory arbiter)çš„ç¡¬ä»¶ç”µè·¯æ’åœ¨æ€»çº¿å’Œæ¯ä¸ª RAM èŠ¯ç‰‡ä¹‹é—´ã€‚å…¶ä½œç”¨å°±æ˜¯å¦‚æœæŸä¸ª RAM èŠ¯ç‰‡ç©ºé—²ï¼Œå°±å‡†äºˆä¸€ä¸ª CPU è®¿é—®ï¼Œå¦‚æœè¯¥èŠ¯ç‰‡å¿™äºä¸ºå¦ä¸€ä¸ªå¤„ç†å™¨æå‡ºçš„è¯·æ±‚æœåŠ¡ï¼Œå°±å»¶è¿Ÿè¿™ä¸ª CPU çš„è®¿é—®ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:2:0","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"ç¡¬ä»¶ä¸­çš„åˆ†æ®µ 80206 å¼€å§‹ï¼ŒIntel å¾®å¤„ç†å™¨å…·æœ‰ä¸¤ç§æ–¹å¼æ‰§è¡Œåœ°å€è½¬æ¢ï¼š å®æ¨¡å¼(real mode)ã€‚ ä¿æŠ¤æ¨¡å¼(protected mode)ã€‚ å®æ¨¡å¼å­˜åœ¨æ˜¯å¤„äºå…¼å®¹æ€§è€ƒè™‘ï¼Œä¸»è¦è¿˜æ˜¯ä¿æŠ¤æ¨¡å¼ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:3:0","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"æ®µé€‰æ‹©ç¬¦å’Œæ®µå¯„å­˜å™¨ ä¸€ä¸ªé€»è¾‘åœ°å€ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€ä¸ªæ®µæ ‡è¯†ç¬¦å’Œä¸€ä¸ªæŒ‡å®šæ®µå†…ç›¸å¯¹åœ°å€çš„åç§»é‡ã€‚æ®µæ ‡è¯†ç¬¦æ˜¯ä¸€ä¸ª 16 ä½é•¿çš„å­—æ®µï¼Œç§°ä¸ºæ®µé€‰æ‹©ç¬¦(Segment Selector)ã€‚åç§»é‡æ˜¯ä¸€ä¸ª 32 ä½é•¿çš„å­—æ®µã€‚ ä¸“é—¨å­˜æ”¾æ®µé€‰æ‹©ç¬¦çš„å¯„å­˜å™¨: cs, ss, ds, es, fs å’Œ gsã€‚å…¶ä¸­3ä¸ªæœ‰ä¸“é—¨çš„ç”¨é€”: cs ä»£ç æ®µå¯„å­˜å™¨ï¼ŒæŒ‡å‘åŒ…å«ç¨‹åºæŒ‡ä»¤çš„æ®µã€‚ ss æ ˆæ®µå¯„å­˜å™¨ï¼ŒæŒ‡å‘åŒ…å«å½“å‰ç¨‹åºæ ˆçš„æ®µã€‚ ds æ•°æ®æ®µå¯„å­˜å™¨ï¼ŒæŒ‡å‘åŒ…å«é™æ€æ•°æ®æˆ–è€…å…¨å±€æ•°æ®æ®µã€‚ å…¶ä»–3ä¸ªæ®µå¯„å­˜å™¨ä½œä¸€èˆ¬ç”¨é€”ï¼Œå¯ä»¥æŒ‡å‘ä»»æ„çš„æ•°æ®æ®µã€‚ cs å¯„å­˜å™¨è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½: å®ƒå«æœ‰ä¸€ä¸ªä¸¤ä½çš„å­—æ®µï¼Œç”¨ä»¥æŒ‡æ˜ CPU çš„å½“å‰ç‰¹æƒçº§ (Current Privilege Level, CPL)ã€‚å€¼ä¸º0ä»£è¡¨æœ€é«˜ä¼˜å…ˆçº§ï¼Œä¸ºå€¼ä¸º3ä»£è¡¨æœ€ä½ä¼˜å…ˆçº§ã€‚Linux åªç”¨0çº§å’Œ3çº§ï¼Œåˆ†åˆ«ç§°ä¹‹ä¸ºå†…æ ¸æ€å’Œç”¨æˆ·æ€ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:3:1","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"æ®µæè¿°ç¬¦ æ¯ä¸ªæ®µç”±ä¸€ä¸ª8å­—èŠ‚çš„æ®µæè¿°ç¬¦(Segment Descriptor)è¡¨ç¤ºï¼Œå®ƒæè¿°äº†æ®µçš„ç‰¹å¾ã€‚æ®µæè¿°ç¬¦æ”¾åœ¨å…¨å±€æè¿°ç¬¦è¡¨(Global Descriptor Table, GDT)æˆ–å±€éƒ¨æè¿°ç¬¦è¡¨(Local Descriptor Table, LDT)ä¸­ã€‚ GDT é€šå¸¸åªæœ‰ä¸€ä¸ªï¼Œåœ¨ä¸»å­˜ä¸­çš„åœ°å€å’Œå¤§å°å­˜æ”¾åœ¨ gdtr æ§åˆ¶å¯„å­˜å™¨ä¸­ï¼Œå½“å‰æ­£è¢«ä½¿ç”¨çš„ LDT åœ°å€å’Œå¤§å°æ”¾åœ¨ ldtr æ§åˆ¶å¯„å­˜å™¨ä¸­ã€‚ æ®µæè¿°ç¬¦å­—æ®µ å­—æ®µ å«ä¹‰ Base åŒ…å«æ®µçš„é¦–å­—èŠ‚çš„çº¿æ€§åœ°å€ G ç²’åº¦æ ‡å¿—ï¼šå¦‚æœæ”¹ä½æ¸…0ï¼Œåˆ™å¤§å°ä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œå¦åˆ™ä»¥4096å­—èŠ‚çš„å€æ•°è®¡ã€‚ Limit å­˜æ”¾æ®µä¸­æœ€åä¸€ä¸ªå†…å­˜å•å…ƒçš„åç§»é‡ï¼Œä»è€Œå†³å®šæ®µçš„é•¿åº¦ã€‚å¦‚æœ G è¢«ç½®ä¸º0ï¼Œåˆ™ä¸€ä¸ªæ®µçš„å¤§å°åœ¨1ä¸ªå­—èŠ‚åˆ°1MBä¹‹é—´å˜åŒ–ï¼›å¦åˆ™ï¼Œå°†åœ¨ 4KB åˆ° 4GB ä¹‹é—´å˜åŒ–ã€‚ S ç³»ç»Ÿæ ‡å¿—ï¼šå¦‚æœå®ƒè¢«æ¸…0ï¼Œåˆ™è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿæ®µï¼Œå­˜å‚¨è¯¸å¦‚ LDT è¿™ç§å…³é”®çš„æ•°æ®ç»“æ„ï¼Œå¦åˆ™å®ƒæ˜¯ä¸€ä¸ªæ™®é€šçš„ä»£ç æ®µæˆ–æ•°æ®æ®µã€‚ Type æè¿°äº†æ®µçš„ç±»å‹ç‰¹å¾å’Œå®ƒçš„å­˜å–æƒé™ã€‚ DPL æè¿°ç¬¦ç‰¹æƒçº§(Descriptor Privilege Level)å­—æ®µï¼šç”¨äºé™åˆ¶å¯¹è¿™ä¸ªæ®µçš„å­˜å–ã€‚å®ƒè¡¨ç¤ºä¸ºè®¿é—®è¿™ä¸ªæ®µè€Œè¦æ±‚çš„CPUæœ€å°çš„ä¼˜å…ˆçº§ã€‚å› æ­¤ï¼ŒDPLè®¾ä¸º0çš„æ®µåªèƒ½å½“ CPL ä¸º0æ—¶(å³åœ¨å†…æ ¸æ€)æ‰æ˜¯å¯è®¿é—®çš„ï¼Œè€ŒDPLè®¾ä¸º3çš„æ®µå¯¹ä»»ä½•CPLå€¼éƒ½æ˜¯å¯è®¿é—®çš„ P Segment-Presentæ ‡å¿—ï¼šç­‰äº0è¡¨ç¤ºæ®µå½“å‰ä¸åœ¨ä¸»å­˜ä¸­ã€‚Linuxæ€»æ˜¯æŠŠè¿™ä¸ªè¡¨ç¤º(ç¬¬47ä½)è®¾ä¸º1ï¼Œå› ä¸ºå®ƒä»æ¥ä¸æŠŠæ•´ä¸ªdauntäº¤æ¢åˆ°ç£ç›˜ä¸Šå»ã€‚ D æˆ– B ç§°ä¸ºDæˆ–Bçš„æ ‡å¿—ï¼Œå–å†³äºä»£ç æ®µè¿˜æ˜¯æ•°æ®æ®µã€‚Dæˆ–Bçš„å«ä¹‰åœ¨ä¸¤ç§æƒ…å†µä¸­æœ‰æ‰€åŒºåˆ«ï¼Œä½†æ˜¯å¦‚æœæ®µåç§»é‡çš„åœ°å€æ˜¯32ä½é•¿ï¼Œå°±åŸºæœ¬ä¸ŠæŠŠå®ƒç½®ä¸º1ï¼Œå¦‚æœè¿™ä¸ªåç§»é‡æ˜¯16ä½é•¿ï¼Œå®ƒè¢«æ¸…0ã€‚ AVL æ ‡å¿— å¯ä»¥ç”±æ“ä½œç³»ç»Ÿä½¿ç”¨ï¼Œä½†æ˜¯è¢« Linux å¿½ç•¥ã€‚ Linux ä¸­è¢«å¹¿æ³›é‡‡ç”¨çš„ç±»å‹: ä»£ç æ®µæè¿°ç¬¦ æ•°æ®æ®µæè¿°ç¬¦ ä»»åŠ¡çŠ¶æ€æ®µæè¿°ç¬¦ æ®µé€‰æ‹©ç¬¦å­—æ®µ: å­—æ®µ å«ä¹‰ index æŒ‡å®šäº†æ”¾åœ¨ GDT æˆ– LDT ä¸­çš„ç›¸åº”æ®µæè¿°ç¬¦çš„å…¥å£ã€‚ TI TI ((Table Indicator)æ ‡å¿—ï¼šæŒ‡æ˜æ®µæè¿°ç¬¦æ˜¯åœ¨ GDT ä¸­ (TI=0) æˆ–åœ¨ LDT ä¸­(TI=1))ã€‚ RPL è¯·æ±‚è€…ç‰¹æƒçº§ï¼šå½“ç›¸åº”çš„æ®µé€‰æ‹©ç¬¦è£…å…¥åˆ° cs å¯„å­˜å™¨ä¸­æ—¶ï¼ŒæŒ‡ç¤ºå‡º CPU å½“å‰çš„ç‰¹æƒçº§ï¼›å®ƒè¿˜å¯ä»¥ç”¨äºåœ¨è®¿é—®æ•°æ®æ®µæ—¶æœ‰é€‰æ‹©åœ°å‰Šå¼±å¤„ç†å™¨çš„ç‰¹æƒçº§ã€‚ ä¸ºäº†åŠ é€Ÿé€»è¾‘åœ°å€åˆ°çº¿æ€§åœ°å€çš„è½¬æ¢ï¼Œ80x86å¤„ç†å™¨æä¾›ä¸€ç§é™„åŠ çš„éç¼–ç¨‹çš„å¯„å­˜å™¨ï¼Œä¾›6ä¸ªå¯ç¼–ç¨‹çš„æ®µå¯„å­˜å™¨ä½¿ç”¨ã€‚ç°åœ¨ï¼Œé’ˆå¯¹é‚£ä¸ªæ®µçš„é€»è¾‘åœ°å€è½¬åŒ–å°±å¯ä»¥ä¸è®¿é—®ä¸»å­˜ä¸­çš„ GDT æˆ– LDTï¼Œå¤„ç†å™¨åªéœ€ç›´æ¥å¼•ç”¨å­˜æ”¾æ®µæè¿°ç¬¦çš„CPUå¯„å­˜å™¨å³å¯ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:3:2","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"åˆ†æ®µå•å…ƒ åˆ†æ®µå•å…ƒ(segmentation unit)æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼Œå°†ä¸€ä¸ªé€»è¾‘åœ°å€è½¬æ¢æˆç›¸åº”çš„çº¿æ€§åœ°å€ã€‚ å…ˆæ£€æŸ¥æ®µé€‰æ‹©ç¬¦çš„TIå­—æ®µï¼Œä»¥å†³å®šæ®µæè¿°ç¬¦ä¿å­˜åœ¨å“ªä¸€ä¸ªæè¿°è¡¨ä¸­ã€‚TIå­—æ®µæŒ‡æ˜æè¿°ç¬¦æ˜¯åœ¨GDTä¸­(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆ†æ®µå•å…ƒä»gdtrå¯„å­˜å™¨ä¸­å¾—åˆ°GDTçš„çº¿æ€§åŸºåœ°å€)è¿˜æ˜¯åœ¨æ¿€æ´»çš„LDTä¸­(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆ†æ®µå•å…ƒä»ldtrå¯„å­˜å™¨ä¸­å¾—åˆ°LDTçš„çº¿æ€§åŸºåœ°å€)ã€‚ ä»æ®µé€‰æ‹©ç¬¦çš„ index å­—æ®µè®¡ç®—æ®µæè¿°ç¬¦çš„åœ°å€ï¼Œindexå­—æ®µçš„å€¼ä¹˜ä»¥8(ä¸€ä¸ªæ®µæè¿°ç¬¦çš„å¤§å°)ï¼Œè¿™ä¸ªç»“æœä¸gdtræˆ–ldtrå¯„å­˜å™¨ä¸­çš„å†…å­˜ç›¸åŠ ã€‚ æŠŠé€»è¾‘åœ°å€çš„åç§»é‡ä¸æ®µæè¿°ç¬¦ Base å­—æ®µçš„å€¼ç›¸åŠ å°±å¾—åˆ°äº†çº¿æ€§åœ°å€ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:3:3","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"Linux ä¸­çš„åˆ†æ®µã€‚ Linux ä¸­ä½¿ç”¨åˆ†æ®µçš„æ–¹å¼ååˆ†æœ‰é™ã€‚åˆ†æ®µå¯ä»¥ç»™æ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸åŒçš„çº¿æ€§åœ°å€ç©ºé—´ï¼Œè€Œåˆ†é¡µå¯ä»¥æŠŠåŒä¸€çº¿æ€§åœ°å€ç©ºé—´æ˜ å°„åˆ°ä¸åŒçš„ç‰©ç†ç©ºé—´ã€‚ä¸åˆ†æ®µç›¸æ¯”ï¼ŒLinux ä¸­å€¾å‘é‡‡ç”¨åˆ†é¡µæ–¹å¼ï¼Œå› ä¸º: å½“æ‰€æœ‰çš„è¿›ç¨‹ä½¿ç”¨ç›¸åŒçš„æ®µå¯„å­˜å™¨å€¼æ—¶ï¼Œå†…å­˜ç®¡ç†å˜å¾—æ›´ç®€å•ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬èƒ½å…±äº«åŒæ ·çš„ä¸€ç»„çº¿æ€§åœ°å€ã€‚ Linux è®¾è®¡ç›®æ ‡ä¹‹ä¸€æ˜¯å¯ä»¥æŠŠå®ƒç§»æ¤åˆ°ç»å¤§å¤šæ•°æµè¡Œçš„å¤„ç†å™¨å¹³å°ä¸Šã€‚ç„¶è€Œï¼ŒRISCä½“ç³»ç»“æ„å¯¹åˆ†æ®µçš„æ”¯æŒå¾ˆæœ‰é™ã€‚ 2.6 ç‰ˆçš„ Linux åªæœ‰åœ¨ 80x86 ç»“æ„ä¸‹æ‰éœ€è¦ä½¿ç”¨åˆ†æ®µã€‚ ç›¸åº”çš„æ®µé€‰æ‹©ç¬¦ç”±å® __USER_CS, __USER_DS, __KERNEL_CS å’Œ __KERNEL_DS åˆ†åˆ«å®šä¹‰ã€‚ä¾‹å¦‚ï¼Œä¸ºäº†å¯¹å†…å­˜ä»£ç æ®µå¯»å€ï¼Œå†…æ ¸åªéœ€è¦æŠŠ __KERNEL_CS å®äº§ç”Ÿçš„å€¼è£…è¿› cs æ®µå¯„å­˜å™¨å³å¯ã€‚ æ‰€æœ‰æ®µéƒ½ä» 0x00000000 å¼€å§‹ï¼Œè¿™å¯ä»¥å¾—å‡ºå¦ä¸€ä¸ªé‡è¦çš„ç»“è®ºï¼Œå°±æ˜¯åœ¨ Linux ä¸‹é€»è¾‘åœ°å€ä¸çº¿æ€§åœ°å€æ˜¯ä¸€è‡´çš„ï¼Œæœºé€»è¾‘åœ°å€çš„åç§»é‡å­—æ®µçš„å€¼ä¸ç›¸åº”çš„çº¿æ€§åœ°å€çš„å€¼æ€»æ˜¯ä¸€è‡´çš„ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:4:0","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"Linux GDT åœ¨å•å¤„ç†å™¨ç³»ç»Ÿä¸­åªæœ‰ä¸€ä¸ª GDTï¼Œè€Œåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­æ¯ä¸ª CPU å¯¹åº”ä¸€ä¸ª GDTã€‚æ‰€æœ‰çš„ GDT éƒ½å­˜æ”¾åœ¨ cpu_gdt_table æ•°ç»„ä¸­ã€‚ä»¥ä¸‹æ˜¯ GDT çš„å¸ƒå±€ç¤ºæ„å›¾ã€‚æ¯ä¸ª GDT åŒ…å« 18 ä¸ªæ®µæè¿°ç¬¦åˆ 14 ä¸ªç©ºçš„ï¼Œæœªä½¿ç”¨çš„ï¼Œæˆ–ä¿ç•™çš„é¡¹ã€‚ æ¯ä¸€ä¸ª GDT ä¸­åŒ…å« 18 ä¸ªæ®µæè¿°ç¬¦æŒ‡å‘ä¸‹åˆ—çš„æ®µ: ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¸‹çš„ä»£ç æ®µå’Œæ•°æ®æ®µå…± 4 ä¸ªã€‚ ä»»åŠ¡çŠ¶æ€æ®µ (TSS)ï¼Œæ¯ä¸ªå¤„ç†å™¨æœ‰ 1 ä¸ªã€‚ 1 ä¸ªåŒ…æ‹¬ç¼ºçœå±€éƒ¨æè¿°ç¬¦è¡¨çš„æ®µã€‚ 3 ä¸ªå±€éƒ¨çº¿ç¨‹å­˜å‚¨ã€‚ ä¸é«˜çº§ç”µæºç®¡ç† (AMP) ç›¸å…³çš„ 3 ä¸ªæ®µã€‚ ä¸æ”¯æŒå³æ’å³ç”¨ (PnP) åŠŸèƒ½çš„ BIOS æœåŠ¡ç¨‹åºç›¸å…³çš„ 5 ä¸ªæ®µã€‚ è¢«å†…æ ¸ç”¨æ¥å¤„ç†â€œåŒé‡é”™è¯¯â€(å¤„ç†ä¸€ä¸ªå¼‚å¸¸æ˜¯å¯èƒ½å¼•å‘å¦ä¸€ä¸ªå¼‚å¸¸ï¼Œåœ¨è¿™ä¸ªæƒ…å†µä¸‹äº§ç”Ÿçš„åŒé‡é”™è¯¯)å¼‚å¸¸çš„ç‰¹æ®Š TSS æ®µã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:4:1","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"Linux LDT å¤§å¤šæ•°ç”¨æˆ·æ€ä¸‹çš„ Linux ç¨‹åºä¸ä½¿ç”¨å±€éƒ¨æè¿°ç¬¦è¡¨ï¼Œè¿™æ ·å†…æ ¸å°±å®šä¹‰äº†ä¸€ä¸ªç¼ºçœçš„ LDT ä¾›å¤§å¤šæ•°è¿›ç¨‹å…±äº«ã€‚ç¼ºçœçš„å±€éƒ¨æè¿°ç¬¦è¡¨å­˜æ”¾åœ¨ default_ldt æ•°ç»„ä¸­ã€‚ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿›ç¨‹ä»ç„¶éœ€è¦åˆ›å»ºè‡ªå·±çš„å±€éƒ¨æè¿°ç¬¦è¡¨ï¼Œè¿™å¯¹æœ‰äº›åº”ç”¨ç¨‹åºå¾ˆæœ‰ç”¨ï¼Œå¦‚ Wine ç¨‹åºã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:4:2","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"ç¡¬ä»¶ä¸­çš„åˆ†é¡µ åˆ†é¡µå•å…ƒ(paging unit)æŠŠçº¿æ€§åœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ã€‚çº¿æ€§åœ°å€è¢«åˆ†æˆä»¥å›ºå®šé•¿åº¦ä¸ºå•ä½çš„ç»„ï¼Œç§°ä¸ºé¡µ(page)ã€‚é¡µå†…éƒ¨è¿ç»­çš„çº¿æ€§åœ°å€è¢«æ˜ å°„åˆ°è¿ç»­çš„ç‰©ç†åœ°å€ä¸­ã€‚ åˆ†é¡µå•å…ƒæŠŠæ‰€æœ‰çš„ RAM åˆ†æˆå›ºå®šé•¿åº¦çš„é¡µæ¡† (page frame) (æœ‰æ—¶å«åšç‰©ç†é¡µ)ã€‚æ¯ä¸€ä¸ªé¡µæ¡†åŒ…å«ä¸€ä¸ªé¡µ (page)ï¼Œé¡µå°±æ˜¯è¯´ä¸€ä¸ªé¡µæ¡†çš„é•¿åº¦ä¸ä¸€ä¸ªé¡µçš„é•¿åº¦ä¸€è‡´ã€‚ æŠŠçº¿æ€§åœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€çš„æ•°æ®ç»“æ„ç§°ä¸ºé¡µè¡¨ (page table)ã€‚é¡µè¡¨æ”¾åœ¨ä¸»å­˜ä¸­ï¼Œå¹¶åœ¨å¯ç”¨åˆ†é¡µå•å…ƒä¹‹å‰å¿…é¡»ç”±å†…æ ¸å¯¹é¡µè¡¨è¿›è¡Œé€‚å½“çš„åˆå§‹åŒ–ã€‚ ä» 80386 å¼€å§‹ï¼Œæ‰€æœ‰çš„ 80x86 å¤„ç†å™¨éƒ½æ”¯æŒåˆ†é¡µï¼Œå®ƒé€šè¿‡è®¾ç½® cr0 å¯„å­˜å™¨çš„ PG æ ‡å¿—å¯ç”¨ã€‚ å½“ PG=0 æ—¶ï¼Œçº¿æ€§åœ°å€å°±è¢«è§£é‡Šæˆç‰©ç†åœ°å€ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:5:0","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"å¸¸è§„åˆ†é¡µ ä» 80386 èµ·ï¼ŒIntel å¤„ç†å™¨çš„åˆ†é¡µå•å…ƒå¤„ç† 4K çš„é¡µã€‚ 32 ä½çš„çº¿æ€§åœ°å€è¢«åˆ†æˆ 3 ä¸ªåŸŸ: Directory (ç›®å½•) æœ€é«˜ 10 ä½ã€‚ Table (é¡µè¡¨) ä¸­é—´ 10 ä½ã€‚ Offset (åç§»é‡) æœ€ä½ 12 ä½ã€‚ çº¿æ€§åœ°å€çš„è½¬æ¢åˆ†ä¸¤æ­¥å®Œæˆï¼Œæ¯ä¸€æ­¥éƒ½åŸºäºä¸€ç§è½¬åŒ–è¡¨ï¼Œç¬¬ä¸€ç§è½¬æ¢è¡¨ç§°ä¸ºé¡µç›®å½•è¡¨ (page directory)ï¼Œç¬¬äºŒç§è½¬æ¢è¡¨ç§°ä¸ºé¡µè¡¨ (page table)ã€‚ æ­£åœ¨ä½¿ç”¨çš„é¡µç›®å½•çš„ç‰©ç†åœ°å€å­˜æ”¾åœ¨æ§åˆ¶å¯„å­˜å™¨ cr0 ä¸­ã€‚çº¿æ€§åœ°å€å†…çš„ Directory å­—æ®µå†³å®šç›®å½•ä¸­çš„ç›®å½•é¡¹ï¼Œè€Œç›®å½•é¡¹æŒ‡å‘é€‚å½“çš„é¡µè¡¨ã€‚åœ°å€çš„ Table å­—æ®µä¾æ¬¡åˆå†³å®šé¡µè¡¨ä¸­çš„è¡¨é¡¹ï¼Œè€Œè¡¨é¡¹å«æœ‰é¡µæ‰€åœ¨é¡µæ¡†çš„ç‰©ç†åœ°å€ã€‚Offset å­—æ®µå†³å®šé¡µæ¡†ä¹Ÿçš„ç›¸å¯¹ä½ç½®ã€‚ç”±äºå®ƒæ˜¯ 12 é•¿ï¼Œæ•…æ¯ä¸€é¡µå«æœ‰ 4096 å­—èŠ‚çš„æ•°æ®ã€‚ å‡è®¾è¿›ç¨‹éœ€è¦è¯»çº¿æ€§åœ°å€ 0x20021406 ä¸­çš„å­—èŠ‚ã€‚è¿™ä¸ªåœ°å€ç”±åˆ†é¡µå•å…ƒæŒ‰ä¸‹é¢çš„æ–¹æ³•å¤„ç†: Directory å­—æ®µçš„ 0x80 ç”¨äºé€‰æ‹©é¡µç›®å½•çš„ç¬¬ 0x80 ç›®å½•é¡¹ï¼Œæ­¤ç›®å½•é¡¹æŒ‡å‘å’Œè¯¥è¿›ç¨‹çš„é¡µç›¸å…³çš„é¡µè¡¨ã€‚ Table å­—æ®µ 0x21 ç”¨äºé€‰æ‹©é¡µè¡¨çš„ç¬¬ 0x21 è¡¨é¡¹ï¼Œæ­¤è¡¨é¡¹æŒ‡å‘åŒ…å«æ‰€éœ€é¡µçš„é¡µæ¡†ã€‚ æœ€åï¼ŒOffset å­—æ®µ 0x406 ç”¨äºåœ¨ç›®æ ‡é¡µæ¡†ä¸­è¯»åç§»é‡ä¸º 0x406 ä¸­çš„å­—èŠ‚ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:5:1","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"ç¡¬ä»¶é«˜é€Ÿç¼“å­˜ å½“ä»Šçš„å¾®å¤„ç†å™¨æ—¶é’Ÿé¢‘ç‡æ¥è¿‘å‡ ä¸ª GHzï¼Œè€ŒåŠ¨æ€ RAM èŠ¯ç‰‡çš„å­˜å–æ—¶é—´æ˜¯æ—¶é’Ÿå‘¨æœŸçš„æ•°ç™¾å€ã€‚è¿™æ„å‘³ç€ï¼Œå½“ä» RAM ä¸­å–æ“ä½œæ•°æˆ–å‘ RAM ä¸­å­˜æ”¾ç»“æœè¿™æ ·çš„æŒ‡ä»¤æ‰§è¡Œæ—¶ï¼ŒCPU å¯èƒ½ç™»å°å¾ˆé•¿æ—¶é—´ã€‚ ä¸ºäº†ç¼©å° CPU å’Œ RAM ä¹‹é—´çš„é€Ÿåº¦ä¸åŒ¹é…ï¼Œå¼•å…¥äº†ç¡¬ä»¶é«˜é€Ÿç¼“å­˜å†…å­˜(hardware cache memory)ã€‚ç¡¬ä»¶é«˜é€Ÿç¼“å­˜åŸºäºè‘—åçš„å±€éƒ¨æ€§åŸç†(locality principle)ï¼Œè¯¥åŸç†æ—¢é€‚ç”¨ç¨‹åºç»“æ„ä¹Ÿé€‚ç”¨æ•°æ®ç»“æ„ã€‚ 80x86 ä½“ç³»ç»“æ„ä¸­å¼•å…¥äº†ä¸€ä¸ªå«è¡Œ (line) çš„æ–°å•ä½ã€‚è¡Œç”±å‡ åä¸ªè¿ç»­çš„å­—èŠ‚ç»„æˆï¼Œå®ƒä»¬ä»¥è„‰å†²çªå‘æ¨¡å¼ (burst mode) åœ¨æ…¢é€Ÿ DRAM å’Œå¿«é€Ÿçš„ç”¨æ¥å®ç°é«˜é€Ÿç¼“å­˜çš„ç‰‡ä¸Šé™æ€ RAM (SRAM) ä¹‹é—´ä¼ é€ï¼Œç”¨æ¥å®ç°é«˜é€Ÿç¼“å­˜ã€‚ å¦‚å›¾ï¼Œé«˜é€Ÿç¼“å­˜å•å…ƒæ’åœ¨åˆ†é¡µå•å…ƒå’Œä¸»å†…å­˜ä¹‹é—´ã€‚å®ƒåŒ…å«ä¸€ä¸ªç¡¬ä»¶é«˜é€Ÿç¼“å­˜å†…å­˜ (hardware cache memory) å’Œä¸€ä¸ªé«˜é€Ÿç¼“å­˜æ§åˆ¶å™¨ (cache controller)ã€‚é«˜é€Ÿç¼“å­˜å†…å­˜å­˜æ”¾å†…å­˜ä¸­çœŸæ­£çš„è¡Œã€‚é«˜é€Ÿç¼“å­˜æ§åˆ¶å™¨å­˜æ”¾ä¸€ä¸ªè¡¨é¡¹æ•°ç»„ï¼Œæ¯ä¸ªè¡¨é¡¹å¯¹åº”é«˜é€Ÿç¼“å­˜å†…å­˜ä¸­çš„ä¸€ä¸ªè¡Œã€‚æ¯ä¸ªè¡¨é¡¹æœ‰ä¸€ä¸ªæ ‡ç­¾(tag)å’Œæè¿°é«˜é€Ÿç¼“å­˜è¡ŒçŠ¶æ€çš„å‡ ä¸ªæ ‡å¿—(flag)ã€‚è¿™ç§å†…å­˜ç‰©ç†åœ°å€é€šå¸¸åˆ†ä¸º3ç»„ï¼šæœ€é«˜å‡ ä½å¯¹åº”æ ‡ç­¾ï¼Œä¸­é—´å‡ ä½å¯¹åº”é«˜é€Ÿç¼“å­˜æ§åˆ¶å™¨çš„å­é›†ç´¢å¼•ï¼Œæœ€ä½å‡ ä½å¯¹åº”è¡Œå†…çš„åç§»é‡ã€‚ å½“è®¿é—®ä¸€ä¸ª RAM å­˜å‚¨å•å…ƒæ—¶ï¼ŒCPU ä»ç‰©ç†åœ°å€ä¸­æå–å‡ºå­é›†çš„ç´¢å¼•å·å¹¶æŠŠå­é›†ä¸­æ‰€æœ‰è¡Œçš„æ ‡ç­¾ä¸ç‰©ç†åœ°å€çš„é«˜å‡ ä½ç›¸æ¯”è¾ƒã€‚å¦‚æœå‘ç°æŸä¸€ä¸ªè¡Œçš„æ ‡ç­¾ä¸è¿™ä¸ªç‰©ç†åœ°å€çš„é«˜ä½ç›¸åŒï¼Œåˆ™ CPU å‘½ä¸­ä¸€ä¸ªé«˜é€Ÿç¼“å­˜ (cache hit)ï¼›å¦åˆ™ï¼Œé«˜é€Ÿç¼“å­˜æ²¡æœ‰å‘½ä¸­ (cache miss)ã€‚ å¯¹äºè¯»æ“ä½œï¼Œæ§åˆ¶å™¨ä»é«˜é€Ÿç¼“å­˜è¡Œä¸­é€‰æ‹©æ•°æ®å¹¶é€åˆ° CPU å¯„å­˜å™¨ã€‚å¯¹äºå†™æ“ä½œï¼Œæ§åˆ¶å™¨å¯èƒ½é‡‡ç”¨ä»¥ä¸‹ä¸¤ä¸ªåŸºæœ¬ç­–ç•¥ä¹‹ä¸€: é€šå†™(write-through): æ§åˆ¶å™¨æ€»æ˜¯æ—¢å†™ RAM ä¹Ÿå†™é«˜é€Ÿç¼“å­˜è¡Œï¼Œä¸ºäº†æé«˜å†™æ“ä½œçš„æ•ˆç‡å…³é—­é«˜é€Ÿç¼“å­˜ã€‚ å›å†™(write-back): åªæ›´æ–°é«˜é€Ÿç¼“å­˜è¡Œï¼Œä¸æ”¹å˜ RAM çš„å†…å­˜ï¼Œæä¾›äº†æ›´å¿«çš„æ•ˆç‡ã€‚ å¤„ç†å™¨çš„ cr0 å¯„å­˜å™¨çš„ CD æ ‡å¿—ä½ç”¨æ¥å¯ç”¨æˆ–ç¦ç”¨é«˜é€Ÿç¼“å­˜ç”µè·¯ã€‚è¿™ä¸ªå¯„å­˜å™¨ä¸­çš„ NW æ ‡å¿—æŒ‡æ˜é«˜é€Ÿç¼“å­˜æ˜¯ä½¿ç”¨é€šå†™è¿˜æ˜¯å›å†™ç­–ç•¥ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:5:2","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"Linux ä¸­çš„åˆ†é¡µ Linux é‡‡ç”¨äº†ä¸€ç§åŒæ—¶é€‚ç”¨äº32ä½å’Œ64ä½çš„æ™®é€šåˆ†é¡µæ¨¡å‹ã€‚åœ¨ 2.6.10 ç‰ˆæœ¬ä¹‹å‰ï¼ŒLinux é‡‡ç”¨ä¸‰çº§åˆ†é¡µçš„æ¨¡å‹ã€‚ä» 2.6.11 ç‰ˆæœ¬å¼€å§‹ï¼Œé‡‡ç”¨äº†å››çº§åˆ†é¡µæ¨¡å‹: é¡µå…¨å±€ç›®å½• (Page Global Directory) é¡µä¸Šçº§ç›®å½• (Page Upper Directory) é¡µä¸­é—´ç›®å½• (Page Middle Directory) é¡µè¡¨ (Page Table) é¡µå…¨å±€ç›®å½•åŒ…å«è‹¥å¹²é¡µä¸Šçº§ç›®å½•çš„åœ°å€ï¼Œé¡µä¸Šçº§ç›®å½•æœ‰ä¸€æ¬¡åŒ…å«è‹¥å¹²é¡µä¸­é—´ç›®å½•çš„åœ°å€ï¼Œè€Œé¡µä¸­é—´ç›®å½•åˆåŒ…å«è‹¥å¹²é¡µè¡¨çš„åœ°å€ã€‚æ¯ä¸€ä¸ªé¡µè¡¨é¡¹æŒ‡å‘ä¸€ä¸ªé¡µæ¡†ã€‚çº¿æ€§åœ°å€å› æ­¤è¢«åˆ†æˆäº”ä¸ªéƒ¨åˆ†ã€‚ Linux çš„è¿›ç¨‹å¤„ç†å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºåˆ†é¡µã€‚äº‹å®ä¸Šï¼Œçº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€çš„è‡ªåŠ¨è½¬æ¢ä½¿ä¸‹é¢çš„è®¾è®¡ç›®æ ‡å˜å¾—å¯è¡Œ: ç»™æ¯ä¸€ä¸ªè¿›ç¨‹åˆ†é…ä¸€å—ä¸åŒçš„ç‰©ç†åœ°å€ç©ºé—´ï¼Œè¿™ç¡®ä¿äº†å¯ä»¥æœ‰æ•ˆåœ°é˜²æ­¢å¯»å€é”™è¯¯ã€‚ åŒºåˆ«é¡µ(å³ä¸€ç»„æ•°æ®)å’Œé¡µæ¡†(å³ä¸»å­˜ä¸­çš„ç‰©ç†åœ°å€)çš„ä¸åŒã€‚è¿™å°±å…è®¸å­˜æ”¾åœ¨æŸä¸ªé¡µæ¡†ä¸­çš„ä¸€ä¸ªé¡µï¼Œç„¶åä¿å­˜åˆ°ç£ç›˜ä¸Šï¼Œä»¥åé‡æ–°è£…å…¥è¿™åŒä¸€é¡µæ˜¯åˆå¯ä»¥è¢«è£…è½½ä¸åŒçš„é¡µæ¡†ä¸­ã€‚è¿™å°±æ˜¯è™šæ‹Ÿå†…å­˜æœºåˆ¶çš„åŸºæœ¬è¦ç´ ã€‚ æ¯ä¸€ä¸ªè¿›ç¨‹æœ‰å®ƒè‡ªå·±çš„é¡µå…¨å±€ç›®å½•å’Œè‡ªå·±çš„é¡µè¡¨é›†ã€‚å½“å‘ç”Ÿè¿›ç¨‹åˆ‡æ¢æ—¶ï¼ŒLinux æŠŠ cr3 æ§åˆ¶å¯„å­˜å™¨çš„å†…å­˜ä¿å­˜åœ¨å‰ä¸€ä¸ªæ‰§è¡Œè¿›ç¨‹çš„æè¿°ç¬¦ä¸­ï¼Œç„¶åæŠŠä¸‹ä¸€ä¸ªè¦æ‰§è¡Œè¿›ç¨‹çš„æè¿°ç¬¦çš„å€¼è£…å…¥ cr3 å¯„å­˜å™¨ä¸­ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:6:0","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"çº¿æ€§åœ°å€å­—æ®µ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:6:1","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"é¡µè¡¨å¤„ç† ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:6:2","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"ç‰©ç†å†…å­˜å¸ƒå±€ åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œå†…æ ¸å¿…é¡»å»ºç«‹ä¸€ä¸ªç‰©ç†åœ°å€æ˜ å°„æ¥æŒ‡å®šå“ªäº›ç‰©ç†åœ°å€èŒƒå›´å¯¹å†…æ ¸å¯ç”¨è€Œå“ªäº›ä¸å¯ç”¨ã€‚ å†…æ ¸å°†ä¸‹åˆ—é¡µæ¡†è®°ä¸ºä¿ç•™: åœ¨ä¸å¯ç”¨çš„ç‰©ç†åœ°å€èŒƒå›´å†…çš„é¡µæ¡†ã€‚ å«æœ‰å†…æ ¸ä»£ç å’Œå·²åˆå§‹åŒ–çš„æ•°æ®ç»“æ„çš„é¡µæ¡†ã€‚ ä» 0x07ff0000 åˆ° 0x07ff2fff çš„ç‰©ç†åœ°å€èŒƒå›´ä¸­å­˜æœ‰åŠ ç”µè‡ªæ£€(POST)é˜¶æ®µç”±BIOSå†™å…¥çš„ç³»ç»Ÿç¡¬ä»¶è®¾å¤‡ä¿¡æ¯ã€‚åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œå†…æ ¸æŠŠè¿™äº›ä¿¡æ¯æ‹·è´åˆ°ä¸€ä¸ªåˆé€‚çš„å†…æ ¸æ•°æ®ç»“æ„ä¸­ï¼Œç„¶åè®¤ä¸ºè¿™äº›é¡µæ¡†æ˜¯å¯ç”¨çš„ã€‚ç›¸åï¼Œä» 0x07ff3000 åˆ° 0x07ffffff çš„ç‰©ç†åœ°å€èŒƒå›´è¢«æ˜ å°„åˆ°ç¡¬ä»¶è®¾å¤‡çš„ ROM èŠ¯ç‰‡ã€‚ä» 0xffff0000 å¼€å§‹çš„ç‰©ç†åœ°å€èŒƒå›´æ ‡è®°ä¸ºä¿ç•™ï¼Œå› ä¸ºå®ƒç”±ç¡¬ä»¶åœ°å€æ˜ å°„åˆ° BIOS çš„ ROM èŠ¯ç‰‡ã€‚ Linux ç”¨ PC ä½“ç³»ç»“æ„æœªä¿ç•™çš„é¡µæ¡†æ¥åŠ¨æ€å­˜æ”¾æ‰€åˆ†é…çš„é¡µã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:6:3","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"è¿›ç¨‹é¡µè¡¨ è¿›ç¨‹çš„çº¿æ€§åœ°å€ç©ºé—´åˆ†æˆä¸¤éƒ¨åˆ†: ä» 0x00000000 åˆ° 0xbfffffff çš„çº¿æ€§åœ°å€ï¼Œæ— è®ºè¿›ç¨‹è¿è¡Œåœ¨ç”¨æˆ·æ€è¿˜æ˜¯å†…æ ¸æ€éƒ½å¯ä»¥å¯»å€ã€‚ ä» 0xc0000000 åˆ° 0xffffffff çš„çº¿æ€§åœ°å€ï¼Œåªæœ‰å†…æ ¸æ€çš„è¿›ç¨‹æ‰èƒ½å¯»å€ã€‚ å½“è¿›ç¨‹è¿è¡Œåœ¨ç”¨æˆ·æ€æ—¶ï¼Œå®ƒäº§ç”Ÿçš„çº¿æ€§åœ°å€å°äº 0xc0000000ï¼›å½“è¿›ç¨‹è¿è¡Œåœ¨å†…æ ¸æ€æ—¶ï¼Œå®ƒæ‰§è¡Œå†…æ ¸ä»£ç ï¼Œæ‰€äº§ç”Ÿçš„åœ°å€å¤§äºç­‰äº 0xc0000000ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:6:4","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"å†…æ ¸é¡µè¡¨ å†…æ ¸ç»´æŒç€ä¸€ç»„è‡ªå·±ä½¿ç”¨çš„é¡µè¡¨ï¼Œé©»ç•™åœ¨ä¸»å†…æ ¸é¡µå…¨å±€ç›®å½•(master kernel Page Global Directory)ä¸­ã€‚ å†…æ ¸å¦‚ä½•åˆå§‹åŒ–è‡ªå·±çš„é¡µè¡¨: å†…æ ¸åˆ›å»ºä¸€ä¸ªæœ‰é™çš„åœ°å€ç©ºé—´ï¼ŒåŒ…æ‹¬å†…æ ¸çš„ä»£ç æ®µå’Œæ•°æ®æ®µã€åˆå§‹é¡µè¡¨å’Œç”¨äºå­˜æ”¾åŠ¨æ€æ•°æ®ç»“æ„çš„128KBå¤§å°çš„ç©ºé—´ã€‚è¿™ä¸ªæœ€å°é™åº¦çš„åœ°å€ç©ºé—´ä»…å¤Ÿå°†å†…æ ¸è£…å…¥RAMå’Œå¯¹å…¶åˆå§‹åŒ–çš„æ•°æ®ç»“æ„ã€‚ å†…æ ¸å……åˆ†åˆ©ç”¨å‰©ä½™çš„RAMå¹¶é€‚å½“åœ°å»ºç«‹åˆ†é¡µè¡¨ã€‚ å»ºç«‹åˆ†é¡µè¡¨çš„è¯¦ç»†æ­¥éª¤: ä¸´æ—¶é¡µå…¨å±€ç›®å½•æ”¾åœ¨ swapper_pg_dir å˜é‡ä¸­ï¼Œä¸´æ—¶é¡µè¡¨åœ¨ pg0 å˜é‡å‡ºå¼€å§‹å­˜æ”¾ï¼Œç´§æ¥åœ¨å†…æ ¸æœªåˆå§‹åŒ–çš„æ•°æ®æ®µåé¢ã€‚å†…æ ¸åœ¨åˆå§‹åŒ–çš„ç¬¬ä¸€é˜¶æ®µï¼Œå¯ä»¥é€šè¿‡ä¸ç‰©ç†åœ°å€ç›¸åŒçš„çº¿æ€§åœ°å€æˆ–è€…é€šè¿‡ä» 0xc0000000 å¼€å§‹çš„ 8MB çº¿æ€§åœ°å€å¯¹ RAM çš„å‰ 8MB è¿›è¡Œå¯»å€ã€‚ å†…æ ¸é€šè¿‡æŠŠ swapper_pg_dir æ‰€æœ‰é¡¹éƒ½å¡«å……ä¸º0æ¥åˆ›å»ºæœŸæœ›çš„æ˜ å°„ï¼Œ0ã€1ã€0x300(768)å’Œ0x301(769)é™¤å¤–ï¼Œå®ƒä»¬çš„åˆå§‹åŒ–å¦‚ä¸‹ï¼š 0 é¡¹å’Œ 0x300 é¡¹çš„åœ°å€å­—æ®µç½®ä¸º pg0 çš„ç‰©ç†åœ°å€ï¼Œè€Œ 1 é¡¹å’Œ 0x301 é¡¹çš„åœ°å€å­—æ®µç½®ä¸ºç´§éš pg0 åçš„é¡µæ¡†çš„ç‰©ç†åœ°å€ã€‚ æŠŠè¿™å››ä¸ªé¡¹ä¸­çš„ Presentã€Read/Write å’Œ User/Supervisor æ ‡å¿—ç½®é›¶ã€‚ æŠŠè¿™å››ä¸ªé¡¹ä¸­çš„ Accessedã€Dirtyã€PCDã€PWD å’Œ Page Size æ ‡å¿—è¯·0ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:6:5","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"å›ºå®šæ˜ å°„çš„çº¿æ€§åœ°å€ æˆ‘ä»¬çœ‹åˆ°å†…æ ¸çº¿æ€§åœ°å€ç¬¬å››ä¸ªGBçš„åˆå§‹åŒ–éƒ¨åˆ†æ˜ å°„ç³»ç»Ÿçš„ç‰©ç†å†…å­˜ã€‚ä½†æ˜¯ï¼Œè‡³å°‘128MBçš„çº¿æ€§åœ°å€æ€»æ˜¯ç•™ä½œå®ƒç”¨ï¼Œå› ä¸ºå†…æ ¸ä½¿ç”¨è¿™äº›çº¿æ€§åœ°å€å®ç°éè¿ç»­å†…å­˜åˆ†é…å’Œå›ºå®šæ˜ å°„çš„çº¿æ€§åœ°å€ã€‚ å›ºå®šæ˜ å°„çš„çº¿æ€§åœ°å€(fix-mapped linear address)åŸºæœ¬ä¸Šæ˜¯ä¸€ç§ç±»ä¼¼äº 0xffffc000 è¿™æ ·çš„å¸¸é‡çº¿æ€§åœ°å€ï¼Œå…¶å¯¹åº”çš„ç‰©ç†åœ°å€ä¸å¿…ç­‰äºçº¿æ€§åœ°å€å‡å» 0xc000000ã€‚å†…æ ¸ä½¿ç”¨å›ºå®šæ˜ å°„çš„çº¿æ€§åœ°å€æ¥ä»£æ›¿æŒ‡é’ˆå˜é‡ï¼Œå› ä¸ºè¿™äº›æŒ‡é’ˆå˜é‡çš„å€¼ä»ä¸æ”¹å˜ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E5%AD%98/:6:6","tags":null,"title":"Linuxå†…å­˜","uri":"/linux%E5%86%85%E5%AD%98/"},{"categories":null,"content":"Linuxå†…æ ¸åŒæ­¥ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/:0:0","tags":null,"title":"Linuxå†…æ ¸åŒæ­¥","uri":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"},{"categories":null,"content":"å†…æ ¸æŠ¢å  æŠ¢å å†…æ ¸çš„ä¸»è¦ç‰¹ç‚¹æ˜¯: ä¸€ä¸ªåœ¨å†…æ ¸æ€è¿è¡Œçš„è¿›ç¨‹ï¼Œå¯èƒ½åœ¨æ‰§è¡Œå†…æ ¸å‡½æ•°æœŸé—´è¢«å¦å¤–ä¸€ä¸ªè¿›ç¨‹å–ä»£ã€‚ ç”¨å®ä¾‹æ¥è¯´æ˜æŠ¢å å†…æ ¸å’ŒéæŠ¢å å†…æ ¸çš„åŒºåˆ«: åœ¨è¿›ç¨‹Aæ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åºæ—¶ï¼Œä¸€ä¸ªå…·æœ‰è¾ƒé«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹Bå˜ä¸ºå¯æ‰§è¡ŒçŠ¶æ€ã€‚è¿™ç§æƒ…å†µæ˜¯æœ‰å¯èƒ½å‡ºç°çš„ï¼Œä¾‹å¦‚ï¼Œå‘ç”Ÿäº†ä¸­æ–­è¯·æ±‚è€Œä¸”ç›¸åº”çš„å¤„ç†ç¨‹åºå”¤é†’äº†è¿›ç¨‹Bã€‚å¦‚æœå†…æ ¸æ˜¯æŠ¢å çš„ï¼Œå°±ä¼šå‘ç”Ÿå¼ºåˆ¶æ€§è¿›ç¨‹åˆ‡æ¢ï¼Œè®©è¿›ç¨‹Bå–ä»£è¿›ç¨‹Aã€‚å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ‰§è¡Œè¢«æš‚åœï¼Œç›´åˆ°è°ƒåº¦ç¨‹åºå†æ¬¡é€‰æ‹©è¿›ç¨‹Aæ—¶æ‰æ¢å¤å®ƒçš„æ‰§è¡Œã€‚ç›¸åï¼Œå¦‚æœå†…æ ¸æ˜¯éæŠ¢å çš„ï¼Œåœ¨è¿›ç¨‹Aå®Œæˆå¼‚å¸¸å¤„ç†ç¨‹åºçš„æ‰§è¡Œä¹‹å‰ï¼Œæ˜¯ä¸ä¼šå‘ç”Ÿè¿›ç¨‹åˆ‡æ¢çš„ï¼Œé™¤éè¿›ç¨‹Aè‡ªåŠ¨æ”¾å¼ƒCPUã€‚ ä¸€ä¸ªæ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åºçš„è¿›ç¨‹å·²ç»ç”¨å®Œäº†å®ƒçš„æ—¶é—´é…é¢ï¼Œå¦‚æœå†…æ ¸æ˜¯æŠ¢å çš„ï¼Œè¿›ç¨‹å¯èƒ½ä¼šç«‹å³è¢«å–ä»£ï¼Œä½†å¦‚æœå†…æ ¸æ˜¯éæŠ¢å çš„ï¼Œè¿›ç¨‹ç»§ç»­è¿è¡Œç›´åˆ°å®ƒæ‰§è¡Œå®Œå¼‚å¸¸å¤„ç†ç¨‹åºæˆ–è‡ªåŠ¨æ”¾å¼ƒCPUã€‚ ä½¿å†…æ ¸å¯æŠ¢å çš„ç›®çš„æ˜¯å‡å°‘ç”¨æˆ·æ€è¿›ç¨‹çš„åˆ†æ´¾å»¶è¿Ÿ(dispatch letency)ï¼Œå³ä»è¿›ç¨‹å˜ä¸ºå¯æ‰§è¡ŒçŠ¶æ€åˆ°å®ƒå®é™…å¼€å§‹è¿è¡Œä¹‹é—´çš„æ—¶é—´é—´éš”ã€‚ åªæœ‰å½“å†…æ ¸æ­£åœ¨æ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åº(å°¤å…¶æ˜¯ç³»ç»Ÿè°ƒç”¨)ï¼Œè€Œä¸”å†…æ ¸æŠ¢å æ²¡æœ‰æ˜¾å¼åœ°ç¦ç”¨æ—¶ï¼Œæ‰å¯èƒ½æŠ¢å å†…æ ¸ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/:1:0","tags":null,"title":"Linuxå†…æ ¸åŒæ­¥","uri":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"},{"categories":null,"content":"åŒæ­¥åŸè¯­ æŠ€æœ¯ è¯´æ˜ é€‚ç”¨èŒƒå›´ æ¯CPUå˜é‡ åœ¨CPUä¹‹é—´å¤åˆ¶æ•°æ®ç»“æ„ æ‰€æœ‰CPU åŸå­æ“ä½œ å¯¹ä¸€ä¸ªè®¡æ•°å™¨åŸå­åœ°\"è¯»-ä¿®æ”¹-å†™\"çš„æŒ‡ä»¤ æ‰€æœ‰CPU å†…å­˜å±éšœ é¿å…æŒ‡ä»¤é‡æ–°æ’åº æœ¬åœ°CPUæˆ–æ‰€æœ‰CPU è‡ªæ—‹é” åŠ é”æ—¶å¿™ç­‰ æ‰€æœ‰CPU ä¿¡å·é‡ åŠ é”æ—¶é˜»å¡ç­‰å¾…(ç¡çœ ) æ‰€æœ‰CPU é¡ºåºé” åŸºäºè®¿é—®è®¡æ•°å™¨çš„é” æ‰€æœ‰CPU æœ¬åœ°ä¸­æ–­çš„ç¦æ­¢ ç¦æ­¢å•ä¸ªCPUä¸Šçš„ä¸­æ–­å¤„ç† æœ¬åœ°CPU æœ¬åœ°è½¯ä¸­æ–­çš„ç¦æ­¢ ç¦æ­¢å•ä¸ªCPUä¸Šçš„å¯å»¶è¿Ÿå‡½æ•°å¤„ç† æœ¬åœ°CPU è¯»-æ‹·è´-æ›´æ–°(RCU) é€šè¿‡æŒ‡æ­£è€Œä¸æ˜¯é”æ¥è®¿é—®å…±äº«æ•°æ®ç»“æ„ æ‰€æœ‰CPU ","date":"2021-12-03","objectID":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/:2:0","tags":null,"title":"Linuxå†…æ ¸åŒæ­¥","uri":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"},{"categories":null,"content":"æ¯CPUå˜é‡ æœ€ç®€å•ä¹Ÿæ˜¯æœ€é‡è¦çš„åŒæ­¥æŠ€æœ¯åŒ…æ‹¬æŠŠå†…æ ¸å˜é‡å£°æ˜ä¸ºæ¯CPUå˜é‡(per-cpu variable)ã€‚æ¯CPUå˜é‡ä¸»è¦æ˜¯æ•°æ®ç»“æ„çš„æ•°ç»„å˜é‡ä¸»è¦æ˜¯æŠ€æœ¯ç»“æ„çš„æ•°ç»„ï¼Œç³»ç»Ÿçš„æ¯ä¸ªCPUå¯¹åº”æ•°ç»„çš„ä¸€ä¸ªå…ƒç´ ã€‚ è™½ç„¶æ¯CPUå˜é‡ä¸ºæ¥è‡ªä¸åŒCPUçš„å¹¶å‘è®¿é—®æä¾›ä¿æŠ¤ï¼Œä½†å¯¹æ¥è‡ªå¼‚æ­¥å‡½æ•°(ä¸­æ–­å¤„ç†ç¨‹åºå’Œå¯å»¶è¿Ÿå‡½æ•°)çš„è®¿é—®ä¸æä¾›ä¿æŠ¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹éœ€è¦å¦å¤–çš„åŒæ­¥åŸè¯­ã€‚ æ­¤å¤–ï¼Œåœ¨å•å¤„ç†å™¨å’Œå¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œå†…æ ¸æŠ¢å éƒ½å¯èƒ½æ˜¯æ¯CPUå˜é‡äº§ç”Ÿç«äº‰æ¡ä»¶ã€‚æ€»çš„åŸåˆ™æ˜¯å†…æ ¸æ§åˆ¶è·¯å¾„åº”è¯¥åœ¨ç¦ç”¨æŠ¢å çš„æƒ…å†µä¸‹è®¿é—®æ¯CPUå˜é‡ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/:2:1","tags":null,"title":"Linuxå†…æ ¸åŒæ­¥","uri":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"},{"categories":null,"content":"åŸå­æ“ä½œ é€šè¿‡åŸå­æ“ä½œæŒ‡ä»¤å®Œæˆã€‚ 80x86 æŒ‡ä»¤: è¿›è¡Œé›¶æ¬¡æˆ–ä¸€æ¬¡å¯¹é½å†…å­˜è®¿é—®çš„æ±‡ç¼–æŒ‡ä»¤æ˜¯åŸå­çš„ã€‚ å¦‚æœåœ¨è¯»æ“ä½œä¹‹åï¼Œå†™æ“ä½œä¹‹å‰æ²¡æœ‰å…¶ä»–å¤„ç†å™¨å ç”¨å†…å­˜æ€»çº¿ï¼Œé‚£ä¹ˆä»å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œæ›´æ–°æ•°ç»„å¹¶æŠŠæ›´æ–°åæ•°ç»„å†™å›å†…å­˜ä¸­çš„è¿™äº›\"è¯»-ä¿®æ”¹-å†™\"æ±‡ç¼–è¯­è¨€æŒ‡ä»¤(ä¾‹å¦‚incæˆ–dec)æ˜¯åŸå­çš„ã€‚å½“ç„¶ï¼Œåœ¨å•å¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œæ°¸è¿œéƒ½ä¸ä¼šå‘ç”Ÿå†…å­˜æ€»çº¿çªƒç”¨çš„æƒ…å†µã€‚ æ“ä½œå—å‰ç¼€æ˜¯ lock å­—èŠ‚(0xf0)çš„\"è¯»-ä¿®æ”¹-å†™\"æ±‡ç¼–è¯­è¨€æŒ‡ä»¤å³ä½¿åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ä¹Ÿæ˜¯åŸå­çš„ã€‚å½“æ§åˆ¶å•å…ƒæ£€æµ‹åˆ°è¿™ä¸ªå‰ç¼€æ—¶ï¼Œå°±\"é”å®š\"å†…å­˜æ€»çº¿ï¼ŒçŸ¥é“è¿™æ¡æŒ‡ä»¤æ‰§è¡Œå®Œæˆä¸ºæ­¢ã€‚å› æ­¤ï¼Œå½“åŠ é”çš„æŒ‡ä»¤æ‰§è¡Œæ—¶ï¼Œå…¶ä»–å¤„ç†å™¨ä¸èƒ½è®¿é—®è¿™ä¸ªå†…å­˜å•å…ƒã€‚ æ“ä½œç å‰ç¼€æ˜¯ä¸€ä¸ªrepå­—èŠ‚(0xf2,0xf3)çš„æ±‡ç¼–è¯­è¨€æ‰§è¡Œä¸æ˜¯åŸå­çš„ï¼Œè¿™æ¡æŒ‡ä»¤å¼ºè¡Œè®©æ§åˆ¶å•å…ƒå¤šæ¬¡é‡å¤æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤ã€‚æ§åˆ¶å•å…ƒåœ¨æ‰§è¡Œæ–°çš„å¾ªç¯ä¹‹å‰è¦æ£€æŸ¥æŒ‚èµ·çš„ä¸­æ–­ã€‚ Linux å†…æ ¸æä¾›äº†ä¸€ä¸ªä¸“é—¨çš„ atomic_t ç±»å‹(ä¸€ä¸ªåŸå­è®¿é—®è®¡æ•°å™¨)å’Œä¸€äº›ä¸“é—¨çš„å‡½æ•°å’Œå®ï¼Œè¿™äº›å‡½æ•°å’Œå®ä½œç”¨äº atomic_t ç±»å‹çš„å˜é‡ï¼Œå¹¶å½“ä½œå•ç‹¬çš„ã€åŸå­çš„æ±‡ç¼–è¯­è¨€æŒ‡ä»¤æ¥ä½¿ç”¨ã€‚åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œæ¯æ¡è¿™æ ·çš„æŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ª lock å­—èŠ‚çš„å‰ç¼€ã€‚ å¦ä¸€ç±»åŸå­å‡½æ•°æ“ä½œä½œç”¨äºä½æ©ç  ","date":"2021-12-03","objectID":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/:2:2","tags":null,"title":"Linuxå†…æ ¸åŒæ­¥","uri":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"},{"categories":null,"content":"ä¼˜åŒ–å’Œå†…å­˜å±éšœ å½“ä½¿ç”¨ä¼˜åŒ–çš„ç¼–è¯‘å™¨æ—¶ï¼Œç¼–è¯‘å™¨å¯èƒ½é‡æ–°å®‰æ’æ±‡ç¼–è¯­è¨€æŒ‡ä»¤å·²ä½¿å¯„å­˜å™¨ä»¥æœ€ä¼˜çš„æ–¹å¼ä½¿ç”¨ã€‚æ­¤å¤–ï¼Œç°ä»£CPUé€šå¸¸å¹¶è¡Œåœ°æ‰§è¡Œè‹¥å¹²æ¡æŒ‡ä»¤ï¼Œä¸”å¯èƒ½é‡æ–°å®‰æ’å†…å­˜è®¿é—®ã€‚ç„¶è€Œï¼Œå½“å¤„ç†åŒæ­¥æ—¶ï¼Œå¿…é¡»é¿å…æŒ‡ä»¤é‡æ–°æ’åºã€‚ ä¼˜åŒ–å±éšœ(optimization barrier) åŸè¯­ä¿è¯ç¼–è¯‘ç¨‹åºä¸ä¼šæ··æ·†æ”¾åœ¨åŸè¯­æ“ä½œä¹‹å‰çš„æ±‡ç¼–è¯­è¨€æŒ‡ä»¤å’Œæ”¾åœ¨åŸè¯­æ“ä½œä¹‹åçš„æ±‡ç¼–è¯­è¨€æŒ‡ä»¤ï¼Œè¿™äº›æ±‡ç¼–è¯­è¨€æŒ‡ä»¤åœ¨Cä¸­éƒ½æœ‰å¯¹åº”çš„è¯­å¥ã€‚åœ¨Linuxä¸­ï¼Œä¼˜åŒ–å±éšœå°±æ˜¯ barrier() å®ï¼Œå®ƒå±•å¼€ asm volatile(\"\":::\"memory\") ã€‚æŒ‡ä»¤ asm å‘Šè¯‰ç¼–è¯‘ç¨‹åºè¦æ’å…¥æ±‡ç¼–è¯­è¨€ç‰‡æ®µ(è¿™ç§æƒ…å†µä¸‹ä¸ºç©º)ã€‚volatile å…³é”®å­—ç¦æ­¢ç¼–è¯‘å™¨æŠŠasmæŒ‡ä»¤ä¸ç¨‹åºä¸­çš„å…¶ä»–æŒ‡ä»¤é‡æ–°ç»„åˆã€‚memory å…³é”®å­—å¼ºåˆ¶ç¼–è¯‘å™¨å‡å®šRAMä¸­çš„æ‰€æœ‰å†…å­˜å•å…ƒå·²ç»è¢«æ±‡ç¼–è¯­è¨€æŒ‡ä»¤ä¿®æ”¹ã€‚ å†…å­˜å±éšœ(memory barrier)åŸè¯­ç¡®ä¿ï¼Œåœ¨åŸè¯­ä¹‹åçš„æ“ä½œå¼€å§‹æ‰§è¡Œä¹‹å‰ï¼ŒåŸè¯­ä¹‹å‰çš„æ“ä½œå·²ç»å®Œæˆã€‚å› æ­¤ï¼Œå†…å­˜å±éšœç±»ä¼¼äºé˜²ç«å¢™ï¼Œè®©ä»»ä½•æ±‡ç¼–è¯­è¨€æŒ‡ä»¤éƒ½ä¸èƒ½é€šè¿‡ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/:2:3","tags":null,"title":"Linuxå†…æ ¸åŒæ­¥","uri":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"},{"categories":null,"content":"è‡ªæ—‹é” è‡ªæ—‹é”(spin lock)æ˜¯ç”¨æ¥åœ¨å¤šå¤„ç†å™¨ç¯å¢ƒä¸­å·¥ä½œçš„ä¸€ç§ç‰¹æ®Šçš„é”ã€‚å¦‚æœå†…æ ¸æ§åˆ¶è·¯å¾„å‘ç°è‡ªæ—‹é”\"å¼€ç€\"ï¼Œå°±è·å–é”å¹¶ç»§ç»­è‡ªå·±çš„æ‰§è¡Œã€‚ç›¸åï¼Œå¦‚æœå†…æ ¸æ§åˆ¶è·¯å¾„å‘ç°é”ç”±è¿è¡Œåœ¨å¦ä¸€ä¸ªCPUä¸Šçš„å†…æ ¸æ§åˆ¶è·¯å¾„\"é”ç€\"ï¼Œå°±åœ¨å‘¨å›´\"æ—‹è½¬\"ï¼Œåå¤æ‰§è¡Œä¸€æ¡ç´§å‡‘çš„å¾ªç¯æŒ‡ä»¤ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚ è‡ªæ—‹é”çš„å¾ªç¯æŒ‡ä»¤è¡¨ç¤º\"å¿™ç­‰\"ã€‚å³ä½¿ç­‰å¾…çš„å†…æ ¸æ§åˆ¶è·¯å¾„æ— äº‹å¯åšï¼Œå®ƒä¹Ÿåœ¨CPUä¸Šä¿æŒè¿è¡Œã€‚ä¸è¿‡ï¼Œè‡ªæ—‹é”é€šå¸¸éå¸¸æ–¹ä¾¿ï¼Œå› ä¸ºå¾ˆå¤šå†…æ ¸èµ„æºåªé”1æ¯«ç§’çš„æ—¶é—´ç‰‡æ®µï¼›æ‰€ä»¥è¯´ï¼Œé‡Šæ”¾CPUå’Œéšåæœ‰è·å¾—CPUéƒ½ä¸ä¼šæ¶ˆè€—å¤šå°‘æ—¶é—´ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œç”±è‡ªæ—‹é”ä¿æŠ¤çš„æ¯ä¸ªä¸´ç•ŒåŒºéƒ½æ˜¯ç¦æ­¢å†…æ ¸æŠ¢å çš„ã€‚åœ¨å•å¤„ç†å™¨ç³»ç»Ÿä¸Šï¼Œè¿™ä¸­é”æœ¬èº«å¹¶ä¸èµ·é”çš„ä½œç”¨ï¼Œè‡ªæ—‹é”åŸè¯­ä»…ä»…æ˜¯ç¦æ­¢æˆ–å¯ç”¨å†…æ ¸æŠ¢å ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‡ªæ—‹è½¬å¿™ç­‰æœŸé—´ï¼Œå†…æ ¸æŠ¢å è¿˜æ˜¯æœ‰æ•ˆçš„ï¼Œå› æ­¤ï¼Œç­‰å¾…è‡ªæ—‹é”é‡Šæ”¾çš„è¿›ç¨‹æœ‰å¯èƒ½è¢«æ›´é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹æ›¿ä»£ã€‚ è¯»/å†™è‡ªæ—‹é” è¯»/å†™è‡ªæ—‹é”çš„å¼•å…¥æ˜¯ä¸ºäº†å¢åŠ æ˜¯å†…æ ¸çš„å¹¶å‘èƒ½åŠ›ã€‚åªè¦æ²¡æœ‰å†…æ ¸æ§åˆ¶è·¯å¾„å¯¹æ•°æ®ç»“æ„è¿›è¡Œä¿®æ”¹ï¼Œè¯»/å†™è‡ªæ—‹é”å°±å…è®¸å¤šä¸ªå†…æ ¸æ§åˆ¶è·¯å¾„åŒæ—¶è¯»åŒä¸€æ•°æ®ç»“æ„ã€‚å¦‚æœä¸€ä¸ªå†…æ ¸æ§åˆ¶è·¯å¾„æƒ³å¯¹è¿™ä¸ªç»“æ„è¿›è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆå®ƒå¿…é¡»é¦–å…ˆè·å–è¯»/å†™é”çš„å†™é”ï¼Œå†™é”æˆæƒç‹¬å è®¿é—®è¿™ä¸ªèµ„æºã€‚å½“ç„¶ï¼Œå…è®¸å¯¹æ•°æ®ç»“æ„å¹¶å‘è¯»å¯ä»¥æé«˜ç³»ç»Ÿæ€§èƒ½ã€‚ é¡ºåºé” Linux 2.6 ä¸­å¼•å…¥é¡ºåºé”(seqlock)ï¼Œå®ƒä¸è¯»/å†™è‡ªæ—‹é”éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯å®ƒä¸ºå†™è€…èµ‹äºˆäº†è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼›äº‹å®ä¸Šï¼Œå³ä½¿åœ¨è¯»è€…æ­£åœ¨è¯»çš„æ—¶å€™ï¼Œä¹Ÿå…è®¸å†™è€…ç»§ç»­è¿è¡Œã€‚è¿™ç§ç­–ç•¥çš„å¥½å¤„æ˜¯å†™è€…æ°¸è¿œä¸ä¼šç­‰å¾…(é™¤éå¦å¤–ä¸€ä¸ªå†™è€…æ­£åœ¨å†™)ï¼Œç¼ºç‚¹æ˜¯æœ‰äº›æ—¶å€™è¯»è€…ä¸å¾—ä¸åå¤å¤šæ¬¡è¯»ç›¸åŒçš„æ•°æ®ç›´åˆ°å®ƒè·å¾—æœ‰æ•ˆçš„å‰¯æœ¬ã€‚ æ¯ä¸ªè¯»è€…éƒ½å¿…é¡»åœ¨è¯»æ•°æ®å‰åä¸¤æ¬¡è¯»é¡ºåºè®¡æ•°å™¨ï¼Œå¹¶æ£€æŸ¥é›¶æ¬¡è¯»åˆ°çš„å€¼æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸ç›¸åŒï¼Œè¯´æ˜æ–°çš„å†™è€…å·²ç»å¼€å§‹å†™å¹¶å¢åŠ äº†é¡ºåºè®¡æ•°å™¨ï¼Œå› æ­¤æš—ç¤ºè¯»è€…åˆšè¯»åˆ°çš„æ•°æ®æ˜¯æ— æ•ˆçš„ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œå¿…é¡»åœ¨æ»¡è¶³ä¸‹è¿°æ¡ä»¶æ˜¯æ‰èƒ½ä½¿ç”¨é¡ºåºé”: è¢«ä¿æŠ¤çš„æ•°æ®ç»“æ„ä¸åŒ…æ‹¬è¢«å†™è€…ä¿®æ”¹å’Œè¢«è¯»è€…é—´æ¥å¼•ç”¨çš„æŒ‡é’ˆã€‚ è¯»è€…çš„ä¸´ç•Œä»£ç æ²¡æœ‰å‰¯ä½œç”¨ã€‚ è¯»-æ‹·è´-æ›´æ–°(RCU) è¯»-æ‹·è´-æ›´æ–°(RCU)æ˜¯ä¸ºäº†ä¿æŠ¤åœ¨å¤šæ•°æƒ…å†µä¸‹è¢«å¤šä¸ªCPUè¯»çš„æ•°æ®ç»“æ„è€Œè®¾è®¡çš„é›¶ä¸€ç§åŒæ­¥æŠ€æœ¯ã€‚RCUå…è®¸å¤šä¸ªè¯»è€…å’Œå†™è€…å¹¶å‘æ‰§è¡Œ(ç›¸å¯¹äºåªå…è®¸ä¸€ä¸ªå†™è€…æ‰§è¡Œçš„é¡ºåºé”æœ‰äº†æ”¹è¿›)ã€‚è€Œä¸”ï¼ŒRCUæ˜¯ä¸ä½¿ç”¨é”çš„ï¼Œå°±æ˜¯è¯´ï¼Œå®ƒä¸ä½¿ç”¨è¢«æ‰€æœ‰CPUå…±äº«çš„é”æˆ–è®¡æ•°å™¨ï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Šä¸è¯»/å†™è‡ªæ—‹é”å’Œé¡ºåºé”(ç”±äºé«˜é€Ÿç¼“å­˜è¡Œçªƒç”¨å’Œå¤±æ•ˆæœ‰å¾ˆé«˜çš„å¼€é”€)ç›¸æ¯”ï¼ŒRCU å…·æœ‰æ›´å¤§çš„ä¼˜åŠ¿ã€‚ RCU æ˜¯å¦‚ä½•ä¸æ˜¯ç”¨å…±äº«æ•°æ®ç»“æ„è€Œä»¤äººæƒŠè®¶åœ°å®ç°å¤šä¸ªCPUåŒæ­¥å‘¢ï¼Ÿå…¶å…³é”®çš„æ€æƒ³åŒ…æ‹¬é™åˆ¶RCUçš„èŒƒå›´ï¼Œå¦‚ä¸‹æ‰€è¿°: RCU åªä¿æŠ¤è¢«åŠ¨æ€åˆ†é…å¹¶é€šè¿‡æŒ‡é’ˆå¼•ç”¨çš„æ•°æ®ç»“æ„ã€‚ åœ¨è¢« RCU ä¿æŠ¤çš„ä¸´ç•ŒåŒºä¸­ï¼Œä»»ä½•å†…æ ¸æ§åˆ¶è·¯å¾„éƒ½ä¸èƒ½ç¡çœ ã€‚ å½“å†…æ ¸æ§åˆ¶è·¯å¾„è¦è¯»å– RCU ä¿æŠ¤çš„æ•°æ®ç»“æ„æ—¶ï¼Œæ‰§è¡Œ rcu_read_lock()ï¼Œå®ƒç­‰åŒäº preempt_disable()ã€‚æ¥ä¸‹æ¥ï¼Œè¯»è€…é—´æ¥å¼•ç”¨è¯¥æ•°æ®ç»“æ„æŒ‡é’ˆæ‰€å¯¹åº”çš„å†…å­˜å•å…ƒå¹¶å¼€å§‹è¯»è¿™ä¸ªæ•°æ®ç»“æ„ã€‚æ­£å¦‚åœ¨å‰é¢æ‰€å¼ºè°ƒçš„ï¼Œè¯»è€…åœ¨å®Œæˆå¯¹æ•°æ®ç»“æ„çš„è¯»æ“ä½œä¹‹å‰ï¼Œæ˜¯ä¸èƒ½ç¡çœ çš„ã€‚ç”¨ç­‰åŒäº preempt_enable() çš„å® rcu_read_unlock() æ ‡è®°ä¸´ç•ŒåŒºçš„ç»“æŸã€‚ ç”±äºè¯»è€…å‡ ä¹ä¸åšä»»ä½•äº‹æƒ…æ¥é˜²æ­¢ç«äº‰æ¡ä»¶çš„å‡ºç°ï¼Œæ‰€ä»¥å†™è€…ä¸å¾—ä¸åšå¾—æ›´å¤šä¸€äº›ã€‚äº‹å®ä¸Šï¼Œå½“å†™è€…è¦æ›´æ–°æ•°æ®ç»“æ„æ˜¯ï¼Œå®ƒé—´æ¥å¼•ç”¨æŒ‡é’ˆå¹¶ç”Ÿæˆæ•´ä¸ªæ•°æ®ç»“æ„çš„å‰¯æœ¬ã€‚æ¥ä¸‹æ¥ï¼Œå†™è€…ä¿®æ”¹è¿™ä¸ªå‰¯æœ¬ã€‚ä¸€æ—¦ä¿®æ”¹å®Œæ¯•ï¼Œå†™è€…æ”¹å˜æŒ‡å‘æ•°æ®ç»“æ„çš„æŒ‡é’ˆï¼Œä»¥ä½¿å®ƒæŒ‡å‘è¢«ä¿®æ”¹åçš„å‰¯æœ¬ã€‚ç”±äºä¿®æ”¹æŒ‡é’ˆå€¼çš„æ“ä½œæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œæ‰€ä»¥æ—§å‰¯æœ¬å’Œæ–°å‰¯æœ¬å¯¹æ¯ä¸ªè¯»è€…æˆ–å†™è€…éƒ½æ˜¯å¯è§çš„ï¼Œåœ¨æ•°æ®ç»“æ„ä¸­ä¸ä¼šå‡ºç°æ•°æ®å´©æºƒã€‚å°½ç®¡å¦‚æ­¤ï¼Œè¿˜éœ€è¦å†…å­˜å±éšœæ¥ä¿è¯: åªæœ‰åœ¨æ•°æ®ç»“æ„è¢«ä¿®æ”¹ä¹‹åï¼Œå·²æ›´æ–°çš„æŒ‡é’ˆå¯¹å…¶ä»–CPUæ‰æ˜¯å¯è§çš„ï¼Œå¦‚æœæŠŠè‡ªæ—‹é”ä¸RCUç»“åˆèµ·æ¥ä»¥ç¦æ­¢å†™è€…çš„å¹¶å‘æ‰§è¡Œï¼Œå°±éšå«åœ°å¼•å…¥äº†è¿™æ ·çš„å†…å­˜å±éšœã€‚ ç„¶è€Œï¼Œä½¿ç”¨ RCU æŠ€æœ¯çš„çœŸæ­£å›°éš¾åœ¨äº: å†™è€…ä¿®æ”¹æŒ‡é’ˆæ—¶ä¸èƒ½ç«‹å³é‡Šæ”¾æ•°æ®ç»“æ„çš„å°±å‰¯æœ¬ã€‚å®é™…ä¸Šï¼Œå†™è€…å¼€å§‹ä¿®æ”¹æ—¶ï¼Œæ­£åœ¨è®¿é—®æ•°æ®ç»“æ„çš„è¯»è€…å¯èƒ½è¿˜åœ¨è¯»å‰¯æœ¬ã€‚åªæœ‰åœ¨CPUä¸Šæ‰€æœ‰(æ½œåœ¨çš„)è¯»è€…éƒ½æ‰§è¡Œå®Œå® rcu_read_unlock() ä¹‹åï¼Œæ‰å¯ä»¥é‡Šæ”¾å°±å‰¯æœ¬ã€‚å†…æ ¸è¦æ±‚æ¯ä¸ªæ½œåœ¨çš„è¯»è€…åœ¨ä¸‹é¢çš„æ“ä½œä¹‹å‰æ‰§è¡Œ rcu_read_unlock() å®: CPU æ‰§è¡Œè¿›ç¨‹åˆ‡æ¢ CPU å¼€å§‹åœ¨ç”¨æˆ·æ€æ‰§è¡Œ CPU æ‰§è¡Œç©ºå¾ªç¯ å¯¹ä¸Šè¿°æ¯ç§æƒ…å†µï¼Œæˆ‘ä»¬è¯´CPUå·²ç»è¿‡äº†é™æ­¢çŠ¶æ€(quiescent state)ã€‚ å†™è€…è°ƒç”¨å‡½æ•° call_rcu() æ¥é‡Šæ”¾æ•°æ®ç»“æ„çš„å°±å‰¯æœ¬ã€‚å½“æ‰€æœ‰çš„ CPU éƒ½é€šè¿‡é™æ­¢çŠ¶æ€ä¹‹åï¼Œcall_rcu() æ¥å— rcu_head æè¿°ç¬¦çš„åœ°å€å’Œå°†è¦è°ƒç”¨çš„å›è°ƒå‡½æ•°çš„åœ°å€ä½œä¸ºå‚æ•°ã€‚ä¸€æ—¦å›è°ƒå‡½æ•°è¢«æ‰§è¡Œï¼Œå®ƒé€šå¸¸é‡Šæ”¾æ•°æ®ç»“æ„çš„å°±å‰¯æœ¬ã€‚ å‡½æ•° call_rcu() æŠŠå›è°ƒå‡½æ•°å’Œå…¶å‚æ•°çš„åœ°å€å­˜æ”¾åœ¨ rcu_head æè¿°ç¬¦ä¸­ï¼Œç„¶åæŠŠæè¿°ç¬¦æ’å…¥å›è°ƒå‡½æ•°çš„æ¯ä¸ª CPU (per-CPU) é“¾è¡¨ä¸­ã€‚å†…æ ¸æ¯ç»è¿‡ä¸€ä¸ªæ—¶é’Ÿæ»´ç­”å°±å‘¨æœŸæ€§åœ°æ£€æŸ¥æœ¬åœ°CPUæ˜¯å¦è¿›è¿‡äº†ä¸€ä¸ªé™æ­¢çŠ¶æ€ã€‚å¦‚æœæ‰€æœ‰CPUéƒ½ç»è¿‡äº†é™æ­¢çŠ¶æ€ï¼Œæœ¬åœ° tasklet (å®ƒçš„æè¿°ç¬¦å­˜æ”¾åœ¨æ¯CPUå˜é‡ rcu_tasklet ä¸­)å°±æ‰§è¡Œé“¾è¡¨ä¸­çš„æ‰€æœ‰å›è°ƒå‡½æ•°ã€‚ RCU æ˜¯ Linux 2.6 ä¸­æ–°åŠ çš„åŠŸèƒ½ï¼Œç”¨åœ¨ç½‘ç»œå±‚å’Œè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸­ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/:2:4","tags":null,"title":"Linuxå†…æ ¸åŒæ­¥","uri":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"},{"categories":null,"content":"ä¿¡å·é‡ Linux æä¾›ä¸¤ç§ä¿¡å·é‡ : å†…æ ¸ä¿¡å·é‡ï¼Œç”±å†…æ ¸æ§åˆ¶è·¯å¾„ä½¿ç”¨ã€‚ System V IPC ä¿¡å·é‡ï¼Œç”±ç”¨æˆ·æ€è¿›ç¨‹ä½¿ç”¨ã€‚ å†…æ ¸ä¿¡å·é‡ç±»ä¼¼äºè‡ªæ—‹é”ï¼Œå› ä¸ºå½“é”å…³é—­ç€æ—¶ï¼Œå®ƒä¸å…è®¸å†…æ ¸æ§åˆ¶è·¯å¾„ç»§ç»­è¿›è¡Œã€‚ç„¶è€Œï¼Œå½“å†…æ ¸æ§åˆ¶è·¯å¾„è¯•å›¾è·å–å†…æ ¸ä¿¡å·é‡æ‰€ä¿æŠ¤çš„å¿™èµ„æºæ—¶ï¼Œç›¸åº”çš„è¿›ç¨‹è¢«æŒ‚èµ·ã€‚åªæœ‰åœ¨èµ„æºè¢«é‡Šæ”¾æ—¶ï¼Œè¿›ç¨‹æ‰å†æ¬¡å˜ä¸ºå¯è¿è¡Œçš„ã€‚å› æ­¤ï¼Œåªæœ‰å¯ä»¥ç¡çœ çš„å‡½æ•°æ‰èƒ½è·å–å†…æ ¸ä¿¡å·é‡ï¼›ä¸­æ–­å¤„ç†ç¨‹åºå’Œå¯å»¶è¿Ÿå‡½æ•°éƒ½ä¸èƒ½ä½¿ç”¨å†…æ ¸ä¿¡å·é‡ã€‚ å†…æ ¸ä¿¡å·é‡æ˜¯ struct semaphore ç±»å‹çš„å¯¹è±¡ï¼ŒåŒ…å«ä¸‹é¢è¿™äº›å­—æ®µ: count: å­˜æ”¾ atomic_t ç±»å‹çš„ä¸€ä¸ªå€¼ã€‚å¦‚æœè¯¥å€¼å¤§äº 0ï¼Œé‚£ä¹ˆèµ„æºå°±æ˜¯ç©ºé—²çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥èµ„æºç°åœ¨å¯ä»¥ä½¿ç”¨ã€‚ç›¸åï¼Œå¦‚æœ count ç­‰äº0ã€‚é‚£ä¹ˆä¿¡å·é‡æ˜¯å¿™çš„ï¼Œä½†æ²¡æœ‰è¿›ç¨‹ç­‰å¾…è¿™ä¸ªè¢«ä¿æŠ¤çš„èµ„æºã€‚æœ€åï¼Œå¦‚æœ count ä¸ºè´Ÿæ•°ï¼Œåˆ™èµ„æºæ—¶ä¸å¯ç”¨çš„ï¼Œå¹¶è‡³å°‘æœ‰ä¸€ä¸ªè¿›ç¨‹ç­‰å¾…èµ„æºã€‚ wait: å­˜æ”¾ç­‰å¾…é˜Ÿåˆ—é“¾è¡¨çš„åœ°å€ï¼Œå½“å‰ç­‰å¾…èµ„æºçš„æ‰€æœ‰ç¡çœ è¿›ç¨‹éƒ½æ”¾åœ¨è¿™ä¸ªé“¾è¡¨ä¸­ã€‚å½“ç„¶ï¼Œå¦‚æœ count å¤§äºæˆ–ç­‰äº 0ï¼Œç­‰å¾…é˜Ÿåˆ—å°±ä¸ºç©ºã€‚ sleepers: å­˜æ”¾ä¸€ä¸ªæ ‡å¿—ï¼Œè¡¨ç¤ºæ˜¯å¦æœ‰ä¸€äº›è¿›ç¨‹åœ¨ä¿¡å·é‡ä¸Šç¡çœ ã€‚ å¯ä»¥ç”¨ init_MUTEX() å’Œ init_MUTEX_LOCKED() å‡½æ•°æ¥åˆå§‹åŒ–äº’æ–¥è®¿é—®æ‰€éœ€çš„ä¿¡å·é‡ã€‚ å½“è¿›ç¨‹å¸Œæœ›é‡Šæ”¾å†…æ ¸ä¿¡å·é‡é”æ—¶ï¼Œå°±è°ƒç”¨ up() å‡½æ•°ã€‚ç›¸åï¼Œå½“è¿›ç¨‹å¸Œæœ›è·å–å†…æ ¸ä¿¡å·è·å–å†…æ ¸ä¿¡å·é‡é”æ—¶ï¼Œå°±è°ƒç”¨ down() å‡½æ•°ã€‚ è¯»/å†™ä¿¡å·é‡ç±»ä¼¼äº\"è¯»/å†™è‡ªæ—‹é”\"ï¼Œä¸åŒçš„æ˜¯ï¼šåœ¨ä¿¡å·é‡å†æ¬¡å˜ä¸ºæ‰“å¼€ä¹‹å‰ï¼Œç­‰å¾…è¿›ç¨‹æŒ‚èµ·è€Œä¸æ˜¯è‡ªæ—‹ã€‚ å¾ˆå¤šå†…æ ¸æ§åˆ¶è·¯å¾„ä¸ºè¯»å¯ä»¥å¹¶å‘åœ°è·å–è¯»/å†™ä¿¡å·é‡ã€‚ä½†æ˜¯ï¼Œä»»ä½•å†™è€…å†…æ ¸æ§åˆ¶è·¯å¾„å¿…é¡»æœ‰è¢«ä¿æŠ¤èµ„æºçš„äº’æ–¥è®¿é—®ã€‚å› æ­¤ï¼Œåªæœ‰åœ¨æ²¡æœ‰å†…æ ¸æ§åˆ¶è·¯å¾„ä¸ºè¯»è®¿é—®æˆ–å†™è®¿é—®æŒæœ‰ä¿¡å·é‡æ—¶ï¼Œæ‰å¯ä»¥ä¸ºå†™è·å–ä¿¡å·é‡ã€‚è¯»/å†™ä¿¡å·é‡å¯ä»¥æä¾›å†…æ ¸ä¸­çš„å¹¶å‘åº¦ï¼Œå¹¶æ”¹å–„äº†è¿™ä¸ªç³»ç»Ÿçš„æ€§èƒ½ã€‚ å†…æ ¸ä»¥ä¸¥æ ¼çš„FIFOé¡ºåºå¤„ç†ç­‰å¾…è¯»/å†™ä¿¡å·é‡çš„æ‰€æœ‰è¿›ç¨‹ã€‚å¦‚æœè¯»è€…æˆ–å†™è€…è¿›ç¨‹å‘ç°ä¿¡å·é‡å…³é—­ï¼Œè¿™äº›è¿›ç¨‹å°±è¢«æ’å…¥åˆ°ä¿¡å·é‡ç­‰å¾…é˜Ÿåˆ—é“¾è¡¨çš„æœ«å°¾ã€‚å½“ä¿¡å·é‡è¢«é‡Šæ”¾æ—¶ï¼Œå°±æ£€æŸ¥å¤„äºç­‰å¾…é˜Ÿåˆ—é“¾è¡¨ç¬¬ä¸€ä¸ªä½ç½®çš„è¿›ç¨‹ã€‚ç¬¬ä¸€ä¸ªè¿›ç¨‹å¸¸è¢«å”¤é†’ã€‚å¦‚æœæ˜¯ä¸€ä¸ªå†™è€…è¿›ç¨‹ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸Šå…¶ä»–çš„è¿›ç¨‹å°±ç»§ç»­ç¡çœ ã€‚å¦‚æœæ˜¯ä¸€ä¸ªè¯»è€…è¿›ç¨‹ï¼Œé‚£ä¹ˆç´§è·Ÿç¬¬ä¸€ä¸ªè¿›ç¨‹çš„å…¶ä»–æ‰€æœ‰è¯»è€…è¿›ç¨‹ä¹Ÿè¢«å”¤é†’å¹¶è·å¾—é”ã€‚ä¸è¿‡ï¼Œåœ¨å†™è€…è¿›ç¨‹ä¹‹åæ’é˜Ÿçš„è¯»è€…è¿›ç¨‹ç»§ç»­ç¡çœ ã€‚ æ¯ä¸ªè¯»/å†™ä¿¡å·é‡éƒ½æ˜¯ç”± rw_semaphore ç»“æ„æè¿°çš„ï¼Œå®ƒåŒ…å«ä¸‹åˆ—å­—æ®µ: count: å­˜æ”¾ä¸¤ä¸ª16ä½è®¡æ•°å™¨ã€‚å…¶ä¸­æœ€é«˜16ä½è®¡æ•°å™¨ä»¥äºŒè¿›åˆ¶è¡¥ç å½¢å¼å­˜æ”¾éç­‰å¾…å†™è€…è¿›ç¨‹çš„æ€»æ•°(0æˆ–1)å’Œç­‰å¾…çš„å†™å†…æ ¸æ§åˆ¶è·¯å¾„æ•°ã€‚æœ€ä½16ä½è®¡æ•°å™¨å­˜æ”¾éç­‰å¾…çš„è¯»è€…å’Œå†™è€…çš„æ€»æ•°ã€‚ wait_list: æŒ‡å‘ç­‰å¾…è¿›ç¨‹çš„é“¾è¡¨ã€‚é“¾è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ å¤šæ˜¯ä¸€ä¸ª rwsem_waiter ç»“æ„ï¼Œè¯¥ç»“æ„åŒ…å«ä¸€ä¸ªæŒ‡é’ˆå’Œä¸€ä¸ªæ ‡å¿—ï¼ŒæŒ‡é’ˆæŒ‡å‘ç¡çœ è¿›ç¨‹çš„æè¿°ç¬¦ï¼Œæ ‡å¿—è¡¨ç¤ºè¿›ç¨‹æ˜¯ä¸ºè¯»éœ€è¦ä¿¡å·é‡è¿˜æ˜¯ä¸ºéœ€è¦ä¿¡å·é‡ã€‚ wait_lock: ä¸€ä¸ªè‡ªæ—‹é”ï¼Œç”¨æˆ·ä¿æŠ¤ç­‰å¾…é˜Ÿåˆ—é“¾è¡¨å’Œ rw_semphore ç»“æ„æœ¬èº«ã€‚ down_read() å’Œ down_write() å‡½æ•°åˆ†åˆ«ä¸ºè¯»æˆ–å†™è·å–è¯»/å†™ä¿¡å·é‡ã€‚åŒæ ·ï¼Œup_read() å’Œ up_write() å‡½æ•°ä¸ºè¯»æˆ–å†™é‡Šæ”¾ä»¥å‰è·å–çš„è¯»/å†™ä¿¡å·é‡ã€‚ down_read_trylock() å’Œ down_write_trylock() å‡½æ•°åˆ†åˆ«ç±»ä¼¼äº down_read() å’Œ down_write() å‡½æ•°ï¼Œä½†æ˜¯ï¼Œåœ¨ä¿¡å·é‡å¿™çš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬ä¸é˜»å¡è¿›ç¨‹ã€‚æœ€åï¼Œå‡½æ•° downgrade_write() è‡ªåŠ¨æŠŠå†™é”è½¬æ¢æˆè¯»é”ã€‚ ","date":"2021-12-03","objectID":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/:2:5","tags":null,"title":"Linuxå†…æ ¸åŒæ­¥","uri":"/linux%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/"},{"categories":null,"content":"Linuxè¿›ç¨‹ è¿›ç¨‹æ—¶ç¨‹åºæ‰§è¡Œçš„ä¸€ä¸ªå®ä¾‹ï¼Œå¯ä»¥æŠŠå®ƒçœ‹ä½œå……åˆ†æè¿°ç¨‹åºå·²ç»æ‰§è¡Œåˆ°ä½•ç§ç¨‹åº¦çš„æ•°æ®ç»“æ„çš„æ±‡é›†ã€‚åœ¨ Linux æºä»£ç ä¸­ï¼Œå¸¸æŠŠè¿›ç¨‹ç§°ä¸ºä»»åŠ¡(task)æˆ–çº¿ç¨‹(thread)ã€‚ Linux ä½¿ç”¨è½»é‡çº§è¿›ç¨‹(lightweight process)å¯¹å¤šçº¿ç¨‹åº”ç”¨æä¾›æ›´å¥½çš„æ”¯æŒã€‚ä¸¤ä¸ªè½»é‡çº§è¿›ç¨‹åŸºæœ¬ä¸Šå¯ä»¥å…±äº«ä¸€äº›èµ„æºï¼Œè¯¸å¦‚åœ°å€ç©ºé—´ã€æ‰“å¼€çš„æ–‡ä»¶ç­‰ç­‰ã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:0:0","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"è¿›ç¨‹æè¿°ç¬¦ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:1:0","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"è¿›ç¨‹çŠ¶æ€ è¿›ç¨‹çŠ¶æ€ç¬¦ä¸­çš„ state å­—æ®µæè¿°äº†è¿›ç¨‹æ‰€å¤„çš„çŠ¶æ€: å¯è¿è¡ŒçŠ¶æ€ (TASK_RUNNING) : è¿›ç¨‹è¦ä¹ˆåœ¨ CPU ä¸Šæ‰§è¡Œï¼Œè¦ä¹ˆå‡†å¤‡æ‰§è¡Œã€‚ å¯ä¸­æ–­çš„ç­‰å¾…çŠ¶æ€ (TASK_INTERRUPTIBLE) : è¿›ç¨‹è¢«æŒ‚èµ· (ç¡çœ )ï¼Œç›´åˆ°æŸä¸ªæ¡ä»¶è¡¨ä¸ºçœŸã€‚äº§ç”Ÿä¸€ä¸ªç¡¬ä»¶ä¸­æ–­ï¼Œé‡Šæ”¾è¿›ç¨‹æ­£ç­‰å¾…çš„ç³»ç»Ÿèµ„æºï¼Œæˆ–ä¼ é€’ä¸€ä¸ªä¿¡å·éƒ½æ˜¯å¯ä»¥å”¤é†’è¿›ç¨‹çš„æ¡ä»¶(æŠŠè¿›ç¨‹çš„çŠ¶æ€æ”¾å›åˆ° TASK_RUNNING)ã€‚ ä¸å¯ä¸­æ–­çš„ç­‰å¾…çŠ¶æ€ (TASK_UNINTERRUPTIBLE) : ä¸å¯ä¸­æ–­çš„ç­‰å¾…çŠ¶æ€ç±»ä¼¼ï¼Œä½†æœ‰ä¸€ä¸ªä¾‹å¤–ï¼ŒæŠŠä¿¡å·ä¼ é€’åˆ°ç¡çœ ä¸èƒ½æ”¹å˜å®ƒçš„çŠ¶æ€ã€‚è¿™ç§çŠ¶æ€å¾ˆå°‘ç”¨åˆ°ï¼Œä½†åœ¨ä¸€äº›ç‰¹å®šçš„æƒ…å†µä¸‹(è¿›ç¨‹å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°ä¸€ä¸ªä¸èƒ½è¢«ä¸­æ–­çš„äº‹ä»¶å‘ç”Ÿ)ï¼Œè¿™ç§çŠ¶æ€æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚ä¾‹å¦‚ï¼Œå½“è¿›ç¨‹æ‰“å¼€ä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œå…¶ç›¸åº”çš„è®¾å¤‡é©±åŠ¨ç¨‹åºå¼€å§‹æ¢æµ‹ç›¸åº”çš„ç¡¬ä»¶è®¾å¤‡æ—¶ä¼šç”¨åˆ°è¿™ç§çŠ¶æ€ã€‚æ¢æµ‹å®Œæˆä»¥å‰ï¼Œè®¾å¤‡é©±åŠ¨ç¨‹åºä¸èƒ½è¢«ä¸­æ–­ï¼Œå¦åˆ™ï¼Œç¡¬ä»¶è®¾å¤‡ä¼šå¤„äºä¸å¯é¢„çŸ¥çš„çŠ¶æ€ã€‚ æš‚å®šçŠ¶æ€ (TASK_STOPPED) : è¿›ç¨‹çš„æ‰§è¡Œè¢«æš‚åœã€‚å½“è¿›ç¨‹æ¥æ”¶åˆ° SIGSTOPã€SIGTSTPã€SIGTTIN æˆ– STGTTOU ä¿¡å·ï¼Œè¿›ç¨‹æš‚åœçŠ¶æ€ã€‚ è·Ÿè¸ªçŠ¶æ€ (TASK_TRACED) : è¿›ç¨‹çš„æ‰§è¡Œå·²ç”± debugger ç¨‹åºæš‚åœã€‚å½“ä¸€ä¸ªè¿›ç¨‹è¢«å¦ä¸€ä¸ªè¿›ç¨‹ç›‘æ§æ—¶(ä¾‹å¦‚ debugger æ‰§è¡Œ ptrace() ç³»ç»Ÿè°ƒç”¨ç›‘æ§ä¸€ä¸ªæµ‹è¯•ç¨‹åº)ï¼Œä»»ä½•ä¿¡å·éƒ½å¯ä»¥æŠŠè¿™ä¸ªè¿›ç¨‹ç½®äº TASK_TRACED çŠ¶æ€ã€‚ è¿˜æœ‰ä¸¤ä¸ªè¿›ç¨‹çŠ¶æ€æ˜¯æ—¢å¯ä»¥å­˜æ”¾åœ¨è¿›ç¨‹æè¿°ç¬¦çš„ state å­—æ®µä¸­ï¼Œä¹Ÿå¯ä»¥å­˜æ”¾åœ¨ exit_state å­—æ®µä¸­ã€‚ä»è¿™ä¸¤ä¸ªå­—æ®µçš„åç§°å¯ä»¥çœ‹å‡ºï¼Œåªæœ‰å½“è¿›ç¨‹çš„æ‰§è¡Œè¢«ç»ˆæ­¢æ—¶ï¼Œè¿›ç¨‹çš„çŠ¶æ€æ‰ä¼šå˜ä¸ºè¿™ä¸¤ç§çŠ¶æ€ä¸­çš„ä¸€ç§: åƒµæ­»çŠ¶æ€ (EXIT_ZOMBIE) : è¿›ç¨‹çš„æ‰§è¡Œè¢«ç»ˆæ­¢ï¼Œä½†æ˜¯ï¼Œçˆ¶è¿›ç¨‹è¿˜æ²¡æœ‰å‘å¸ƒ wait4() æˆ– waitpid() ç³»ç»Ÿè°ƒç”¨æ¥è¿”å›æœ‰å…³æ­»äº¡è¿›ç¨‹çš„ä¿¡æ¯ã€‚å‘å¸ƒ wait() ç±»ç³»ç»Ÿè°ƒç”¨å‰ï¼Œå†…æ ¸ä¸èƒ½ä¸¢å¼ƒåŒ…å«åœ¨æ­»è¿›ç¨‹æè¿°ç¬¦ä¸­çš„æ•°æ®ï¼Œå› ä¸ºçˆ¶è¿›ç¨‹å¯èƒ½è¿˜éœ€è¦å®ƒã€‚ åƒµæ­»æ’¤é”€çŠ¶æ€ (EXIT_DEAD) : æœ€ç»ˆçŠ¶æ€ï¼šç”±äºçˆ¶è¿›ç¨‹åˆšå‘å‡º wait4() æˆ– waitpid() ç³»ç»Ÿè°ƒç”¨ï¼Œå› è€Œè¿›ç¨‹ç”±ç³»ç»Ÿåˆ é™¤ã€‚ä¸ºäº†é˜²æ­¢å…¶ä»–æ‰§è¡Œçº¿ç¨‹åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸Šä¹Ÿæ‰§è¡Œ wait() ç±»ç³»ç»Ÿè°ƒç”¨ï¼Œè€ŒæŠŠè¿›ç¨‹çš„çŠ¶æ€ç”± (EXIT_ZOMBIE) çŠ¶æ€æ”¹ä¸ºåƒµæ­»æ’¤é”€çŠ¶æ€ (EXIT_DEAD)ã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:1:1","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"æ ‡è¯†ä¸€ä¸ªè¿›ç¨‹ æ ‡è¯†ä¸€ä¸ªè¿›ç¨‹æœ‰ä¸¤ç§æ–¹å¼: è¿›ç¨‹æè¿°ç¬¦æŒ‡é’ˆ: è¿›ç¨‹å’Œè¿›ç¨‹æè¿°ç¬¦ä¹‹é—´æœ‰éå¸¸ä¸¥æ ¼çš„ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œè¿™ä½¿å¾—ç”¨32ä½è¿›ç¨‹æè¿°ç¬¦åœ°å€æ ‡è¯†è¿›ç¨‹æˆä¸ºä¸€ç§æ–¹ä¾¿çš„æ–¹å¼ã€‚ PID: PID å­˜æ”¾åœ¨è¿›ç¨‹æè¿°ç¬¦çš„ pid å­—æ®µä¸­ã€‚ PID è¢«é¡ºåºç¼–å·ï¼Œæ–°åˆ›å»ºè¿›ç¨‹çš„ PID é€šå¸¸æ˜¯å‰ä¸€ä¸ªè¿›ç¨‹çš„ PID åŠ 1ã€‚PID å­˜åœ¨ä¸Šé™ï¼Œå½“å†…æ ¸ä½¿ç”¨çš„ PID è¾¾åˆ°è¿™ä¸ªä¸Šé™å€¼çš„æ—¶å€™å°±å¿…é¡»å¼€å§‹å¾ªç¯ä½¿ç”¨å·²é—²ç½®çš„ PID å·ã€‚ PID çš„é»˜è®¤æœ€å¤§å€¼æ˜¯32767(PID_MAX_DEFAULT-1)ã€‚å¯ä»¥é€šè¿‡ä¿®æ”¹ /proc/sys/kernel/pid_max æ–‡ä»¶æ”¹å˜ PID ä¸Šé™å€¼ã€‚ å†…æ ¸é€šè¿‡ç®¡ç†ä¸€ä¸ª pidmap-array ä½å›¾æ¥è¡¨ç¤ºå½“å‰å·²åˆ†é…çš„ PID å·å’Œé—²ç½®çš„ PID å·ã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:1:2","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"è¿›ç¨‹çš„åˆ‡æ¢ ä¸ºäº†æ§åˆ¶è¿›ç¨‹çš„æ‰§è¡Œï¼Œå†…æ ¸å¿…é¡»æœ‰èƒ½åŠ›æŒ‚èµ·æ­£åœ¨ CPU ä¸Šè¿è¡Œçš„è¿›ç¨‹ï¼Œå¹¶æ¢å¤ä»¥å‰æŒ‚èµ·çš„æŸä¸ªè¿›ç¨‹çš„æ‰§è¡Œã€‚è¿™ä¸ªä¸­è¡Œä¸ºè¢«ç§°ä¸ºè¿›ç¨‹åˆ‡æ¢ (process switch)ã€ä»»åŠ¡åˆ‡æ¢ (task switch) æˆ–ä¸Šä¸‹æ–‡åˆ‡æ¢ (context switch)ã€‚ æ‰€æœ‰è¿›ç¨‹å…±äº« CPU å¯„å­˜å™¨ï¼Œæ‰€ä»¥åœ¨æ¢å¤ä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œä¹‹å‰ï¼Œå¿…é¡»ç¡®ä¿æ¯ä¸ªå¯„å­˜å™¨è£…å…¥äº†æŒ‚èµ·è¿›ç¨‹æ—¶çš„å€¼ã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:2:0","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"ç¡¬ä»¶ä¸Šä¸‹æ–‡ è¿›ç¨‹æ¢å¤æ‰§è¡Œå‰å¿…é¡»è£…å…¥å¯„å­˜å™¨çš„ä¸€ç»„æ•°æ®ç§°ä¸ºç¡¬ä»¶ä¸Šä¸‹æ–‡ (hardware context)ã€‚åœ¨ Linux ä¸­ï¼Œè¿›ç¨‹ç¡¬ä»¶ä¸Šä¸‹æ–‡çš„ä¸€éƒ¨åˆ†å­˜æ”¾åœ¨ TSS æ®µï¼Œè€Œå‰©ä½™éƒ¨åˆ†å­˜æ”¾åœ¨å†…æ ¸æ€å †æ ˆä¸­ã€‚ è¿›ç¨‹åˆ‡æ¢åªå‘ç”Ÿåœ¨å†…æ ¸æ€ï¼Œåœ¨æ‰§è¡Œè¿›ç¨‹åˆ‡æ¢ä¹‹å‰ï¼Œç”¨æˆ·æ€è¿›ç¨‹ä½¿ç”¨çš„æ‰€æœ‰å¯„å­˜å™¨å†…å®¹éƒ½å·²ä¿å­˜åœ¨å†…æ ¸æ€å †æ ˆä¸Šï¼Œè¿™ä¹ŸåŒ…æ‹¬ ss å’Œ esp è¿™å¯¹å¯„å­˜å™¨çš„å†…å®¹ (å­˜å‚¨ç”¨æˆ·æ€å †æ ˆæŒ‡é’ˆçš„åœ°å€)ã€‚ Linux ä½¿ç”¨è½¯ä»¶åˆ‡æ¢ä¸Šä¸‹æ–‡ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:2:1","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"ä»»åŠ¡çŠ¶æ€æ®µ 80x86 ä½“ç³»ç»“æ„åŒ…æ‹¬äº†ä¸€ä¸ªç‰¹æ®Šçš„ä½†ç±»å‹ï¼Œå«ä»»åŠ¡çŠ¶æ€æ®µ (Task State Segment, TSS) æ¥å­˜æ”¾ç¡¬ä»¶ä¸Šä¸‹æ–‡ã€‚Linux ä¸ä½¿ç”¨ç¡¬ä»¶ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ˜¯å¼ºåˆ¶ä¸ºæ¯ä¸ªä¸åŒCPUåˆ›å»ºä¸€ä¸ªTSSã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:2:2","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"æ‰§è¡Œè¿›ç¨‹åˆ‡æ¢ è¿›ç¨‹åˆ‡æ¢çš„æ ¸å¿ƒç‚¹åœ¨äº scheduler() å‡½æ•°ã€‚ ä»æœ¬è´¨ä¸Šè¯´ï¼Œæ¯ä¸ªè¿›ç¨‹åˆ‡æ¢ç”±ä¸¤æ­¥ç»„æˆ: åˆ‡æ¢é¡µå…¨å±€ç›®å½•ä»¥å®‰è£…ä¸€ä¸ªæ–°çš„åœ°å€ç©ºé—´ã€‚ åˆ‡æ¢å†…æ ¸æ€å †æ ˆå’Œç¡¬ä»¶ä¸Šä¸‹æ–‡ï¼Œå› ä¸ºç¡¬ä»¶ä¸Šä¸‹æ–‡æä¾›äº†å†…æ ¸æ‰§è¡Œæ–°è¿›ç¨‹æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…å« CPU å¯„å­˜å™¨ (é‡ç‚¹åœ¨ switch_to() å‡½æ•°)ã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:2:3","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"åˆ›å»ºè¿›ç¨‹ Linux ä¸­åˆ›å»ºä¸€ä¸ªè¿›ç¨‹çš„æ–¹å¼: fork() -\u003e sys_fork() -\u003e do_fork() -\u003e copy_process() ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:3:0","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"å†…æ ¸è¿›ç¨‹ ä¼ ç»Ÿçš„ Unix ç³»ç»ŸæŠŠä¸€äº›é‡è¦çš„ä»»åŠ¡å§”æ‰˜ç»™å‘¨æœŸæ€§æ‰§è¡Œçš„è¿›ç¨‹ï¼Œè¿™äº›è¿›ç¨‹åªè¿è¡Œåœ¨å†…æ ¸æ€ï¼Œç§°ä½œå†…æ ¸çº¿ç¨‹(kernel thread)ï¼Œå†…æ ¸çº¿ç¨‹ä¸å—ä¸å¿…è¦çš„ç”¨æˆ·æ€ä¸Šä¸‹æ–‡çš„æ‹–ç´¯ã€‚å†…æ ¸çº¿ç¨‹å’Œæ™®é€šè¿›ç¨‹çš„åŒºåˆ«: å†…æ ¸çº¿ç¨‹åªè¿è¡Œåœ¨å†…æ ¸æ€ï¼Œè€Œæ™®é€šè¿›ç¨‹æ—¢å¯ä»¥è¿è¡Œåœ¨å†…æ ¸æ€ï¼Œä¹Ÿå¯ä»¥è¿è¡Œåœ¨ç”¨æˆ·æ€ã€‚ å› ä¸ºå†…æ ¸çº¿ç¨‹åªè¿è¡Œåœ¨å†…æ ¸æ€ï¼Œå®ƒä»¬åªä½¿ç”¨å¤§äº PAGE_OFFSET çš„çº¿æ€§åœ°å€ç©ºé—´ã€‚å¦ä¸€æ–¹é¢ï¼Œä¸ç®¡åœ¨ç”¨æˆ·æ€è¿˜æ˜¯åœ¨å†…æ ¸æ€ï¼Œæ™®é€šè¿›ç¨‹å¯ä»¥ç”¨ 4GB çš„çº¿ç¨‹åœ°å€ç©ºé—´ã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:3:1","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"è¿›ç¨‹ 0 æ‰€æœ‰è¿›ç¨‹çš„ç¥–å…ˆå«åšè¿›ç¨‹0ï¼Œidle è¿›ç¨‹æˆ– swapper è¿›ç¨‹ï¼Œå®ƒæ˜¯åœ¨ Linux çš„åˆå§‹åŒ–é˜¶æ®µä»æ— åˆ°æœ‰åˆ›å»ºçš„ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ã€‚start_kernel() å‡½æ•°åˆå§‹åŒ–å†…æ ¸éœ€è¦çš„æ‰€æœ‰æ•°æ®ç»“æ„ï¼Œæ¿€æ´»ä¸­æ–­ï¼Œåˆ›å»ºå¦ä¸€ä¸ªå«è¿›ç¨‹1çš„å†…æ ¸çº¿ç¨‹(initè¿›ç¨‹)ã€‚ æ–°åˆ›å»ºçš„å†…æ ¸çº¿ç¨‹çš„ PID ä¸º1ï¼Œå¹¶ä¸è¿›ç¨‹0å…±äº«æ¯è¿›ç¨‹æ‰€æœ‰çš„å†…æ ¸æ•°æ®ç»“æ„ã€‚æ­¤å¤–ï¼Œå½“è°ƒåº¦ç¨‹åºé€‰æ‹©åˆ°å®ƒæ—¶ï¼Œinit è¿›ç¨‹å¼€å§‹æ‰§è¡Œ init() å‡½æ•°ã€‚ åˆ›å»ºinitè¿›ç¨‹åï¼Œè¿›ç¨‹0æ‰§è¡Œ cpu_idle() å‡½æ•°ï¼Œè¯¥å‡½æ•°æœ¬è´¨ä¸Šæ˜¯åœ¨å¼€ä¸­æ–­çš„æƒ…å†µä¸‹é‡å¤æ‰§è¡Œ hlt æ±‡ç¼–è¯­è¨€æŒ‡ä»¤ã€‚åªæœ‰å½“æ²¡æœ‰è¿›ç¨‹å¤„äº TASK_RUNNING çŠ¶æ€æ˜¯ï¼Œè°ƒåº¦ç¨‹åºæ‰é€‰æ‹©è¿›ç¨‹0ã€‚ åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ª CPU éƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹ 0ã€‚åªè¦æ‰“å¼€æœºå™¨ç”µæºï¼Œè®¡ç®—æœºçš„ BIOS å°±å¯åŠ¨æŸä¸€ä¸ª CPUï¼ŒåŒæ—¶ç¦ç”¨å…¶ä»– CPUã€‚è¿è¡Œåœ¨ CPU 0 ä¸Šçš„ swapper è¿›ç¨‹åˆå§‹åŒ–å†…æ ¸æ•°æ®ç»“æ„ï¼Œç„¶åæ¿€æ´»å…¶ä»–çš„CPUï¼Œå¹¶é€šè¿‡ copy_process() å‡½æ•°åˆ›å»ºå¦å¤–çš„ swapper è¿›ç¨‹ï¼ŒæŠŠ 0 ä¼ é€’ç»™æ–°åˆ›å»ºçš„ swapper è¿›ç¨‹ä½œä¸ºå®ƒä»¬çš„æ–° PIDã€‚æ­¤å¤–ï¼Œå†…æ ¸æŠŠé€‚å½“çš„ CPU ç´¢å¼•èµ‹ç»™å†…æ ¸æ‰€åˆ›å»ºçš„æ¯ä¸ªè¿›ç¨‹çš„ thread_info æè¿°ç¬¦çš„ cpu å­—æ®µã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:3:2","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"è¿›ç¨‹ 1 ç”±è¿›ç¨‹0åˆ›å»ºçš„å†…æ ¸çº¿ç¨‹æ‰§è¡Œ init() å‡½æ•°ï¼Œinit() ä¾æ¬¡å®Œæˆå†…æ ¸åˆå§‹åŒ–ã€‚init() è°ƒç”¨ execve() ç³»ç»Ÿè°ƒç”¨è£…å…¥å¯æ‰§è¡Œç¨‹åº initã€‚ç»“æœï¼Œinit å†…æ ¸çº¿ç¨‹å˜ä¸ºä¸€ä¸ªæ™®é€šè¿›ç¨‹ï¼Œä¸”æ‹¥æœ‰è‡ªå·±çš„æ¯è¿›ç¨‹(per-process)å†…æ ¸æ•°æ®ç»“æ„ã€‚åœ¨ç³»ç»Ÿå…³é—­ä¹‹å‰ï¼Œinit è¿›ç¨‹ä¸€ç›´å­˜æ´»ï¼Œå› ä¸ºå®ƒåˆ›å»ºå’Œç›‘æ§åœ¨æ“ä½œç³»ç»Ÿå¤–å±‚æ‰§è¡Œçš„æ‰€æœ‰è¿›ç¨‹çš„æ´»åŠ¨ã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:3:3","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"å…¶ä»–å†…æ ¸çº¿ç¨‹ keventd(ä¹Ÿè¢«ç§°ä¸ºäº‹ä»¶): æ‰§è¡Œ keventd_wq å·¥ä½œé˜Ÿåˆ—ä¸­çš„å‡½æ•°ã€‚ kapmd: å¤„ç†ä¸é«˜çº§ç”µæºç®¡ç†(APM)ç›¸å…³çš„äº‹ä»¶ã€‚ kswapd: æ‰§è¡Œå†…å­˜å›æ”¶ã€‚ pdflush: åˆ·æ–° â€œè„â€ ç¼“å†²åŒºä¸­çš„å†…å®¹åˆ°ç£ç›˜å›æ”¶å†…å­˜ã€‚ blockd: æ‰§è¡Œ kblockd_workqueue å·¥ä½œé˜Ÿåˆ—ä¸­çš„å‡½æ•°ã€‚ ksoftirqd: è¿è¡Œ tasklet; ç³»ç»Ÿä¸­æ¯ä¸ª CPU éƒ½æœ‰è¿™æ ·ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:3:4","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"æ’¤é”€è¿›ç¨‹ è¿›ç¨‹ç»ˆæ­¢çš„ä¸€èˆ¬æ–¹å¼æ˜¯è°ƒç”¨ exit() åº“å‡½æ•°ã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:4:0","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"è¿›ç¨‹ç»ˆæ­¢ ç»ˆæ­¢ç”¨æˆ·æ€åº”ç”¨çš„ç³»ç»Ÿè°ƒç”¨: exit_group() ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒç»ˆæ­¢æ•´ä¸ªçº¿ç¨‹ç»„ï¼Œå³æ•´ä¸ªåŸºäºå¤šçº¿ç¨‹çš„åº”ç”¨ã€‚do_group_exit() æ˜¯å®ç°è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„ä¸»è¦å†…æ ¸å‡½æ•°ã€‚ exit() ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒç»ˆæ­¢æŸä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œä¸ç®¡è¯¥çº¿ç¨‹æ‰€å±çº¿ç¨‹ç»„ä¸­çš„æ‰€æœ‰å…¶ä»–è¿›ç¨‹ã€‚do_exit() æ˜¯å®ç°è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„ä¸»è¦å†…æ ¸å‡½æ•°ã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:4:1","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"è¿›ç¨‹åˆ é™¤ è¿›ç¨‹é€šè¿‡è°ƒç”¨ wait() ç±»å‡½æ•°æ¥æ£€æŸ¥å­è¿›ç¨‹æ˜¯å¦ç»ˆæ­¢ï¼Œåœ¨å­è¿›ç¨‹å·²ç»ˆæ­¢ï¼Œä½†æ˜¯çˆ¶è¿›ç¨‹è¿˜æœªæ¥æ”¶åˆ° wait() ç±»å‡½æ•°çš„é€šçŸ¥ä¹‹å‰ï¼Œå­è¿›ç¨‹å¤„äºåƒµæ­»çŠ¶æ€ã€‚è¿™æ—¶ç³»ç»Ÿèµ„æºå·²ç»é‡Šæ”¾ï¼Œä½†è¿˜å ç”¨è¿›ç¨‹æè¿°ç¬¦ã€‚ å¦‚æœçˆ¶è¿›ç¨‹åœ¨æ¥æ”¶åˆ°å­è¿›ç¨‹å‰å°±ç»ˆæ­¢ï¼Œå­è¿›ç¨‹å°±ä¼šè¢«initè¿›ç¨‹æ¥ç®¡ã€‚ ","date":"2021-12-03","objectID":"/linux%E8%BF%9B%E7%A8%8B/:4:2","tags":null,"title":"Linuxè¿›ç¨‹","uri":"/linux%E8%BF%9B%E7%A8%8B/"},{"categories":null,"content":"Nginxå¤šç»„ä»£ç†é…ç½® ä¸€ã€éœ€æ±‚ å…·ä½“å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼šä½¿ç”¨ nginx ä½œä¸ºå¯¹å¤–çš„æœåŠ¡æœºå™¨ï¼Œè®©å®¢æˆ·ç«¯é€šè¿‡è®¿é—® nginx æ‰€åœ¨çš„IP+ç«¯å£çš„æ–¹å¼èƒ½è®¿é—®å†…éƒ¨å¤šä¸ªç³»ç»Ÿï¼Œè¿™æ ·ä¸€æ¥é€šè¿‡å¯¹å•å°æœºå™¨ä½œè®¿é—®æ§åˆ¶å°±å¯ä»¥ä¿è¯å†…éƒ¨ç³»ç»Ÿçš„è®¿é—®å®‰å…¨ã€‚å®ç°æ€è·¯å¦‚ä¸‹ï¼šåœ¨å¯¹å¤–çš„æœºå™¨ä¸Šéƒ¨ç½² nginx æœåŠ¡ï¼Œé€šè¿‡ nginx è™šæ‹ŸæœºåŠŸèƒ½å’Œä»£ç†åŠŸèƒ½ç›¸ç»“åˆå®ç°å¤šç»„ä»£ç†ã€‚å…·ä½“åœºæ™¯å¦‚ä¸‹ï¼š ä»£ç†æœåŠ¡å™¨ ä»£ç†æœåŠ¡ nginx 192.168.10.10:8080 192.168.10.11:8080 nginx 192.168.10.10:8081 192.168.10.11:9000 äºŒã€ç¯å¢ƒ æµ‹è¯•ç¯å¢ƒå¦‚ä¸‹ï¼š ä»£ç†æœåŠ¡å™¨ï¼šip 192.168.10.10ï¼›ç³»ç»Ÿ CentOS7 ;Â  éœ€è¦ä»£ç†çš„æœåŠ¡ï¼š192.168.10.11:8080 nginx ï¼›192.168.10.11:9000 tomcat ä¸‰ã€é…ç½®ä»£ç† å‡å¦‚æœ‰ä¸¤ä¸ªæœåŠ¡éœ€è¦é…ç½®ä»£ç†ï¼Œä¸€ä¸ª webï¼Œä¸€ä¸ª tomcatã€‚web è¿è¡Œåœ¨ 192.168.10.11:8080 tomcat è¿è¡Œåœ¨ 192.168.10.11:9000 ç°åœ¨é…ç½® nginx ä»£ç†ã€‚ 1.å®‰è£… nginxå…ˆåœ¨ä»£ç†æœåŠ¡å™¨ä¸Šå®‰è£… nginxï¼Œä½¿ç”¨å‘½ä»¤ï¼š $ yum install -y nginx å®‰è£…æˆåŠŸåå°±å¯ä»¥å°è¯•å¯åŠ¨ nginx æœåŠ¡å™¨ï¼š $ systemctl start nginx å¯åŠ¨æœåŠ¡æˆåŠŸåï¼Œnginx å°±è¿è¡Œåœ¨ 80 ç«¯å£ã€‚ 2.ä¿®æ”¹é…ç½®æ–‡ä»¶å®‰è£…nginxå°±å¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶çš„é»˜è®¤è·¯å¾„ä¸ºÂ  $ ll /etc/nginx/nginx.conf -rw-r--r-- 1 root root 1822 Nov 24 19:30 /etc/nginx/nginx.conf ä¿®æ”¹ nginx.conf å¦‚ä¸‹ # ç³»ç»Ÿç”¨æˆ· user nginx; # å·¥ä½œè¿›ç¨‹æ•°ï¼Œé…ç½®é«˜çš„æœºå™¨å¯ä»¥é€‚å½“å¢åŠ  worker_processes 4; # é”™è¯¯æ—¥å¿— error_log /var/log/nginx/error.log; # pid æ–‡ä»¶å­˜æ”¾ç›®å½• pid /run/nginx.pid; events { # linux ä½¿ç”¨ epoll äº‹ä»¶æœºåˆ¶ use epoll; # è¿æ¥æ•° worker_connections 1024; } http { log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /var/log/nginx/access.log main; sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; include /etc/nginx/mime.types; default_type application/octet-stream; # é…ç½®è™šæ‹Ÿæœºï¼Œåœ¨è¯¥ç›®å½•ä¸‹é…ç½®å¤šä¸ªé…ç½®æ–‡ä»¶å¯¹åº”å¤šå°éœ€è¦ä»£ç†çš„æœºå™¨ include /etc/nginx/conf.d/*.conf; # é…ç½® https # Settings for a TLS enabled server. # # server { # listen 443 ssl http2 default_server; # listen [::]:443 ssl http2 default_server; # server_name _; # root /usr/share/nginx/html; # # ssl_certificate \"/etc/pki/nginx/server.crt\"; # ssl_certificate_key \"/etc/pki/nginx/private/server.key\"; # ssl_session_cache shared:SSL:1m; # ssl_session_timeout 10m; # ssl_ciphers HIGH:!aNULL:!MD5; # ssl_prefer_server_ciphers on; # # # Load configuration files for the default server block. # include /etc/nginx/default.d/*.conf; # # location / { # } # # error_page 404 /404.html; # location = /40x.html { # } # # error_page 500 502 503 504 /50x.html; # location = /50x.html { # } # } } æ³¨æ„ 23 è¡Œçš„é…ç½®ï¼šinclude /etc/nginx/conf.d/*.conf; è¿™ä¸ªç›®å½•ä¸‹å°±æ˜¯è¦å­˜æ”¾ä»£ç†çš„é…ç½®æ–‡ä»¶ã€‚ä¸€èˆ¬è¿™ä¸ªæ–‡ä»¶é»˜è®¤æ˜¯å­˜åœ¨çš„ï¼Œå¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºå¹¶ä¿®æ”¹æƒé™ã€‚ $ mkdir /etc/nginx/conf.d $ chmod 755 /etc/nginx/conf.d 3.é…ç½®ä»£ç†æ–‡ä»¶åœ¨è¿™ä¸ªç›®å½•ä¸‹å­˜æ”¾ä»£ç†æœåŠ¡çš„æ–‡ä»¶ï¼Œæœ€å¥½ä¸€ä¸ªä»£ç†å¯¹åº”ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚æˆ‘ä»¬ä¹‹å‰éœ€æ±‚ä¸Šéœ€è¦ä»£ç†çš„æœåŠ¡æ˜¯ä¸¤ä¸ªï¼Œç›´æ¥åˆ›å»ºä¸¤ä¸ªä»£ç†æ–‡ä»¶ï¼Œå¹¶ä¿®æ”¹ # /etc/nginx/conf.d/nginx.conf # ä»£ç†çš„èŠ‚ç‚¹ # upstream \u003cä»£ç†åç§° å”¯ä¸€\u003e upstream nginx_server { # ä»£ç†çš„ip:port,å¯æ·»åŠ å¤šä¸ªipåœ°å€å°±è¡Œè´Ÿè½½å‡è¡¡ server 192.168.10.11:8080; } server { # ç›‘å¬çš„åœ°å€å’Œç«¯å£ # å¯¹åº”ä¸€ä¸ªä»£ç†ä¸€ä¸ªç«¯å£ listen 192.168.10.10:8080; # å¯¹å¤–çš„åŸŸå server_name aaa.test.com; location / { # ä»£ç†é…ç½®ï¼Œåç§°å’Œä»¥ä¸Šçš„ä»£ç†åç§°å¯¹åº” proxy_pass http://nginx_server; # é…ç½®ä½¿ç”¨çœŸå®çš„åœ°å€è®¿é—®ï¼Œå¦‚æœä¸é…ç½®æ­¤é¡¹ä¼šå¯¼è‡´ä»£ç†tomcatæœåŠ¡å™¨ 400 é”™è¯¯ proxy_set_header Host $host; } } # cat /etc/nginx/conf.d/tomcat.conf upstream tomcat_server { server 192.168.10.11:9000; } server { listen 192.168.10.10:8081; server_name bbb.test.com; location / { proxy_pass http://tomcat_server; proxy_set_header Host $host; } } ä¿®æ”¹å¹¶ä¿å­˜åï¼Œä½¿ç”¨ nginx å‘½ä»¤æ¥éªŒè¯æ–‡ä»¶çš„è¯­æ³•ï¼š $ # nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful ä¹‹åå°±å¯ä»¥é‡å¯ nginx æœåŠ¡ $ systemctl restart nginx $ netstat -tnlp | grep nginx tcp 0 0 192.168.10.10:8080 0.0.0.0:* LISTEN 11643/nginx: master tcp 0 0 192.168.10.10:8081 0.0.0.0:* LISTEN 11643/nginx: master å¯ä»¥çœ‹åˆ°æˆåŠŸç»‘å®šä¸¤ä¸ªç«¯å£ï¼Œä»£ç†ä¸¤ä¸ªæœåŠ¡ã€‚é€šè¿‡æµè§ˆå™¨è®¿é—®8080å’Œ8081![image.png] åˆ°è¿™é‡Œé…ç½®å°±å®Œæˆäº†ã€‚å¦‚æœéœ€è¦å†ä»£ç†ï¼Œåœ¨ /etc/nginx/conf.d ç›®å½•ä¸‹å†æ·»åŠ ç›¸åº”çš„é…ç½®æ–‡ä»¶å°±å¯ä»¥ã€‚å¦‚æœæ²¡æœ‰è®¿é—®æˆåŠŸï¼Œè¯·æ£€æŸ¥å„ç§é˜²ç«å¢™å’Œå®‰å…¨ç­–ç•¥ã€‚ ","date":"2021-12-03","objectID":"/nginx%E5%A4%9A%E7%BB%84%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE/:0:0","tags":null,"title":"Nginxå¤šç»„ä»£ç†é…ç½®","uri":"/nginx%E5%A4%9A%E7%BB%84%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE/"},{"categories":null,"content":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨ å®‰è£… è¿™é‡Œç›´æ¥ä½¿ç”¨ docker å®‰è£… postgresql-13 docker run --name postgresql13 -e POSTGRES_PASSWORD=123456 -p 54322:5432 -d postgres:13 å®‰è£…æˆåŠŸåä¼šç»‘å®šä¸»æœºç«¯å£ 54322ã€‚ç›´æ¥è¿›å…¥ postgresql13 å®¹å™¨ï¼Œä½¿ç”¨ pgsqlã€‚ [root@localhost ~]# docker exec -it 3e3b03e3 /bin/bash root@3e3b03e3e442:/# psql -h localhost -p 5432 -U postgres psql (13.0 (Debian 13.0-1.pgdg100+1)) Type \"help\" for help. postgres=# psql æ˜¯ pgsql çš„å®¢æˆ·ç«¯å‘½ä»¤ï¼Œä½¿ç”¨å‚æ•°å¦‚ä¸‹ï¼š -hï¼šæŒ‡å®š pgsql çš„åœ°å€ -pï¼šæŒ‡å®š pgsql çš„ç»‘å®šç«¯å£ -Uï¼šæŒ‡å®šç™»å½•çš„ç”¨æˆ·åï¼Œé»˜è®¤ä¸º postgresã€‚åé¢å¯ä»¥ç´§æ¥ â€œdatabaseâ€ï¼Œç›´æ¥è¿›å…¥æŒ‡å®šçš„æ•°æ®åº“ã€‚ æ•°æ®åº“çš„æ“ä½œ postgresql æ”¯æŒçš„æ•°æ®åº“æ“ä½œæœ‰ å¢ã€åˆ ã€æŸ¥ã€æ”¹ ","date":"2021-12-03","objectID":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/:0:0","tags":null,"title":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨","uri":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":"åˆ›å»ºæ•°æ®åº“ åˆ›å»ºæ•°æ®åº“çš„å‘½ä»¤ä¸ºï¼š create database \u003cdatabasename\u003e [encoding 'UTF-8']Â  postgres=#createdatabasetestencoding'UTF-8';CREATEDATABASE ","date":"2021-12-03","objectID":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/:1:0","tags":null,"title":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨","uri":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":"æŸ¥è¯¢æ•°æ®åº“ æŸ¥è¯¢æ•°æ®åº“çš„å‘½ä»¤æœ‰ä¸¤ç§ï¼šç¬¬ä¸€ç§æ˜¯ \\lÂ ï¼Œåªèƒ½åœ¨ psql ä¸­ä½¿ç”¨ï¼š postgres=#\\lListofdatabasesName|Owner|Encoding|Collate|Ctype|Accessprivileges-----------+----------+----------+------------+------------+----------------------- postgres|postgres|UTF8|en_US.utf8|en_US.utf8|template0|postgres|UTF8|en_US.utf8|en_US.utf8|=c/postgres+|||||postgres=CTc/postgrestemplate1|postgres|UTF8|en_US.utf8|en_US.utf8|=c/postgres+|||||postgres=CTc/postgrestest|postgres|UTF8|en_US.utf8|en_US.utf8|testdb|postgres|UTF8|en_US.utf8|en_US.utf8|(5rows) å¦ä¸€ç§å‘½ä»¤ä¸ºï¼š select * from pg_databseÂ  postgres=#selectdatnamefrompg_database;datname----------- postgrestemplate1template0testdbtest(5rows) ","date":"2021-12-03","objectID":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/:2:0","tags":null,"title":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨","uri":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":"ä¿®æ”¹æ•°æ®åº“ ä¿®æ”¹æ•°æ®åº“ä½¿ç”¨å…³é”®å­— alterÂ  postgres=#alterdatabasetestxrenametotest;ALTERDATABASE ","date":"2021-12-03","objectID":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/:3:0","tags":null,"title":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨","uri":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":"åˆ é™¤æ•°æ®åº“ postgres=#dropdatabasetest;DROPDATABASE ","date":"2021-12-03","objectID":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/:4:0","tags":null,"title":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨","uri":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":"é€‰æ‹©æ•°æ®åº“ é€‰æ‹©æ•°æ®å’Œåˆ‡æ¢æ•°æ®çš„å‘½ä»¤æ˜¯ç›¸åŒçš„ï¼Œä½¿ç”¨å‘½ä»¤ \\c databasenameÂ  postgres=#\\ctest;Youarenowconnectedtodatabase\"test\"asuser\"postgres\".test=#\\cpostgres;Youarenowconnectedtodatabase\"postgres\"asuser\"postgres\". è¡¨çš„æ“ä½œ ","date":"2021-12-03","objectID":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/:5:0","tags":null,"title":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨","uri":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":"åˆ›å»ºè¡¨ åˆ›å»º postgresql è¡¨çš„è¯­æ³•ä¸ºï¼š CREATETABLEtable_name(column1datatype,column2datatype,column3datatype,.....columnNdatatype,PRIMARYKEY(oneormorecolumns)); åˆ›å»ºä¸€å¼ åä¸º COMPANY çš„è¡¨ï¼š testdb=#CREATETABLECOMPANY(IDINTPRIMARYKEYNOTNULL,NAMETEXTNOTNULL,AGEINTNOTNULL,ADDRESSCHAR(50),SALARYREAL);CREATETABLE ","date":"2021-12-03","objectID":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/:6:0","tags":null,"title":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨","uri":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":"æŸ¥è¯¢è¡¨ æŸ¥è¯¢è¡¨ä½¿ç”¨ \\d ï¼š testdb=#\\dListofrelationsSchema|Name|Type|Owner--------+---------+-------+---------- public|company|table|postgrespublic|person|table|postgres ä½†æ˜¯è¿™ç§æ–¹å¼åªèƒ½åœ¨ psql å‘½ä»¤ä¸­ä¸­ä½¿ç”¨ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ selectÂ å‘½ä»¤ï¼š testdb=#select*frompg_tableswhereschemaname='public';schemaname|tablename|tableowner|tablespace|hasindexes|hasrules|hastriggers|rowsecurity------------+-----------+------------+------------+------------+----------+-------------+------------- public|person|postgres||f|f|f|fpublic|company|postgres||t|f|f|f(2rows ","date":"2021-12-03","objectID":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/:7:0","tags":null,"title":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨","uri":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":"æŸ¥çœ‹è¡¨ç»“æ„ æŸ¥çœ‹è¡¨ç»“æ„ä¹Ÿæ˜¯ä½¿ç”¨ \\dÂ å‘½ä»¤ï¼š Table\"public.company\"Column|Type|Collation|Nullable|Default---------+---------------+-----------+----------+--------- id|integer||notnull|name|text||notnull|age|integer||notnull|address|character(50)|||salary|real|||Indexes:\"company_pkey\"PRIMARYKEY,btree(id) ä¹Ÿå¯ä»¥ä½¿ç”¨ sql å®ç°ï¼š testdb=#SELECTa.attnum,a.attnameASfield,t.typnameAStype,a.attlenASlength,a.atttypmodASlengthvar,a.attnotnullASnotnull,b.descriptionAScommentFROMpg_classc,pg_attributeaLEFTJOINpg_descriptionbONa.attrelid=b.objoidANDa.attnum=b.objsubid,pg_typetWHEREc.relname='company'ANDa.attnum\u003e0ANDa.attrelid=c.oidANDa.atttypid=t.oidORDERBYa.attnum;attnum|field|type|length|lengthvar|notnull|comment--------+---------+--------+--------+-----------+---------+--------- 1|id|int4|4|-1|t|2|name|text|-1|-1|t|3|age|int4|4|-1|t|4|address|bpchar|-1|54|f|5|salary|float4|4|-1|f|(5rows) ","date":"2021-12-03","objectID":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/:8:0","tags":null,"title":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨","uri":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":"ä¿®æ”¹è¡¨ç»“æ„ ALTER TABLEÂ è¯­å¥ç”¨äºæ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤è¡¨ä¸­çš„åˆ—ï¼šåœ¨ç°æœ‰è¡¨ä¸­æ·»åŠ åˆ—ï¼š ALTERTABLEtable_nameADDcolumn_namedatatype; åœ¨ç°æœ‰è¡¨ä¸­åˆ é™¤åˆ—ï¼š ALTERTABLEtable_nameDROPCOLUMNcolume_name; åœ¨ç°æœ‰è¡¨ä¸­ä¿®æ”¹å­—æ®µç±»å‹ï¼š ALTERTABLEtable_nameALTERCOLUMNcolume_nameTYPEdatatype; å‘è¡¨ä¸­çš„åˆ—æ·»åŠ  NOT NULLÂ çº¦æŸï¼š ALTERTABLEtable_nameMODIFYcolume_namedatatypeNOTNULL; æ·»åŠ çº¦æŸï¼Œæ”¯æŒçš„çº¦æŸæœ‰ UNIQUEÂ ã€ PRIMARY KEYÂ ã€ CHECKÂ  ALTERTABLEtable_nameADDCONSTRAINTMyUniqueConstraintUNIQUE(colume_name1,colume_name2...); åˆ é™¤çº¦æŸï¼Œæ”¯æŒçš„çº¦æŸæœ‰ UNIQUE ã€ PRIMARY KEY ã€ CHECK ALTERTABLEtable_nameDROPCONSTRAINTMyUniqueConstraintUNIQUE; ","date":"2021-12-03","objectID":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/:9:0","tags":null,"title":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨","uri":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":"åˆ é™¤è¡¨ DROPÂ ç”¨äºåˆ é™¤è¡¨ï¼š testdb=#droptablecompany;DROPTABLE JSON ç±»å‹çš„æ”¯æŒ PostgreSQL æ”¯æŒå­˜å‚¨ JSON ç±»å‹çš„æ•°æ®ï¼Œæä¾›äº†ä¸¤ç§ç±»å‹ï¼š jsonÂ å’Œ jsonbÂ ã€‚ jsonæ•°æ®ç±»å‹å­˜å‚¨è¾“å…¥æ–‡æœ¬çš„ç²¾å‡†æ‹·è´ï¼Œå¤„ç†å‡½æ•°å¿…é¡»åœ¨æ¯ æ¬¡æ‰§è¡Œæ—¶å¿…é¡»é‡æ–°è§£æè¯¥æ•°æ®ã€‚ jsonbæ•°æ®è¢«å­˜å‚¨åœ¨ä¸€ç§åˆ†è§£å¥½çš„ äºŒè¿›åˆ¶æ ¼å¼ä¸­ï¼Œå®ƒåœ¨è¾“å…¥æ—¶è¦ç¨æ…¢ä¸€äº›ï¼Œå› ä¸ºéœ€è¦åšé™„åŠ çš„è½¬æ¢ã€‚ä½†æ˜¯Â jsonbåœ¨å¤„ç†æ—¶è¦å¿«å¾ˆå¤šï¼Œå› ä¸ºä¸éœ€è¦è§£æã€‚jsonbä¹Ÿæ”¯æŒç´¢å¼•ï¼Œjsonbä¸ä¿ç•™ç©ºæ ¼ã€ä¸ ä¿ç•™å¯¹è±¡é”®çš„é¡ºåºå¹¶ä¸”ä¸ä¿ç•™é‡å¤çš„å¯¹è±¡é”®ã€‚ å…³äº JSONBÂ çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ JSON ç±»å‹ï¼Œè¿™é‡Œåªä»‹ç» JSONBÂ ç±»å‹æ•°æ®çš„ä½¿ç”¨ã€‚ åˆ›å»º JSONB ç±»å‹çš„è¡¨ CREATETABLEposts(IDINTPRIMARYKEYNOTNULL,specJSONB); æ’å…¥æ•°æ®ï¼Œä½¿ç”¨çš„å…³é”®å­—ä¸º INSERT INTOÂ ã€‚ -- æ’å…¥ç¬¬ä¸€æ¡æ•°æ® insertintopostsvalues(1,'{\"name\": \"first posts\", \"content\": \"This is a simple post\", \"author\": \"a\", \"time\": \"2020/10/15\"}');-- æ’å…¥ç¬¬äºŒæ¡æ•°æ® insertintopostsvalues(2,'{\"name\": \"jsonb\", \"content\": \"jsonb is PostgreSQL inner type\", \"author\": \"bb\", \"time\": \"2020/10/12\", \"tag\": [\"database\", \"PgSQL\"]}'); æ·»åŠ  key/valueÂ ç´¢å¼•ï¼š -- ç»™æ‰€æœ‰ key/values æ·»åŠ ç´¢å¼• CREATEINDEXidx_posts_specONpostsUSINGgin(spec);-- ç»™æŒ‡å®šçš„ key/values æ·»åŠ ç´¢å¼• CREATEINDEXidx_posts_spec_authorONpostsUSINGgin((spec-\u003e'author')); æ•°æ®æŸ¥è¯¢ SELECTÂ ï¼Œå…¨è¡¨æŸ¥è¯¢ï¼š testdb=#select*fromposts;id|spec----+------------------------------------------------------------------------------------------------------------------------------------ 1|{\"name\":\"first posts\",\"time\":\"2020/10/15\",\"author\":\"a\",\"content\":\"This is a simple post\"}2|{\"tag\":[\"database\",\"PgSQL\"],\"name\":\"jsonb\",\"time\":\"2020/10/12\",\"author\":\"bb\",\"content\":\"jsonb is PostgreSQL inner type\"}(2rows) æŸ¥è¯¢ JSONBÂ å†…çš„æ•°æ®ï¼š -- spec-\u003e'name' è¾“å‡ºçš„æ•°æ®æ ¼å¼ä¸ºåŸç”Ÿæ ¼å¼ testdb=#selectid,spec-\u003e'name'fromposts;id|?column?----+--------------- 1|\"first posts\"2|\"jsonb\"(2rows)-- spec-\u003e\u003e'name' è¾“å‡ºæ ¼å¼ä¸º TEXT testdb=#selectid,spec-\u003e\u003e'name'fromposts;id|?column?----+------------- 1|firstposts2|jsonb(2rows)testdb=#insertintopostsvalues(3,'{\"name\": \"other\", \"content\": \"other data\", \"author\": \"bb\", \"other\": {\"name\": \"other\"}}');INSERT01-- ä½¿ç”¨ -\u003e æ“ä½œç¬¦æŸ¥è¯¢å¤šçº§ json æ ¼å¼çš„æ•°æ® testdb=#selectid,spec-\u003e'name'asspec_name,spec-\u003e'other'-\u003e'name'asspec_other_namefromposts;id|spec_name|spec_other_name----+---------------+----------------- 1|\"first posts\"|2|\"jsonb\"|3|\"other\"|\"other\"-- ä½¿ç”¨ ? æŸ¥è¯¢ key æ˜¯å¦å­˜åœ¨ testdb=#selectid,specfrompostswherespec?'tag';id|spec----+------------------------------------------------------------------------------------------------------------------------------------ 2|{\"tag\":[\"database\",\"PgSQL\"],\"name\":\"jsonb\",\"time\":\"2020/10/12\",\"author\":\"bb\",\"content\":\"jsonb is PostgreSQL inner type\"}(1row)-- ä½¿ç”¨ ? æŸ¥è¯¢ values testdb=#selectid,specfrompostswherespec-\u003e'author'?'bb';id|spec----+------------------------------------------------------------------------------------------------------------------------------------ 2|{\"tag\":[\"database\",\"PgSQL\"],\"name\":\"jsonb\",\"time\":\"2020/10/12\",\"author\":\"bb\",\"content\":\"jsonb is PostgreSQL inner type\"}3|{\"name\":\"other\",\"other\":{\"name\":\"other\"},\"author\":\"bb\",\"content\":\"other data\"}(2rows)-- ä½¿ç”¨ @\u003e æ¥ç²¾ç¡®æŸ¥è¯¢ testdb=#selectid,specfrompostswherespec@\u003e'{\"other\": {\"name\": \"other\"}}'::jsonb;id|spec----+---------------------------------------------------------------------------------------- 3|{\"name\":\"other\",\"other\":{\"name\":\"other\"},\"author\":\"bb\",\"content\":\"other data\"}(1row) JSONBÂ æ”¯æŒçš„å…¶ä»–å‡½æ•°å’Œæ“ä½œç¬¦å¯ä»¥å‚è€ƒ è¿™é‡Œã€‚ ","date":"2021-12-03","objectID":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/:10:0","tags":null,"title":"postgresql å®æˆ˜ä¸€ï¼šå®‰è£…å’Œä½¿ç”¨","uri":"/pgsql%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"},{"categories":null,"content":"Windows Batæ€»ç»“ æœ€è¿‘é¡¹ç›®éœ€è¦å† windows ä¸Šåšå¼€å‘ï¼Œè€Œä¸”ä¸€äº›è‡ªåŠ¨åŒ–çš„å¤„ç†éœ€è¦ä½¿ç”¨ windows çš„çš„è„šæœ¬ã€‚æ‰€ä»¥åšäº›è®°å½•ï¼Œé˜²æ­¢é—å¿˜ã€‚ åŸºæœ¬çš„è¯­æ³• é¦–å…ˆä»åŸºç¡€å¼€å§‹å§ï¼Œä¹‹å‰éƒ½æ˜¯ä½¿ç”¨ linux bash çš„ã€‚å¯ä»¥è¯´ windows bat è„šæœ¬å’Œ linux bash è„šæœ¬è¿˜æ˜¯æœ‰å¾ˆå¤šåŒºåˆ«çš„ã€‚ ","date":"2021-12-03","objectID":"/bat/:0:0","tags":null,"title":"Windows Batæ€»ç»“","uri":"/bat/"},{"categories":null,"content":"è®¾ç½®å˜é‡ å˜é‡è®¾ç½®ä½¿ç”¨çš„å‘½ä»¤ä¸ºsetã€‚ set a=\"hello world\" echo %a% ä»ä¸Šé¢çš„è„šæœ¬ä¸­å¯ä»¥çŸ¥é“ï¼Œä½¿ç”¨setæ¥è®¾ç½®å˜é‡ï¼Œè¯­æ³•ä¸ºset var=\u003cå€¼\u003eã€‚å¦‚æœè¦å¼•ç”¨è¿™ä¸ªå˜é‡çš„è¯å°±ä½¿ç”¨%var%ã€‚ æ³¨ï¼šbat è„šæœ¬ä¸èƒ½åƒ bash ä¸­ä¸€æ ·è®¾ç½®ä¸´æ—¶å˜é‡ï¼Œåªç”¨å°†å˜é‡è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ã€‚ setå‘½ä»¤çš„åŠŸèƒ½è¿˜æ˜¯æ¯”è¾ƒå¼ºå¤§çš„ï¼Œæ¯”å¦‚è·å–ä»é”®ç›˜ä¸­è¾“å…¥çš„å­—ç¬¦ï¼š set /p a=\"Input a number:\" echo %a% æ”¯æŒç®—æœ¯ï¼š set /a a=1+2 echo %a% set /a a-=1 echo %a% set /a a*=3 echo %a% set /a a/=3 echo %a% è¿™ä¸ªå…³é”®åœ¨äºset /a è¿˜æœ‰å­—ç¬¦ä¸²çš„ä¿®æ”¹å’Œæˆªå–ï¼š :::::::::: å­—ç¬¦ä¸²çš„æˆªå– :::::::::: set a=Hello Windows Bat :: æˆªå–æ‰€æœ‰ set a=%a:~0% :: æˆªå–æŒ‡å®šçš„ set a=%a:~1,-1% set a=%a:~2,4% :::::::::: å­—ç¬¦ä¸²çš„æ›¿æ¢ :::::::::: set a=Hello Windows :: å°†Windowsæ›¿æ¢æˆLinux set a=%a:Windows=Linux% ","date":"2021-12-03","objectID":"/bat/:1:0","tags":null,"title":"Windows Batæ€»ç»“","uri":"/bat/"},{"categories":null,"content":"æ³¨é‡Š bat ä¸­èƒ½å®ç°æ³¨é‡ŠåŠŸèƒ½çš„æœ‰ä¸¤ä¸ª::å’Œremã€‚ å®ƒä»¬çš„ä¸åŒç‚¹æ˜¯ï¼šremæ˜¯ä¸€æ¡å‘½ä»¤ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™ç›¸å½“äºæŠŠremæœ¬èº«åŠå…¶åé¢çš„å†…å®¹ç½®ç©ºã€‚æ—¢ç„¶å®ƒæ˜¯ä¸€æ¡å‘½ä»¤ï¼Œå°±å¿…é¡»å¤„äºå•ç‹¬çš„ä¸€è¡Œæˆ–è€…æœ‰ç±»ä¼¼ â€œ\u0026â€ çš„è¿æ¥ç¬¦å·è¿æ¥ã€‚ bat é‡åˆ°ä»¥å†’å· â€œ:â€ å¼€å¤´çš„è¡Œæ—¶ï¼ˆå¿½ç•¥å†’å·å‰çš„ç©ºæ ¼ï¼‰ï¼Œä¼šå°†å…¶åçš„è¯­å¥è¯†åˆ«ä¸ºâ€œæ ‡è®°â€è€Œä¸æ˜¯å‘½ä»¤è¯­å¥ï¼Œå› æ­¤ç±»ä¼¼ â€œ:labelâ€ è¿™æ ·çš„åœ¨ bat ä¸­ä»…ä»…æ˜¯ä¸€ä¸ªæ ‡è®°ã€‚ æ³¨: ä½¿ç”¨ bat ä¸­çš„æ³¨é‡Šæ—¶éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œä¸è¦å† () çš„è¾¹ä¸Šä½¿ç”¨æ³¨é‡Šã€‚ ","date":"2021-12-03","objectID":"/bat/:2:0","tags":null,"title":"Windows Batæ€»ç»“","uri":"/bat/"},{"categories":null,"content":"æ¡ä»¶åˆ¤æ–­ bat ä¸­çš„æ¡ä»¶åˆ¤æ–­ä¹Ÿæ˜¯ä½¿ç”¨ifã€‚ set a=1 if %a%==1 ( echo OK ) else ( echo ERROR ) å¦‚æœæ—¶åˆ¤æ–­å­—ç¬¦ä¸²ä½¿ç”¨ä¸ºç©ºæ—¶,å¯ä»¥è¿™æ ·å¤„ç†: set a=\"hello\" if (%a%)==() ( echo OK ) else ( echo ERROR ) ","date":"2021-12-03","objectID":"/bat/:3:0","tags":null,"title":"Windows Batæ€»ç»“","uri":"/bat/"},{"categories":null,"content":"å¾ªç¯è¯­å¥ bat ä¸­çš„å¾ªç¯æœ‰äº›ä¸åŒã€‚å…³é”®å­—ä¹Ÿæ˜¯forã€‚è¿˜æ˜¯å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š for /f \"delims=: tokens=1,2,3\" %%i in ( \"2018:04:11\" ) do ( echo %%i echo %%j ) è¿™æ®µè„šæœ¬ä¸­éœ€è¦æ³¨æ„çš„ç‚¹æ˜¯ï¼šdelims=:è¡¨ç¤ºä½¿ç”¨ â€œ:â€ æ¥åˆ†å‰²å­—ç¬¦ä¸²ï¼Œè€Œtokens=1,2,3åˆ™è¡¨ç¤ºå–å‡ºåˆ†å‰²åçš„å­—ç¬¦ä¸²çš„éƒ¨åˆ†ï¼Œä»1å¼€å§‹ã€‚%%iæ˜¯å¾ªç¯ä¸­çš„æ¯ä¸ªé¡¹ã€‚è¾“å‡ºæ—¶%%iå’Œ%%jåˆ†åˆ«å¯¹åº”çš„å°±æ˜¯æˆªå–çš„å­—æ®µ1å’Œ2ã€‚å¦‚æœè¿˜éœ€è¦è¾“å‡ºç¬¬ä¸‰ä¸ªï¼Œä¹Ÿæ˜¯ä½¿ç”¨%%kè¡¨ç¤ºï¼Œä¾æ¬¡ç±»æ¨ã€‚ ä½† bat ä¸­çš„forä¼šå­˜åœ¨å»¶è¿Ÿèµ‹å€¼çš„æƒ…å†µï¼Œå…ˆæ¥çœ‹ä¸€æ®µè„šæœ¬: for /f \"delims=: tokens=2\" %%i in ( 'ipconfig /all ^| findstr /i \"ipv4\" ' ) do ( echo %%i set a=%%i echo %a% ) è¾“å‡ºç»“æœ: IPv4 åœ°å€ . . . . . . . . . . . . : 192.168.168.1(é¦–é€‰) IPv4 åœ°å€ . . . . . . . . . . . . : 192.168.2.160(é¦–é€‰ IPv4 åœ°å€ . . . . . . . . . . . . : 192.168.157.1(é¦–é€‰) IPv4 åœ°å€ . . . . . . . . . . . . : 192.168.2.160(é¦–é€‰ IPv4 åœ°å€ . . . . . . . . . . . . : 192.168.2.160(é¦–é€‰) IPv4 åœ°å€ . . . . . . . . . . . . : 192.168.2.160(é¦–é€‰ %a%çš„å€¼ä¸€ç›´ç­‰äºæœ€åä¸€é¡¹ã€‚ ","date":"2021-12-03","objectID":"/bat/:4:0","tags":null,"title":"Windows Batæ€»ç»“","uri":"/bat/"},{"categories":null,"content":"å‡½æ•° bat ä¸­å‡½æ•°æ˜¯ä½¿ç”¨:labelæ–¹å¼å®šä¹‰çš„ï¼Œä½¿ç”¨callæ¥è°ƒç”¨: call :test Hello World goto EXIT :test echo %1 %2 :EXIT è„šæœ¬ä¸­çš„gotoç”¨æ¥è·³è½¬é€€å‡ºï¼Œè€Œä¸”å‡½æ•°è¦æ”¾åœ¨è„šæœ¬çš„å°¾éƒ¨ï¼Œå­˜åœ¨å¤šä¸ªå‡½æ•°æ—¶è¿˜éœ€è¦ä½¿ç”¨gotoç›´æ¥è·³è½¬ï¼Œå› ä¸ºè„šæœ¬æ˜¯ä¼šæŒ‰é¡ºåºæ‰§è¡Œä¸‹å»çš„ã€‚ å®æˆ˜æ“ä½œ @echo off set option=%1 set address=%2 if (%option%) == () ( echo \"Usage: connectIscsi.bat \u003cstart|stop\u003e \u003caddress\u003e\" goto EXIT ) if (%address%) == () ( echo \"Usage: connectIscsi.bat \u003cstart|stop\u003e \u003caddress\u003e\" goto EXIT ) if %option% == start ( call :start %address% ) else if %option% == stop ( call :stop %address% ) else ( echo \"Usage: connectIscsi.bat \u003cstart|stop\u003e \u003caddress\u003e\" goto EXIT ) ::sc config msiscsi start=auto ::net start msiscsi goto EXIT :: è¿æ¥iscsiæœåŠ¡å™¨ :start iscsicli QAddTargetPortal %1 for /f \"delims= tokens=1\" %%i in ( 'iscsicli ListTargets t ^| findstr /i \"iqn.2018-11\" ' ) do ( iscsicli qlogintarget %%i ) goto EXIT :: æ–­å¼€iscsiæœåŠ¡å™¨ :stop set a= for /f \"delims=: tokens=2\" %%i in ('iscsicli SessionList ^| findstr /i \"fffffa8\"') do ( set a=%%i goto return ) :return set a=%a: =0x% set a=%a:-=-0x% iscsicli LogoutTarget %a% iscsicli RemoveTargetPortal %1 3260 goto EXIT :EXIT è¿™ä¸ªè„šæœ¬æ˜¯ç”¨æ¥è¿æ¥å’Œæ–­å¼€iscsiæœåŠ¡å™¨çš„ã€‚è„šæœ¬æœ‰ä¸¤ä¸ªå…¥å‚ï¼Œoption å’Œ addressã€‚è¿æ¥å’Œæ–­å¼€iscsiæœåŠ¡å™¨ã€‚è„šæœ¬çš„æ€è·¯å¾ˆç®€å•ï¼Œå¼€å§‹åˆ¤æ–­è¾“å…¥å‚æ•°æ˜¯å¦æ­£ç¡®ã€‚ç„¶åæ ¹æ® option é€‰æ‹©æ‰§è¡Œå¯¹åº”çš„å‡½æ•°ã€‚ç‰¹åˆ«åœ¨:stopä¸­ï¼Œå› ä¸ºå»¶æ—¶å¤åˆ¶çš„å…³ç³»ï¼Œæ‰€ä»¥å¾ªç¯ä½“ä¸­åªæ”¾ç®€å•çš„å¤åˆ¶ï¼Œå¤„ç†éƒ¨åˆ†åœ¨å¤–é¢è¿›è¡Œå¤„ç†ã€‚ åè®° ","date":"2021-12-03","objectID":"/bat/:5:0","tags":null,"title":"Windows Batæ€»ç»“","uri":"/bat/"},{"categories":null,"content":"å»¶æ—¶èµ‹å€¼é—®é¢˜ bat çš„å»¶æ—¶èµ‹å€¼æœ‰å¯¹åº”çš„è§£å†³æ–¹æ³•ï¼š SETLOCAL ENABLEDELAYEDEXPANSION set a=hello set a=!a! set a=!a:~1! ","date":"2021-12-03","objectID":"/bat/:6:0","tags":null,"title":"Windows Batæ€»ç»“","uri":"/bat/"},{"categories":null,"content":"æ­å»ºlampç¯å¢ƒ lampå³ apache + mysql + phpï¼Œæ˜¯äº’è”ç½‘å¸¸ç”¨æ¶æ„ã€‚ è¦æ³¨æ„çš„æ˜¯phpä¾èµ–apacheå’Œmysqlï¼Œæ‰€ä»¥è¦æœ€åå®‰è£…ã€‚ç³»ç»Ÿç¯å¢ƒä¸ºCentOS6.5 å®‰è£…mysql è¿™é‡Œé€‰æ‹©å…ç¼–è¯‘å®‰è£…ï¼Œå¯ä»¥åœ¨å®˜ç½‘æ‰¾åˆ°ã€‚åœ¨mysql5.5ä¹‹åçš„ç‰ˆæœ¬ä¸åœ¨å¼€æºäº†ï¼Œä½†è¿˜å¯ä»¥é€‰æ‹©mariadbçš„åˆ†æ”¯ç‰ˆæœ¬ä½œä¸ºè¿™ä¸ªæ¶æ„çš„ä»£æ›¿ã€‚æ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹mysqlçš„å®‰è£…äº†ã€‚ ","date":"2021-12-03","objectID":"/lamp/:0:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"ä¸‹è½½mysql wget http://mirrors.sohu.com/mysql/MySQL-5.1/mysql-5.1.73-linux-i686-glibc23.tar.gz è¿™ä¸ªç‰ˆæœ¬æœ‰ç‚¹ä½ï¼Œå¯ä»¥è‡ªå·±é€‰æ‹©åˆé€‚ç‰ˆæœ¬ ","date":"2021-12-03","objectID":"/lamp/:1:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"è§£å‹ tar -zxvf tar -zxvf mysql-5.1.73-linux-i686-glibc23.tar.gz ","date":"2021-12-03","objectID":"/lamp/:2:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"ç§»åŠ¨åˆ°æŒ‡å®šç›®å½• mv mysql-5.1.73-linux-i686-glibc23 /usr/local/mysql ","date":"2021-12-03","objectID":"/lamp/:3:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"åˆ›å»ºmysqlç”¨æˆ·ï¼Œä½†ä¸å…è®¸ç™»å½•ï¼Œä¸åˆ›å»ºå®¶ç›®å½• useradd -s /sbin/nologin -M mysql -sè¡¨ç¤ºæŒ‡å®šbashï¼Œè¿™é‡Œå‡ºäºå®‰å…¨æ€§è€ƒè™‘è®¾ç½®ä¸å…è®¸ç™»å½•ï¼Œ-Mä¸åˆ›å»ºå®¶ç›®å½• ","date":"2021-12-03","objectID":"/lamp/:4:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"åˆ›å»ºæ•°æ®åº“ç›®å½•ï¼Œå¹¶æ”¹ä¸ºmysqlå±ä¸» mkdir /data/mysql -pv chown -R mysqlï¼šmysql /data/mysql ","date":"2021-12-03","objectID":"/lamp/:5:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"åˆå§‹åŒ–mysql cd /usr/local/mysql ./scripts/mysql_install_db --user=mysql --datadir=/data/mysql --user=*æ˜¯æŒ‡å®šç”¨æˆ·mysqlï¼Œ--datadir=*æ˜¯æŒ‡å®šæ•°æ®åº“ç›®å½•ã€‚å¯ä»¥ä½¿ç”¨echo $?éªŒè¯å‘½ä»¤æ‰§è¡Œç»“æœæ˜¯å¦æ­£ç¡®ï¼Œ0ä¸ºæ­£ç¡®ã€‚ ","date":"2021-12-03","objectID":"/lamp/:6:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"mysqlé…ç½®æ–‡ä»¶ cp /usr/local/mysql/support-files/my-large.cnf /etc/my.cnf vim /etc/my.cnf ...... port = 3306 #ç›‘å¬ç«¯å£ socket = /tmp/mysql.sock #socket ..... log-bin=mysql-bin #ä¿®æ”¹mysqlæ•°æ®åº“æ—¶ï¼Œè®°å½•æ—¥å¿— ","date":"2021-12-03","objectID":"/lamp/:7:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"mysqlå¯åŠ¨è„šæœ¬ cp /usr/local/mysql/mysql.server /etc/init.d/mysqld vim /etc/init.d/mysqld basedir=/usr/local/mysql #æŒ‡å®šå®‰è£…ç›®å½• datadir=/data/mysql #æŒ‡å®šæ•°æ®åº“ç›®å½• ","date":"2021-12-03","objectID":"/lamp/:8:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"è®¾ç½®å¼€æœºå¯åŠ¨ chkconfig --add mysqldï¼›chkconfig mysqld on å¼€æœºå¯åŠ¨ ç¼–è¯‘å®‰è£…mysqlæ—¶ç¼–è¯‘å‚æ•°è®°å½•åœ¨cat /usr/local/mysql/bin/mysqlbug |grep -i configure å®‰è£…httpd ä½¿ç”¨apacheçš„httpdæä¾›ç½‘ç»œwebæœåŠ¡ ","date":"2021-12-03","objectID":"/lamp/:9:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"ä¸‹è½½httpd wget http://mirrors.cnnic.cn/apache/httpd/httpd-2.2.31.tar.gz ","date":"2021-12-03","objectID":"/lamp/:10:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"è§£å‹ tar -zxvf httpd-2.2.31.tar.gz ","date":"2021-12-03","objectID":"/lamp/:11:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"ç¼–è¯‘å®‰è£… # ç¼–è¯‘ ./configure --prefix=/usr/local/apache \\ \u003e-with-include-apr --enable-so \\ \u003e--enable-deflate=shared \\ \u003e--enable-rewrite=shared \\ \u003e--enable-expires=shared \\ \u003e-with-pcre \\ \u003e-with-mpm=prefork make # å®‰è£… make install ç¼–è¯‘é€‰é¡¹è®°å½•åœ¨/usr/local/apache/build/config.nice ä¸­ ","date":"2021-12-03","objectID":"/lamp/:12:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"å¯åŠ¨httpd /usr/local/apache/bin/apachectl start /usr/local/apache/bin/apachectl -M ï¼šæŸ¥çœ‹å„ç§åº“ é™æ€åº“(ç¼–è¯‘æ—¶ç›´æ¥æ”¾å…¥ä¸‹åˆ—æ–‡ä»¶) /usr/local/apache/bin/httpd åŠ¨æ€åº“(ç”¨åˆ°æ—¶åŠ è½½) /usr/local/apache/modules/ /usr/local/apache/bin/apachectl -l ï¼šæŸ¥çœ‹é™æ€åº“ä»¥åŠapacheå·¥ä½œæ¨¡å¼ /usr/local/apache/bin/apachectl -t ï¼šæŸ¥çœ‹é…ç½®æ–‡ä»¶æœ‰æ— è¯­æ³•é”™è¯¯ é…ç½®æ–‡ä»¶ /usr/local/apache/conf/httpd.conf /usr/local/apache/bin/apachectl graceful åŠ è½½é…ç½®æ–‡ä»¶ å¯åŠ¨httpdæ—¶çš„è­¦å‘Šï¼š httpd: apr_sockaddr_info_get() failed for ã€linuxã€‘ httpd: Could not reliably determine the server's fully qualified domain name, using 127.0.0.1 for ServerName è§£å†³æ–¹æ³•(é—®é¢˜åœ¨äºä¸»æœºåä¸åŒ¹é…) è­¦å‘Š1 ï¼šåœ¨/etc/hostsä¸­çš„127.0.0.1è¡Œåæ·»åŠ linux è­¦å‘Š2 ï¼šåœ¨httpdçš„é…ç½®æ–‡ä»¶/usr/local/apache/conf/httpd.confä¸­çš„ServerNameè¡Œä¸­æ”¹ä¸º ServerName linux:80 ","date":"2021-12-03","objectID":"/lamp/:13:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"å¼€æœºå¯åŠ¨ ä¿®æ”¹å¯åŠ¨è„šæœ¬ cp /usr/local/apache/bin/apachectl /etc/init.d/httpd vim /etc/init.d/httpd åœ¨#!/bin/bashä¸‹åŠ å…¥ #chkconfig:345 61 61 #description:Apache httpd è®¾ç½®å¼€æœºå¯åŠ¨ chkconfig --add httpd chkconfig --level 345 httpd on å®‰è£…php ","date":"2021-12-03","objectID":"/lamp/:14:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"ä¸‹è½½php wget http://cn2.php.net/get/php-5.4.45.tar.bz2/from/this/mirror ","date":"2021-12-03","objectID":"/lamp/:15:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"è§£å‹ mv mirror php-5.4.45.tar.bz2 tar -jxvf php-5.4.45.tar.bz2 ","date":"2021-12-03","objectID":"/lamp/:16:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"ç¼–è¯‘å®‰è£… cd php-5.4.45 ./configure --prefix=/usr/local/php --with-apxs2=/usr/local/apache/bin/apxs --with-config-file-path=/usr/local/php/etc --with-mysql=/usr/local/mysql --with-libxml-dir --with-gd --with-jpeg-dir --with-png-dir --with-freetype-dir --with-iconv-dir --with-zlib-dir --with-bz2 --with-openssl --with-mcrypt --enable-soap --enable-gd-native-ttf --enable-mbstring --enable-sockets --enable-exif --disable-ipv6 #å‡ºç°é”™è¯¯ï¼š configure: error: jpeglib.h not found. # è§£å†³æ–¹æ³•ï¼š yum install -y libjpeg-devel #å‡ºç°é”™è¯¯ï¼š configure: error: mcrypt.h not found. #è§£å†³æ–¹æ³•ï¼š wget http://www.lishiming.net/data/attachment/forum/epel-release-6-8_32.noarch.rpm #CentOSçš„yumæ‰©å±•æº rpm -ivh epel-release-6-8_32.noarch.rpm yum install -y libmcrypt-devel make make install /usr/local/php/bin/php -m :æŸ¥çœ‹é™æ€æ¨¡å— /usr/local/php/bin/php -i ï¼šæŸ¥çœ‹ç›¸å…³é…ç½® ","date":"2021-12-03","objectID":"/lamp/:17:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"ä¿®æ”¹é…ç½®æ–‡ä»¶ cp /usr/src/php-5.4.45/php.ini-production /usr/local/php/etc/php.ini vim /usr/local/apache/conf/httpd.conf åœ¨ AddType application/x-compress .Z AddType application/x-gzip .gz .tgz ä¸¤è¡Œä¸‹åŠ å…¥ AddType application/x-httpd-php .php å°† DirectoryIndex index.html åæ·»åŠ  1.php DirectoryIndex index.html 1.php ","date":"2021-12-03","objectID":"/lamp/:18:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"æµ‹è¯• åœ¨Apacheçš„å®‰è£…æ–‡ä»¶ä¸­æ·»åŠ phpæ–‡ä»¶ /usr/local/apache/htdocs/ç›®å½•ä¸‹åˆ›å»º vim 1.php \u003c?php echo \"Welcome to 1.php\" ; ?\u003e ","date":"2021-12-03","objectID":"/lamp/:19:0","tags":null,"title":"æ­å»ºlampç¯å¢ƒ","uri":"/lamp/"},{"categories":null,"content":"æ­å»ºlnmpç¯å¢ƒ lnmpå³ï¼šnginx + mysql + php ä¸lampä¸åŒçš„æ˜¯ï¼Œlnmpçš„phpä¸åœ¨åªæ˜¯httpdä¸­çš„ä¸€ä¸ªåº“ï¼Œlnmpæ¶æ„ä¸­phpä½œä¸ºä¸€ä¸ªæœåŠ¡ï¼Œä¸“é—¨è§£æphpã€‚ åŒæ ·çš„phpä¾èµ–mysqlï¼Œæ‰€ä»¥é¦–å…ˆå®‰è£…mysql è¿™é‡Œç¯å¢ƒä¸ºCentOS6.5 å®‰è£…mysql è¿™é‡Œé€‰æ‹©å…ç¼–è¯‘å®‰è£…ï¼Œå¯ä»¥åœ¨å®˜ç½‘æ‰¾åˆ°ã€‚åœ¨mysql5.5ä¹‹åçš„ç‰ˆæœ¬ä¸åœ¨å¼€æºäº†ï¼Œä½†è¿˜å¯ä»¥é€‰æ‹©mariadbçš„åˆ†æ”¯ç‰ˆæœ¬ä½œä¸ºè¿™ä¸ªæ¶æ„çš„ä»£æ›¿ã€‚æ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹mysqlçš„å®‰è£…äº†ã€‚ ","date":"2021-12-03","objectID":"/lnmp/:0:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"ä¸‹è½½mysql wget http://mirrors.sohu.com/mysql/MySQL-5.1/mysql-5.1.73-linux-i686-glibc23.tar.gz è¿™ä¸ªç‰ˆæœ¬æœ‰ç‚¹ä½ï¼Œå¯ä»¥è‡ªå·±é€‰æ‹©åˆé€‚ç‰ˆæœ¬ ","date":"2021-12-03","objectID":"/lnmp/:1:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"è§£å‹ tar -zxvf tar -zxvf mysql-5.1.73-linux-i686-glibc23.tar.gz ","date":"2021-12-03","objectID":"/lnmp/:2:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"ç§»åŠ¨åˆ°æŒ‡å®šç›®å½• mv mysql-5.1.73-linux-i686-glibc23 /usr/local/mysql ","date":"2021-12-03","objectID":"/lnmp/:3:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"åˆ›å»ºmysqlç”¨æˆ·ï¼Œä½†ä¸å…è®¸ç™»å½•ï¼Œä¸åˆ›å»ºå®¶ç›®å½• useradd -s /sbin/nologin -M mysql -sè¡¨ç¤ºæŒ‡å®šbashï¼Œè¿™é‡Œå‡ºäºå®‰å…¨æ€§è€ƒè™‘è®¾ç½®ä¸å…è®¸ç™»å½•ï¼Œ-Mä¸åˆ›å»ºå®¶ç›®å½• ","date":"2021-12-03","objectID":"/lnmp/:4:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"åˆ›å»ºæ•°æ®åº“ç›®å½•ï¼Œå¹¶æ”¹ä¸ºmysqlå±ä¸» mkdir /data/mysql -pv chown -R mysqlï¼šmysql /data/mysql ","date":"2021-12-03","objectID":"/lnmp/:5:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"åˆå§‹åŒ–mysql cd /usr/local/mysql ./scripts/mysql_install_db --user=mysql --datadir=/data/mysql --user=*æ˜¯æŒ‡å®šç”¨æˆ·mysqlï¼Œ--datadir=*æ˜¯æŒ‡å®šæ•°æ®åº“ç›®å½•ã€‚å¯ä»¥ä½¿ç”¨echo $?éªŒè¯å‘½ä»¤æ‰§è¡Œç»“æœæ˜¯å¦æ­£ç¡®ï¼Œ0ä¸ºæ­£ç¡®ã€‚ ","date":"2021-12-03","objectID":"/lnmp/:6:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"mysqlé…ç½®æ–‡ä»¶ cp /usr/local/mysql/support-files/my-large.cnf /etc/my.cnf vim /etc/my.cnf ...... port = 3306 #ç›‘å¬ç«¯å£ socket = /tmp/mysql.sock #socket ..... log-bin=mysql-bin #ä¿®æ”¹mysqlæ•°æ®åº“æ—¶ï¼Œè®°å½•æ—¥å¿— ","date":"2021-12-03","objectID":"/lnmp/:7:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"mysqlå¯åŠ¨è„šæœ¬ cp /usr/local/mysql/mysql.server /etc/init.d/mysqld vim /etc/init.d/mysqld basedir=/usr/local/mysql #æŒ‡å®šå®‰è£…ç›®å½• datadir=/data/mysql #æŒ‡å®šæ•°æ®åº“ç›®å½• ","date":"2021-12-03","objectID":"/lnmp/:8:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"è®¾ç½®å¼€æœºå¯åŠ¨ chkconfig --add mysqldï¼›chkconfig mysqld on å¼€æœºå¯åŠ¨ ç¼–è¯‘å®‰è£…mysqlæ—¶ç¼–è¯‘å‚æ•°è®°å½•åœ¨cat /usr/local/mysql/bin/mysqlbug |grep -i configure å®‰è£…php ","date":"2021-12-03","objectID":"/lnmp/:9:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"ä¸‹è½½ wget http://cn2.php.net/get/php-5.4.45.tar.bz2/from/this/mirror ","date":"2021-12-03","objectID":"/lnmp/:10:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"è§£å‹ mv mirror php-5.4.45.tar.bz2 tar -jxvf php-5.4.45.tar.bz2 ","date":"2021-12-03","objectID":"/lnmp/:11:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"ç¼–è¯‘å®‰è£… cd php-5.4.45 ./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --enable-fpm --with-fpm-user=php-fpm --with-fpm-group=php-fpm --with-mysql=/usr/local/mysql --with-mysql-sock=/tmp/mysql.sock --with-libxml-dir --with-gd --with-jpeg-dir --with-png-dir --with-freetype-dir --with-iconv-dir --with-zlib-dir --with-mcrypt --enable-soap --enable-gd-native-ttf --enable-ftp --enable-mbstring --enable-exif --enable-zend-multibyte --disable-ipv6 --with-pear --with-curl # å‡ºç°é”™è¯¯ï¼š configure: error: jpeglib.h not found. #è§£å†³æ–¹æ³•ï¼š yum install -y libjpeg-devel #å‡ºç°é”™è¯¯ï¼š configure: error: mcrypt.h not found. # è§£å†³æ–¹æ³•ï¼š wget http://www.lishiming.net/data/attachment/forum/epel-release-6-8_32.noarch.rpm #CentOSçš„yumæ‰©å±•æº rpm -ivh epel-release-6-8_32.noarch.rpm yum install -y libmcrypt-devel make make install /usr/local/php/bin/php -m :æŸ¥çœ‹é™æ€æ¨¡å— /usr/local/php/bin/php -i ï¼šæŸ¥çœ‹ç›¸å…³é…ç½® ","date":"2021-12-03","objectID":"/lnmp/:12:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"phpçš„é…ç½®æ–‡ä»¶ cp /usr/src/php-5.4.45/php.ini-production /usr/local/php/etc/php.ini ","date":"2021-12-03","objectID":"/lnmp/:13:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"phpå¼€æœºå¯åŠ¨ cp /usr/src/php-5.4.45/sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm mv /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf #æœåŠ¡å¯åŠ¨çš„è„šæœ¬é…ç½®æ–‡ä»¶ chkconfig --add php-fpm chkconfig --level 345 php-fpm on ","date":"2021-12-03","objectID":"/lnmp/:14:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"å¯åŠ¨php useradd -s /sbin/nologin php-fpm chmod +x /etc/init.d/php-fpm service php-fpm start å®‰è£…nginx ","date":"2021-12-03","objectID":"/lnmp/:15:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"ä¸‹è½½nginx cd /usr/src wget http://nginx.org/download/nginx-1.6.2.tar.gz ","date":"2021-12-03","objectID":"/lnmp/:16:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"è§£å‹ tar -xvf nginx-1.6.2.tar.gz ","date":"2021-12-03","objectID":"/lnmp/:17:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"ç¼–è¯‘å®‰è£… ./configure --prefix=/usr/local/nginx --with-pcre #å‡ºç°é”™è¯¯ï¼š ./configure: error: the HTTP rewrite module requires the PCRE library. #è§£å†³æ–¹æ³•ï¼š yum install -y pcre-devel make make install ","date":"2021-12-03","objectID":"/lnmp/:18:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"å¯åŠ¨ ç¼–è¾‘å¯åŠ¨è„šæœ¬ vim /etc/init.d/nginx #!/bin/bash # chkconfig: - 30 21 # description: http service. # Source Function Library . /etc/init.d/functions # Nginx Settings NGINX_SBIN=\"/usr/local/nginx/sbin/nginx\" NGINX_CONF=\"/usr/local/nginx/conf/nginx.conf\" NGINX_PID=\"/usr/local/nginx/logs/nginx.pid\" RETVAL=0 prog=\"Nginx\" start() { echo -n $\"Starting $prog: \" mkdir -p /dev/shm/nginx_temp daemon $NGINX_SBIN -c $NGINX_CONF RETVAL=$? echo return $RETVAL } stop() { echo -n $\"Stopping $prog: \" killproc -p $NGINX_PID $NGINX_SBIN -TERM rm -rf /dev/shm/nginx_temp RETVAL=$? echo return $RETVAL } reload(){ echo -n $\"Reloading $prog: \" killproc -p $NGINX_PID $NGINX_SBIN -HUP RETVAL=$? echo return $RETVAL } restart(){ stop start } configtest(){ $NGINX_SBIN -c $NGINX_CONF -t return 0 } case \"$1\" in start) start ;; stop) stop ;; reload) reload ;; restart) restart ;; configtest) configtest ;; *) echo $\"Usage: $0{start|stop|reload|restart|configtest}\" RETVAL=1 esac exit $RETVAL ä¿å­˜åï¼Œæ›´æ”¹æƒé™: chmod 755 /etc/init.d/nginx chkconfig --add nginx å¼€æœºå¯åŠ¨ chkconfig nginx on å¯åŠ¨æœåŠ¡ service nginx start ","date":"2021-12-03","objectID":"/lnmp/:19:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"æµ‹è¯•è§£æphp ç¼–è¾‘é…ç½®æ–‡ä»¶/usr/local/nginx/conf/nginx.conf ä¿®æ”¹åˆ¶å®šè¡Œ ...... location ~ \\.php$ { root html; fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME /usr/local/nginx/html$fastcgi_script_name; #è·¯å¾„ä¸ºç½‘ç«™æ ¹ç›®å½• include fastcgi_params; } ...... åœ¨/usr/local/nginx/html/ä¸‹åˆ›å»ºä¸€ä¸ªinfo.phpæ–‡ä»¶ \u003c?php phpinfo(); ?\u003e æµè§ˆå™¨è®¿é—®ï¼šhttp://127.0.0.1/info.phpæµ‹è¯• ","date":"2021-12-03","objectID":"/lnmp/:20:0","tags":null,"title":"æ­å»ºlnmpç¯å¢ƒ","uri":"/lnmp/"},{"categories":null,"content":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ ","date":"2021-12-03","objectID":"/csapp/:0:0","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"ä¸€ã€è®¡ç®—æœºç³»ç»Ÿæ¼«æ¸¸ è®¡ç®—æœºç³»ç»Ÿæ˜¯ç”±ç¡¬ä»¶å’Œè½¯ä»¶ç»„æˆã€‚ ","date":"2021-12-03","objectID":"/csapp/:1:0","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"1.1 ä¿¡æ¯å°±æ˜¯ä½ + ä¸Šä¸‹æ–‡ ç³»ç»Ÿä¸­æ‰€æœ‰çš„ä¿¡æ¯â€”â€”åŒ…æ‹¬ç£ç›˜æ–‡ä»¶ã€å†…å­˜ä¸­çš„ç¨‹åºã€å†…å­˜ä¸­å­˜æ”¾çš„ç”¨æˆ·æ•°æ®ä»¥åŠç½‘ç»œä¸Šä¼ é€çš„æ•°æ®ï¼Œéƒ½æ˜¯ç”±ä¸€ä¸² bit è¡¨ç¤ºçš„ã€‚åŒºåˆ†ä¸åŒæ•°æ®å¯¹è±¡çš„å”¯ä¸€æ–¹æ³•æ˜¯æˆ‘ä»¬è¯»åˆ°è¿™äº›æ•°æ®å¯¹è±¡æ˜¯çš„ä¸Šä¸‹æ–‡ã€‚ ","date":"2021-12-03","objectID":"/csapp/:1:1","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"1.2 ç¨‹åºè¢«å…¶ä»–ç¨‹åºç¿»è¯‘æˆä¸åŒçš„æ ¼å¼ ","date":"2021-12-03","objectID":"/csapp/:1:2","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"1.3 äº†è§£ç¼–è¯‘ç³»ç»Ÿå¦‚ä½•å·¥ä½œæ˜¯å¤§æœ‰ç›Šå¤„çš„ ä¸ºä»€ä¹ˆç¨‹åºå‘˜å¿…é¡»è¦çŸ¥é“ç¼–è¯‘ç³»ç»Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„? ä¼˜åŒ–ç¨‹åºæ€§èƒ½ã€‚ ç†è§£é“¾æ¥æ—¶å‡ºç°çš„é”™è¯¯ã€‚ é¿å…å®‰å…¨æ¼æ´ã€‚ ","date":"2021-12-03","objectID":"/csapp/:1:3","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"1.4 å¤„ç†å™¨è¯»å¹¶è§£é‡Šå‚¨å­˜åœ¨å†…å­˜ä¸­æŒ‡ä»¤ ç³»ç»Ÿç¡¬ä»¶ç»„æˆ æ€»çº¿: è´¯ç©¿æ•´ä¸ªç³»ç»Ÿçš„ä¸€ç»„ç”µå­ç®¡é“ï¼Œç§°ä½œæ€»çº¿ï¼Œä»–æºå¸¦ä¿¡æ¯å­—èŠ‚å¹¶è´Ÿè´£åœ¨å„ä¸ªéƒ¨ä»¶é—´ä¼ é€’ã€‚ I/O è®¾å¤‡: ç³»ç»Ÿä¸å¤–éƒ¨ä¸–ç•Œçš„è”ç³»é€šé“ã€‚æ¯ä¸ª I/O è®¾å¤‡éƒ½é€šè¿‡ä¸€ä¸ªæ§åˆ¶å™¨æˆ–è€…é€‚é…å™¨ä¸ I/O æ€»çº¿ç›¸è¿ã€‚æ§åˆ¶å™¨å’Œé€‚é…å™¨ä¹‹é—´çš„åŒºåˆ«ä¸»è¦åœ¨äºå®ƒä»¬çš„å°è£…æ–¹å¼ã€‚æ§åˆ¶å™¨æ˜¯ I/O è®¾å¤‡æœ¬èº«æˆ–è€…ç³»ç»Ÿçš„ä¸»å°åˆ¶ç”µè·¯æ¿ä¸Šçš„èŠ¯ç‰‡ç»„ã€‚è€Œé€‚é…å™¨åˆ™æ˜¯ä¸€å—æ’åœ¨ä¸»æ¿æ’æ§½ä¸Šçš„å¡ã€‚ ä¸»å­˜: ä¸»å­˜æ˜¯ä¸€ä¸ªä¸´æ—¶å­˜å‚¨è®¾å¤‡ï¼Œåœ¨å¤„ç†æ‰§è¡Œç¨‹åºæ—¶ï¼Œç”¨æ¥å­˜æ”¾ç¨‹åºå’Œç¨‹åºå¤„ç†çš„æ•°æ®ã€‚ä»ç‰©ç†ä¸Šæ¥è¯´ï¼Œä¸»å­˜æ˜¯ç”±ä¸€ç»„åŠ¨æ€éšæœºå­˜å‚¨å­˜å‚¨å™¨ (DRAM) èŠ¯ç‰‡ç»„æˆçš„ã€‚ä»é€»è¾‘ä¸Šæ¥è¯´ï¼Œå­˜å‚¨å™¨æ˜¯ä¸€ä¸ªçº¿æ€§çš„å­—èŠ‚æ•°ç»„ï¼Œæ¯ä¸ªå­—èŠ‚éƒ½æœ‰å…¶å”¯ä¸€çš„åœ°å€(æ•°ç»„ç´¢å¼•)ï¼Œè¿™äº›åœ°å€æ˜¯ä»é›¶å¼€å§‹çš„ã€‚ å¤„ç†å™¨ï¼šä¸­å¤®å¤„ç†å•å…ƒ (CPU)ï¼Œç®€ç§°å¤„ç†å™¨ï¼Œæ˜¯è§£é‡Š(æˆ–)æ‰§è¡Œå­˜å‚¨åœ¨ä¸»å­˜ä¸­æŒ‡ä»¤çš„å¼•æ“ã€å¤„ç†å™¨çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªå¤§å°ä¸ä¸€ä¸ªå­—çš„å­˜å‚¨è®¾å¤‡(æˆ–å¯„å­˜å™¨)ï¼Œç§°ä¸ºç¨‹åºè®¡æ•°å™¨(PC)ã€‚åœ¨ä»»ä½•æ—¶åˆ»ï¼ŒPC éƒ½æŒ‡å‘ä¸»å­˜ä¸­çš„æŸæ¡æœºå™¨è¯­è¨€æŒ‡ä»¤ã€‚ ç³»ç»Ÿæ‰§è¡Œä¸€ä¸ª Hello World ç¨‹åºæ—¶ï¼Œç¡¬ä»¶è¿è¡Œæµç¨‹ã€‚ é”®ç›˜è¾“å…¥å‘½ä»¤æ—¶ï¼Œshell ç¨‹åºå°†å­—ç¬¦é€ä¸€è¯»å…¥å¯„å­˜å™¨ï¼Œå†å­˜æ”¾åˆ°å†…å­˜ä¸­ã€‚ é”®å…¥å›è½¦é”®åï¼Œshell æ‰§è¡Œä¸€ç³»åˆ—æŒ‡ä»¤æ¥åŠ è½½å¯æ‰§è¡Œçš„ hello æ–‡ä»¶ï¼Œå°† hello ç›®æ ‡æ–‡ä»¶ä¸­çš„ä»£ç å’Œæ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°å†…å­˜ã€‚ å¤„ç†å™¨å¼€å§‹æ‰§è¡Œ hello ç¨‹åº main ç¨‹åºä¸­çš„æœºå™¨è¯­è¨€æŒ‡ä»¤ã€‚ è¿™äº›æŒ‡ä»¤å°†è¾“å‡ºçš„å­—ç¬¦ä¸²ä¸­çš„å­—èŠ‚ä»ä¸»å­˜å¤åˆ¶åˆ°å¯„å­˜å™¨æ–‡ä»¶ï¼Œå†ä»å¯„å­˜å™¨æ–‡ä»¶ä¸­å¤åˆ¶åˆ°æ˜¾ç¤ºè®¾å¤‡ï¼Œæœ€ç»ˆæ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚ ","date":"2021-12-03","objectID":"/csapp/:1:4","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"1.5 é«˜é€Ÿç¼“å­˜è‡³å…³é‡è¦ ç³»ç»Ÿè¿è¡Œæ—¶ä¼šé¢‘ç¹çš„æŒªåŠ¨ä¿¡æ¯ï¼Œè€Œä¸åŒå­˜å‚¨è®¾å¤‡ä¹‹é—´çš„è¯»å†™æ€§èƒ½æœ‰ä¸¥é‡åå·® (ä»å¯„å­˜å™¨ä¸­è¯»å–æ•°æ®æ¯”ä»ä¸»å­˜ä¸­è¯»å–å¿« 100 è¢«ï¼Œä»ä¸»å­˜ä¸­è¯»å–åˆæ¯”ç£ç›˜ä¸­å¿« 1000 ä¸‡å€)ã€‚æ‰€ä»¥ä¸åŒå­˜å‚¨è®¾å¤‡é—´éœ€è¦é«˜é€Ÿç¼“å­˜æ¥æä¾›ç³»ç»Ÿè¿è¡Œé€Ÿåº¦ã€‚ è¿™é‡Œçš„é«˜é€Ÿç¼“å­˜æ˜¯ç›¸å¯¹æ¦‚å¿µã€‚ ","date":"2021-12-03","objectID":"/csapp/:1:5","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"1.6 å­˜å‚¨è®¾å¤‡å½¢æˆå±‚æ¬¡ç»“æ„ ","date":"2021-12-03","objectID":"/csapp/:1:6","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"1.7 æ“ä½œç³»ç»Ÿç®¡ç†ç¡¬ä»¶ æˆ‘ä»¬å¹¶ä¸ç›´æ¥è®¿é—®ç¡¬ä»¶ï¼Œè€Œæ˜¯é€šè¿‡æ“ä½œç³»ç»Ÿã€‚æ‰€æœ‰åº”ç”¨ç¨‹åºå¯¹ç¡¬ä»¶çš„æ“ä½œå°è¯•éƒ½å¿…é¡»é€šè¿‡æ“ä½œç³»ç»Ÿã€‚ æ“ä½œç³»ç»Ÿæœ‰ä¸¤ä¸ªåŸºæœ¬åŠŸèƒ½: é˜²æ­¢ç¡¬ä»¶è¢«å¤±æ§çš„åº”ç”¨ç¨‹åºæ»¥ç”¨ã€‚ å‘åº”ç”¨ç¨‹åºæä¾›ç®€å•ä¸€è‡´çš„æœºåˆ¶æ¥æ§åˆ¶å¤æ‚è€Œåˆé€šå¸¸ä¸å¤§ç›¸åŒçš„ä½çº§ç¡¬ä»¶è®¾å¤‡ã€‚ æ“ä½œç³»ç»Ÿé€šè¿‡å‡ ä¸ªåŸºæœ¬æŠ½è±¡æ¦‚å¿µæ¥å®ç°è¿™ä¸¤ä¸ªåŠŸèƒ½ã€‚ è¿›ç¨‹: æ“ä½œç³»ç»Ÿå¯¹ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åºçš„ä¸€ç§æŠ½è±¡ã€‚ ä¸Šä¸‹æ–‡: æ“ä½œç³»ç»Ÿä¿æŒè·Ÿè¸ªè¿›ç¨‹è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…å« PC å’Œå¯„å­˜å™¨æ–‡ä»¶çš„å½“å‰å€¼ï¼Œä»¥åŠä¸»å­˜çš„å†…å­˜ã€‚ åœ¨ä»»ä½•ä¸€ä¸ªæ—¶åˆ»ï¼Œå•å¤„ç†å™¨ç³»ç»Ÿéƒ½åªèƒ½æ‰§è¡Œä¸€ä¸ªè¿›ç¨‹çš„ä»£ç ã€‚å½“æ“ä½œç³»ç»Ÿå†³å®šè¦æŠŠæ§åˆ¶æƒä»å½“å‰è¿›ç¨‹è½¬ç§»åˆ°æŸä¸ªæ–°è¿›ç¨‹æ—¶ï¼Œå°±ä¼šè¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚è¿™ä¸€è¿‡ç¨‹æœ‰æ“ä½œç³»ç»Ÿå†…æ ¸ (kernel) ç®¡ç†ã€‚ çº¿ç¨‹: ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å®é™…ä¸Šå¯ä»¥ç”±å¤šä¸ªç§°ä¸ºçº¿ç¨‹çš„æ‰§è¡Œå•å…ƒç»„æˆï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½è£•å…´åœ¨è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶å…±äº«åŒæ ·çš„ä»£ç å’Œå…¨å±€æ•°æ®ã€‚ è™šæ‹Ÿæœºå†…å­˜æ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå®ƒä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›ä¸€ä¸ªå‡è±¡ï¼Œå³æ¯ä¸ªè¿›ç¨‹éƒ½åœ¨ç‹¬å åœ°ä½¿ç”¨ä¸»å­˜ï¼Œæ¯ä¸ªè¿›ç¨‹çœ‹åˆ°çš„å†…å­˜éƒ½æ˜¯ä¸€è‡´çš„ï¼Œç§°ä¸ºè™šæ‹Ÿåœ°å€ç©ºé—´ã€‚ è™šæ‹Ÿåœ°å€ç©ºé—´ä»ä¸‹è‡³ä¸Šä¾æ¬¡ä¸º: ç¨‹åºä»£ç å’Œæ•°æ®ã€‚å¯¹æ‰€æœ‰çš„è¿›ç¨‹æ¥è¯´ï¼Œä»£ç æ˜¯ä»åŒä¸€å›ºå®šåœ°å€å¼€å§‹ï¼Œç´§æ¥ç€çš„æ˜¯å’Œ C å…¨å±€å˜é‡ç›¸å¯¹åº”çš„æ•°æ®ä½ç½®ã€‚ä»£ç å’Œæ•°æ®åŒºæ˜¯ç›´æ¥æŒ‰ç…§å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶çš„å†…å®¹åˆå§‹åŒ–çš„ã€‚ å †ã€‚å †å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°æ‰©å±•å’Œæ”¶ç¼©ã€‚ å…±äº«åº“ã€‚å­˜æ”¾ C æ ‡å‡†åº“å’Œæ•°å­¦åº“è¿™äº›å…±äº«åº“çš„ä»£ç å’Œæ•°æ®ã€‚ æ ˆã€‚ä½äºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´é¡¶éƒ¨ï¼Œç¼–è¯‘å™¨ç”¨å®ƒæ¥å®ç°å‡½æ•°è°ƒç”¨ï¼Œå®ƒå’Œå †ä¸€æ ·åœ¨ç¨‹åºè¿è¡ŒæœŸé—´å¯ä»¥åŠ¨æ€åœ°æ‰©å±•å’Œæ”¶ç¼©ã€‚æ¯æ¬¡è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œæ ˆå°±ä¼šå¢é•¿ï¼Œä»ä¸€ä¸ªå‡½æ•°è¿”å›æ—¶ï¼Œæ ˆå°±ä¼šæ”¶ç¼©ã€‚ å†…æ ¸è™šæ‹Ÿå†…å­˜ã€‚åœ°å€ç©ºé—´é¡¶éƒ¨çš„åŒºåŸŸæ˜¯ä¸ºå†…æ ¸ä¿ç•™çš„ã€‚ä¸å…è®¸åº”ç”¨ç¨‹åºè¯»å†™è¿™ä¸ªåŒºåŸŸçš„å†…å®¹æˆ–è€…ç›´æ¥è°ƒç”¨å†…æ ¸ä»£ç å®šä¹‰çš„å‡½æ•°ã€‚ç›¸åï¼Œä»–ä»¬å¿…é¡»è°ƒç”¨å†…æ ¸æ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚ æ–‡ä»¶å°±æ˜¯å­—èŠ‚åºåˆ—ï¼æ¯ä¸ª I/O è®¾å¤‡ï¼ŒåŒ…æ‹¬ç£ç›˜ã€é”®ç›˜ã€æ˜¾ç¤ºå™¨ï¼Œç”šè‡³ç½‘ç»œï¼Œéƒ½å¯ä»¥çœ‹æˆæ–‡ä»¶ã€‚ ","date":"2021-12-03","objectID":"/csapp/:1:7","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"1.8 ç³»ç»Ÿä¹‹é—´åˆ©ç”¨ç½‘ç»œé€šä¿¡ ç¡¬ä»¶å’Œè½¯ä»¶ç»„åˆæˆä¸€ä¸ªç³»ç»Ÿï¼Œè€Œé€šè¿‡ç½‘ç»œé—´ä¸åŒçš„ä¸»æœºè¿æ¥æˆä¸€ä¸ªæ›´å¹¿å¤§çš„ç°ä»£ç³»ç»Ÿã€‚ ","date":"2021-12-03","objectID":"/csapp/:1:8","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"1.9 é‡è¦ä¸»é¢˜ å¹¶å‘ (concurrency): ä¸€ä¸ªåŒæ—¶å…·æœ‰å¤šä¸ªæ´»åŠ¨çš„ç³»ç»Ÿã€‚ å¹¶è¡Œ (parallelism): ç”¨å¹¶å‘æ¥æ˜¯ä¸€ä¸ªç³»ç»Ÿè¿è¡Œå¾—æ›´å¿«ã€‚ è¶…çº¿ç¨‹ï¼šæœ‰æ—¶ç§°ä¸ºåŒæ—¶å¤šçº¿ç¨‹ (simultaneous multi-threading)ï¼Œæ˜¯ä¸€é¡¹å…è®¸ä¸€ä¸ª CPU æ‰§è¡Œå¤šä¸ªæ§åˆ¶æµçš„æŠ€æœ¯ã€‚ æŠ½è±¡çš„ä½¿ç”¨æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­æœ€ä¸ºé‡è¦çš„æ¦‚å¿µä¹‹ä¸€ã€‚è¿™é‡Œä»‹ç»å››ä¸ªæŠ½è±¡: æ–‡ä»¶æ˜¯å¯¹ I/O è®¾å¤‡çš„æŠ½è±¡ã€‚ è™šæ‹Ÿå†…å­˜æ˜¯å¯¹ç¨‹åºå­˜å‚¨å™¨çš„æŠ½è±¡ã€‚ è¿›ç¨‹æ˜¯å¯¹ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åºçš„æŠ½è±¡ã€‚ è™šæ‹Ÿæœºæ˜¯å¯¹æ•´ä¸ªè®¡ç®—æœºçš„æŠ½è±¡ã€‚ ","date":"2021-12-03","objectID":"/csapp/:1:9","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"ä¸‰ã€ç¨‹åºçš„æœºå™¨çº§è¡¨ç¤º ","date":"2021-12-03","objectID":"/csapp/:2:0","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"3.1 å†å²è§‚ç‚¹ Intel å¤„ç†å™¨ç³»åˆ—ä¿—ç§° x86ã€‚ æ‘©å°”å®šå¾‹: 1965 å¹´ï¼Œ Gordon Moore, Intel å…¬å¸çš„åˆ›å§‹äººæ ¹æ®å½“æ—¶çš„èŠ¯ç‰‡æŠ€æœ¯åšå‡ºæ¨æ–­ï¼Œé¢„æµ‹åœ¨æœªæ¥ 10 å¹´ï¼ŒèŠ¯ç‰‡ä¸Šçš„æ™¶ä½“ç®¡æ•°é‡æ¯å¹´éƒ½ä¼šç¿»ä¸€ç•ªã€‚è¿™ä¸ªé¢„æµ‹å°±æˆä¸ºæ‘©å°”å®šå¾‹ã€‚ ","date":"2021-12-03","objectID":"/csapp/:2:1","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"3.2 ç¨‹åºç¼–ç  æœºå™¨çº§ç¼–ç¨‹é‡è¦çš„ä¸¤ç§æŠ½è±¡: ç”±æŒ‡ä»¤çº§ä½“ç³»ç»“æ„æˆ–æŒ‡ä»¤é›†æ¶æ„(Instruction Set Architecture, ISA) æ¥å®šä¹‰æœºå™¨çº§ç¨‹åºçš„æ ¼å¼å’Œè¡Œä¸ºï¼Œå®ƒå®šä¹‰äº†å¤„ç†å™¨çŠ¶æ€ã€æŒ‡ä»¤çš„æ ¼å¼ï¼Œä»¥åŠæ¯æ¡æŒ‡ä»¤å¯¹çŠ¶æ€çš„å½±å“ã€‚ æœºå™¨çº§ç¨‹åºä½¿ç”¨çš„å†…å­˜åœ°å€æ˜¯è™šæ‹Ÿåœ°å€ï¼Œæä¾›çš„å†…å­˜æ¨¡å‹çœ‹ä¸Šå»æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„å­—èŠ‚æ•°ç»„ã€‚ æ±‡ç¼–ä»£ç éå¸¸æ¥è¿‘äºæœºå™¨ä»£ç ï¼Œå®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯å®ƒç”¨å¯è¯»æ€§æ›´å¥½çš„æ–‡æœ¬æ ¼å¼è¡¨ç¤ºã€‚ ç¨‹åºå†…å­˜åŒ…å«ï¼šç¨‹åºçš„å¯æ‰§è¡Œæœºå™¨ä»£ç ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦çš„ä¸€äº›ä¿¡æ¯ï¼Œç”¨æ¥ç®¡ç†è¿‡ç¨‹è°ƒç”¨å’Œè¿”å›çš„è¿è¡Œæ—¶æ ˆï¼Œä»¥åŠç”¨æˆ·åˆ†é…çš„å†…å­˜å—ã€‚ ä¸€æ¡æœºå™¨æŒ‡ä»¤åªèƒ½æ‰§è¡Œä¸€ä¸ªéå¸¸åŸºæœ¬çš„æ“ä½œã€‚ ","date":"2021-12-03","objectID":"/csapp/:2:2","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"3.3 æ•°æ®æ ¼å¼ Intel ä¸­æ•°æ®æ ¼å¼ï¼š å­— word: è¡¨ç¤º 16 ä½æ•°æ®ç±»å‹ åŒå­— double words: 32 ä½æ•° å››å­— qoad words: 64 ä½æ•° C è¯­è¨€æ•°æ®ç±»å‹åœ¨ x86-64 ä¸­çš„å¤§å°ã€‚åœ¨ 64 ä¸ºæœºå™¨ä¸­ï¼ŒæŒ‡é’ˆé•¿ 8 å­—èŠ‚ã€‚ å¤§å¤šæ•°GCCç”Ÿæˆçš„æ±‡ç¼–ä»£ç æŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ªå­—ç¬¦çš„åç¼€ï¼Œè¡¨æ˜æ“ä½œæ•°çš„å¤§å°ã€‚ä¾‹å¦‚ã€‚æ•°æ®ä¼ é€æŒ‡ä»¤æœ‰å››ä¸ªå˜ç§ï¼š movb: ä¼ é€å­—èŠ‚ movw: ä¼ é€å­— movl: ä¼ é€åŒå­— movq: ä¼ é€å››å­— ","date":"2021-12-03","objectID":"/csapp/:2:3","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"3.4 è®¿é—®ä¿¡æ¯ ä¸€ä¸ª x86-64 çš„ä¸­å¤®å¤„ç†å•å…ƒ CPU åŒ…å«ä¸€ç»„ 16 ä¸ªå­˜å‚¨ 64 ä½å€¼çš„é€šç”¨ç›®çš„å¯„å­˜å™¨ï¼Œè¿™äº›å¯„å­˜å™¨ç”¨æ¥å­˜å‚¨æ•´æ•°æ•°æ®å’ŒæŒ‡é’ˆã€‚ å…³äºå¯„å­˜å™¨çš„è¯´æ˜å¯ä»¥å‚è€ƒ: X86-64 å¯„å­˜å™¨å’Œæ ˆå¸§ x86_64 å¯„å­˜å™¨ä»‹ç» å¤§å¤šæ•°æŒ‡ä»¤æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ“ä½œæ•°(operand)ï¼ŒæŒ‡ç¤ºå‡ºæ‰§è¡Œä¸€ä¸ªæ“ä½œä¸­è¦ä½¿ç”¨åˆ°çš„æºæ•°æ®å€¼ï¼Œä»¥åŠæ”¾ç½®ç»“æœçš„ç›®çš„ä½ç½®ã€‚ å­˜æ”¾æ“ä½œæ•°çš„ç±»å‹ï¼š ç«‹å³æ•°(immediate)ï¼Œç”¨æ¥è¡¨ç¤ºå¸¸æ•°å€¼ã€‚æ ¼å¼æ˜¯ â€˜$â€™ åé¢è·Ÿä¸€ä¸ªæ ‡å‡† C è¡¨ç¤ºæ³•è¡¨ç¤ºçš„æ•´æ•°ã€‚æ¯”å¦‚ $-577æˆ–$0x1Fã€‚ å¯„å­˜å™¨(register)ï¼Œå®ƒè¡¨ç¤ºæŸä¸ªå¯„å­˜å™¨çš„å†…å®¹ï¼Œç”¨ç¬¦å· $R_a$ è¡¨ç¤ºã€‚ å†…å­˜å¼•ç”¨ï¼Œå®ƒä¼šæ ¹æ®è®¡ç®—å‡ºæ¥çš„åœ°å€(é€šå¸¸ç§°ä¸ºæœ‰æ•ˆåœ°å€)è®¿é—®æŸä¸ªå†…å­˜ä½ç½®ã€‚ä½¿ç”¨ $M_b$[Addr] è¡¨ç¤ºå¯¹å­˜å‚¨åœ¨å†…å­˜ä¸­ä» Addr å¼€å§‹çš„ b ä¸ªå­—èŠ‚å€¼çš„å¼•ç”¨ã€‚ å¤šç§ä¸åŒçš„å¯»å€æ–¹å¼ï¼Œå…è®¸ä¸åŒå½¢å¼çš„å†…å­˜å¼•ç”¨ã€‚ Imm($r_b$, $r_i$, s) : ä¸€ä¸ªç«‹å³æ•°åç§» Immï¼Œä¸€ä¸ªåŸºå€å¯„å­˜å™¨ $r_b$ï¼Œä¸€ä¸ªå˜å€å¯„å­˜å™¨ $r_i$ å’Œä¸€ä¸ªæ¯”ä¾‹å› å­ sï¼Œs å¿…é¡»æ˜¯ 1ã€2ã€4ã€8ã€‚åŸºå€å’Œå˜å€å¯„å­˜å™¨éƒ½å¿…é¡»æ˜¯ 64 ä½å¯„å­˜å™¨ã€‚æœ‰æ•ˆåœ°å€ä¸º Imm+R[$r_b$]+R[$r_i$]*sã€‚ è®¡ç®—é¢˜: æœ‰ä»¥ä¸‹å†…å­˜åœ°å€å’Œå¯„å­˜å™¨çš„å€¼: å¾—å‡ºä»¥ä¸‹æ“ä½œæ•°çš„å€¼: æ“ä½œæ•° å€¼ æ³¨é‡Š %rax 0x100 å¯„å­˜å™¨ 0x104 0xAB ç»å¯¹åœ°å€ $0x108 0x108 ç«‹å³æ•° (%rax) 0xFF åœ°å€ 0x100 4(%rax) 0xAB åœ°å€ 0x104 9(%rax,%rdx) 0x11 åœ°å€ 0x10C 260(%rax,%rdx) 0x13 åœ°å€ 0x108 OxFC(,%rcx,4) 0xFF åœ°å€ 0x100 (%rax,%rdx,4) 0x11 åœ°å€ 0x10C æ•°æ®ä¼ é€æŒ‡ä»¤: å°†æ•°æ®ä»ä¸€ä¸ªä½ç½®å¤åˆ¶åˆ°å¦ä¸€ä¸ªä½ç½®ã€‚ æºæ“ä½œæ•°æŒ‡å®šçš„å€¼æ˜¯ä¸€ä¸ªç«‹å³æ•°ï¼Œå­˜å‚¨åœ¨å¯„å­˜å™¨æˆ–è€…å†…å­˜ä¸­ã€‚ç›®çš„æ“ä½œæ•°æŒ‡å®šä¸€ä¸ªä½ç½®ï¼Œå¯„å­˜å™¨æˆ–è€…å†…å­˜åœ°å€ã€‚ x86-64 ä¸­ä¼ é€æŒ‡ä»¤çš„ä¸¤ä¸ªæ“ä½œæ•°ä¸èƒ½éƒ½æŒ‡å‘å†…å­˜ä½ç½®ï¼Œå†…å­˜é—´çš„å¤åˆ¶éœ€è¦ä¸¤æ¡æŒ‡ä»¤ã€‚ MOV çš„äº”ç§å¯èƒ½ç»„åˆ: movl $0x4050, $eax ; Immediate -- Register, 4 bytes movw %bp, %sp ; Register -- Register, 2 bytes movb (%bp, %rcx), %al ; Memory -- Register, 1 bytes movb $-17, (%rsp) ; Immediate -- Memory, 1 bytes movq %rax, -12(%rbp) ; Register -- Memory, 8 bytes MOVZ ç±»ä¸­æŒ‡ä»¤æŠŠç›®çš„ä¸­å‰©ä½™çš„å­—èŠ‚å¡«å……ä¸º0ã€‚ MOVS ç±»ä¸­çš„æŒ‡ä»¤é€šè¿‡ç¬¦å·æ‰©å±•æ¥å¡«å……ï¼ŒæŠŠæºæ“ä½œçš„æœ€é«˜ä¸ºè¿›è¡Œå¤åˆ¶ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªæ•°æ®ä¼ é€ç¤ºä¾‹: long exchange(long *xp, long y) { long x = *xp; *xp = y; return x; } æ‰§è¡Œå‘½ä»¤ gcc -Og -S main.c ç”Ÿæˆä»¥ä¸‹æ±‡ç¼–å†…å®¹: exchange: movq (%rdi), %rax movq %rsi, (%rdi) ret å¯ä»¥çœ‹å‡º: C è¯­è¨€çš„ â€œæŒ‡é’ˆâ€ å…¶å®å°±æ˜¯åœ°å€ã€‚é—´æ¥å¼•ç”¨æŒ‡é’ˆå°±æ˜¯é—´è¯¥æŒ‡é’ˆæ”¾åœ¨ä¸€ä¸ªå¯„å­˜å™¨ä¸­ï¼Œç„¶åå†å†…å­˜å¼•ç”¨ä¸­ä½¿ç”¨è¿™ä¸ªå¯„å­˜å™¨ã€‚ æœ€åçš„ä¸¤ä¸ªæ•°æ®ä¼ é€æ“ä½œ: å°†æ•°æ®å‹å…¥ç¨‹åºæ ˆä¸­ï¼Œä»ç¨‹åºæ ˆä¸­å¼¹å‡ºæ•°æ®ã€‚ pushq %rbp ; æ ˆæŒ‡é’ˆå‡8ï¼Œç„¶åå°†å€¼å†™åˆ°æ–°çš„æ ˆé¡¶åœ°å€ã€‚ ; ç­‰åŒäº subq $8, %rsp ; Decrement stack pointer movq %rbp, (%rsp) ; Store %rbp on stack æ“ä½œç¤ºæ„å›¾: popq %rbp ; å¼¹å‡ºä¸€ä¸ªå››å­—çš„æ“ä½œåŒ…æ‹¬ä»æ ˆé¡¶ä½ç½®è¯»å‡ºæ•°æ®ï¼Œç„¶åå‡æ ˆæŒ‡é’ˆåŠ 8ã€‚ ; ç­‰åŒäº movq %rsp, (%rax) ; Read %rax from stack addq $8, %rsp ; Increment stack pointer ","date":"2021-12-03","objectID":"/csapp/:2:4","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"3.5 ç®—æœ¯å’Œé€»è¾‘æ“ä½œ æŒ‡ä»¤ç±» ADD ç”±å››æ¡åŠ æ³•æŒ‡ä»¤ç»„æˆ: addb å­—èŠ‚åŠ æ³•ã€addw å­—åŠ æ³•ã€addl åŒå­—åŠ æ³• å’Œ addq å››å­—åŠ æ³•ã€‚ è¿™äº›æ“ä½œè¢«åˆ†æˆå››ç»„: åŠ è½½æœ‰æ•ˆåœ°å€ã€ä¸€å…ƒæ“ä½œã€äºŒå…ƒæ“ä½œå’Œç§»ä½ã€‚ åŠ è½½æœ‰æ•ˆåœ°å€(load effective address)æŒ‡ä»¤ leaq å®é™…ä¸Šæ˜¯ movq æŒ‡ä»¤çš„å˜å½¢ã€‚å®ƒçš„æŒ‡ä»¤å½¢å¼æ˜¯ä»å†…å­˜è¯»æ•°æ®åˆ°å¯„å­˜å™¨ï¼Œä½†å®é™…ä¸Šå®ƒæ ¹æœ¬å°±æ²¡æœ‰å¼•ç”¨å†…å­˜ã€‚ long scale(long x, long y, long z) { long t = x + 4 * y + 12 * z; return t; } å¾—åˆ°æ±‡ç¼–å‘½ä»¤: _scale: ## @scale .cfi_startproc ## %bb.0: pushq %rbp movq %rsp, %rbp leaq (%rdi,%rsi,4), %rax leaq (%rdx,%rdx,2), %rcx leaq (%rax,%rcx,4), %rax popq %rbp retq ä¸€å…ƒæ“ä½œæ•°åªæœ‰ä¸€ä¸ªæ“ä½œæ•°ï¼Œæ—¢æ˜¯æºåˆæ˜¯ç›®çš„ã€‚å¦‚ incq (%rsp)ã€‚ äºŒå…ƒæ“ä½œæ•°ï¼Œç¬¬äºŒä¸ªæ“ä½œæ•°æ—¢æ˜¯æºåˆæ˜¯ç›®çš„ã€‚å¦‚ subq %rax,%rdxã€‚ ç§»ä½æ“ä½œï¼Œå…ˆç»™å‡ºç§»ä½é‡ï¼Œç„¶åç¬¬äºŒé¡¹æ˜¯è¦ç§»ä½ã€‚å¯ä»¥è¿›è¡Œç®—æœ¯å’Œé€»è¾‘å³ç§»ã€‚ä½ç§»é‡å¯ä»¥æ˜¯ä¸€ä¸ªç«‹å³æ•°ï¼Œæˆ–è€…æ”¾åœ¨å•å­—èŠ‚å¯„å­˜å™¨ %cl ä¸­(ç§»ä½æ“ä½œæŒ‡ä»¤åªå…è®¸ä»¥è¿™ä¸ªç‰¹å®šçš„å¯„å­˜å™¨ä½œä¸ºæ“ä½œæ•°)ã€‚ ç‰¹æ®Šçš„ç®—æœ¯æ“ä½œ ä»¥ä¸‹çš„ C ä»£ç : #include \u003cinttypes.h\u003e typedef unsigned __int128 uint128_t; void store_uprod(uint128_t *dest, uint64_t x, uint64_t y) { *dest = x * (uint128_t) y; } void remdiv(long x, long y, long *qp, long *rp) { long q = x / y; long r = x%y; *qp = q; *rp = r; } ç”Ÿæˆæ±‡ç¼– store_uprod: movq %rsp, %rbp movq %rdx, %rax ; Copy x to multiplicand mulq %rsi ; Multiply by y movq %rdx, 8(%rdi) ; Store upper 8 bytes at dest+8 movq %rax, (%rdi) ; Store lower 8 bytes at dest retq remdiv: movq %rsp, %rbp movq %rdx, %r8 ; Copy qp movq %rdi, %rax ; Move x to lower 8 bytes of dividend cqto ; Sign-extend to upper 8 bytes of dividend idivq %rsi ; Divide by y movq %rax, (%r8) ; Store remainder at rp movq %rdx, (%rcx) ; Store quotient at qp retq ","date":"2021-12-03","objectID":"/csapp/:2:5","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"3.6 æ§åˆ¶ CPU è¿˜ç»´æŠ¤ç€ä¸€ç»„å•ä¸ªä½çš„æ¡ä»¶ç  (condition code) å¯„å­˜å™¨ï¼Œå®ƒä»¬æè¿°äº†æœ€è¿‘çš„ç®—æœ¯æˆ–é€»è¾‘æ“ä½œçš„å±æ€§ã€‚å¯ä»¥æ£€æµ‹è¿™äº›å¯„å­˜å™¨æ¥æ‰§è¡Œæ¡ä»¶åˆ†æ”¯æŒ‡ä»¤ã€‚æœ€å¸¸ç”¨çš„æ¡ä»¶ç æœ‰: CF: è¿›ä½æ ‡å¿—ã€‚æœ€è¿‘çš„æ“ä½œä½¿æœ€é«˜ä½äº§ç”Ÿäº†è¿›ä½ã€‚å¯ä»¥æ¥æ£€æŸ¥æ— ç¬¦å·æ“ä½œçš„æº¢å‡ºã€‚ ZF: é›¶æ ‡å¿—ã€‚æœ€è¿‘çš„æ“ä½œå¾—å‡ºçš„ç»“æœä¸º0ã€‚ SF: ç¬¦å·æ ‡å¿—ã€‚æœ€è¿‘çš„æ“ä½œå¾—åˆ°çš„ç»“æœä¸ºè´Ÿæ•°ã€‚ OF: æº¢å‡ºæ ‡å¿—ã€‚æœ€è¿‘çš„æ“ä½œå¯¼è‡´ä¸€ä¸ªè¡¥ç æº¢å‡º â€”â€” æ­£æº¢å‡ºæˆ–è´Ÿæº¢å‡ºã€‚ æ¡ä»¶ç é€šå¸¸ä¸ä¼šç›´æ¥è¯»å–ï¼Œå¸¸ç”¨çš„ä½¿ç”¨æ–¹æ³•æœ‰ä¸‰ç§: å¯ä»¥æ ¹æ®æ¡ä»¶ç çš„æŸç§ç»„åˆï¼Œå°†ä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º 0 æˆ–è€… 1ã€‚ å¯ä»¥æ¡ä»¶è·³è½¬åˆ°ç¨‹åºçš„æŸä¸ªå…¶ä»–éƒ¨åˆ†ã€‚ å¯ä»¥æœ‰æ¡ä»¶åœ°åˆ›é€æ•°æ®ã€‚ SET æŒ‡ä»¤æ˜¯æ ¹æ®æ¡ä»¶ç çš„æŸç§ç»„åˆï¼Œå°†ä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º 0 æˆ–è€… 1çš„ä¸€æ•´ç±»æŒ‡ä»¤ã€‚è¿™äº›æŒ‡ä»¤çš„åç¼€è¡¨ç¤ºä¸åŒçš„æ¡ä»¶è€Œä¸æ˜¯æ“ä½œæ•°çš„å¤§å°ã€‚å¦‚ setl è¡¨ç¤º â€œå°äºæ—¶è®¾ç½® (set less)â€ã€‚ setb è¡¨ç¤º â€œä½äºæ—¶è®¾ç½® (set below)â€ã€‚ ä¸€æ¡ SET æŒ‡ä»¤çš„ç›®çš„æ“ä½œæ•°æ˜¯ä½ä½å•å­—èŠ‚å¯„å­˜å™¨å…ƒç´ ä¹‹ä¸€ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå­—èŠ‚çš„å†…å­˜ä½ç½®ï¼ŒæŒ‡ä»¤ä¼šå°†è¿™ä¸ªå­—èŠ‚è®¾ç½®æˆ 0 æˆ–è€… 1ã€‚ è·³è½¬ (jump) æŒ‡ä»¤ä¼šå¯¼è‡´æ‰§è¡Œåˆ‡æ¢åˆ°ç¨‹åºä¸­ä¸€ä¸ªå…¨æ–°çš„ä½ç½®ã€‚åœ¨æ±‡ç¼–ä»£ç ä¸­ï¼Œè¿™äº›è·³è½¬çš„ç›®çš„åœ°é€šå¸¸ç”¨ä¸€ä¸ªæ ‡å· (label) æŒ‡æ˜ã€‚ movq $0,%rax ; Set %rax to 0 jmp .L1 ; Goto .L1 movq (%rax), %rdx ; Null pointer dereference (skipped) .L1: popq %rdx ; Jump target å®ç°æ¡ä»¶æ“ä½œçš„ä¼ ç»Ÿæ–¹æ³•æ˜¯é€šè¿‡ä½¿ç”¨æ§åˆ¶çš„æ¡ä»¶è½¬ç§»ã€‚å½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œç¨‹åºæ²¿ç€ä¸€æ¡æ‰§è¡Œè·¯å¾„æ‰§è¡Œï¼Œè€Œå½“æ¡ä»¶ä¸æ»¡è¶³æ˜¯ï¼Œå°±èµ°å¦ä¸€æ¡è·¯å¾„ã€‚ä½†è¿™ä¸ªæ–¹æ³•åœ¨ç°ä»£å¤„ç†å™¨ä¸Šå¯èƒ½ä¼šéå¸¸ä½æ•ˆã€‚ å¦ä¸€ç§ç­–ç•¥æ˜¯ä½¿ç”¨æ•°æ®çš„æ¡ä»¶è½¬ç§»ã€‚è¿™ä¸ªæ–¹æ³•è®¡ç®—ä¸€ä¸ªæ¡ä»¶æ“ä½œçš„ä¸¤ç§ç»“æœï¼Œç„¶åå†æ ¹æ®æ¡ä»¶æ˜¯å¦æ»¡è¶³ä»ä¸­é€‰å–ä¸€ä¸ªã€‚ æ±‡ç¼–ä¸­æ²¡æœ‰å¾ªç¯æŒ‡ä»¤å­˜åœ¨ï¼Œå¯ä»¥ç”¨æ¡ä»¶æµ‹è¯•å’Œè·³è½¬ç»„åˆèµ·æ¥å®ç°å¾ªç¯æ•ˆæœã€‚ long fact_do(long n) { long result = 1; do { result *= n; n = n - 1; } while (n \u003e 1); return result; } ç”Ÿæˆæ±‡ç¼–ä»£ç : _fact_do: ## @fact_do pushq %rbp movq %rsp, %rbp movl $1, %eax LBB0_1: ## =\u003eThis Inner Loop Header: Depth=1 imulq %rdi, %rax decq %rdi cmpq $1, %rdi jg LBB0_1 popq %rbp retq switch è¯­å¥å¯ä»¥æ ¹æ®ä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼è¿›è¡Œå¤šé‡åˆ†æ”¯ (multiway branching)ã€‚switch ä¼šè¢«è½¬åŒ–æˆè·³è½¬è¡¨ (jump table)ã€‚è·³è½¬è¡¨ç¤ºä¸€ä¸ªæ•°ç»„ï¼Œè¡¨é¡¹ i æ˜¯ä¸€ä¸ªä»£ç æ®µçš„åœ°å€ï¼Œè¿™ä¸ªä»£ç æ®µå®ç°å½“å¼€å…³ç´¢å¼•å€¼ç­‰äº i æ—¶ç¨‹åºåº”è¯¥é‡‡å–çš„åŠ¨ä½œã€‚ç¨‹åºä»£ç ç”¨å¼€å…³ç´¢å¼•å€¼æ¥æ‰§è¡Œä¸€ä¸ªè·³è½¬è¡¨å†…çš„æ•°ç»„å¼•ç”¨ï¼Œç¡®å®šè·³è½¬æŒ‡ä»¤çš„ç›®æ ‡ã€‚å’Œä½¿ç”¨ä¸€ç»„å¾ˆé•¿çš„ if-else è¯­å¥å¯¹æ¯”ï¼Œä½¿ç”¨è·³è½¬è¡¨çš„ä¼˜ç‚¹æ˜¯æ‰§è¡Œå¼€å…³è¯­å¥çš„æ—¶é—´ä¸å¼€å…³æƒ…å†µçš„æ•°é‡æ— å…³ã€‚ C switch ä»£ç : void switch_eg(long x, long n, long *dest) { long val = x; switch (n) { case 100: val *= 13; break; case 102: val += 10; case 103: val += 11; break; case 104: case 106: val *= val; break; default: val = 0; } *dest = val; } ç”Ÿæˆæ±‡ç¼–: .section __TEXT,__text,regular,pure_instructions .build_version macos, 10, 15, 4 sdk_version 10, 15, 4 .globl _switch_eg ## -- Begin function switch_eg .p2align 4, 0x90 _switch_eg: ## @switch_eg ## %bb.0: pushq %rbp movq %rsp, %rbp xorl %eax, %eax addq $-100, %rsi cmpq $6, %rsi ja LBB0_7 ## %bb.1: leaq LJTI0_0(%rip), %rcx movslq (%rcx,%rsi,4), %rsi addq %rcx, %rsi jmpq *%rsi LBB0_5: imulq %rdi, %rdi jmp LBB0_6 LBB0_2: leaq (%rdi,%rdi,2), %rax leaq (%rdi,%rax,4), %rax jmp LBB0_7 LBB0_3: addq $10, %rdi LBB0_4: addq $11, %rdi LBB0_6: movq %rdi, %rax LBB0_7: movq %rax, (%rdx) popq %rbp retq ","date":"2021-12-03","objectID":"/csapp/:2:6","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"3.7 è¿‡ç¨‹ è¿‡ç¨‹æ˜¯è½¯ä»¶ä¸­ä¸€ç§å¾ˆé‡è¦çš„æŠ½è±¡ã€‚å®ƒæä¾›äº†ä¸€ç§å°è£…ä»£ç çš„æ–¹å¼ï¼Œç”¨ä¸€ç»„æŒ‡å®šçš„å‚æ•°å’Œä¸€ä¸ªå¯é€‰çš„è¿”å›å€¼å®ç°äº†æŸç§åŠŸèƒ½ã€‚ç„¶åï¼Œå¯ä»¥åœ¨ç¨‹åºä¸­ä¸åŒçš„åœ°æ–¹è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚è®¾è®¡è‰¯å¥½çš„å¦‚è½¯ä»¶ç”¨è¿‡ç¨‹ä½œä¸ºæŠ½è±¡æœºåˆ¶ï¼Œéšè—æŸä¸ªè¡Œä¸ºçš„å…·ä½“å®ç°ï¼ŒåŒæ—¶åˆæä¾›æ¸…æ™°ç®€æ´çš„æ¥å£å®šä¹‰ï¼Œè¯´æ˜è¦è®¡ç®—çš„æ˜¯å“ªäº›å€¼ï¼Œè¿‡ç¨‹ä¼šå¯¹ç¨‹åºçŠ¶æ€äº§ç”Ÿè¯´æ˜æ ·çš„å½±å“ã€‚ ä¸åŒç¼–ç¨‹è¯­è¨€ä¸­ï¼Œè¿‡ç¨‹çš„å½¢å¼: å‡½æ•° (function) æ–¹æ³• (method) å­ä¾‹ç¨‹ (subroutine) å¤„ç†å‡½æ•° (handler) å‡è®¾è¿‡ç¨‹ P è°ƒç”¨è¿‡ç¨‹ Qï¼ŒQ æ‰§è¡Œåè¿”å› Pã€‚è¿‡ç¨‹å¯èƒ½ç”¨åˆ°çš„ä¸€ä¸ªæˆ–å¤šä¸ªæœºåˆ¶: ä¼ é€’æ§åˆ¶ã€‚åœ¨è¿›å…¥è¿‡ç¨‹ Q çš„æ—¶å€™ï¼Œç¨‹åºè®¡æ•°å™¨å¿…é¡»è¢«è®¾ç½®ä¸º Q çš„ä»£ç çš„èµ·å§‹åœ°å€ï¼Œç„¶åå†è¿”å›æ—¶ï¼Œè¦æŠŠç¨‹åºè®¡æ•°å™¨è®¾ç½®ä¸º P ä¸­è°ƒç”¨ Q åé¢é‚£æ¡æŒ‡ä»¤çš„åœ°å€ã€‚ ä¼ é€’æ•°æ®ã€‚P å¿…é¡»èƒ½å¤Ÿå‘ Q æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ï¼ŒQ å¿…é¡»èƒ½å¤Ÿå‘ P è¿”å›ä¸€ä¸ªå€¼ã€‚ åˆ†é…å’Œé‡Šæ”¾å†…å­˜ã€‚åœ¨å¼€å§‹æ˜¯ï¼ŒQ å¯èƒ½éœ€è¦ä¸ºå±€éƒ¨å˜é‡åˆ†é…ç©ºé—´ï¼Œè€Œåœ¨è¿”å›å‰ï¼Œåˆå¿…é¡»é‡Šæ”¾è¿™äº›å­˜å‚¨ç©ºé—´ã€‚ 3.7.1 ä¼ é€’æ§åˆ¶ C è¯­è¨€è¿‡ç¨‹è°ƒç”¨ä¸­ä½¿ç”¨æ ˆæ•°æ®ç»“æ„æä¾›çš„åè¿›å…ˆå‡ºçš„å†…å­˜ç®¡ç†åŸåˆ™ã€‚ ç¨‹åºå¯ä»¥ç”¨æ ˆæ¥ç®¡ç†å®ƒçš„è¿‡ç¨‹æ‰€éœ€è¦çš„å­˜å‚¨ç©ºé—´ï¼Œæ ˆå’Œç¨‹åºå¯„å­˜å™¨å­˜æ”¾è¿™ä¼ é€’æ§åˆ¶å’Œæ•°æ®ã€åˆ†é…å†…å­˜æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚å½“ P è°ƒç”¨ Q æ—¶ï¼Œæ§åˆ¶å’Œæ•°æ®ä¿¡æ¯æ·»åŠ åˆ°æ ˆå°¾ã€‚å½“ P è¿”å›æ—¶ï¼Œè¿™äº›ä¿¡æ¯ä¼šé‡Šæ”¾æ‰ã€‚ å½“ x86-64 è¿‡ç¨‹éœ€è¦çš„å­˜å‚¨ç©ºé—´è¶…å‡ºå¯„å­˜å™¨èƒ½å¤Ÿå­˜æ”¾çš„å¤§å°æ—¶ï¼Œå°±ä¼šåœ¨æ ˆä¸Šåˆ†é…ç©ºé—´ã€‚è¿™ä¸ªéƒ¨åˆ†ç§°ä¸ºè¿‡ç¨‹çš„æ ˆå¸§(stack frame)ã€‚å½“å‰æ­£åœ¨æ‰§è¡Œçš„è¿‡ç¨‹çš„å¸§æ€»æ˜¯åœ¨æ ˆé¡¶ã€‚ 3.7.2 è½¬ç§»æ§åˆ¶ å°†æ§åˆ¶ä»å‡½æ•° P è½¬ç§»åˆ°å‡½æ•° Q åªéœ€è¦ç®€å•åœ°æŠŠç¨‹åºè®¡æ•°å™¨(PC)è®¾ç½®ä¸º Q çš„ä»£ç çš„èµ·å§‹ä½ç½®ã€‚ä¸è¿‡ï¼Œå½“ç¨åä» Q è¿”å›çš„æ—¶å€™ï¼Œå¤„ç†å™¨å¿…é¡»è®°å½•å¥½éœ€è¦ç»§ç»­ P çš„æ‰§è¡Œçš„ä»£ç ä½ç½®ã€‚åœ¨ x86-64 æœºå™¨ä¸­ï¼Œè¿™ä¸ªä¿¡æ¯æ˜¯ç”¨æŒ‡ä»¤ call Q è°ƒç”¨è¿‡ç¨‹ Q æ¥è®°å½•çš„ã€‚è¯¥æŒ‡ä»¤ä¼šæŠŠåœ°å€ A å‹å…¥æ ˆä¸­ï¼Œå¹¶å°† PC è®¾ç½®ä¸º Q çš„èµ·å§‹åœ°å€ã€‚å‹å…¥çš„åœ°å€ A è¢«ç§°ä¸ºè¿”å›åœ°å€ï¼Œæ˜¯ç´§è·Ÿåœ¨ call æŒ‡ä»¤åé¢çš„é‚£æ¡æŒ‡ä»¤çš„åœ°å€ã€‚å¯¹åº”çš„æŒ‡ä»¤ ret ä¼šä»æ ˆä¸­å¼¹å‡ºåœ°å€ Aï¼Œå¹¶æŠŠ PC è®¾ç½®ä¸º Aã€‚ call æŒ‡ä»¤æœ‰ä¸€ä¸ªç›®æ ‡ï¼Œå³æŒ‡æ˜è¢«è°ƒç”¨è¿‡ç¨‹èµ·å§‹çš„æŒ‡ä»¤åœ°å€ã€‚åŒè°ƒæ•´ä¸€æ ·ï¼Œè°ƒç”¨å¯èƒ½æ˜¯ç›´æ¥çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯é—´æ¥çš„ã€‚åœ¨æ±‡ç¼–ä»£ç ä¸­ï¼Œç›´æ¥è°ƒç”¨çš„ç›®æ ‡æ˜¯ä¸€ä¸ªæ ‡å·ï¼Œè€Œé—´æ¥è°ƒç”¨çš„ç›®æ ‡æ˜¯ * åé¢è·Ÿè®´æ­Œæ“ä½œæ•°æŒ‡ç¤ºç¬¦ã€‚ 3.7.3 æ•°æ®åˆ›é€ æ•°æ®ä¼ é€: å½“è°ƒç”¨ä¸€ä¸ªè¿‡ç¨‹æ—¶ï¼Œé™¤äº†è¦æŠŠæ§åˆ¶ä¼ é€’ç»™å®ƒå¹¶åœ¨è¿‡ç¨‹è¿”å›æ—¶å†ä¼ é€’å›æ¥ä¹‹å¤–ï¼Œè¿‡ç¨‹è°ƒç”¨è¿˜å¯èƒ½åŒ…æ‹¬å§æ•°æ®ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œè€Œä»è¿‡ç¨‹è¿”å›è¿˜æœ‰å¯èƒ½åŒ…æ‹¬è¿”å›ä¸€ä¸ªå€¼ã€‚ x86-64ä¸­ï¼Œå¯èƒ½é€šè¿‡å¯„å­˜å™¨æœ€å¤šä¼ é€’ 6 ä¸ªæ•´å‹(ä¾‹å¦‚æ•´æ•°å’ŒæŒ‡é’ˆ)å‚æ•°ã€‚å¯„å­˜å™¨çš„ä½¿ç”¨æ˜¯ç”±ç‰¹æ®Šé¡ºåºçš„ï¼Œå¯„å­˜å™¨ä½¿ç”¨çš„åå­—å–å†³äºè¦ä¼ é€’çš„æ•°æ®ç±»å‹çš„å¤§å°ã€‚ å¦‚æœä¸€ä¸ªå‡½æ•°æœ‰å¤§äº 6 ä¸ªæ•´å‹å‚æ•°ï¼Œè¶…å‡º 6 ä¸ªçš„éƒ¨åˆ†å°±è¦é€šè¿‡æ ˆæ¥ä¼ é€’ã€‚ void proc(long a1, long *a1p, int a2, int *a2p, short a3, short *a3p, char a4, char *a4p) { *a1p += a1; *a2p += a2; *a3p += a3; *a4p += a4; } 3.7.4 æ ˆä¸Šçš„å±€éƒ¨å­˜å‚¨ éœ€è¦æ ˆä¸Šå±€éƒ¨å­˜å‚¨çš„æƒ…å†µ: å¯„å­˜å™¨ä¸èƒ½è¶³å¤Ÿå­˜æ”¾ç´ æœ‰çš„æœ¬åœ°æ•°æ®ã€‚ å¯¹ä¸€ä¸ªå±€éƒ¨å˜é‡ä½¿ç”¨åœ°å€è¿ç®—ç¬¦ â€˜\u0026â€™, å› æ­¤å¿…é¡»èƒ½å¤Ÿä¸ºä»–äº§ç”Ÿä¸€ä¸ªåœ°å€ã€‚ æŸäº›å±€éƒ¨å˜é‡æ˜¯æ•°ç»„æˆ–ç»“æ„ï¼Œå› æ­¤å¿…é¡»èƒ½å¤Ÿé€šè¿‡æ•°æ®æˆ–ç»“æ„å¼•ç”¨è¢«è®¿é—®åˆ°ã€‚ long call_proc() { long x1 = 1; int x2 = 2; short x3 = 3; char x4 = 4; proc(x1, \u0026x1, x2, \u0026x2, x3, \u0026x3, x4, \u0026x4); // åˆ›å»ºæ ˆå¸§ return (x1 + x2) * (x3 - x4); } 3.7.5 å¯„å­˜å™¨ä¸­çš„å±€éƒ¨å­˜å‚¨ç©ºé—´ å¯„å­˜å™¨ç»„æ˜¯å”¯ä¸€è¢«æ‰€æœ‰è¿‡ç¨‹å…±äº«çš„èµ„æºï¼Œä¸ºäº†é˜²æ­¢å¯„å­˜å™¨çš„å€¼åœ¨è¢«ä¸€ä¸ªè¿‡ç¨‹ä½¿ç”¨æ—¶ï¼Œä¸è¢«å…¶ä»–è¿‡ç¨‹è°ƒç”¨å¯¼è‡´å€¼è¢«è¦†ç›–ï¼Œx86-64 é‡‡ç”¨ä¸€ç»„ç»Ÿä¸€çš„å¯„å­˜å™¨ä½¿ç”¨æƒ¯ä¾‹: å¯„å­˜å™¨ %rbxã€%rbp å’Œ %r12~%r15 è¢«åˆ’åˆ†ä¸ºè¢«è°ƒç”¨è€…å¯„å­˜å™¨ï¼ŒQ è¿‡ç¨‹å¿…é¡»ä¿è¯å¯„å­˜å™¨å€¼çš„å®‰å…¨ã€‚ é™¤äº†æ ˆæŒ‡é’ˆ %rsp, éƒ½åˆ†ç±»ä¸ºè°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ã€‚ 3.7.6 é€’å½’è¿‡ç¨‹ é€’å½’è°ƒç”¨ä¸€ä¸ªå‡½æ•°æœ¬èº«ä¸è°ƒç”¨å…¶ä»–å‡½æ•°æ—¶ä¸€æ ·çš„ã€‚æ ˆè§„åˆ™æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨éƒ½æœ‰å®ƒè‡ªå·±ç§æœ‰çš„çŠ¶æ€ä¿¡æ¯(ä¿å­˜çš„è¿”å›ä½ç½®å’Œè¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨çš„å€¼)å­˜å‚¨ç©ºé—´ã€‚å¦‚æœéœ€è¦ï¼Œå®ƒè¿˜å¯ä»¥æä¾›å±€éƒ¨å˜é‡çš„å­˜å‚¨ã€‚æ ˆåˆ†é…å’Œé‡Šæ”¾çš„è§„åˆ™å¾ˆè‡ªç„¶å°±ä¸å‡½æ•°è°ƒç”¨-è¿”å›çš„å¾ªåºåŒ¹é…ã€‚è¿™ç§å®ç°å‡½æ•°è°ƒç”¨å’Œè¿”å›çš„æ–¹æ³•ç”šè‡³å¯¹æ›´å¤æ‚çš„æƒ…å†µä¹Ÿé€‚ç”¨ï¼Œæš´æ‰£äº’ç›¸é€’å½’è°ƒç”¨ã€‚ long rfact(long n) { long result; if (n \u003c= 1) { result = 1; } else { result = n * rfact(n - 1); } return result; } å¯¹åº”æ±‡ç¼–ä»£ç : rfact: pushq %rbx movq %rdi, rbx movl $1, %eax cmpq $1, %rdi jle .L35 leaq -1(%rdi), %rdi call rfact imulq %rbx, %rax .L35: popq %rbx ret ","date":"2021-12-03","objectID":"/csapp/:2:7","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"3.8 æ•°ç»„åˆ†é…å’Œè®¿é—® C è¯­è¨€çš„æ•°ç»„æ˜¯ä¸€ç§å°†æ ‡é‡æ•°æ®èšé›†æˆæ›´å¤§æ•°æ®ç±»å‹çš„æ–¹å¼ã€‚ 3.8.1 åŸºæœ¬åŸåˆ™ å¯¹äºæ•°æ®ç±»å‹ T å’Œæ•´å‹å¸¸æ•° Nï¼Œå£°æ˜å¦‚ä¸‹: T A[N]; èµ·å§‹ä½ç½®è¡¨ç¤ºä¸º $x_A$ã€‚è¿™ä¸ªå£°æ˜æœ‰ä¸¤ä¸ªæ•ˆæœã€‚é¦–å…ˆï¼Œå®ƒåœ¨å†…å­˜ä¸­åˆ†é…ä¸€ä¸ª LÂ·N å­—èŠ‚çš„è¿ç»­åŒºåŸŸã€‚è¿™é‡Œ L æ˜¯æ•°æ®ç±»å‹ T çš„å¤§å°(å•ä½ä¸ºå­—èŠ‚)ã€‚å…¶æ¬¡ï¼Œå®ƒå¼•å…¥äº†æ ‡è¯†ç¬¦ Aï¼Œå¯ä»¥ç”¨ A æ¥ä½œä¸ºæŒ‡å‘æ•°ç»„å¼€å¤´çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆçš„å€¼å°±æ˜¯ $x_A$ã€‚å¯ç”¨ç”¨ 0~N-1 çš„è¯ä¹¦ç´¢å¼•æ¥è®¿é—®è¯¥æ•°ç»„å…ƒç´ ã€‚æ•°ç»„å…ƒç´  i ä¼šè¢«å­˜æ”¾åœ¨åœ°å€ä¸º $x_A$+LÂ·i çš„åœ°æ–¹ã€‚ 3.8.2 æŒ‡é’ˆè¿ç®— C è¯­è¨€å…è®¸å¯¹æŒ‡é’ˆè¿›è¡Œè¿ç®—ï¼Œè€Œè®¡ç®—å‡ºæ¥çš„å€¼ä¼šæ ¹æ®è¯¥æŒ‡é’ˆå¼•ç”¨çš„æ•°æ®ç±»å‹çš„å¤§å°è¿›è¡Œä¼¸ç¼©ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ p æ˜¯ä¸€ä¸ªæŒ‡å‘ç±»å‹ä¸º T çš„æ•°æ®çš„æŒ‡é’ˆï¼Œp çš„å€¼ä¸º $x_p$ï¼Œé‚£ä¹ˆè¡¨è¾¾å¼ p+i çš„å€¼ä¸º $x_p$+LÂ·iï¼Œè¿™é‡Œ L æ˜¯æ•°æ®ç±»å‹ T çš„å¤§å°ã€‚ å•æ“ä½œæ•°æ“ä½œç¬¦ â€˜$â€™ å’Œ â€˜* ' å¯ä»¥äº§ç”ŸæŒ‡é’ˆå’Œé—´æ¥å¼•ç”¨æŒ‡é’ˆã€‚å¯¹äºä¸€ä¸ªè¡¨ç¤ºæŸä¸ªå¯¹è±¡çš„è¡¨è¾¾å¼ Exprï¼Œ\u0026Expr æ˜¯è¯¥å¯¹è±¡çš„ä¸€ä¸ªæŒ‡é’ˆã€‚å¯¹äºä¸€ä¸ªè¡¨ç¤ºåœ°å€çš„è¡¨è¾¾å¼ AExpr, *AExpr æ˜¯è¯¥åœ°å€çš„å€¼ã€‚å› æ­¤ï¼Œè¡¨è¾¾å¼ Expr ä¸ * \u0026Expr æ˜¯ç­‰ä»·çš„ã€‚å¯ä»¥å¯¹æ•°ç»„å’ŒæŒ‡é’ˆåº”ç”¨æ•°ç»„ä¸‹æ ‡æ“ä½œã€‚ 3.8.3 åµŒå¥—æ•°ç»„ è¦è®¿é—®å¤šç»´æ•°ç»„çš„å…ƒç´ ï¼Œç¼–è¯‘å™¨ä¼šä»¥æ•°ç»„èµ·å§‹ä¸ºåŸºåœ°å€ï¼Œåç§»é‡ä¸ºç´¢å¼•ï¼Œäº§ç”Ÿè®¡ç®—æœŸæœ›çš„å…ƒç´ åç§»é‡ï¼Œç„¶åä½¿ç”¨æŸç§ MOV æŒ‡ä»¤ã€‚ é€šå¸¸æ¥è¯´ï¼Œå¯¹äºä¸€ä¸ªå£°æ˜å¦‚ä¸‹çš„æ•°ç»„: T D[R][C] çš„å…ƒç´  D[i][j] çš„å†…å­˜åœ°å€ä¸º $$ D[i][j] = x_D+L(CÂ·i+j) $$ 3.8.4 å®šé•¿æ•°ç»„ Cè¯­è¨€ç¼–è¯‘å™¨èƒ½å¤Ÿä¼˜åŒ–å®šé•¿å¤šç»´æ•°ç»„ä¸Šçš„æ“ä½œä»£ç  ","date":"2021-12-03","objectID":"/csapp/:2:8","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"3.9 å¼‚è´¨çš„æ•°æ®ç»“æ„ C è¯­è¨€2æä¾›äº†ä¸¤ç§å°†ä¸åŒç±»å‹çš„å¯¹è±¡ç»„åˆåˆ°ä¸€èµ·åˆ›å»ºæ•°æ®ç±»å‹çš„æœºåˆ¶: ç»“æ„ (structure)ï¼Œå…³é”®å­— structï¼Œå°†å¤šä¸ªå¯¹è±¡é›†åˆåˆ°ä¸€ä¸ªå•ä½ä¸­ã€‚ è”åˆ (union)ï¼Œç”¨å…³é”®å­— union æ¥å£°æ˜ï¼Œå…è®¸ç”¨å‡ ç§ä¸åŒçš„ç±»å‹æ¥å¼•ç”¨ä¸€ä¸ªå¯¹è±¡ã€‚ 3.9.1 ç»“æ„ C è¯­è¨€çš„ struct å£°æ˜åˆ›å»ºä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œå°†å¯èƒ½ä¸åŒç±»å‹çš„å¯¹è±¡èšåˆåˆ°ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚ç”¨åå­—æ¥å¼•ç”¨ç»“æ„çš„å„ä¸ªç»„æˆéƒ¨åˆ†ã€‚ç±»ä¼¼äºæ•°ç»„çš„å®ç°ï¼Œç»“æ„çš„æ‰€æœ‰ç»„æˆéƒ¨åˆ†éƒ½å­˜æ”¾åœ¨å†…å­˜ä¸­ä¸€æ®µè¿ç»­çš„åŒºåŸŸå†…ï¼Œè€ŒæŒ‡å‘ç»“æ„çš„æŒ‡é’ˆå°±æ˜¯ç»“æ„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€ã€‚ struct rect { int i; int j; int a[2]; int *p; }; è¯¥ç»“æ„åœ¨å†…å­˜ä¸­çš„å¸ƒå±€: 3.9.2 è”åˆ è”åˆæä¾›äº†ä¸€ç§æ–¹å¼ï¼Œèƒ½å¤Ÿè§„é¿ C è¯­è¨€çš„ç±»å‹ç³»ç»Ÿï¼Œå…è®¸ä»¥å¤šç§ç±»å‹æ¥å¼•ç”¨ä¸€ä¸ªå¯¹è±¡ã€‚ä¸€ä¸ªè”åˆçš„æ€»çš„å¤§å°ç­‰äºå®ƒæœ€å¤§å­—æ®µçš„å¤§å°ã€‚ åœ¨ä¸€äº›ä¸Šä¸‹æ–‡ä¸­ï¼Œè”åˆååˆ†æœ‰ç”¨ã€‚ä½†æ˜¯ï¼Œå®ƒä¹Ÿèƒ½å¼•èµ·ä¸€äº›è®¨åŒçš„é”™è¯¯ï¼Œå› ä¸ºä»–ä»¬ç»•è¿‡äº† C è¯­è¨€ç±»å‹ç³»ç»Ÿæä¾›çš„å®‰å…¨æªæ–½ã€‚ä¸€ç§åº”ç”¨æƒ…å†µæ˜¯ï¼Œæˆ‘ä»¬äº‹å…ˆçŸ¥é“å¯¹ä¸€ä¸ªæ•°æ®ç»“æ„ä¸­çš„ä¸¤ä¸ªä¸åŒå­—æ®µçš„ä½¿ç”¨æ˜¯äº’æ–¥çš„ï¼Œé‚£ä¹ˆå°†è¿™ä¸¤ä¸ªå­—æ®µå£°æ˜ä¸ºè”åˆçš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯ç»“æ„çš„ä¸€éƒ¨åˆ†ï¼Œä¼šå‡å°åˆ†é…ç©ºé—´çš„æ€»é‡ã€‚ 3.9.3 æ•°æ®å¯¹é½ è®¸å¤šè®¡ç®—æœºç³»ç»Ÿå¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„åˆæ³•åœ°å€åšå‡ºäº†ä¸€äº›é™åˆ¶ï¼Œè¦æ±‚æŸç§ç±»å‹å¯¹è±¡çš„åœ°å€å¿…é¡»æ˜¯æŸä¸ªå€¼ K (é€šå¸¸æ˜¯2ã€4æˆ–8)çš„å€æ•°ã€‚è¿™ç§å¯¹é½é™åˆ¶ç®€åŒ–äº†å½¢æˆå¤„ç†å™¨å’Œå†…å­˜ç³»ç»Ÿä¹‹é—´æ¥å£çš„ç¡¬ä»¶è®¾è®¡ã€‚ æ— è®ºæ•°æ®æ˜¯å¦å¯¹é½ï¼Œx86-64 ç¡¬ä»¶éƒ½èƒ½æ­£ç¡®å·¥ä½œã€‚ä¸è¿‡ï¼ŒIntel è¿˜æ˜¯å»ºè®®è¦å¯¹é½æ•°æ®ä»¥æé«˜å†…å­˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚å¯¹é½åŸåˆ™æ˜¯ä»»ä½• K å­—èŠ‚çš„åŸºæœ¬å¯¹è±¡çš„åœ°å€å¿…é¡»æ˜¯ K çš„å€æ•°ã€‚ ç¡®ä¿æ¯ç§æ•°æ®ç±»å‹éƒ½æ˜¯æŒ‰ç…§æŒ‡å®šæ–¹å¼æ¥ç»„ç»‡å’Œåˆ†é…ï¼Œå³æ¯ç§ç±»å‹çš„å¯¹è±¡éƒ½æ»¡è¶³å®ƒçš„å¯¹é½é™åˆ¶ï¼Œå°±å¯ä¿è¯å®æ–½å¯¹é½ã€‚ç¼–è¯‘å™¨åœ¨æ±‡ç¼–ä»£ç ä¸­æ”¾å…¥å‘½ä»¤ï¼ŒæŒ‡æ˜å…¨å±€æ•°æ®æ‰€éœ€çš„å¯¹é½ã€‚ .align 8 è¿™å‘½ä»¤å°±ä¿è¯äº†å®ƒåé¢çš„æ•°æ®çš„å¼€å§‹åœ°å€æ˜¯ 8 çš„å€æ•°ã€‚å› ä¸ºæ¯ä¸ªè¡¨é¡¹é•¿ 8 ä¸ªå­—èŠ‚ï¼Œåé¢çš„å…ƒç´ éƒ½ä¼šéµå®ˆ 8 å­—èŠ‚å¯¹é½çš„é™åˆ¶ã€‚ å¯¹äºåŒ…å«ç»“æ„çš„ä»£ç ï¼Œç¼–è¯‘å™¨å¯èƒ½éœ€è¦åœ¨å­—æ®µçš„åˆ†é…ä¸­æ’å…¥é—´éš™ï¼Œä»¥ä¿è¯æ¯ä¸ªç»“æ„å…ƒç´ éƒ½æ»¡è¶³å®ƒçš„å¯¹é½è¦æ±‚ã€‚è€Œç»“æ„æœ¬èº«å¯¹å®ƒçš„èµ·å§‹åœ°å€ä¹Ÿæœ‰ä¸€äº›å¯¹é½è¦æ±‚ã€‚ å‡è®¾å¦‚ä¸‹çš„ç»“æ„å£°æ˜: struct S1 { int i; char c; int j; } å¦‚æœç¼–è¯‘å™¨ç”¨æœ€å°çš„9å­—èŠ‚åˆ†é…ï¼Œå†…å­˜å¸ƒå±€ä¼šæ˜¯è¿™æ ·: ä½†æ˜¯å®ƒä¸æ»¡è¶³å­—æ®µ i å’Œ j çš„4å­—èŠ‚å¯¹é½è¦æ±‚ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨åœ¨å­—æ®µ c å’Œ j ä¹‹é—´æ’å…¥ä¸€ä¸ª 3 å­—èŠ‚çš„é—´éš™: ","date":"2021-12-03","objectID":"/csapp/:2:9","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"3.10 åœ¨æœºå™¨çº§ç¨‹åºä¸­å°†æ§åˆ¶ä¸æ•°æ®ç»“åˆèµ·æ¥ 3.10.1 ç†è§£æŒ‡é’ˆ ä¸€äº›æŒ‡é’ˆå’Œå®ƒä»¬æ˜ å°„åˆ°æœºå™¨ä»£ç çš„å…³é”®åŸåˆ™: æ¯ä¸ªæŒ‡é’ˆéƒ½å¯¹åº”ä¸€ä¸ªç±»å‹ã€‚è¿™ä¸ªç±»å‹è¡¨æ˜è¯¥æŒ‡é’ˆæŒ‡å‘çš„æ˜¯å“ªä¸€ç±»å¯¹è±¡ã€‚ æ¯ä¸ªæŒ‡é’ˆéƒ½æœ‰ä¸€ä¸ªå€¼ã€‚è¿™ä¸ªå€¼æ˜¯æŸä¸ªæŒ‡å®šç±»å‹çš„å¯¹è±¡çš„åœ°å€ã€‚ç‰¹æ®Šçš„ NULL(0) å€¼è¡¨ç¤ºè¯¥æŒ‡é’ˆæ²¡æœ‰æŒ‡å‘ä»»ä½•åœ°æ–¹ã€‚ æŒ‡é’ˆç”¨ â€˜\u0026â€™ è¿ç®—ç¬¦åˆ›å»ºã€‚ *æ“ä½œç¬¦ç”¨äºé—´æ¥å¼•ç”¨æŒ‡é’ˆã€‚å…¶ç»“æœæ˜¯ä¸€ä¸ªå€¼ï¼Œå®ƒçš„ç±»å‹ä¸è¯¥æŒ‡é’ˆçš„ç±»å‹ä¸€è‡´ã€‚é—´æ¥å¼•ç”¨æ˜¯ç”¨å†…å­˜æ¥å®ç°çš„ï¼Œè¦ä¹ˆæ˜¯å­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„åœ°å€ï¼Œè¦ä¹ˆæ˜¯ä»æŒ‡å®šçš„åœ°å€è¯»å–ã€‚ æ•°ç»„ä¸æŒ‡é’ˆç´§å¯†è”ç³»ã€‚ä¸€ä¸ªæ•°ç»„çš„åå­—å¯ä»¥åƒä¸€ä¸ªæŒ‡é’ˆå˜é‡ä¸€æ ·å¼•ç”¨(ä½†æ˜¯ä¸èƒ½ä¿®æ”¹)ã€‚ å°†æŒ‡é’ˆä»ä¸€ç§ç±»å‹å¼ºåˆ¶è½¬åŒ–æˆå¦ä¸€ä¸ªç±»å‹ï¼Œåªæ”¹å˜å®ƒçš„ç±»å‹ï¼Œè€Œä¸æ”¹å˜å®ƒçš„å€¼ã€‚å¼ºåˆ¶ç±»å‹è½¬æ¢çš„ä¸€ä¸ªæ•ˆæœæ˜¯æ”¹å˜æŒ‡é’ˆè¿ç®—çš„ä¼¸ç¼©ã€‚ æŒ‡é’ˆä¹Ÿå¯ä»¥æŒ‡å‘å‡½æ•°ã€‚è¿™æä¾›äº†ä¸€ä¸ªå¾ˆå¼ºå¤§çš„å­˜å‚¨å’Œå‘ä»£ç ä¼ é€’å¼•ç”¨çš„åŠŸèƒ½ï¼Œè¿™ä¸ªå¼•ç”¨å¯ä»¥è¢«ç¨‹åºçš„æŸä¸ªå…¶ä»–éƒ¨åˆ†è°ƒç”¨ã€‚ å‡½æ•°æŒ‡é’ˆ: #include \u003cstdio.h\u003e int fun(int x, int *p); int (*fp)(int, int *); int main() { fp = fun; int y = 1; int result = fp(3, \u0026y); printf(\"%d\\n\", result); } int fun(int x, int *p) { *p += x; return *p; } ","date":"2021-12-03","objectID":"/csapp/:2:10","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"},{"categories":null,"content":"3.11 æµ®ç‚¹ä»£ç  å¤„ç†å™¨çš„æµ®ç‚¹ç³»ç»Ÿç»“æ„åŒ…æ‹¬å¤šä¸ªæ–¹é¢ï¼Œä¼šå½±å“å¯¹æµ®ç‚¹æ•°æ®æ“ä½œçš„ç¨‹åºå¦‚ä½•è¢«æ˜ å°„åˆ°æœºå™¨ä¸Šï¼ŒåŒ…æ‹¬: å¦‚ä½•å­˜å‚¨å’Œè®¿é—®æµ®ç‚¹æ•°æ®ã€‚é€šå¸¸æ˜¯é€šè¿‡æŸç§å¯„å­˜å™¨æ–¹å¼æ¥å®Œæˆã€‚ å¯¹æµ®ç‚¹æ•°æ®æ“ä½œçš„æŒ‡ä»¤ã€‚ å‘å‡½æ•°ä¼ é€’æµ®ç‚¹æ•°å‚æ•°å’Œä»å‡½æ•°è¿”å›æµ®ç‚¹æ•°ç»“æ„çš„è§„åˆ™ã€‚ å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­ä¿å­˜å¯„å­˜å™¨çš„è§„åˆ™ã€‚ x86-64 æµ®ç‚¹ä½“ç³»ç»“æ„çš„å†å²: å¦‚å›¾æ‰€ç¤ºï¼ŒAVX æµ®ç‚¹ä½“ç³»ç»“æ„å…è®¸æ•°æ®å­˜å‚¨åœ¨ 16 ä¸ª YMM å¯„å­˜å™¨ä¸­ï¼Œåå­—æ˜¯ %ymm0~%ymm15ã€‚æ¯ä¸ª YMM å¯„å­˜å™¨éƒ½æ˜¯ 256(32 å­—èŠ‚)ã€‚å½“å¯¹æ ‡é‡æ•°æ®æ“ä½œæ—¶ï¼Œè¿™äº›å¯„å­˜å™¨å€¼ä¿å­˜æµ®ç‚¹æ•°ï¼Œè€Œä¸”åªä½¿ç”¨ä½ 32 ä½(å¯¹äº float) æˆ– 64 ä½(å¯¹äº double)ã€‚æ±‡ç¼–ä»£ç ç”¨å¯„å­˜å™¨çš„ SSE XMM å¯„å­˜å™¨åå­— %xmm0~%xmm15 æ¥å¼•ç”¨å®ƒä»¬ï¼Œæ¯ä¸ª XMM å¯„å­˜å™¨éƒ½æ˜¯å¯¹åº”çš„ YMM å¯„å­˜å™¨çš„ä½ 128 ä½(16å­—èŠ‚)ã€‚ 3.11.1 æµ®ç‚¹ä¼ é€å’Œè½¬åŒ–æ“ä½œ GCC åªç”¨æ ‡é‡ä¼ é€æ“ä½œä»å†…å­˜ä¼ é€æ•°æ®åˆ° XMM å¯„å­˜å™¨æˆ–ä» XMM å¯„å­˜å™¨ä¼ é€æ•°æ®åˆ°å†…å­˜ã€‚å¯¹äºåœ¨ä¸¤ä¸ª XMM å¯„å­˜å™¨ä¹‹é—´ä¼ é€æ•°æ®ï¼ŒGCC ä¼šä½¿ç”¨ä¸¤ç§æŒ‡ä»¤ä¹‹ä¸€ï¼Œå³ç”¨ vmpovaps ä¼ é€å•ç²¾åº¦æ•°ï¼Œç”¨ vmovapd ä¼ é€åŒç²¾åº¦æ•°ã€‚å¯¹äºè¿™äº›æƒ…å†µï¼Œç¨‹åºå¤åˆ¶æ•´ä¸ªå¯„å­˜å™¨è¿˜æ˜¯åªå¤åˆ¶ä½ä½å€¼ã€‚æ—¢ä¸ä¼šå½±å“ç¨‹åºåŠŸèƒ½ï¼Œä¹Ÿä¸ä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ï¼Œæ‰€ä»¥ä½¿ç”¨è¿™äº›æŒ‡ä»¤è¿˜æ˜¯é’ˆå¯¹æ ‡é‡æ•°æ®çš„äººæŒ‡ä»¤æ²¡æœ‰å®è´¨ä¸Šçš„å·®åˆ«ã€‚æŒ‡ä»¤åå­—ä¸­çš„å­—æ¯ â€˜aâ€™ è¡¨ç¤º â€œaligned(å¯¹é½çš„)\"ã€‚å½“ç”¨äºè¯»å†™å†…å­˜æ˜¯ï¼Œå¦‚æœåœ°å€ä¸æ»¡è¶³16å­—èŠ‚å¯¹é½ï¼Œå®ƒä»¬ä¼šå¯¼è‡´å¼‚å¸¸ã€‚åœ¨ä¸¤ä¸ªå¯„å­˜å™¨ä¹‹é—´ä¼ é€æ•°æ®ï¼Œç»ä¸ä¼šå‡ºç°é”™è¯¯å¯¹é½çš„çŠ¶å†µã€‚ æµ®ç‚¹æ•°å’Œæ•´æ•°æ•°æ®ç±»å‹ä¹‹é—´ä»¥åŠä¸åŒæµ®ç‚¹æ ¼å¼ä¹‹é—´è¿›è¡Œè½¬æ¢çš„æŒ‡ä»¤é›†åˆã€‚ æŠŠä¸€ä¸ªä» XMM å¯„å­˜å™¨æˆ–å†…å­˜ä¸­è¯»å‡ºçš„æµ®ç‚¹å€¼è¿›è¡Œè½¬æ¢ï¼Œå¹¶å°†ç»“æœå†™å…¥ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨ã€‚æŠŠæµ®ç‚¹å€¼è½¬æ¢æˆæ•´æ•°æ—¶ï¼ŒæŒ‡ä»¤ä¼šæ‰§è¡Œæˆªæ–­(truncation)ï¼ŒæŠŠå€¼å‘ 0 è¿›è¡Œèˆå…¥ã€‚ 3.11.2 è¿‡ç¨‹ä¸­çš„æµ®ç‚¹ä»£ç  åœ¨ x86-64 ä¸­ï¼ŒXMM å¯„å­˜å™¨ç”¨æ¥å‘å‡½æ•°ä¼ é€’æµ®ç‚¹å‚æ•°ï¼Œä»¥åŠä»å‡½æ•°è¿”å›æµ®ç‚¹å€¼ã€‚å…·æœ‰ä»¥ä¸‹è§„åˆ™: XMM å¯„å­˜å™¨ %xmm0~%xmm7 æœ€å¤šå¯ä»¥ä¼ é€’ 8 ä¸ªæµ®ç‚¹å‚æ•°ã€‚æŒ‰ç…§å‚æ•°åˆ—å‡ºçš„é¡ºåºä½¿ç”¨è¿™äº›å¯„å­˜å™¨ã€‚å¯ä»¥é€šè¿‡æ ˆä¼ é€’é¢å¤–çš„æµ®ç‚¹å‚æ•°ã€‚ å‡½æ•°ä½¿ç”¨å¯„å­˜å™¨ %xmm0 æ¥è¿”å›æµ®ç‚¹å€¼ã€‚ æ‰€æœ‰çš„ XMM å¯„å­˜å™¨éƒ½æ˜¯è°ƒç”¨è€…ä¿å­˜çš„ã€‚è¢«è°ƒç”¨è€…å¯ä»¥ä¸åŒä¿å­˜å°±è¦†ç›–è¿™äº›å¯„å­˜å™¨ä¸­ä»»æ„ä¸€ä¸ªã€‚ å½“å‡½æ•°åŒ…å«æŒ‡é’ˆã€æ•´æ•°å’Œæµ®ç‚¹æ•°æ··åˆçš„å‚æ•°æ—¶ï¼ŒæŒ‡é’ˆå’Œæ•´æ•°é€šè¿‡é€šç”¨å¯„å­˜å™¨ä¼ é€’ï¼Œè€Œæµ®ç‚¹å€¼é€šè¿‡ XMM å¯„å­˜å™¨ä¼ é€’ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‚æ•°åˆ°å¯„å­˜å™¨çš„æ˜ å°„å–å†³äºå®ƒä»¬çš„ç±»å‹å’Œæ’åˆ—çš„é¡ºåºã€‚ä¾‹å¦‚: // è¿™ä¸ªå‡½æ•°ä¼šæŠŠ x å­˜æ”¾åœ¨ %edi ä¸­ï¼Œy æ”¾åœ¨ %xmm0 ä¸­ï¼Œz æ”¾åœ¨ %rsi ä¸­ã€‚ double f1(int x, double y, long z); // è¿™ä¸ªå‡½æ•°çš„å¯„å­˜å™¨åˆ†é…ä¸å‡½æ•° f1 ç›¸åŒã€‚ double f2(double y, int x, long z); // è¿™ä¸ªå‡½æ•°ä¼šå°† x æ”¾åœ¨ %xmm0 ä¸­ï¼Œy æ”¾åœ¨ %rdi ä¸­ï¼Œz æ”¾åœ¨ %rsi ä¸­ã€‚ double f1(float x, double *y, long *z); 3.11.3 æµ®ç‚¹è¿ç®—æ“ä½œ ä¸‹å›¾æè¿°äº†ä¸€ç»„æ‰§è¡Œç®—æœ¯è¿ç®—çš„æ ‡é‡ AVX2 æµ®ç‚¹æŒ‡ä»¤ã€‚æ¯æ¡æŒ‡ä»¤æœ‰ä¸€ä¸ª($S_1$)æˆ–ä¸¤ä¸ª($S_1, S_2$)ï¼Œå’Œä¸€ä¸ªç›®çš„æ“ä½œæ•° Dã€‚ç¬¬ä¸€ä¸ªæºæ“ä½œæ•° $S_1$ å¯ä»¥æ˜¯ä¸€ä¸ª XMM å¯„å­˜å™¨æˆ–ä¸€ä¸ªå†…å­˜ä½ç½®ã€‚ç¬¬äºŒä¸ªæºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°éƒ½å¿…é¡»æ˜¯ XMM å¯„å­˜å™¨ã€‚æ¯ä¸ªæ“ä½œå¤šæœ‰ä¸€æ¡é’ˆå¯¹å½“ç²¾åº¦çš„æŒ‡ä»¤å’Œä¸€æ¡é’ˆå¯¹åŒç²¾åº¦çš„æŒ‡ä»¤ã€‚ç»“æœå­˜æ”¾åœ¨ç›®çš„å¯„å­˜å™¨ä¸­ã€‚ 3.11.4 å®šä¹‰å’Œä½¿ç”¨æµ®ç‚¹å¸¸æ•° å’Œæ•´æ•°è¿ç®—æ“ä½œä¸åŒï¼ŒAVX æµ®ç‚¹æ“ä½œä¸èƒ½ä»¥ç«‹å³æ•°å€¼ä½œä¸ºæ“ä½œæ•°ã€‚ç›¸åï¼Œç¼–è¯‘å™¨å¿…é¡»ä¸ºæ‰€æœ‰çš„å¸¸é‡å€¼åˆ†é…å’Œåˆå§‹åŒ–å­˜å‚¨ç©ºé—´ã€‚ç„¶åä»£ç å†æŠŠè¿™äº›å€¼ä»å†…å­˜è¯»å…¥ã€‚ 3.11.5 åœ¨æµ®ç‚¹ä»£ç ä¸­ä½¿ç”¨ä½çº§æ“ä½œ 3.11.6 æµ®ç‚¹æ¯”è¾ƒæ“ä½œ æµ®ç‚¹æ¯”è¾ƒæŒ‡ä»¤ä¼šè®¾ç½®ä¸‰ä¸ªæ¡ä»¶ç : é›¶æ ‡å¿—ä½ ZF, è¿›ä½æ ‡å¿—ä½ CF å’Œå¥‡å¶æ ‡å¿—ä½ PFã€‚ ","date":"2021-12-03","objectID":"/csapp/:2:11","tags":null,"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ","uri":"/csapp/"}]